<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<title>단체예약 관리 시스템</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--p:#1a472a;--p2:#2d6a4f;--p3:#40916c;--bg:#f7f5f0;--card:#fff;--tx:#2c2c2c;--tl:#888;--bd:#e8e4dc;--red:#c0392b;--grn:#27ae60;--blu:#2980b9;--org:#f39c12;--yel:#FEE500;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,'Malgun Gothic',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;touch-action:manipulation;}
select,input,button,textarea{font-family:inherit;}
::-webkit-scrollbar{width:5px;height:5px;}::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}

#loginScreen{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(160deg,#0d2818,#1a472a 30%,#2d6a4f 60%,#40916c);}
.login-box{background:#fff;border-radius:24px;padding:44px 36px;width:440px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,.3);text-align:center;}
.login-box h1{font-size:22px;font-weight:900;color:var(--p);margin-bottom:4px;}
.login-box>p{font-size:12px;color:var(--tl);margin-bottom:24px;}
.mcards{display:flex;gap:12px;margin-bottom:20px;}
.mcard{flex:1;border:2.5px solid var(--bd);border-radius:14px;padding:20px 14px;cursor:pointer;transition:all .2s;text-align:center;}
.mcard:hover{border-color:var(--p3);background:#f0faf4;}
.mcard.sel{border-color:var(--p);background:#e8f5e9;box-shadow:0 4px 16px rgba(26,71,42,.1);}
.mcard .ic{font-size:32px;margin-bottom:6px;}
.mcard h3{font-size:14px;font-weight:800;color:var(--p);margin-bottom:3px;}
.mcard p{font-size:10px;color:var(--tl);line-height:1.4;}
.lf{margin-bottom:14px;text-align:left;}
.lf label{font-size:11px;font-weight:700;color:#666;display:block;margin-bottom:4px;}
.lf input{width:100%;border:2px solid var(--bd);border-radius:10px;padding:11px 13px;font-size:14px;outline:none;}
.lf input:focus{border-color:var(--p3);}
.lbtn{width:100%;padding:13px;border:none;border-radius:12px;font-size:15px;font-weight:800;color:#fff;cursor:pointer;transition:all .2s;margin-top:6px;}
.lbtn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.15);}
.lbtn.cust{background:linear-gradient(135deg,var(--p3),#52b788);}
.lbtn.adm{background:linear-gradient(135deg,var(--p),var(--p2));}
.book-big-btn{width:100%;padding:32px 20px;border:none;border-radius:18px;background:linear-gradient(135deg,var(--p),var(--p3));color:#fff;cursor:pointer;transition:all .25s;box-shadow:0 8px 28px rgba(26,71,42,.3);text-align:center;margin-bottom:4px;}
.book-big-btn:hover{transform:translateY(-3px);box-shadow:0 12px 36px rgba(26,71,42,.4);}
.book-big-btn:hover .mascot-img{transform:scale(1.08);}
.entry-btn{flex:1;padding:28px 14px;border:none;border-radius:16px;color:#fff;cursor:pointer;transition:all .25s;text-align:center;}
.entry-btn:hover{transform:translateY(-3px);}
.eb-book{background:linear-gradient(135deg,var(--p),var(--p3));box-shadow:0 6px 22px rgba(26,71,42,.25);}
.eb-book:hover{box-shadow:0 10px 30px rgba(26,71,42,.35);}
.eb-check{background:linear-gradient(135deg,#1565C0,#42A5F5);box-shadow:0 6px 22px rgba(21,101,192,.25);}
.eb-check:hover{box-shadow:0 10px 30px rgba(21,101,192,.35);}
.mascot-wrap{width:110px;height:110px;margin:0 auto 12px;background:rgba(255,255,255,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 24px rgba(255,255,255,.2),inset 0 0 12px rgba(255,255,255,.1);border:3px solid rgba(255,255,255,.25);animation:mascotPulse 3s ease-in-out infinite;}
.mascot-img{width:88px;height:88px;object-fit:contain;border-radius:50%;transition:transform .3s;filter:drop-shadow(0 2px 6px rgba(0,0,0,.15));}
@keyframes mascotPulse{0%,100%{box-shadow:0 0 24px rgba(255,255,255,.2),inset 0 0 12px rgba(255,255,255,.1);}50%{box-shadow:0 0 36px rgba(255,255,255,.35),inset 0 0 18px rgba(255,255,255,.15);}}

.topnav{background:linear-gradient(135deg,var(--p),var(--p2),var(--p3));padding:0 20px;display:flex;align-items:center;height:56px;box-shadow:0 2px 12px rgba(0,0,0,.12);position:sticky;top:0;z-index:100;}
.topnav .logo{font-size:15px;font-weight:900;color:#fff;white-space:nowrap;}
.mbadge{font-size:9px;font-weight:800;padding:2px 8px;border-radius:20px;margin-left:6px;vertical-align:middle;}
.mbadge.ad{background:#ff6b6b;color:#fff;}.mbadge.cu{background:var(--yel);color:#333;}
.navl{display:flex;gap:1px;margin-left:auto;align-items:center;position:relative;}
.navl>.nav-group{position:relative;}
.navl>.nav-group>.nav-main{background:none;border:none;color:rgba(255,255,255,.75);font-size:12px;font-weight:700;padding:7px 11px;cursor:pointer;border-radius:7px;transition:all .15s;white-space:nowrap;display:flex;align-items:center;gap:3px;}
.navl>.nav-group>.nav-main:hover,.navl>.nav-group>.nav-main.act{background:rgba(255,255,255,.18);color:#fff;}
.navl>.nav-group>.nav-main .nav-arrow{font-size:8px;opacity:.6;transition:transform .2s;}
.navl>.nav-group:hover>.nav-main .nav-arrow{transform:rotate(180deg);}
.nav-sub{display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);min-width:150px;background:#fff;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.18);padding:6px;z-index:200;margin-top:6px;}
.nav-sub::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);border:6px solid transparent;border-bottom-color:#fff;}
.navl>.nav-group:hover>.nav-sub{display:block;}
.nav-sub button{display:flex;align-items:center;gap:8px;width:100%;background:none;border:none;padding:9px 12px;font-size:12px;font-weight:600;color:#333;cursor:pointer;border-radius:7px;transition:background .12s;white-space:nowrap;text-align:left;}
.nav-sub button:hover{background:#e8f5e9;}
.nav-sub button.act{background:#e8f5e9;color:var(--p);font-weight:800;}
.nav-sub .sub-icon{font-size:14px;width:20px;text-align:center;}
.nav-sub .sub-divider{height:1px;background:#eee;margin:4px 8px;}
.navl button.nav-direct{background:none;border:none;color:rgba(255,255,255,.75);font-size:12px;font-weight:700;padding:7px 11px;cursor:pointer;border-radius:7px;transition:all .15s;white-space:nowrap;}
.navl button.nav-direct:hover,.navl button.nav-direct.act{background:rgba(255,255,255,.18);color:#fff;}
.subtab-bar{display:flex;gap:5px;padding:12px 16px;position:sticky;top:50px;z-index:50;background:#fff;flex-wrap:wrap;border-bottom:none;margin-bottom:14px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);border:1px solid var(--bd);}
.subtab-bar button{padding:8px 16px;border:2px solid #e0e0e0;background:#fafafa;color:#666;font-size:12px;font-weight:800;border-radius:20px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.subtab-bar button:hover{border-color:var(--p2);color:var(--p);background:#e8f5e9;}
.subtab-bar button.on{background:linear-gradient(135deg,var(--p),var(--p2));color:#fff;border-color:var(--p);box-shadow:0 2px 8px rgba(26,71,42,.3);}
@media(max-width:768px){.subtab-bar{top:50px;gap:4px;padding:10px 12px;}.subtab-bar button{padding:6px 12px;font-size:11px;}}
.lobtn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:11px;font-weight:600;padding:5px 12px;border-radius:7px;cursor:pointer;margin-left:10px;}

.chat-msg-wrap{position:relative;}.chat-msg-wrap .chat-msg-actions{display:none;position:absolute;top:-6px;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.18);padding:2px;z-index:10;gap:1px;}.chat-msg-wrap:hover .chat-msg-actions{display:flex;}
.chat-msg-actions button{border:none;background:none;cursor:pointer;padding:4px 7px;border-radius:6px;font-size:11px;transition:background .12s;white-space:nowrap;}.chat-msg-actions button:hover{background:#f0f0f0;}
.chat-msg-actions .cma-edit{color:#1976d2;}.chat-msg-actions .cma-del{color:#c62828;}
.chat-edited-mark{font-size:9px;color:#999;font-style:italic;margin-top:2px;}
.chat-edit-area{display:flex;flex-direction:column;gap:6px;width:100%;}.chat-edit-area textarea{width:100%;border:2px solid #1976d2;border-radius:10px;padding:8px 10px;font-size:12px;font-family:inherit;resize:vertical;min-height:40px;outline:none;}
.chat-edit-area .chat-edit-btns{display:flex;gap:6px;justify-content:flex-end;}.chat-edit-area .chat-edit-btns button{padding:5px 14px;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;}.chat-edit-btns .ced-save{background:#1976d2;color:#fff;}.chat-edit-btns .ced-cancel{background:#eee;color:#666;}

.page{display:none;padding:22px;max-width:1600px;margin:0 auto;}.page.act{display:block;}
.card{background:var(--card);border-radius:14px;box-shadow:0 3px 16px rgba(0,0,0,.04);border:1px solid var(--bd);margin-bottom:18px;overflow:hidden;}
.chd{padding:16px 22px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;}
.chd h3{font-size:15px;font-weight:800;color:var(--p);display:flex;align-items:center;gap:6px;}
.cbd{padding:22px;}
.hero{background:linear-gradient(135deg,var(--p),var(--p3));border-radius:18px;padding:32px;color:#fff;margin-bottom:22px;position:relative;overflow:hidden;}
.hero::after{content:'';position:absolute;top:-40%;right:-8%;width:260px;height:260px;background:rgba(255,255,255,.04);border-radius:50%;}
.hero h2{font-size:24px;font-weight:900;margin-bottom:4px;}.hero p{font-size:13px;opacity:.8;font-weight:300;}

.fg{display:flex;flex-direction:column;gap:4px;}.fg.full{grid-column:1/-1;}
.fg label{font-size:11px;font-weight:700;color:#666;}.fg .req{color:var(--red);}
.fg input,.fg select,.fg textarea{border:2px solid var(--bd);border-radius:9px;padding:9px 12px;font-size:13px;outline:none;background:#fafaf8;transition:border .2s;}
.fg input:focus,.fg select:focus{border-color:var(--p3);background:#fff;}
.fg textarea{resize:vertical;min-height:50px;}
.fgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;}

.rgrp,.cgrp{display:flex;gap:7px;flex-wrap:wrap;}
.rgrp label,.cgrp label{display:flex;align-items:center;gap:4px;font-weight:500;font-size:12px;padding:6px 12px;border:2px solid var(--bd);border-radius:9px;cursor:pointer;transition:all .2s;background:#fafaf8;}
.rgrp label:has(input:checked){border-color:var(--p3);background:#e8f5e9;color:var(--p);font-weight:700;}
.cgrp label:has(input:checked){border-color:var(--org);background:#fef9e7;color:#7d6608;font-weight:700;}

.sbtn{display:block;margin:20px auto 0;background:linear-gradient(135deg,var(--p),var(--p3));color:#fff;border:none;border-radius:13px;padding:14px 56px;font-size:15px;font-weight:800;cursor:pointer;box-shadow:0 5px 18px rgba(26,71,42,.22);transition:all .2s;}
.sbtn:hover{transform:translateY(-2px);}

.btn{border:none;border-radius:9px;padding:9px 18px;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;color:#fff;}
.btn:hover{transform:translateY(-1px);}
.bg{background:linear-gradient(135deg,#4CAF50,#388E3C);box-shadow:0 2px 8px rgba(76,175,80,.2);}
.bo{background:linear-gradient(135deg,#FF9800,#E65100);box-shadow:0 2px 8px rgba(255,152,0,.2);}
.bb{background:linear-gradient(135deg,#2196F3,#1976D2);box-shadow:0 2px 8px rgba(33,150,243,.2);}
.br{background:linear-gradient(135deg,#ef5350,#c62828);box-shadow:0 2px 8px rgba(244,67,54,.15);}
.bk{background:var(--yel);color:#3c1e1e;box-shadow:0 2px 8px rgba(254,229,0,.2);}
.bgy{background:#e0e0e0;color:#666;box-shadow:none;}
.bs{padding:5px 12px;font-size:10px;border-radius:6px;}

.tbl{width:100%;border-collapse:collapse;font-size:12px;}
.tbl th{background:#fafaf8;padding:10px 12px;font-weight:700;color:#555;border-bottom:2px solid var(--bd);text-align:left;white-space:nowrap;}
.tbl td{padding:10px 12px;border-bottom:1px solid #f5f3ee;vertical-align:middle;}
.tbl tr:hover td{background:#fafaf8;}
.bdg{display:inline-block;padding:2px 9px;border-radius:20px;font-size:10px;font-weight:700;}
.bdg-g{background:#d5f5e3;color:#1e8449;}.bdg-y{background:#fef9e7;color:#b7950b;}.bdg-r{background:#fadbd8;color:#922b21;}

.cal-wrap{overflow:hidden;}
.cal-hd{background:linear-gradient(135deg,var(--p),var(--p2));padding:16px 22px;color:#fff;display:flex;justify-content:space-between;align-items:center;}
.cal-hd h2{font-size:18px;font-weight:800;}
.cal-hd select option{color:#333;background:#fff;}
.cal-hd select{transition:opacity .2s;border-bottom:1px dashed rgba(255,255,255,.4) !important;}
.cal-hd select:hover{opacity:.8;border-bottom-color:rgba(255,255,255,.8) !important;}
.cnav{display:flex;gap:5px;}
.cnav button{background:rgba(255,255,255,.15);border:none;color:#fff;width:34px;height:34px;border-radius:8px;font-size:15px;cursor:pointer;}
.cnav button:hover{background:rgba(255,255,255,.3);}
.cgrid{display:grid;grid-template-columns:repeat(7,1fr);}
.cdh{padding:9px;text-align:center;font-size:11px;font-weight:700;color:var(--tl);background:#fafaf8;border-bottom:1px solid var(--bd);}
.cdh:first-child{color:var(--red);}.cdh:last-child{color:var(--blu);}
.ccell{min-height:90px;padding:5px;border-bottom:1px solid #f0ede6;border-right:1px solid #f0ede6;cursor:pointer;transition:background .12s;}
.ccell:hover{background:#f5f3ee;}.ccell.today{background:#fef9e7;}.ccell.oth{opacity:.2;}
.ccell .dn{font-size:11px;font-weight:700;color:#555;margin-bottom:2px;}
.ccell:nth-child(7n+1) .dn{color:var(--red);}.ccell:nth-child(7n) .dn{color:var(--blu);}
.chip{font-size:8px;font-weight:600;padding:1px 4px;border-radius:3px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:none;}
.day-summary{display:flex;gap:4px;margin-bottom:3px;flex-wrap:wrap;}
.day-summary .ds-badge{font-size:12px;font-weight:900;padding:3px 7px;border-radius:5px;line-height:1.4;}
.ds-team{background:#1a472a;color:#fff;}
.ds-ppl{background:#2196F3;color:#fff;}

.st{width:100%;border-collapse:collapse;font-size:11px;}
.st th{padding:12px 14px;font-weight:800;border-bottom:3px solid #ccc;text-align:center;font-size:14px;}
.st th.tth{background:#f5f5f5;position:sticky;left:0;z-index:2;min-width:110px;font-size:14px;color:#333;}
.st th .sub{font-size:11px;font-weight:600;opacity:.8;margin-top:3px;}
.st td{padding:10px 12px;text-align:center;border-left:1px solid #ddd;font-weight:600;cursor:pointer;transition:background .1s;font-size:13px;}
.st td.ttd{font-weight:700;color:#333;border-right:2px solid #ddd;position:sticky;left:0;z-index:1;font-size:13px;cursor:default;}
.st td.cfl{background:#ffcdd2!important;color:#c62828!important;}

.sr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f0ede6;}
.sr:last-child{border-bottom:none;}
.si h4{font-size:13px;font-weight:700;}.si p{font-size:10px;color:#999;margin-top:1px;}
.tg{width:44px;height:22px;background:#ddd;border-radius:11px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;}
.tg.on{background:var(--p3);}
.tg::after{content:'';position:absolute;width:18px;height:18px;border-radius:9px;background:#fff;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.tg.on::after{transform:translateX(22px);}

.mo{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:center;padding:20px;}
.mo.show{display:flex;}
.mdl{background:#fff;border-radius:18px;width:100%;max-width:560px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);}
.mhd{padding:20px 24px 12px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;}
.mhd h3{font-size:16px;font-weight:800;color:var(--p);}
.mc{background:none;border:none;font-size:20px;cursor:pointer;color:#aaa;}
.mbd{padding:20px 24px;}.mft{padding:12px 24px 20px;display:flex;justify-content:flex-end;gap:7px;}

.mbk{border-left:4px solid var(--p3);background:#fff;border-radius:11px;padding:18px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);}
.mbk .mt{font-size:14px;font-weight:700;margin-bottom:6px;}
.mbk .mr{display:flex;flex-wrap:wrap;gap:14px;font-size:12px;color:#666;}

.tw{position:fixed;top:70px;right:16px;z-index:300;display:flex;flex-direction:column;gap:6px;}
.toast{background:#fff;border-radius:10px;padding:11px 16px;box-shadow:0 6px 24px rgba(0,0,0,.1);display:flex;align-items:center;gap:7px;font-size:12px;font-weight:600;animation:ti .3s ease;min-width:260px;}
.toast.s{border-left:4px solid var(--grn);}.toast.k{border-left:4px solid var(--yel);}.toast.e{border-left:4px solid var(--red);}.toast.i{border-left:4px solid var(--blu);}
@keyframes ti{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}

@media(max-width:768px){.topnav{padding:0 8px;height:50px;}.navl>.nav-group>.nav-main{padding:5px 7px;font-size:10px;}.navl button.nav-direct{padding:5px 7px;font-size:10px;}.nav-sub{min-width:130px;}.nav-sub button{padding:8px 10px;font-size:11px;}.page{padding:12px;}.hero{padding:22px;}.hero h2{font-size:18px;}.fgrid{grid-template-columns:1fr;}.ccell{min-height:60px;}.login-box{padding:28px 20px;}.mcards{flex-direction:column;}}
button,a,.btn,.lbtn,.entry-btn,.mcard,.sbtn,.book-big-btn,[onclick]{touch-action:manipulation;cursor:pointer;-webkit-user-select:none;user-select:none;}
input,textarea,select{font-size:16px !important;}
</style>
</head>
<body>
<!-- FACILITY SELECTION -->
<div id="facilityScreen" style="display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#1a472a 0%,#2d6a4f 100%);padding:20px;">
  <div style="background:#fff;border-radius:20px;padding:32px 28px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3);">
    <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:40px;margin-bottom:8px;">🏕️</div>
      <h1 style="font-size:20px;color:#1a472a;margin-bottom:4px;">단체예약 관리 시스템</h1>
      <p style="font-size:12px;color:#888;">시설을 선택하세요</p>
    </div>
    <div id="facilityList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;max-height:400px;overflow-y:auto;"></div>
  </div>
</div>
<div id="loginScreen" style="display:none;">
<div class="login-box">
  <div style="position:relative;text-align:center;">
    <h1 onclick="toggleFacDropdown()" style="cursor:pointer;display:inline-flex;align-items:center;gap:6px;" id="loginFacName">🏕️ 잠사박물관 플레이팜 <span style="font-size:12px;color:#999;">▼</span></h1>
    <div id="facDropdown" style="display:none;position:absolute;left:50%;transform:translateX(-50%);top:100%;background:#fff;border:2px solid #1a472a;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:999;min-width:260px;max-height:250px;overflow-y:auto;padding:6px;">
    </div>
  </div>
  <p>단체예약 관리 시스템</p>

  <!-- Main two buttons -->
  <div id="mainEntry">
    <div class="mascot-wrap" style="margin:0 auto 18px;width:90px;height:90px;"><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCACsAMkDASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAAAAMEBQYHAggB/8QATBAAAQMDAwIDAwYJCAgHAQAAAQIDBAAFEQYSIQcxE0FRImFxFBUjMoGRCEJSVpShsdHSFhckM1NiwfBDY3KChJKVoiU1RlRzs+Hi/8QAGgEAAwEBAQEAAAAAAAAAAAAAAAIDBAEFBv/EAC4RAAICAQIEBQUAAQUAAAAAAAABAhEDBCESEzFRMkFhsdEFInGB8JEUIzNSof/aAAwDAQACEQMRAD8A9l0UUUAFFFFABRRRQAUUUUAFFFMrpdrVami7dLnCgtgZ3yX0tjHrlRFAD2q1rHXOnNJTIca+S3WFy0OOJLcdbobQgpClr2g7E5WkZPH3GvsLX+hJsgR4etdOSXldm2roypR+ACqqeoHG19bIclKkrae04oR3EnKVlMgFW09jgKT94qWbJy4OSHhG3TNKhSo06I1LhSGpMd1O5t1pYWhY9QRwRS1ZxoIN2DqFP01BSUWy4W/51jsJOERXUu+G8lCfJKtyF4HAO71q2XjV2lLMrbeNT2W3KzjEqe00c+ntKFPCalFSRyUadE3RUNZtV6XvX/k+pLPcedv9FnNu8+nsqNTNMKFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRXJdbBwXED4mgDqiviVJUMpII9xqs671fF03HRDism5agmApttqZUPGkr9f7rY5KlnAAB+FAEHr3Ul2nX46N0rJEWS22ly63LbuMJtQ9ltAPBdWOQTnaBnByKioOg9LsvGVJtbV0nKIU5NuP9JfcWPxiteTn4YA7DA4qV0ppWfYLWsTlfK7lMeVLuEpGSHX18qI89o4SB5BIqT7V4uqzTlOnsjZjgktiOm2OzTY3yWbaYMlj+ydjpWj7iMVVbn0wsYmRrnpxx7TtyhuKdYdictbiMHcyfZII4ONpI4JxV7rhxvccha0K9Qf8KzRm49GPSKpetFpvOq/nqbergiP83pgrhRXCwh1O9Slb1pO4pUSn2QUj2RndUlZ9I6YtGDbNP2yKsDbvbjJCyPQqxk/fUwpsqUCXFAY7DilW0KWoIbSpR8gOTXXKTpWFIgbxo/S94ybnp+2yl4x4i46d4HuVjI++mLFxunTqWxJeuMu6aPdcSzJRLdLr9qKjhLqXFEqWzkhKkqyU8KBIyKuyLbNV/oSPiQK6d0+ZsZ2JObZXGfQW3m1+0FoIwQR55FaMCzwknFMnLga3ZYwQQCCCDyCKKzvQt3OkpzfT3UshTSmT4dhnPkBNwjDG1G7t4zeQgp4J9kgYNaIeO9eynZlaoKK48VrOPER/wAwrsEEZBBFdOBRRRQAUUUUAFFFFABRRWfdR+qFs0y65Z7S0LzqEjiG0vDcfP4z6xw2MeXKjxgc5HJSUVbOpNukW7U+oLLpm0rut+uLECIg43uHlSuSEpSOVKODhIBJx2rH9R9Yb/cluM6XtjNnhEFKZ9zQVPnP4yGQQlPPbeo580+RpE9U+7XdV+1RNduNxAIbWU4ZjA49hlvnaOBzjcfM0qhTpRuSslsj2SpPtKP7P1Vgy6tvaBphhS8QldzerulR1HqW73RtQ9ttU1TDPw8Jvag/bk1GCwWFKM/NcaT/APOwFn4blAn9tTSGEoAQBlR5Wr0HoKb3S6W+2FJmPpQsjDDCBvcc8vZQOT9grK5yk+pdJIj4tnjW6SHbSbla5B+q7AlLYWge7arGO3BGD51NaD1pcNB3uZPurCb9GmuFyfcVIJuDafIn+0bT+SkJ2jsDTW12/WGoF4ttsbtcVzu/NTveIP8AqgcJ/wB5XxHlUzM6ZPR7SubftV3wpaAJEBkEgkgDa002VHkj8r17V1ZGtrFaize7ZqK2z4Meaw7vjyGkutOo9pC0KGQQR3BBBp0LpAP+n/7D+6vP3SHR1/ag+BebjeGLDCmLftEUuKhvuhSgol9DZB2hQVtQcA7lbk/VxrnABJIAAySewFO9bkg62ZLkxY517qliyacXJgstT7lJdREt0RXHjyHDtQnnyHKj6JSo+VfbBpm4QrQhq6X126XAkrdfWwhpGT+KhKQNqR5ZJPvrL7ffoeserMJqKla7TZYb8qFJSPo5kgqDK1pP4yGwpSQRwVKPoK0ifqUWO3Km3CUG4rakJUpaCvBUoJSMJGTlSgBj1pnqIT+3LE5y2vCyVbsjpJDj6Uj1SMn9dV7Q9xn2TUFw0bqSYmXKjsJmW+4raS2udGJ2q3JSNu9teEnGMhSTgZqcXeZZGAhpJ9QD++s96uyH7dEg66bBek2B0qdRnl2K5hDzYHbdjaoe9HvNEc2HH/xrcHGcvEaY9e20qw0wpY9SrH76SVe3CPYjpHxVmq5Yrtbr5ambpapKJMR4ZStJ5B80qHkoHgg8g0w13b7zcdMyGtOzjCuzSkvRFlZSlSkqB2Lx3SoZTzxznyqD1eZuroflQ7FK6wa6RelzNKW+FDuRbV4U6VKSTHir77UAEFbqeDwQEnGTniqM5AmzoEaLfb3fb0hlAQj5TMc8NOBhOEAhOceZyfeamNEdKZT1ozJu2prXcoyih1Lym0IUs+0pSQAtC0kk+17WfU0pddH64sLalsPwr6wSSpt9v5OvHuWgFJ/3kj4+Vd46dKQ6S7ECjTlhGWzYoSMDO5UVClH38D9dOLdbGoLhcsk25Wx/jLkOe6wceRKUnBGfIjHfivsa9xXJKYExuRa7ik4QxNTsUs9vYVylweWUk+tSTjaNwUtA2r7g+SvI0cUkNSZOWPqNrywrUmTMiaoj5B8CUkR5KR6JdQNpz/eT38x2rWtCdQNPavKo8F16Jcm0b3rdMR4chCc43YyQpPb2kkjnvnisGSl5vLbagSORuHce4+v/AOetNpUZibsV4klEphW9l9lXhPsK8lIWMFJ+FXx6qUfFuiUsMX0PV1FYxoXqw/bVN2nXzgDaiEx70hsJbVk4xIA4bPIG4eyfPbjnZWXG3mkOtLS42tIUhaTkKB7EHzFehCcZq0ZZRcXTOqKKKcU8waxv/VO0OLsnUHUF0t8ZwgIm25ppmLIGeP6ShAU2SR9UlB9cg0xt8WHHgf8Ah7DSWVZV4gXvUtXmokElRPmc5Jr1VIZZkMOR5DTbzLiShba0hSVJPBBB4Iqh3fo509uEhUluyKtb6hgrtklyID8UNqCCfeUk1ly6dz6SLwzKPkYy2ztQhCtylnupSirA9MmkLldrdAdSiVLbSvgNsI9p1aj2CUDKifgPWtfZ6HaICv6S5f5iPyHbw+B/2KSf11b9M6N0ppohVh09bre5t2l1lhIdUD3yv6xzjnJ5qS0Tv7mO9QvJGJaa0RrbVa0PNwjpi1r5Mue2DKcT/cY/F583COOcHNP/AOb/AE1Z+rcK1Q4jrxt9lVNdlyXS7IkvPO+ECtZ8koaVgJwPpFYHJzretNZ6d0a1Dd1FNdiImullhSIrr25YGdv0aVYOO2e/lWQ6uuNy1f1Fj3vp2ic2l21Kt065zobjEeOkO70LbS4kF1eFOjAGAdmTimzY4Y8TUdmJGcpStmgWObAnxHHLbgsMyHI5IRtG9tZQsD1AUkjI9Kf1H6bs8LT9hh2W3IUmLEaDaNxyo+qifMk5J95pnrG+P2iLHi2uMibfLk78ntkRRIC3MZK145DaB7Sj5AepFeRVukaRXU2orZp9pkzVPPSZCtkWFGbLsmSr8ltscn3ngDzIplF0nqDVuHdbK+a7STlNhhv7lO4/9y+n64OT9GjCe2SqpzROjo1gccus+Sq7ailoAmXJ4DcR38Nodm2geyB9pJ5qyLjtrXvWlSj71HA+ytEYKP5JuVlN6iWKex8zaj0vBS7KsKXGjbWcNiTEcCfEaR2AUNiFpHbKMcZqD1O83rnpnOe0o+iTJy2/HbX7KkyI7qHQy4lX1FbmwkhWMZ8u9ak2ktoCcqIAxlRyfvrP+o9idsZl9QtLpSxcIbRfu0NIAaukdAysKHk8ACUuYJ42nIPHZR4qa6oIutvIf6cvEPUFhhXu3qJjS2g4kKGFJPZSSPIggg+8VX+qbfztbbdo9kByVfp7LJbCgFCO2tLr7n+yEII+KgByQKrPT/WtoZg3c2dqTdHLtepEix2qOMvONqS3vWQf6povF1W5eAASfdWkaE0rNhTn9TaldalaimNhvDXLMBnv4DOecZ5Ur8YgHyFJDG1K/I65bCWo9CuC5v3/AEbPRZLw8d0hpSCuFNPH9a0OyjgDxE4V370ws+qCu7JsGo7cuwX0gluO64Fsyh+Uw6MBzjBKeFDnI4rQDGQpRUsKUonOSe3uHuqP1Hp+0ajsptF8iCZGOCkrOHELA4cSoYKVjyUMGnlFS6ip10GXxoIyMVV7PKumntSJ0bqOUqYHm1O2W5ucLmNI+sy72BfQMEkcLT7WAQoVaBwazSi4umVTtWjL9fxNMagtOlNRohR5sKVdIqcKRw4xI+icSR3SravywQpIPdNPtUdJb7Zdz+jJXzvBzk2u4P4ebB8mnz3H91fYfjdhUNqnT15sF3t7UePKnaMRe2rq83DZ8WRBKXPEW2lse0ttS8H2eUAq4OBWs6c6naM1Bfo9itlxlLuMhC1tsO2+Q0cJGVElaABj416mlhCePhe5DJKUXaMEkXSPHuBgXNuRZ7g0o5jXBssKVzg7SfZWPekkdj6U8cbBcCsZSvuR5H1/z7q9K3e1Wy8RDDu1uiT45OfCkspcTn1woHmqLN6K9P33VuxLdNtZWdykwLg8y3n3NhWxP2AU0tH/ANWdjqO6MeQwShbTiEPA5Cg5k5B+OQfhTKx3nUFnlm1dPLrePlrysJtkNCJjDZKu5QsKSynJ5OUADPkONsidEtBNOBcuNdLkAc7JlzfWg+5SQoBQ9ygRV6slmtFjh/I7NbIduj5yW4zKW0k4xkgDk4A5psellF22LLMmuhVelln19FYcuWv9SifOfbCW4EdptDEUZzypKRvX257DkAq71eKKK2JUQbsKKKKDgUVFqkSJ61CKvwYwOPGAypZ89voPfSbduirJEhCnXgBuW4sqKh61F5r8KKcHcU1PYbTqWzu2q8xEyYrhCsbilSFDstKhylQ8iCCKw3osI063WO53HVV8uF5lxX5jcJ+4uLbaZC9g3IHBwlxse3nKskduNuXaoqcOMNrbWnP9W4Un7DnvWNaH0wNJdar9aUSEPQlWlEm2jZhTLDklxSmz/subh8NvbtWTVtyhbVUUxJJmm1XdFNouvVTUl0fSFGyx49sh8nCfET4zysep3NJz6I95qxCq1optiP1G1nYbg2y43d2Y9yjtOJ3JfZ8LwHkkEYOFIGQfJxPrWDD1ZaXQkuq2s5GloEO32WG3cNSXdxTNtiuEhCcDK3nCBw2gYJ7Z7cckYL1Dm2m0PJja+1DqDWF7d+legMTVxojBPKcJQUhAxwByT3wAa1TS/SrS2musbsqzsORm5drLqI63StKMOAO7M8gf1XmcbyBgHFeeunlhtvULXIe1HqaDZFXC4KW9GeDgedUpWfDQop8MEk7Ble7I4SeAfTxxSgmt2yS3bvyLZoXqLabbd2I8a4ak0gjbtZ+Uz3LnATuGU+K06dwQeOUYPPcckenbjbWtSaVetd9YR8nuDBakojSVbHEHg7Vpwdqhz5cHBrA/woun+mLfc4t9h363WWQ/HSybc8hxQdS0gIQpsNpUU4SEp5ATwORznR/wYLlMuXRa1iaFkw3norLivx20rO3HuAOz/crmSOzfmg2pNFx0hpPTekoRhaassS2tL27/AAUe25jtuUcqVjJ7k9z61lfX3XLdhlfNty1HcIjitqmbRY3A3IUjn6SRIP1AccIRg8/jZyncmAC6nNeIbbaY3UHqtcnNS6th2lybdVpcL4cLrid5AQ2dpQnCQEjcoYwMA4pMUU1xPdnaTZIQdQ6LN7bXdbVqvTM51tKxdmL/ACXnkpWgLStW5WcKSoHICu/pzW0aH1dfdL6jt2ndU3cX/T95WG7LfVlHiIcIKkMvKBwvcMBKwMk+4+zWfwnunml4KbVd4uoINifRFRCRCkhxYkNtJwlSA2la8pGEkkEY25IPeG0nbpOqvwWp8NwLfcYuaIEZPdRSp9nYke8KcIHoCB2FWlBSuLFtUmjaeu0dSOnE69soT8vsCkXaG4fxFsncrPqFI3pI9FGpVpxLzKHkZ2uJCx8CM1Stc6W0/oTojd9L6bi7HbwgWxhLju56XIfw0Mk9zgqVxgAJJwAKucdsMR2mEnIbQlAPrgYrzc1UisCva6iWySm3C4Xy62dxyQY8Z6DMcZ3OKSVbVYyg5CDgrHB4BBVgqfg72e3/AMllaocMibe5ciXDkXGW+p55xtiU60lIKj7KcIBKU4Ge9Q3XFmRJ0OyxAU0i5OXe3oglzO3xlSWwM45xgq7VetHaQg2DTkCxtPvy2IaMLccJHjOklTjm0cDcsqUfea0aNuK4luJlSexcMj1oqHetluSgqVHSB7ic19aanxUeKw8t0dzHdVu49AryP3it3Na6r/BHgXkyXopGHIblR0vNk4PBB7pPmD76WqyaatE2qCiiiugFML6tQhBhBIVIWlkEeWe/6gaf1H3z2GGHycIZfQtZ9ByM/rqeXwMaHiR0lbTLYQWyyhAwMj2QB7xxiulhLqUrbWN3dKhz/kV9Dij9VlePIqwM/wCP6qTWyp0ZWhlCvVI3EfA8c/ZUfQohVl3flKk7XE/WTnOPf8KqHUnTtzmPQNT6aCFX20hwIjLXsbnMObfEYUfInYkpJ4CkjPHItQipCEpDz25PZZVlX66FqkJWEJ2rGcE4xj/P2Vx7qpI752jILj1OtioD7FpYJ1FHUnxbJcD8mkJIIK0YV+MUZ2kZTkpOcU4Ey268ixb5o28NRtRWZZW0l4ELYUoYXGlNfWDasYPvSCknArRL/YNNahYSxqCyW+eE4CBOiodKT5YKgRnnyqDk9LumxjeFJ0Lp5LKPaLrUBttQ95UkBWPtx8MVl/0qW8XRTmPzRF6U6iwLnr2Lpe9ack2/VseO4XA2W5DTTZAUoh1CtyW1bUHC0pydmRnFVXWGgX7HLuLMXTz1+0zc5S5ZTESFSYbq17lJUgYUtAUcpUjKkjgjgE9aJ05eJepl6o6YtW3RelpLQQESoy5KbqEZCHvkwUjw0HKilQcClDaSMHFd9XNUdQNOafFtvDMVAuM5iPFvVk8RlISXU70OIWpSmVKRuwpK1eeCDimljWWsXr/73R3Fnlglxx/l2G8mFfNRXt2TaNL3I3SVGRGcuN4jux2GG0AJyoPYWr8rahJ3KOTjkjSrPG09016fwLY/cG4tstzYa+UP8F51ask4Hda1qJ2gdzxWZ9P+pWrkaWjsvWe03YtPPtJlzL+tl5xCXlhIUnwF8hICclRKtu4nJNT0yWjqxpeDNsDsSDqKwyw/JtU1wqS06ptxstuKSM7SFKKHUpOcZx3A7PSZdOm2nv5vz7bnXq46mSi2kl5Ly/RctPa60te7oi2265OCctCltx5UR6MtxKfrFAdQkrxnnbnFZ7rrQrtpn3aRb9O/PenrzJMqVFjICpEZ9eN6ggkeI2VALBSdyVE4BSBt7t+ktQ/OlvvutDZ7DabJIFwUqNPU84txAISCpTaEob9o57k9uM5p3G6sXe4b5dp0pbF25a1fJnJ17VGedQDgLLXgK2A9wNxOCM47UmLT5dRFw4W/x5etoaWox6XLxY57evn6bkHIh3W9XZl6yaOuztzEFuCiZd470ZhhpAwN6ngFEZyopQCVE/bVnuNx0r0W0FZLNcY8ya09JOZEeKlCHpZO8rUSoIbyokpSTwE4HCazbpN1D1zP1dJixmZF8n3eI8+3EkzT8khqRLcT4hVg7G0ownCEjcQnjJzWh9QNL9UtQabTCdvunZUdwgzrVDhuwjKbx7TQkrcdPJ4BCEZzyR2puVyJNPq6tt2+li5dS86S2SV0lsjhabhcbojXGu3Idlt1sbUq2wFyUqbiBQwZD7mdinSk7QASlIJwSTmo+J1SsypcqdcHGbZpxKUohTZSihyYvklaUHnw8Y28ZVycYxUzoHRfSW+2dF1tGgLWHUKXGkRZ8RK3IrzZ2radSvcAsHv3JyDyDmrdZdFaKsEz5XbdMWOFL+slca3tIWPhtTupXpk3cmKp10RWdN2y4ay1FB1Dc4Ui3adtay7bYclvY9OfKSkSHEHlCEpUdiT7RKiogYSK0lakoQScJSBSJW6FAoQrac53/t/ziuiwVqC3XVKx2A4SPeK0QioKoom93bBtKnFB1wYA+ok/tPvr6X2txSlW4p7hPJHxxSYihKiQvxMnI8Ub8fA12FvJSQpgEDsG1A8fbimVo4xvDUpq8qQGy2iS1vKTjO5JAzx7jUrUU2vxr8ylKVjwWFlWUkYyQB+w1K1XD0f5En1CiiirCBXEhpD7C2XBlC0lJHuruihq9mBFMyVRliFMJ8UcNLxkOp8j7j6inJcV/YuH7U/vpxJjsyWi0+2FpPkfL4elREv5RAdQzFkmUpX1Y7idysZ5O4dh8ayyi8fXoWTUvyP/ABFj/QLPwI/fSanFJdK/k7iuPxduR+ukflktsFUi2uBI823EqP3EikzckFSXERJgz3yweR8QDn76VyXc6kxyJiVjBjPgHj20hP7TVD6lq1ncbJerHYbLY1w5ttejrlOXotqaK0KSSWy1gAA5yDV4FzZPaPMP/DqqodZ7i+90vvMGHCktyLkhu2sLeQEpC5LiWATznH0lCkr6nafYR6J6zsWptE2eHCkNx7lEgMtv2936N5AS2nC0oPJbUMKSoDBCh2OQKv8AhJawsn8n2dIRZDc+6ybhFL7bBDnyJtL7ZK3cfUyrakA8kq91aNc9FaSucOHEu2m7Tcm4bCGGDMhtulCEjAAKgcVi/X+x2XT1ztyLHZ4NsiJthekIiRktISlFxge2oJAGAFK5PYZqWn4Xli/UWd8LKLpabfmrR4UOzxZLAkv7HFy9hV9MvPG045z51V9XzJydWKcmxGID6mogIbuymd6PH81JCd3bnP1AN3lWqdPNF63uulGLjaIthMCQ/IcjqmTnmnFoL68KKUsKAB7ggnKSD54r5c7HpKBoe/xVO/yy1xdIgbfXaLY9cmopSsgtMKbQQztCj3UhZICjt4x9BrddilhjjhJye1qlSr9Hm6bTTWVzlFJd7d+5hkGS478iYU8mTvWx9E5dVlKiGlYBTnA+GOD7PY1rSbhqgDA0/C+yf/8AxTTojbNNMwp7WtdLXyJbLpAiNx5kjTsspLuFDxGnwlwIThXC8oBBB8uLxaNB6ylQQ7Y7tpS/23coRbh85uAvtgnaVbGVJ3Y4OFEZzU/puuxYuJZG4XXkvgpr9NObXAlKvV/JWPwdNV2zS+qkfPmIkW5W1bRmKP0cZxMx4gLV2SlW4jccDIT68embpfbJarSLzcrxBi25SdyZLj6Q2sEZG059rIGRjOa8i6Ig+JqO3Wm5MtOCLdYkS4N43tpcN23BtWR+Nt4BAyPKvU0LQOhbfcEz4OjdPxpaFbkvNW5pK0n1BCcg15Gt4eba7L2Rswp8O/d+7KD0eu2obletR3mFaYbWnLvfH3lKkz1RpMcpbS2ApnYSlStiVY3A4WD7q1xiSENgqjICld/AWFp+84J+6qVpt1Nj6sattaI777VzjxLy2lpKTsWQph0YJHBLLavitVXMXNrGVRJyD6GOqlTWzuileh2uQXUYTFfAz3WkJH6zSwcXtA8FZ475H76Zu3FC1JSIsspzk/QKz92K6FwW5lMeBJUoeTmG/wBpz+qmUl3Bp9h0XFg/1K/iCP30jJnNx8BxDgcV9RATkrPoMU1ekz/HQ08luA2vhLhHiZPp6D7akocBiMsue068e7rhyr/8+yux4p7R/v0K6j1ObXGcZQ4/Ix8ofVuXg8JA7JHwH+NPKKK0xioqkSbt2FFFFMcCiiigDiQ6llhx5edqElRx6AVGwIwUwJElKVyHj4ilEZ2kjgD0wDinl2Qpy2SUIBKlNKAA8zikI6S5FYdElaUlCTxtwePeKz5fGisOhwplZkBCH1BAGSlXtHPqCTkfsrsreQ6cvsqR2CEtEr+3Cj+yuPoA4ULVvbPcqcyBx55V/hSzb0ZKEpZIKOw8JJUB93apjAlUhecNpa9CrnP2A/41jP4QurZzU22aZtKGp8q3yY14uKEYQNrTocaY5JKVrKM5zwEjg7hWla61bD0ppibe3mFyPASEstBQSX3lHahpPnuUogduBz2FedYKJji5FwubwkXSe8qTNeA4U6ruB6JSMJSPIJAqebKoR26ltPh5kt+hvlg6iaJvttFwialtrKUo3PMypCWXo/fIcQshSCMHvxxkZHNY5qvVlxvvU+XqXSeopcG3xICbXEkR2mnESRv8R1aQ62sbSrYkKA58Pg47xMiDCkrSuREjvKT9VTjYUR8M04AFY+bS2NcNIk7k7Qper9rydZpsJevbwpMiO40pIiQk5CkkY3JYCh37ggjyIPNaZ0/1BraJ0ysE6PpfT10jP22O/HbgTxBWErSFbPBWjw07QQCQ5gnOEp7Vl5q99MbtbLF0mjTZ8tmFCtrj8Z1buVFKUSFtNg45JICMDB+sAK9D6b/uSlGTrazB9UawQjKEerofdKNR61OmG7RF0XDQ1Adkxmn51+bQgJbkLQlr6JtxXsgBO7bg7c55rPpdx1tade6tU1qkW55+4oL7dqhsiMtQjte0EvIcO/napWQVFPI4AF56ca1sF9lv2y1Olt59yRPjpcjqSH2FO5Lg7YJU4DtOFYUDjBzWX2VS3kTZrqSlU24ypQT6JcfWpIHu2kY91V16WPEnF3ZL6dN5s0ozjVIealvWtJ9vZXJ1PPuhgy2J7UV2NFQlxxhxLiRltlKgcp45+PFbtauoWibpZk3lrU9qjxikKdEqW2ytg+aXEqIKFDzBrDqavQILskSnIcdb47OKbBUPt715Sy2qkerPTRl4dic1B1HeT1U/l3p5Trun4URqBJSGAVT44WtbrjYUARtKwU8jcUHyIr0FEkLlw2psSRFlRpDaXWFoSQFIUMgg5Ocg15owMdqvHQXU6rTJe0HMS46yAuXZikDIa3ZdZ5xnYpW4ee1X92tODNxPhf6M+fT8EU4/s2FTzxABU2wo/wBogkfDIIGftr46l0hDvyhPvKUDB+GTSoktEJI3kK7KCCR94GKQdXFIUtktrWT7ZbUMn48irv8AJlQquMw43tWjxARjKzuPPvNFndWW3YriipcdezcTypOMgn7DXLbPCfDlLwByAoKB+/J/XXFnSfnC4ubtyS4hGfeE8/tp47SVf2xx9GSdFFFaSIUUUUAFFFFABUOWRbHlkx/EiLUVBxKcqa9QfMp9/lUxRU541P8AI0ZcJHF9h1CVRVpeJPAbV+3nj7aUbQp4ZeJx5oHCft9f2V1JtsCQrc7FbKvygME/aKqfVqOzaOluqrnbwY8uLZ5TzDoWSW1paUUqGTjg4NSeOfp/fodSiZN1W1GdXa6VFjnNk086thjj2ZEz6rrg9Q3y2Pf4nuqGTxVXt2nbrChMxouqZTTDSAlCBEYwB/yZpx81Xv8AO2X+isfw15eWaySu/f4PYxQ5cVGvb5LCKKr3zXe/zul/orH8NHzVfD21fM/RGP4KnS7+/wAFOJ9vb5LCaYvNzWrNdLMy3AnWq5viTIhTUuDa4AgZbcaWlSM7Ace1zn1IMZ8037z1fM/RI/8ABR81Xzz1dL/RGP4KpjyPG7jL+/wSy445Y8M43/fklNMu3HTrEhnTdosVgVJb2OS0F6bJz6pU6oJT64KSnIyQaWt8ZuFBjw2d3hsNJaRuOThIwMnzPFQvzVe/ztmfojH8FfRar3+d0z9EY/gpsuaeWuKXT+7C4cEMNuEev792WHNFV42m+fndL/RGP4a+fNd7H/q6X+iMfw1Hbv7/AAXt9vb5LDTWciXmPMtryY9ygvJkwnlZwh1PbdjukjKVDzSo1E/Nd7/O6X+isfw18+ar4e2rZh/4Vj+CmTSdp+/wcf3KnH2+T1BoTUMPWGlImoYQXGcdG2UyB7TL6DtcbUPMhQIz5jBHcVLpcJcBkDYkdlEkJPx54+2sJ/Btt7jGtdQ264XJ24JkQ2ZmFoDfthSmyoBGB9UJB4549K3pNotqVBXyRCiPyiVD7jXqQUppSjX9+jx5pQk4sbPPNSiWITLclw8FZTlCPeT/AIU/t8VuFERHb5Ce5x9Y+ZpdCUoSEoSEpHYAYFfatDHwu31JSneyCiiiqiBRRRQAUUUUAFFFFABVO64YPRrWeRkfMcz/AOlVXGqj1pbW70f1i02hTi12OYEpSMknwVcAUAjzpozTGnZXUzSMF+x25yNJlvJfaVHTscSIrygFDHI3JB+IFeif5rem/wCY2nv0Bv8AdWEdNJLMzq5o0RVF3w5chTm1J9gfI3xk+gzgfaK9T1l0ifL+7qa9Y1zPtKf/ADW9N/zF07/09v8AdSFx6R9NJ8F2I7omytIcGCuPFSy4n3haMKH2GrvRWmkZbZhJ6fwtBHwLh0/tes9OJH0c9i1MOXOKOwS80Ejx0/6xHtcnKeM1O6XtvRjUycWOwaLnOfjMNwWEvo9QtpSQtBHYggEVrNQN/wBGaP1A8Xr7pWx3R093JcBp1X3qSTUMmnUnadFI5a6lZuWiOmltiLl3DRulIUdAyp6TCjttp+KiMCqg5G0PfFLg9POmOmtQSuUm4rtjbdrYI4O5/Z9IQcey0FHvyMHGiwemHTiFIEiLoLTLTw7OC1s7h8Dt4q2MttstIaZbQ22gBKUJGAkDsAPIUsNLTtuweXsZlpDohom0pelXmz2y93OScvOOQW2o6PRLTCRsQB68qPmo1YP5r+nH5j6e/QG/3Vb6K0pJE+JlP/mu6cfmNp7/AKe3+6sz/CK0NoyzaVsj1p0rZoTjt9YacWxDQgrQUO5SSByCQOO3Fb5WS/hSBQ0VZXdi1Iav0dbhSknanY7yceXNJkX2Ouw+J/er7lb/AAbLdAg6+vvyKHHjBVsYyGmwkH6Vfp8BW/Vg/wCDg6iVre+SGNy2hbWEFe0gbvEWcfHFbxSaa+UrH1Nc10FFFFXIBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRTOfLcj2eXMQlBcZZcWkEcEpBIz91K295UiBHkLACnWkrUB2yQDQAvRRXxRwkn0FAH2iq65fZadFR70G2PlDgaJTtOz2lhJ4znsfWrFQAUVHy5zrV+gwEpQWpDTy1kg7gUbcY5/vGpCgAoqOtk56TPujDiUBMR9LbZSDkgtpVzz6qNP2lFbSVHuQDQB1RRRQAUUUUAFFFFABRRRQB//2Q==" class="mascot-img" style="width:72px;height:72px;"></div>
    <div style="display:flex;gap:10px;margin-bottom:18px;">
      <button class="entry-btn eb-book" onclick="showBookingEntry()">
        <span style="font-size:28px;display:block;margin-bottom:6px;">📝</span>
        <span style="font-size:15px;font-weight:900;display:block;">단체예약<br>신청하기</span>
      </button>
      <button class="entry-btn eb-check" onclick="showCheckEntry()">
        <span style="font-size:28px;display:block;margin-bottom:6px;">🔍</span>
        <span style="font-size:15px;font-weight:900;display:block;">예약현황<br>조회하기</span>
      </button>
    </div>
  </div>

  <!-- Booking entry: phone required -->
  <div id="bookEntry" style="display:none;">
    <div style="background:#e8f5e9;border-radius:12px;padding:16px;margin-bottom:12px;text-align:left;">
      <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:8px;">📝 단체예약 신청</h3>
      <p style="font-size:11px;color:#666;margin-bottom:10px;">연락처를 입력하시면 예약 양식 페이지로 이동합니다.</p>
      <div class="lf" style="margin-bottom:0;"><label>연락처 <span style="color:var(--red);">*</span></label><input type="tel" id="lph" placeholder="010-0000-0000"></div>
    </div>
    <button class="lbtn cust" onclick="goBookingDirect()">예약 신청 페이지로 이동</button>
    <button onclick="backToMain()" style="background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;margin-top:8px;display:block;width:100%;text-align:center;">← 돌아가기</button>
  </div>

  <!-- Check entry: phone required -->
  <div id="checkEntry" style="display:none;">
    <div style="background:#e3f2fd;border-radius:12px;padding:16px;margin-bottom:12px;text-align:left;">
      <h3 style="font-size:14px;font-weight:800;color:var(--blu);margin-bottom:8px;">🔍 예약 현황 조회</h3>
      <p style="font-size:11px;color:#666;margin-bottom:10px;">연락처를 입력하면 내 예약 및 전체 예약 현황을 확인할 수 있습니다.</p>
      <div class="lf" style="margin-bottom:0;"><label>연락처 <span style="color:var(--red);">*</span></label><input type="tel" id="lph2" placeholder="010-0000-0000"></div>
    </div>
    <button class="lbtn" style="background:linear-gradient(135deg,var(--blu),#1565C0);" onclick="goCheckDirect()">예약 조회 페이지로 이동</button>
    <button onclick="backToMain()" style="background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;margin-top:8px;display:block;width:100%;text-align:center;">← 돌아가기</button>
  </div>

  <!-- Admin -->
  <div id="af" style="display:none;margin-top:12px;">
    <div class="lf"><label>관리자 아이디</label><input type="text" id="lid" placeholder="아이디 입력"></div>
    <div class="lf"><label>비밀번호</label><input type="password" id="lpw" placeholder="비밀번호 입력"></div>
    <button class="lbtn adm" onclick="doAdminLogin()" style="margin-top:4px;">관리자 입장</button>
    <button onclick="showAdminRecover()" style="background:none;border:none;color:#1976d2;font-size:11px;cursor:pointer;margin-top:8px;display:block;width:100%;text-align:center;">🔑 아이디/비밀번호 찾기</button>
    <button onclick="hideAdmin()" style="background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;margin-top:4px;display:block;width:100%;text-align:center;">← 돌아가기</button>
  </div>
  <!-- Admin recover -->
  <div id="adminRecoverPanel" style="display:none;margin-top:12px;">
    <div style="background:#e3f2fd;border-radius:12px;padding:16px;text-align:left;">
      <h3 style="font-size:14px;font-weight:800;color:#1565c0;margin-bottom:10px;">🔑 관리자 계정 찾기</h3>
      <p style="font-size:11px;color:#666;margin-bottom:12px;">등록된 연락처 또는 이름으로 계정을 찾을 수 있습니다.</p>
      <div class="lf" style="margin-bottom:6px;"><label>이름 또는 연락처</label><input type="text" id="admRecoverKey" placeholder="이름 또는 전화번호 입력"></div>
      <button class="lbtn" style="background:linear-gradient(135deg,#1565c0,#1e88e5);" onclick="doAdminRecover()">계정 찾기</button>
      <div id="admRecoverResult" style="margin-top:10px;"></div>
    </div>
    <button onclick="hideAdminRecover()" style="background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;margin-top:8px;display:block;width:100%;text-align:center;">← 로그인으로 돌아가기</button>
  </div>

  <div style="margin-top:24px;border-top:1px solid #eee;padding-top:14px;">
    <button onclick="showAgencyLogin()" style="background:none;border:none;color:#f57c00;font-size:11px;cursor:pointer;margin-bottom:4px;display:block;width:100%;text-align:center;">🏢 대행사 로그인</button>
    <button onclick="showAdmin()" style="background:none;border:none;color:#bbb;font-size:11px;cursor:pointer;">🔐 관리자 로그인</button>
  </div>

  <!-- Agency login -->
  <div id="agencyEntry" style="display:none;">
    <div style="background:#fff3e0;border-radius:12px;padding:16px;margin-bottom:12px;text-align:left;">
      <h3 style="font-size:14px;font-weight:800;color:#e65100;margin-bottom:8px;">🏢 대행사 로그인</h3>
      <p style="font-size:11px;color:#666;margin-bottom:10px;">등록된 대행사 코드와 비밀번호를 입력하세요.</p>
      <div class="lf" style="margin-bottom:6px;"><label>대행사 코드</label><input type="text" id="agCode" placeholder="대행사 코드"></div>
      <div class="lf" style="margin-bottom:0;"><label>비밀번호</label><input type="password" id="agPw" placeholder="비밀번호"></div>
    </div>
    <button class="lbtn" style="background:linear-gradient(135deg,#e65100,#f57c00);" onclick="doAgencyLogin()">대행사 입장</button>
    <button onclick="showAgencyRecover()" style="background:none;border:none;color:#e65100;font-size:11px;cursor:pointer;margin-top:8px;display:block;width:100%;text-align:center;">🔑 코드/비밀번호 찾기</button>
    <button onclick="backToMain()" style="background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;margin-top:4px;display:block;width:100%;text-align:center;">← 돌아가기</button>
  </div>
  <!-- Agency recover -->
  <div id="agencyRecoverPanel" style="display:none;">
    <div style="background:#fff3e0;border-radius:12px;padding:16px;text-align:left;">
      <h3 style="font-size:14px;font-weight:800;color:#e65100;margin-bottom:10px;">🔑 대행사 계정 찾기</h3>
      <p style="font-size:11px;color:#666;margin-bottom:12px;">등록된 대행사명 또는 연락처로 계정을 찾을 수 있습니다.</p>
      <div class="lf" style="margin-bottom:6px;"><label>대행사명 또는 연락처</label><input type="text" id="agRecoverKey" placeholder="대행사명 또는 전화번호 입력"></div>
      <button class="lbtn" style="background:linear-gradient(135deg,#e65100,#f57c00);" onclick="doAgencyRecover()">계정 찾기</button>
      <div id="agRecoverResult" style="margin-top:10px;"></div>
    </div>
    <button onclick="hideAgencyRecover()" style="background:none;border:none;color:#aaa;font-size:11px;cursor:pointer;margin-top:8px;display:block;width:100%;text-align:center;">← 로그인으로 돌아가기</button>
  </div>
  <p style="font-size:10px;color:#ccc;margin-top:10px;">문의: 010-6256-2969 / 043-235-1267</p>
</div>
</div>

<div id="app" style="display:none">
<nav class="topnav">
  <div class="logo">🏕️ 잠사박물관 <span class="mbadge" id="mbd"></span></div>
  <div class="navl" id="nl"></div>
  <button onclick="backToFacility()" style="background:#e65100;color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:9px;font-weight:700;cursor:pointer;margin-right:2px;">🔄 시설변경</button>
  <button class="lobtn" onclick="doLogout()">로그아웃</button>
</nav>

<!-- CUSTOMER: Booking -->
<div class="page" id="p-cb">
  <div class="hero"><h2>📝 단체예약 신청</h2><p>양식을 작성하여 제출해주시면, 관리자에게 카카오톡 알림이 전송됩니다.</p></div>

  <div class="card"><div class="cbd">
    <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:12px;">📜 개인정보 동의</h3>
    <div style="background:#f9f9f6;border:1px solid var(--bd);border-radius:9px;padding:12px;max-height:80px;overflow-y:auto;font-size:10px;color:#999;line-height:1.7;margin-bottom:8px;">한국잠사박물관플레이팜은 개인정보 보호법에 따라 단체명, 연락처, 이메일, 방문인원, 방문일정을 수집합니다. 목적: 예약 접수 및 관리. 보유기간: 방문일로부터 1년.</div>
    <label style="font-size:12px;font-weight:600;cursor:pointer;"><input type="checkbox" id="ck1"> 동의합니다</label>
  </div></div>
  <div class="card"><div class="cbd">
    <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:12px;">📢 유입경로</h3>
    <div class="rgrp" id="channelSection"></div>
  </div></div>
  <div class="card"><div class="cbd">
    <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:12px;">📋 예약 정보</h3>
    <div class="fgrid">
      <div class="fg"><label>방문일 <span class="req">*</span></label><input type="date" id="b_dt"></div>
      <div class="fg"><label>단체명 <span class="req">*</span></label><input type="text" id="b_nm" placeholder="예: 해피어린이집"></div>
      <div class="fg"><label>단체유형 <span class="req">*</span></label>
        <select id="b_cat" style="width:100%;padding:9px 12px;border:2px solid var(--bd);border-radius:9px;font-size:13px;">
          <option value="어린이집">어린이집</option>
          <option value="유치원">유치원</option>
          <option value="초등학교">초등학교</option>
          <option value="중학교">중학교</option>
          <option value="복지기관">복지기관</option>
          <option value="기타">기타</option>
        </select>
      </div>
      <div class="fg"><label>입장시간 <span class="req">*</span></label><select id="b_ar"></select></div>
      <div class="fg"><label>퇴장시간 <span class="req">*</span></label><select id="b_dp"></select></div>
      <div class="fg"><label>연령구분 <span class="req">*</span></label>
        <div class="rgrp"><label><input type="radio" name="ag" value="유아" checked> 유아</label><label><input type="radio" name="ag" value="초등"> 초등</label><label><input type="radio" name="ag" value="혼합"> 혼합</label></div>
      </div>
      <div class="fg"><label>유아 인원</label><input type="number" id="b_st1" placeholder="유아" value="0"></div>
      <div class="fg"><label>초등 인원</label><input type="number" id="b_st2" placeholder="초등" value="0"></div>
      <div class="fg"><label>인솔자</label><input type="number" id="b_tc" value="0"></div>
    </div>
  </div></div>
  <div class="card"><div class="cbd">
    <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:12px;">🍚 단체식</h3>
    <div id="mealSection"></div>
  </div></div>
  <div class="card"><div class="cbd">
    <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:12px;">📞 연락처</h3>
    <div class="fgrid">
      <div class="fg"><label>연락처 <span class="req">*</span></label><input type="tel" id="b_ph" placeholder="010-0000-0000"></div>
      <div class="fg"><label>이메일</label><input type="email" id="b_em" placeholder="거래내역서 수신용"></div>
    </div>
  </div></div>
  <div class="card"><div class="cbd">
    <h3 style="font-size:14px;font-weight:800;color:var(--p);margin-bottom:12px;">🎫 패키지 · 부가체험</h3>
    <div id="pkgSection"></div>
    <h4 style="font-size:12px;font-weight:700;margin:12px 0 6px;">부가체험</h4>
    <div class="cgrp" style="margin-bottom:12px;" id="addonSection"></div>
    <div class="fg"><label style="color:#F57F17;font-weight:700;">📝 요청사항 / 특이사항</label><textarea id="b_etc" rows="3" placeholder="알레르기, 식이제한, 휠체어 이용, 특별 요청 등을 입력해주세요." style="border:2px solid #FFB300;background:#FFFDE7;border-radius:8px;padding:10px;font-size:13px;line-height:1.5;resize:vertical;"></textarea></div>
  </div></div>
  <div class="card"><div class="cbd">
    <div class="fg"><label>사전답사 예약일</label><input type="date" id="b_vd"></div>
  </div></div>
  <button class="sbtn" onclick="submitBk()">제출하기</button>
</div>

<!-- CUSTOMER: My Bookings -->
<div class="page" id="p-cm">
  <div class="hero" style="padding:24px 32px;"><h2>📌 내 예약 조회</h2><p id="cmSub"></p></div>
  <div id="cmList"></div>
  <div id="cmEmpty" style="display:none;text-align:center;padding:50px;color:#aaa;"><div style="font-size:42px;margin-bottom:10px;">📭</div><p style="font-size:14px;font-weight:600;">예약 내역이 없습니다.</p></div>
</div>

<!-- CUSTOMER: Chat -->
<div class="page" id="p-ct">
  <div class="hero" style="padding:24px 32px;"><h2>💬 채팅 상담</h2><p>박물관 관리자와 실시간으로 소통하세요.</p></div>
  <div id="custChatArea" style="background:#fff;border-radius:12px;margin:0 16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08);">
    <div id="custChatList"></div>
    <div id="custChatRoom" style="display:none;">
      <div id="custChatHeader" style="padding:12px 16px;background:var(--p);color:#fff;display:flex;justify-content:space-between;align-items:center;"></div>
      <div id="custChatBody" style="height:400px;overflow-y:auto;padding:16px;background:#e8e4de;"></div>
      <div id="custChatInput" style="padding:10px 16px;background:#fff;border-top:1px solid #eee;display:flex;gap:8px;align-items:center;"></div>
    </div>
  </div>
</div>

<!-- CUSTOMER: Calendar -->
<div class="page" id="p-cc">
  <div class="hero" style="padding:24px 32px;"><h2>📅 예약 현황</h2><p>날짜별 예약 팀 수와 인원을 확인하세요. 날짜를 클릭하면 상세 정보를 볼 수 있습니다.</p></div>
  <div class="card cal-wrap">
    <div class="cal-hd"><h2 id="ccT" style="display:flex;align-items:baseline;gap:0;margin:0;">
      <select id="ccYearSel" onchange="ccY=parseInt(this.value);rCCal();" style="font-size:22px;font-weight:900;color:#fff;border:none;background:rgba(255,255,255,.12);border-radius:6px;cursor:pointer;padding:2px 6px;outline:none;-webkit-appearance:none;appearance:none;text-align:center;width:66px;"></select><span style="font-size:22px;font-weight:900;color:#fff;">년 </span>
      <select id="ccMonthSel" onchange="ccMo=parseInt(this.value);rCCal();" style="font-size:22px;font-weight:900;color:#fff;border:none;background:rgba(255,255,255,.12);border-radius:6px;cursor:pointer;padding:2px 6px;outline:none;-webkit-appearance:none;appearance:none;text-align:center;width:36px;"></select><span style="font-size:22px;font-weight:900;color:#fff;">월</span>
    </h2><div class="cnav"><button onclick="ccM(-1)">◀</button><button onclick="ccM(0)" style="font-size:11px;width:auto;padding:0 10px;">오늘</button><button onclick="ccM(1)">▶</button></div></div>
    <div class="cgrid" id="ccG"></div>
    <div style="padding:14px 22px;background:#fafaf8;border-top:1px solid var(--bd);display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:#666;align-items:center;">
      <span><span class="ds-badge ds-team" style="font-size:9px;">팀수</span></span>
      <span><span class="ds-badge ds-ppl" style="font-size:9px;">인원</span></span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--grn);margin-right:3px;"></span>확정</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--org);margin-right:3px;"></span>대기</span>
      <span id="ccMC" style="margin-left:auto;font-weight:900;font-size:14px;color:var(--p);background:#e8f5e9;padding:4px 12px;border-radius:6px;"></span>
    </div>
  </div>
  <!-- Day detail for customer -->
  <div class="card" id="ccDayCard" style="display:none;margin-top:16px;">
    <div class="chd"><h3 id="ccDayTitle"></h3></div>
    <div class="cbd" id="ccDayBody"></div>
  </div>
  <!-- Monthly summary -->
  <div class="card" style="margin-top:16px;">
    <div class="chd"><h3>📊 월간 요약</h3></div>
    <div class="cbd" id="ccMonthSummary"></div>
  </div>
</div>

<!-- ADMIN: Dashboard -->
<div class="page" id="p-ad">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
    <h2 style="font-size:18px;font-weight:900;color:var(--p);margin:0;">📊 대시보드</h2>
    <button id="dashFilterToggle" onclick="toggleDashFilter()" style="padding:6px 14px;background:var(--p);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;">📅 기간조회 ▼</button>
    <span id="dashFilterLabel" style="font-size:13px;color:#666;"></span>
  </div>
  <div id="dashFilterPanel" style="display:none;margin-bottom:10px;padding:16px;background:linear-gradient(135deg,var(--p),var(--p2));border-radius:12px;">
    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
      <input type="date" id="drFrom" style="font-size:13px;padding:7px 10px;border:2px solid rgba(255,255,255,.4);border-radius:8px;background:rgba(255,255,255,.15);color:#fff;">
      <span style="color:#fff;font-size:14px;">~</span>
      <input type="date" id="drTo" style="font-size:13px;padding:7px 10px;border:2px solid rgba(255,255,255,.4);border-radius:8px;background:rgba(255,255,255,.15);color:#fff;">
      <button onclick="applyDrFilter()" style="padding:7px 14px;background:#fff;color:var(--p);border:none;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;">🔍 조회</button>
      <button id="drDlBtn" onclick="doDailyReport()" style="padding:7px 14px;background:#FEE500;color:#333;border:none;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;">📥 리포트</button>
    </div>
    <div style="display:flex;gap:4px;margin-top:8px;flex-wrap:wrap;">
      <button class="btn bs" onclick="setDrRange('today')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">오늘</button>
      <button class="btn bs" onclick="setDrRange('week')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">이번주</button>
      <button class="btn bs" onclick="setDrRange('month')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">이번달</button>
      <button class="btn bs" onclick="setDrRange('3m')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">3개월</button>
      <button class="btn bs" onclick="setDrRange('6m')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">6개월</button>
      <button class="btn bs" onclick="setDrRange('year')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">올해</button>
      <button class="btn bs" onclick="setDrRange('all')" style="font-size:12px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);">전체</button>
    </div>
  </div>
  <div id="drPreview" style="display:none;margin-bottom:16px;"></div>
  <div class="subtab-bar" id="adSubTabs">
    <button class="on" onclick="showAdSec('overview',this)">📊 요약+주간</button>
    <button onclick="showAdSec('revenue',this)">💰 매출</button>
    <button onclick="showAdSec('flow',this)">📆 신청→방문</button>
    <button onclick="showAdSec('category',this)">🏢 유형별</button>
    <button onclick="showAdSec('all',this)">📋 전체</button>
  </div>
  <div data-ad-sec="overview">
  <div id="dStats" style="display:grid;grid-template-columns:repeat(4,1fr) repeat(2,minmax(0,1.5fr));gap:6px;margin-bottom:8px;"></div>
  <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;">
    <button onclick="exportStatExcel('today')" style="padding:6px 12px;background:#1a472a;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">📥 오늘</button>
    <button onclick="exportStatReport('today')" style="padding:6px 12px;background:#1565c0;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">📋 리포트</button>
    <button onclick="exportStatExcel('month')" style="padding:6px 12px;background:#2d6a4f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">📥 월간</button>
    <button onclick="toggleAutoSendPanel()" id="autoSendToggleBtn" style="padding:6px 12px;background:#e65100;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;">⏰ 자동발송</button>
  </div>
  <div id="autoSendPanel" style="display:none;margin-bottom:10px;">
    <div class="card" style="margin:0;border:2px solid #e65100;">
      <div class="cbd">
        <h3 style="font-size:14px;font-weight:800;color:#e65100;margin-bottom:12px;">⏰ 데일리 리포트 자동발송 설정</h3>
        <p style="font-size:11px;color:#888;margin-bottom:14px;">설정된 시간에 관리자 연락처로 데일리 리포트를 카카오톡 또는 문자로 자동 발송합니다.</p>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#fff5f0;border-radius:10px;">
            <div><span style="font-weight:700;font-size:13px;">📱 카카오톡 발송</span><br><span style="font-size:10px;color:#888;">매일 오전 리포트 카톡 발송</span></div>
            <div class="tg on" id="tgKakaoDaily" onclick="this.classList.toggle('on');saveAutoSend();"></div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#fff5f0;border-radius:10px;">
            <div><span style="font-weight:700;font-size:13px;">💬 문자(SMS) 발송</span><br><span style="font-size:10px;color:#888;">매일 요약 문자 발송</span></div>
            <div class="tg" id="tgSmsDaily" onclick="this.classList.toggle('on');saveAutoSend();"></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
            <div class="fg"><label style="font-size:11px;font-weight:700;">발송 시간</label>
              <select id="autoSendTime" onchange="saveAutoSend()" style="padding:8px;border:2px solid #ddd;border-radius:8px;font-size:13px;">
                <option value="07:00">오전 7:00</option><option value="08:00" selected>오전 8:00</option><option value="09:00">오전 9:00</option><option value="10:00">오전 10:00</option>
                <option value="18:00">오후 6:00</option><option value="20:00">오후 8:00</option><option value="21:00">오후 9:00</option>
              </select>
            </div>
            <div class="fg"><label style="font-size:11px;font-weight:700;">수신 연락처</label>
              <input type="tel" id="autoSendPhone" placeholder="010-0000-0000" onchange="saveAutoSend()" style="padding:8px;border:2px solid #ddd;border-radius:8px;font-size:13px;width:150px;">
            </div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
            <div class="fg"><label style="font-size:11px;font-weight:700;">리포트 유형</label>
              <select id="autoSendType" onchange="saveAutoSend()" style="padding:8px;border:2px solid #ddd;border-radius:8px;font-size:13px;">
                <option value="today">오늘 예약</option><option value="pending">대기 중</option><option value="confirmed">확정</option><option value="month">이번달</option><option value="monthEst">이달 견적</option>
              </select>
            </div>
            <div class="fg"><label style="font-size:11px;font-weight:700;">발송 주기</label>
              <select id="autoSendFreq" onchange="saveAutoSend()" style="padding:8px;border:2px solid #ddd;border-radius:8px;font-size:13px;">
                <option value="daily">매일</option><option value="weekday">평일만</option><option value="weekly">매주 월요일</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:6px;margin-top:4px;">
            <button onclick="testAutoSend('kakao')" style="flex:1;padding:10px;background:#FEE500;color:#333;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;">💬 카카오톡 테스트 발송</button>
            <button onclick="testAutoSend('sms')" style="flex:1;padding:10px;background:#1565c0;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;">📱 문자 테스트 발송</button>
          </div>
          <div id="autoSendStatus" style="font-size:11px;color:#888;padding:6px 0;"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="dStatDetail" style="display:none;margin-bottom:10px;"></div>
  <div id="dashChatAlert" style="margin-bottom:10px;"></div>
  <div class="card" style="margin-bottom:10px;"><div class="chd" style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;"><h3 style="font-size:16px;">📅 주간 예약 현황</h3><button onclick="exportWeekExcel()" style="padding:5px 12px;background:#1a472a;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;">📥 엑셀</button></div>
    <div class="cbd" id="dashWeekAll" style="display:flex;flex-direction:column;gap:12px;padding:10px 16px;"></div>
    <div id="insightDash" style="margin:8px 16px;"></div>
  </div>
  </div>
  <div data-ad-sec="revenue" style="display:none;">
  <div class="card"><div class="chd" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
    <h3>💰 매출 통계</h3>
    <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
      <button class="btn bs" onclick="setRevPeriod('week')" id="rv_week" style="font-size:10px;">주별</button>
      <button class="btn bs" onclick="setRevPeriod('month')" id="rv_month" style="font-size:10px;">월별</button>
      <button class="btn bs" onclick="setRevPeriod('day')" id="rv_day" style="font-size:10px;">일별</button>
      <span style="color:#ccc;margin:0 2px;">|</span>
      <button class="btn bs" onclick="setRevRange('1m')" id="rr_1m" style="font-size:10px;">1개월</button>
      <button class="btn bs" onclick="setRevRange('3m')" id="rr_3m" style="font-size:10px;">3개월</button>
      <button class="btn bs" onclick="setRevRange('6m')" id="rr_6m" style="font-size:10px;">6개월</button>
      <button class="btn bs" onclick="setRevRange('1y')" id="rr_1y" style="font-size:10px;">1년</button>
      <button class="btn bs" onclick="setRevRange('all')" id="rr_all" style="font-size:10px;">전체</button>
      <span style="color:#ccc;margin:0 2px;">|</span>
      <input type="date" id="rvFrom" style="font-size:10px;padding:3px 6px;border:1px solid #ddd;border-radius:5px;">
      <span style="font-size:10px;color:#888;">~</span>
      <input type="date" id="rvTo" style="font-size:10px;padding:3px 6px;border:1px solid #ddd;border-radius:5px;">
      <button class="btn bs" onclick="setRevRange('custom')" style="font-size:10px;background:var(--p);color:#fff;">조회</button>
    </div>
  </div><div class="cbd">
    <div id="revPeriodLabel" style="font-size:11px;color:#888;margin-bottom:8px;"></div>
    <div id="revSummary" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;"></div>
    <div id="revChart" style="position:relative;height:260px;margin-bottom:10px;"></div>
    <div id="revTable" style="overflow-x:auto;"></div>
    <div style="text-align:right;margin-top:10px;">
      <button class="btn bs" onclick="exportRevExcel()" style="background:#1a472a;color:#fff;font-size:11px;padding:8px 16px;">📥 매출통계 엑셀 다운로드</button>
    </div>
    <div id="insightRev" style="margin-top:12px;"></div>
  </div></div>
  </div>
  <div data-ad-sec="flow" style="display:none;">
  <div class="card"><div class="chd" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
    <h3>📆 신청월 → 방문월 흐름</h3>
    <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
      <button class="btn bs" onclick="setLtPeriod('month')" id="lt_month" style="font-size:10px;">월별</button>
      <button class="btn bs" onclick="setLtPeriod('year')" id="lt_year" style="font-size:10px;">년별</button>
      <span style="color:#ccc;margin:0 2px;">|</span>
      <button class="btn bs" onclick="setLtRange('1w')" id="lr_1w" style="font-size:10px;">주간</button>
      <button class="btn bs" onclick="setLtRange('1m')" id="lr_1m" style="font-size:10px;">월간</button>
      <button class="btn bs" onclick="setLtRange('3m')" id="lr_3m" style="font-size:10px;">3개월</button>
      <button class="btn bs" onclick="setLtRange('6m')" id="lr_6m" style="font-size:10px;">6개월</button>
      <button class="btn bs" onclick="setLtRange('1y')" id="lr_1y" style="font-size:10px;">1년</button>
      <button class="btn bs" onclick="setLtRange('all')" id="lr_all" style="font-size:10px;">전체</button>
      <span style="color:#ccc;margin:0 2px;">|</span>
      <input type="date" id="ltFrom" style="font-size:10px;padding:3px 6px;border:1px solid #ddd;border-radius:5px;">
      <span style="font-size:10px;color:#888;">~</span>
      <input type="date" id="ltTo" style="font-size:10px;padding:3px 6px;border:1px solid #ddd;border-radius:5px;">
      <button class="btn bs" onclick="setLtRange('custom')" style="font-size:10px;background:var(--p);color:#fff;">조회</button>
    </div>
  </div><div class="cbd">
    <div id="ltPeriodLabel" style="font-size:11px;color:#888;margin-bottom:8px;"></div>
    <div id="ltSummary" style="margin-bottom:16px;"></div>
    <div id="ltFlow" style="overflow-x:auto;margin-bottom:16px;"></div>
    <div id="ltTable" style="overflow-x:auto;"></div>
    <div style="text-align:right;margin-top:10px;">
      <button class="btn bs" onclick="exportLtExcel()" style="background:#1a472a;color:#fff;font-size:11px;padding:8px 16px;">📥 신청→방문 흐름 엑셀 다운로드</button>
    </div>
    <div id="insightLt" style="margin-top:12px;"></div>
  </div></div>
  </div>
  <div data-ad-sec="category" style="display:none;">
  <div class="card"><div class="chd" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
    <h3>🏢 단체유형별 통계</h3>
    <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
      <button class="btn bs" onclick="setCatPeriod('1m')" id="cp_1m" style="font-size:10px;">1개월</button>
      <button class="btn bs" onclick="setCatPeriod('3m')" id="cp_3m" style="font-size:10px;">3개월</button>
      <button class="btn bs" onclick="setCatPeriod('6m')" id="cp_6m" style="font-size:10px;">6개월</button>
      <button class="btn bs" onclick="setCatPeriod('1y')" id="cp_1y" style="font-size:10px;">1년</button>
      <button class="btn bs" onclick="setCatPeriod('all')" id="cp_all" style="font-size:10px;">전체</button>
      <span style="color:#ccc;margin:0 2px;">|</span>
      <input type="date" id="cpFrom" style="font-size:10px;padding:3px 6px;border:1px solid #ddd;border-radius:5px;">
      <span style="font-size:10px;color:#888;">~</span>
      <input type="date" id="cpTo" style="font-size:10px;padding:3px 6px;border:1px solid #ddd;border-radius:5px;">
      <button class="btn bs" onclick="setCatPeriod('custom')" style="font-size:10px;background:var(--p);color:#fff;">조회</button>
      <span style="color:#ccc;margin:0 2px;">|</span>
      <button class="btn bs" onclick="exportCatExcel()" style="font-size:10px;background:#1565C0;color:#fff;">📥 엑셀</button>
    </div>
  </div><div class="cbd">
    <div id="catPeriodLabel" style="font-size:11px;color:#888;margin-bottom:10px;"></div>
    <div id="catSummary" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:16px;"></div>
    <div id="catChart" style="margin-bottom:16px;"></div>
    <div id="catTable" style="overflow-x:auto;margin-bottom:16px;"></div>
    <div id="catCross" style="overflow-x:auto;"></div>
    <div id="insightCat" style="margin-top:12px;"></div>
  </div></div>
  </div>
</div>

<!-- ADMIN: Calendar -->
<div class="page" id="p-ac">
  <div class="card cal-wrap">
    <div class="cal-hd"><h2 id="cT" style="display:flex;align-items:baseline;gap:0;margin:0;">
      <select id="cYearSel" onchange="cY=parseInt(this.value);rCal();" style="font-size:22px;font-weight:900;color:#fff;border:none;background:rgba(255,255,255,.12);border-radius:6px;cursor:pointer;padding:2px 6px;outline:none;-webkit-appearance:none;appearance:none;text-align:center;width:66px;"></select><span style="font-size:22px;font-weight:900;color:#fff;">년 </span>
      <select id="cMonthSel" onchange="cMo=parseInt(this.value);rCal();" style="font-size:22px;font-weight:900;color:#fff;border:none;background:rgba(255,255,255,.12);border-radius:6px;cursor:pointer;padding:2px 6px;outline:none;-webkit-appearance:none;appearance:none;text-align:center;width:36px;"></select><span style="font-size:22px;font-weight:900;color:#fff;">월</span>
    </h2><div class="cnav"><button onclick="cM(-1)">◀</button><button onclick="cM(0)" style="font-size:11px;width:auto;padding:0 10px;">오늘</button><button onclick="cM(1)">▶</button></div></div>
    <div class="cgrid" id="cG"></div>
    <div style="padding:14px 22px;background:#fafaf8;border-top:1px solid var(--bd);display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:#666;align-items:center;">
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--grn);margin-right:3px;"></span>확정</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--org);margin-right:3px;"></span>대기</span>
      <span id="cMC" style="margin-left:auto;font-weight:900;font-size:14px;color:var(--p);background:#e8f5e9;padding:4px 12px;border-radius:6px;"></span>
    </div>
  </div>
  <div class="card" id="dCard" style="display:none;">
    <div class="chd"><h3 id="dTitle"></h3><button class="btn bg bs" onclick="goSch()">📋 일정표</button></div>
    <div id="dDaySummary" style="padding:8px 16px;"></div>
    <div class="cbd" style="overflow-x:auto;"><table class="tbl" id="dTb2"><thead><tr><th>단체</th><th>시간</th><th>인원</th><th>코스/식사</th><th>부가체험</th><th>특이사항</th><th>상태</th><th>관리</th></tr></thead><tbody></tbody></table></div>
  </div>
  <div class="card">
    <div id="cMonthStats" style="padding:16px 22px;background:#fff;"></div>
  </div>
</div>

<!-- ADMIN: All Bookings -->
<div class="page" id="p-ab">
  <!-- Search & Filters -->
  <div class="card"><div class="cbd" style="padding:16px 22px;">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <input type="text" id="fQ" oninput="rAll()" placeholder="🔍 단체명·연락처 검색" style="flex:1;min-width:160px;border:2px solid var(--bd);border-radius:9px;padding:8px 12px;font-size:13px;outline:none;">
      <select id="fS" onchange="rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;">
        <option value="all">전체 상태</option><option value="확정">✅ 확정</option><option value="대기">⏳ 대기</option><option value="취소">❌ 취소</option>
      </select>
      <select id="fC" onchange="rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;">
        <option value="all">전체 코스</option><option value="기본코스">기본코스</option><option value="기본코스+단체식">기본코스+단체식</option>
      </select>
      <select id="fMl" onchange="rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;">
        <option value="all">식사 전체</option><option value="이용함">🍚 이용함</option><option value="이용안함">이용안함</option>
      </select>
      <select id="fCat" onchange="rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;background:#E8F5E9;">
        <option value="all">전체 기관</option>
      </select>
      <select id="fCh" onchange="rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 10px;font-size:12px;outline:none;background:#FFF3E0;">
        <option value="all">전체 채널</option><option value="direct">📋 직접예약</option><option value="agency_all">🏢 대행사(전체)</option>
      </select>
      <button class="btn" onclick="rAll()" style="padding:8px 16px;background:#1565C0;color:#fff;font-size:11px;font-weight:800;border-radius:8px;border:none;cursor:pointer;">🔍 조회</button>
      <button class="btn bo" onclick="expAll()" style="padding:8px 16px;">📥 엑셀</button>
      <button onclick="addNewBk()" style="padding:8px 16px;background:#2e7d32;color:#fff;font-size:11px;font-weight:800;border-radius:8px;border:none;cursor:pointer;">➕ 새 예약</button>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid #eee;">
      <div style="display:flex;gap:4px;align-items:center;flex-shrink:0;">
        <button onclick="setAbDateRange('today')" class="ab-dq" id="abdq_today" style="padding:5px 12px;border:2px solid var(--p);border-radius:20px;background:var(--p);color:#fff;font-size:11px;font-weight:800;cursor:pointer;transition:all .15s;">오늘</button>
        <button onclick="setAbDateRange('week')" class="ab-dq" id="abdq_week" style="padding:5px 12px;border:2px solid #ddd;border-radius:20px;background:#fff;color:#666;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;">이번주</button>
        <button onclick="setAbDateRange('month')" class="ab-dq" id="abdq_month" style="padding:5px 12px;border:2px solid #ddd;border-radius:20px;background:#fff;color:#666;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;">이번달</button>
        <button onclick="setAbDateRange('all')" class="ab-dq" id="abdq_all" style="padding:5px 12px;border:2px solid #ddd;border-radius:20px;background:#fff;color:#666;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;">전체</button>
      </div>
      <div style="display:flex;gap:4px;align-items:center;margin-left:6px;">
        <span style="font-size:11px;color:#888;font-weight:600;">📅</span>
        <input type="date" id="fDateFrom" onchange="setAbDateRange('custom');rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:6px 8px;font-size:12px;outline:none;">
        <span style="font-size:11px;color:#aaa;">~</span>
        <input type="date" id="fDateTo" onchange="setAbDateRange('custom');rAll()" style="border:2px solid var(--bd);border-radius:8px;padding:6px 8px;font-size:12px;outline:none;">
      </div>
    </div>
  </div></div>

  <!-- Summary -->
  <div id="abSummary" style="display:flex;flex-direction:column;gap:0;margin-bottom:12px;"></div>

  <!-- Date-grouped bookings -->
  <div id="abList"></div>
</div>

<!-- ADMIN: Schedule -->
<div class="page" id="p-as">
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
    <div style="background:#fff;border-radius:10px;padding:9px 16px;border:1px solid var(--bd);display:flex;align-items:center;gap:6px;">
      <span style="font-size:12px;font-weight:700;color:#555;">📅</span>
      <input type="date" id="sD" style="border:2px solid var(--bd);border-radius:7px;padding:5px 10px;font-size:13px;outline:none;">
    </div>
    <button class="btn bg" onclick="bSch()">⚡ 자동 생성</button>
    <button class="btn" style="background:linear-gradient(135deg,#78909C,#546E7A);color:#fff;padding:9px 18px;font-size:12px;" onclick="regenSch()" id="regenBtn">🔄 새로 생성</button>
    <button class="btn bb" onclick="saveSch()" id="savSchBtn" style="display:none;">💾 저장</button>
    <button class="btn bo" onclick="expSch()">📥 엑셀</button>
    <button class="btn bk" onclick="sendDK()">💬 일정 카톡</button>
    <button class="btn bs" style="background:#e3f2fd;color:#1565c0;padding:9px 14px;font-size:12px;" onclick="toggleSchRules()">📐 조건설정</button>
  </div>
  <!-- Schedule Rules -->
  <div class="card" id="schRulesCard" style="display:none;margin-bottom:16px;">
    <div class="chd"><h3>📐 일정표 생성 조건</h3></div>
    <div class="cbd" style="padding:16px 22px;">
      <div style="font-size:11px;color:#888;margin-bottom:12px;">조건을 설정하면 자동 생성 시 규칙이 적용됩니다.</div>
      <div id="schRulesList" style="margin-bottom:12px;"></div>
      <div style="padding:12px;background:#f9f9f9;border-radius:8px;">
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
          <select id="srType" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
            <option value="fix">🔒 고정</option>
            <option value="ban">🚫 금지</option>
            <option value="first">⭐ 우선배정</option>
          </select>
          <select id="srGroup" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
            <option value="all">전체 단체</option>
          </select>
          <select id="srTime" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
            <option value="all">전체시간</option>
          </select>
          <select id="srDur" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
            <option value="1">30분 (1칸)</option>
            <option value="2">1시간 (2칸)</option>
            <option value="3">1시간30분 (3칸)</option>
          </select>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <select id="srAct" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;"></select>
          <input type="text" id="srMemo" placeholder="비고(선택)" style="width:100px;padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;">
          <button class="btn bg bs" onclick="addSchRule()">+ 추가</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Saved schedules list -->
  <div class="card" id="savedSchCard" style="margin-bottom:16px;">
    <div class="chd" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;">
      <h3 style="font-size:17px;font-weight:800;">💾 저장된 일정표</h3>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <input type="date" id="savedSchFrom" style="padding:5px 8px;border:1px solid #ccc;border-radius:6px;font-size:13px;">
        <span style="font-size:13px;color:#888;">~</span>
        <input type="date" id="savedSchTo" style="padding:5px 8px;border:1px solid #ccc;border-radius:6px;font-size:13px;">
        <button onclick="renderSavedList()" style="padding:5px 14px;background:var(--p);color:#fff;border:none;border-radius:6px;font-size:13px;cursor:pointer;font-weight:700;">조회</button>
        <button onclick="setSavedSchRange(0)" style="padding:5px 12px;background:#fff;border:1px solid #bbb;border-radius:6px;font-size:13px;cursor:pointer;font-weight:600;">오늘</button>
        <button onclick="setSavedSchRange(7)" style="padding:5px 12px;background:#fff;border:1px solid #bbb;border-radius:6px;font-size:13px;cursor:pointer;font-weight:600;">1주일</button>
        <button onclick="setSavedSchRange(30)" style="padding:5px 12px;background:#fff;border:1px solid #bbb;border-radius:6px;font-size:13px;cursor:pointer;font-weight:600;">1개월</button>
        <button onclick="document.getElementById('savedSchFrom').value='';document.getElementById('savedSchTo').value='';renderSavedList();" style="padding:5px 12px;background:#fff;border:1px solid #ccc;border-radius:6px;font-size:13px;cursor:pointer;font-weight:600;">전체</button>
      </div>
    </div>
    <div class="cbd" id="savedSchList" style="padding:14px 22px;max-height:400px;overflow-y:auto;"></div>
  </div>
  <div class="card" id="sW" style="display:none;">
    <div style="background:linear-gradient(135deg,var(--p),var(--p2));padding:14px 22px;color:#fff;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
      <h2 id="sT" style="font-size:20px;font-weight:800;"></h2>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <button onclick="saveSch()" id="schSavedBadge" style="display:none;padding:6px 16px;border-radius:8px;font-size:13px;font-weight:800;cursor:pointer;border:2px solid #fff;background:rgba(255,255,255,.2);color:#fff;transition:all .2s;" onmouseenter="this.style.background='rgba(255,255,255,.4)'" onmouseleave="this.style.background='rgba(255,255,255,.2)'">💾 저장</button>
        <button onclick="previewSchExcel()" id="schExcelPreviewBtn" style="display:none;padding:6px 16px;border-radius:8px;font-size:13px;font-weight:800;cursor:pointer;border:2px solid #81C784;background:rgba(129,199,132,.25);color:#fff;transition:all .2s;" onmouseenter="this.style.background='rgba(129,199,132,.45)'" onmouseleave="this.style.background='rgba(129,199,132,.25)'">👁 엑셀 미리보기</button>
        <button onclick="expSch()" id="schExcelDlBtn" style="display:none;padding:6px 16px;border-radius:8px;font-size:13px;font-weight:800;cursor:pointer;border:2px solid #64B5F6;background:rgba(100,181,246,.25);color:#fff;transition:all .2s;" onmouseenter="this.style.background='rgba(100,181,246,.45)'" onmouseleave="this.style.background='rgba(100,181,246,.25)'">📥 엑셀 다운로드</button>
        <span id="sCB" style="display:none;background:#ff5252;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;color:#fff;"></span>
      </div>
    </div>
    <div style="overflow-x:auto;"><table class="st" id="sTbl"></table></div>
    <div style="padding:12px 20px;background:#f9f9f9;border-top:1px solid #eee;font-size:13px;color:#777;text-align:center;font-weight:600;">셀 클릭 → 드롭다운 변경 | 더블클릭 → 직접 입력 | 💾 수정 후 저장 버튼으로 보관 | ⚠️ 빨간색 = 충돌 | 📝 헤더 = 고객 특이사항</div>
  </div>
  <div class="card" id="sLocCard" style="display:none;margin-top:12px;">
    <div style="background:#37474F;padding:14px 22px;color:#fff;border-radius:14px 14px 0 0;">
      <h3 style="font-size:18px;font-weight:800;color:#fff;">📍 시간대별 장소별 인원 현황</h3>
    </div>
    <div style="overflow-x:auto;"><table class="st" id="sLocTbl"></table></div>
  </div>
</div>

<!-- ADMIN: Chat -->
<div class="page" id="p-at">
  <div class="card" style="margin-bottom:0;">
    <div class="chd" style="display:flex;justify-content:space-between;align-items:center;">
      <h3>💬 채팅 목록</h3>
      <div style="display:flex;gap:6px;align-items:center;">
        <span id="chatOnlineBadge" style="font-size:10px;color:#4CAF50;">● 사용중</span>
      </div>
    </div>
  </div>
  <div style="display:flex;border-bottom:2px solid #eee;background:#fff;">
    <button class="chatTab chatTabAct" onclick="switchChatTab('all',this)" style="flex:1;padding:10px;border:none;background:none;font-size:12px;font-weight:700;cursor:pointer;border-bottom:2px solid var(--p);color:var(--p);">전체 채팅목록</button>
    <button class="chatTab" onclick="switchChatTab('star',this)" style="flex:1;padding:10px;border:none;background:none;font-size:12px;font-weight:700;cursor:pointer;color:#888;">⭐ 중요채팅</button>
    <button class="chatTab" onclick="switchChatTab('block',this)" style="flex:1;padding:10px;border:none;background:none;font-size:12px;font-weight:700;cursor:pointer;color:#888;">🚫 차단목록</button>
    <button class="chatTab" onclick="switchChatTab('faq',this)" style="flex:1;padding:10px;border:none;background:none;font-size:12px;font-weight:700;cursor:pointer;color:#888;">📋 자주묻는질문</button>
  </div>
  <div style="display:flex;gap:6px;padding:10px 16px;background:#fff;border-bottom:1px solid #eee;flex-wrap:wrap;align-items:center;">
    <select id="chatFilter" onchange="renderChatList()" style="padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;">
      <option value="all">전체 상담</option>
      <option value="active" selected>진행 중 상담</option>
      <option value="waiting">대기 중</option>
      <option value="done">완료</option>
    </select>
    <input type="text" id="chatSearch" placeholder="채팅방 이름 검색" oninput="renderChatList()" style="flex:1;min-width:120px;padding:5px 10px;border:1px solid #ddd;border-radius:6px;font-size:11px;">
    <button onclick="renderChatList()" style="padding:5px 10px;background:var(--p);color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;">🔍</button>
  </div>
  <div style="display:flex;height:calc(100vh - 260px);background:#fff;">
    <div id="chatListPanel" style="width:360px;border-right:1px solid #eee;overflow-y:auto;"></div>
    <div id="chatMsgPanel" style="flex:1;display:flex;flex-direction:column;">
      <div id="chatMsgEmpty" style="flex:1;display:flex;align-items:center;justify-content:center;color:#aaa;font-size:14px;">💬 채팅을 선택하세요</div>
      <div id="chatMsgHeader" style="display:none;padding:10px 16px;background:#f9f9f9;border-bottom:1px solid #eee;"></div>
      <div id="chatMsgBody" style="display:none;flex:1;overflow-y:auto;padding:16px;background:#e8e4de;"></div>
      <div id="chatMsgInput" style="display:none;padding:10px 16px;background:#fff;border-top:1px solid #eee;"></div>
    </div>
  </div>
</div>

<!-- ADMIN: Settings -->
<div class="page" id="p-ax">
  <div class="subtab-bar" id="axSubTabs">
    <button class="on" onclick="showAxSec('facility',this)">🏕️ 시설</button>
    <button onclick="showAxSec('data',this)">📥 데이터</button>
    <button onclick="showAxSec('admin',this)">👥 관리자</button>
    <button onclick="showAxSec('account',this)">🔐 계정</button>
    <button onclick="showAxSec('form',this)">📝 예약폼</button>
    <button onclick="showAxSec('agency',this)">🏢 대행사</button>
    <button onclick="showAxSec('system',this)">🔧 시스템</button>
    <button onclick="showAxSec('update',this)">🔄 업데이트</button>
    <button onclick="showAxSec('all',this)">📋 전체</button>
  </div>
  <div data-ax-sec="facility">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">🏕️ 시설 관리</h3>
    <div id="adminFacList" style="margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <input type="text" id="adminNewFac" placeholder="새 시설명 입력" style="flex:1;padding:10px 12px;border:2px solid #ddd;border-radius:10px;font-size:13px;">
      <button class="btn bg" onclick="adminAddFacility()">+ 시설 추가</button>
    </div>
  </div></div>
  </div>
  <div data-ax-sec="data" style="display:none;">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:8px;">📥 예약 엑셀 일괄 업로드</h3>
    <p style="font-size:11px;color:#888;margin-bottom:14px;">엑셀 파일(.xls/.xlsx/.csv)로 예약 데이터를 한꺼번에 등록합니다.</p>
    <div style="margin-bottom:12px;">
      <button class="btn" onclick="downloadBulkTemplate()" style="background:#2d6a4f;color:#fff;padding:8px 16px;font-size:12px;font-weight:700;">📋 양식 다운로드</button>
      <span style="font-size:10px;color:#aaa;margin-left:8px;">양식에 맞춰 데이터를 입력 후 업로드하세요</span>
    </div>
    <div id="bulkDropZone" onclick="document.getElementById('bulkFileInput').click()" ondragover="event.preventDefault();this.style.background='#e0f2e0';this.style.borderColor='var(--p)'" ondragleave="this.style.background='#fafff8';this.style.borderColor='#a5d6a7'" ondrop="event.preventDefault();this.style.background='#fafff8';this.style.borderColor='#a5d6a7';var f=event.dataTransfer.files[0];if(f){document.getElementById('bulkFileInput').files=event.dataTransfer.files;handleBulkUpload(document.getElementById('bulkFileInput'));}" style="border:2px dashed #a5d6a7;border-radius:12px;padding:30px 20px;text-align:center;cursor:pointer;background:#fafff8;transition:all .2s;" onmouseenter="this.style.background='#eef7f0';this.style.borderColor='var(--p)'" onmouseleave="this.style.background='#fafff8';this.style.borderColor='#a5d6a7'">
      <div style="font-size:32px;margin-bottom:6px;">📤</div>
      <div style="font-size:13px;font-weight:700;color:var(--p);">클릭 또는 파일을 여기에 놓으세요</div>
      <div style="font-size:11px;color:#aaa;margin-top:4px;">.xls, .xlsx, .csv 지원</div>
      <input type="file" id="bulkFileInput" accept=".csv,.xls,.xlsx" style="display:none;" onchange="handleBulkUpload(this)">
    </div>
    <div id="bulkPreview" style="display:none;margin-top:14px;"></div>
  </div></div>
  </div>
  <div data-ax-sec="admin" style="display:none;">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">👥 관리자 관리</h3>
    <div id="adminMgmt"></div>
    <script>
    function renderAdminMgmt(){
      const el=document.getElementById('adminMgmt');if(!el)return;
      const isMaster=curAdmin&&curAdmin.role==='master';
      const permDefs=[
        {key:'dashboard',label:'📊 대시보드',desc:'대시보드 조회'},
        {key:'calendar',label:'📅 캘린더',desc:'캘린더 조회/예약 상세'},
        {key:'bookings',label:'📋 예약관리',desc:'예약 목록/상세/수정'},
        {key:'bookings_edit',label:'✏️ 예약수정',desc:'예약 정보 직접 수정'},
        {key:'bookings_delete',label:'🗑️ 예약삭제',desc:'예약 삭제 권한'},
        {key:'bookings_status',label:'✅ 상태변경',desc:'확정/대기/취소 변경'},
        {key:'agency',label:'🏢 대행사',desc:'대행사 관리/정산'},
        {key:'schedule',label:'🗓️ 일정표',desc:'일정표 조회/편집'},
        {key:'chat',label:'💬 채팅',desc:'채팅 상담/FAQ 관리'},
        {key:'settings',label:'⚙️ 설정',desc:'시설/코스/요금 설정'},
        {key:'excel',label:'📥 엑셀',desc:'엑셀 업로드/다운로드'},
        {key:'log',label:'📜 활동로그',desc:'활동로그 열람'}
      ];

      let h='';
      adminAccounts.forEach((a,i)=>{
        const roleLabel=a.role==='master'?'👑 마스터':'🔧 관리자';
        const roleBg=a.role==='master'?'#FFF3E0':'#E3F2FD';
        const roleColor=a.role==='master'?'#E65100':'#1565C0';
        const isMe=curAdmin&&curAdmin.id===a.id;
        const photoUrl=a.photo||'';
        const initial=a.name.charAt(0);
        const colors=['#1976d2','#c2185b','#00796b','#e65100','#6a1b9a','#2e7d32'];
        const bgc=colors[i%colors.length];
        if(!a.perms&&a.role!=='master')a.perms={dashboard:true,calendar:true,bookings:true,bookings_edit:false,bookings_delete:false,bookings_status:true,agency:false,schedule:true,chat:true,settings:false,excel:false,log:false};

        h+='<div style="border:1px solid #e0e0e0;border-radius:12px;margin-bottom:12px;overflow:hidden;background:#fff;">';
        // Header row
        h+='<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fafaf8;">';
        // Photo
        if(photoUrl){
          h+='<div style="position:relative;width:44px;height:44px;flex-shrink:0;"><img src="'+photoUrl+'" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid '+bgc+';"><button onclick="changeAdminPhoto('+i+')" style="position:absolute;bottom:-2px;right:-2px;width:18px;height:18px;border-radius:50%;background:#fff;border:1px solid #ccc;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;">📷</button></div>';
        } else {
          h+='<div style="position:relative;width:44px;height:44px;flex-shrink:0;"><div style="width:44px;height:44px;border-radius:50%;background:'+bgc+';color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;">'+initial+'</div><button onclick="changeAdminPhoto('+i+')" style="position:absolute;bottom:-2px;right:-2px;width:18px;height:18px;border-radius:50%;background:#fff;border:1px solid #ccc;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;">📷</button></div>';
        }
        // Info
        h+='<div style="flex:1;min-width:0;">';
        h+='<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;"><span style="font-size:14px;font-weight:700;">'+a.name+'</span>'+(isMe?' <span style="font-size:9px;color:#999;background:#f0f0f0;padding:1px 5px;border-radius:3px;">(나)</span>':'');
        h+=' <span style="background:'+roleBg+';color:'+roleColor+';padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;">'+roleLabel+'</span>';
        if(isMaster||isMe)h+=' <input type="text" value="'+(a.title||'')+'" placeholder="직책" style="width:60px;padding:2px 5px;border:1px solid #ddd;border-radius:4px;font-size:10px;" onchange="adminAccounts['+i+'].title=this.value;svAdmins();">';
        else if(a.title)h+=' <span style="font-size:10px;color:#888;background:#f5f5f5;padding:1px 6px;border-radius:3px;">'+a.title+'</span>';
        h+='</div>';
        h+='<div style="display:flex;gap:8px;margin-top:3px;font-size:11px;color:#888;">';
        h+='<span>🆔 '+a.id+'</span>';
        if(isMaster||isMe)h+='<span>📞 <input type="text" value="'+(a.phone||'')+'" placeholder="연락처" style="width:100px;padding:1px 4px;border:1px solid #ddd;border-radius:3px;font-size:10px;" onchange="adminAccounts['+i+'].phone=this.value;svAdmins();"></span>';
        else h+='<span>📞 '+(a.phone||'-')+'</span>';
        h+='</div></div>';
        // Right side buttons
        h+='<div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">';
        if(isMaster){
          const uid='admPw_'+i;
          h+='<div style="display:flex;align-items:center;gap:3px;"><input type="password" id="'+uid+'" value="'+a.pw+'" style="width:80px;padding:3px 6px;border:1px solid #ddd;border-radius:4px;font-size:10px;" onchange="adminAccounts['+i+'].pw=this.value;svAdmins();toast(\'비밀번호 변경됨\',\'s\');">';
          h+='<button onclick="const inp=document.getElementById(\''+uid+'\');if(inp.type===\'password\'){inp.type=\'text\';this.textContent=\'🙈\';}else{inp.type=\'password\';this.textContent=\'👁\';}" style="background:none;border:none;cursor:pointer;font-size:12px;">👁</button></div>';
        } else if(isMe){
          const uid='admPw_'+i;
          h+='<input type="password" id="'+uid+'" value="'+a.pw+'" style="width:80px;padding:3px 6px;border:1px solid #ddd;border-radius:4px;font-size:10px;" onchange="adminAccounts['+i+'].pw=this.value;svAdmins();toast(\'비밀번호 변경됨\',\'s\');">';
        } else {
          h+='<span style="color:#ccc;font-size:11px;">••••</span>';
        }
        if(isMaster&&a.role!=='master'){
          h+='<div style="display:flex;gap:3px;margin-top:2px;">';
          h+='<button onclick="promoteAdmin('+i+')" style="padding:2px 8px;background:#FFF3E0;color:#E65100;border:1px solid #E65100;border-radius:4px;font-size:9px;cursor:pointer;">마스터임명</button>';
          h+='<button onclick="removeAdmin('+i+')" style="padding:2px 8px;background:#FFEBEE;color:#c00;border:1px solid #c00;border-radius:4px;font-size:9px;cursor:pointer;">삭제</button>';
          h+='</div>';
        }
        h+='</div></div>';

        // Permission section (collapsible) - only for non-master, visible to master
        if(a.role!=='master'){
          h+='<div style="border-top:1px solid #eee;">';
          h+='<div onclick="togglePermPanel('+i+')" style="padding:8px 16px;background:#f9f9f6;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background=\'#f0f0eb\'" onmouseout="this.style.background=\'#f9f9f6\'">';
          h+='<span style="font-size:11px;font-weight:700;color:#555;">🔑 세부 권한 설정</span>';
          const permCount=permDefs.filter(p=>a.perms?.[p.key]).length;
          h+='<span style="font-size:10px;color:#888;">'+permCount+'/'+permDefs.length+' 활성 <span id="permArrow'+i+'" style="display:inline-block;transition:transform .2s;">▼</span></span>';
          h+='</div>';
          h+='<div id="permPanel'+i+'" style="display:none;padding:12px 16px;background:#fff;">';

          if(isMaster){
            // Quick buttons
            h+='<div style="display:flex;gap:6px;margin-bottom:10px;">';
            h+='<button onclick="setAllPerms('+i+',true)" style="padding:3px 10px;background:#e8f5e9;color:#2e7d32;border:1px solid #a5d6a7;border-radius:4px;font-size:10px;cursor:pointer;font-weight:600;">✅ 전체 허용</button>';
            h+='<button onclick="setAllPerms('+i+',false)" style="padding:3px 10px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:4px;font-size:10px;cursor:pointer;font-weight:600;">🚫 전체 차단</button>';
            h+='<button onclick="setDefaultPerms('+i+')" style="padding:3px 10px;background:#e3f2fd;color:#1565c0;border:1px solid #90caf9;border-radius:4px;font-size:10px;cursor:pointer;font-weight:600;">🔄 기본값</button>';
            h+='</div>';
            h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px;">';
            permDefs.forEach(p=>{
              const checked=a.perms?.[p.key]?'checked':'';
              h+='<label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border:1.5px solid '+(a.perms?.[p.key]?'#66bb6a':'#e0e0e0')+';border-radius:8px;cursor:pointer;background:'+(a.perms?.[p.key]?'#f1f8e9':'#fafafa')+';transition:all .15s;" onmouseover="this.style.boxShadow=\'0 1px 4px rgba(0,0,0,.1)\'" onmouseout="this.style.boxShadow=\'none\'">';
              h+='<input type="checkbox" '+checked+' onchange="togglePerm('+i+',\''+p.key+'\',this.checked)" style="accent-color:#4caf50;width:15px;height:15px;">';
              h+='<div><div style="font-size:11px;font-weight:700;color:#333;">'+p.label+'</div><div style="font-size:9px;color:#999;">'+p.desc+'</div></div>';
              h+='</label>';
            });
            h+='</div>';
          } else {
            // Non-master view (read only)
            h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px;">';
            permDefs.forEach(p=>{
              const has=a.perms?.[p.key];
              h+='<div style="display:flex;align-items:center;gap:6px;padding:6px 10px;border:1.5px solid '+(has?'#66bb6a':'#e0e0e0')+';border-radius:8px;background:'+(has?'#f1f8e9':'#fafafa')+'">';
              h+='<span style="font-size:14px;">'+(has?'✅':'❌')+'</span>';
              h+='<div><div style="font-size:11px;font-weight:700;color:'+(has?'#333':'#bbb')+';">'+p.label+'</div><div style="font-size:9px;color:#999;">'+p.desc+'</div></div>';
              h+='</div>';
            });
            h+='</div>';
          }
          h+='</div></div>';
        } else {
          // Master always has all permissions
          h+='<div style="padding:6px 16px;background:#FFF3E0;border-top:1px solid #ffe0b2;font-size:10px;color:#e65100;">👑 마스터는 모든 권한을 가집니다.</div>';
        }
        h+='</div>';
      });

      if(isMaster){
        h+='<div style="margin-top:16px;padding:14px;background:#f9f9f6;border-radius:10px;border:1px dashed #ccc;">';
        h+='<div style="font-size:12px;font-weight:700;margin-bottom:8px;">➕ 관리자 추가</div>';
        h+='<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end;">';
        h+='<div><label style="font-size:10px;color:#999;">이름</label><input type="text" id="newAdmName" placeholder="이름" style="display:block;width:80px;padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;"></div>';
        h+='<div><label style="font-size:10px;color:#999;">아이디</label><input type="text" id="newAdmId" placeholder="아이디" style="display:block;width:80px;padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;"></div>';
        h+='<div><label style="font-size:10px;color:#999;">비밀번호</label><input type="password" id="newAdmPw" placeholder="비밀번호" style="display:block;width:80px;padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;"></div>';
        h+='<div><label style="font-size:10px;color:#999;">직책</label><input type="text" id="newAdmTitle" placeholder="직책" style="display:block;width:70px;padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;"></div>';
        h+='<div><label style="font-size:10px;color:#999;">연락처</label><input type="text" id="newAdmPhone" placeholder="연락처" style="display:block;width:100px;padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;"></div>';
        h+='<button onclick="addAdmin()" class="btn bg" style="padding:5px 14px;font-size:11px;">추가</button>';
        h+='</div></div>';
      } else {
        h+='<div style="margin-top:12px;padding:10px;background:#FFF3E0;border-radius:8px;font-size:11px;color:#E65100;">⚠️ 관리자 추가/삭제는 마스터만 가능합니다.</div>';
      }
      el.innerHTML=h;
    }

    function togglePermPanel(i){
      const p=document.getElementById('permPanel'+i);
      const a=document.getElementById('permArrow'+i);
      if(!p)return;
      const open=p.style.display!=='none';
      p.style.display=open?'none':'block';
      if(a)a.style.transform=open?'rotate(0deg)':'rotate(180deg)';
    }
    function togglePerm(i,key,val){
      if(!adminAccounts[i].perms)adminAccounts[i].perms={};
      adminAccounts[i].perms[key]=val;
      svAdmins();
      renderAdminMgmt();
      // Re-open the panel
      setTimeout(()=>{const p=document.getElementById('permPanel'+i);if(p)p.style.display='block';const a=document.getElementById('permArrow'+i);if(a)a.style.transform='rotate(180deg)';},50);
    }
    function setAllPerms(i,val){
      if(!adminAccounts[i].perms)adminAccounts[i].perms={};
      ['dashboard','calendar','bookings','bookings_edit','bookings_delete','bookings_status','agency','schedule','chat','settings','excel','log'].forEach(k=>adminAccounts[i].perms[k]=val);
      svAdmins();renderAdminMgmt();
      setTimeout(()=>{const p=document.getElementById('permPanel'+i);if(p)p.style.display='block';const a=document.getElementById('permArrow'+i);if(a)a.style.transform='rotate(180deg)';},50);
    }
    function setDefaultPerms(i){
      adminAccounts[i].perms={dashboard:true,calendar:true,bookings:true,bookings_edit:false,bookings_delete:false,bookings_status:true,agency:false,schedule:true,chat:true,settings:false,excel:false,log:false};
      svAdmins();renderAdminMgmt();
      setTimeout(()=>{const p=document.getElementById('permPanel'+i);if(p)p.style.display='block';const a=document.getElementById('permArrow'+i);if(a)a.style.transform='rotate(180deg)';},50);
    }
    </script>
  </div></div>
  </div>
  <div data-ax-sec="account" style="display:none;">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">🔐 내 비밀번호 변경</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
      <div class="fg"><label>현재</label><input type="password" id="cpw" style="width:150px;"></div>
      <div class="fg"><label>새 비밀번호</label><input type="password" id="npw" style="width:150px;"></div>
      <button class="btn bg" onclick="chPw()">변경</button>
    </div>
  </div></div>

  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">💬 카카오톡 알림 설정</h3>
    <div class="sr"><div class="si"><h4>신규 예약 → 관리자 카톡</h4><p>새 예약 접수 시 알림</p></div><div class="tg on" onclick="this.classList.toggle('on')"></div></div>
    <div class="sr"><div class="si"><h4>예약 확정 → 고객 카톡</h4><p>확정 시 고객에게 알림</p></div><div class="tg on" onclick="this.classList.toggle('on')"></div></div>
    <div class="sr"><div class="si"><h4>방문 전일 리마인더 → 고객</h4><p>방문 전날 오전 10시 발송</p></div><div class="tg on" onclick="this.classList.toggle('on')"></div></div>
    <div class="sr"><div class="si"><h4>방문 1주 전 리마인더 → 고객</h4><p>방문 1주 전 발송</p></div><div class="tg on" onclick="this.classList.toggle('on')"></div></div>
    <div class="sr"><div class="si"><h4>일별 전체예약 요약 → 관리자</h4><p>매일 오전 8시, 당일 예약 요약</p></div><div class="tg on" onclick="this.classList.toggle('on')"></div></div>

    <div style="margin-top:18px;padding:16px;background:#FFF9C4;border-radius:11px;border:1px solid #f0d78c;">
      <h4 style="font-size:12px;font-weight:700;color:#7d6608;margin-bottom:10px;">🔑 알림톡 API</h4>
      <div class="fgrid" style="grid-template-columns:1fr 1fr;">
        <div class="fg"><label>API Key</label><input type="text" id="xK" placeholder="알리고/NCloud Key"></div>
        <div class="fg"><label>발신 프로필</label><input type="text" id="xP" placeholder="프로필 ID"></div>
        <div class="fg"><label>관리자 번호</label><input type="tel" id="xPh" value="010-6256-2969"></div>
        <div class="fg"><label>템플릿 코드</label><input type="text" id="xT" placeholder="코드"></div>
      </div>
      <p style="font-size:9px;color:#aaa;margin-top:8px;">미설정 시 브라우저 알림으로 대체</p>
      <button class="btn bk bs" onclick="testK()" style="margin-top:8px;">🔔 테스트</button>
    </div>
  </div></div>
  </div>
  <div data-ax-sec="form" style="display:none;">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">🏕️ 코스 관리</h3>
    <div id="csList"></div>
    <div style="display:flex;gap:6px;margin-top:8px;">
      <input type="text" id="nCs" placeholder="새 코스명" style="flex:1;border:2px solid var(--bd);border-radius:7px;padding:7px 10px;font-size:12px;outline:none;">
      <button class="btn bb bs" onclick="addCs()">추가</button>
    </div>
  </div></div>

  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">📝 예약폼 설정</h3>
    <p style="font-size:11px;color:#888;margin-bottom:14px;">고객 예약 신청 페이지에 표시되는 항목을 수정합니다.</p>

    <div style="background:#f9f9f6;border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:14px;">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:10px;">🍚 단체식 메뉴 관리</h4>
      <div id="fc_mealList"></div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <input type="text" id="fc_newMealName" placeholder="메뉴명" style="flex:1;padding:6px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;">
        <input type="number" id="fc_newMealP1" placeholder="유아가격" style="width:80px;padding:6px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;">
        <input type="number" id="fc_newMealP2" placeholder="초등가격" style="width:80px;padding:6px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;">
        <button class="btn bb bs" onclick="addFormMeal()">추가</button>
      </div>
    </div>

    <div style="background:#f9f9f6;border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:14px;">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:10px;">🎫 기본입장 안내문</h4>
      <div class="fg"><label>패키지 설명</label><textarea id="fc_pkgDesc" rows="2" style="font-size:12px;"></textarea></div>
      <div class="fgrid" style="gap:8px;margin-top:8px;">
        <div class="fg"><label>유아 입장료</label><input type="number" id="fc_entryP1" style="font-size:12px;"></div>
        <div class="fg"><label>초등 입장료</label><input type="number" id="fc_entryP2" style="font-size:12px;"></div>
        <div class="fg"><label>인솔자 입장료</label><input type="number" id="fc_entryTea" style="font-size:12px;"></div>
        <div class="fg"><label>유아 무료비율 (유아 X명당 1인솔 무료)</label><input type="number" id="fc_freeRatioChild" style="font-size:12px;"></div>
        <div class="fg"><label>초등 무료비율 (초등 X명당 1인솔 무료)</label><input type="number" id="fc_freeRatioElem" style="font-size:12px;"></div>
      </div>
    </div>

    <div style="background:#f9f9f6;border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:14px;">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:10px;">🎨 부가체험 항목</h4>
      <div id="fc_addonList"></div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <input type="text" id="fc_addonName" placeholder="체험명" style="flex:1;padding:6px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;">
        <input type="number" id="fc_addonPrice" placeholder="가격" style="width:80px;padding:6px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;">
        <button class="btn bb bs" onclick="addFormAddon()">추가</button>
      </div>
    </div>

    <div style="background:#f9f9f6;border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:14px;">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:10px;">📢 유입경로 항목</h4>
      <div id="fc_channelList"></div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <input type="text" id="fc_newChannel" placeholder="경로명 (예: SNS)" style="flex:1;padding:6px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;">
        <button class="btn bb bs" onclick="addFormChannel()">추가</button>
      </div>
    </div>

    <button class="btn bg" onclick="saveFormConfig()">💾 예약폼 설정 저장</button>
  </div></div>
  </div>
  <div data-ax-sec="agency" style="display:none;">
  <!-- Agency Management in Settings -->
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:#e65100;margin-bottom:6px;">🏢 대행사 관리</h3>
    <p style="font-size:11px;color:#888;margin-bottom:14px;">대행사 등록·수수료 설정·활성/비활성·강제탈퇴를 관리합니다.</p>
    <div id="agencyList"></div>
    <div style="margin-top:14px;padding:14px;background:#fff8e1;border-radius:10px;border:1px solid #ffe082;">
      <h4 style="font-size:12px;font-weight:700;color:#e65100;margin-bottom:10px;">➕ 새 대행사 등록</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div class="fg"><label style="font-size:10px;">대행사명 *</label><input type="text" id="ag_newName" placeholder="예: 해피투어" style="padding:7px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;"></div>
        <div class="fg"><label style="font-size:10px;">로그인코드 *</label><input type="text" id="ag_newCode" placeholder="예: happy01" style="padding:7px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;"></div>
        <div class="fg"><label style="font-size:10px;">비밀번호 *</label><input type="password" id="ag_newPw" placeholder="비밀번호" style="padding:7px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;"></div>
        <div class="fg"><label style="font-size:10px;">수수료율 (%)</label><input type="number" id="ag_newFee" placeholder="10" style="padding:7px 10px;font-size:12px;border:1px solid var(--bd);border-radius:6px;"></div>
      </div>
      <button class="btn" style="background:#e65100;color:#fff;width:100%;margin-top:10px;padding:10px;font-weight:700;border-radius:8px;" onclick="addAgency()">🏢 대행사 등록</button>
    </div>
  </div></div>
  </div>
  <div data-ax-sec="system" style="display:none;">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">🔧 시스템 정보</h3>
    <div id="sysInfoPanel"></div>
    <button onclick="renderSysInfo()" class="btn" style="background:var(--p);color:#fff;padding:8px 16px;font-size:12px;font-weight:700;margin-top:10px;">🔄 새로고침</button>
    <button onclick="runHealthCheck()" class="btn" style="background:#e65100;color:#fff;padding:8px 16px;font-size:12px;font-weight:700;margin-top:10px;margin-left:6px;">🩺 상태 점검</button>
    <button onclick="showChangelog()" class="btn" style="background:#1565c0;color:#fff;padding:8px 16px;font-size:12px;font-weight:700;margin-top:10px;margin-left:6px;">📋 변경 이력</button>
    <button onclick="renderPatchManager()" class="btn" style="background:#6a1b9a;color:#fff;padding:8px 16px;font-size:12px;font-weight:700;margin-top:10px;margin-left:6px;">🩹 패치 관리</button>
    <div id="healthCheckPanel" style="display:none;margin-top:12px;"></div>
    <div id="changelogPanel" style="display:none;margin-top:12px;"></div>
    <div id="patchManagerPanel" style="display:none;margin-top:12px;"></div>
  </div></div>
  </div>
  <div data-ax-sec="update" style="display:none;">
  <div class="card"><div class="cbd">
    <h3 style="font-size:15px;font-weight:800;color:var(--p);margin-bottom:16px;">🔄 시스템 업데이트 & 마이그레이션</h3>
    <p style="font-size:11px;color:#888;margin-bottom:14px;">DB 스키마 업데이트, API 변경, 데이터 마이그레이션을 관리합니다.</p>
    <div id="updatePanel"><div style="text-align:center;padding:30px;color:#ccc;">🔄 업데이트 탭을 선택하면 로딩됩니다.</div></div>
  </div></div>
  </div>
</div>

<!-- AGENCY: Booking -->
<div class="page" id="p-agb">
  <div class="hero" style="padding:18px 28px;"><h2>🏢 <span id="agNameTitle"></span> — 단체예약 신청</h2></div>
  <div id="agBookingForm"></div>
</div>

<!-- AGENCY: My Bookings -->
<div class="page" id="p-agm">
  <div class="hero" style="padding:18px 28px;"><h2>📋 <span id="agNameTitle2"></span> — 예약 현황</h2></div>
  <div id="agSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:16px;"></div>
  <div id="agBookingList"></div>
</div>

<!-- AGENCY: Settlement -->
<div class="page" id="p-ags">
  <div class="hero" style="padding:18px 28px;"><h2>💰 <span id="agNameTitle3"></span> — 정산</h2></div>

  <div id="agSettleSummary" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:16px;"></div>

  <div class="card"><div class="chd"><h3>🏢 사업자 정보</h3></div><div class="cbd">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
      <div style="padding:12px;background:#f9f9f6;border-radius:10px;border:1px dashed #ccc;">
        <div style="font-size:12px;font-weight:700;margin-bottom:6px;">📄 사업자등록증 사본</div>
        <input type="file" id="ags_bizImg" accept="image/*" onchange="ocrBizImg()" style="font-size:11px;margin-bottom:6px;">
        <div id="ags_bizImgPreview"></div>
        <div id="ags_bizOcrStatus" style="font-size:10px;margin-top:4px;"></div>
      </div>
      <div style="padding:12px;background:#f9f9f6;border-radius:10px;border:1px dashed #ccc;">
        <div style="font-size:12px;font-weight:700;margin-bottom:6px;">🏦 통장사본</div>
        <input type="file" id="ags_bankImg" accept="image/*" onchange="ocrBankImg()" style="font-size:11px;margin-bottom:6px;">
        <div id="ags_bankImgPreview"></div>
        <div id="ags_bankOcrStatus" style="font-size:10px;margin-top:4px;"></div>
      </div>
    </div>
    <div class="fgrid" style="gap:8px;">
      <div class="fg"><label>상호(법인명)</label><input type="text" id="ags_bizName" placeholder="상호명" style="font-size:13px;"></div>
      <div class="fg"><label>사업자등록번호</label><input type="text" id="ags_bizNo" placeholder="000-00-00000" style="font-size:13px;"></div>
      <div class="fg"><label>대표자명</label><input type="text" id="ags_bizCeo" placeholder="대표자" style="font-size:13px;"></div>
      <div class="fg"><label>업태</label><input type="text" id="ags_bizType" placeholder="서비스업" style="font-size:13px;"></div>
      <div class="fg"><label>종목</label><input type="text" id="ags_bizItem" placeholder="여행업" style="font-size:13px;"></div>
      <div class="fg"><label>사업장 주소</label><input type="text" id="ags_bizAddr" placeholder="주소" style="font-size:13px;"></div>
      <div class="fg"><label>담당자 연락처</label><input type="tel" id="ags_bizTel" placeholder="010-0000-0000" style="font-size:13px;"></div>
      <div class="fg"><label>이메일</label><input type="email" id="ags_bizEmail" placeholder="email@example.com" style="font-size:13px;"></div>
    </div>
    <button class="btn bb bs" onclick="saveAgBizInfo()" style="margin-top:8px;">💾 사업자정보 저장</button>
  </div></div>

  <div class="card"><div class="chd"><h3>🏦 입금계좌 정보</h3></div><div class="cbd">
    <div class="fgrid" style="gap:8px;">
      <div class="fg"><label>은행명</label><input type="text" id="ags_bank" placeholder="예: 국민은행" style="font-size:13px;"></div>
      <div class="fg"><label>계좌번호</label><input type="text" id="ags_acct" placeholder="000-0000-0000" style="font-size:13px;"></div>
      <div class="fg"><label>예금주</label><input type="text" id="ags_holder" placeholder="예금주명" style="font-size:13px;"></div>
    </div>
    <button class="btn bb bs" onclick="saveAgBankInfo()" style="margin-top:8px;">💾 계좌정보 저장</button>
  </div></div>

  <div class="card"><div class="chd"><h3>📊 기간별 수수료 현황</h3></div><div class="cbd">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
      <input type="month" id="ags_periodFrom" style="border:2px solid var(--bd);border-radius:8px;padding:6px 10px;font-size:12px;">
      <span style="font-size:12px;">~</span>
      <input type="month" id="ags_periodTo" style="border:2px solid var(--bd);border-radius:8px;padding:6px 10px;font-size:12px;">
      <button class="btn bg bs" onclick="renderAgSettle()">조회</button>
      <button class="btn bo bs" onclick="reqAgExport('정산')" style="margin-left:auto;">📥 정산 엑셀 요청</button>
    </div>
    <div id="agPeriodSummary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px;"></div>
    <div id="agSettleChart" style="margin-bottom:12px;"></div>
    <div id="agSettleTable" style="overflow-x:auto;"></div>
  </div></div>

  <div class="card"><div class="chd"><h3>📈 작년 대비 수수료 비교</h3></div><div class="cbd">
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
      <button class="btn bo bs" onclick="reqAgExport('연간비교')">📥 연간비교 엑셀 요청</button>
    </div>
    <div id="agYoyChart" style="margin-bottom:12px;"></div>
    <div id="agYoyTable" style="overflow-x:auto;"></div>
  </div></div>

  <div class="card"><div class="chd"><h3>🧾 수수료 계산서 / 증빙 첨부</h3></div><div class="cbd">
    <div class="fgrid" style="gap:8px;margin-bottom:10px;">
      <div class="fg"><label>정산 월 선택</label><input type="month" id="ags_month" style="font-size:13px;"></div>
    </div>
    <div class="fg" style="margin-bottom:10px;"><label>계산서 메모</label><textarea id="ags_memo" rows="2" placeholder="수수료 계산서 관련 메모 입력"></textarea></div>
    <div class="fg" style="margin-bottom:10px;">
      <label>증빙 캡쳐 첨부 (이미지)</label>
      <input type="file" id="ags_file" accept="image/*" onchange="previewAgFile()" style="font-size:12px;">
      <div id="ags_preview" style="margin-top:8px;"></div>
    </div>
    <div id="ags_savedDocs" style="margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn bg" onclick="saveAgSettle()">💾 계산서 저장</button>
      <button class="btn bk" onclick="requestAgSettle()">💬 정산요청 카톡</button>
    </div>
  </div></div>

  <div class="card"><div class="chd"><h3>📋 다운로드 요청 이력</h3></div><div class="cbd">
    <div id="agExportLog" style="overflow-x:auto;"></div>
  </div></div>
</div>

<!-- ADMIN: Agency Stats -->
<div class="page" id="p-ag">
  <div class="hero" style="padding:18px 28px;"><h2>🏢 대행사별 통계</h2><p>대행사 예약현황 · 수수료 · 월별 정산</p></div>
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
    <select id="agFilter" onchange="renderAgencyStats()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 12px;font-size:12px;">
      <option value="all">전체 대행사</option>
    </select>
    <input type="month" id="agMonth" onchange="renderAgencyStats()" style="border:2px solid var(--bd);border-radius:8px;padding:8px 12px;font-size:12px;">
    <button class="btn bo" onclick="exportAgencyExcel()">📥 엑셀 다운로드</button>
  </div>
  <div id="agStatsSummary" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:16px;"></div>
  <div class="card"><div class="chd"><h3>📊 대행사별 예약현황</h3></div><div class="cbd"><div id="agStatsChart"></div><div id="agStatsTable" style="overflow-x:auto;margin-top:12px;"></div></div></div>
  <div class="card"><div class="chd"><h3>💰 월별 수수료 정산</h3></div><div class="cbd"><div id="agFeeChart" style="margin-bottom:12px;"></div><div id="agFeeTable" style="overflow-x:auto;"></div></div></div>
  <div class="card"><div class="chd"><h3>🧾 정산요청 현황</h3></div><div class="cbd"><div id="agSettleRequests" style="overflow-x:auto;"></div></div></div>
  <div class="card"><div class="chd"><h3>📥 엑셀 다운로드 요청</h3></div><div class="cbd"><div id="agExportRequests" style="overflow-x:auto;"></div></div></div>
  <div class="card"><div class="chd"><h3>📋 전체 다운로드 로그</h3></div><div class="cbd"><div id="agExportAllLog" style="overflow-x:auto;max-height:300px;overflow-y:auto;"></div></div></div>
</div>

</div><!-- /app -->

<div class="mo" id="mdl"><div class="mdl"><div class="mhd"><h3 id="mtl"></h3><button class="mc" onclick="cMdl()">×</button></div><div class="mbd" id="mdlBd"></div><div class="mft" id="mft"></div></div></div>

<!-- Quote Preview Modal -->
<div class="mo" id="qMdl" style="z-index:10001;">
  <div style="background:#fff;width:98%;max-width:920px;height:95vh;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.4);">
    <div style="background:linear-gradient(135deg,var(--p),var(--p2));padding:10px 20px;color:#fff;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;">
      <h3 id="qMdlTitle" style="font-size:14px;font-weight:700;"></h3>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="btn bg bs" onclick="dlCurQuote()" style="color:#fff;border:1px solid rgba(255,255,255,.3);">📥 다운로드</button>
        <button class="btn bs" style="background:var(--yel);color:#3c1e1e;" onclick="emailCurQuote()">📧 이메일</button>
        <button style="background:none;border:none;color:#fff;font-size:22px;cursor:pointer;padding:0 6px;" onclick="cQMdl()">×</button>
      </div>
    </div>
    <div id="qEditBar" style="display:none;padding:8px 16px;background:#fff3e0;border-bottom:1px solid #ffe0b2;flex-shrink:0;max-height:40vh;overflow-y:auto;">
      <div style="font-size:11px;font-weight:700;color:#e65100;margin-bottom:6px;">✏️ 관리자 수정 모드 — 항목을 추가·수정·삭제할 수 있습니다</div>
      <div id="qEditItems"></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn bg bs" onclick="addQItem()">➕ 항목 추가</button>
        <button class="btn bb bs" onclick="applyQEdit()">✅ 적용 및 미리보기 갱신</button>
      </div>
    </div>
    <div id="qMdlBody" style="flex:1;overflow:hidden;padding:0;"></div>
  </div>
</div>
<div class="tw" id="tw"></div>

<script>
// ===== STORAGE SAFETY WRAPPER =====
(function(){
  var works=false;
  try{
    var t='__st_'+Date.now();
    localStorage.setItem(t,'1');
    localStorage.removeItem(t);
    works=true;
  }catch(e){}
  if(!works){
    var _m={};
    Object.defineProperty(window,'localStorage',{
      value:{
        getItem:function(k){return _m.hasOwnProperty(k)?_m[k]:null;},
        setItem:function(k,v){_m[k]=String(v);},
        removeItem:function(k){delete _m[k];},
        clear:function(){_m={};}
      },
      writable:false,configurable:true
    });
  }
})();
window.onerror=function(msg,url,line){document.title='ERR:'+line+':'+msg;return false;};

// ╔═══════════════════════════════════════════════════════════════╗
// ║  JAMSA SYSTEM — VERSION & MODULE REGISTRY                    ║
// ║  상용 업데이트를 위한 버전 관리 / 모듈 등록 / 마이그레이션    ║
// ╚═══════════════════════════════════════════════════════════════╝

const JAMSA={
  version:'2.10.0',
  build:'20260213',
  schemaVersion:5,
  _modules:{},
  _migrations:[],
  _changelog:[],

  // ── 모듈 등록 ──
  registerModule:function(id,opts){
    if(this._modules[id]){console.warn('[JAMSA] 모듈 중복:',id);return;}
    this._modules[id]={
      id:id,
      name:opts.name||id,
      version:opts.version||'1.0.0',
      schemaVer:opts.schemaVer||1,
      storageKeys:opts.storageKeys||[],
      depends:opts.depends||[],
      description:opts.description||'',
      init:opts.init||null,
      migrate:opts.migrate||null,
      registeredAt:Date.now()
    };
  },

  // ── 모듈 조회 ──
  getModule:function(id){return this._modules[id]||null;},
  getAllModules:function(){return Object.values(this._modules);},

  // ── 마이그레이션 등록 ──
  addMigration:function(opts){
    this._migrations.push({
      module:opts.module,
      fromVer:opts.fromVer,
      toVer:opts.toVer,
      description:opts.description||'',
      run:opts.run
    });
    this._migrations.sort((a,b)=>a.fromVer-b.fromVer);
  },

  // ── 마이그레이션 실행 ──
  runMigrations:function(moduleId,currentVer){
    const pending=this._migrations.filter(m=>m.module===moduleId&&m.fromVer>=currentVer);
    let ver=currentVer;
    pending.forEach(m=>{
      try{
        m.run();ver=m.toVer;
        console.log('[JAMSA] 마이그레이션 완료:',moduleId,m.fromVer,'→',m.toVer);
      }catch(e){
        console.error('[JAMSA] 마이그레이션 실패:',moduleId,m.fromVer,'→',m.toVer,e);
      }
    });
    return ver;
  },

  // ── 변경 이력 ──
  addChangelog:function(ver,date,changes){
    this._changelog.push({version:ver,date:date,changes:changes});
  },

  // ── 시스템 버전 키 (FP 독립) ──
  getSysVer:function(fp){
    try{return JSON.parse(localStorage.getItem(fp+'_sysver')||'{}');}catch(e){return{};}
  },
  setSysVer:function(fp,moduleId,ver){
    const sv=this.getSysVer(fp);
    sv[moduleId]=ver;
    sv._lastUpdate=new Date().toISOString();
    sv._appVer=this.version;
    try{localStorage.setItem(fp+'_sysver',JSON.stringify(sv));}catch(e){}
  },

  // ── 시스템 초기화 (로그인/시설전환 후 호출) ──
  initAll:function(fp){
    const sv=this.getSysVer(fp);
    Object.values(this._modules).forEach(mod=>{
      const curVer=sv[mod.id]||0;
      // 마이그레이션 필요 체크
      if(curVer<mod.schemaVer){
        const newVer=this.runMigrations(mod.id,curVer);
        this.setSysVer(fp,mod.id,newVer||mod.schemaVer);
      }
      // init 콜백
      if(mod.init){
        try{mod.init(fp);}catch(e){
          console.error('[JAMSA] 모듈 init 실패:',mod.id,e);
        }
      }
    });
  },

  // ── 진단 정보 ──
  getDiagnostics:function(fp){
    const sv=this.getSysVer(fp);
    const mods=this.getAllModules().map(m=>({
      id:m.id,name:m.name,version:m.version,
      schemaVer:m.schemaVer,currentVer:sv[m.id]||0,
      needsMigration:(sv[m.id]||0)<m.schemaVer,
      storageKeys:m.storageKeys,
      depends:m.depends
    }));
    let totalKB=0;
    mods.forEach(m=>{
      m.storageKeys.forEach(k=>{
        try{const d=localStorage.getItem(fp+k)||'';totalKB+=d.length*2/1024;}catch(e){}
      });
    });
    return{
      appVersion:this.version,
      build:this.build,
      schemaVersion:this.schemaVersion,
      facilityPrefix:fp,
      modules:mods,
      totalStorageKB:Math.round(totalKB),
      changelog:this._changelog,
      lastUpdate:sv._lastUpdate||'없음'
    };
  },

  // ── 패치 시스템 ──
  _patches:[],
  _patchLog:[], // {id,status,ts,error?}

  registerPatch:function(opts){
    if(this._patches.find(p=>p.id===opts.id)){console.warn('[JAMSA] 패치 중복:',opts.id);return;}
    this._patches.push({
      id:opts.id,                    // 'P2.10.1-001'
      version:opts.version||'',      // 대상 버전
      date:opts.date||new Date().toISOString().slice(0,10),
      module:opts.module||'전체',
      type:opts.type||'fix',         // fix|feature|hotfix|migration
      title:opts.title||'',
      description:opts.description||'',
      apply:opts.apply,              // function(): 실행할 패치 코드
      rollback:opts.rollback||null,  // function(): 되돌리기 (optional)
      breaking:opts.breaking||false  // 데이터 구조 변경 여부
    });
  },

  getPatchHistory:function(fp){
    try{return JSON.parse(localStorage.getItem(fp+'_patches')||'[]');}catch(e){return[];}
  },
  _savePatchHistory:function(fp,history){
    try{localStorage.setItem(fp+'_patches',JSON.stringify(history));}catch(e){}
  },

  applyPatch:function(fp,patchId){
    const patch=this._patches.find(p=>p.id===patchId);
    if(!patch) return{ok:false,error:'패치를 찾을 수 없습니다: '+patchId};
    const history=this.getPatchHistory(fp);
    if(history.find(h=>h.id===patchId&&h.status==='applied'))
      return{ok:false,error:'이미 적용된 패치입니다'};

    // 데이터 백업
    let backup=null;
    if(patch.breaking){
      backup={};
      const mod=this._modules[patch.module];
      if(mod){
        mod.storageKeys.forEach(k=>{
          try{backup[k]=localStorage.getItem(fp+k);}catch(e){}
        });
      }
    }

    try{
      patch.apply(fp);
      history.push({
        id:patchId,status:'applied',
        ts:new Date().toISOString(),
        backup:backup
      });
      this._savePatchHistory(fp,history);
      return{ok:true};
    }catch(e){
      // 자동 롤백
      if(backup){
        Object.entries(backup).forEach(([k,v])=>{
          try{if(v!==null)localStorage.setItem(fp+k,v);else localStorage.removeItem(fp+k);}catch(e2){}
        });
      }
      history.push({
        id:patchId,status:'failed',
        ts:new Date().toISOString(),
        error:String(e)
      });
      this._savePatchHistory(fp,history);
      return{ok:false,error:String(e)};
    }
  },

  rollbackPatch:function(fp,patchId){
    const patch=this._patches.find(p=>p.id===patchId);
    if(!patch) return{ok:false,error:'패치를 찾을 수 없습니다'};
    const history=this.getPatchHistory(fp);
    const record=history.find(h=>h.id===patchId&&h.status==='applied');
    if(!record) return{ok:false,error:'적용된 기록이 없습니다'};

    try{
      // 롤백 함수가 있으면 실행
      if(patch.rollback){
        patch.rollback(fp);
      } else if(record.backup){
        // 백업 데이터 복원
        Object.entries(record.backup).forEach(([k,v])=>{
          try{if(v!==null)localStorage.setItem(fp+k,v);else localStorage.removeItem(fp+k);}catch(e2){}
        });
      } else {
        return{ok:false,error:'롤백 수단이 없습니다'};
      }
      record.status='rolledback';
      record.rollbackTs=new Date().toISOString();
      this._savePatchHistory(fp,history);
      return{ok:true};
    }catch(e){
      return{ok:false,error:String(e)};
    }
  },

  getAvailablePatches:function(fp){
    const history=this.getPatchHistory(fp);
    return this._patches.map(p=>{
      const rec=history.filter(h=>h.id===p.id).pop();
      return{
        ...p,
        applied:rec?.status==='applied',
        failed:rec?.status==='failed',
        rolledback:rec?.status==='rolledback',
        record:rec||null
      };
    });
  }
};

// ── 변경 이력 등록 ──
JAMSA.addChangelog('2.10.0','2026-02-13',[
  'FAQ 미디어 첨부 (사진/영상 다중업로드, 삭제/교체/순서변경)',
  'FAQ 데이터 스키마 v2 (media[], 마이그레이션)',
  'FAQ 검증 시스템 (용량/형식/YouTube URL)',
  'FAQ 안내문구 중앙화 (FAQ_MSG 관리자8+고객5)',
  '고객 FAQ 이미지 갤러리 모달 (키보드/스와이프)',
  '고객 FAQ YouTube 썸네일 카드',
  '실시간 채팅 알림 3종 (푸시/토스트/사운드)',
  '코스/식사/부가 영상·블로그 링크 관리',
  'FAQ 활동로그(addLog) 연동'
]);
JAMSA.addChangelog('2.9.0','2026-02-12',[
  '권한 관리 시스템 (12개 세분화)',
  '계정 복구 (전화번호 인라인 인증)',
  '고객 상세 모달 전체 편집',
  '채팅 헤더 예약 미리보기 툴팁'
]);
JAMSA.addChangelog('2.8.0','2026-02-11',[
  '관리자 채팅 시스템 (카카오톡 스타일)',
  '고객 채팅 메뉴',
  '관리자 프로필 관리',
  '고객 FAQ 퀵메뉴'
]);

// ── 모듈 등록: 모든 시스템 모듈 ──
JAMSA.registerModule('core',{
  name:'코어 시스템',version:'2.10.0',schemaVer:1,
  storageKeys:['bk','formcfg','daylimits'],
  description:'예약/설정/일일제한 등 기본 데이터'
});
JAMSA.registerModule('admin',{
  name:'관리자 시스템',version:'2.5.0',schemaVer:2,
  storageKeys:['admins','actlog','autosend'],
  depends:['core'],
  description:'멀티관리자, 활동로그, 권한'
});
JAMSA.registerModule('agency',{
  name:'대행사 시스템',version:'1.3.0',schemaVer:1,
  storageKeys:['agencies','agexlogs'],
  depends:['core'],
  description:'대행사 등록/관리/정산'
});
JAMSA.registerModule('chat',{
  name:'채팅 시스템',version:'2.2.0',schemaVer:1,
  storageKeys:['chats'],
  depends:['core','admin'],
  description:'관리자-고객 채팅, 알림'
});
JAMSA.registerModule('faq',{
  name:'FAQ 시스템',version:'2.0.0',schemaVer:2,
  storageKeys:['chatfaq'],
  depends:['chat'],
  description:'자주묻는질문 + 미디어 첨부'
});
JAMSA.registerModule('schedule',{
  name:'일정 시스템',version:'1.5.0',schemaVer:1,
  storageKeys:['sch','schrules'],
  depends:['core'],
  description:'일정표, 자동배정, 저장'
});
JAMSA.registerModule('courseInfo',{
  name:'코스 미디어',version:'1.0.0',schemaVer:1,
  storageKeys:['courseInfo'],
  depends:['core'],
  description:'코스/식사/부가 영상·블로그 링크'
});

// ── 패치 등록 (예시) ──
JAMSA.registerPatch({
  id:'P2.10.1-001',version:'2.10.1',date:'2026-02-13',
  module:'faq',type:'fix',
  title:'FAQ media 빈 배열 정리',
  description:'media 안에 null/undefined 항목이 있는 경우 자동 제거',
  apply:function(fp){
    const raw=localStorage.getItem(fp+'chatfaq');
    if(!raw)return;
    const faq=JSON.parse(raw);
    let fixed=0;
    faq.forEach(f=>{
      if(!f.media)f.media=[];
      const before=f.media.length;
      f.media=f.media.filter(m=>m&&m.type);
      fixed+=(before-f.media.length);
    });
    localStorage.setItem(fp+'chatfaq',JSON.stringify(faq));
    if(fixed)console.log('[PATCH] '+fixed+'개 빈 미디어 항목 제거');
  },
  rollback:null,breaking:false
});

JAMSA.registerPatch({
  id:'P2.10.1-002',version:'2.10.1',date:'2026-02-13',
  module:'core',type:'fix',
  title:'예약 courseType 기본값 보정',
  description:'courseType이 비어있는 예약에 "기본코스" 할당',
  apply:function(fp){
    const raw=localStorage.getItem(fp+'bk');
    if(!raw)return;
    const bks=JSON.parse(raw);
    let fixed=0;
    bks.forEach(b=>{if(!b.courseType){b.courseType='기본코스';fixed++;}});
    if(fixed){localStorage.setItem(fp+'bk',JSON.stringify(bks));console.log('[PATCH] '+fixed+'건 courseType 보정');}
  },
  rollback:null,breaking:false
});

JAMSA.registerPatch({
  id:'P2.10.1-003',version:'2.10.1',date:'2026-02-13',
  module:'admin',type:'fix',
  title:'활동로그 1000건 초과 정리',
  description:'활동로그가 1000건 초과 시 오래된 항목 자동 삭제',
  apply:function(fp){
    const raw=localStorage.getItem(fp+'actlog');
    if(!raw)return;
    const log=JSON.parse(raw);
    if(log.length>1000){
      const trimmed=log.slice(-1000);
      localStorage.setItem(fp+'actlog',JSON.stringify(trimmed));
      console.log('[PATCH] 활동로그 '+(log.length-1000)+'건 정리');
    }
  },
  rollback:null,breaking:false
});

var FLIST_K='__fac_list';
var curFac=null; // {code:'xxx', name:'잠사박물관'}
var FP='jp_'; // facility prefix for localStorage keys
// 초기 시설의 모듈 버전 기록
JAMSA.initAll(FP);

function getFacilities(){
  try{return JSON.parse(localStorage.getItem(FLIST_K)||'null')||[];}catch(e){return [];}
}
function saveFacilities(list){
  try{localStorage.setItem(FLIST_K,JSON.stringify(list));}catch(e){}
}
function renderFacilities(){
  var list=getFacilities();
  var el=document.getElementById('facilityList');
  if(!el)return;
  if(!list.length){
    el.innerHTML='<div style="text-align:center;padding:20px;color:#aaa;font-size:12px;">등록된 시설이 없습니다.<br>아래에서 시설을 추가하세요.</div>';
    return;
  }
  el.innerHTML=list.map(function(f,i){
    return '<div style="background:#f9fafb;border:2px solid #e0e0e0;border-radius:14px;padding:14px;margin-bottom:2px;">'
      +'<div style="font-size:15px;font-weight:800;color:#1a472a;margin-bottom:10px;">🏕️ '+f.name+'</div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;">'
      +'<button onclick="selectFacilityBook('+i+')" style="flex:1;padding:10px 8px;background:linear-gradient(135deg,#1a472a,#2d6a4f);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;">📝 예약신청</button>'
      +'<button onclick="selectFacilityCheck('+i+')" style="flex:1;padding:10px 8px;background:linear-gradient(135deg,#1565c0,#1e88e5);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;">🔍 예약조회</button>'
      +'<button onclick="selectFacilityAgency('+i+')" style="flex:1;padding:10px 8px;background:linear-gradient(135deg,#6a1b9a,#8e24aa);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;">🏢 대행사</button>'
      +'<button onclick="selectFacilityAdmin('+i+')" style="flex:1;padding:10px 8px;background:linear-gradient(135deg,#e65100,#f57c00);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;">🔐 관리자</button>'
      +'</div>'
      +'</div>';
  }).join('');
}
function addFacility(){
  var inp=document.getElementById('newFacName');
  var name=(inp?inp.value:'').trim();
  if(!name){alert('시설명을 입력하세요.');return;}
  var list=getFacilities();
  var code='f'+Date.now();
  list.push({code:code,name:name});
  saveFacilities(list);
  if(inp)inp.value='';
  renderFacilities();
}
function removeFacility(idx){
  var list=getFacilities();
  if(!confirm(list[idx].name+' 시설을 삭제하시겠습니까?\n(예약 데이터는 유지됩니다)')){return;}
  list.splice(idx,1);
  saveFacilities(list);
  renderFacilities();
}

// Admin facility management
function renderAdminFacList(){
  var el=document.getElementById('adminFacList');
  if(!el)return;
  var list=getFacilities();
  if(!list.length){el.innerHTML='<div style="color:#aaa;font-size:12px;padding:8px;">등록된 시설이 없습니다.</div>';return;}
  el.innerHTML=list.map(function(f,i){
    var isCurrent=curFac&&curFac.code===f.code;
    return '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:'+(isCurrent?'#e8f5e9':'#f9f9f9')+';border-radius:8px;margin-bottom:4px;">'
      +'<span style="flex:1;font-size:13px;font-weight:'+(isCurrent?'800':'600')+';color:#1a472a;">🏕️ '+f.name+(isCurrent?' (현재)':'')+'</span>'
      +'<button onclick="adminRenameFac('+i+')" style="padding:4px 8px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:11px;">✏️ 이름변경</button>'
      +(isCurrent?'':'<button onclick="adminRemoveFac('+i+')" style="padding:4px 8px;background:#fff;border:1px solid #ecc;border-radius:6px;cursor:pointer;font-size:11px;color:#c62828;">🗑️ 삭제</button>')
      +'</div>';
  }).join('');
}
function adminAddFacility(){
  var inp=document.getElementById('adminNewFac');
  var name=(inp?inp.value:'').trim();
  if(!name){toast('시설명을 입력하세요','e');return;}
  var list=getFacilities();
  list.push({code:'f'+Date.now(),name:name});
  saveFacilities(list);
  if(inp)inp.value='';
  renderAdminFacList();
  renderFacilities();
  toast('✅ '+name+' 시설이 추가되었습니다','s');
}
function adminRemoveFac(idx){
  var list=getFacilities();
  var name=list[idx].name;
  if(!confirm(name+' 시설을 삭제하시겠습니까?\n(해당 시설의 예약 데이터는 유지됩니다)')){return;}
  list.splice(idx,1);
  saveFacilities(list);
  renderAdminFacList();
  renderFacilities();
  toast('🗑️ '+name+' 시설이 삭제되었습니다','s');
}
function adminRenameFac(idx){
  var list=getFacilities();
  var newName=prompt('새 시설명을 입력하세요:',list[idx].name);
  if(!newName||!newName.trim())return;
  list[idx].name=newName.trim();
  saveFacilities(list);
  // Update current display if renaming current facility
  if(curFac&&curFac.code===list[idx].code){
    curFac.name=newName.trim();
    var nameEl=document.getElementById('loginFacName');
    if(nameEl)nameEl.innerHTML='🏕️ '+curFac.name+' <span style="font-size:12px;color:#999;">▼</span>';
    var logoEls=document.querySelectorAll('.logo');
    logoEls.forEach(function(el){el.childNodes[0].textContent='🏕️ '+curFac.name+' ';});
    document.title=curFac.name+' - 단체예약 시스템';
  }
  renderAdminFacList();
  renderFacilities();
  toast('✅ 시설명이 변경되었습니다','s');
}

// ===== EXCEL BULK UPLOAD =====
function downloadBulkTemplate(){
  var xml='<?xml version="1.0" encoding="UTF-8"?><?mso-application progid="Excel.Sheet"?>';
  xml+='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
  xml+='<Styles><Style ss:ID="hd"><Font ss:Bold="1" ss:Size="11" ss:Color="#FFFFFF"/><Interior ss:Color="#1A472A" ss:Pattern="Solid"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="td"><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="ex"><Font ss:Color="#999999" ss:Italic="1"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='</Styles><Worksheet ss:Name="예약업로드양식"><Table>';
  xml+='<Column ss:Width="100"/><Column ss:Width="130"/><Column ss:Width="80"/><Column ss:Width="60"/><Column ss:Width="60"/><Column ss:Width="60"/><Column ss:Width="60"/><Column ss:Width="130"/><Column ss:Width="60"/><Column ss:Width="80"/><Column ss:Width="100"/><Column ss:Width="100"/><Column ss:Width="180"/>';
  xml+='<Row>';
  ['방문일(필수)','단체명(필수)','구분','도착시간','출발시간','아동수(필수)','인솔수','연락처','상태','채널','예약일(신청일)','체험/코스','추가요청사항'].forEach(function(c){
    xml+='<Cell ss:StyleID="hd"><Data ss:Type="String">'+c+'</Data></Cell>';
  });
  xml+='</Row>';
  xml+='<Row>';
  ['2026-02-20','해피유치원','유치원','09:30','11:00','25','3','010-1234-5678','대기','전화','2026-02-10','오디돈가스체험','알레르기 아동 2명 있음'].forEach(function(c){
    xml+='<Cell ss:StyleID="ex"><Data ss:Type="String">'+c+'</Data></Cell>';
  });
  xml+='</Row>';
  xml+='<Row>';
  ['2026-02-21','꿈나무어린이집','어린이집','10:00','14:00','30','5','010-9876-5432','확정','네이버','2026-02-05','기본체험','대형버스 주차 필요'].forEach(function(c){
    xml+='<Cell ss:StyleID="ex"><Data ss:Type="String">'+c+'</Data></Cell>';
  });
  xml+='</Row>';
  xml+='</Table></Worksheet></Workbook>';
  try{
    var blob=new Blob([xml],{type:'application/vnd.ms-excel;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');a.href=url;a.download='예약_일괄업로드_양식.xls';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},1000);
    toast('📋 양식 다운로드 완료','s');
  }catch(e){toast('다운로드 오류','e');}
}

function handleBulkUpload(input){
  var file=input.files[0];
  if(!file){return;}
  var ext=file.name.split('.').pop().toLowerCase();
  var reader=new FileReader();
  if(ext==='csv'){
    reader.onload=function(e){parseBulkCSV(e.target.result);};
    reader.readAsText(file,'UTF-8');
  }else{
    reader.onload=function(e){parseBulkXLS(e.target.result);};
    reader.readAsText(file,'UTF-8');
  }
  input.value='';
}

function parseBulkCSV(text){
  var lines=text.split(/\r?\n/).filter(function(l){return l.trim();});
  if(lines.length<2){toast('데이터가 없습니다','e');return;}
  var rows=[];
  for(var i=1;i<lines.length;i++){
    var cols=lines[i].split(',').map(function(c){return c.trim().replace(/^["']|["']$/g,'');});
    if(cols.length<2||!cols[0]||!cols[1])continue;
    rows.push(parseBulkRow(cols));
  }
  showBulkPreview(rows);
}

function parseBulkXLS(text){
  var rows=[];
  var rowMatches=text.match(/<Row[^>]*>[\s\S]*?<\/Row>/gi);
  if(!rowMatches||rowMatches.length<2){toast('데이터를 읽을 수 없습니다. CSV로 저장 후 시도해주세요.','e');return;}
  for(var i=1;i<rowMatches.length;i++){
    var cellMatches=rowMatches[i].match(/<Cell[^>]*>[\s\S]*?<\/Cell>/gi);
    if(!cellMatches)continue;
    var cols=[];
    cellMatches.forEach(function(cell){
      var idxMatch=cell.match(/ss:Index="(\d+)"/i);
      if(idxMatch){
        var idx=parseInt(idxMatch[1])-1;
        while(cols.length<idx)cols.push('');
      }
      var dataMatch=cell.match(/<Data[^>]*>([\s\S]*?)<\/Data>/i);
      cols.push(dataMatch?dataMatch[1].replace(/<[^>]+>/g,'').trim():'');
    });
    if(!cols[0]||!cols[1])continue;
    rows.push(parseBulkRow(cols));
  }
  showBulkPreview(rows);
}

function parseBulkRow(cols){
  var date=cols[0]||'';
  if(date.includes('/'))date=date.replace(/(\d+)\/(\d+)\/(\d+)/,function(m,a,b,c){return (a.length===4?a:'20'+a)+'-'+(b.length<2?'0'+b:b)+'-'+(c.length<2?'0'+c:c);});
  var created=cols[10]||'';
  if(created.includes('/'))created=created.replace(/(\d+)\/(\d+)\/(\d+)/,function(m,a,b,c){return (a.length===4?a:'20'+a)+'-'+(b.length<2?'0'+b:b)+'-'+(c.length<2?'0'+c:c);});
  return {
    date:date,
    name:cols[1]||'',
    category:cols[2]||'미분류',
    arrival:cols[3]||'10:00',
    departure:cols[4]||'14:00',
    students:parseInt(cols[5])||0,
    teachers:parseInt(cols[6])||0,
    phone:cols[7]||'',
    status:cols[8]||'대기',
    channel:cols[9]||'',
    created:created,
    course:cols[11]||'',
    memo:cols[12]||''
  };
}

function showBulkPreview(rows){
  var el=document.getElementById('bulkPreview');
  if(!el||!rows.length){toast('유효한 데이터가 없습니다','e');return;}
  window._bulkRows=rows;
  renderBulkTable();
}

function renderBulkTable(){
  var el=document.getElementById('bulkPreview');
  if(!el||!window._bulkRows)return;
  var rows=window._bulkRows;
  var validCount=rows.filter(function(r){return r.date&&r.name&&r.students>0;}).length;
  var invalidCount=rows.length-validCount;

  var S='padding:3px 5px;border:1px solid #ccc;border-radius:4px;font-size:11px;width:100%;box-sizing:border-box;';
  var Se=S+'border-color:#e65100;background:#fff3e0;';

  var h='<div style="border:2px solid var(--p);border-radius:10px;overflow:hidden;">';
  h+='<div id="bulkHeader" style="background:var(--p);color:#fff;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;">';
  h+='<span style="font-weight:800;">📋 업로드 미리보기 — <span id="bulkValidCnt">'+validCount+'</span>건 유효'+(invalidCount?' / <span style="color:#ffcdd2;" id="bulkInvalidCnt">'+invalidCount+'건 오류</span>':'')+'</span>';
  h+='<div style="display:flex;gap:6px;"><button onclick="executeBulkUpload()" id="bulkExecBtn" style="padding:6px 16px;background:#FEE500;color:#333;border:none;border-radius:6px;font-size:12px;font-weight:800;cursor:pointer;">✅ '+validCount+'건 등록하기</button>';
  h+='<button onclick="document.getElementById(\'bulkPreview\').style.display=\'none\'" style="background:none;border:none;cursor:pointer;color:#fff;font-size:16px;">✕</button></div></div>';

  h+='<div style="overflow-x:auto;max-height:450px;overflow-y:auto;"><table style="width:100%;border-collapse:collapse;font-size:11px;">';
  h+='<thead style="position:sticky;top:0;z-index:1;"><tr style="background:#f0f7f0;">';
  ['','날짜','단체명','구분','도착','출발','아동','인솔','연락처','상태','채널','예약일','체험','요청사항',''].forEach(function(c){h+='<th style="padding:5px 6px;border:1px solid #e0e0e0;font-weight:700;white-space:nowrap;font-size:10px;">'+c+'</th>';});
  h+='</tr></thead><tbody>';

  rows.forEach(function(r,i){
    var valid=r.date&&r.name&&r.students>0;
    var bg=valid?'':'background:#fff3e0;';
    var eS=valid?S:Se;
    h+='<tr id="bkr_'+i+'" style="'+bg+'">';
    h+='<td style="padding:3px;border:1px solid #eee;text-align:center;font-size:13px;" id="bkv_'+i+'">'+(valid?'✅':'❌')+'</td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input type="date" value="'+r.date+'" onchange="updBulk('+i+',\'date\',this.value)" style="'+(!r.date?Se:S)+'"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input value="'+r.name+'" onchange="updBulk('+i+',\'name\',this.value)" style="'+(!r.name?Se:S)+'width:90px;font-weight:700;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><select onchange="updBulk('+i+',\'category\',this.value)" style="'+S+'width:70px;">';
    ['미분류','어린이집','유치원','초등학교','중학교','고등학교','성인','기타'].forEach(function(c){h+='<option'+(r.category===c?' selected':'')+'>'+c+'</option>';});
    h+='</select></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input type="time" value="'+r.arrival+'" onchange="updBulk('+i+',\'arrival\',this.value)" style="'+S+'width:70px;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input type="time" value="'+r.departure+'" onchange="updBulk('+i+',\'departure\',this.value)" style="'+S+'width:70px;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input type="number" value="'+r.students+'" min="0" onchange="updBulk('+i+',\'students\',parseInt(this.value)||0)" style="'+(r.students<=0?Se:S)+'width:45px;text-align:center;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input type="number" value="'+r.teachers+'" min="0" onchange="updBulk('+i+',\'teachers\',parseInt(this.value)||0)" style="'+S+'width:45px;text-align:center;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input value="'+r.phone+'" onchange="updBulk('+i+',\'phone\',this.value)" style="'+S+'width:100px;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><select onchange="updBulk('+i+',\'status\',this.value)" style="'+S+'width:55px;">';
    ['대기','확정','취소'].forEach(function(c){h+='<option'+(r.status===c?' selected':'')+'>'+c+'</option>';});
    h+='</select></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input value="'+r.channel+'" onchange="updBulk('+i+',\'channel\',this.value)" style="'+S+'width:60px;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input type="date" value="'+r.created+'" onchange="updBulk('+i+',\'created\',this.value)" style="'+S+'"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input value="'+r.course+'" onchange="updBulk('+i+',\'course\',this.value)" style="'+S+'width:80px;"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;"><input value="'+(r.memo||'').replace(/"/g,'&quot;')+'" onchange="updBulk('+i+',\'memo\',this.value)" style="'+S+'width:120px;" title="'+(r.memo||'')+'"></td>';
    h+='<td style="padding:3px;border:1px solid #eee;text-align:center;"><button onclick="delBulk('+i+')" style="background:none;border:none;cursor:pointer;font-size:14px;color:#c62828;" title="삭제">🗑</button></td>';
    h+='</tr>';
  });
  h+='</tbody></table></div>';

  if(invalidCount>0){
    h+='<div style="padding:8px 16px;background:#fff3e0;font-size:11px;color:#e65100;">⚠️ 오류 건의 빨간 테두리 필드를 직접 수정하면 자동 반영됩니다.</div>';
  }
  h+='</div>';

  el.innerHTML=h;
  el.style.display='block';
}

function updBulk(i,field,val){
  if(!window._bulkRows||!window._bulkRows[i])return;
  window._bulkRows[i][field]=val;
  var r=window._bulkRows[i];
  var valid=r.date&&r.name&&r.students>0;
  // Update row indicator
  var vEl=document.getElementById('bkv_'+i);
  if(vEl)vEl.textContent=valid?'✅':'❌';
  var trEl=document.getElementById('bkr_'+i);
  if(trEl)trEl.style.background=valid?'':'#fff3e0';
  // Update header counts
  var vc=window._bulkRows.filter(function(r){return r.date&&r.name&&r.students>0;}).length;
  var ic=window._bulkRows.length-vc;
  var btn=document.getElementById('bulkExecBtn');
  if(btn)btn.textContent='✅ '+vc+'건 등록하기';
  var vcEl=document.getElementById('bulkValidCnt');
  if(vcEl)vcEl.textContent=vc;
  var icEl=document.getElementById('bulkInvalidCnt');
  if(icEl)icEl.textContent=ic+'건 오류';
}

function delBulk(i){
  if(!window._bulkRows)return;
  window._bulkRows.splice(i,1);
  if(!window._bulkRows.length){
    document.getElementById('bulkPreview').style.display='none';
    toast('모든 행이 삭제되었습니다','s');
    return;
  }
  renderBulkTable();
}

function executeBulkUpload(){
  if(!window._bulkRows||!window._bulkRows.length){toast('데이터가 없습니다','e');return;}
  var validRows=window._bulkRows.filter(function(r){return r.date&&r.name&&r.students>0;});
  if(!validRows.length){toast('유효한 데이터가 없습니다','e');return;}
  var count=0;
  try{
    pushUndo('엑셀업로드',`${validRows.length}건 엑셀 일괄등록`,JSON.stringify(bks));
    validRows.forEach(function(r){
      var id=Date.now()+Math.floor(Math.random()*10000)+count;
      var bk={
        id:id,
        date:r.date,
        name:r.name,
        category:r.category||'미분류',
        arrival:r.arrival||'10:00',
        departure:r.departure||'14:00',
        students:typeof r.students==='string'?parseInt(r.students)||0:r.students,
        studentsChild:0,
        studentsElem:0,
        ageGroup:'유아',
        teachers:typeof r.teachers==='string'?parseInt(r.teachers)||0:r.teachers,
        courseType:'기본코스',
        phone:r.phone||'',
        status:r.status||'대기',
        channel:r.channel||'',
        created:r.created||r.date||td(),
        course:r.course||'기본',
        memo:r.memo||'',
        contact:'',
        email:'',
        meal:'이용안함',
        addons:[],
        paidAmount:null,
        actualStudents:null,
        actualTeachers:null
      };
      bks.push(bk);
      count++;
    });
    sv();
    document.getElementById('bulkPreview').style.display='none';
    window._bulkRows=null;
    toast('✅ '+count+'건 예약이 등록되었습니다!','s');
    rfr();
  }catch(e){
    toast('등록 오류: '+e.message,'e');
  }
}
function initFacility(idx){
  var list=getFacilities();
  curFac=list[idx];
  FP=curFac.code+'_';
  document.getElementById('facilityScreen').style.display='none';
  document.title=curFac.name+' - 단체예약 시스템';
  // Update login screen name
  var nameEl=document.getElementById('loginFacName');
  if(nameEl)nameEl.innerHTML='🏕️ '+curFac.name+' <span style="font-size:12px;color:#999;">▼</span>';
  // Update nav logo
  var logoEls=document.querySelectorAll('.logo');
  logoEls.forEach(function(el){el.childNodes[0].textContent='🏕️ '+curFac.name+' ';});
  loadFacilityData();
  JAMSA.initAll(FP);
}

function toggleFacDropdown(){
  var dd=document.getElementById('facDropdown');
  if(!dd)return;
  if(dd.style.display==='none'){
    var list=getFacilities();
    dd.innerHTML=list.map(function(f,i){
      var isCurrent=curFac&&curFac.code===f.code;
      return '<button onclick="switchFacility('+i+');event.stopPropagation();" style="display:block;width:100%;padding:10px 14px;border:none;background:'+(isCurrent?'#e8f5e9':'#fff')+';border-radius:8px;cursor:pointer;text-align:left;font-size:13px;font-weight:'+(isCurrent?'800':'600')+';color:#1a472a;margin-bottom:2px;" onmouseover="this.style.background=\'#f0f7f0\'" onmouseout="this.style.background=\''+(isCurrent?'#e8f5e9':'#fff')+'\'">🏕️ '+f.name+(isCurrent?' ✓':'')+'</button>';
    }).join('');
    dd.style.display='block';
    // Close on outside click
    setTimeout(function(){document.addEventListener('click',closeFacDropdown,{once:true});},10);
  }else{
    dd.style.display='none';
  }
}
function closeFacDropdown(){
  var dd=document.getElementById('facDropdown');
  if(dd)dd.style.display='none';
}
function switchFacility(idx){
  closeFacDropdown();
  initFacility(idx);
  // Stay on login screen, reset to main entry
  document.getElementById('loginScreen').style.display='';
  hideAllEntries();
  document.getElementById('mainEntry').style.display='block';
}
function addFacFromDropdown(){
  var inp=document.getElementById('ddNewFac');
  var name=(inp?inp.value:'').trim();
  if(!name){return;}
  var list=getFacilities();
  list.push({code:'f'+Date.now(),name:name});
  saveFacilities(list);
  // Switch to new facility
  switchFacility(list.length-1);
}
function selectFacility(idx){
  initFacility(idx);
  document.getElementById('loginScreen').style.display='';
}
function selectFacilityBook(idx){
  initFacility(idx);
  document.getElementById('loginScreen').style.display='';
  hideAllEntries();
  document.getElementById('bookEntry').style.display='block';
}
function selectFacilityCheck(idx){
  initFacility(idx);
  document.getElementById('loginScreen').style.display='';
  hideAllEntries();
  document.getElementById('checkEntry').style.display='block';
}
function selectFacilityAdmin(idx){
  initFacility(idx);
  document.getElementById('loginScreen').style.display='';
  hideAllEntries();
  document.getElementById('af').style.display='block';
}
function selectFacilityAgency(idx){
  initFacility(idx);
  document.getElementById('loginScreen').style.display='';
  hideAllEntries();
  document.getElementById('agencyEntry').style.display='block';
}

function backToFacility(){
  document.getElementById('app').style.display='none';
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('facilityScreen').style.display='flex';
  renderFacilities();
}

// Initialize facility screen
renderFacilities();
// Auto-select if only one facility
(function(){
  var list=getFacilities();
  if(list.length===0){
    // Auto-create default facility for first use
    list.push({code:'jp',name:'잠사박물관 플레이팜'});
    saveFacilities(list);
    renderFacilities();
  }
})();

// ===== DATA =====
var PW_K,BK_K,CS_K;
function loadFacilityData(){
  PW_K=FP+'pw';BK_K=FP+'bk';CS_K=FP+'cs';
  pw=localStorage.getItem(PW_K)||'1234';
  bks=JSON.parse(localStorage.getItem(BK_K)||'[]');
  // Auto-fix: 열 밀림/잘못된 데이터 교정
  var datePattern=/^\d{4}-\d{2}-\d{2}$/;
  var timePattern=/^\d{1,2}:\d{2}$/;
  var dataFixed=false;
  bks.forEach(function(b){
    // category에 시간값이 들어간 경우
    if(b.category&&timePattern.test(b.category)){b.category='미분류';dataFixed=true;}
    // date가 유효한 날짜가 아닌 경우 (열 밀림으로 단체명 등이 들어감)
    if(b.date&&!datePattern.test(b.date)){
      // date에 숫자가 포함된 경우 날짜 추출 시도
      var dm=b.date.match(/(\d{4})[-.\/](\d{1,2})[-.\/](\d{1,2})/);
      if(dm){b.date=dm[1]+'-'+(dm[2].length<2?'0'+dm[2]:dm[2])+'-'+(dm[3].length<2?'0'+dm[3]:dm[3]);dataFixed=true;}
    }
    if(!b.courseType)b.courseType='기본코스';
    if(!b.meal)b.meal='이용안함';
    if(!b.addons)b.addons=[];
    // created가 없거나 방문일보다 미래면 방문일로 교정
    if(!b.created||!datePattern.test(b.created)){b.created=b.date;dataFixed=true;}
    else if(b.created>b.date){b.created=b.date;dataFixed=true;}
  });
  // 유효하지 않은 날짜의 예약 제거
  var beforeLen=bks.length;
  bks=bks.filter(function(b){return b.date&&datePattern.test(b.date);});
  if(bks.length<beforeLen)dataFixed=true;
  if(dataFixed)try{localStorage.setItem(BK_K,JSON.stringify(bks));}catch(e){}
  cs=JSON.parse(localStorage.getItem(CS_K)||'null')||["박물관 관람","양떼정원","눈썰매장","키즈카페","누에쉼터","사계절 썰매","자유관람"];
  nid=Math.max(0.1,...bks.map(function(b){return b.id;}))+1;
  // Load agencies
  agencies=JSON.parse(localStorage.getItem(FP+'agencies')||'[]');
  agExportLogs=JSON.parse(localStorage.getItem(FP+'agexlogs')||'[]');
  // Load form config
  formCfg=JSON.parse(localStorage.getItem(FP+'formcfg')||'null')||JSON.parse(JSON.stringify(defaultFormCfg));
  // Load day limits
  dayLimits=JSON.parse(localStorage.getItem(FP+'daylimits')||'{}');
}
let pw='1234';
// ===== MULTI-ADMIN SYSTEM =====
let adminAccounts=JSON.parse(localStorage.getItem(FP+'admins')||'null');
if(!adminAccounts){
  adminAccounts=[{id:'master',name:'마스터',pw:'1234',role:'master',created:td()}];
  localStorage.setItem(FP+'admins',JSON.stringify(adminAccounts));
}
function svAdmins(){localStorage.setItem(FP+'admins',JSON.stringify(adminAccounts));}
let curAdmin=null; // currently logged-in admin {id,name,role}
let bks=[];
let cs=["박물관 관람","양떼정원","눈썰매장","키즈카페","누에쉼터","사계절 썰매","자유관람"];
let nid=1;
let dayLimits={};
function saveDayLimits(){try{localStorage.setItem(FP+'daylimits',JSON.stringify(dayLimits));}catch(e){}}
let mode=null,uph='';
let cY,cMo,sD=null,cSch=null,sEd=null;
const CL=[{b:"#E8F5E9",r:"#4CAF50",t:"#1B5E20"},{b:"#FFF3E0",r:"#FF9800",t:"#BF360C"},{b:"#E3F2FD",r:"#2196F3",t:"#0D47A1"},{b:"#F3E5F5",r:"#9C27B0",t:"#4A148C"},{b:"#FFF9C4",r:"#FBC02D",t:"#E65100"},{b:"#FFEBEE",r:"#F44336",t:"#B71C1C"},{b:"#E0F7FA",r:"#00BCD4",t:"#006064"},{b:"#F1F8E9",r:"#8BC34A",t:"#33691E"}];
const TS=[];for(let h=10;h<17;h++)for(let m=0;m<60;m+=30){const s=`${h}:${String(m).padStart(2,'0')}`;const eh=m===30?h+1:h,em=m===30?0:30;TS.push({s,e:`${eh}:${String(em).padStart(2,'0')}`,l:`${s}~${eh}:${String(em).padStart(2,'0')}`});}
function ti(t){const[h,m]=t.split(':').map(Number);return(h-10)*2+(m>=30?1:0);}
const allA=()=>[...cs,"점심식사","점심식사(단체식)","-","✏️ 직접입력"];
function td(){return new Date().toISOString().split('T')[0];}

// ===== UNDO/REDO SYSTEM =====
let undoStack=[];
let redoStack=[];
const MAX_UNDO=50;

function pushUndo(action,desc,oldData,reason){
  undoStack.push({action,desc,oldData,time:new Date().toLocaleString('ko-KR')});
  if(undoStack.length>MAX_UNDO)undoStack.shift();
  redoStack=[];
  addLog(action,desc,oldData,reason);
  renderUndoBtn();
}

function undo(){
  if(!undoStack.length){toast('되돌릴 항목이 없습니다','e');return;}
  const item=undoStack.pop();
  const curData=JSON.stringify(bks);
  redoStack.push({action:item.action,desc:item.desc,oldData:curData,time:new Date().toLocaleString('ko-KR')});
  bks=JSON.parse(item.oldData);
  sv();rfr();
  addLog('↩ 되돌리기',item.desc,curData);
  toast(`↩ 되돌림: ${item.desc}`,'i');
  renderUndoBtn();
}

function redo(){
  if(!redoStack.length){toast('다시 실행할 항목이 없습니다','e');return;}
  const item=redoStack.pop();
  const curData=JSON.stringify(bks);
  undoStack.push({action:item.action,desc:item.desc,oldData:curData,time:new Date().toLocaleString('ko-KR')});
  bks=JSON.parse(item.oldData);
  sv();rfr();
  addLog('↪ 다시실행',item.desc,curData);
  toast(`↪ 다시실행: ${item.desc}`,'i');
  renderUndoBtn();
}

function renderUndoBtn(){
  const el=document.getElementById('undoRedoBar');
  if(!el)return;
  el.innerHTML=`<button onclick="undo()" style="padding:5px 12px;border:1px solid ${undoStack.length?'#1976d2':'#ccc'};background:${undoStack.length?'#e3f2fd':'#f5f5f5'};color:${undoStack.length?'#1976d2':'#bbb'};border-radius:6px;font-size:11px;cursor:${undoStack.length?'pointer':'default'};font-weight:700;" ${undoStack.length?'':'disabled'}>↩ 되돌리기${undoStack.length?' ('+undoStack.length+')':''}</button>
  <button onclick="redo()" style="padding:5px 12px;border:1px solid ${redoStack.length?'#7b1fa2':'#ccc'};background:${redoStack.length?'#f3e5f5':'#f5f5f5'};color:${redoStack.length?'#7b1fa2':'#bbb'};border-radius:6px;font-size:11px;cursor:${redoStack.length?'pointer':'default'};font-weight:700;" ${redoStack.length?'':'disabled'}>↪ 다시실행${redoStack.length?' ('+redoStack.length+')':''}</button>
  <button onclick="showLogPanel()" style="padding:5px 12px;border:1px solid #e65100;background:#fff3e0;color:#e65100;border-radius:6px;font-size:11px;cursor:pointer;font-weight:700;">📜 로그</button>`;
}

// ===== ACTIVITY LOG =====
let actLog=JSON.parse(localStorage.getItem(FP+'actlog')||'[]');
function saveLog(){
  if(actLog.length>200)actLog=actLog.slice(-200);
  localStorage.setItem(FP+'actlog',JSON.stringify(actLog));
}
function addLog(action,desc,snapshot,reason){
  const who=mode==='admin'&&curAdmin?curAdmin.name:(mode==='agency'&&typeof curAgency!=='undefined'?curAgency.name:'고객');
  actLog.push({action,desc,time:new Date().toLocaleString('ko-KR'),user:who,snap:snapshot||null,reason:reason||null});
  saveLog();
}
function clearLog(){
  actLog=[];saveLog();
  toast('📜 로그가 삭제되었습니다','i');
  showLogPanel();
}

function promptReason(title,callback){
  let mdl=document.getElementById('reasonModal');
  if(!mdl){mdl=document.createElement('div');mdl.id='reasonModal';mdl.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:10001;display:flex;align-items:center;justify-content:center;';document.body.appendChild(mdl);}
  mdl.innerHTML=`<div style="background:#fff;border-radius:14px;width:90%;max-width:400px;overflow:hidden;">
    <div style="background:#37474F;color:#fff;padding:12px 18px;font-size:14px;font-weight:700;">${title}</div>
    <div style="padding:18px;">
      <textarea id="reasonInput" placeholder="사유를 입력하세요 (선택사항)" style="width:100%;height:70px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:12px;resize:vertical;box-sizing:border-box;"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button onclick="document.getElementById('reasonModal').style.display='none'" style="padding:7px 18px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;font-size:12px;cursor:pointer;">취소</button>
        <button id="reasonConfirmBtn" style="padding:7px 18px;background:var(--p);color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:700;">확인</button>
      </div>
    </div>
  </div>`;
  mdl.style.display='flex';
  setTimeout(()=>{document.getElementById('reasonInput').focus();},100);
  document.getElementById('reasonConfirmBtn').onclick=function(){
    const reason=document.getElementById('reasonInput').value.trim();
    mdl.style.display='none';
    callback(reason||null);
  };
  document.getElementById('reasonInput').onkeydown=function(e){
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('reasonConfirmBtn').click();}
  };
}

function revertToLog(idx){
  const log=actLog[idx];
  if(!log||!log.snap){toast('이 로그에는 복원 데이터가 없습니다','e');return;}
  document.getElementById('logModal').style.display='none';
  promptReason(`🔙 "${log.desc}" 시점으로 복원`,function(reason){
    pushUndo('로그복원',`"${log.desc}" 시점으로 복원`,JSON.stringify(bks),reason);
    bks=JSON.parse(log.snap);
    sv();rfr();
    toast(`↩ "${log.desc}" 시점으로 복원 완료`,'s');
  });
}

let _logFilter={from:'',to:'',action:'all',user:'all'};

function setLogRange(days){
  const to=new Date();
  const from=new Date();
  from.setDate(from.getDate()-days);
  _logFilter.to=to.toISOString().split('T')[0];
  _logFilter.from=from.toISOString().split('T')[0];
  renderLogContent();
}

function setLogRangeInput(days){
  const to=new Date();
  const from=new Date();
  from.setDate(from.getDate()-days);
  const toStr=to.toISOString().split('T')[0];
  const fromStr=from.toISOString().split('T')[0];
  const elFrom=document.getElementById('logFrom');
  const elTo=document.getElementById('logTo');
  if(elFrom)elFrom.value=fromStr;
  if(elTo)elTo.value=toStr;
}

function applyLogFilter(){
  const f=document.getElementById('logFrom');
  const t=document.getElementById('logTo');
  const a=document.getElementById('logActFilter');
  const u=document.getElementById('logUserFilter');
  _logFilter.from=f?f.value:'';
  _logFilter.to=t?t.value:'';
  _logFilter.action=a?a.value:'all';
  _logFilter.user=u?u.value:'all';
  renderLogContent();
}

function showLogPanel(){
  let mdl=document.getElementById('logModal');
  if(!mdl){mdl=document.createElement('div');mdl.id='logModal';mdl.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;';document.body.appendChild(mdl);}
  renderLogContent();
  mdl.style.display='flex';
}

function parseLogDate(timeStr){
  try{
    const m=timeStr.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
    if(m)return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
  }catch(e){}
  return '';
}

function renderLogContent(){
  const mdl=document.getElementById('logModal');if(!mdl)return;
  const actionIcons={'입력':'✏️','수정':'📝','삭제':'🗑️','상태변경':'🔄','↩ 되돌리기':'↩','↪ 다시실행':'↪','취소':'❌','확정':'✅','일정표저장':'💾','일정표삭제':'🗑️','엑셀업로드':'📥','로그복원':'🔙','로그인':'🔑','로그아웃':'🚪'};
  const actionColors={'입력':'#e8f5e9','수정':'#e3f2fd','삭제':'#ffebee','상태변경':'#fff3e0','↩ 되돌리기':'#e3f2fd','↪ 다시실행':'#f3e5f5','취소':'#ffebee','확정':'#e8f5e9','일정표저장':'#e8f5e9','일정표삭제':'#ffebee','엑셀업로드':'#e8f5e9','로그복원':'#e8eaf6','로그인':'#e8f5e9','로그아웃':'#f5f5f5'};
  const allActions=[...new Set(actLog.map(l=>l.action))];
  const allUsers=[...new Set(actLog.map(l=>l.user).filter(Boolean))];

  // Filter logs
  let filtered=actLog.map((l,i)=>({...l,_idx:i}));
  if(_logFilter.from){filtered=filtered.filter(l=>parseLogDate(l.time)>=_logFilter.from);}
  if(_logFilter.to){filtered=filtered.filter(l=>parseLogDate(l.time)<=_logFilter.to);}
  if(_logFilter.action!=='all'){filtered=filtered.filter(l=>l.action===_logFilter.action);}
  if(_logFilter.user!=='all'){filtered=filtered.filter(l=>l.user===_logFilter.user);}

  const logs=[...filtered].reverse();
  const grouped={};
  logs.forEach(l=>{const dk=l.time.split(' ')[0]||'기타';if(!grouped[dk])grouped[dk]=[];grouped[dk].push(l);});

  // Stats summary
  const statByAction={};
  const statByUser={};
  filtered.forEach(l=>{statByAction[l.action]=(statByAction[l.action]||0)+1;statByUser[l.user||'-']=(statByUser[l.user||'-']||0)+1;});

  let html=`<div style="background:#fff;border-radius:14px;width:95%;max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
    <div style="background:#37474F;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;">
      <h3 style="font-size:15px;font-weight:700;">📜 활동 로그</h3>
      <div style="display:flex;gap:6px;">
        <button onclick="exportLogExcel()" style="padding:4px 12px;background:#2e7d32;color:#fff;border:none;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;">📥 엑셀</button>
        <button onclick="clearLog()" style="padding:4px 12px;background:#ff5252;color:#fff;border:none;border-radius:6px;font-size:10px;cursor:pointer;">전체삭제</button>
        <button onclick="document.getElementById('logModal').style.display='none'" style="padding:4px 12px;background:rgba(255,255,255,.2);color:#fff;border:none;border-radius:6px;font-size:10px;cursor:pointer;">닫기</button>
      </div>
    </div>
    <div style="padding:10px 16px;background:#ECEFF1;">
      <div style="display:flex;flex-wrap:wrap;gap:5px;align-items:center;margin-bottom:6px;">
        <input type="date" id="logFrom" value="${_logFilter.from}" style="padding:4px 6px;border:1px solid #ccc;border-radius:5px;font-size:11px;">
        <span style="font-size:11px;color:#888;">~</span>
        <input type="date" id="logTo" value="${_logFilter.to}" style="padding:4px 6px;border:1px solid #ccc;border-radius:5px;font-size:11px;">
        <select id="logActFilter" style="padding:4px 6px;border:1px solid #ccc;border-radius:5px;font-size:11px;">
          <option value="all">전체 유형</option>
          ${allActions.map(a=>`<option value="${a}" ${_logFilter.action===a?'selected':''}>${actionIcons[a]||''} ${a}</option>`).join('')}
        </select>
        <select id="logUserFilter" style="padding:4px 6px;border:1px solid #ccc;border-radius:5px;font-size:11px;">
          <option value="all">전체 작업자</option>
          ${allUsers.map(u=>`<option value="${u}" ${_logFilter.user===u?'selected':''}>${u}</option>`).join('')}
        </select>
        <button onclick="applyLogFilter()" style="padding:4px 14px;background:#1976d2;color:#fff;border:none;border-radius:5px;font-size:11px;cursor:pointer;font-weight:700;">🔍 조회</button>
        <button onclick="_logFilter={from:'',to:'',action:'all',user:'all'};renderLogContent();" style="padding:4px 8px;background:#fff;border:1px solid #ccc;border-radius:5px;font-size:10px;cursor:pointer;">초기화</button>
      </div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        <button onclick="setLogRangeInput(0)" style="padding:2px 10px;background:#fff;border:1px solid #bbb;border-radius:4px;font-size:10px;cursor:pointer;">오늘</button>
        <button onclick="setLogRangeInput(7)" style="padding:2px 10px;background:#fff;border:1px solid #bbb;border-radius:4px;font-size:10px;cursor:pointer;">1주일</button>
        <button onclick="setLogRangeInput(30)" style="padding:2px 10px;background:#fff;border:1px solid #bbb;border-radius:4px;font-size:10px;cursor:pointer;">1개월</button>
        <button onclick="setLogRangeInput(90)" style="padding:2px 10px;background:#fff;border:1px solid #bbb;border-radius:4px;font-size:10px;cursor:pointer;">3개월</button>
        <button onclick="setLogRangeInput(365)" style="padding:2px 10px;background:#fff;border:1px solid #bbb;border-radius:4px;font-size:10px;cursor:pointer;">1년</button>
      </div>
    </div>
    <div style="padding:10px 16px;background:#fff;border-bottom:1px solid #eee;">
      <div style="font-size:12px;font-weight:700;color:#37474F;margin-bottom:8px;">📊 조회결과: ${filtered.length}건</div>
      <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:6px;">
        ${Object.entries(statByAction).sort((a,b)=>b[1]-a[1]).map(([k,v])=>{
          const byUser={};
          filtered.filter(x=>x.action===k).forEach(x=>{byUser[x.user||'-']=(byUser[x.user||'-']||0)+1;});
          const tip=Object.entries(byUser).sort((a,b)=>b[1]-a[1]).map(([u,c])=>u+': '+c+'건').join('&#10;');
          return `<span style="font-size:10px;padding:2px 7px;background:${actionColors[k]||'#f5f5f5'};border-radius:4px;white-space:nowrap;cursor:default;position:relative;" title="${k} ${v}건&#10;─────&#10;${tip}">${actionIcons[k]||''}${k} <strong>${v}</strong></span>`;
        }).join('')}
      </div>
      ${(()=>{
        const userColors2=['#1976d2','#c2185b','#00796b','#e65100','#6a1b9a','#2e7d32','#d84315','#283593','#00838f','#4e342e'];
        const userBgs2=['#e3f2fd','#fce4ec','#e0f2f1','#fff3e0','#f3e5f5','#e8f5e9','#fbe9e7','#e8eaf6','#e0f7fa','#efebe9'];
        const allU3=[...new Set(actLog.map(x=>x.user).filter(x=>x&&x!=='-'&&x!=='고객'))];
        const adminMap2={};adminAccounts.forEach(a=>{adminMap2[a.name]=a.role==='master'?'👑':'🔧';});
        // Pre-store per-user detailed data for popup
        const _cardUserData={};
        let uh='';
        Object.entries(statByUser).sort((a,b)=>b[1]-a[1]).forEach(([uname,total])=>{
          let uIdx2=allU3.indexOf(uname)%userColors2.length;if(uIdx2<0)uIdx2=0;
          const uc=uname==='고객'?'#888':userColors2[uIdx2];
          const ubg=uname==='고객'?'#f5f5f5':userBgs2[uIdx2];
          const roleIcon=adminMap2[uname]||'';
          const perUser={};
          const userLogs=filtered.filter(x=>x.user===uname);
          userLogs.forEach(x=>{perUser[x.action]=(perUser[x.action]||0)+1;});
          const details=Object.entries(perUser).sort((a,b)=>b[1]-a[1]).map(([a,c])=>`${actionIcons[a]||''}${a}${c}`).join(' ');
          _cardUserData[uname]={actions:perUser,logs:userLogs,total,color:uc};
          const safeU=uname.replace(/'/g,"\\'");
          uh+=`<div class="logCardUser" onmouseenter="showUserTip(event,'${safeU}')" onmouseleave="hideUserTip()" style="display:flex;align-items:center;gap:6px;padding:5px 8px;background:${ubg};border-radius:6px;border-left:3px solid ${uc};cursor:pointer;transition:box-shadow .15s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,.12)'" onmouseout="this.style.boxShadow='none'">
            <span style="font-size:11px;font-weight:700;color:${uc};min-width:70px;">${roleIcon} ${uname}</span>
            <span style="font-size:12px;font-weight:800;color:${uc};">${total}건</span>
            <span style="font-size:9px;color:#888;flex:1;">${details}</span>
            <span style="font-size:9px;color:#bbb;">🔍</span>
          </div>`;
        });
        // Store for popup use
        window._cardUserData=_cardUserData;
        return uh?'<div style="display:flex;flex-direction:column;gap:4px;">'+uh+'</div>':'';
      })()}
    </div>
    <div style="padding:3px 16px;background:#fafafa;font-size:9px;color:#aaa;">💡 파란 줄 = 복원 가능 | 💬 주황 메모 = 사유</div>
    <div id="logListArea" style="overflow-y:auto;padding:12px 16px;flex:1;">`;

  // Pre-build per-user stats for tooltips (always, regardless of log count)
  const _userStats={};
  filtered.forEach(fl=>{
    const u=fl.user||'-';
    if(!_userStats[u])_userStats[u]={actions:{},logs:[]};
    _userStats[u].actions[fl.action]=(_userStats[u].actions[fl.action]||0)+1;
    _userStats[u].logs.push(fl);
  });
  const adminMap3={};adminAccounts.forEach(a=>{adminMap3[a.name]=a.role==='master'?'👑 마스터':'🔧 관리자';});

  if(!logs.length){
    html+='<div style="text-align:center;color:#aaa;padding:30px;font-size:13px;">조건에 맞는 로그가 없습니다.</div>';
  } else {
    const userColors=['#1976d2','#c2185b','#00796b','#e65100','#6a1b9a','#2e7d32','#d84315','#283593','#00838f','#4e342e'];
    const userBgs=['#e3f2fd','#fce4ec','#e0f2f1','#fff3e0','#f3e5f5','#e8f5e9','#fbe9e7','#e8eaf6','#e0f7fa','#efebe9'];
    const allU2=[...new Set(actLog.map(x=>x.user).filter(x=>x&&x!=='-'&&x!=='고객'))];

    Object.keys(grouped).forEach(dk=>{
      html+=`<div style="font-size:11px;font-weight:700;color:#888;margin:10px 0 5px;padding-bottom:3px;border-bottom:1px solid #eee;">${dk} (${grouped[dk].length}건)</div>`;
      grouped[dk].forEach(l=>{
        const icon=actionIcons[l.action]||'📋';
        const bg=actionColors[l.action]||'#f5f5f5';
        const hasSnap=!!l.snap;
        const isRevertable=['입력','수정','삭제','상태변경','취소','엑셀업로드','↩ 되돌리기','↪ 다시실행','로그복원'].includes(l.action);
        const uName=l.user||'-';
        let uIdx=0;
        if(uName!=='-'&&uName!=='고객'){uIdx=allU2.indexOf(uName)%userColors.length;if(uIdx<0)uIdx=0;}
        const uColor=uName==='고객'?'#888':userColors[uIdx];
        const uBg2=uName==='고객'?'#f5f5f5':userBgs[uIdx];
        const snapBtn=hasSnap?`<button onclick="revertToLog(${l._idx})" style="padding:3px 10px;background:#1976d2;color:#fff;border:none;border-radius:5px;font-size:10px;cursor:pointer;white-space:nowrap;font-weight:600;">↩ 복원</button>`:(isRevertable?`<span style="font-size:9px;color:#bbb;white-space:nowrap;">복원불가</span>`:'');
        const reasonHtml=l.reason?`<div style="margin-top:3px;padding:3px 8px;background:#fff;border-left:2px solid #e65100;border-radius:0 4px 4px 0;font-size:10px;color:#e65100;">💬 ${l.reason}</div>`:'';
        const safeUser=uName.replace(/'/g,"\\'");
        html+=`<div style="padding:7px 10px;margin-bottom:3px;background:${bg};border-radius:8px;${hasSnap?'border-left:3px solid #1976d2;':''}">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:13px;">${icon}</span>
            <span style="font-size:11px;font-weight:700;min-width:50px;">${l.action}</span>
            <span style="font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${l.desc}</span>
            <span class="logUserBadge" onmouseenter="showUserTip(event,'${safeUser}')" onmouseleave="hideUserTip()" style="font-size:9px;color:${uColor};font-weight:700;white-space:nowrap;background:${uBg2};padding:1px 6px;border-radius:3px;cursor:pointer;">${uName}</span>
            <span style="font-size:9px;color:#999;white-space:nowrap;">${l.time.split(' ').slice(1).join(' ')||l.time}</span>
            ${snapBtn}
          </div>
          ${reasonHtml}
        </div>`;
      });
    });
  }
  html+='</div></div>';
  mdl.innerHTML=html;
  // Store user stats globally for tooltip
  window._logUserStats=_userStats;
  window._logAdminMap=adminMap3;
  window._logActionIcons=actionIcons;
}

let _userTipTimer=null;
function showUserTip(e,userName){
  clearTimeout(_userTipTimer);
  let tip=document.getElementById('logUserTip');
  if(!tip){tip=document.createElement('div');tip.id='logUserTip';tip.style.cssText='position:fixed;z-index:10002;background:#fff;border-radius:12px;box-shadow:0 6px 32px rgba(0,0,0,.3);padding:0;pointer-events:auto;width:340px;overflow:hidden;display:none;';document.body.appendChild(tip);}
  // Try both data sources
  const stats=window._logUserStats?.[userName]||window._cardUserData?.[userName];
  if(!stats){tip.style.display='none';return;}
  const icons=window._logActionIcons||{};
  const role=window._logAdminMap?.[userName]||'';
  const total=stats.total||stats.logs.length;
  const actions=stats.actions||{};
  const logs=stats.logs||[];
  const actEntries=Object.entries(actions).sort((a,b)=>b[1]-a[1]);
  const maxAct=actEntries.length?actEntries[0][1]:1;

  // Group recent logs by date
  const recentAll=logs.slice(-15).reverse();
  const byDate={};
  recentAll.forEach(r=>{
    const dk=r.time?.split(' ')[0]||'';
    if(!byDate[dk])byDate[dk]=[];
    byDate[dk].push(r);
  });

  const color=stats.color||'#1976d2';

  let h=`<div style="background:${color};color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
    <span style="font-size:13px;font-weight:700;">${role?role+' ':''}${userName}</span>
    <span style="font-size:11px;opacity:.8;">${total}건</span>
  </div>`;

  h+='<div style="max-height:320px;overflow-y:auto;">';

  // Action stats with bar chart
  h+='<div style="padding:10px 14px 6px;">';
  h+='<div style="font-size:10px;font-weight:700;color:#888;margin-bottom:6px;">📊 유형별 통계</div>';
  actEntries.forEach(([a,c])=>{
    const pct=Math.round(c/maxAct*100);
    const actionBg=({'입력':'#4CAF50','수정':'#2196F3','삭제':'#f44336','상태변경':'#FF9800','↩ 되돌리기':'#2196F3','↪ 다시실행':'#9C27B0','취소':'#f44336','로그인':'#4CAF50','로그아웃':'#9E9E9E','로그복원':'#3F51B5','엑셀업로드':'#4CAF50','일정표저장':'#4CAF50','일정표삭제':'#f44336'})[a]||'#888';
    h+=`<div style="display:flex;align-items:center;gap:5px;margin-bottom:3px;">
      <span style="font-size:12px;width:16px;text-align:center;">${icons[a]||''}</span>
      <span style="font-size:10px;min-width:58px;color:#555;">${a}</span>
      <div style="flex:1;background:#f0f0f0;border-radius:3px;height:12px;overflow:hidden;"><div style="width:${pct}%;background:${actionBg};height:100%;border-radius:3px;transition:width .3s;"></div></div>
      <span style="font-size:11px;font-weight:700;min-width:32px;text-align:right;color:#333;">${c}건</span>
    </div>`;
  });
  h+='</div>';

  // Recent activity grouped by date
  h+='<div style="padding:6px 14px 10px;border-top:1px solid #f0f0f0;">';
  h+='<div style="font-size:10px;font-weight:700;color:#888;margin-bottom:6px;">🕐 최근 활동</div>';
  Object.keys(byDate).forEach(dk=>{
    h+=`<div style="font-size:9px;color:#aaa;margin:4px 0 2px;font-weight:600;">${dk}</div>`;
    byDate[dk].forEach(r=>{
      const timeStr=r.time?.split(' ').slice(1).join(' ')||'';
      const actionBg2=({'입력':'#e8f5e9','수정':'#e3f2fd','삭제':'#ffebee','상태변경':'#fff3e0','취소':'#ffebee'})[r.action]||'#f9f9f9';
      h+=`<div style="display:flex;align-items:start;gap:4px;padding:3px 4px;margin-bottom:1px;background:${actionBg2};border-radius:4px;">
        <span style="font-size:11px;flex-shrink:0;">${icons[r.action]||''}</span>
        <div style="flex:1;min-width:0;">
          <div style="font-size:10px;color:#333;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.desc}</div>
          ${r.reason?'<div style="font-size:9px;color:#e65100;margin-top:1px;">💬 '+r.reason+'</div>':''}
        </div>
        <span style="font-size:9px;color:#bbb;white-space:nowrap;flex-shrink:0;">${timeStr}</span>
      </div>`;
    });
  });
  h+='</div></div>';

  tip.innerHTML=h;
  tip.style.display='block';

  // Keep tooltip alive when hovering over it
  tip.onmouseenter=function(){clearTimeout(_userTipTimer);};
  tip.onmouseleave=function(){hideUserTip();};

  const rect=e.target.closest('.logCardUser,.logUserBadge')?.getBoundingClientRect()||e.target.getBoundingClientRect();
  let left=rect.right+10;
  if(left+350>window.innerWidth)left=rect.left-350;
  if(left<5)left=5;
  let top=rect.top;
  if(top+tip.offsetHeight>window.innerHeight-10)top=window.innerHeight-tip.offsetHeight-10;
  if(top<5)top=5;
  tip.style.left=left+'px';
  tip.style.top=top+'px';
}
function hideUserTip(){
  _userTipTimer=setTimeout(()=>{const t=document.getElementById('logUserTip');if(t)t.style.display='none';},300);
}

function exportLogExcel(){
  let filtered=actLog.map((l,i)=>({...l,_idx:i}));
  if(_logFilter.from){filtered=filtered.filter(l=>parseLogDate(l.time)>=_logFilter.from);}
  if(_logFilter.to){filtered=filtered.filter(l=>parseLogDate(l.time)<=_logFilter.to);}
  if(_logFilter.action!=='all'){filtered=filtered.filter(l=>l.action===_logFilter.action);}
  if(_logFilter.user!=='all'){filtered=filtered.filter(l=>l.user===_logFilter.user);}

  const adminMap={};
  adminAccounts.forEach(a=>{adminMap[a.name]=a.role==='master'?'마스터':'관리자';});

  // Build stats
  const statAct={},statUser={},statUserAct={};
  filtered.forEach(l=>{
    statAct[l.action]=(statAct[l.action]||0)+1;
    const u=l.user||'-';
    statUser[u]=(statUser[u]||0)+1;
    if(!statUserAct[u])statUserAct[u]={};
    statUserAct[u][l.action]=(statUserAct[u][l.action]||0)+1;
  });
  const range=(_logFilter.from||'전체')+'~'+(_logFilter.to||'전체');

  let t='<html><head><meta charset="utf-8"></head><body>';

  // Summary header
  t+='<table border="1" style="border-collapse:collapse;">';
  t+='<tr style="background:#37474F;color:#fff;"><td colspan="8" style="font-size:16px;font-weight:bold;padding:8px;">📜 활동 로그 조회결과</td></tr>';
  t+='<tr style="background:#ECEFF1;"><td style="font-weight:bold;">조회기간</td><td colspan="7">'+range+'</td></tr>';
  t+='<tr style="background:#ECEFF1;"><td style="font-weight:bold;">총 건수</td><td colspan="7">'+filtered.length+'건</td></tr>';

  // Action type summary
  t+='<tr style="background:#E8F5E9;"><td style="font-weight:bold;">유형별</td>';
  const actEntries=Object.entries(statAct).sort((a,b)=>b[1]-a[1]);
  t+='<td colspan="7">'+actEntries.map(([k,v])=>k+' '+v+'건').join(' | ')+'</td></tr>';

  // Per-user breakdown
  t+='<tr style="background:#fff3e0;"><td colspan="8" style="font-weight:bold;">👥 작업자별 상세</td></tr>';
  t+='<tr style="background:#fff3e0;"><td style="font-weight:bold;">작업자</td><td style="font-weight:bold;">역할</td><td style="font-weight:bold;">총건수</td><td colspan="5" style="font-weight:bold;">세부내역</td></tr>';
  Object.entries(statUser).sort((a,b)=>b[1]-a[1]).forEach(([u,total])=>{
    const role=adminMap[u]||(u==='고객'?'고객':'');
    const details=Object.entries(statUserAct[u]||{}).sort((a,b)=>b[1]-a[1]).map(([a,c])=>a+' '+c+'건').join(', ');
    t+='<tr><td>'+u+'</td><td>'+role+'</td><td>'+total+'건</td><td colspan="5">'+details+'</td></tr>';
  });

  t+='<tr><td colspan="8"></td></tr>';

  // Detail table
  t+='<tr style="background:#37474F;color:#fff;font-weight:bold;"><td>No</td><td>일시</td><td>유형</td><td>내용</td><td>작업자</td><td>역할</td><td>사유</td><td>복원가능</td></tr>';
  filtered.forEach((l,i)=>{
    const role=adminMap[l.user]||(l.user==='고객'?'고객':'');
    const bg=i%2===0?'#fff':'#f9f9f9';
    const snap=l.snap?'O':'';
    t+='<tr style="background:'+bg+';"><td>'+(i+1)+'</td><td>'+l.time+'</td><td>'+l.action+'</td><td>'+((l.desc||'').replace(/</g,'&lt;'))+'</td><td>'+(l.user||'-')+'</td><td>'+role+'</td><td>'+((l.reason||'').replace(/</g,'&lt;'))+'</td><td>'+snap+'</td></tr>';
  });
  t+='</table></body></html>';

  dl(t,`활동로그_${range}_${td()}.xls`);
  toast(`📥 ${filtered.length}건 엑셀 다운로드`,'s');
}

function sv(){try{localStorage.setItem(BK_K,JSON.stringify(bks));}catch(e){}}
function svC(){try{localStorage.setItem(CS_K,JSON.stringify(cs));}catch(e){}}

// Sample data loaded via loadFacilityData

// ===== LOGIN =====
let sm='c';
// hideAllEntries moved below
function backToMain(){hideAllEntries();document.getElementById('mainEntry').style.display='block';}
function showBookingEntry(){hideAllEntries();document.getElementById('bookEntry').style.display='block';}
function showCheckEntry(){hideAllEntries();document.getElementById('checkEntry').style.display='block';}
function showAdmin(){hideAllEntries();document.getElementById('af').style.display='block';}
function showAgencyLogin(){hideAllEntries();document.getElementById('agencyEntry').style.display='block';}
function hideAdmin(){backToMain();}

// ===== Account Recovery =====
function hideAllEntries(){
  ['mainEntry','bookEntry','checkEntry','af','agencyEntry','adminRecoverPanel','agencyRecoverPanel'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.style.display='none';
  });
}

function showAdminRecover(){
  document.getElementById('af').style.display='none';
  document.getElementById('adminRecoverPanel').style.display='block';
  document.getElementById('admRecoverResult').innerHTML='';
}
function hideAdminRecover(){
  document.getElementById('adminRecoverPanel').style.display='none';
  document.getElementById('af').style.display='block';
}
function doAdminRecover(){
  const key=(document.getElementById('admRecoverKey').value||'').trim().toLowerCase();
  if(!key){toast('이름 또는 연락처를 입력하세요','e');return;}
  const results=adminAccounts.filter(a=>
    a.name.toLowerCase().includes(key)||
    (a.phone||'').replace(/-/g,'').includes(key.replace(/-/g,''))||
    a.id.toLowerCase().includes(key)
  );
  const el=document.getElementById('admRecoverResult');
  if(!results.length){
    el.innerHTML=`<div style="padding:12px;background:#ffebee;border-radius:8px;font-size:12px;color:#c62828;">
      <strong>❌ 일치하는 계정을 찾을 수 없습니다.</strong><br>
      <span style="font-size:11px;color:#888;">이름, 아이디, 연락처를 정확히 입력해주세요.<br>계속 문제가 있으시면 관리자에게 문의하세요.</span>
    </div>`;
    return;
  }
  let h=`<div style="font-size:12px;font-weight:700;color:#1565c0;margin-bottom:8px;">✅ ${results.length}개 계정을 찾았습니다</div>`;
  results.forEach(a=>{
    const maskedPw=a.pw.charAt(0)+'•'.repeat(Math.max(a.pw.length-2,1))+a.pw.charAt(a.pw.length-1);
    const roleBg=a.role==='master'?'#FFF3E0':'#E3F2FD';
    const roleColor=a.role==='master'?'#E65100':'#1565C0';
    const roleLabel=a.role==='master'?'👑 마스터':'🔧 관리자';
    h+=`<div style="background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:12px;margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:14px;font-weight:700;">${a.name}</span>
        <span style="background:${roleBg};color:${roleColor};padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;">${roleLabel}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">
        <div style="background:#f5f5f5;padding:6px 10px;border-radius:6px;">
          <div style="font-size:9px;color:#888;">아이디</div>
          <div style="font-weight:700;color:#333;">${a.id}</div>
        </div>
        <div style="background:#f5f5f5;padding:6px 10px;border-radius:6px;">
          <div style="font-size:9px;color:#888;">비밀번호 힌트</div>
          <div style="font-weight:700;color:#333;letter-spacing:1px;">${maskedPw}</div>
        </div>
      </div>
      <button onclick="document.getElementById('verifyBox_${a.id}').style.display='block';this.style.display='none';" style="margin-top:8px;width:100%;padding:6px;background:#e3f2fd;color:#1565c0;border:1px solid #90caf9;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">🔓 비밀번호 전체 보기 (본인확인)</button>
      <div id="verifyBox_${a.id}" style="display:none;margin-top:6px;padding:10px;background:#f5f5f5;border-radius:8px;border:1px solid #ddd;">
        <div style="font-size:11px;font-weight:700;color:#333;margin-bottom:6px;">📞 본인 확인</div>
        <div style="font-size:10px;color:#888;margin-bottom:6px;">등록된 연락처를 입력하세요</div>
        <div style="display:flex;gap:6px;">
          <input type="tel" id="verifyPhone_${a.id}" placeholder="연락처 입력" style="flex:1;padding:6px 10px;border:2px solid #90caf9;border-radius:6px;font-size:12px;">
          <button onclick="revealAdminPw('${a.id}')" style="padding:6px 14px;background:#1565c0;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;">확인</button>
        </div>
      </div>
      <div id="revealPw_${a.id}" style="display:none;margin-top:6px;padding:8px;background:#e8f5e9;border-radius:6px;text-align:center;">
        <span style="font-size:9px;color:#888;">비밀번호:</span>
        <span id="revealPwVal_${a.id}" style="font-size:16px;font-weight:800;color:#2e7d32;letter-spacing:2px;margin-left:6px;"></span>
      </div>
    </div>`;
  });
  el.innerHTML=h;
}

function revealAdminPw(aid){
  const a=adminAccounts.find(x=>x.id===aid);if(!a)return;
  const inp=document.getElementById('verifyPhone_'+aid);
  const phone=(inp?.value||'').trim();
  const regPhone=(a.phone||'').replace(/-/g,'').trim();
  if(!regPhone){
    document.getElementById('revealPw_'+aid).style.display='block';
    document.getElementById('revealPwVal_'+aid).textContent=a.pw;
    return;
  }
  if(!phone){toast('연락처를 입력하세요','e');return;}
  const clean=phone.replace(/-/g,'').trim();
  if(clean===regPhone){
    document.getElementById('revealPw_'+aid).style.display='block';
    document.getElementById('revealPwVal_'+aid).textContent=a.pw;
    const vb=document.getElementById('verifyBox_'+aid);if(vb)vb.style.display='none';
    toast('✅ 본인확인 완료','s');
  } else {
    toast('❌ 연락처가 일치하지 않습니다','e');
    if(inp)inp.style.borderColor='#f44336';
  }
}

function showAgencyRecover(){
  document.getElementById('agencyEntry').style.display='none';
  document.getElementById('agencyRecoverPanel').style.display='block';
  document.getElementById('agRecoverResult').innerHTML='';
}
function hideAgencyRecover(){
  document.getElementById('agencyRecoverPanel').style.display='none';
  document.getElementById('agencyEntry').style.display='block';
}
function doAgencyRecover(){
  const key=(document.getElementById('agRecoverKey').value||'').trim().toLowerCase();
  if(!key){toast('대행사명 또는 연락처를 입력하세요','e');return;}
  const ags=JSON.parse(localStorage.getItem(FP+'agencies')||'[]');
  const results=ags.filter(a=>
    a.name.toLowerCase().includes(key)||
    (a.phone||'').replace(/-/g,'').includes(key.replace(/-/g,''))||
    (a.code||'').toLowerCase().includes(key)
  );
  const el=document.getElementById('agRecoverResult');
  if(!results.length){
    el.innerHTML=`<div style="padding:12px;background:#ffebee;border-radius:8px;font-size:12px;color:#c62828;">
      <strong>❌ 일치하는 대행사를 찾을 수 없습니다.</strong><br>
      <span style="font-size:11px;color:#888;">대행사명, 코드, 연락처를 정확히 입력해주세요.<br>계속 문제가 있으시면 관리자에게 문의하세요.</span>
    </div>`;
    return;
  }
  let h=`<div style="font-size:12px;font-weight:700;color:#e65100;margin-bottom:8px;">✅ ${results.length}개 대행사를 찾았습니다</div>`;
  results.forEach(a=>{
    const maskedPw=(a.pw||'').charAt(0)+'•'.repeat(Math.max((a.pw||'').length-2,1))+(a.pw||'').charAt((a.pw||'').length-1);
    h+=`<div style="background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:12px;margin-bottom:8px;">
      <div style="font-size:14px;font-weight:700;margin-bottom:8px;">🏢 ${a.name}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">
        <div style="background:#fff8e1;padding:6px 10px;border-radius:6px;">
          <div style="font-size:9px;color:#888;">로그인 코드</div>
          <div style="font-weight:700;color:#e65100;">${a.code}</div>
        </div>
        <div style="background:#fff8e1;padding:6px 10px;border-radius:6px;">
          <div style="font-size:9px;color:#888;">비밀번호 힌트</div>
          <div style="font-weight:700;color:#333;letter-spacing:1px;">${maskedPw}</div>
        </div>
      </div>
      <button onclick="document.getElementById('verifyAgBox_${a.code}').style.display='block';this.style.display='none';" style="margin-top:8px;width:100%;padding:6px;background:#fff3e0;color:#e65100;border:1px solid #ffcc80;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">🔓 비밀번호 전체 보기 (본인확인)</button>
      <div id="verifyAgBox_${a.code}" style="display:none;margin-top:6px;padding:10px;background:#f5f5f5;border-radius:8px;border:1px solid #ddd;">
        <div style="font-size:11px;font-weight:700;color:#333;margin-bottom:6px;">📞 본인 확인</div>
        <div style="font-size:10px;color:#888;margin-bottom:6px;">등록된 연락처를 입력하세요</div>
        <div style="display:flex;gap:6px;">
          <input type="tel" id="verifyAgPhone_${a.code}" placeholder="연락처 입력" style="flex:1;padding:6px 10px;border:2px solid #ffcc80;border-radius:6px;font-size:12px;">
          <button onclick="revealAgencyPw('${a.code}')" style="padding:6px 14px;background:#e65100;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;">확인</button>
        </div>
      </div>
      <div id="revealAgPw_${a.code}" style="display:none;margin-top:6px;padding:8px;background:#e8f5e9;border-radius:6px;text-align:center;">
        <span style="font-size:9px;color:#888;">비밀번호:</span>
        <span id="revealAgPwVal_${a.code}" style="font-size:16px;font-weight:800;color:#2e7d32;letter-spacing:2px;margin-left:6px;"></span>
      </div>
    </div>`;
  });
  el.innerHTML=h;
}

function revealAgencyPw(code){
  const ags=JSON.parse(localStorage.getItem(FP+'agencies')||'[]');
  const a=ags.find(x=>x.code===code);if(!a)return;
  const inp=document.getElementById('verifyAgPhone_'+code);
  const phone=(inp?.value||'').trim();
  const regPhone=(a.phone||'').replace(/-/g,'').trim();
  if(!regPhone){
    document.getElementById('revealAgPw_'+code).style.display='block';
    document.getElementById('revealAgPwVal_'+code).textContent=a.pw||'';
    return;
  }
  if(!phone){toast('연락처를 입력하세요','e');return;}
  const clean=phone.replace(/-/g,'').trim();
  if(clean===regPhone){
    document.getElementById('revealAgPw_'+code).style.display='block';
    document.getElementById('revealAgPwVal_'+code).textContent=a.pw||'';
    const vb=document.getElementById('verifyAgBox_'+code);if(vb)vb.style.display='none';
    toast('✅ 본인확인 완료','s');
  } else {
    toast('❌ 연락처가 일치하지 않습니다','e');
    if(inp)inp.style.borderColor='#f44336';
  }
}

function goBookingDirect(){
  const p=document.getElementById('lph').value.trim();if(!p){toast('연락처를 입력하세요','e');return;}
  uph=p;mode='customer';startMode='book';
  document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='block';setupNav();
  if('Notification' in window&&Notification.permission==='default')Notification.requestPermission();
}
function goCheckDirect(){
  const p=document.getElementById('lph2').value.trim();if(!p){toast('연락처를 입력하세요','e');return;}
  uph=p;mode='customer';startMode='check';
  document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='block';setupNav();
  if('Notification' in window&&Notification.permission==='default')Notification.requestPermission();
}
function doAdminLogin(){
  const lid=document.getElementById('lid').value.trim();
  const lpw=document.getElementById('lpw').value;
  if(!lid||!lpw){toast('아이디와 비밀번호를 입력하세요','e');return;}
  const acc=adminAccounts.find(a=>a.id===lid&&a.pw===lpw);
  if(!acc){toast('아이디 또는 비밀번호 오류','e');return;}
  curAdmin={id:acc.id,name:acc.name,role:acc.role};
  mode='admin';startMode=null;
  document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='block';setupNav();
  addLog('로그인',`${acc.name}(${acc.role==='master'?'마스터':'관리자'}) 로그인`);
  if('Notification' in window&&Notification.permission==='default')Notification.requestPermission();
  JAMSA.initAll(FP);
}
let startMode=null;
function doLogout(){if(curAdmin)addLog('로그아웃',`${curAdmin.name} 로그아웃`);mode=null;uph='';startMode=null;curAdmin=null;document.getElementById('app').style.display='none';document.getElementById('loginScreen').style.display='flex';document.getElementById('lpw').value='';const lid=document.getElementById('lid');if(lid)lid.value='';document.querySelectorAll('.page').forEach(p=>p.classList.remove('act'));backToMain();}

// ===== NAV =====
function setupNav(){
  const n=document.getElementById('nl'),bd=document.getElementById('mbd');

  if(mode==='customer'){
    bd.textContent='고객';bd.className='mbadge cu';
    n.innerHTML=`<button class="nav-direct act" onclick="gp('cb')">📝 예약</button><button class="nav-direct" onclick="gp('cc')">📅 현황</button><button class="nav-direct" onclick="gp('cm')">📌 내예약</button><button class="nav-direct" onclick="gp('ct')">💬 채팅</button>`;
    if(startMode==='check')gp('cc');else gp('cb');
  }
  else if(mode==='agency'){
    bd.textContent=curAgency.name;bd.className='mbadge';bd.style.background='#e65100';bd.style.color='#fff';
    n.innerHTML=`<button class="nav-direct act" onclick="gp('agb')">📝 예약신청</button><button class="nav-direct" onclick="gp('agm')">📋 현황</button><button class="nav-direct" onclick="gp('ags')">💰 정산</button>`;
    gp('agb');
  }
  else{
    const rLabel=curAdmin?.role==='master'?'마스터':'관리자';
    bd.textContent=curAdmin?curAdmin.name:rLabel;
    bd.className='mbadge ad';

    // 메뉴 그룹 정의
    const groups=[
      {
        id:'nav-dash',label:'📊 대시보드',perm:'dashboard',
        direct:'ad' // 하위 없이 직접 이동
      },
      {
        id:'nav-reserve',label:'📅 예약',perm:null,
        items:[
          {page:'ac',icon:'📅',text:'캘린더',perm:'calendar'},
          {page:'ab',icon:'📋',text:'예약관리',perm:'bookings'},
          {page:'as',icon:'🗓️',text:'일정표',perm:'schedule'}
        ]
      },
      {
        id:'nav-comm',label:'💬 소통',perm:null,
        items:[
          {page:'at',icon:'💬',text:'채팅',perm:'chat'},
          {page:'ag',icon:'🏢',text:'대행사',perm:'agency'}
        ]
      },
      {
        id:'nav-sys',label:'⚙️ 설정',perm:'settings',
        direct:'ax'
      }
    ];

    let html='';
    groups.forEach(g=>{
      // 권한 필터
      if(g.direct&&g.perm&&!hasPerm(g.perm))return;
      if(g.items){
        const visibleItems=g.items.filter(it=>!it.perm||hasPerm(it.perm));
        if(!visibleItems.length)return;
        // 하위 1개면 직접 버튼
        if(visibleItems.length===1){
          const it=visibleItems[0];
          html+=`<button class="nav-direct" onclick="gpNav('${it.page}',this)">${it.icon} ${it.text}</button>`;
          return;
        }
        html+=visibleItems.map(it=>`<button class="nav-direct" onclick="gpNav('${it.page}',this)">${it.icon} ${it.text}</button>`).join('');
      } else {
        html+=`<button class="nav-direct" onclick="gpNav('${g.direct}',this)">${g.label}</button>`;
      }
    });

    if(!html)html=`<button class="nav-direct act" onclick="gpNav('ad',this)">📊 대시보드</button>`;
    n.innerHTML=html;

    if(hasPerm('dashboard'))gpNav('ad');else if(hasPerm('calendar'))gpNav('ac');else if(hasPerm('bookings'))gpNav('ab');else gpNav('ad');
  }

  if(mode==='admin'){
    let ub=document.getElementById('undoRedoBar');
    if(!ub){ub=document.createElement('div');ub.id='undoRedoBar';ub.style.cssText='position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:8000;display:flex;gap:6px;background:#fff;padding:6px 12px;border-radius:10px;box-shadow:0 2px 16px rgba(0,0,0,.15);';document.body.appendChild(ub);}
    renderUndoBtn();
  }
}

function gpNav(pageId,el){
  // 페이지 전환
  gp(pageId);
  // 활성 표시 — 모든 nav 버튼 비활성
  document.querySelectorAll('.navl .nav-main,.navl .nav-direct,.nav-sub button').forEach(b=>b.classList.remove('act'));
  // 클릭한 요소 활성
  if(el){
    if(el.classList.contains('nav-group')){
      el.querySelector('.nav-main')?.classList.add('act');
    } else if(el.closest){
      el.classList.add('act');
      const group=el.closest('.nav-group');
      if(group)group.querySelector('.nav-main')?.classList.add('act');
    }
  }
}

// ===== 서브탭 섹션 전환 =====
function toggleDashFilter(){
  const p=document.getElementById('dashFilterPanel');
  const b=document.getElementById('dashFilterToggle');
  if(p.style.display==='none'){
    p.style.display='block';
    b.innerHTML='📅 기간조회 ▲';
  } else {
    p.style.display='none';
    b.innerHTML='📅 기간조회 ▼';
  }
}
function showAdSec(sec,btn){
  document.querySelectorAll('[data-ad-sec]').forEach(el=>{
    el.style.display=(sec==='all'||el.dataset.adSec===sec)?'':'none';
  });
  document.querySelectorAll('#adSubTabs button').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  window.scrollTo({top:0,behavior:'smooth'});
}
function showAxSec(sec,btn){
  document.querySelectorAll('[data-ax-sec]').forEach(el=>{
    el.style.display=(sec==='all'||el.dataset.axSec===sec)?'':'none';
  });
  document.querySelectorAll('#axSubTabs button').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  if(sec==='update'||sec==='all'){if(typeof renderUpdatePanel==='function')renderUpdatePanel();}
  window.scrollTo({top:0,behavior:'smooth'});
}

function gp(n){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('act'));
  const el=document.getElementById('p-'+n);if(el)el.classList.add('act');
  document.querySelectorAll('.navl button').forEach(b=>b.classList.remove('act'));if(event?.target?.tagName==='BUTTON')event.target.classList.add('act');
  if(n==='cb')initBk();if(n==='cm')rMyBk();if(n==='cc'){iCCal();rCCal();}if(n==='ad')rDash();if(n==='ac'){iCal();rCal();}if(n==='ab'){setAbDateRange('today');setTimeout(()=>{const todayRow=document.querySelector('#abList tr[data-today="1"]');if(todayRow)todayRow.scrollIntoView({behavior:'smooth',block:'center'});},150);}if(n==='ag')renderAgencyStats();if(n==='agb')initAgBk();if(n==='agm')renderAgMyBk();if(n==='ags')renderAgSettle();if(n==='as'){if(!document.getElementById('sD').value)document.getElementById('sD').value=td();const sf=document.getElementById('savedSchFrom'),st2=document.getElementById('savedSchTo');if(sf&&!sf.value)sf.value=td();if(st2&&!st2.value)st2.value=td();renderSavedList();}if(n==='ax'){rCs();renderAgencyList();renderAdminFacList();if(typeof renderAdminMgmt==='function')renderAdminMgmt();renderSysInfo();}if(n==='at'){renderChatList();}if(n==='ct'){renderCustomerChat();}
}

// ===== CUSTOMER: BOOKING =====
// Form config (admin-editable)
const defaultFormCfg={
  meals:[{name:'오디돈가스',p1:8000,p2:10000}],
  pkgDesc:'기본입장: 잠사박물관·양떼목장·사계절썰매장·키즈카페',
  entryP1:12000,entryP2:13000,entryTea:12000,freeRatioChild:10,freeRatioElem:10,
  addons:[{name:'젤캔들',price:10000},{name:'먹이주기',price:2000},{name:'가이드(50인↑)',price:2000}],
  channels:['문자','이메일','우편물','사이트']
};
let formCfg=JSON.parse(JSON.stringify(defaultFormCfg));
// Migrate old format
if(formCfg.mealName&&!formCfg.meals){formCfg.meals=[{name:formCfg.mealName,p1:formCfg.mealP1,p2:formCfg.mealP2}];delete formCfg.mealName;delete formCfg.mealP1;delete formCfg.mealP2;}
if(!formCfg.channels)formCfg.channels=['문자','이메일','우편물','사이트'];
if(!formCfg.meals)formCfg.meals=[{name:'오디돈가스',p1:8000,p2:10000}];
if(formCfg.freeRatio&&!formCfg.freeRatioChild){formCfg.freeRatioChild=formCfg.freeRatio;formCfg.freeRatioElem=formCfg.freeRatio;delete formCfg.freeRatio;}
if(!formCfg.freeRatioChild){formCfg.freeRatioChild=10;formCfg.freeRatioElem=10;}
function saveFormCfgLS(){try{localStorage.setItem(FP+'formcfg',JSON.stringify(formCfg));}catch(e){}}

function initBk(){
  const ts=TS.map(t=>t.s);ts.push('17:00');
  document.getElementById('b_ar').innerHTML=ts.slice(0,-1).map(t=>`<option value="${t}">${t}</option>`).join('');
  document.getElementById('b_dp').innerHTML=ts.slice(1).map(t=>`<option value="${t}">${t}</option>`).join('');
  document.getElementById('b_ar').value='10:00';document.getElementById('b_dp').value='14:00';
  if(uph)document.getElementById('b_ph').value=uph;
  const d=new Date();d.setDate(d.getDate()+7);document.getElementById('b_dt').value=d.toISOString().split('T')[0];
  // Render dynamic sections
  renderBkSections();
}

function renderBkSections(){
  const fc=formCfg;
  // Meal section - multiple menus
  document.getElementById('mealSection').innerHTML=fc.meals.map(m=>
    `<p style="font-size:11px;color:#999;margin-bottom:4px;">${m.name}: 유아${fmtWon(m.p1)}원 / 초등이상 ${fmtWon(m.p2)}원</p>`
  ).join('')+`
    <div class="rgrp" style="margin-top:8px;">
      <label><input type="radio" name="ml" value="이용안함" checked> 이용안함</label>
      ${fc.meals.map(m=>{
        const mi=window.courseInfo?.['meal_'+m.name]||{};
        const mLinks=(mi.video?` <span onclick="event.preventDefault();showMediaPreview('${m.name}','${mi.video.replace(/'/g,"\\\\'")}','${(mi.blog||'').replace(/'/g,"\\\\'")}')" style="font-size:9px;color:#1976d2;cursor:pointer;">▶영상</span>`:'')+(mi.blog?` <span onclick="event.preventDefault();showMediaPreview('${m.name}','${(mi.video||'').replace(/'/g,"\\\\'")}','${mi.blog.replace(/'/g,"\\\\'")}')" style="font-size:9px;color:#e65100;cursor:pointer;">📖후기</span>`:'');
        return `<label><input type="radio" name="ml" value="${m.name}"> ${m.name}${mLinks}</label>`;
      }).join('')}
    </div>`;
  // Package section
  document.getElementById('pkgSection').innerHTML=`
    <p style="font-size:11px;color:#999;margin-bottom:8px;">${fc.pkgDesc} (유아${fmtWon(fc.entryP1)}/초등${fmtWon(fc.entryP2)}원)</p>
    <p style="font-size:10px;color:#aaa;margin-bottom:8px;">※인솔자 입장료 별도 ${fmtWon(fc.entryTea)}원 / 유아${fc.freeRatioChild}인당·초등${fc.freeRatioElem}인당 인솔1명 무료</p>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;">
      ${cs.map(c=>{
        const ci=window.courseInfo?.[c]||{};
        return `<div style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:#f0f8e8;border:1px solid #c8e6c9;border-radius:8px;font-size:11px;font-weight:600;color:#2e7d32;">
          🏕️ ${c}${ci.video?` <span onclick="showMediaPreview('${c}','${ci.video.replace(/'/g,"\\\\'")}','${(ci.blog||'').replace(/'/g,"\\\\'")}')" style="color:#1976d2;cursor:pointer;font-size:9px;font-weight:400;">▶영상</span>`:''}${ci.blog?` <span onclick="showMediaPreview('${c}','${(ci.video||'').replace(/'/g,"\\\\'")}','${ci.blog.replace(/'/g,"\\\\'")}')" style="color:#e65100;cursor:pointer;font-size:9px;font-weight:400;">📖후기</span>`:''}
        </div>`;
      }).join('')}
    </div>`;
  // Addon section
  if(!window.courseInfo)window.courseInfo=JSON.parse(localStorage.getItem(FP+'courseInfo')||'{}');
  document.getElementById('addonSection').innerHTML=`
    <label><input type="checkbox" value="없음" class="adc" checked onchange="adcN(this)"> 없음</label>
    ${fc.addons.map(a=>{
      const info=window.courseInfo['addon_'+a.name]||{};
      const vBtn=info.video?` <span onclick="event.preventDefault();showMediaPreview('${a.name}','${info.video.replace(/'/g,"\\\\'")}','${(info.blog||'').replace(/'/g,"\\\\'")}')" style="font-size:9px;color:#1976d2;cursor:pointer;">▶영상</span>`:'';
      const bBtn=info.blog?` <span onclick="event.preventDefault();showMediaPreview('${a.name}','${(info.video||'').replace(/'/g,"\\\\'")}','${info.blog.replace(/'/g,"\\\\'")}')" style="font-size:9px;color:#e65100;cursor:pointer;">📖후기</span>`:'';
      return `<label><input type="checkbox" value="${a.name}(+${a.price>=10000?(a.price/10000)+'만':(a.price/1000)+'천'})" class="adc"> ${a.name}(+${a.price>=10000?(a.price/10000)+'만':(a.price/1000)+'천'})${vBtn}${bBtn}</label>`;
    }).join('')}`;
  // Channel section
  const chEl=document.getElementById('channelSection');
  if(chEl)chEl.innerHTML=fc.channels.map((c,i)=>`<label><input type="radio" name="ch" value="${c}" ${i===fc.channels.length-1?'checked':''}> ${c}</label>`).join('');
}
function adcN(el){if(el.checked)document.querySelectorAll('.adc').forEach(c=>{if(c!==el)c.checked=false;});}

function showMediaPreview(name,videoUrl,blogUrl){
  const old=document.getElementById('mediaPreviewModal');if(old)old.remove();
  
  // Extract YouTube video ID for thumbnail
  let ytId='';
  if(videoUrl){
    const ytMatch=videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/|youtube\.com\/embed\/)([^&\s?\/]+)/);
    if(ytMatch)ytId=ytMatch[1];
  }
  
  const modal=document.createElement('div');
  modal.id='mediaPreviewModal';
  modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px;';
  modal.onclick=function(e){if(e.target===modal)modal.remove();};
  
  let content=`
    <div style="background:#fff;border-radius:16px;max-width:400px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.3);">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--p);border-radius:16px 16px 0 0;">
        <span style="font-size:15px;font-weight:800;color:#fff;">🏕️ ${name}</span>
        <button onclick="document.getElementById('mediaPreviewModal').remove()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0;">✕</button>
      </div>`;
  
  if(videoUrl){
    if(ytId){
      content+=`
      <div style="padding:14px;">
        <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">🎬 시연 영상</div>
        <div style="position:relative;border-radius:12px;overflow:hidden;cursor:pointer;background:#000;" onclick="window.open('${videoUrl}','_blank')">
          <img src="https://img.youtube.com/vi/${ytId}/hqdefault.jpg" style="width:100%;display:block;border-radius:12px;" onerror="this.style.display='none'">
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:60px;background:rgba(255,0,0,.85);border-radius:50%;display:flex;align-items:center;justify-content:center;">
            <div style="width:0;height:0;border-left:22px solid #fff;border-top:13px solid transparent;border-bottom:13px solid transparent;margin-left:4px;"></div>
          </div>
        </div>
        <div style="margin-top:8px;text-align:center;">
          <span onclick="window.open('${videoUrl}','_blank')" style="display:inline-block;padding:8px 24px;background:linear-gradient(135deg,#f44336,#d32f2f);color:#fff;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">▶ YouTube에서 보기</span>
        </div>
      </div>`;
    } else {
      content+=`
      <div style="padding:14px;">
        <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">🎬 시연 영상</div>
        <div style="text-align:center;padding:20px;background:#f5f5f5;border-radius:12px;">
          <div style="font-size:36px;margin-bottom:8px;">🎬</div>
          <span onclick="window.open('${videoUrl}','_blank')" style="display:inline-block;padding:8px 24px;background:#1976d2;color:#fff;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">▶ 영상 보기</span>
        </div>
      </div>`;
    }
  }
  
  if(blogUrl){
    content+=`
      <div style="padding:14px;${videoUrl?'border-top:1px solid #eee;':''}">
        <div style="font-size:12px;font-weight:700;color:#333;margin-bottom:8px;">📖 블로그 후기</div>
        <div onclick="window.open('${blogUrl}','_blank')" style="cursor:pointer;border:1.5px solid #e0e0e0;border-radius:12px;padding:16px;background:#fafafa;transition:background .15s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='#fafafa'">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:48px;height:48px;border-radius:10px;background:#e8f5e9;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">📖</div>
            <div>
              <div style="font-size:13px;font-weight:700;color:#333;">${name} 후기 보기</div>
              <div style="font-size:10px;color:#999;margin-top:2px;word-break:break-all;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${blogUrl}</div>
            </div>
          </div>
          <div style="margin-top:10px;text-align:center;">
            <span style="padding:8px 24px;background:linear-gradient(135deg,#e65100,#f57c00);color:#fff;border-radius:8px;font-size:12px;font-weight:700;display:inline-block;">📖 블로그 열기</span>
          </div>
        </div>
      </div>`;
  }
  
  content+=`</div>`;
  modal.innerHTML=content;
  document.body.appendChild(modal);
}

function submitBk(){
  if(!document.getElementById('ck1').checked){toast('개인정보 동의 필요','e');return;}
  const dt=document.getElementById('b_dt').value,nm=document.getElementById('b_nm').value.trim();
  const ar=document.getElementById('b_ar').value,dp=document.getElementById('b_dp').value;
  const st1=parseInt(document.getElementById('b_st1').value)||0;
  const st2=parseInt(document.getElementById('b_st2').value)||0;
  const st=st1+st2;
  const tc=parseInt(document.getElementById('b_tc').value)||0;
  const ag=document.querySelector('input[name="ag"]:checked')?.value||'유아';
  const ph=document.getElementById('b_ph').value.trim();
  if(!dt||!nm||!ar||!dp||!st||!ph){toast('필수 항목을 모두 입력하세요','e');return;}
  if(ti(dp)<=ti(ar)){toast('퇴장>입장 시간이어야 합니다','e');return;}
  const ml=document.querySelector('input[name="ml"]:checked')?.value||'';
  const hasMeal=ml!=='이용안함'&&ml!=='';
  const ct=hasMeal?'기본코스+단체식':'기본코스';
  const ad=[...document.querySelectorAll('.adc:checked')].map(c=>c.value).filter(v=>v!=='없음');
  const ch=document.querySelector('input[name="ch"]:checked')?.value||'';

  const cat=document.getElementById('b_cat').value;
  const bk={id:nid++,date:dt,name:nm,category:cat,arrival:ar,departure:dp,students:st,studentsChild:st1,studentsElem:st2,ageGroup:ag,teachers:tc,courseType:ct,meal:ml,phone:ph,email:document.getElementById('b_em').value,addons:ad,etc:document.getElementById('b_etc').value,status:'대기',channel:ch,visitDate:document.getElementById('b_vd').value||'',created:td()};
  pushUndo('입력',`${nm} ${dt} 예약 접수`,JSON.stringify(bks));
  bks.push(bk);sv();
  sendK('admin',admMsg(bk));sendK('customer',custMsg(bk,'접수'),ph);
  toast(`✅ "${nm}" 예약 접수!`,'s');toast('💬 관리자에게 카톡 전송','k');
  document.getElementById('b_nm').value='';document.getElementById('b_st1').value='0';document.getElementById('b_st2').value='0';document.getElementById('b_etc').value='';uph=ph;
  // Schedule reminders
  scheduleReminder(bk);
  // Generate quote and send email
  if(bk.email){
    genQuote(bk);
    toast('📧 견적서가 이메일로 전송됩니다','i');
  }
}

// ===== QUOTE / ESTIMATE GENERATOR =====
function getPrices(){
  const fc=formCfg;
  return {
    entryChild:fc.entryP1,entryElem:fc.entryP2,entryTeacher:fc.entryTea,
    freeRatioChild:fc.freeRatioChild,freeRatioElem:fc.freeRatioElem,
    addonMap:Object.fromEntries(fc.addons.map(a=>[a.name,a.price]))
  };
}

function calcQuote(bk){
  const P=getPrices();
  const items=[];
  const sC=bk.studentsChild||0, sE=bk.studentsElem||0;
  const stu=bk.students||sC+sE, tea=bk.teachers;
  // Determine child/elem split - if old data without split, use ageGroup
  let childN=sC,elemN=sE;
  if(!childN&&!elemN){
    if(bk.ageGroup==='초등'){elemN=stu;}
    else if(bk.ageGroup==='혼합'){childN=Math.ceil(stu/2);elemN=stu-childN;}
    else{childN=stu;}
  }

  // Entry fees by age group - use actualEntryPrices if present
  const ePC=bk.actualEntryPrices?.child!=null?bk.actualEntryPrices.child:P.entryChild;
  const ePE=bk.actualEntryPrices?.elem!=null?bk.actualEntryPrices.elem:P.entryElem;
  const ePT=bk.actualEntryPrices?.teacher!=null?bk.actualEntryPrices.teacher:P.entryTeacher;
  if(childN>0)items.push({cat:'체험료',name:'기본입장-유아',qty:childN,unit:ePC,total:childN*ePC});
  if(elemN>0)items.push({cat:'체험료',name:'기본입장-초등',qty:elemN,unit:ePE,total:elemN*ePE});

  // Free teacher calculation per age group
  const freeFromChild=P.freeRatioChild>0?Math.floor(childN/P.freeRatioChild):0;
  const freeFromElem=P.freeRatioElem>0?Math.floor(elemN/P.freeRatioElem):0;
  const freeTea=freeFromChild+freeFromElem;
  const paidTea=Math.max(0,tea-freeTea);
  if(paidTea>0)items.push({cat:'체험료',name:`인솔자 입장료 (${freeTea}명 무료, ${paidTea}명 유료)`,qty:paidTea,unit:ePT,total:paidTea*ePT});

  // Addons - use actualAddonQty if present, otherwise apply to total students
  if(bk.actualAddonQty&&bk.actualAddonQty.length){
    bk.actualAddonQty.forEach(aq=>{
      const defPrice=P.addonMap[aq.name]||0;
      const price=aq.price!=null?aq.price:defPrice;
      if(aq.qty>0)items.push({cat:'체험료',name:aq.name+' 체험',qty:aq.qty,unit:price,total:aq.qty*price});
    });
  } else if(bk.addons&&bk.addons.length){
    bk.addons.forEach(a=>{
      for(const [aName,aPrice] of Object.entries(P.addonMap)){
        if(a.includes(aName)){items.push({cat:'체험료',name:aName+' 체험',qty:stu,unit:aPrice,total:stu*aPrice});break;}
      }
    });
  }

  // Meal - use actualMealQty if present
  if(bk.actualMealQty&&bk.meal&&bk.meal!=='이용안함'){
    const mealMenu=formCfg.meals.find(m=>m.name===bk.meal)||formCfg.meals[0];
    if(mealMenu){
      const mq=bk.actualMealQty;
      const p1=mq.priceChild!=null?mq.priceChild:mealMenu.p1;
      const p2=mq.priceElem!=null?mq.priceElem:mealMenu.p2;
      if(mq.child>0)items.push({cat:'급식',name:`단체식-유아(${mealMenu.name})`,qty:mq.child,unit:p1,total:mq.child*p1});
      if(mq.elem>0)items.push({cat:'급식',name:`단체식-초등(${mealMenu.name})`,qty:mq.elem,unit:p2,total:mq.elem*p2});
      if(mq.teacher>0)items.push({cat:'급식',name:`단체식-인솔(${mealMenu.name})`,qty:mq.teacher,unit:p2,total:mq.teacher*p2});
    }
  } else if(bk.meal&&bk.meal!=='이용안함'){
    const mealMenu=formCfg.meals.find(m=>m.name===bk.meal)||formCfg.meals[0];
    if(mealMenu){
      if(childN>0)items.push({cat:'급식',name:`단체식-유아(${mealMenu.name})`,qty:childN,unit:mealMenu.p1,total:childN*mealMenu.p1});
      if(elemN>0)items.push({cat:'급식',name:`단체식-초등(${mealMenu.name})`,qty:elemN,unit:mealMenu.p2,total:elemN*mealMenu.p2});
      if(tea>0)items.push({cat:'급식',name:`단체식-인솔(${mealMenu.name})`,qty:tea,unit:mealMenu.p2,total:tea*mealMenu.p2});
    }
  }

  const grandTotal=items.reduce((s,i)=>s+i.total,0);
  return {items,grandTotal};
}

function numKor(n){
  if(n===0)return '영';
  const units=['','만','억'];const digits=['','일','이','삼','사','오','육','칠','팔','구'];
  const tens=['','십','백','천'];let result='';let idx=0;
  while(n>0){const chunk=n%10000;n=Math.floor(n/10000);
    if(chunk>0){let cs='';let c=chunk;for(let i=0;i<4&&c>0;i++){const d=c%10;c=Math.floor(c/10);if(d>0)cs=(d===1&&i>0?'':digits[d])+tens[i]+cs;}
    result=cs+units[idx]+result;}idx++;}
  return result;
}

function fmtWon(n){return n.toLocaleString('ko-KR');}
function actualTip(b){
  if(b.actualStudents==null)return '실제 미입력';
  const parts=[`유아 ${b.actualStudentsChild||0}`,`초등 ${b.actualStudentsElem||0}`,`인솔 ${b.actualTeachers!=null?b.actualTeachers:b.teachers}`];
  let tip='실제: '+parts.join(' / ')+` = ${(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers)}명`;
  if(b.actualAddons?.length)tip+='\n체험: '+b.actualAddons.join(', ');
  if(b.actualMeal)tip+='\n단체식: '+b.actualMeal;
  return tip;
}
function actualPopup(b){
  if(b.actualStudents==null)return `<div style="padding:10px;font-size:11px;color:#888;text-align:center;">실제 미입력</div>`;
  const P=getPrices();
  const aC=b.actualStudentsChild||0,aE=b.actualStudentsElem||0,aT=b.actualTeachers!=null?b.actualTeachers:b.teachers;
  const epC=b.actualEntryPrices?.child!=null?b.actualEntryPrices.child:P.entryChild;
  const epE=b.actualEntryPrices?.elem!=null?b.actualEntryPrices.elem:P.entryElem;
  const epT=b.actualEntryPrices?.teacher!=null?b.actualEntryPrices.teacher:P.entryTeacher;
  let rows=[];
  if(aC>0)rows.push(['기본입장-유아',aC,epC]);
  if(aE>0)rows.push(['기본입장-초등',aE,epE]);
  const frC=P.freeRatioChild>0?Math.floor(aC/P.freeRatioChild):0;
  const frE=P.freeRatioElem>0?Math.floor(aE/P.freeRatioElem):0;
  const paidT=Math.max(0,aT-frC-frE);
  if(paidT>0)rows.push([`인솔(${frC+frE}명무료,${paidT}유료)`,paidT,epT]);
  if(b.actualAddonQty?.length){b.actualAddonQty.forEach(aq=>{if(aq.qty>0){const dp=P.addonMap[aq.name]||0;rows.push([aq.name,aq.qty,aq.price!=null?aq.price:dp]);}});}
  if(b.actualMeal&&b.actualMealQty){
    const mm=formCfg.meals.find(m=>m.name===b.actualMeal)||formCfg.meals[0];
    const mp1=b.actualMealQty.priceChild!=null?b.actualMealQty.priceChild:(mm?mm.p1:0);
    const mp2=b.actualMealQty.priceElem!=null?b.actualMealQty.priceElem:(mm?mm.p2:0);
    if(b.actualMealQty.child>0)rows.push([`식사-유아(${b.actualMeal})`,b.actualMealQty.child,mp1]);
    if(b.actualMealQty.elem>0)rows.push([`식사-초등(${b.actualMeal})`,b.actualMealQty.elem,mp2]);
    if(b.actualMealQty.teacher>0)rows.push([`식사-인솔(${b.actualMeal})`,b.actualMealQty.teacher,mp2]);
  }
  const total=rows.reduce((s,r)=>s+r[1]*r[2],0);
  return `<div style="padding:4px 0;">
    <div style="font-size:11px;font-weight:700;color:#c2185b;margin-bottom:6px;">👥 실제: 유아${aC}+초등${aE}+인솔${aT} = ${aC+aE+aT}명</div>
    <table style="width:100%;font-size:10px;border-collapse:collapse;">
      <tr style="background:#f5f5f5;"><th style="padding:3px 6px;text-align:left;">항목</th><th style="padding:3px 4px;text-align:center;">수량</th><th style="padding:3px 4px;text-align:right;">단가</th><th style="padding:3px 4px;text-align:right;">금액</th></tr>
      ${rows.map(r=>`<tr><td style="padding:2px 6px;border-bottom:1px solid #f0f0f0;">${r[0]}</td><td style="padding:2px 4px;text-align:center;border-bottom:1px solid #f0f0f0;">${r[1]}</td><td style="padding:2px 4px;text-align:right;border-bottom:1px solid #f0f0f0;">₩${fmtWon(r[2])}</td><td style="padding:2px 4px;text-align:right;border-bottom:1px solid #f0f0f0;">₩${fmtWon(r[1]*r[2])}</td></tr>`).join('')}
      <tr style="font-weight:700;background:#fce4ec;"><td colspan="3" style="padding:4px 6px;">합계</td><td style="padding:4px 4px;text-align:right;color:#c2185b;">₩${fmtWon(total)}</td></tr>
    </table>
  </div>`;
}
function showActTip(ev,bid){
  const b=bks.find(x=>x.id===bid);if(!b)return;
  let tip=document.getElementById('actTipBox');
  if(!tip){tip=document.createElement('div');tip.id='actTipBox';
    tip.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid #f48fb1;border-radius:10px;padding:10px;box-shadow:0 4px 20px rgba(0,0,0,.2);max-width:320px;min-width:220px;pointer-events:none;';
    document.body.appendChild(tip);}
  tip.innerHTML=actualPopup(b);
  tip.style.display='block';
  const rect=ev.target.getBoundingClientRect();
  let left=rect.left-tip.offsetWidth-8;if(left<8)left=rect.right+8;
  let top=rect.top-10;if(top+tip.offsetHeight>window.innerHeight-10)top=window.innerHeight-tip.offsetHeight-10;
  tip.style.left=left+'px';tip.style.top=top+'px';
}
function hideActTip(){const t=document.getElementById('actTipBox');if(t)t.style.display='none';}

function showEtcTip(ev,bid){
  const b=bks.find(x=>x.id===bid);if(!b||!b.etc)return;
  let tip=document.getElementById('etcTipBox');
  if(!tip){tip=document.createElement('div');tip.id='etcTipBox';
    tip.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid #FFB300;border-radius:10px;padding:0;box-shadow:0 4px 20px rgba(0,0,0,.2);max-width:300px;min-width:200px;pointer-events:none;overflow:hidden;';
    document.body.appendChild(tip);}
  tip.innerHTML=`<div style="background:#FFF8E1;padding:8px 12px;border-bottom:1px solid #FFE082;font-weight:700;font-size:12px;color:#F57F17;">📝 ${b.name} 요청사항</div>
    <div style="padding:10px 12px;font-size:12px;color:#555;line-height:1.5;max-height:150px;overflow-y:auto;">${b.etc}</div>`;
  tip.style.display='block';
  const rect=ev.target.getBoundingClientRect();
  let left=rect.left-tip.offsetWidth-8;if(left<8)left=rect.right+8;
  let top=rect.top-10;if(top+tip.offsetHeight>window.innerHeight-10)top=window.innerHeight-tip.offsetHeight-10;
  tip.style.left=left+'px';tip.style.top=top+'px';
}
function hideEtcTip(){const t=document.getElementById('etcTipBox');if(t)t.style.display='none';}

function showEtcPopup(bid){
  const b=bks.find(x=>x.id===bid);if(!b)return;
  const mdl=document.getElementById('mdl');
  document.getElementById('mtl').textContent='📝 '+b.name+' 요청사항';
  document.getElementById('mdlBd').innerHTML=`
    <div style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:8px;font-size:12px;color:#666;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
        <div>📅 <strong>${b.date}</strong></div><div>⏰ ${b.arrival}~${b.departure}</div>
        <div>👥 ${b.students}+${b.teachers}명</div><div>🎫 ${b.courseType}</div>
        <div>🍚 ${b.meal}</div><div>📞 ${b.phone}</div>
      </div>
    </div>
    <div style="font-weight:700;font-size:13px;color:#F57F17;margin-bottom:6px;">📝 요청사항</div>
    <textarea id="etcPopupText" style="width:100%;min-height:100px;padding:10px;border:2px solid #FFB300;border-radius:8px;font-size:13px;line-height:1.6;resize:vertical;background:#FFFDE7;">${b.etc||''}</textarea>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;">
      <button class="btn bs" style="background:#FFB300;color:#fff;" onclick="saveEtcPopup(${bid})">💾 저장</button>
      <button class="btn bgy bs" onclick="cMdl()">닫기</button>
    </div>`;
  document.getElementById('mft').innerHTML='';
  mdl.style.display='flex';
}

function saveEtcPopup(bid){
  const b=bks.find(x=>x.id===bid);if(!b)return;
  const val=document.getElementById('etcPopupText').value.trim();
  b.etc=val;
  sv();
  addLog('수정',b.name+' 요청사항 수정');
  toast('💾 요청사항이 저장되었습니다','s');
  cMdl();
  if(typeof rAll==='function')rAll();
}

function showLocTip(ev,el){
  let tip=document.getElementById('locTipBox');
  if(!tip){tip=document.createElement('div');tip.id='locTipBox';
    tip.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid #37474F;border-radius:12px;padding:0;box-shadow:0 8px 32px rgba(0,0,0,.25);max-width:350px;min-width:240px;pointer-events:none;overflow:hidden;';
    document.body.appendChild(tip);}
  const raw=el.getAttribute('data-loctip')||'';
  if(!raw){tip.style.display='none';return;}
  const lines=raw.split('||');
  const header=lines[0]||'';
  const sub=lines[1]||'';
  let detailHtml='';
  for(let i=3;i<lines.length;i++){
    const ln=lines[i];
    const m=ln.match(/^• (.+?): (\d+)명\(아동(\d+)\+인솔(\d+)\)$/);
    if(m){
      detailHtml+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0;">
        <span style="font-weight:700;font-size:12px;">${m[1]}</span>
        <div style="text-align:right;">
          <span style="font-size:14px;font-weight:800;color:var(--p);">${m[2]}명</span>
          <div style="font-size:9px;color:#999;">아동 ${m[3]} + 인솔 ${m[4]}</div>
        </div>
      </div>`;
    }
  }
  tip.innerHTML=`<div style="background:#37474F;color:#fff;padding:8px 14px;font-size:12px;font-weight:700;">${header}</div>
    <div style="padding:6px 14px;background:#ECEFF1;font-size:12px;font-weight:800;color:#37474F;">${sub}</div>
    <div style="padding:8px 14px;">${detailHtml}</div>`;
  tip.style.display='block';
  const rect=el.closest('td').getBoundingClientRect();
  let left=rect.right+8;if(left+tip.offsetWidth>window.innerWidth-10)left=rect.left-tip.offsetWidth-8;
  let top=rect.top;if(top+tip.offsetHeight>window.innerHeight-10)top=window.innerHeight-tip.offsetHeight-10;
  if(top<0)top=8;
  tip.style.left=left+'px';tip.style.top=top+'px';
}
function hideLocTip(){
  const t=document.getElementById('locTipBox');if(t)t.style.display='none';
}

function genQuoteHTML(bk,quote,type){
  const today=new Date();
  const dd=today.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
  const title=type==='견적서'?'견 적 서':'거 래 내 역 서';

  let rows='';
  quote.items.forEach(item=>{
    rows+=`<tr><td style="border:1px solid #999;padding:5px 8px;text-align:center;">${item.cat}</td>
    <td style="border:1px solid #999;padding:5px 8px;">${item.name}</td>
    <td style="border:1px solid #999;padding:5px 8px;text-align:center;"></td>
    <td style="border:1px solid #999;padding:5px 8px;text-align:center;">${item.qty}</td>
    <td style="border:1px solid #999;padding:5px 8px;text-align:right;">${fmtWon(item.unit)}</td>
    <td style="border:1px solid #999;padding:5px 8px;text-align:right;">${fmtWon(item.total)}</td>
    <td style="border:1px solid #999;padding:8px;text-align:right;"></td></tr>`;
  });

  const totalKor=numKor(quote.grandTotal);

  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title>
<style>
body{font-family:'맑은 고딕',sans-serif;padding:24px 30px;max-width:800px;margin:0 auto;color:#333;}
h1{text-align:center;font-size:24px;letter-spacing:12px;border-bottom:3px double #333;padding-bottom:8px;margin-bottom:18px;}
.info-grid{display:grid;grid-template-columns:auto 1fr;gap:0;border:1px solid #999;margin-bottom:24px;}
.info-grid>div{padding:8px 14px;border:1px solid #ddd;font-size:13px;}
.info-label{background:#f5f5f5;font-weight:700;min-width:80px;}
table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:6px;}
th{background:#f5f5f5;border:1px solid #999;padding:8px;text-align:center;font-weight:700;}
.total-row td{background:#f9f9f9;font-weight:700;font-size:14px;}
.footer{margin-top:20px;display:flex;justify-content:space-between;font-size:12px;color:#666;border-top:1px solid #ccc;padding-top:8px;}
.supplier-box{position:relative;}
.stamp-img{width:130px;height:auto;opacity:0.85;position:absolute;right:-15px;top:5px;transform:rotate(-5deg);z-index:2;}
@media print{body{padding:20px;}}
</style></head><body>
<h1>${title}</h1>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
  <div>
    <p style="font-size:14px;margin-bottom:4px;">${dd}</p>
    <p style="font-size:16px;font-weight:700;margin-bottom:4px;">${bk.name} 귀하</p>
    <p style="font-size:13px;color:#666;">아래와 같이 ${type==='견적서'?'견적':'거래내역을 안내'}합니다.</p>
  </div>
  <div style="border:1px solid #999;font-size:12px;" class="supplier-box">
    <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAB0AGQDASIAAhEBAxEB/8QAGwABAAMBAQEBAAAAAAAAAAAAAAQFBgECAwf/xABDEAABAwMCAgYGBAoLAAAAAAABAgMEAAURBiESMRMVQVFhlRQiVnGR0xZCgaEHIyQyUlWxwdHSJTQ2RGJyk6OywvD/xAAaAQEAAwEBAQAAAAAAAAAAAAAAAQIFBAMG/8QALhEAAgIABQEFBwUAAAAAAAAAAAECEQMEEiFBMRMUMmHhBSJRgZHB0SNCsfDx/9oADAMBAAIRAxEAPwD9mpSlAKUpQClKUApSlAKUpQClKUApSlAcpVF1fqv2gtnlK/n06v1X7QWzylfz6AvaVRdX6r9oLZ5Sv59Or9V+0Fs8pX8+gL2lUXV+q/aC2eUr+fTq/VftBbPKV/PoC9pVF1fqv2gtnlK/n06v1X7QWzylfz6AvaVRdX6r9oLZ5Sv59Or9V+0Fs8pX8+gL2lUXV+q/aC2eUr+fTq/VftBbPKV/PoC9pVF1fqv2gtnlK/n0oC+pSlAKVymaA7SuZpQHaVylAdpXKUB2lcpmgO0pSgFKVygPjLlsQYjsqSsNstJKlqPYBVKnXFgXuJiv9FW/3VI1Xj6K3MEZHo6v2VgJerJ9thuRFSFNrZdj9AUoAw1jKh3nIxUWdmXy/axvzNwjW9gXymke9pQ/dXBrjTx/v/8Atq/hWPd1XeZ1pffaU236ROSzHXwhJQjByM/D4mrdyx6tXaYwZmxUygtRdUQPWSfzd8Us9XlYQXvuvn6F0Nb6eJI6wSMd6FD91DrjTvEB1ig55EJJFZzqHWuPWmRicb/mn/rXyhi+Rru/Z5a4rkl+KpTJ6NBCF4OOzw7aWy3dcJr3ZX8/Q06tc6cScdYpV/lSTXBrzTeR/SSBntKTivz6TI1NGvqbQZURMpQ2UpLYTn342PhU6SNRSb2xY4qITc2Ox0j6w0jCyTzzw9xG3vqNRMsnhxrfi+vobca106ogdaM79hzXE6302pXCLsxk9pyBWQmv3a7akkWezMRGDAQA8roUALXtk7g7ZOMV7mpvdgsrr1yYgreffbajksoVwknfkkUs8+6wpb7vi/Q16tZacQeFV6hpI7C4BSqZuHICB1nboPTdn4tJ9X4e+lWsnukeGW30vh/q29+Tyf5KfS+H+rb35PJ/kq/pQzjG6i1LEl6cuEdMG7ILjChxPWx9tA96lJAFY+fdr5JkNsQrJ6SxFbbbHDDL6tk81FNfpOq8fRa5ZSFj0dWQaxsSxyri667p69qiudG2mQ2CUlB4eW3OqtWaeUcVhtuuvPQqZlzVedOxokqIWZLEzhWGY5Qgbf8ALn6vParqyayVaNMxkPxpMx5T62msgjIB7zUg6MlwLTDjpV6VIVPS/IdG2321UW95bMWxlpAW6LhI4UfpK3wPjSmdv6ONDSt1f2ZcyPwjLaUWFWd9Ly0ngAOST7qz1hujVtcuEyUiYu6KYWppZbKwM9pxkgeJ2Aq1nStTSpcW5vWNLT8EKWlPNJyN+I5/ZUWbc1Xp3rBTbbfSWxwLA+qoA5+ylMnDwoaWoxq1vTspzZrUbAubK63XcHE9Ih70J3oSo8h0mOEj/FmvdweecuDNwacksyG4jeFltQyQBkk9gI+sdqvJM2wu2i0wbi/KCobKSpLKAUnI5HNfK+y7JcLXcJdveeQ61EQyGFpAASCOXfUNEwnNeNN9eNkQ/TZ3X06bbEzWXZKgpwsQ3Frxgc0gEpGe+pkq9v3mwtQ7i3IMiPLSVuGOrhKezJxgK7k8zUeTIdZ6/W0tXF0bKVcJwQk8OcVYXGLbYWkIIgOl9Ls5lTp4sEqzyPdUrqUxElpdLivpyeo9yjxmQwlE6Qhv1UqMdxRA7jtsc52O4pUiBNkI9KSoJP5S5jYDbNKtsWca4N/SlKHzxTarBOlrkAcfk6qx1hv8TTz1xclBxbiwjgSkbq27K2Wq8fRa5Z2/J1b1WWJuy3rZUBKpUNDaFqcR+d6owfGoNHLyjHAlrVpvgi23Xyn5zLE+3GM1IUA06lRI3OBnI/ZVHZkt8VhSV5ULo6R4+sa1Ny1BY+GUiXG6Q255CQktg+vjIKfdiqw37SsOFAnC3KRh9xTICN2159Y/Gh74bST7PDav8P8AJbXzV1mt7MqK5J4pKUFBaSk8yOWeVYxMVMWGylzDSl2x1asjOAQavHr1oqbLEt6GVPKPEVKa5nx3qU7qDS1xdcW4wpxaI6k5U1jKMbpH2U5LYOrAjUYS36lBpZ6zR5cnrdbawWW+jLreezsqPflW9Uy8Lt3RqZXESAEJ2zkZqXJuuipKg6uBIBQkNgoUUjA2A2NTnX9FW+GlkR3VouCEqWBxKUlOe0525chUHRKTUtemVtdOD6x3dLW6VKM6eC9LYbQ+ytJUlI4RtsPAe6qmcNMR4yItnlLdW7MacWkk+qAezIxUu9zNHM3d9Mi3yHHkYC1NkgHYePdivVqd0UC5c2oz6DBCXD0hKuZwMDO5zS9znSqOtqW/0PrEMR16aSkLIluAkDxpX3hS9Oy23JEJpQQ64pa+LOeM86VY909vCzcUrmff8KZ9/wAKHzxU6oTx6YuIPawqsZarzPhTZjkCCHkr4ePYnhwNuQrZap/svctj/V1b4z2Vl49l1BGUl+1Smm2ZKELVlYBPq8sGoNXJuHZSU63fJQy5Lr6ZsxTAbdcnNqW0QdjwnYj/ANzqxut1jy4lluSLZlpp1YcjISMZHMcqlu6dujLCHJCfSpL89txfRkKwACCo/GosO43CLYYsK1FKJEqc8kKcSDyPLeoNByjOuzVtP48Vv/BIb1Ta1JClaXCEHkopT/CvNnlx7pq+Oti1pishpYUjhBB2O5qI7d9Vx5zURyXDUp4ngKQgp27z2VZ2+66lTNehyvRi87HUuNhKQni7DxDsqUyk8Nwg3FLdP9ze3xPLdxjsx7xFulqitvRG1LSUMgZzyHifGs/GdesUqE45GZkFMRKnQ6MgBSj9+O2pkuxaruEh16RECzICOlUlQwoJ5cqgX0XFbshFwZQiQ3HQjgQdkpB2z9lQz1wYR3UWna3V+RoNTTRdbgu0Wy2ocdKELddDYK+8DPZjvqFKmoVYXIj0BpmRFktJdS2nBcHiOyrLTi3WL7fn2WFPOttjhbH1iEp28KgG2Xl+JJursJ30iXMaPQhOVBIVucdgFScycILQ+ip9eWaG3SLfKhNrEREYpHCpofVI+ylRrMgluWpWcqluZHAdsHGPupV0ikkk6TZa/Qqyd1w80lfMp9CrJ3XDzSV8ylKqYhXX/Stqg2KbKYE0OtMqWgruMhYyO9KlkH3EVknmCiRhMiRwhCVAdKdsjkPClKhm57LSadngdKy9EWmTIPG8Eqy8rkezY5qTZ4EZ9u0qcQsl+c42v8avHDk8hnb3jelKI0sZKO6/uzNG7oSzIbWQH9gduIY5e6sXGbS4nhUV4RHeUMLUN05x28vAbUpRnjlpylhy1O/8NejT1tTpFNyKJZfTDDm1wkJTnh/RS4APcMVlEMoe05OmOFxb7S2uBa3FKOCNwSTk/bmlKMz8n4pvz+593IrTMm6htUhHQuNdGpEl1Kk54c7hWTz7c1HclSHJ0VtcmSW3FpC0iU6niGcc0qB++lKHcoxcJNrj7I2NlSmIxJjsghtEpwJClFRxnvJyftpSlWOOa3P/2Q==" class="stamp-img" alt="직인">
    <div class="info-grid">
      <div class="info-label">공급자</div><div colspan="3" style="grid-column:span 3;">한국잠사플레이팜㈜</div>
      <div class="info-label">등록번호</div><div>890-86-02292</div>
      <div class="info-label">성 명</div><div>이경연</div>
      <div class="info-label">사업장</div><div style="grid-column:span 3;">충청북도 청주시 흥덕구 강내면 학천리 175</div>
      <div class="info-label">업 태</div><div>사업시설관리</div>
      <div class="info-label">종 목</div><div>전시,컨벤션 및 행사 대행</div>
    </div>
  </div>
</div>

<div style="background:#f0f0f0;padding:8px 14px;border:1px solid #999;margin-bottom:10px;font-size:13px;">
  <strong>합 계</strong>&nbsp;&nbsp;&nbsp;&nbsp;일금 <strong>${totalKor}원정</strong>&nbsp;&nbsp;&nbsp;&nbsp;
  <strong style="font-size:16px;">(₩${fmtWon(quote.grandTotal)})</strong>
</div>

<div style="font-size:11px;color:#888;margin-bottom:6px;">방문일: ${bk.date} | 시간: ${bk.arrival}~${bk.departure} | ${bk._useActual?`예약인원: 아동 ${bk.students}명 + 인솔 ${bk.teachers}명 → <strong style="color:#c2185b;">실제인원: 아동 ${bk.actualStudents}명 + 인솔 ${bk.actualTeachers!=null?bk.actualTeachers:bk.teachers}명</strong>`:`인원: 아동 ${bk.students}명 + 인솔 ${bk.teachers}명`}</div>

<table>
<thead><tr><th>품목</th><th>품 목</th><th>규격</th><th>수량</th><th>단 가</th><th>공급가액</th><th>부가세</th></tr></thead>
<tbody>${rows}
<tr class="total-row"><td colspan="5" style="border:1px solid #999;padding:10px;text-align:center;font-size:15px;">계</td><td style="border:1px solid #999;padding:10px;text-align:right;font-size:15px;">${fmtWon(quote.grandTotal)}</td><td style="border:1px solid #999;padding:10px;"></td></tr>
</tbody></table>

<div style="border:1px solid #999;padding:10px;text-align:center;background:#fafafa;font-size:12px;color:#888;">비 고</div>

<div class="footer">
  <div>043-235-1267</div>
  <div>담당자</div>
  <div>변재선</div>
</div>

</body></html>`;
}

function genQuote(bk){
  // On submit: open preview for customer to see and download
  previewQuote(bk.id,'견적서');
}

function dlQuote(id,type){
  previewQuote(id,type);
}

// ===== QUOTE PREVIEW & EDIT =====
let curQBk=null,curQType='',curQItems=[];

function previewQuote(id,type){
  const bk=bks.find(b=>b.id===id);if(!bk)return;
  curQBk=bk;curQType=type;
  const useActual=type==='거래내역서(실제인원)';
  const displayType=useActual?'거래내역서':type;
  curQType=displayType;

  if(useActual&&bk.actualStudents!=null){
    const tmp={...bk,
      students:bk.actualStudents,
      studentsChild:bk.actualStudentsChild||0,
      studentsElem:bk.actualStudentsElem||0,
      teachers:bk.actualTeachers!=null?bk.actualTeachers:bk.teachers,
      addons:bk.actualAddons!=null?bk.actualAddons.map(a=>a):[],
      actualAddonQty:bk.actualAddonQty||[],
      meal:bk.actualMeal!=null?bk.actualMeal:'',
      actualMealQty:bk.actualMealQty||null
    };
    if(bk.customQuoteActual){curQItems=JSON.parse(JSON.stringify(bk.customQuoteActual));}
    else{const q=calcQuote(tmp);curQItems=q.items.map(i=>({...i}));}
    curQBk._useActual=true;
  } else {
    if(bk.customQuote){curQItems=JSON.parse(JSON.stringify(bk.customQuote));}
    else{const q=calcQuote(bk);curQItems=q.items.map(i=>({...i}));}
    curQBk._useActual=false;
  }
  renderQPreview();
  document.getElementById('qMdl').classList.add('show');
}

function renderQPreview(){
  const total=curQItems.reduce((s,i)=>s+i.total,0);
  const quote={items:curQItems,grandTotal:total};
  const html=genQuoteHTML(curQBk,quote,curQType);
  document.getElementById('qMdlTitle').textContent=`${curQType} — ${curQBk.name} (${curQBk.date})`;
  document.getElementById('qMdlBody').innerHTML=`<iframe id="qFrame" srcdoc="${html.replace(/"/g,'&quot;')}" style="width:100%;height:100%;border:none;transform-origin:top left;" onload="scaleQFrame()"></iframe>`;
  // Show edit bar for admin
  if(mode==='admin'){
    document.getElementById('qEditBar').style.display='block';
    renderQEditItems();
  } else {
    document.getElementById('qEditBar').style.display='none';
  }
}

function renderQEditItems(){
  const el=document.getElementById('qEditItems');
  el.innerHTML=curQItems.map((item,i)=>`
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap;">
      <select onchange="curQItems[${i}].cat=this.value" style="width:60px;padding:4px;font-size:11px;border:1px solid #ddd;border-radius:5px;">
        <option ${item.cat==='체험료'?'selected':''}>체험료</option><option ${item.cat==='급식'?'selected':''}>급식</option><option ${item.cat==='기타'?'selected':''}>기타</option>
      </select>
      <input value="${item.name}" onchange="curQItems[${i}].name=this.value" placeholder="품목명" style="flex:1;min-width:140px;padding:4px 8px;font-size:11px;border:1px solid #ddd;border-radius:5px;">
      <input type="number" value="${item.qty}" onchange="curQItems[${i}].qty=+this.value;curQItems[${i}].total=curQItems[${i}].qty*curQItems[${i}].unit;renderQEditItems();" placeholder="수량" style="width:55px;padding:4px;font-size:11px;border:1px solid #ddd;border-radius:5px;text-align:center;">
      <input type="number" value="${item.unit}" onchange="curQItems[${i}].unit=+this.value;curQItems[${i}].total=curQItems[${i}].qty*curQItems[${i}].unit;renderQEditItems();" placeholder="단가" style="width:80px;padding:4px;font-size:11px;border:1px solid #ddd;border-radius:5px;text-align:right;">
      <span style="font-size:11px;font-weight:700;min-width:75px;text-align:right;">₩${fmtWon(item.total)}</span>
      <button onclick="curQItems.splice(${i},1);renderQEditItems();" style="background:#fdd;color:#c00;border:none;border-radius:5px;padding:4px 8px;font-size:11px;cursor:pointer;">✕</button>
    </div>
  `).join('')+`<div style="text-align:right;font-size:13px;font-weight:900;color:var(--p);margin-top:6px;">합계: ₩${fmtWon(curQItems.reduce((s,i)=>s+i.total,0))}</div>
  ${curQType==='거래내역서'?`<div style="margin-top:10px;padding:10px;background:#e3f2fd;border-radius:8px;display:flex;gap:8px;align-items:center;">
    <span style="font-size:12px;font-weight:700;color:#1565C0;">💳 실제 결제액:</span>
    <input type="number" id="qPaidInput" value="${curQBk.paidAmount!=null?curQBk.paidAmount:''}" placeholder="미입력" style="flex:1;padding:6px 10px;font-size:13px;font-weight:700;border:2px solid #90caf9;border-radius:6px;">
    <button class="btn bb bs" onclick="curQBk.paidAmount=parseInt(document.getElementById('qPaidInput').value)||0;sv();toast('💳 실결제액 저장','s');">저장</button>
  </div>`:''}`;
}

function addQItem(){
  curQItems.push({cat:'기타',name:'',qty:1,unit:0,total:0});
  renderQEditItems();
}

function applyQEdit(){
  if(curQBk._useActual){
    curQBk.customQuoteActual=JSON.parse(JSON.stringify(curQItems));
  } else {
    curQBk.customQuote=JSON.parse(JSON.stringify(curQItems));
  }
  sv();
  renderQPreview();
  toast('✅ 견적서가 수정되었습니다','s');
}

function dlCurQuote(){
  const total=curQItems.reduce((s,i)=>s+i.total,0);
  const html=genQuoteHTML(curQBk,{items:curQItems,grandTotal:total},curQType);
  // Open in new window optimized for print-to-PDF
  const printHtml=html.replace('</style>',`
    @page{size:A4;margin:15mm;}
    body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    .no-print{display:none !important;}
  </style>`).replace('</body>',`
    <div class="no-print" style="position:fixed;top:10px;right:10px;z-index:9999;display:flex;gap:8px;">
      <button onclick="window.print()" style="padding:10px 24px;background:#1a472a;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 3px 12px rgba(0,0,0,.2);">📥 PDF 저장 (인쇄)</button>
      <button onclick="window.close()" style="padding:10px 18px;background:#eee;border:none;border-radius:8px;font-size:14px;cursor:pointer;">닫기</button>
    </div>
  </body>`);
  const w=window.open('','_blank');
  if(w){w.document.write(printHtml);w.document.close();}
  else{
    // Fallback: download as HTML
    dl(html,`${curQType}_${curQBk.name}_${curQBk.date}.html`);
  }
  toast(`📥 새 창에서 "인쇄 > PDF로 저장"을 선택하세요`,'i');
}

function emailCurQuote(){
  if(!curQBk)return;
  const bk=curQBk;
  if(!bk.email){toast('이메일이 등록되지 않았습니다','e');return;}
  const total=curQItems.reduce((s,i)=>s+i.total,0);
  const subject=encodeURIComponent(`[잠사박물관] ${bk.name} ${curQType} (${bk.date})`);
  const body=encodeURIComponent(
`안녕하세요, ${bk.name} 담당자님.

한국잠사박물관 플레이팜 ${curQType}을 안내드립니다.

━━━━━━━━━━━━━━━━━━━
📅 방문일: ${bk.date}
⏰ 시간: ${bk.arrival} ~ ${bk.departure}
👥 인원: 아동 ${bk.students}명 + 인솔 ${bk.teachers}명
━━━━━━━━━━━━━━━━━━━
💰 합계: ₩${fmtWon(total)}
${curQItems.map(i=>`  - ${i.name}: ${i.qty}명 × ₩${fmtWon(i.unit)} = ₩${fmtWon(i.total)}`).join('\n')}
━━━━━━━━━━━━━━━━━━━

* 첨부된 ${curQType} 파일을 확인해주세요.
* 문의: 043-235-1267 / 010-6256-2969

감사합니다.
한국잠사박물관 플레이팜`
  );
  window.open(`mailto:${bk.email}?subject=${subject}&body=${body}`,'_blank');
  toast('📧 메일 앱이 열립니다','i');
}

function cQMdl(){document.getElementById('qMdl').classList.remove('show');}

function scaleQFrame(){
  try{
    const f=document.getElementById('qFrame');if(!f)return;
    const container=document.getElementById('qMdlBody');
    const cH=container.clientHeight;
    const cW=container.clientWidth;
    const doc=f.contentDocument||f.contentWindow.document;
    const body=doc.body;if(!body)return;
    const sH=body.scrollHeight;
    const sW=body.scrollWidth;
    if(sH>cH||sW>cW){
      const scale=Math.min(cH/sH, cW/sW, 1);
      f.style.transform=`scale(${scale})`;
      f.style.width=(cW/scale)+'px';
      f.style.height=(cH/scale)+'px';
    }
  }catch(e){}
}

function emailQuote(id){
  previewQuote(id,'견적서');
}

// ===== CUSTOMER: MY BOOKINGS =====
function rMyBk(){
  const mine=bks.filter(b=>b.phone===uph).sort((a,b)=>b.date.localeCompare(a.date));
  document.getElementById('cmSub').textContent=`${uph} 예약 ${mine.length}건`;
  if(!mine.length){document.getElementById('cmEmpty').style.display='block';document.getElementById('cmList').innerHTML='';return;}
  document.getElementById('cmEmpty').style.display='none';
  document.getElementById('cmList').innerHTML=mine.map(b=>{
    const sc=b.status==='확정'?'bdg-g':b.status==='대기'?'bdg-y':'bdg-r';
    const bc=b.status==='확정'?'var(--grn)':b.status==='대기'?'var(--org)':'var(--red)';
    const q=b.customQuote?{items:b.customQuote,grandTotal:b.customQuote.reduce((s,i)=>s+i.total,0)}:calcQuote(b);
    const canEdit=b.status!=='취소'&&b.date>=td();
    return `<div class="mbk" style="border-left-color:${bc};${b.date<td()?'opacity:.5;':''}">
      <div class="mt">${b.name} <span class="bdg ${sc}">${b.status}</span></div>
      <div class="mr"><span>📅 <strong>${b.date}</strong></span><span>⏰ ${b.arrival}~${b.departure}</span><span>👥 ${b.studentsChild?'유'+b.studentsChild:''}${b.studentsChild&&b.studentsElem?'+':''}${b.studentsElem?'초'+b.studentsElem:b.students+'명'}+인솔${b.teachers}${b.actualStudents!=null?` <span style="color:#c2185b;font-size:11px;">→실제${b.actualStudents}+${b.actualTeachers!=null?b.actualTeachers:b.teachers}</span>`:''}</span><span>🎫 ${b.courseType}</span></div>
      <div style="font-size:13px;font-weight:700;color:var(--p);margin:6px 0;">💰 예상금액: ₩${fmtWon(q.grandTotal)}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn bg bs" onclick="dlQuote(${b.id},'견적서')">📄 견적서</button>
        ${b.actualStudents!=null?`<button class="btn bb bs" onclick="dlQuote(${b.id},'거래내역서(실제인원)')">📋 거래내역서</button>`:`<span style="font-size:10px;color:#aaa;padding:6px;">거래내역서는 실제인원 확정 후 발행됩니다</span>`}
        ${b.email?`<button class="btn bk bs" onclick="emailQuote(${b.id})">📧 이메일</button>`:''}
        ${canEdit?`<button class="btn bs" style="background:#e3f2fd;color:#1565C0;" onclick="custEdit(${b.id})">✏️ 수정</button>
        <button class="btn br bs" onclick="custCancel(${b.id})">취소</button>`:''}
      </div>
    </div>`;
  }).join('');
}

// ===== CUSTOMER: EDIT & CANCEL =====
function custCancel(id){
  const bk=bks.find(b=>b.id===id);if(!bk)return;
  pushUndo('취소',`${bk.name} ${bk.date} 예약 취소`,JSON.stringify(bks));
  bk.status='취소';sv();
  sendK('admin',`❌ 예약취소\n${bk.name} (${bk.date})\n${bk.phone}`);
  toast('예약이 취소되었습니다 (↩ 하단 되돌리기 가능)','i');rMyBk();
}

function custEdit(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const ts=TS.map(t=>t.s);ts.push('17:00');
  const arOpts=ts.slice(0,-1).map(t=>`<option value="${t}" ${t===b.arrival?'selected':''}>${t}</option>`).join('');
  const dpOpts=ts.slice(1).map(t=>`<option value="${t}" ${t===b.departure?'selected':''}>${t}</option>`).join('');
  document.getElementById('mtl').textContent='✏️ 예약 수정';
  document.getElementById('mdlBd').innerHTML=`
    <div style="font-size:13px;">
      <div class="fgrid" style="gap:10px;">
        <div class="fg"><label>방문일 *</label><input type="date" id="ce_dt" value="${b.date}"></div>
        <div class="fg"><label>단체명 *</label><input type="text" id="ce_nm" value="${b.name}"></div>
        <div class="fg"><label>단체유형</label><select id="ce_cat">
          ${['어린이집','유치원','초등학교','중학교','복지기관','기타'].map(c=>`<option ${b.category===c?'selected':''}>${c}</option>`).join('')}
        </select></div>
        <div class="fg"><label>입장시간 *</label><select id="ce_ar">${arOpts}</select></div>
        <div class="fg"><label>퇴장시간 *</label><select id="ce_dp">${dpOpts}</select></div>
        <div class="fg"><label>유아 인원</label><input type="number" id="ce_st1" value="${b.studentsChild||0}"></div>
        <div class="fg"><label>초등 인원</label><input type="number" id="ce_st2" value="${b.studentsElem||0}"></div>
        <div class="fg"><label>인솔자</label><input type="number" id="ce_tc" value="${b.teachers}"></div>
        <div class="fg"><label>연락처</label><input type="tel" id="ce_ph" value="${b.phone}"></div>
        <div class="fg"><label>이메일</label><input type="email" id="ce_em" value="${b.email||''}"></div>
      </div>
      <div style="margin-top:10px;">
        <label style="font-size:12px;font-weight:600;">단체식</label>
        <div class="rgrp">
          <label><input type="radio" name="ce_ml" value="이용안함" ${!b.meal||b.meal==='이용안함'?'checked':''}> 이용안함</label>
          ${formCfg.meals.map(m=>`<label><input type="radio" name="ce_ml" value="${m.name}" ${b.meal===m.name?'checked':''}> ${m.name}</label>`).join('')}
        </div>
      </div>
      <div class="fg" style="margin-top:8px;"><label style="color:#F57F17;font-weight:700;">📝 요청사항 / 특이사항</label><textarea id="ce_etc" style="border:2px solid #FFB300;background:#FFFDE7;border-radius:8px;padding:8px;font-size:12px;line-height:1.5;">${b.etc||''}</textarea></div>
      <div class="fg" style="margin-top:8px;"><label style="color:#e65100;">📝 수정 사유</label><input type="text" id="ce_editReason" placeholder="수정 사유 입력 (선택)" style="border:1px dashed #e65100;"></div>
    </div>`;
  document.getElementById('mft').innerHTML=`
    <button class="btn bg" onclick="saveCustEdit(${b.id})">💾 저장</button>
    <button class="btn bgy" onclick="cMdl()">취소</button>`;
  document.getElementById('mdl').classList.add('show');
}

function saveCustEdit(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const dt=document.getElementById('ce_dt').value,nm=document.getElementById('ce_nm').value.trim();
  const ar=document.getElementById('ce_ar').value,dp=document.getElementById('ce_dp').value;
  const st1=parseInt(document.getElementById('ce_st1').value)||0;
  const st2=parseInt(document.getElementById('ce_st2').value)||0;
  const st=st1+st2;
  const tc=parseInt(document.getElementById('ce_tc').value)||0;
  const ph=document.getElementById('ce_ph').value.trim();
  if(!dt||!nm||!ar||!dp||!st||!ph){toast('필수 항목을 모두 입력하세요','e');return;}
  if(ti(dp)<=ti(ar)){toast('퇴장>입장 시간이어야 합니다','e');return;}
  const ml=document.querySelector('input[name="ce_ml"]:checked')?.value||'';
  const editReason=document.getElementById('ce_editReason')?.value?.trim()||null;
  pushUndo('수정',`${b.name} ${b.date} 예약 수정`,JSON.stringify(bks),editReason);
  b.date=dt;b.name=nm;b.category=document.getElementById('ce_cat').value;b.arrival=ar;b.departure=dp;b.students=st;b.studentsChild=st1;b.studentsElem=st2;b.teachers=tc;
  b.phone=ph;b.email=document.getElementById('ce_em').value;
  b.meal=ml;b.courseType=(ml&&ml!=='이용안함')?'기본코스+단체식':'기본코스';
  b.etc=document.getElementById('ce_etc').value;
  b.customQuote=null; // reset custom quote on edit
  sv();cMdl();rMyBk();
  sendK('admin',`✏️ 예약수정\n${b.name} (${b.date})\n${b.phone}`);
  toast('✅ 예약이 수정되었습니다','s');
}

// ===== ADMIN: DASHBOARD =====
let dashWeekOffset=0;
function setDashWeek(w){dashWeekOffset=w;renderDashWeek();}

function getWeekRange(offset){
  const now=new Date();
  const day=now.getDay();
  const mon=new Date(now);mon.setDate(now.getDate()-((day+6)%7)+offset*7);
  const sun=new Date(mon);sun.setDate(mon.getDate()+6);
  const dates=[];
  for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);dates.push(d.toISOString().split('T')[0]);}
  return {start:dates[0],end:dates[6],dates,monDate:mon,sunDate:sun};
}

function buildWeekSummary(weekBks){
  const wkTeams=weekBks.length;
  const wkPeople=weekBks.reduce((s,b)=>s+b.students+b.teachers,0);
  const wkEst=weekBks.reduce((s,b)=>s+getEstimate(b),0);
  const wkActEst=weekBks.reduce((s,b)=>s+getEstimate(b,true),0);
  const wkConf=weekBks.filter(b=>b.status==='확정').length;
  const wkPend=weekBks.filter(b=>b.status==='대기').length;
  const wkActCnt=weekBks.filter(b=>b.actualStudents!=null).length;
  const wkActPeople=weekBks.filter(b=>b.actualStudents!=null).reduce((s,b)=>s+(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers),0);
  const addonTotals={};
  let mealTotal={child:0,elem:0,teacher:0,name:''};
  weekBks.forEach(b=>{
    const useAct=b.actualStudents!=null;
    const addons=useAct?(b.actualAddonQty||[]):((b.addons||[]).map(a=>{
      const n=formCfg.addons.find(x=>a.includes(x.name));
      return n?{name:n.name,qty:b.students}:null;
    }).filter(Boolean));
    addons.forEach(aq=>{addonTotals[aq.name]=(addonTotals[aq.name]||0)+(aq.qty||0);});
    if(useAct&&b.actualMeal&&b.actualMealQty){
      mealTotal.child+=(b.actualMealQty.child||0);mealTotal.elem+=(b.actualMealQty.elem||0);mealTotal.teacher+=(b.actualMealQty.teacher||0);mealTotal.name=b.actualMeal;
    } else if(b.meal&&b.meal!=='이용안함'){
      mealTotal.child+=(b.studentsChild||0);mealTotal.elem+=(b.studentsElem||0);mealTotal.teacher+=b.teachers;mealTotal.name=b.meal;
    }
  });
  const addonStr=Object.keys(addonTotals).length?Object.entries(addonTotals).map(([k,v])=>`${k} ${v}명`).join(', '):'없음';
  const mealSum=mealTotal.child+mealTotal.elem+mealTotal.teacher;
  const mealStr=mealSum>0?`${mealTotal.name||'단체식'} ${mealSum}명 (유${mealTotal.child}+초${mealTotal.elem}+인솔${mealTotal.teacher})`:'없음';
  return {wkTeams,wkPeople,wkEst,wkActEst,wkConf,wkPend,wkActCnt,wkActPeople,addonStr,mealStr};
}

function renderOneWeek(offset,label){
  const wk=getWeekRange(offset);
  const t=td();
  const dayNames=['일','월','화','수','목','금','토'];
  const dayColors=['#e53935','#333','#333','#333','#333','#333','#1e88e5'];
  const fmt=d=>`${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]})`;
  const isThisWeek=offset===0;
  const weekBks=bks.filter(b=>b.date>=wk.start&&b.date<=wk.end&&b.status!=='취소').sort((a,b)=>a.date.localeCompare(b.date)||a.arrival?.localeCompare(b.arrival));

  // Group by date
  const grouped={};
  weekBks.forEach(b=>{if(!grouped[b.date])grouped[b.date]=[];grouped[b.date].push(b);});
  const wkDates=Object.keys(grouped).sort();

  let rows='';
  wkDates.forEach(date=>{
    const grp=grouped[date];
    const d=new Date(date);
    const dayName=dayNames[d.getDay()];
    const dayClr=dayColors[d.getDay()];
    const isToday=date===t;
    const dm=`${d.getMonth()+1}/${d.getDate()}`;
    const gPpl=grp.reduce((s,b)=>s+b.students+b.teachers,0);

    grp.forEach((b,bi)=>{
      const sc=b.status==='확정'?'#2e7d32':b.status==='대기'?'#e65100':'#c62828';
      const scBg=b.status==='확정'?'#E8F5E9':b.status==='대기'?'#FFF3E0':'#FFEBEE';
      const hasMeal=b.meal&&b.meal!=='이용안함';
      const hasAddon=b.addons&&b.addons.length>0;
      let tags='';
      if(b.courseType)tags+=`<span style="font-size:10px;padding:3px 7px;border-radius:5px;background:${(b.courseType||'').includes('단체식')?'#E65100':'#2e7d32'};color:#fff;font-weight:700;display:inline-block;margin:1px;">${b.courseType.replace('기본코스','기본')}</span>`;
      if(hasMeal)tags+=`<span style="font-size:10px;padding:3px 7px;border-radius:5px;background:#C2185B;color:#fff;font-weight:700;display:inline-block;margin:1px;">🍚 ${b.meal.replace('이용함','식사')}</span>`;
      if(hasAddon)b.addons.forEach(a=>tags+=`<span style="font-size:10px;padding:3px 7px;border-radius:5px;background:#7B1FA2;color:#fff;font-weight:700;display:inline-block;margin:1px;">🎨${a}</span>`);

      rows+=`<tr style="background:${isToday?'#F1F8E9':'#fff'};border-bottom:1px solid #eee;">`;

      // Date cell with rowspan
      if(bi===0){
        rows+=`<td rowspan="${grp.length}" style="padding:8px 6px;text-align:center;vertical-align:middle;border-right:2px solid ${isToday?'#2e7d32':'#ddd'};background:${isToday?'#C8E6C9':'#FAFAFA'};font-size:14px;white-space:nowrap;">
          <div style="font-size:16px;font-weight:900;color:${isToday?'#1B5E20':'#333'};">${dm}</div>
          <div style="font-size:13px;font-weight:800;color:${dayClr};">${dayName}</div>
          ${isToday?'<div style="background:#2e7d32;color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:6px;margin-top:3px;display:inline-block;">오늘</div>':''}
        </td>`;
      }

      rows+=`<td style="padding:6px 8px;font-size:14px;font-weight:700;color:#111;">${b.agency?'<span style="font-size:9px;background:#E65100;color:#fff;padding:2px 5px;border-radius:4px;font-weight:800;margin-right:3px;">🏢</span>':''}${b.name}</td>
        <td style="padding:6px;font-size:13px;white-space:nowrap;color:#222;font-weight:600;">${b.arrival}~${b.departure}</td>
        <td style="padding:6px;text-align:center;font-size:13px;">
          <strong style="color:#1B5E20;font-size:16px;">${b.students+b.teachers}</strong><span style="font-size:11px;color:#666;font-weight:700;">명</span>
          ${b.actualStudents!=null?`<div style="font-size:11px;color:#C2185B;font-weight:700;">실제${(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers)}</div>`:''}
        </td>
        <td style="padding:6px;max-width:200px;line-height:1.6;">${tags||'<span style="color:#ddd;font-size:11px;">-</span>'}</td>
        <td style="padding:6px;text-align:center;"><span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:800;background:${sc};color:#fff;">${b.status}</span></td>
        <td style="padding:5px 4px;white-space:nowrap;">
          ${b.status==='대기'?`<button class="btn bg bs" style="font-size:10px;padding:3px 7px;" onclick="setSt(${b.id},'확정')">확정</button> `:''}
          <button class="btn bgy bs" style="font-size:10px;padding:3px 7px;" onclick="showDtl(${b.id})">상세</button>
          <button class="btn bs" style="background:${b.etc?'#FFF8E1':'#f5f5f5'};color:${b.etc?'#E65100':'#ccc'};font-size:10px;padding:3px 7px;border:1px solid ${b.etc?'#FFB300':'#eee'};" onclick="showEtcPopup(${b.id})">📝요청</button>
          <button class="btn bs" onmouseenter="showActTip(event,${b.id})" onmouseleave="hideActTip()" style="background:${b.actualStudents!=null?'#C2185B':'#FCE4EC'};color:${b.actualStudents!=null?'#fff':'#C2185B'};font-size:10px;padding:3px 7px;" onclick="showDtl(${b.id});setTimeout(()=>{const el=document.getElementById('dtl_aSt1');if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},100)">실제</button>
        </td>
      </tr>`;
    });

    // Date subtotal
    rows+=`<tr style="background:#F5F5F5;border-bottom:2px solid #ddd;">
      <td colspan="2" style="padding:5px 8px;text-align:right;font-size:12px;font-weight:800;color:#666;">소계</td>
      <td style="padding:5px 6px;text-align:center;font-size:14px;font-weight:900;color:#1565C0;">${gPpl}명</td>
      <td colspan="3" style="padding:3px;"></td>
    </tr>`;
  });

  if(!weekBks.length)rows=`<tr><td colspan="7" style="text-align:center;color:#bbb;padding:24px;font-size:14px;">예약 없음</td></tr>`;

  const sm=buildWeekSummary(weekBks);
  let summaryHtml='';
  if(weekBks.length){
    summaryHtml=`<tr><td colspan="7" style="padding:0;border:none;">
      <div style="background:${isThisWeek?'linear-gradient(135deg,#E8F5E9,#C8E6C9)':'linear-gradient(135deg,#F5F5F5,#EEEEEE)'};padding:12px 16px;border-top:2px solid ${isThisWeek?'#2e7d32':'#ccc'};">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="background:#fff;border-radius:10px;padding:8px 14px;border-left:4px solid ${isThisWeek?'#2e7d32':'#78909C'};display:flex;align-items:baseline;gap:6px;box-shadow:0 1px 3px rgba(0,0,0,.08);">
            <span style="font-size:22px;font-weight:900;color:${isThisWeek?'#2e7d32':'#555'};">${sm.wkTeams}</span><span style="font-size:14px;font-weight:700;color:#888;">팀</span>
            <span style="font-size:12px;color:#888;">확정<strong style="color:#2e7d32;">${sm.wkConf}</strong>/대기<strong style="color:#e65100;">${sm.wkPend}</strong></span>
          </div>
          <div style="background:#fff;border-radius:10px;padding:8px 14px;border-left:4px solid #1565C0;display:flex;align-items:baseline;gap:6px;box-shadow:0 1px 3px rgba(0,0,0,.08);">
            <span style="font-size:22px;font-weight:900;color:#1565C0;">${sm.wkPeople}</span><span style="font-size:14px;font-weight:700;color:#888;">명</span>
            ${sm.wkActCnt>0?`<span style="font-size:12px;color:#C2185B;font-weight:700;">실제 <strong>${sm.wkActPeople}</strong></span>`:''}
          </div>
          <div style="background:#fff;border-radius:10px;padding:8px 14px;border-left:4px solid #2e7d32;display:flex;align-items:baseline;gap:6px;box-shadow:0 1px 3px rgba(0,0,0,.08);">
            <span style="font-size:20px;font-weight:900;color:#2e7d32;">₩${fmtWon(sm.wkEst)}</span>
            ${sm.wkActCnt>0?`<span style="font-size:12px;color:#C2185B;font-weight:700;">실제 ₩${fmtWon(sm.wkActEst)}</span>`:''}
          </div>
        </div>
        ${sm.mealStr!=='없음'||sm.addonStr!=='없음'?`<div style="display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:#444;margin-top:8px;">${sm.mealStr!=='없음'?`<span style="background:#fff;padding:4px 10px;border-radius:6px;border:1px solid #F8BBD0;font-weight:600;">🍚 ${sm.mealStr}</span>`:''}${sm.addonStr!=='없음'?`<span style="background:#fff;padding:4px 10px;border-radius:6px;border:1px solid #E1BEE7;font-weight:600;">🎨 ${sm.addonStr}</span>`:''}</div>`:''}
      </div>
    </td></tr>`;
  }

  const borderColor=isThisWeek?'#2e7d32':'#ddd';
  const headerBg=isThisWeek?'#2e7d32':offset===-1?'#78909C':'#546E7A';
  return `<div style="border:2px solid ${borderColor};border-radius:10px;overflow:hidden;margin-bottom:12px;">
    <div style="background:${headerBg};color:#fff;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:800;font-size:16px;">${label}</span>
      <span style="font-size:13px;opacity:.9;">${fmt(wk.monDate)} ~ ${fmt(wk.sunDate)}${weekBks.length?` · <strong>${weekBks.length}팀</strong>`:''}</span>
    </div>
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="background:#F5F5F5;border-bottom:2px solid #ddd;">
          <th style="padding:8px;text-align:center;font-size:13px;font-weight:800;color:#444;border-right:1px solid #eee;width:65px;">날짜</th>
          <th style="padding:8px;text-align:left;font-size:13px;font-weight:800;color:#444;border-right:1px solid #eee;">단체명</th>
          <th style="padding:8px;text-align:center;font-size:13px;font-weight:800;color:#444;border-right:1px solid #eee;width:100px;">시간</th>
          <th style="padding:8px;text-align:center;font-size:13px;font-weight:800;color:#444;border-right:1px solid #eee;width:60px;">인원</th>
          <th style="padding:8px;text-align:left;font-size:13px;font-weight:800;color:#444;border-right:1px solid #eee;">상세정보</th>
          <th style="padding:8px;text-align:center;font-size:13px;font-weight:800;color:#444;border-right:1px solid #eee;width:50px;">상태</th>
          <th style="padding:8px;text-align:center;font-size:13px;font-weight:800;color:#444;">관리</th>
        </tr></thead>
        <tbody>${rows}${summaryHtml}</tbody>
      </table>
    </div>
  </div>`;
}

function renderDashWeek(){
  const container=document.getElementById('dashWeekAll');
  if(!container)return;
  container.innerHTML=renderOneWeek(-1,'📆 지난주')+renderOneWeek(0,'📅 이번주')+renderOneWeek(1,'📆 다음주');
}

function rDash(){
  const t=td(),tw=new Date();tw.setDate(tw.getDate()+1);const ts=tw.toISOString().split('T')[0];
  const mo=t.substring(0,7);
  // 기본 기간: 당월
  const drF=document.getElementById('drFrom'),drT=document.getElementById('drTo');
  if(drF&&!drF.value)drF.value=mo+'-01';
  if(drT&&!drT.value)drT.value=t;
  const tB=bks.filter(b=>b.date===t&&b.status!=='취소');
  const tP=tB.reduce((s,b)=>s+b.students+b.teachers,0);
  const pendList=bks.filter(b=>b.status==='대기');
  const confList=bks.filter(b=>b.status==='확정');
  const pendPpl=pendList.reduce((s,b)=>s+b.students+b.teachers,0);
  const confPpl=confList.reduce((s,b)=>s+b.students+b.teachers,0);
  const mList=bks.filter(b=>b.date.startsWith(mo)&&b.status!=='취소');
  const mPpl=mList.reduce((s,b)=>s+b.students+b.teachers,0);
  const mEst=mList.reduce((s,b)=>s+getEstimate(b),0);
  const mPaidList=mList.filter(b=>b.paidAmount!=null);
  const mPaid=mPaidList.reduce((s,b)=>s+b.paidAmount,0);
  const mPaidPpl=mPaidList.reduce((s,b)=>s+b.students+b.teachers,0);
  const cards=[
    {v:tB.length,l:'오늘 예약',s:tP+'명',c:'var(--p)',k:'today'},
    {v:pendList.length,l:'대기 중',s:pendPpl+'명',c:'var(--org)',k:'pending'},
    {v:confList.length,l:'확정',s:confPpl+'명',c:'var(--grn)',k:'confirmed'},
    {v:mList.length,l:'이번달',s:mPpl+'명',c:'var(--blu)',k:'month'},
    {v:'₩'+fmtWon(mEst),l:'이달 견적',s:mList.length+'건 / '+mPpl+'명',c:'var(--p)',sm:true,k:'monthEst'},
    {v:'₩'+fmtWon(mPaid),l:'이달 실결제',s:mPaidList.length+'건 / '+mPaidPpl+'명',c:'#1565C0',sm:true,k:'monthPaid'}
  ];
  document.getElementById('dStats').innerHTML=cards.map(x=>{
    const fs=x.sm?'font-size:clamp(14px,2.5vw,22px)':'font-size:clamp(20px,3.5vw,30px)';
    return '<div class="card" style="margin:0;cursor:pointer;border:2px solid transparent;transition:all .2s;" onclick="toggleStatDetail(\''+x.k+'\')" id="dsc_'+x.k+'"><div class="cbd" style="text-align:center;padding:12px 6px;"><div style="'+fs+';font-weight:900;color:'+x.c+';line-height:1.2;white-space:nowrap;">'+x.v+'</div><div style="font-size:13px;color:#444;margin-top:4px;font-weight:700;">'+x.l+'</div>'+(x.s?'<div style="font-size:13px;color:var(--p);font-weight:800;margin-top:3px;">'+x.s+'</div>':'')+'</div></div>';
  }).join('');

  // Hide detail on re-render
  var dd=document.getElementById('dStatDetail');
  if(dd){dd.style.display='none';dd.innerHTML='';}
  _openStatKey=null;

  renderDashWeek();

  // Unanswered chat alert on dashboard
  initChatFromBookings();
  const dashChatEl=document.getElementById('dashChatAlert');
  const allRooms=Object.values(chatData);
  const unansweredRooms=allRooms.filter(r=>{
    if(!r.msgs||!r.msgs.length)return false;
    const realMsgs=r.msgs.filter(m=>m.from!=='system');
    if(!realMsgs.length)return false;
    return realMsgs[realMsgs.length-1].from==='customer';
  });
  if(unansweredRooms.length&&dashChatEl){
    const chatColors=['#f44336','#e65100','#c2185b','#6a1b9a','#00796b'];
    let chatHtml=`<div class="card" style="margin:0;border-left:4px solid #f44336;">
      <div class="chd" style="padding:10px 16px;background:linear-gradient(135deg,#ffebee,#fff);display:flex;justify-content:space-between;align-items:center;">
        <h3 style="font-size:15px;color:#d32f2f;">💬 미답변 채팅 <span style="background:#f44336;color:#fff;padding:3px 10px;border-radius:10px;font-size:13px;">${unansweredRooms.length}</span></h3>
        <button onclick="gpNav('at')" style="padding:5px 14px;background:#f44336;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;">전체 채팅 보기 →</button>
      </div>
      <div class="cbd" style="padding:10px 14px;max-height:280px;overflow-y:auto;scrollbar-width:thin;">`;
    unansweredRooms.forEach((r,i)=>{
      const lastCust=r.msgs.filter(m=>m.from==='customer').pop();
      const preview=lastCust?(lastCust.text.length>30?lastCust.text.slice(0,30)+'...':lastCust.text):'';
      const timeStr=lastCust?formatChatTime(lastCust.ts):'';
      const bk2=bks.find(b=>'bk_'+b.id===r.id);
      const bkInfo=bk2?`<span style="font-size:11px;color:#888;margin-left:4px;">📅${bk2.date} 👥${bk2.students+bk2.teachers}명</span>`:'';
      const aiS=getChatAiSummary(r);
      const recentMsgs=(r.msgs||[]).filter(m=>m.from!=='system').slice(-3);
      let msgBubbles='';
      recentMsgs.forEach(m=>{
        const isCust=m.from==='customer';
        const time2=m.ts?new Date(m.ts).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
        const sender=m.sender||(isCust?r.name:(curAdmin?.name||'관리자'));
        if(isCust){
          msgBubbles+=`<div style="display:flex;align-items:flex-end;gap:4px;margin:3px 0;">
            <div style="background:#f5f5f5;padding:7px 12px;border-radius:10px 10px 10px 0;font-size:13px;color:#333;max-width:70%;line-height:1.4;"><strong style="font-size:10px;color:#888;">${sender}</strong><br>${m.text}</div>
            <span style="font-size:10px;color:#aaa;">${time2}</span>
          </div>`;
        } else {
          msgBubbles+=`<div style="display:flex;align-items:flex-end;gap:4px;margin:3px 0;justify-content:flex-end;">
            <span style="font-size:10px;color:#aaa;">${time2}</span>
            <div style="background:var(--p);padding:7px 12px;border-radius:10px 10px 0 10px;font-size:13px;color:#fff;max-width:70%;line-height:1.4;">${m.text}</div>
          </div>`;
        }
      });
      chatHtml+=`<div style="border-radius:10px;border:1px solid #f0f0f0;margin-bottom:8px;overflow:hidden;">
        <div onclick="const el=document.getElementById('dashChat_${i}');el.style.display=el.style.display==='none'?'block':'none';" style="display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;background:#fff;transition:background .12s;" onmouseenter="this.style.background='#fff8f8'" onmouseleave="this.style.background='#fff'">
          <div style="width:36px;height:36px;border-radius:50%;background:${chatColors[i%chatColors.length]};color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;position:relative;">
            ${r.name.charAt(0)}
            <span style="position:absolute;top:-2px;right:-2px;width:9px;height:9px;background:#f44336;border-radius:50%;border:2px solid #fff;"></span>
          </div>
          <div style="flex:1;min-width:0;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="font-size:14px;font-weight:700;color:#333;">${r.name}${bkInfo}</span>
              <span style="font-size:11px;color:#f44336;font-weight:600;">${timeStr}</span>
            </div>
            <div style="font-size:13px;color:#555;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">💬 "${preview}"</div>
            ${aiS?`<div style="font-size:9px;color:#1565c0;margin-top:1px;">🤖 ${aiS}</div>`:''}
          </div>
          <span style="font-size:18px;color:#ccc;" id="dashChatArrow_${i}">▼</span>
        </div>
        <div id="dashChat_${i}" style="display:none;border-top:1px solid #f0f0f0;background:#fafafa;">
          <div style="padding:8px 12px;max-height:150px;overflow-y:auto;">${msgBubbles}</div>
          <div style="display:flex;gap:6px;padding:8px 12px;background:#fff;border-top:1px solid #f0f0f0;">
            <input type="text" id="dashReply_${i}" data-rid="${r.id}" placeholder="답변 입력..." style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:12px;outline:none;" onkeydown="if(event.key==='Enter')dashQuickReply(${i})">
            <button onclick="dashQuickReply(${i})" style="padding:8px 14px;background:var(--p);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;">전송 ✉️</button>
          </div>
        </div>
      </div>`;
    });
    chatHtml+=`</div></div>`;
    dashChatEl.innerHTML=chatHtml;
  } else if(dashChatEl){
    dashChatEl.innerHTML='';
  }
  setRevRange('1m');
  setLtRange('1m');
  setCatPeriod('1m');
  generateDashInsight();
}

// ===== AI INSIGHT GENERATION =====
function insightBox(html){
  return '<div style="background:linear-gradient(135deg,#f0f7f0,#e4f2e4);border:2px solid #81C784;border-radius:14px;padding:16px 20px;margin:8px 0;box-shadow:0 2px 8px rgba(46,125,50,.1);"><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid rgba(46,125,50,.15);"><span style="font-size:20px;">🤖</span><span style="font-size:15px;font-weight:900;color:#1B5E20;">AI 분석</span></div><div style="font-size:14px;line-height:2;color:#222;">'+html+'</div></div>';
}

function generateDashInsight(){
  var t=td(),mo=t.substring(0,7);
  var today=bks.filter(function(b){return b.date===t&&b.status!=='취소';});
  var pend=bks.filter(function(b){return b.status==='대기';});
  var conf=bks.filter(function(b){return b.status==='확정';});
  var mList=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});
  var todayPpl=today.reduce(function(s,b){return s+b.students+b.teachers;},0);
  var lines=[];
  if(today.length>0)lines.push('오늘 <strong>'+today.length+'건</strong> ('+todayPpl+'명) 방문 예정이며, '+(today.filter(function(b){return b.status==='대기';}).length>0?'아직 확정되지 않은 건이 있어 확인이 필요합니다.':'모두 확정 상태입니다.'));
  else lines.push('오늘 예정된 예약이 없습니다.');
  if(pend.length>0){
    var oldPend=pend.filter(function(b){var d=new Date(b.created);var diff=Math.floor((new Date()-d)/(1000*60*60*24));return diff>=7;});
    lines.push('대기 중 <strong>'+pend.length+'건</strong> 중'+(oldPend.length>0?' <span style="color:#c62828;">'+oldPend.length+'건이 7일 이상 경과</span>하여 조속한 확정/취소 처리가 권장됩니다.':' 모두 최근 접수건입니다.'));
  }
  var confRate=mList.length>0?Math.round(conf.filter(function(b){return b.date.startsWith(mo);}).length/mList.length*100):0;
  lines.push('이번달 확정률 <strong>'+confRate+'%</strong> ('+mList.length+'건 중 '+conf.filter(function(b){return b.date.startsWith(mo);}).length+'건 확정)');
  var el=document.getElementById('insightDash');
  if(el)el.innerHTML=insightBox(lines.join('<br>'));
}

function generateRevInsight(){
  var el=document.getElementById('insightRev');
  if(!el)return;
  var mo=td().substring(0,7);
  var mList=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});
  var mEst=mList.reduce(function(s,b){return s+getEstimate(b);},0);
  var mPaid=mList.filter(function(b){return b.paidAmount!=null;}).reduce(function(s,b){return s+b.paidAmount;},0);
  // Previous month
  var pm=new Date();pm.setMonth(pm.getMonth()-1);
  var pmKey=pm.toISOString().substring(0,7);
  var pmList=bks.filter(function(b){return b.date.startsWith(pmKey)&&b.status!=='취소';});
  var pmEst=pmList.reduce(function(s,b){return s+getEstimate(b);},0);
  var lines=[];
  if(pmEst>0){
    var growth=Math.round((mEst-pmEst)/pmEst*100);
    lines.push('이번달 견적(₩'+fmtWon(mEst)+')은 전월 대비 <strong>'+(growth>=0?'+':'')+growth+'%</strong>'+( growth>0?' 증가했습니다.':growth<0?' 감소했습니다.':' 동일합니다.'));
  }else{lines.push('이번달 견적 합계: <strong>₩'+fmtWon(mEst)+'</strong>');}
  var collectRate=mEst>0?Math.round(mPaid/mEst*100):0;
  lines.push('실결제 수금률 <strong>'+collectRate+'%</strong> (₩'+fmtWon(mPaid)+'/₩'+fmtWon(mEst)+')'+(collectRate<50&&mEst>0?' — <span style="color:#e65100;">미수금 관리에 주의가 필요합니다.</span>':''));
  var avgPerTeam=mList.length>0?Math.round(mEst/mList.length):0;
  lines.push('건당 평균 견적: <strong>₩'+fmtWon(avgPerTeam)+'</strong> ('+mList.length+'건)');
  el.innerHTML=insightBox(lines.join('<br>'));
}

function generateLtInsight(){
  var el=document.getElementById('insightLt');
  if(!el)return;
  var dp=/^\d{4}-\d{2}-\d{2}$/;
  var active=bks.filter(function(b){return b.status!=='취소'&&b.created&&dp.test(b.created)&&b.date&&dp.test(b.date);});
  if(!active.length){el.innerHTML='';return;}
  var leads=active.map(function(b){var d=Math.max(0,Math.floor((new Date(b.date)-new Date(b.created))/(1000*60*60*24)));return isNaN(d)?0:d;});
  var avg=Math.round(leads.reduce(function(s,v){return s+v;},0)/leads.length);
  var sameMonth=active.filter(function(b){return b.date.substring(0,7)===b.created.substring(0,7);}).length;
  var lines=[];
  lines.push('평균 리드타임(신청→방문) <strong>'+avg+'일</strong>이며, '+(avg<=7?'빠른 회전율을 보이고 있습니다.':avg<=14?'일반적인 수준입니다.':'장기 사전예약 비중이 높습니다.'));
  lines.push('전체 '+active.length+'건 중 <strong>'+sameMonth+'건('+Math.round(sameMonth/active.length*100)+'%)</strong>이 당월 신청·방문으로 즉시 수요가 높습니다.');
  var shortLead=leads.filter(function(v){return v<=7;}).length;
  lines.push('7일 이내 단기예약 <strong>'+shortLead+'건('+Math.round(shortLead/leads.length*100)+'%)</strong>'+(shortLead/leads.length>0.5?' — 탄력적 운영이 중요합니다.':' — 안정적인 사전예약 비중입니다.'));
  el.innerHTML=insightBox(lines.join('<br>'));
}

function generateCatInsight(){
  var el=document.getElementById('insightCat');
  if(!el)return;
  var active=bks.filter(function(b){return b.status!=='취소';});
  if(!active.length){el.innerHTML='';return;}
  var catMap={};
  active.forEach(function(b){var c=b.category||'미분류';if(!catMap[c])catMap[c]={n:0,p:0,e:0};catMap[c].n++;catMap[c].p+=b.students+b.teachers;catMap[c].e+=getEstimate(b);});
  var sorted=Object.keys(catMap).sort(function(a,b){return catMap[b].n-catMap[a].n;});
  var lines=[];
  if(sorted.length>0){
    var top=sorted[0],topG=catMap[top];
    lines.push('가장 많은 유형은 <strong>'+top+'</strong> ('+topG.n+'건, '+Math.round(topG.n/active.length*100)+'%)이며, 평균 '+(Math.round(topG.p/topG.n))+'명 규모입니다.');
  }
  if(sorted.length>1){
    var avgEsts=sorted.map(function(k){return {k:k,avg:Math.round(catMap[k].e/catMap[k].n)};}).sort(function(a,b){return b.avg-a.avg;});
    lines.push('건당 견적이 가장 높은 유형은 <strong>'+avgEsts[0].k+'</strong> (평균 ₩'+fmtWon(avgEsts[0].avg)+')입니다.');
  }
  var uncat=catMap['미분류'];
  if(uncat&&uncat.n>0&&sorted.length>1){
    lines.push('<span style="color:#e65100;">미분류 '+uncat.n+'건('+Math.round(uncat.n/active.length*100)+'%)이 있어 구분 입력을 권장합니다.</span>');
  }else if(sorted.length<=1){
    lines.push('단체 유형 데이터가 부족합니다. 예약 시 구분(어린이집/유치원/초등 등)을 입력하면 더 정확한 분석이 가능합니다.');
  }
  el.innerHTML=insightBox(lines.join('<br>'));
}

// ===== REPORT AI ANALYSIS =====

function exportWeekExcel(){
  var now=new Date(),dow=now.getDay(),diff=(dow+6)%7;
  var weeks=[];
  for(var w=-1;w<=1;w++){
    var mon=new Date(now);mon.setDate(mon.getDate()-diff+w*7);
    var sun=new Date(mon);sun.setDate(mon.getDate()+6);
    var from=mon.toISOString().split('T')[0];
    var to=sun.toISOString().split('T')[0];
    var label=w===-1?'지난주':w===0?'이번주':'다음주';
    var list=bks.filter(function(b){return b.date>=from&&b.date<=to&&b.status!=='취소';}).sort(function(a,b){return a.date>b.date?1:-1;});
    weeks.push({label:label,from:from,to:to,list:list});
  }
  var facName=curFac?curFac.name:'시설';
  var xml='<?xml version="1.0" encoding="UTF-8"?><?mso-application progid="Excel.Sheet"?>';
  xml+='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
  xml+='<Styles>';
  xml+='<Style ss:ID="hd"><Font ss:Bold="1" ss:Size="14"/></Style>';
  xml+='<Style ss:ID="h2"><Font ss:Bold="1" ss:Size="12"/><Interior ss:Color="#E8F5E9" ss:Pattern="Solid"/></Style>';
  xml+='<Style ss:ID="th"><Font ss:Bold="1" ss:Size="10"/><Interior ss:Color="#F0F7F0" ss:Pattern="Solid"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="td"><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="num"><NumberFormat ss:Format="#,##0"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="tot"><Font ss:Bold="1"/><Interior ss:Color="#F0F7F0" ss:Pattern="Solid"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="totN"><Font ss:Bold="1"/><Interior ss:Color="#F0F7F0" ss:Pattern="Solid"/><NumberFormat ss:Format="#,##0"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='</Styles>';
  xml+='<Worksheet ss:Name="주간예약현황"><Table>';
  xml+='<Column ss:Width="90"/><Column ss:Width="140"/><Column ss:Width="70"/><Column ss:Width="100"/><Column ss:Width="55"/><Column ss:Width="55"/><Column ss:Width="90"/><Column ss:Width="55"/>';
  xml+='<Row><Cell ss:StyleID="hd"><Data ss:Type="String">'+facName+' 주간 예약 현황 ('+td()+')</Data></Cell></Row><Row></Row>';
  weeks.forEach(function(wk){
    xml+='<Row><Cell ss:StyleID="h2"><Data ss:Type="String">'+wk.label+' ('+wk.from+' ~ '+wk.to+') — '+wk.list.length+'건</Data></Cell></Row>';
    xml+='<Row>';
    ['날짜','단체명','구분','시간','아동','인솔','견적','상태'].forEach(function(c){xml+='<Cell ss:StyleID="th"><Data ss:Type="String">'+c+'</Data></Cell>';});
    xml+='</Row>';
    if(!wk.list.length){
      xml+='<Row><Cell ss:StyleID="td"><Data ss:Type="String">예약 없음</Data></Cell></Row>';
    }else{
      wk.list.forEach(function(b){
        xml+='<Row>';
        xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.date+'</Data></Cell>';
        xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.name+'</Data></Cell>';
        xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+(b.category||'미분류')+'</Data></Cell>';
        xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.arrival+'~'+b.departure+'</Data></Cell>';
        xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+b.students+'</Data></Cell>';
        xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+b.teachers+'</Data></Cell>';
        xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+getEstimate(b)+'</Data></Cell>';
        xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.status+'</Data></Cell>';
        xml+='</Row>';
      });
      var ts=wk.list.reduce(function(s,b){return s+b.students;},0);
      var tt=wk.list.reduce(function(s,b){return s+b.teachers;},0);
      var te=wk.list.reduce(function(s,b){return s+getEstimate(b);},0);
      xml+='<Row><Cell ss:StyleID="tot" ss:MergeAcross="3"><Data ss:Type="String">소계 ('+wk.list.length+'건)</Data></Cell>';
      xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+ts+'</Data></Cell>';
      xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+tt+'</Data></Cell>';
      xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+te+'</Data></Cell>';
      xml+='<Cell ss:StyleID="tot"><Data ss:Type="String">'+(ts+tt)+'명</Data></Cell></Row>';
    }
    xml+='<Row></Row>';
  });
  xml+='</Table></Worksheet></Workbook>';
  try{
    var blob=new Blob([xml],{type:'application/vnd.ms-excel;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');a.href=url;a.download=facName+'_주간예약현황_'+td()+'.xls';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},1000);
    toast('📥 주간 엑셀 다운로드 완료','s');
  }catch(e){toast('다운로드 오류','e');}
}
function getReportAIAnalysis(todayList,pendList,confList,monthList,monthPaidList){
  var t=td(),mo=t.substring(0,7);
  var lines=[];
  var todayPpl=todayList.reduce(function(s,b){return s+b.students+b.teachers;},0);
  var mEst=monthList.reduce(function(s,b){return s+getEstimate(b);},0);
  var mPaid=monthPaidList.reduce(function(s,b){return s+(b.paidAmount||0);},0);
  var mConfInMonth=confList.filter(function(b){return b.date.startsWith(mo);}).length;
  var confRate=monthList.length>0?Math.round(mConfInMonth/monthList.length*100):0;
  lines.push('<strong>📌 현황 요약:</strong> 오늘 '+todayList.length+'건('+todayPpl+'명) 방문, 대기 '+pendList.length+'건, 확정 '+confList.length+'건. 이번달 확정률 '+confRate+'%.');
  var pm=new Date();pm.setMonth(pm.getMonth()-1);
  var pmKey=pm.toISOString().substring(0,7);
  var pmList=bks.filter(function(b){return b.date.startsWith(pmKey)&&b.status!=='취소';});
  var pmEst=pmList.reduce(function(s,b){return s+getEstimate(b);},0);
  var collectRate=mEst>0?Math.round(mPaid/mEst*100):0;
  var growthStr='';
  if(pmEst>0){var g=Math.round((mEst-pmEst)/pmEst*100);growthStr='전월 대비 '+(g>=0?'+':'')+g+'%, ';}
  lines.push('<strong>💰 매출:</strong> 이달 견적 ₩'+fmtWon(mEst)+' ('+growthStr+'수금률 '+collectRate+'%)'+(collectRate<50&&mEst>0?' — 미수금 관리 필요.':'.'));
  var active=bks.filter(function(b){return b.status!=='취소'&&b.created;});
  var catMap={};
  active.forEach(function(b){var c=b.category||'미분류';if(!catMap[c])catMap[c]=0;catMap[c]++;});
  var topCat=Object.keys(catMap).sort(function(a,b){return catMap[b]-catMap[a];})[0]||'미분류';
  var pendOld=pendList.filter(function(b){var d=new Date(b.created);return (new Date()-d)/(1000*60*60*24)>=7;}).length;
  var actionItems=[];
  if(pendOld>0)actionItems.push('장기 대기 '+pendOld+'건 처리');
  if(collectRate<50&&mEst>0)actionItems.push('미수금 확인');
  var uncatN=catMap['미분류']||0;
  if(uncatN>0&&Object.keys(catMap).length>1)actionItems.push('미분류 '+uncatN+'건 구분 입력');
  lines.push('<strong>📋 주요 조치:</strong> '+(actionItems.length>0?actionItems.join(', ')+' 필요.':'특별 조치사항 없음. 주요 유형: '+topCat+'.'));
  return lines.join('<br>');
}

var _openStatKey=null;
function toggleStatDetail(key){
  var dd=document.getElementById('dStatDetail');
  if(!dd)return;
  // Deselect all cards
  document.querySelectorAll('[id^="dsc_"]').forEach(function(el){el.style.border='2px solid transparent';});
  if(_openStatKey===key){dd.style.display='none';dd.innerHTML='';_openStatKey=null;return;}
  _openStatKey=key;
  // Highlight selected
  var sc=document.getElementById('dsc_'+key);
  if(sc)sc.style.border='2px solid var(--p)';

  var t=td(),mo=t.substring(0,7);
  var list=[];
  var title='';
  if(key==='today'){list=bks.filter(function(b){return b.date===t&&b.status!=='취소';});title='📌 오늘 예약';}
  else if(key==='pending'){list=bks.filter(function(b){return b.status==='대기';});title='⏳ 대기 중';}
  else if(key==='confirmed'){list=bks.filter(function(b){return b.status==='확정';});title='✅ 확정';}
  else if(key==='month'){list=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});title='📅 이번달 예약';}
  else if(key==='monthEst'){list=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});title='💰 이달 견적';}
  else if(key==='monthPaid'){list=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소'&&b.paidAmount!=null;});title='💳 이달 실결제';}

  if(!list.length){
    dd.innerHTML='<div class="card" style="margin:0;"><div class="cbd" style="text-align:center;padding:20px;color:#aaa;font-size:13px;">'+title+' — 해당 예약이 없습니다.</div></div>';
    dd.style.display='block';return;
  }

  list.sort(function(a,b){return a.date>b.date?1:a.date<b.date?-1:0;});
  var h='<div class="card" style="margin:0;"><div class="cbd">';
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><h3 style="font-size:14px;font-weight:800;color:var(--p);">'+title+' ('+list.length+'건)</h3><button onclick="toggleStatDetail(\''+key+'\')" style="background:none;border:none;cursor:pointer;font-size:16px;color:#aaa;">✕</button></div>';
  h+='<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:11px;">';
  h+='<thead><tr style="background:#f0f7f0;">';
  ['날짜','단체명','구분','시간','아동','인솔','견적','상태'].forEach(function(c){h+='<th style="padding:6px 8px;border:1px solid #e0e0e0;font-weight:700;white-space:nowrap;">'+c+'</th>';});
  h+='</tr></thead><tbody>';
  list.forEach(function(b){
    var bg=b.date===t?'background:#fffde7;':'';
    var stColor=b.status==='확정'?'#2e7d32':b.status==='대기'?'#e65100':'#888';
    h+='<tr style="'+bg+'">';
    h+='<td style="padding:5px 8px;border:1px solid #eee;white-space:nowrap;font-weight:600;">'+b.date.substring(5)+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;font-weight:700;color:#1a472a;">'+b.name+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;font-size:10px;color:#555;">'+(b.category||'미분류')+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;white-space:nowrap;">'+b.arrival+'~'+b.departure+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:center;">'+b.students+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:center;">'+b.teachers+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:right;white-space:nowrap;">₩'+fmtWon(getEstimate(b))+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:center;font-weight:700;color:'+stColor+';">'+b.status+'</td>';
    h+='</tr>';
  });
  // Totals
  var totStu=list.reduce(function(s,b){return s+b.students;},0);
  var totTea=list.reduce(function(s,b){return s+b.teachers;},0);
  var totEst=list.reduce(function(s,b){return s+getEstimate(b);},0);
  h+='<tr style="background:#f0f7f0;font-weight:700;">';
  h+='<td colspan="4" style="padding:6px 8px;border:1px solid #e0e0e0;">합계 ('+list.length+'건)</td>';
  h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:center;">'+totStu+'</td>';
  h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:center;">'+totTea+'</td>';
  h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:right;">₩'+fmtWon(totEst)+'</td>';
  h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:center;">'+(totStu+totTea)+'명</td>';
  h+='</tr></tbody></table></div>';

  // Category summary
  var catMap={};
  list.forEach(function(b){
    var cat=b.category||'미분류';
    if(!catMap[cat])catMap[cat]={count:0,students:0,teachers:0,est:0};
    catMap[cat].count++;catMap[cat].students+=b.students;catMap[cat].teachers+=b.teachers;catMap[cat].est+=getEstimate(b);
  });
  var catKeys=Object.keys(catMap).sort(function(a,b){return catMap[b].count-catMap[a].count;});
  if(catKeys.length>0){
    h+='<div style="margin-top:12px;"><div style="font-size:13px;font-weight:800;color:var(--p);margin-bottom:8px;">📊 구분별 현황</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:8px;">';
    catKeys.forEach(function(cat){
      var g=catMap[cat];
      h+='<div style="background:#f5f9f5;border:1px solid #c8e6c9;border-radius:10px;padding:10px 14px;min-width:120px;">';
      h+='<div style="font-size:13px;font-weight:800;color:#1a472a;">'+cat+'</div>';
      h+='<div style="font-size:12px;color:#555;margin-top:4px;">'+g.count+'건 · 아동 '+g.students+'명 · 인솔 '+g.teachers+'명</div>';
      h+='<div style="font-size:11px;color:#1565c0;font-weight:700;margin-top:2px;">₩'+fmtWon(g.est)+'</div>';
      h+='</div>';
    });
    h+='</div></div>';
  }

  h+='</div></div>';
  dd.innerHTML=h;
  dd.style.display='block';
  dd.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function _getStatList(key){
  if(key==='__drPreview__'&&window._drOverride)return window._drOverride;
  var t=td(),mo=t.substring(0,7);
  if(key==='today')return {list:bks.filter(function(b){return b.date===t&&b.status!=='취소';}),title:'오늘 예약'};
  if(key==='pending')return {list:bks.filter(function(b){return b.status==='대기';}),title:'대기 중'};
  if(key==='confirmed')return {list:bks.filter(function(b){return b.status==='확정';}),title:'확정'};
  if(key==='month')return {list:bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';}),title:'이번달 예약'};
  if(key==='monthEst')return {list:bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';}),title:'이달 견적'};
  if(key==='monthPaid')return {list:bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소'&&b.paidAmount!=null;}),title:'이달 실결제'};
  return {list:[],title:''};
}

function exportStatExcel(key){
  var d=_getStatList(key);
  var list=d.list.slice().sort(function(a,b){return a.date>b.date?1:-1;});
  if(!list.length){toast('데이터가 없습니다','e');return;}
  var facName=curFac?curFac.name:'시설';
  var fn=facName+'_'+d.title.replace(/ /g,'')+'_'+td();

  var xml='<?xml version="1.0" encoding="UTF-8"?>';
  xml+='<?mso-application progid="Excel.Sheet"?>';
  xml+='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"';
  xml+=' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
  xml+='<Styles>';
  xml+='<Style ss:ID="hd"><Font ss:Bold="1" ss:Size="14"/></Style>';
  xml+='<Style ss:ID="th"><Font ss:Bold="1" ss:Size="11"/><Interior ss:Color="#E8F5E9" ss:Pattern="Solid"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="td"><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="num"><NumberFormat ss:Format="#,##0"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="tot"><Font ss:Bold="1"/><Interior ss:Color="#F0F7F0" ss:Pattern="Solid"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='<Style ss:ID="totN"><Font ss:Bold="1"/><Interior ss:Color="#F0F7F0" ss:Pattern="Solid"/><NumberFormat ss:Format="#,##0"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style>';
  xml+='</Styles>';

  // Sheet 1: Booking List
  xml+='<Worksheet ss:Name="예약목록">';
  xml+='<Table>';
  xml+='<Column ss:Width="90"/><Column ss:Width="140"/><Column ss:Width="70"/><Column ss:Width="100"/><Column ss:Width="55"/><Column ss:Width="55"/><Column ss:Width="60"/><Column ss:Width="90"/><Column ss:Width="90"/><Column ss:Width="55"/><Column ss:Width="70"/>';
  // Title
  xml+='<Row><Cell ss:StyleID="hd"><Data ss:Type="String">'+facName+' - '+d.title+' ('+td()+')</Data></Cell></Row>';
  xml+='<Row></Row>';
  // Headers
  xml+='<Row>';
  ['날짜','단체명','구분','시간','아동','인솔','총인원','견적','실결제','상태','채널'].forEach(function(c){
    xml+='<Cell ss:StyleID="th"><Data ss:Type="String">'+c+'</Data></Cell>';
  });
  xml+='</Row>';
  // Data rows
  list.forEach(function(b){
    xml+='<Row>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.date+'</Data></Cell>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.name+'</Data></Cell>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+(b.category||'미분류')+'</Data></Cell>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.arrival+'~'+b.departure+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+b.students+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+b.teachers+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+(b.students+b.teachers)+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+getEstimate(b)+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+(b.paidAmount!=null?b.paidAmount:0)+'</Data></Cell>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+b.status+'</Data></Cell>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+(b.channel||'')+'</Data></Cell>';
    xml+='</Row>';
  });
  // Totals
  var tStu=list.reduce(function(s,b){return s+b.students;},0);
  var tTea=list.reduce(function(s,b){return s+b.teachers;},0);
  var tEst=list.reduce(function(s,b){return s+getEstimate(b);},0);
  var tPaid=list.filter(function(b){return b.paidAmount!=null;}).reduce(function(s,b){return s+b.paidAmount;},0);
  xml+='<Row>';
  xml+='<Cell ss:StyleID="tot" ss:MergeAcross="3"><Data ss:Type="String">합계 ('+list.length+'건)</Data></Cell>';
  xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+tStu+'</Data></Cell>';
  xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+tTea+'</Data></Cell>';
  xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+(tStu+tTea)+'</Data></Cell>';
  xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+tEst+'</Data></Cell>';
  xml+='<Cell ss:StyleID="totN"><Data ss:Type="Number">'+tPaid+'</Data></Cell>';
  xml+='<Cell ss:StyleID="tot"><Data ss:Type="String"></Data></Cell>';
  xml+='<Cell ss:StyleID="tot"><Data ss:Type="String"></Data></Cell>';
  xml+='</Row>';
  xml+='</Table></Worksheet>';

  // Sheet 2: Category Summary
  xml+='<Worksheet ss:Name="구분별현황">';
  xml+='<Table>';
  xml+='<Column ss:Width="100"/><Column ss:Width="60"/><Column ss:Width="60"/><Column ss:Width="60"/><Column ss:Width="70"/><Column ss:Width="100"/>';
  xml+='<Row><Cell ss:StyleID="hd"><Data ss:Type="String">구분별 현황</Data></Cell></Row>';
  xml+='<Row></Row>';
  xml+='<Row>';
  ['구분','건수','아동','인솔','총인원','견적'].forEach(function(c){
    xml+='<Cell ss:StyleID="th"><Data ss:Type="String">'+c+'</Data></Cell>';
  });
  xml+='</Row>';
  var catMap={};
  list.forEach(function(b){var cat=b.category||'미분류';if(!catMap[cat])catMap[cat]={c:0,s:0,t:0,e:0};catMap[cat].c++;catMap[cat].s+=b.students;catMap[cat].t+=b.teachers;catMap[cat].e+=getEstimate(b);});
  Object.keys(catMap).sort(function(a,b){return catMap[b].c-catMap[a].c;}).forEach(function(k){
    var g=catMap[k];
    xml+='<Row>';
    xml+='<Cell ss:StyleID="td"><Data ss:Type="String">'+k+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+g.c+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+g.s+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+g.t+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+(g.s+g.t)+'</Data></Cell>';
    xml+='<Cell ss:StyleID="num"><Data ss:Type="Number">'+g.e+'</Data></Cell>';
    xml+='</Row>';
  });
  xml+='</Table></Worksheet>';
  xml+='</Workbook>';

  try{
    var blob=new Blob([xml],{type:'application/vnd.ms-excel;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');a.href=url;a.download=fn+'.xls';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    setTimeout(function(){URL.revokeObjectURL(url);},1000);
    toast('📥 엑셀 다운로드 완료','s');
  }catch(e){
    var ov=document.createElement('div');ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:#fff;overflow-y:auto;';
    var bar=document.createElement('div');bar.style.cssText='position:sticky;top:0;background:#1a472a;padding:8px 16px;display:flex;gap:8px;justify-content:flex-end;';
    var bc=document.createElement('button');bc.textContent='✕ 닫기';bc.style.cssText='padding:8px 16px;background:#c62828;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;';bc.onclick=function(){ov.remove();};
    bar.appendChild(bc);ov.appendChild(bar);
    var ct=document.createElement('div');ct.style.cssText='padding:20px;';ct.innerHTML='<pre>'+xml.replace(/</g,'&lt;')+'</pre>';ov.appendChild(ct);
    document.body.appendChild(ov);
    toast('다운로드 불가 — 화면에서 확인하세요','e');
  }
}

function exportStatReport(key){
  var now=new Date();
  var facName=curFac?curFac.name:'시설';
  var t=td(),mo=t.substring(0,7);

  // All category data
  var todayList=bks.filter(function(b){return b.date===t&&b.status!=='취소';});
  var pendList=bks.filter(function(b){return b.status==='대기';});
  var confList=bks.filter(function(b){return b.status==='확정';});
  var monthList=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});
  var monthPaidList=monthList.filter(function(b){return b.paidAmount!=null;});
  function sumStu(l){return l.reduce(function(s,b){return s+b.students;},0);}
  function sumTea(l){return l.reduce(function(s,b){return s+b.teachers;},0);}
  function sumEst(l){return l.reduce(function(s,b){return s+getEstimate(b);},0);}
  function sumPaid(l){return l.reduce(function(s,b){return s+(b.paidAmount||0);},0);}

  var S={
    h1:'font-size:22px;color:#1a472a;border-bottom:3px solid #1a472a;padding-bottom:10px;margin-bottom:14px;',
    h2:'font-size:16px;color:#2d6a4f;margin:22px 0 10px;border-left:4px solid #2d6a4f;padding-left:10px;',
    tbl:'border-collapse:collapse;width:100%;margin-bottom:14px;font-size:12px;',
    th:'border:1px solid #ccc;padding:6px 10px;text-align:center;background:#f0f7f0;font-weight:700;font-size:12px;',
    td:'border:1px solid #ccc;padding:6px 10px;text-align:center;font-size:12px;',
    sc:'flex:1;min-width:130px;padding:14px 10px;border-radius:10px;text-align:center;',
    tot:'background:#f0f7f0;font-weight:700;'
  };

  var h='<div style="font-family:-apple-system,sans-serif;color:#222;font-size:13px;">';
  h+='<h1 style="'+S.h1+'">📊 '+facName+' 데일리 리포트</h1>';
  h+='<div style="font-size:12px;color:#888;margin-bottom:18px;">📅 '+t+' ('+['일','월','화','수','목','금','토'][now.getDay()]+'요일) | 작성: '+now.toLocaleString('ko-KR')+'</div>';

  // ===== 1. Summary cards =====
  h+='<h2 style="'+S.h2+'">📌 종합 현황</h2>';
  h+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">';
  var cards=[
    {v:todayList.length+'건',s:'아동 '+sumStu(todayList)+' · 인솔 '+sumTea(todayList),l:'오늘 예약',bg:'#e8f5e9',c:'#1a472a'},
    {v:pendList.length+'건',s:sumStu(pendList)+sumTea(pendList)+'명',l:'대기 중',bg:'#fff3e0',c:'#e65100'},
    {v:confList.length+'건',s:sumStu(confList)+sumTea(confList)+'명',l:'확정',bg:'#e8f5e9',c:'#2e7d32'},
    {v:monthList.length+'건',s:sumStu(monthList)+sumTea(monthList)+'명',l:'이번달',bg:'#e3f2fd',c:'#1565c0'},
    {v:'₩'+fmtWon(sumEst(monthList)),s:monthList.length+'건 / '+(sumStu(monthList)+sumTea(monthList))+'명',l:'이달 견적',bg:'#e8f5e9',c:'#1a472a'},
    {v:'₩'+fmtWon(sumPaid(monthPaidList)),s:monthPaidList.length+'건 / '+(sumStu(monthPaidList)+sumTea(monthPaidList))+'명',l:'이달 실결제',bg:'#e3f2fd',c:'#1565c0'}
  ];
  cards.forEach(function(x){
    h+='<div style="'+S.sc+'background:'+x.bg+';">';
    h+='<div style="font-size:22px;font-weight:900;color:'+x.c+';">'+x.v+'</div>';
    h+='<div style="font-size:13px;font-weight:700;color:#555;margin-top:4px;">'+x.l+'</div>';
    h+='<div style="font-size:11px;color:#777;margin-top:2px;">'+x.s+'</div>';
    h+='</div>';
  });
  h+='</div>';

  // Helper: build section with table
  function buildSection(title,emoji,list){
    if(!list.length)return '<h2 style="'+S.h2+'">'+emoji+' '+title+' (0건)</h2><div style="color:#aaa;font-size:12px;padding:10px 0;">해당 예약이 없습니다.</div>';
    var sorted=list.slice().sort(function(a,b){return a.date>b.date?1:-1;});
    var r='<h2 style="'+S.h2+'">'+emoji+' '+title+' ('+list.length+'건 / '+(sumStu(list)+sumTea(list))+'명 / ₩'+fmtWon(sumEst(list))+')</h2>';
    r+='<table style="'+S.tbl+'"><thead><tr>';
    ['날짜','단체명','구분','시간','아동','인솔','견적','상태'].forEach(function(c){r+='<th style="'+S.th+'">'+c+'</th>';});
    r+='</tr></thead><tbody>';
    sorted.forEach(function(b){
      var isToday=b.date===t?'background:#fffde7;':'';
      var stC=b.status==='확정'?'color:#2e7d32;':b.status==='대기'?'color:#e65100;':'color:#888;';
      r+='<tr style="'+isToday+'">';
      r+='<td style="'+S.td+'font-weight:600;">'+b.date+'</td>';
      r+='<td style="'+S.td+'text-align:left;font-weight:700;">'+b.name+'</td>';
      r+='<td style="'+S.td+'">'+(b.category||'미분류')+'</td>';
      r+='<td style="'+S.td+'">'+b.arrival+'~'+b.departure+'</td>';
      r+='<td style="'+S.td+'">'+b.students+'</td>';
      r+='<td style="'+S.td+'">'+b.teachers+'</td>';
      r+='<td style="'+S.td+'text-align:right;">₩'+fmtWon(getEstimate(b))+'</td>';
      r+='<td style="'+S.td+'font-weight:700;'+stC+'">'+b.status+'</td>';
      r+='</tr>';
    });
    r+='<tr style="'+S.tot+'"><td colspan="4" style="'+S.td+'">합계</td>';
    r+='<td style="'+S.td+'">'+sumStu(list)+'</td><td style="'+S.td+'">'+sumTea(list)+'</td>';
    r+='<td style="'+S.td+'text-align:right;">₩'+fmtWon(sumEst(list))+'</td>';
    r+='<td style="'+S.td+'">'+(sumStu(list)+sumTea(list))+'명</td></tr>';
    r+='</tbody></table>';
    // Category breakdown
    var cm={};
    list.forEach(function(b){var c=b.category||'미분류';if(!cm[c])cm[c]={n:0,s:0,t:0,e:0};cm[c].n++;cm[c].s+=b.students;cm[c].t+=b.teachers;cm[c].e+=getEstimate(b);});
    var ck=Object.keys(cm).sort(function(a,b){return cm[b].n-cm[a].n;});
    if(ck.length>1||ck[0]!=='미분류'){
      r+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">';
      ck.forEach(function(k){var g=cm[k];
        r+='<div style="background:#f5f9f5;border:1px solid #c8e6c9;border-radius:8px;padding:8px 12px;min-width:110px;">';
        r+='<div style="font-weight:800;font-size:12px;color:#1a472a;">'+k+'</div>';
        r+='<div style="font-size:11px;color:#555;">'+g.n+'건 · '+g.s+'명 · ₩'+fmtWon(g.e)+'</div></div>';
      });
      r+='</div>';
    }
    return r;
  }

  // ===== 2. Today =====
  h+=buildSection('오늘 예약','📌',todayList);
  // ===== 3. Pending =====
  h+=buildSection('대기 중','⏳',pendList);
  // ===== 4. Confirmed =====
  h+=buildSection('확정','✅',confList);
  // ===== 5. This month =====
  h+=buildSection('이번달 전체','📅',monthList);

  // ===== 6. AI Analysis =====
  h+='<h2 style="'+S.h2+'">🤖 AI 종합 분석</h2>';
  h+='<div style="background:linear-gradient(135deg,#f8fffe,#eef7f2);border:1px solid #a5d6a7;border-radius:12px;padding:16px 20px;line-height:1.8;font-size:13px;color:#333;">';
  var ai=getReportAIAnalysis(todayList,pendList,confList,monthList,monthPaidList);
  h+=ai;
  h+='</div>';

  // Footer
  h+='<div style="text-align:center;margin-top:24px;padding:12px;border-top:2px solid #ddd;font-size:11px;color:#aaa;">'+facName+' 데일리 리포트 — '+now.toLocaleString('ko-KR')+'</div>';
  h+='</div>';

  // Show as overlay
  var ov=document.getElementById('_rptOverlay');
  if(ov)ov.remove();
  ov=document.createElement('div');
  ov.id='_rptOverlay';
  ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:#fff;overflow-y:auto;-webkit-overflow-scrolling:touch;';
  var bar=document.createElement('div');
  bar.style.cssText='position:sticky;top:0;background:#1a472a;padding:8px 16px;display:flex;gap:8px;justify-content:flex-end;z-index:100000;';
  var bp=document.createElement('button');bp.textContent='🖨️ 인쇄/PDF';bp.style.cssText='padding:8px 16px;background:#fff;color:#1a472a;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;';bp.onclick=function(){window.print();};
  var bc=document.createElement('button');bc.textContent='✕ 닫기';bc.style.cssText='padding:8px 16px;background:#c62828;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;';bc.onclick=function(){document.getElementById('_rptOverlay').remove();};
  bar.appendChild(bp);bar.appendChild(bc);ov.appendChild(bar);
  var ct=document.createElement('div');ct.style.cssText='padding:24px;max-width:1000px;margin:0 auto;';ct.innerHTML=h;ov.appendChild(ct);
  document.body.appendChild(ov);ov.scrollTop=0;
  toast('📋 데일리 리포트 생성 완료','s');
}

// ===== REVENUE STATISTICS =====

// ===== AUTO SEND SETTINGS =====
function toggleAutoSendPanel(){
  var p=document.getElementById('autoSendPanel');
  if(!p)return;
  if(p.style.display==='none'){
    p.style.display='block';loadAutoSend();
  }else{p.style.display='none';}
}
function loadAutoSend(){
  var cfg=JSON.parse(localStorage.getItem(FP+'autosend')||'null')||{kakao:true,sms:false,time:'08:00',phone:'',type:'today',freq:'daily'};
  var tk=document.getElementById('tgKakaoDaily');
  var ts=document.getElementById('tgSmsDaily');
  if(tk){if(cfg.kakao)tk.classList.add('on');else tk.classList.remove('on');}
  if(ts){if(cfg.sms)ts.classList.add('on');else ts.classList.remove('on');}
  var t=document.getElementById('autoSendTime');if(t)t.value=cfg.time||'08:00';
  var ph=document.getElementById('autoSendPhone');if(ph)ph.value=cfg.phone||'';
  var ty=document.getElementById('autoSendType');if(ty)ty.value=cfg.type||'today';
  var fr=document.getElementById('autoSendFreq');if(fr)fr.value=cfg.freq||'daily';
  updateAutoSendStatus(cfg);
}
function saveAutoSend(){
  var cfg={
    kakao:document.getElementById('tgKakaoDaily').classList.contains('on'),
    sms:document.getElementById('tgSmsDaily').classList.contains('on'),
    time:(document.getElementById('autoSendTime')||{}).value||'08:00',
    phone:(document.getElementById('autoSendPhone')||{}).value||'',
    type:(document.getElementById('autoSendType')||{}).value||'today',
    freq:(document.getElementById('autoSendFreq')||{}).value||'daily'
  };
  try{localStorage.setItem(FP+'autosend',JSON.stringify(cfg));}catch(e){}
  updateAutoSendStatus(cfg);
}
function updateAutoSendStatus(cfg){
  var el=document.getElementById('autoSendStatus');
  if(!el)return;
  var methods=[];
  if(cfg.kakao)methods.push('카카오톡');
  if(cfg.sms)methods.push('문자');
  if(!methods.length){el.innerHTML='⚠️ 자동발송이 비활성화 상태입니다.';return;}
  var freqLabel={'daily':'매일','weekday':'평일','weekly':'매주 월요일'};
  var typeLabel={'today':'오늘 예약','pending':'대기 중','confirmed':'확정','month':'이번달','monthEst':'이달 견적'};
  el.innerHTML='✅ <strong>'+methods.join(' + ')+'</strong>로 '+(freqLabel[cfg.freq]||'매일')+' '+(cfg.time||'08:00')+'에 <strong>'+(typeLabel[cfg.type]||'오늘 예약')+'</strong> 리포트가 '+(cfg.phone||'(연락처 미입력)')+'으로 발송됩니다.';
}
function testAutoSend(method){
  var d=_getStatList((document.getElementById('autoSendType')||{}).value||'today');
  var list=d.list;
  var phone=(document.getElementById('autoSendPhone')||{}).value;
  if(!phone){toast('수신 연락처를 입력하세요','e');return;}
  var facName=curFac?curFac.name:'시설';
  var totStu=list.reduce(function(s,b){return s+b.students;},0);
  var totTea=list.reduce(function(s,b){return s+b.teachers;},0);
  var totEst=list.reduce(function(s,b){return s+getEstimate(b);},0);

  // Build message
  var msg='['+facName+' 데일리리포트]\\n';
  msg+='📅 '+td()+' '+d.title+'\\n';
  msg+='━━━━━━━━━━━\\n';
  msg+='총 '+list.length+'건 / '+(totStu+totTea)+'명\\n';
  msg+='아동 '+totStu+'명 · 인솔 '+totTea+'명\\n';
  msg+='견적: ₩'+fmtWon(totEst)+'\\n';
  if(list.length>0){
    msg+='━━━━━━━━━━━\\n';
    list.slice(0,10).forEach(function(b){
      msg+=b.date.substring(5)+' '+b.name+' '+(b.category||'')+' '+b.students+'명 '+b.status+'\\n';
    });
    if(list.length>10)msg+='...외 '+(list.length-10)+'건\\n';
  }

  if(method==='kakao'){
    var url='https://sharer.kakao.com/talk/friends/picker/shorturl?url='+encodeURIComponent('data:text/plain,'+msg);
    try{
      var kakaoMsg=encodeURIComponent(msg.replace(/\\n/g,'\n'));
      window.open('https://accounts.kakao.com/login?continue=https://sharer.kakao.com','_blank','width=500,height=600');
      toast('💬 카카오톡 앱에서 발송해주세요. 메시지가 클립보드에 복사됩니다.','s');
      copyToClip(msg.replace(/\\\\n/g,'\n'));
    }catch(e){
      toast('카카오톡 앱으로 발송해주세요','e');
    }
  }else{
    var smsBody=encodeURIComponent(msg.replace(/\\n/g,'\n'));
    var smsUrl='sms:'+phone+'?body='+smsBody;
    try{window.open(smsUrl,'_self');}catch(e){}
    toast('📱 문자 앱이 열립니다','s');
  }
}
function copyToClip(text){
  try{
    if(navigator.clipboard){navigator.clipboard.writeText(text);}
    else{var ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}
  }catch(e){}
}

// ===== REVENUE STATISTICS (continued) =====
let revPeriod='month';
function setRevPeriod(p){revPeriod=p;renderRevenue();}

function getEstimate(b,useActual){
  if(!useActual){
    if(b.customQuote)return b.customQuote.reduce((s,i)=>s+i.total,0);
    // Strip actual-only fields for regular estimate
    const reg={...b};
    delete reg.actualEntryPrices;delete reg.actualAddonQty;delete reg.actualMealQty;
    try{return calcQuote(reg).grandTotal;}catch(e){return 0;}
  }
  if(b.actualStudents==null)return getEstimate(b);
  const tmp={...b,
    students:b.actualStudents,
    studentsChild:b.actualStudentsChild||0,
    studentsElem:b.actualStudentsElem||0,
    teachers:b.actualTeachers!=null?b.actualTeachers:b.teachers,
    addons:b.actualAddons!=null?b.actualAddons.map(a=>a):[],
    actualAddonQty:b.actualAddonQty||[],
    meal:b.actualMeal!=null?b.actualMeal:'',
    actualMealQty:b.actualMealQty||null
  };
  try{return calcQuote(tmp).grandTotal;}catch(e){return 0;}
}

let _revRange='1m';
function setRevRange(r){
  _revRange=r;
  const now=new Date();const fmt=d=>d.toISOString().split('T')[0];
  if(r==='custom'){renderRevenue();return;}
  let from='',to='';
  if(r!=='all')to=fmt(now);
  if(r==='1m'){const d=new Date(now);d.setMonth(d.getMonth()-1);from=fmt(d);}
  else if(r==='3m'){const d=new Date(now);d.setMonth(d.getMonth()-3);from=fmt(d);}
  else if(r==='6m'){const d=new Date(now);d.setMonth(d.getMonth()-6);from=fmt(d);}
  else if(r==='1y'){const d=new Date(now);d.setFullYear(d.getFullYear()-1);from=fmt(d);}
  document.getElementById('rvFrom').value=from;
  document.getElementById('rvTo').value=to;
  renderRevenue();
}

function renderRevenue(){
  let active=bks.filter(b=>b.status!=='취소');

  // Apply date range filter
  const rvFrom=document.getElementById('rvFrom')?.value||'';
  const rvTo=document.getElementById('rvTo')?.value||'';
  if(rvFrom)active=active.filter(b=>b.date>=rvFrom);
  if(rvTo)active=active.filter(b=>b.date<=rvTo);

  // Highlight buttons
  ['day','week','month'].forEach(p=>{const el=document.getElementById('rv_'+p);if(el){el.style.background=p===revPeriod?'var(--p)':'#eee';el.style.color=p===revPeriod?'#fff':'#333';}});
  ['1m','3m','6m','1y','all'].forEach(k=>{const el=document.getElementById('rr_'+k);if(el){el.style.background=_revRange===k?'#555':'#eee';el.style.color=_revRange===k?'#fff':'#333';}});

  // Period label
  const plEl=document.getElementById('revPeriodLabel');
  if(plEl){
    if(rvFrom||rvTo){const cnt=active.length;plEl.innerHTML=`📆 ${rvFrom||'시작'} ~ ${rvTo||td()} | ${cnt}건`;}
    else plEl.innerHTML='';
  }

  // Group data by period
  const groups={};
  const today=new Date();

  active.forEach(b=>{
    let key;
    if(revPeriod==='day')key=b.date;
    else if(revPeriod==='week'){
      const d=new Date(b.date);const dayOfWeek=d.getDay();
      const mon=new Date(d);mon.setDate(d.getDate()-((dayOfWeek+6)%7));
      key=mon.toISOString().split('T')[0];
    } else key=b.date.substring(0,7);

    if(!groups[key])groups[key]={est:0,paid:0,paidCount:0,count:0};
    groups[key].est+=getEstimate(b);
    if(b.paidAmount!=null){groups[key].paid+=b.paidAmount;groups[key].paidCount++;}
    groups[key].count++;
  });

  // Sort keys and limit
  let keys=Object.keys(groups).sort();
  const hasFilter=rvFrom||rvTo;
  if(!hasFilter){
    if(revPeriod==='day')keys=keys.slice(-14);
    else if(revPeriod==='week')keys=keys.slice(-12);
    else keys=keys.slice(-12);
  } else {
    if(revPeriod==='day')keys=keys.slice(-60);
    else if(revPeriod==='week')keys=keys.slice(-52);
    else keys=keys.slice(-24);
  }

  const totalEst=keys.reduce((s,k)=>s+groups[k].est,0);
  const totalPaid=keys.reduce((s,k)=>s+groups[k].paid,0);
  const diff=totalPaid-totalEst;

  // Summary cards
  document.getElementById('revSummary').innerHTML=`
    <div style="padding:14px;background:#e8f5e9;border-radius:10px;text-align:center;">
      <div style="font-size:10px;color:#666;">견적 합계</div>
      <div style="font-size:18px;font-weight:900;color:var(--p);">₩${fmtWon(totalEst)}</div>
    </div>
    <div style="padding:14px;background:#e3f2fd;border-radius:10px;text-align:center;">
      <div style="font-size:10px;color:#666;">실결제 합계</div>
      <div style="font-size:18px;font-weight:900;color:#1565C0;">₩${fmtWon(totalPaid)}</div>
    </div>
    <div style="padding:14px;background:${diff>=0?'#e8f5e9':'#fce4ec'};border-radius:10px;text-align:center;">
      <div style="font-size:10px;color:#666;">차액</div>
      <div style="font-size:18px;font-weight:900;color:${diff>=0?'var(--grn)':'#c62828'};">${diff>=0?'+':''}₩${fmtWon(diff)}</div>
    </div>`;

  // Bar chart
  if(!keys.length){document.getElementById('revChart').innerHTML='<div style="text-align:center;color:#aaa;padding:40px;">데이터 없음</div>';document.getElementById('revTable').innerHTML='';return;}

  const maxVal=Math.max(...keys.map(k=>Math.max(groups[k].est,groups[k].paid)),1);
  const barW=Math.max(20,Math.min(60,Math.floor(700/keys.length)-10));

  let chartH=`<div style="display:flex;align-items:flex-end;gap:4px;height:220px;padding:0 4px;overflow-x:auto;">`;
  keys.forEach(k=>{
    const g=groups[k];
    const hE=Math.max(2,Math.round(g.est/maxVal*200));
    const hP=Math.max(2,Math.round(g.paid/maxVal*200));
    const lbl=revPeriod==='month'?fmtMo(k):revPeriod==='week'?k.substring(5)+'~':(k.substring(5).replace('-','/'));
    chartH+=`<div style="display:flex;flex-direction:column;align-items:center;flex-shrink:0;width:${barW*2+6}px;">
      <div style="display:flex;gap:2px;align-items:flex-end;height:200px;">
        <div style="width:${barW}px;height:${hE}px;background:linear-gradient(180deg,#66bb6a,#388e3c);border-radius:4px 4px 0 0;position:relative;" title="견적 ₩${fmtWon(g.est)}"></div>
        <div style="width:${barW}px;height:${hP}px;background:linear-gradient(180deg,#42a5f5,#1565C0);border-radius:4px 4px 0 0;position:relative;" title="실결제 ₩${fmtWon(g.paid)}"></div>
      </div>
      <div style="font-size:9px;color:#888;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:${barW*2+6}px;text-align:center;">${lbl}</div>
    </div>`;
  });
  chartH+=`</div>
  <div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:10px;">
    <span><span style="display:inline-block;width:10px;height:10px;background:#388e3c;border-radius:2px;margin-right:3px;"></span>견적액</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#1565C0;border-radius:2px;margin-right:3px;"></span>실결제액</span>
  </div>`;
  document.getElementById('revChart').innerHTML=chartH;

  // Table
  const periodLabel=revPeriod==='day'?'일자':revPeriod==='week'?'주차':'월';
  document.getElementById('revTable').innerHTML=`
    <table class="tbl" style="font-size:11px;"><thead><tr>
      <th>${periodLabel}</th><th>팀수</th><th>견적액</th><th>실결제액</th><th>차액</th><th>입금율</th>
    </tr></thead><tbody>
    ${keys.map(k=>{const g=groups[k];const d=g.paid-g.est;const rate=g.est>0?Math.round(g.paid/g.est*100):0;
      return `<tr><td style="font-weight:600;">${revPeriod==='month'?k:revPeriod==='week'?k.substring(5)+'주':k.substring(5).replace('-','/')}</td>
      <td>${g.count}</td>
      <td style="color:var(--p);font-weight:600;">₩${fmtWon(g.est)}</td>
      <td style="color:#1565C0;font-weight:600;">₩${fmtWon(g.paid)}</td>
      <td style="color:${d>=0?'var(--grn)':'#c62828'};font-weight:600;">${d>=0?'+':''}₩${fmtWon(d)}</td>
      <td><div style="background:#eee;border-radius:10px;height:14px;width:80px;overflow:hidden;"><div style="height:100%;width:${Math.min(100,rate)}%;background:${rate>=100?'var(--grn)':rate>=70?'var(--org)':'#c62828'};border-radius:10px;"></div></div><span style="font-size:9px;">${rate}%</span></td></tr>`;
    }).join('')}
    </tbody></table>`;
  generateRevInsight();
}

function setDrRange(r){
 try{
  const now=new Date(),t=td();
  let from='',to='';
  if(r==='today'){from=t;to=t;}
  else if(r==='week'){
    const d=new Date();d.setDate(d.getDate()-((d.getDay()+6)%7));
    from=d.toISOString().split('T')[0];
    const s=new Date(d);s.setDate(d.getDate()+6);to=s.toISOString().split('T')[0];
  }else if(r==='month'){from=t.substring(0,7)+'-01';to=t;}
  else if(r==='3m'){const d=new Date();d.setMonth(d.getMonth()-3);from=d.toISOString().split('T')[0];to=t;}
  else if(r==='6m'){const d=new Date();d.setMonth(d.getMonth()-6);from=d.toISOString().split('T')[0];to=t;}
  else if(r==='year'){from=t.substring(0,4)+'-01-01';to=t;}
  else{from='';to='';}
  document.getElementById('drFrom').value=from;
  document.getElementById('drTo').value=to;
  if(r==='all'){renderDrPreview(true);}else{renderDrPreview();}
 }catch(ex){alert('기간설정 오류: '+ex.message);}
}

function applyDrFilter(){
  renderDrPreview();
}

function renderDrPreview(forceAll){
  var el=document.getElementById('drPreview');
  if(!el)return;
  var from=document.getElementById('drFrom')?document.getElementById('drFrom').value:'';
  var to=document.getElementById('drTo')?document.getElementById('drTo').value:'';
  if(!from&&!to&&!forceAll){el.style.display='none';el.innerHTML='';return;}
  var rangeLabel=forceAll?'전체 기간':(from||'시작')+' ~ '+(to||td());
  var list=bks.filter(function(b){return b.status!=='취소';});
  if(from)list=list.filter(function(b){return b.date>=from;});
  if(to)list=list.filter(function(b){return b.date<=to;});
  list.sort(function(a,b){return a.date>b.date?1:-1;});

  var totStu=list.reduce(function(s,b){return s+b.students;},0);
  var totTea=list.reduce(function(s,b){return s+b.teachers;},0);
  var totEst=list.reduce(function(s,b){return s+getEstimate(b);},0);
  var totPaid=list.filter(function(b){return b.paidAmount!=null;}).reduce(function(s,b){return s+b.paidAmount;},0);
  var pend=list.filter(function(b){return b.status==='대기';}).length;
  var conf=list.filter(function(b){return b.status==='확정';}).length;

  var h='<div class="card" style="margin:0;border:2px solid var(--p);">';
  h+='<div class="cbd">';
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
  h+='<h3 style="font-size:15px;font-weight:800;color:var(--p);">🔍 조회 결과: '+rangeLabel+' ('+list.length+'건)</h3>';
  h+='<div style="display:flex;gap:6px;"><button onclick="exportDrPreviewExcel()" style="padding:5px 12px;background:#1a472a;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">📥 엑셀</button>';
  h+='<button onclick="document.getElementById(\'drPreview\').style.display=\'none\'" style="background:none;border:none;cursor:pointer;font-size:16px;color:#aaa;">✕</button></div></div>';

  // Summary cards
  h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:14px;">';
  [{v:list.length+'건',l:'총 예약',c:'#1a472a'},{v:(totStu+totTea)+'명',l:'총 인원',c:'#1565c0'},{v:pend+'건',l:'대기',c:'#e65100'},{v:conf+'건',l:'확정',c:'#2e7d32'},{v:'₩'+fmtWon(totEst),l:'견적합계',c:'#1a472a'},{v:'₩'+fmtWon(totPaid),l:'실결제',c:'#1565c0'}].forEach(function(x){
    h+='<div style="background:#f5f9f5;border-radius:8px;padding:10px;text-align:center;"><div style="font-size:18px;font-weight:900;color:'+x.c+';">'+x.v+'</div><div style="font-size:11px;color:#777;">'+x.l+'</div></div>';
  });
  h+='</div>';

  // Table
  if(list.length>0){
    h+='<div style="overflow-x:auto;max-height:400px;overflow-y:auto;"><table style="width:100%;border-collapse:collapse;font-size:11px;">';
    h+='<thead style="position:sticky;top:0;"><tr style="background:#f0f7f0;">';
    ['날짜','단체명','구분','시간','아동','인솔','견적','실결제','상태'].forEach(function(c){h+='<th style="padding:6px 8px;border:1px solid #e0e0e0;font-weight:700;white-space:nowrap;">'+c+'</th>';});
    h+='</tr></thead><tbody>';
    var t=td();
    list.forEach(function(b){
      var bg=b.date===t?'background:#fffde7;':'';
      var stC=b.status==='확정'?'color:#2e7d32;':b.status==='대기'?'color:#e65100;':'color:#888;';
      h+='<tr style="'+bg+'">';
      h+='<td style="padding:5px 8px;border:1px solid #eee;font-weight:600;white-space:nowrap;">'+b.date+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;font-weight:700;color:#1a472a;">'+b.name+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;font-size:10px;">'+(b.category||'미분류')+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;white-space:nowrap;">'+b.arrival+'~'+b.departure+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:center;">'+b.students+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:center;">'+b.teachers+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:right;">₩'+fmtWon(getEstimate(b))+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:right;">'+(b.paidAmount!=null?'₩'+fmtWon(b.paidAmount):'-')+'</td>';
      h+='<td style="padding:5px 8px;border:1px solid #eee;text-align:center;font-weight:700;'+stC+'">'+b.status+'</td>';
      h+='</tr>';
    });
    h+='<tr style="background:#f0f7f0;font-weight:700;">';
    h+='<td colspan="4" style="padding:6px 8px;border:1px solid #e0e0e0;">합계 ('+list.length+'건)</td>';
    h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:center;">'+totStu+'</td>';
    h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:center;">'+totTea+'</td>';
    h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:right;">₩'+fmtWon(totEst)+'</td>';
    h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:right;">₩'+fmtWon(totPaid)+'</td>';
    h+='<td style="padding:6px 8px;border:1px solid #e0e0e0;text-align:center;">'+(totStu+totTea)+'명</td>';
    h+='</tr></tbody></table></div>';

    // Category breakdown
    var catMap={};
    list.forEach(function(b){var c=b.category||'미분류';if(!catMap[c])catMap[c]={n:0,s:0,t:0,e:0};catMap[c].n++;catMap[c].s+=b.students;catMap[c].t+=b.teachers;catMap[c].e+=getEstimate(b);});
    var catKeys=Object.keys(catMap).sort(function(a,b){return catMap[b].n-catMap[a].n;});
    if(catKeys.length>0){
      h+='<div style="margin-top:12px;font-size:12px;font-weight:800;color:var(--p);margin-bottom:6px;">📊 구분별 현황</div>';
      h+='<div style="display:flex;gap:8px;flex-wrap:wrap;">';
      catKeys.forEach(function(k){var g=catMap[k];
        h+='<div style="background:#f5f9f5;border:1px solid #c8e6c9;border-radius:8px;padding:8px 12px;min-width:110px;">';
        h+='<div style="font-weight:800;font-size:12px;color:#1a472a;">'+k+'</div>';
        h+='<div style="font-size:11px;color:#555;">'+g.n+'건 · '+(g.s+g.t)+'명 · ₩'+fmtWon(g.e)+'</div></div>';
      });
      h+='</div>';
    }
  }else{
    h+='<div style="text-align:center;padding:20px;color:#aaa;">해당 기간에 예약이 없습니다.</div>';
  }

  // AI insight
  var pendAll=bks.filter(function(b){return b.status==='대기';});
  var confAll=bks.filter(function(b){return b.status==='확정';});
  var mo=td().substring(0,7);
  var mList=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});
  var mPaidList=mList.filter(function(b){return b.paidAmount!=null;});
  h+='<div style="margin-top:12px;">'+insightBox(getReportAIAnalysis(list.filter(function(b){return b.date===td();}),pendAll,confAll,mList,mPaidList))+'</div>';

  h+='</div></div>';
  el.innerHTML=h;
  el.style.display='block';
  el.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function exportDrPreviewExcel(){
  var from=document.getElementById('drFrom')?document.getElementById('drFrom').value:'';
  var to=document.getElementById('drTo')?document.getElementById('drTo').value:'';
  var list=bks.filter(function(b){return b.status!=='취소';});
  if(from)list=list.filter(function(b){return b.date>=from;});
  if(to)list=list.filter(function(b){return b.date<=to;});
  if(!list.length){toast('데이터가 없습니다','e');return;}
  // Temporarily override _getStatList
  window._drOverride={list:list,title:'조회_'+(from||'시작')+'~'+(to||td())};
  exportStatExcel('__drPreview__');
  window._drOverride=null;
}

function doDailyReport(){
  const btn=document.getElementById('drDlBtn');
  if(btn)btn.textContent='⏳ 생성중...';
  setTimeout(function(){
    try{exportDailyReport();}catch(e){alert('리포트 오류: '+e.message);}
    if(btn)btn.textContent='📥 리포트 다운로드';
  },100);
}

function exportDailyReport(){
  var drFrom=document.getElementById('drFrom')?document.getElementById('drFrom').value:'';
  var drTo=document.getElementById('drTo')?document.getElementById('drTo').value:'';
  var today=td();
  var now=new Date();
  var active=bks.filter(function(b){return b.status!=='취소';});

  var rangeActive=active;
  if(drFrom)rangeActive=rangeActive.filter(function(b){return b.date>=drFrom;});
  if(drTo)rangeActive=rangeActive.filter(function(b){return b.date<=drTo;});
  var rangeLabel=(drFrom||drTo)?(drFrom||'시작')+' ~ '+(drTo||td()):'전체 기간';

  // Inline style constants
  var S={
    h1:'font-size:20px;color:#1a472a;border-bottom:3px solid #1a472a;padding-bottom:8px;margin-bottom:4px;',
    h2:'font-size:15px;color:#2d6a4f;margin:20px 0 8px;border-left:4px solid #2d6a4f;padding-left:8px;',
    h3:'font-size:13px;color:#555;margin:14px 0 6px;',
    tbl:'border-collapse:collapse;width:100%;margin-bottom:12px;font-size:11px;',
    th:'border:1px solid #ccc;padding:5px 8px;text-align:center;background:#f0f7f0;font-weight:700;font-size:11px;',
    td:'border:1px solid #ccc;padding:5px 8px;text-align:center;font-size:11px;',
    sum:'display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;',
    sc:'flex:1;min-width:110px;padding:12px;border-radius:8px;text-align:center;',
    val:'font-size:18px;font-weight:900;',
    lbl:'font-size:10px;color:#666;margin-top:2px;',
    grn:'background:#e8f5e9;color:#1a472a;',
    blu:'background:#e3f2fd;color:#1565c0;',
    org:'background:#fff3e0;color:#e65100;',
    red:'background:#fce4ec;color:#c62828;',
    gry:'background:#f5f5f5;color:#555;',
    r:'text-align:right;',
    l:'text-align:left;',
    b:'font-weight:700;'
  };
  function SC(val,lbl,bg){return '<div style="'+S.sc+bg+'"><div style="'+S.val+'">'+val+'</div><div style="'+S.lbl+'">'+lbl+'</div></div>';}
  function TH(v){return '<th style="'+S.th+'">'+v+'</th>';}
  function TD(v,extra){return '<td style="'+S.td+(extra||'')+'">'+v+'</td>';}

  var h='<div style="font-family:-apple-system,sans-serif;color:#222;font-size:12px;">';
  h+='<h1 style="'+S.h1+'">🏕️ 잠사박물관 플레이팜 — 리포트</h1>';
  h+='<div style="font-size:11px;color:#888;margin-bottom:16px;">작성일시: '+now.toLocaleString('ko-KR')+' | 조회기간: <strong style="color:#1a472a;">'+rangeLabel+'</strong> | 총 '+rangeActive.length+'건</div>';

  // 1. Summary
  var todayBks=active.filter(function(b){return b.date===today;});
  var todayPpl=todayBks.reduce(function(s,b){return s+(b.students||0)+(b.teachers||0);},0);
  var pending=bks.filter(function(b){return b.status==='대기';}).length;
  var confirmed=bks.filter(function(b){return b.status==='확정';}).length;
  var rangeEst=rangeActive.reduce(function(s,b){return s+getEstimate(b);},0);
  var rangePaid=rangeActive.filter(function(b){return b.paidAmount!=null;}).reduce(function(s,b){return s+b.paidAmount;},0);
  var rangePpl=rangeActive.reduce(function(s,b){return s+(b.students||0)+(b.teachers||0);},0);

  h+='<h2 style="'+S.h2+'">📌 현황 요약</h2>';
  h+='<div style="'+S.sum+'">';
  h+=SC(todayBks.length+'건','오늘 예약 ('+todayPpl+'명)',S.grn);
  h+=SC(pending,'대기 중',S.org);
  h+=SC(confirmed,'확정',S.blu);
  h+='</div>';
  h+='<h3 style="'+S.h3+'">조회기간 ('+rangeLabel+')</h3>';
  h+='<div style="'+S.sum+'">';
  h+=SC(rangeActive.length+'건','예약 ('+rangePpl+'명)',S.grn);
  h+=SC('₩'+fmtWon(rangeEst),'견적 합계',S.grn);
  h+=SC('₩'+fmtWon(rangePaid),'실결제 합계',S.blu);
  h+=SC('₩'+fmtWon(rangePaid-rangeEst),'차액',rangePaid-rangeEst>=0?S.grn:S.red);
  h+='</div>';

  // 2. Today detail
  if(todayBks.length){
    h+='<h3 style="'+S.h3+'">오늘 예약 상세</h3><table style="'+S.tbl+'"><thead><tr>';
    ['단체명','시간','아동','인솔','코스','견적','상태'].forEach(function(v){h+=TH(v);});
    h+='</tr></thead><tbody>';
    todayBks.forEach(function(b){
      h+='<tr>'+TD(b.name,S.l+S.b)+TD(b.arrival+'~'+b.departure)+TD(b.students)+TD(b.teachers)+TD(b.courseType||'')+TD('₩'+fmtWon(getEstimate(b)),S.r)+TD(b.status)+'</tr>';
    });
    h+='</tbody></table>';
  }

  // 3. Revenue by month
  h+='<h2 style="'+S.h2+'">💰 매출 통계 (월별)</h2>';
  var mGroups={};
  rangeActive.forEach(function(b){
    var k=b.date.substring(0,7);
    if(!mGroups[k])mGroups[k]={est:0,paid:0,count:0,people:0};
    mGroups[k].est+=getEstimate(b);
    if(b.paidAmount!=null)mGroups[k].paid+=b.paidAmount;
    mGroups[k].count++;mGroups[k].people+=(b.students||0)+(b.teachers||0);
  });
  var mKeys=Object.keys(mGroups).sort();
  h+='<table style="'+S.tbl+'"><thead><tr>';
  ['월','팀수','인원','견적액','실결제','차액','입금율'].forEach(function(v){h+=TH(v);});
  h+='</tr></thead><tbody>';
  mKeys.forEach(function(k){
    var g=mGroups[k],d=g.paid-g.est,rate=g.est>0?Math.round(g.paid/g.est*100):0;
    h+='<tr>'+TD(k,S.b)+TD(g.count)+TD(g.people+'명')+TD('₩'+fmtWon(g.est),S.r+'color:#1a472a;')+TD('₩'+fmtWon(g.paid),S.r+'color:#1565c0;')+TD('₩'+fmtWon(d),S.r+'color:'+(d>=0?'#27ae60':'#c62828')+';')+TD(rate+'%')+'</tr>';
  });
  h+='</tbody></table>';

  // 4. Category stats
  h+='<h2 style="'+S.h2+'">🏢 단체유형별 통계</h2>';
  var catGroups={};
  rangeActive.forEach(function(b){
    var cat=b.category||'미분류';
    if(!catGroups[cat])catGroups[cat]={count:0,people:0,est:0};
    catGroups[cat].count++;catGroups[cat].people+=(b.students||0)+(b.teachers||0);
    catGroups[cat].est+=getEstimate(b);
  });
  h+='<table style="'+S.tbl+'"><thead><tr>';
  ['유형','예약건','비율','인원','견적액'].forEach(function(v){h+=TH(v);});
  h+='</tr></thead><tbody>';
  Object.keys(catGroups).sort(function(a,b){return catGroups[b].count-catGroups[a].count;}).forEach(function(k){
    var g=catGroups[k],pct=rangeActive.length>0?Math.round(g.count/rangeActive.length*100):0;
    h+='<tr>'+TD(k,S.l+S.b)+TD(g.count+'건')+TD(pct+'%')+TD(g.people+'명')+TD('₩'+fmtWon(g.est),S.r)+'</tr>';
  });
  h+='</tbody></table>';

  // 5. Booking list
  h+='<h2 style="'+S.h2+'">📋 예약 목록 ('+rangeActive.length+'건)</h2>';
  h+='<table style="'+S.tbl+'"><thead><tr>';
  ['날짜','단체명','시간','아동','인솔','견적','실결제','상태'].forEach(function(v){h+=TH(v);});
  h+='</tr></thead><tbody>';
  rangeActive.slice().sort(function(a,b){return a.date>b.date?1:-1;}).forEach(function(b){
    var bg=b.date===today?'background:#fffde7;':'';
    h+='<tr style="'+bg+'">'+TD(b.date,S.b)+TD(b.name,S.l)+TD(b.arrival+'~'+b.departure)+TD(b.students)+TD(b.teachers)+TD('₩'+fmtWon(getEstimate(b)),S.r)+TD(b.paidAmount!=null?'₩'+fmtWon(b.paidAmount):'-',S.r)+TD(b.status)+'</tr>';
  });
  h+='</tbody></table>';

  // AI Analysis
  var mo=today.substring(0,7);
  var mList=bks.filter(function(b){return b.date.startsWith(mo)&&b.status!=='취소';});
  var mPaidList=mList.filter(function(b){return b.paidAmount!=null;});
  var todayBksAll=active.filter(function(b){return b.date===today;});
  var pendAll=bks.filter(function(b){return b.status==='대기';});
  var confAll=bks.filter(function(b){return b.status==='확정';});
  h+='<h2 style="'+S.h2+'">🤖 AI 종합 분석</h2>';
  h+='<div style="background:linear-gradient(135deg,#f8fffe,#eef7f2);border:1px solid #a5d6a7;border-radius:12px;padding:16px 20px;line-height:1.8;font-size:13px;color:#333;">';
  h+=getReportAIAnalysis(todayBksAll,pendAll,confAll,mList,mPaidList);
  h+='</div>';

  h+='<div style="text-align:center;margin-top:24px;padding:12px;border-top:2px solid #ddd;font-size:10px;color:#aaa;">잠사박물관 플레이팜 리포트 ('+rangeLabel+') — '+now.toLocaleString('ko-KR')+' 생성</div>';
  h+='</div>';

  // Display as overlay
  var ov=document.getElementById('_rptOverlay');
  if(ov)ov.remove();
  ov=document.createElement('div');
  ov.id='_rptOverlay';
  ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:#fff;overflow-y:auto;-webkit-overflow-scrolling:touch;';
  var bar=document.createElement('div');
  bar.id='_rptBar';
  bar.style.cssText='position:sticky;top:0;background:#1a472a;padding:8px 16px;display:flex;gap:8px;justify-content:flex-end;z-index:100000;';
  var btnPrint=document.createElement('button');
  btnPrint.textContent='🖨️ 인쇄/PDF';
  btnPrint.style.cssText='padding:8px 16px;background:#fff;color:#1a472a;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;';
  btnPrint.onclick=function(){window.print();};
  var btnClose=document.createElement('button');
  btnClose.textContent='✕ 닫기';
  btnClose.style.cssText='padding:8px 16px;background:#c62828;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;';
  btnClose.onclick=function(){document.getElementById('_rptOverlay').remove();};
  bar.appendChild(btnPrint);
  bar.appendChild(btnClose);
  ov.appendChild(bar);
  var content=document.createElement('div');
  content.style.cssText='padding:24px;max-width:1000px;margin:0 auto;';
  content.innerHTML=h;
  ov.appendChild(content);
  document.body.appendChild(ov);
  ov.scrollTop=0;
  toast('📥 리포트 생성 완료','s');
}

function exportRevExcel(){
  let active=bks.filter(b=>b.status!=='취소');
  const rvFrom=document.getElementById('rvFrom')?.value||'';
  const rvTo=document.getElementById('rvTo')?.value||'';
  if(rvFrom)active=active.filter(b=>b.date>=rvFrom);
  if(rvTo)active=active.filter(b=>b.date<=rvTo);

  const groups={};
  active.forEach(b=>{
    let key;
    if(revPeriod==='day')key=b.date;
    else if(revPeriod==='week'){
      const d=new Date(b.date);const dayOfWeek=d.getDay();
      const mon=new Date(d);mon.setDate(d.getDate()-((dayOfWeek+6)%7));
      key=mon.toISOString().split('T')[0];
    } else key=b.date.substring(0,7);
    if(!groups[key])groups[key]={est:0,paid:0,count:0,people:0};
    groups[key].est+=getEstimate(b);
    if(b.paidAmount!=null)groups[key].paid+=b.paidAmount;
    groups[key].count++;
    groups[key].people+=(b.students||0)+(b.teachers||0);
  });
  const keys=Object.keys(groups).sort();
  const periodLabel=revPeriod==='day'?'일자':revPeriod==='week'?'주차':'월';
  const periodFile=revPeriod==='day'?'일별':revPeriod==='week'?'주별':'월별';
  const rangeLabel=rvFrom||rvTo?`${rvFrom||'시작'}~${rvTo||'현재'}`:'전체';

  let csv='\uFEFF';
  csv+=`잠사박물관 매출통계 (${periodFile})\n`;
  csv+=`기간,${rangeLabel}\n`;
  csv+=`작성일,${td()}\n\n`;

  // Summary
  const totalEst=keys.reduce((s,k)=>s+groups[k].est,0);
  const totalPaid=keys.reduce((s,k)=>s+groups[k].paid,0);
  csv+=`견적합계,${totalEst}\n`;
  csv+=`실결제합계,${totalPaid}\n`;
  csv+=`차액,${totalPaid-totalEst}\n\n`;

  // Period table
  csv+=`${periodLabel},팀수,인원,견적액,실결제액,차액,입금율\n`;
  keys.forEach(k=>{
    const g=groups[k];const d=g.paid-g.est;const rate=g.est>0?Math.round(g.paid/g.est*100):0;
    csv+=`${k},${g.count},${g.people},${g.est},${g.paid},${d},${rate}%\n`;
  });
  const tPpl=keys.reduce((s,k)=>s+groups[k].people,0);
  const tCnt=keys.reduce((s,k)=>s+groups[k].count,0);
  csv+=`합계,${tCnt},${tPpl},${totalEst},${totalPaid},${totalPaid-totalEst},${totalEst>0?Math.round(totalPaid/totalEst*100):0}%\n\n`;

  // Detail booking list
  csv+=`\n[예약 상세]\n`;
  csv+=`날짜,단체명,카테고리,유형,아동,인솔,견적액,실결제액,상태,채널\n`;
  active.sort((a,b)=>a.date.localeCompare(b.date)).forEach(b=>{
    csv+=`${b.date},"${b.name}",${b.category||''},${b.courseType||''},${b.students||0},${b.teachers||0},${getEstimate(b)},${b.paidAmount||0},${b.status},${b.channel||''}\n`;
  });

  {const _a=document.createElement('a');_a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'application/vnd.ms-excel;charset=utf-8'}));_a.download=`매출통계_${periodFile}_${rangeLabel.replace(/~/g,'-')}_${td()}.xls`;_a.style.display='none';document.body.appendChild(_a);_a.click();setTimeout(()=>{document.body.removeChild(_a);},300);}
  toast('📥 매출통계 엑셀 다운로드','s');
}

// ===== AGENCY SYSTEM =====
let agencies=[];
let curAgency=null;
function svAg(){try{localStorage.setItem(FP+'agencies',JSON.stringify(agencies));}catch(e){}}

function doAgencyLogin(){
  const code=document.getElementById('agCode').value.trim();
  const pw=document.getElementById('agPw').value;
  const ag=agencies.find(a=>a.code===code&&a.pw===pw);
  if(!ag){toast('대행사 코드 또는 비밀번호 오류','e');return;}
  if(ag.active===false){toast('⛔ 비활성화된 대행사입니다. 관리자에게 문의하세요.','e');return;}
  curAgency=ag;mode='agency';
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  setupNav();
}

// Agency list in settings
function renderAgencyList(){
  const el=document.getElementById('agencyList');if(!el)return;
  if(!agencies.length){el.innerHTML='<div style="color:#aaa;font-size:12px;padding:12px;text-align:center;">등록된 대행사가 없습니다.</div>';return;}
  el.innerHTML=agencies.map((a,i)=>{
    const isActive=a.active!==false;
    const bkCount=bks.filter(b=>b.agency===a.code&&b.status!=='취소').length;
    const pFees=a.periodFees||[];
    return `<div style="padding:12px;margin-bottom:8px;border-radius:10px;border:2px solid ${isActive?'#e65100':'#ccc'};background:${isActive?'#fff8e1':'#f5f5f5'};${!isActive?'opacity:0.6;':''}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:14px;font-weight:800;color:${isActive?'#e65100':'#999'};">${a.name}</span>
          <span style="font-size:9px;padding:2px 8px;border-radius:10px;background:${isActive?'#e8f5e9':'#ffebee'};color:${isActive?'#2e7d32':'#c62828'};font-weight:600;">${isActive?'✅ 활성':'⛔ 비활성'}</span>
          <span style="font-size:9px;color:#888;">예약 ${bkCount}건</span>
        </div>
        <div style="display:flex;gap:4px;">
          <button onclick="toggleAgency(${i})" style="font-size:10px;padding:4px 10px;border:1px solid ${isActive?'#c62828':'#2e7d32'};background:${isActive?'#ffebee':'#e8f5e9'};color:${isActive?'#c62828':'#2e7d32'};border-radius:6px;cursor:pointer;font-weight:600;">${isActive?'⛔ 비활성화':'✅ 활성화'}</button>
          <button onclick="expelAgency(${i})" style="font-size:10px;padding:4px 10px;border:1px solid #c62828;background:#ffebee;color:#c62828;border-radius:6px;cursor:pointer;font-weight:600;">🚫 강제탈퇴</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;">
        <div class="fg"><label style="font-size:9px;color:#999;">대행사명</label><input value="${a.name}" onchange="agencies[${i}].name=this.value;svAg();" style="padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;font-weight:600;"></div>
        <div class="fg"><label style="font-size:9px;color:#999;">로그인코드</label><input value="${a.code}" onchange="agencies[${i}].code=this.value;svAg();" style="padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;"></div>
        <div class="fg"><label style="font-size:9px;color:#999;">비밀번호</label><input value="${a.pw}" onchange="agencies[${i}].pw=this.value;svAg();" style="padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;"></div>
        <div class="fg"><label style="font-size:9px;color:#999;">기본 수수료(%)</label><input type="number" value="${a.fee||0}" onchange="agencies[${i}].fee=+this.value;svAg();" style="padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;text-align:right;"></div>
      </div>
      <div style="margin-top:8px;padding:8px;background:rgba(230,81,0,0.05);border-radius:8px;border:1px dashed #e6510044;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:11px;font-weight:700;color:#e65100;">📅 기간별 수수료</span>
          <button onclick="addPeriodFee(${i})" style="font-size:10px;padding:2px 10px;border:1px solid #e65100;background:#fff3e0;color:#e65100;border-radius:5px;cursor:pointer;">+ 추가</button>
        </div>
        ${pFees.length?pFees.map((pf,j)=>`<div style="display:flex;gap:4px;align-items:center;margin-bottom:4px;flex-wrap:wrap;">
          <input type="month" value="${pf.from||''}" onchange="agencies[${i}].periodFees[${j}].from=this.value;svAg();" style="padding:3px 6px;font-size:11px;border:1px solid #ddd;border-radius:4px;width:120px;" title="시작월">
          <span style="font-size:10px;">~</span>
          <input type="month" value="${pf.to||''}" onchange="agencies[${i}].periodFees[${j}].to=this.value;svAg();" style="padding:3px 6px;font-size:11px;border:1px solid #ddd;border-radius:4px;width:120px;" title="종료월">
          <input type="number" value="${pf.rate}" onchange="agencies[${i}].periodFees[${j}].rate=+this.value;svAg();" style="padding:3px 6px;font-size:11px;border:1px solid #ddd;border-radius:4px;width:50px;text-align:right;" title="수수료율">
          <span style="font-size:10px;">%</span>
          <button onclick="agencies[${i}].periodFees.splice(${j},1);svAg();renderAgencyList();" style="background:#fdd;color:#c00;border:none;border-radius:4px;padding:2px 6px;font-size:10px;cursor:pointer;">✕</button>
        </div>`).join(''):`<div style="font-size:10px;color:#aaa;">기간별 수수료 없음 → 기본 수수료(${a.fee||0}%) 적용</div>`}
      </div>
    </div>`;
  }).join('');
}

function addPeriodFee(agIdx){
  if(!agencies[agIdx].periodFees)agencies[agIdx].periodFees=[];
  const now=new Date();const mo=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
  agencies[agIdx].periodFees.push({from:mo,to:mo,rate:agencies[agIdx].fee||0});
  svAg();renderAgencyList();
}

// Resolve fee rate: booking.feeRate > periodFee > agency.fee
function getAgencyFee(code,b){
  if(b&&b.feeRate!=null)return b.feeRate;
  const ag=agencies.find(a=>a.code===code);if(!ag)return 0;
  if(ag.periodFees&&ag.periodFees.length&&b){
    const bMo=b.date.substring(0,7);
    const pf=ag.periodFees.find(p=>(!p.from||bMo>=p.from)&&(!p.to||bMo<=p.to));
    if(pf)return pf.rate;
  }
  return ag.fee||0;
}

function toggleAgency(i){
  agencies[i].active=agencies[i].active===false?true:false;
  svAg();renderAgencyList();
  toast(agencies[i].active!==false?`✅ "${agencies[i].name}" 활성화`:`⛔ "${agencies[i].name}" 비활성화`,'s');
}

function expelAgency(i){
  const ag=agencies[i];
  const bkCount=bks.filter(b=>b.agency===ag.code&&b.status!=='취소').length;
  const msg=bkCount>0?`"${ag.name}" 대행사를 강제탈퇴합니다.\n\n⚠️ 이 대행사의 기존 예약 ${bkCount}건은 유지되지만,\n더 이상 로그인 및 새 예약이 불가합니다.\n\n정말 탈퇴시키겠습니까?`:`"${ag.name}" 대행사를 강제탈퇴합니다.\n정말 삭제하시겠습니까?`;
  if(!confirm(msg))return;
  const name=ag.name;
  agencies.splice(i,1);svAg();renderAgencyList();
  toast(`🚫 "${name}" 대행사 강제탈퇴 완료`,'s');
}
function addAgency(){
  const name=document.getElementById('ag_newName').value.trim();
  const code=document.getElementById('ag_newCode').value.trim();
  const pw=document.getElementById('ag_newPw').value.trim();
  const fee=parseInt(document.getElementById('ag_newFee').value)||0;
  if(!name||!code||!pw){toast('모든 항목을 입력하세요','e');return;}
  if(agencies.find(a=>a.code===code)){toast('이미 사용 중인 코드','e');return;}
  agencies.push({name,code,pw,fee,active:true});svAg();
  document.getElementById('ag_newName').value='';document.getElementById('ag_newCode').value='';document.getElementById('ag_newPw').value='';document.getElementById('ag_newFee').value='';
  renderAgencyList();toast(`🏢 "${name}" 대행사 등록 완료`,'s');
}

// Agency booking page
function initAgBk(){
  const el=document.getElementById('agBookingForm');
  if(document.getElementById('agNameTitle'))document.getElementById('agNameTitle').textContent=curAgency.name;
  const fc=formCfg;
  const tOpts=Array.from({length:19},(_,i)=>{const h=8+Math.floor(i/2),m=i%2?'30':'00';return `${String(h).padStart(2,'0')}:${m}`;}).map(t=>`<option>${t}</option>`).join('');
  el.innerHTML=`
  <div class="card"><div class="cbd"><h3 style="font-size:14px;font-weight:800;color:#e65100;margin-bottom:12px;">📋 예약 정보</h3>
    <div class="fgrid">
      <div class="fg"><label>방문일 *</label><input type="date" id="ag_dt"></div>
      <div class="fg"><label>단체명 *</label><input type="text" id="ag_nm" placeholder="예: 해피어린이집"></div>
      <div class="fg"><label>단체유형 *</label><select id="ag_cat" style="width:100%;padding:9px 12px;border:2px solid var(--bd);border-radius:9px;font-size:13px;">
        <option>어린이집</option><option>유치원</option><option>초등학교</option><option>중학교</option><option>복지기관</option><option>기타</option></select></div>
      <div class="fg"><label>입장시간 *</label><select id="ag_ar">${tOpts}</select></div>
      <div class="fg"><label>퇴장시간 *</label><select id="ag_dp">${tOpts}</select></div>
      <div class="fg"><label>유아 인원</label><input type="number" id="ag_st1" value="0"></div>
      <div class="fg"><label>초등 인원</label><input type="number" id="ag_st2" value="0"></div>
      <div class="fg"><label>인솔자</label><input type="number" id="ag_tc" value="0"></div>
      <div class="fg"><label>연락처 *</label><input type="tel" id="ag_ph" placeholder="010-0000-0000"></div>
      <div class="fg"><label>이메일</label><input type="email" id="ag_em"></div>
    </div>
  </div></div>
  <div class="card"><div class="cbd"><h3 style="font-size:14px;font-weight:800;color:#e65100;margin-bottom:12px;">🍚 단체식</h3>
    <div class="rgrp"><label><input type="radio" name="ag_ml" value="이용안함" checked> 이용안함</label>
    ${fc.meals.map(m=>`<label><input type="radio" name="ag_ml" value="${m.name}"> ${m.name}</label>`).join('')}</div>
  </div></div>
  <div class="card"><div class="cbd"><h3 style="font-size:14px;font-weight:800;color:#e65100;margin-bottom:12px;">🎨 부가체험</h3>
    <div class="rgrp">${fc.addons.map(a=>`<label><input type="checkbox" class="ag_adc" value="${a.name}"> ${a.name} (₩${fmtWon(a.price)})</label>`).join('')}</div>
  </div></div>
  <div class="card"><div class="cbd">
    <div class="fg"><label style="color:#F57F17;font-weight:700;">📝 요청사항 / 특이사항</label><textarea id="ag_etc" rows="3" placeholder="알레르기, 식이제한, 휠체어 이용, 특별 요청 등을 입력해주세요." style="border:2px solid #FFB300;background:#FFFDE7;border-radius:8px;padding:10px;font-size:13px;line-height:1.5;resize:vertical;"></textarea></div>
  </div></div>
  <button class="btn" style="background:linear-gradient(135deg,#e65100,#f57c00);color:#fff;width:100%;padding:14px;font-size:15px;font-weight:700;border-radius:12px;margin-top:8px;" onclick="submitAgBk()">📨 예약 신청</button>`;
  const dpSel=el.querySelector('#ag_dp');if(dpSel)dpSel.selectedIndex=Math.min(6,dpSel.options.length-1);
}

function submitAgBk(){
  const dt=document.getElementById('ag_dt').value,nm=document.getElementById('ag_nm').value.trim();
  const ar=document.getElementById('ag_ar').value,dp=document.getElementById('ag_dp').value;
  const st1=parseInt(document.getElementById('ag_st1').value)||0,st2=parseInt(document.getElementById('ag_st2').value)||0;
  const st=st1+st2,tc=parseInt(document.getElementById('ag_tc').value)||0;
  const ph=document.getElementById('ag_ph').value.trim(),cat=document.getElementById('ag_cat').value;
  if(!dt||!nm||!ar||!dp||!st||!ph){toast('필수 항목을 모두 입력하세요','e');return;}
  if(ti(dp)<=ti(ar)){toast('퇴장>입장 시간이어야 합니다','e');return;}
  const ml=document.querySelector('input[name="ag_ml"]:checked')?.value||'';
  const hasMeal=ml!=='이용안함'&&ml!=='';
  const ct=hasMeal?'기본코스+단체식':'기본코스';
  const ad=[...document.querySelectorAll('.ag_adc:checked')].map(c=>c.value);

  const bk={id:nid++,date:dt,name:nm,category:cat,arrival:ar,departure:dp,students:st,studentsChild:st1,studentsElem:st2,ageGroup:st1&&st2?'혼합':st2?'초등':'유아',teachers:tc,courseType:ct,meal:ml,phone:ph,email:document.getElementById('ag_em').value,addons:ad,etc:document.getElementById('ag_etc').value,status:'대기',channel:'대행사',agency:curAgency.code,agencyName:curAgency.name,created:td()};
  pushUndo('입력',`[대행사] ${nm} ${dt} 예약 접수`,JSON.stringify(bks));
  bks.push(bk);sv();
  sendK('admin',`[대행사:${curAgency.name}] `+admMsg(bk));
  toast(`✅ "${nm}" 예약 접수!`,'s');
  document.getElementById('ag_nm').value='';document.getElementById('ag_st1').value='0';document.getElementById('ag_st2').value='0';document.getElementById('ag_etc').value='';
}

// Agency my bookings
function renderAgMyBk(){
  if(document.getElementById('agNameTitle2'))document.getElementById('agNameTitle2').textContent=curAgency.name;
  const allMyBks=bks.filter(b=>b.agency===curAgency.code).sort((a,b)=>b.date.localeCompare(a.date));
  const selMo=document.getElementById('agm_month')?.value||'';
  const myBks=selMo?allMyBks.filter(b=>b.date.startsWith(selMo)):allMyBks;
  const active=myBks.filter(b=>b.status!=='취소');
  const estTotal=active.reduce((s,b)=>s+getEstimate(b),0);
  const paidTotal=active.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+b.paidAmount,0);
  const feeTotal=active.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+Math.round(b.paidAmount*getAgencyFee(curAgency.code,b)/100),0);
  const avgFee=active.length?Math.round(active.reduce((s,b)=>s+getAgencyFee(curAgency.code,b),0)/active.length*10)/10:0;

  document.getElementById('agSummaryCards').innerHTML=`
    <div style="padding:12px;background:#fff3e0;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">총 예약</div><div style="font-size:22px;font-weight:900;color:#e65100;">${active.length}건</div></div>
    <div style="padding:12px;background:#e8f5e9;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">견적합계</div><div style="font-size:16px;font-weight:900;color:var(--p);">₩${fmtWon(estTotal)}</div></div>
    <div style="padding:12px;background:#e3f2fd;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">실결제</div><div style="font-size:16px;font-weight:900;color:#1565C0;">₩${fmtWon(paidTotal)}</div></div>
    <div style="padding:12px;background:#f3e5f5;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">수수료(평균${avgFee}%)</div><div style="font-size:16px;font-weight:900;color:#7b1fa2;">₩${fmtWon(feeTotal)}</div></div>`;

  // Month filter + Excel
  let filterHtml=`<div class="card"><div class="cbd" style="padding:12px 18px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <input type="month" id="agm_month" value="${selMo}" onchange="renderAgMyBk()" style="border:2px solid var(--bd);border-radius:8px;padding:7px 10px;font-size:12px;">
    <button class="btn bo bs" onclick="exportAgMyExcel()">📥 엑셀</button>
    <span style="font-size:11px;color:#888;margin-left:auto;">${selMo?selMo+' 필터':'전체 기간'} · ${myBks.length}건</span>
  </div></div>`;

  // Booking list with actions
  let listHtml='';
  if(myBks.length){
    // Group by month
    const grouped={};
    myBks.forEach(b=>{const mo=b.date.substring(0,7);if(!grouped[mo])grouped[mo]=[];grouped[mo].push(b);});
    const moKeys=Object.keys(grouped).sort().reverse();

    listHtml=moKeys.map(mo=>{
      const mBks=grouped[mo];
      const mEst=mBks.filter(b=>b.status!=='취소').reduce((s,b)=>s+getEstimate(b),0);
      const mPaid=mBks.filter(b=>b.status!=='취소'&&b.paidAmount!=null).reduce((s,b)=>s+b.paidAmount,0);
      return `<div class="card" style="margin-bottom:12px;">
        <div class="chd" style="display:flex;justify-content:space-between;align-items:center;">
          <h3>${mo} <span style="font-size:11px;color:#888;font-weight:400;">${mBks.length}건 · 견적 ₩${fmtWon(mEst)} · 실결제 ₩${fmtWon(mPaid)}</span></h3>
        </div>
        <div class="cbd" style="overflow-x:auto;">
        <table class="tbl" style="font-size:11px;"><thead><tr><th>날짜</th><th>단체명</th><th>유형</th><th>인원</th><th>상태</th><th>견적</th><th>실결제</th><th>수수료</th><th>관리</th></tr></thead><tbody>
        ${mBks.map(b=>{
          const sc=b.status==='확정'?'bdg-g':b.status==='대기'?'bdg-y':'bdg-r';
          const q=getEstimate(b);
          const bFee=getAgencyFee(curAgency.code,b);
          const bFeeAmt=b.paidAmount!=null?Math.round(b.paidAmount*bFee/100):0;
          const canEdit=b.status!=='취소';
          return `<tr><td>${b.date}</td><td style="font-weight:600;">${b.name}</td><td>${b.category||'-'}</td>
            <td>${b.students}+${b.teachers}${b.actualStudents!=null?`<br><span style="color:#c2185b;font-size:9px;">실제 ${b.actualStudents}+${b.actualTeachers!=null?b.actualTeachers:b.teachers}</span>`:''}</td><td><span class="bdg ${sc}">${b.status}</span></td>
            <td>₩${fmtWon(q)}</td><td>${b.paidAmount!=null?'₩'+fmtWon(b.paidAmount):'-'}</td>
            <td style="color:#7b1fa2;font-size:10px;">${bFee}%${b.feeRate!=null?' <span style="color:#e65100;">(건별)</span>':''}${b.paidAmount!=null?'<br>₩'+fmtWon(bFeeAmt):''}</td>
            <td style="white-space:nowrap;">
              <button class="btn bg bs" onclick="dlQuote(${b.id},'견적서')" style="font-size:9px;padding:3px 6px;">견적</button>
              <button class="btn bb bs" onclick="dlQuote(${b.id},'거래내역서')" style="font-size:9px;padding:3px 6px;">거래</button>
              ${b.actualStudents!=null?`<button class="btn bs" onclick="dlQuote(${b.id},'거래내역서(실제인원)')" style="font-size:9px;padding:3px 6px;background:#fce4ec;color:#c2185b;">실제</button>`:''}
              ${canEdit?`<button class="btn bs" style="background:#fff3e0;color:#e65100;font-size:9px;padding:3px 6px;" onclick="agEditBk(${b.id})">수정</button>`:''}
            </td></tr>`;
        }).join('')}
        </tbody></table></div></div>`;
    }).join('');
  } else {
    listHtml='<div style="text-align:center;color:#aaa;padding:40px;">예약 내역 없음</div>';
  }

  document.getElementById('agBookingList').innerHTML=filterHtml+listHtml;
}

// Agency edit booking
function agEditBk(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const tOpts=Array.from({length:19},(_,i)=>{const h=8+Math.floor(i/2),m=i%2?'30':'00';return `${String(h).padStart(2,'0')}:${m}`;});
  const arOpts=tOpts.map(t=>`<option ${b.arrival===t?'selected':''}>${t}</option>`).join('');
  const dpOpts=tOpts.map(t=>`<option ${b.departure===t?'selected':''}>${t}</option>`).join('');

  document.getElementById('mtl').textContent='✏️ 예약 수정 — '+b.name;
  document.getElementById('mdlBd').innerHTML=`<div style="font-size:13px;">
    <div class="fgrid" style="gap:10px;">
      <div class="fg"><label>방문일 *</label><input type="date" id="age_dt" value="${b.date}"></div>
      <div class="fg"><label>단체명 *</label><input type="text" id="age_nm" value="${b.name}"></div>
      <div class="fg"><label>단체유형</label><select id="age_cat">${['어린이집','유치원','초등학교','중학교','복지기관','기타'].map(c=>`<option ${b.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
      <div class="fg"><label>입장시간</label><select id="age_ar">${arOpts}</select></div>
      <div class="fg"><label>퇴장시간</label><select id="age_dp">${dpOpts}</select></div>
      <div class="fg"><label>유아 인원</label><input type="number" id="age_st1" value="${b.studentsChild||0}"></div>
      <div class="fg"><label>초등 인원</label><input type="number" id="age_st2" value="${b.studentsElem||0}"></div>
      <div class="fg"><label>인솔자</label><input type="number" id="age_tc" value="${b.teachers}"></div>
      <div class="fg"><label>연락처</label><input type="tel" id="age_ph" value="${b.phone}"></div>
      <div class="fg"><label>이메일</label><input type="email" id="age_em" value="${b.email||''}"></div>
    </div>
    <div style="margin-top:10px;"><label style="font-size:12px;font-weight:600;">단체식</label>
      <div class="rgrp"><label><input type="radio" name="age_ml" value="이용안함" ${!b.meal||b.meal==='이용안함'?'checked':''}> 이용안함</label>
      ${formCfg.meals.map(m=>`<label><input type="radio" name="age_ml" value="${m.name}" ${b.meal===m.name?'checked':''}> ${m.name}</label>`).join('')}</div>
    </div>
    <div class="fg" style="margin-top:8px;"><label>요청사항</label><textarea id="age_etc">${b.etc||''}</textarea></div>
  </div>`;
  document.getElementById('mft').innerHTML=`
    <button class="btn" style="background:#e65100;color:#fff;" onclick="saveAgEdit(${b.id})">💾 저장</button>
    <button class="btn bgy bs" onclick="cMdl()">닫기</button>`;
  document.getElementById('mdl').classList.add('show');
}

function saveAgEdit(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const dt=document.getElementById('age_dt').value,nm=document.getElementById('age_nm').value.trim();
  const ar=document.getElementById('age_ar').value,dp=document.getElementById('age_dp').value;
  const st1=parseInt(document.getElementById('age_st1').value)||0;
  const st2=parseInt(document.getElementById('age_st2').value)||0;
  const tc=parseInt(document.getElementById('age_tc').value)||0;
  const ph=document.getElementById('age_ph').value.trim();
  if(!dt||!nm||!ph){toast('필수 항목을 입력하세요','e');return;}
  b.date=dt;b.name=nm;b.category=document.getElementById('age_cat').value;
  b.arrival=ar;b.departure=dp;b.students=st1+st2;b.studentsChild=st1;b.studentsElem=st2;b.teachers=tc;
  b.phone=ph;b.email=document.getElementById('age_em').value;
  b.meal=document.querySelector('input[name="age_ml"]:checked')?.value||'';
  const hasMeal=b.meal!=='이용안함'&&b.meal!=='';
  b.courseType=hasMeal?'기본코스+단체식':'기본코스';
  b.etc=document.getElementById('age_etc').value;
  b.customQuote=null;sv();
  cMdl();renderAgMyBk();
  toast('✅ 예약 수정 완료','s');
}

// Agency Excel export
function exportAgMyExcel(){
  const selMo=document.getElementById('agm_month')?.value||'';
  const myBks=bks.filter(b=>b.agency===curAgency.code&&(!selMo||b.date.startsWith(selMo))).sort((a,b)=>a.date.localeCompare(b.date));
  let csv='\uFEFF날짜,단체명,단체유형,유아,초등,인솔,상태,코스,단체식,견적액,실결제,연락처,이메일,요청사항\n';
  myBks.forEach(b=>{
    csv+=`${b.date},${b.name},${b.category||''},${b.studentsChild||0},${b.studentsElem||0},${b.teachers},${b.status},${b.courseType},${b.meal||''},${getEstimate(b)},${b.paidAmount||0},${b.phone},${b.email||''},${(b.etc||'').replace(/,/g,' ')}\n`;
  });
  {const _a=document.createElement('a');_a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'application/vnd.ms-excel;charset=utf-8'}));_a.download=`${curAgency.name}_예약_${selMo||'전체'}.xls`;_a.style.display='none';document.body.appendChild(_a);_a.click();setTimeout(()=>{document.body.removeChild(_a);},300);}
  toast('📥 엑셀 다운로드','s');
}

// Agency settlement page
function renderAgSettle(){
  if(!curAgency)return;
  const el3=document.getElementById('agNameTitle3');if(el3)el3.textContent=curAgency.name;
  const myBks=bks.filter(b=>b.agency===curAgency.code&&b.status!=='취소');

  // Load biz info
  const biz=JSON.parse(localStorage.getItem(FP+'agbiz_'+curAgency.code)||'{}');
  ['bizName','bizNo','bizCeo','bizType','bizItem','bizAddr','bizTel','bizEmail'].forEach(k=>{
    const el=document.getElementById('ags_'+k);if(el)el.value=biz[k]||'';
  });
  // Load saved images
  const bizPrev=document.getElementById('ags_bizImgPreview');
  if(bizPrev)bizPrev.innerHTML=biz.bizImgData?`<img src="${biz.bizImgData}" style="max-width:100%;max-height:180px;border-radius:8px;border:1px solid #ddd;">`:'';
  const bankPrev=document.getElementById('ags_bankImgPreview');
  if(bankPrev)bankPrev.innerHTML=biz.bankImgData?`<img src="${biz.bankImgData}" style="max-width:100%;max-height:180px;border-radius:8px;border:1px solid #ddd;">`:'';

  // Load bank info
  const bankInfo=JSON.parse(localStorage.getItem(FP+'agbank_'+curAgency.code)||'{}');
  const bi=document.getElementById('ags_bank');if(bi)bi.value=bankInfo.bank||'';
  const ai=document.getElementById('ags_acct');if(ai)ai.value=bankInfo.acct||'';
  const hi=document.getElementById('ags_holder');if(hi)hi.value=bankInfo.holder||'';

  // Period filter
  const pfrom=document.getElementById('ags_periodFrom')?.value||'';
  const pto=document.getElementById('ags_periodTo')?.value||'';

  // Monthly breakdown with per-booking fee
  const months={};
  myBks.forEach(b=>{
    const mo=b.date.substring(0,7);
    if(!months[mo])months[mo]={count:0,people:0,est:0,paid:0,fee:0};
    months[mo].count++;months[mo].people+=b.students+b.teachers;
    months[mo].est+=getEstimate(b);
    if(b.paidAmount!=null){months[mo].paid+=b.paidAmount;months[mo].fee+=Math.round(b.paidAmount*getAgencyFee(curAgency.code,b)/100);}
  });
  const allMoKeys=Object.keys(months).sort();
  const moKeys=allMoKeys.filter(mo=>(!pfrom||mo>=pfrom)&&(!pto||mo<=pto));

  const totalPaid=moKeys.reduce((s,k)=>s+months[k].paid,0);
  const totalFee=moKeys.reduce((s,k)=>s+months[k].fee,0);
  const totalEst=moKeys.reduce((s,k)=>s+months[k].est,0);
  const totalCount=moKeys.reduce((s,k)=>s+months[k].count,0);

  // Top summary
  document.getElementById('agSettleSummary').innerHTML=`
    <div style="padding:12px;background:#e8f5e9;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">총 견적</div><div style="font-size:16px;font-weight:900;color:var(--p);">₩${fmtWon(totalEst)}</div></div>
    <div style="padding:12px;background:#e3f2fd;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">총 실결제</div><div style="font-size:16px;font-weight:900;color:#1565C0;">₩${fmtWon(totalPaid)}</div></div>
    <div style="padding:12px;background:#f3e5f5;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">수수료합계</div><div style="font-size:18px;font-weight:900;color:#7b1fa2;">₩${fmtWon(totalFee)}</div></div>
    <div style="padding:12px;background:#fff3e0;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">총 예약건</div><div style="font-size:18px;font-weight:900;color:#e65100;">${totalCount}건</div></div>`;

  // Period summary
  const periodLabel=pfrom&&pto?`${pfrom} ~ ${pto}`:pfrom?`${pfrom} ~`:pto?`~ ${pto}`:'전체기간';
  document.getElementById('agPeriodSummary').innerHTML=`
    <div style="padding:10px;background:#fafafa;border-radius:8px;text-align:center;border:1px solid #eee;"><div style="font-size:9px;color:#888;">기간</div><div style="font-size:12px;font-weight:700;">${periodLabel}</div></div>
    <div style="padding:10px;background:#fafafa;border-radius:8px;text-align:center;border:1px solid #eee;"><div style="font-size:9px;color:#888;">기간 실결제</div><div style="font-size:14px;font-weight:900;color:#1565C0;">₩${fmtWon(totalPaid)}</div></div>
    <div style="padding:10px;background:#fafafa;border-radius:8px;text-align:center;border:1px solid #eee;"><div style="font-size:9px;color:#888;">기간 수수료</div><div style="font-size:14px;font-weight:900;color:#7b1fa2;">₩${fmtWon(totalFee)}</div></div>
    <div style="padding:10px;background:#fafafa;border-radius:8px;text-align:center;border:1px solid #eee;"><div style="font-size:9px;color:#888;">월평균 수수료</div><div style="font-size:14px;font-weight:900;color:#e65100;">₩${fmtWon(moKeys.length?Math.round(totalFee/moKeys.length):0)}</div></div>`;

  // Bar chart for monthly fees
  if(moKeys.length){
    const maxFee=Math.max(...moKeys.map(k=>months[k].fee),1);
    let ch=`<div style="display:flex;align-items:flex-end;gap:4px;height:140px;overflow-x:auto;">`;
    moKeys.forEach(mo=>{
      const g=months[mo];
      const hFee=Math.max(3,Math.round(g.fee/maxFee*120));
      const hPaid=Math.max(3,Math.round(g.paid/Math.max(...moKeys.map(k=>months[k].paid),1)*120));
      ch+=`<div style="display:flex;flex-direction:column-reverse;align-items:center;flex-shrink:0;width:50px;">
        <div style="font-size:9px;color:#888;margin-top:3px;">${fmtMo(mo)}</div>
        <div style="display:flex;gap:2px;align-items:flex-end;">
          <div style="width:18px;height:${hPaid}px;background:#90caf9;border-radius:3px 3px 0 0;" title="실결제 ₩${fmtWon(g.paid)}"></div>
          <div style="width:18px;height:${hFee}px;background:#ab47bc;border-radius:3px 3px 0 0;" title="수수료 ₩${fmtWon(g.fee)}"></div>
        </div>
      </div>`;
    });
    ch+=`</div><div style="display:flex;gap:12px;justify-content:center;margin-top:6px;font-size:10px;">
      <span><span style="display:inline-block;width:10px;height:10px;background:#90caf9;border-radius:2px;margin-right:3px;"></span>실결제</span>
      <span><span style="display:inline-block;width:10px;height:10px;background:#ab47bc;border-radius:2px;margin-right:3px;"></span>수수료</span></div>`;
    document.getElementById('agSettleChart').innerHTML=ch;
  } else {
    document.getElementById('agSettleChart').innerHTML='';
  }

  // Monthly table
  document.getElementById('agSettleTable').innerHTML=moKeys.length?`
    <table class="tbl" style="font-size:11px;"><thead><tr><th>월</th><th>예약건</th><th>인원</th><th>견적합계</th><th>실결제</th><th>수수료</th><th>정산상태</th></tr></thead><tbody>
    ${moKeys.map(mo=>{const g=months[mo];
      const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+curAgency.code)||'{}');
      const st=settles[mo];
      const badge=st?`<span class="bdg bdg-g" style="font-size:9px;">✅ ${st.status||'저장됨'}</span>`:'<span class="bdg bdg-y" style="font-size:9px;">미정산</span>';
      return `<tr><td style="font-weight:700;">${mo}</td><td>${g.count}</td><td>${g.people}명</td>
        <td style="color:var(--p);">₩${fmtWon(g.est)}</td><td style="color:#1565C0;">₩${fmtWon(g.paid)}</td>
        <td style="color:#7b1fa2;font-weight:700;">₩${fmtWon(g.fee)}</td><td>${badge}</td></tr>`;
    }).join('')}
    <tr style="background:#f5f5f5;font-weight:800;"><td>합계</td><td>${totalCount}</td><td>${moKeys.reduce((s,k)=>s+months[k].people,0)}명</td>
      <td style="color:var(--p);">₩${fmtWon(totalEst)}</td><td style="color:#1565C0;">₩${fmtWon(totalPaid)}</td><td style="color:#7b1fa2;">₩${fmtWon(totalFee)}</td><td></td></tr>
    </tbody></table>`:'<div style="text-align:center;color:#aaa;padding:20px;">정산 데이터 없음</div>';

  // YoY comparison
  renderAgYoy(months,allMoKeys);
  renderAgSavedDocs();
  renderAgExportLog();
}

function renderAgYoy(months,allMoKeys){
  const thisYear=new Date().getFullYear();
  const lastYear=thisYear-1;
  const tyKeys=allMoKeys.filter(k=>k.startsWith(String(thisYear)));
  const lyKeys=allMoKeys.filter(k=>k.startsWith(String(lastYear)));

  if(!lyKeys.length&&!tyKeys.length){
    document.getElementById('agYoyChart').innerHTML='<div style="text-align:center;color:#aaa;padding:20px;">비교 데이터 없음</div>';
    document.getElementById('agYoyTable').innerHTML='';return;
  }

  // Build 12-month comparison
  const compare=[];
  for(let m=1;m<=12;m++){
    const mm=String(m).padStart(2,'0');
    const lyK=lastYear+'-'+mm;const tyK=thisYear+'-'+mm;
    const lyD=months[lyK]||{fee:0,paid:0,count:0};
    const tyD=months[tyK]||{fee:0,paid:0,count:0};
    compare.push({month:m,lyFee:lyD.fee,tyFee:tyD.fee,lyPaid:lyD.paid,tyPaid:tyD.paid,lyCount:lyD.count,tyCount:tyD.count});
  }

  // Chart
  const maxV=Math.max(...compare.map(c=>Math.max(c.lyFee,c.tyFee)),1);
  let ch=`<div style="display:flex;align-items:flex-end;gap:3px;height:130px;overflow-x:auto;">`;
  compare.forEach(c=>{
    const hLy=Math.max(1,Math.round(c.lyFee/maxV*110));
    const hTy=Math.max(1,Math.round(c.tyFee/maxV*110));
    ch+=`<div style="display:flex;flex-direction:column-reverse;align-items:center;flex-shrink:0;width:44px;">
      <div style="font-size:9px;color:#888;margin-top:3px;">${c.month}월</div>
      <div style="display:flex;gap:1px;align-items:flex-end;">
        <div style="width:16px;height:${c.lyFee?hLy:0}px;background:#bdbdbd;border-radius:2px 2px 0 0;" title="${lastYear}: ₩${fmtWon(c.lyFee)}"></div>
        <div style="width:16px;height:${c.tyFee?hTy:0}px;background:#7b1fa2;border-radius:2px 2px 0 0;" title="${thisYear}: ₩${fmtWon(c.tyFee)}"></div>
      </div>
    </div>`;
  });
  ch+=`</div><div style="display:flex;gap:12px;justify-content:center;margin-top:6px;font-size:10px;">
    <span><span style="display:inline-block;width:10px;height:10px;background:#bdbdbd;border-radius:2px;margin-right:3px;"></span>${lastYear}년</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#7b1fa2;border-radius:2px;margin-right:3px;"></span>${thisYear}년</span></div>`;
  document.getElementById('agYoyChart').innerHTML=ch;

  // Table
  const lyTotal=compare.reduce((s,c)=>s+c.lyFee,0);
  const tyTotal=compare.reduce((s,c)=>s+c.tyFee,0);
  const diff=tyTotal-lyTotal;const diffPct=lyTotal?Math.round(diff/lyTotal*100):tyTotal?100:0;

  document.getElementById('agYoyTable').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;">
      <div style="padding:10px;background:#f5f5f5;border-radius:8px;text-align:center;"><div style="font-size:9px;color:#888;">${lastYear}년 수수료</div><div style="font-size:16px;font-weight:900;color:#666;">₩${fmtWon(lyTotal)}</div></div>
      <div style="padding:10px;background:#f3e5f5;border-radius:8px;text-align:center;"><div style="font-size:9px;color:#888;">${thisYear}년 수수료</div><div style="font-size:16px;font-weight:900;color:#7b1fa2;">₩${fmtWon(tyTotal)}</div></div>
      <div style="padding:10px;background:${diff>=0?'#e8f5e9':'#ffebee'};border-radius:8px;text-align:center;"><div style="font-size:9px;color:#888;">증감</div><div style="font-size:16px;font-weight:900;color:${diff>=0?'#2e7d32':'#c62828'};">${diff>=0?'+':''}₩${fmtWon(diff)} (${diff>=0?'+':''}${diffPct}%)</div></div>
    </div>
    <table class="tbl" style="font-size:11px;"><thead><tr><th>월</th><th>${lastYear} 수수료</th><th>${thisYear} 수수료</th><th>증감</th><th>${lastYear} 건수</th><th>${thisYear} 건수</th></tr></thead><tbody>
    ${compare.filter(c=>c.lyFee||c.tyFee).map(c=>{
      const d=c.tyFee-c.lyFee;const p=c.lyFee?Math.round(d/c.lyFee*100):c.tyFee?100:0;
      return `<tr><td style="font-weight:600;">${c.month}월</td>
        <td>₩${fmtWon(c.lyFee)}</td><td style="color:#7b1fa2;font-weight:700;">₩${fmtWon(c.tyFee)}</td>
        <td style="color:${d>=0?'#2e7d32':'#c62828'};font-weight:600;">${d>=0?'+':''}₩${fmtWon(d)} <span style="font-size:9px;">(${d>=0?'+':''}${p}%)</span></td>
        <td>${c.lyCount}건</td><td>${c.tyCount}건</td></tr>`;
    }).join('')}
    </tbody></table>`;
}

function saveAgBizInfo(){
  const info={};
  ['bizName','bizNo','bizCeo','bizType','bizItem','bizAddr','bizTel','bizEmail'].forEach(k=>{
    info[k]=document.getElementById('ags_'+k)?.value.trim()||'';
  });
  // Preserve saved images
  const old=JSON.parse(localStorage.getItem(FP+'agbiz_'+curAgency.code)||'{}');
  if(old.bizImgData)info.bizImgData=old.bizImgData;
  if(old.bankImgData)info.bankImgData=old.bankImgData;
  localStorage.setItem(FP+'agbiz_'+curAgency.code,JSON.stringify(info));
  const ag=agencies.find(a=>a.code===curAgency.code);
  if(ag){ag.bizInfo=info;svAg();}
  toast('💾 사업자정보 저장 완료','s');
}

function saveAgBankInfo(){
  const info={bank:document.getElementById('ags_bank').value.trim(),acct:document.getElementById('ags_acct').value.trim(),holder:document.getElementById('ags_holder').value.trim()};
  localStorage.setItem(FP+'agbank_'+curAgency.code,JSON.stringify(info));
  const ag=agencies.find(a=>a.code===curAgency.code);
  if(ag){ag.bankInfo=info;svAg();}
  toast('💾 계좌정보 저장 완료','s');
}

// Claude Vision API for OCR
async function callClaudeVision(imgData, prompt){
  try{
    const base64=imgData.split(',')[1];
    const mediaType=imgData.split(';')[0].split(':')[1]||'image/jpeg';
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',max_tokens:1000,
        messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mediaType,data:base64}},
          {type:'text',text:prompt}
        ]}]
      })
    });
    const data=await res.json();
    return data.content?.map(c=>c.text||'').join('')||'';
  }catch(err){console.error('Claude Vision error:',err);return '';}
}

// Business registration OCR
function ocrBizImg(){
  const file=document.getElementById('ags_bizImg').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async function(e){
    const imgData=e.target.result;
    document.getElementById('ags_bizImgPreview').innerHTML=`<img src="${imgData}" style="max-width:100%;max-height:180px;border-radius:8px;border:1px solid #ddd;">`;
    const biz=JSON.parse(localStorage.getItem(FP+'agbiz_'+curAgency.code)||'{}');
    biz.bizImgData=imgData;localStorage.setItem(FP+'agbiz_'+curAgency.code,JSON.stringify(biz));

    const statusEl=document.getElementById('ags_bizOcrStatus');
    statusEl.innerHTML='<span style="color:#e65100;">🔄 AI가 사업자등록증을 분석중...</span>';

    const prompt=`이 사업자등록증 이미지에서 다음 정보를 JSON으로만 추출해줘. 다른 설명이나 마크다운 없이 순수 JSON만 출력해:
{"bizName":"상호명","bizNo":"사업자등록번호(000-00-00000형식)","bizCeo":"대표자명","bizType":"업태","bizItem":"종목","bizAddr":"사업장소재지"}
값이 보이지 않으면 빈 문자열로 넣어줘.`;

    const result=await callClaudeVision(imgData,prompt);
    if(result){
      try{
        const clean=result.replace(/```json|```/g,'').trim();
        const parsed=JSON.parse(clean);
        if(parsed.bizName)document.getElementById('ags_bizName').value=parsed.bizName;
        if(parsed.bizNo)document.getElementById('ags_bizNo').value=parsed.bizNo;
        if(parsed.bizCeo)document.getElementById('ags_bizCeo').value=parsed.bizCeo;
        if(parsed.bizType)document.getElementById('ags_bizType').value=parsed.bizType;
        if(parsed.bizItem)document.getElementById('ags_bizItem').value=parsed.bizItem;
        if(parsed.bizAddr)document.getElementById('ags_bizAddr').value=parsed.bizAddr;
        statusEl.innerHTML='<span style="color:#2e7d32;">✅ AI 자동입력 완료 — 결과를 확인해주세요</span>';
        toast('✅ 사업자등록증 자동입력 완료','s');
      }catch(pe){
        statusEl.innerHTML='<span style="color:#e65100;">⚠️ AI 분석 실패 — 아래 항목을 직접 입력해주세요</span>';
      }
    }else{
      statusEl.innerHTML='<span style="color:#e65100;">⚠️ AI 분석 실패 — 아래 항목을 직접 입력해주세요</span>';
    }
  };
  reader.readAsDataURL(file);
}

// Bankbook OCR
function ocrBankImg(){
  const file=document.getElementById('ags_bankImg').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async function(e){
    const imgData=e.target.result;
    document.getElementById('ags_bankImgPreview').innerHTML=`<img src="${imgData}" style="max-width:100%;max-height:180px;border-radius:8px;border:1px solid #ddd;">`;
    const biz=JSON.parse(localStorage.getItem(FP+'agbiz_'+curAgency.code)||'{}');
    biz.bankImgData=imgData;localStorage.setItem(FP+'agbiz_'+curAgency.code,JSON.stringify(biz));

    const statusEl=document.getElementById('ags_bankOcrStatus');
    statusEl.innerHTML='<span style="color:#1565C0;">🔄 AI가 통장사본을 분석중...</span>';

    const prompt=`이 통장사본 이미지에서 다음 정보를 JSON으로만 추출해줘. 다른 설명이나 마크다운 없이 순수 JSON만 출력해:
{"bank":"은행명","acct":"계좌번호","holder":"예금주"}
값이 보이지 않으면 빈 문자열로 넣어줘.`;

    const result=await callClaudeVision(imgData,prompt);
    if(result){
      try{
        const clean=result.replace(/```json|```/g,'').trim();
        const parsed=JSON.parse(clean);
        if(parsed.bank)document.getElementById('ags_bank').value=parsed.bank;
        if(parsed.acct)document.getElementById('ags_acct').value=parsed.acct;
        if(parsed.holder)document.getElementById('ags_holder').value=parsed.holder;
        statusEl.innerHTML='<span style="color:#2e7d32;">✅ AI 자동입력 완료 — 결과를 확인해주세요</span>';
        toast('✅ 통장사본 자동입력 완료','s');
      }catch(pe){
        statusEl.innerHTML='<span style="color:#1565C0;">⚠️ AI 분석 실패 — 아래 항목을 직접 입력해주세요</span>';
      }
    }else{
      statusEl.innerHTML='<span style="color:#1565C0;">⚠️ AI 분석 실패 — 아래 항목을 직접 입력해주세요</span>';
    }
  };
  reader.readAsDataURL(file);
}

let agFileData=null;
function previewAgFile(){
  const file=document.getElementById('ags_file').files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    agFileData=e.target.result;
    document.getElementById('ags_preview').innerHTML=`<img src="${agFileData}" style="max-width:100%;max-height:200px;border-radius:8px;border:2px solid var(--bd);">`;
  };
  reader.readAsDataURL(file);
}

function saveAgSettle(){
  const mo=document.getElementById('ags_month').value;
  if(!mo){toast('정산 월을 선택하세요','e');return;}
  const memo=document.getElementById('ags_memo').value.trim();
  const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+curAgency.code)||'{}');
  settles[mo]={memo,image:agFileData||settles[mo]?.image||null,status:'저장됨',date:td()};
  localStorage.setItem(FP+'agsettle_'+curAgency.code,JSON.stringify(settles));
  agFileData=null;
  document.getElementById('ags_memo').value='';document.getElementById('ags_file').value='';document.getElementById('ags_preview').innerHTML='';
  toast('💾 계산서 저장 완료','s');
  renderAgSettle();
}

function renderAgSavedDocs(){
  const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+curAgency.code)||'{}');
  const keys=Object.keys(settles).sort().reverse();
  const el=document.getElementById('ags_savedDocs');
  if(!keys.length){el.innerHTML='';return;}
  el.innerHTML=`<div style="font-size:12px;font-weight:700;margin-bottom:8px;">📋 저장된 계산서</div>`+keys.map(mo=>{
    const s=settles[mo];
    return `<div style="padding:10px;margin-bottom:8px;border:1px solid var(--bd);border-radius:8px;background:#fafafa;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <span style="font-weight:700;font-size:13px;">${mo}</span>
        <div style="display:flex;gap:4px;align-items:center;">
          <span class="bdg ${s.status==='정산요청'?'bdg-y':'bdg-g'}" style="font-size:9px;">${s.status}</span>
          <button onclick="deleteAgSettle('${mo}')" style="background:#fdd;color:#c00;border:none;border-radius:5px;padding:3px 8px;font-size:10px;cursor:pointer;">삭제</button>
        </div>
      </div>
      ${s.memo?`<div style="font-size:11px;color:#666;margin-bottom:6px;">📝 ${s.memo}</div>`:''}
      ${s.image?`<img src="${s.image}" style="max-width:100%;max-height:150px;border-radius:6px;border:1px solid #ddd;">`:''}</div>`;
  }).join('');
}

function deleteAgSettle(mo){
  if(!confirm(`${mo} 계산서를 삭제하시겠습니까?`))return;
  const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+curAgency.code)||'{}');
  delete settles[mo];
  localStorage.setItem(FP+'agsettle_'+curAgency.code,JSON.stringify(settles));
  toast('삭제 완료','s');renderAgSettle();
}

function requestAgSettle(){
  const mo=document.getElementById('ags_month').value;
  if(!mo){toast('정산 월을 선택하세요','e');return;}
  // Save status as 정산요청
  const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+curAgency.code)||'{}');
  if(!settles[mo])settles[mo]={memo:'',image:null,date:td()};
  settles[mo].status='정산요청';settles[mo].requestDate=td();
  localStorage.setItem(FP+'agsettle_'+curAgency.code,JSON.stringify(settles));

  // Calculate fee for this month
  const myBks=bks.filter(b=>b.agency===curAgency.code&&b.status!=='취소'&&b.date.startsWith(mo));
  const paid=myBks.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+b.paidAmount,0);
  const fee=myBks.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+Math.round(b.paidAmount*getAgencyFee(curAgency.code,b)/100),0);
  const bankInfo=JSON.parse(localStorage.getItem(FP+'agbank_'+curAgency.code)||'{}');
  const bankStr=bankInfo.bank?`\n🏦 ${bankInfo.bank} ${bankInfo.acct} (${bankInfo.holder})`:'';

  const msg=`[🏢 정산요청]\n대행사: ${curAgency.name}\n정산월: ${mo}\n예약건: ${myBks.length}건\n실결제: ₩${fmtWon(paid)}\n수수료: ₩${fmtWon(fee)}${bankStr}\n\n정산 확인 부탁드립니다.`;

  sendK('admin',msg);
  toast('💬 관리자에게 정산요청 카톡 전송!','k');
  renderAgSettle();
}

// ===== AGENCY EXPORT REQUEST & LOG =====
let agExportLogs=[];
function svAgLogs(){try{localStorage.setItem(FP+'agexlogs',JSON.stringify(agExportLogs));}catch(e){}}

function reqAgExport(type){
  if(!curAgency)return;
  const pfrom=document.getElementById('ags_periodFrom')?.value||'';
  const pto=document.getElementById('ags_periodTo')?.value||'';
  const period=pfrom||pto?`${pfrom||'시작'}~${pto||'현재'}`:'전체기간';

  // Create request
  const req={
    id:Date.now(),agency:curAgency.code,agencyName:curAgency.name,
    type,period,pfrom,pto,
    status:'승인대기',requestDate:td(),requestTime:new Date().toLocaleTimeString('ko-KR')
  };
  agExportLogs.push(req);svAgLogs();

  // Notify admin
  sendK('admin',`[📥 엑셀 다운로드 요청]\n대행사: ${curAgency.name}\n유형: ${type}\n기간: ${period}\n\n승인 후 다운로드됩니다.`);
  toast('📥 관리자에게 엑셀 다운로드 승인 요청을 보냈습니다.','k');
  renderAgExportLog();
}

function renderAgExportLog(){
  const el=document.getElementById('agExportLog');if(!el)return;
  const myLogs=agExportLogs.filter(l=>l.agency===curAgency?.code).sort((a,b)=>b.id-a.id);
  if(!myLogs.length){el.innerHTML='<div style="text-align:center;color:#aaa;font-size:12px;padding:16px;">다운로드 요청 내역 없음</div>';return;}
  el.innerHTML=`<table class="tbl" style="font-size:11px;"><thead><tr><th>요청일</th><th>유형</th><th>기간</th><th>상태</th><th>다운로드</th></tr></thead><tbody>
  ${myLogs.map(l=>{
    const isPending=l.status==='승인대기';
    const isApproved=l.status==='승인완료';
    const badge=isPending?'<span class="bdg bdg-y" style="font-size:9px;">⏳ 승인대기</span>':
      isApproved?'<span class="bdg bdg-g" style="font-size:9px;">✅ 승인완료</span>':
      '<span class="bdg bdg-r" style="font-size:9px;">❌ 거절</span>';
    return `<tr><td>${l.requestDate} ${l.requestTime||''}</td><td>${l.type}</td><td style="font-size:10px;">${l.period}</td><td>${badge}</td>
      <td>${isApproved?`<button class="btn bo bs" onclick="doAgExport(${l.id})" style="font-size:9px;padding:3px 8px;">📥 다운로드</button>`:'—'}</td></tr>`;
  }).join('')}</tbody></table>`;
}

function doAgExport(reqId){
  const req=agExportLogs.find(l=>l.id===reqId);if(!req||req.status!=='승인완료')return;
  const myBks=bks.filter(b=>b.agency===req.agency&&b.status!=='취소'&&(!req.pfrom||b.date>=req.pfrom+'-01')&&(!req.pto||b.date<=req.pto+'-31'));

  if(req.type==='정산'){
    let csv='\uFEFF[정산 엑셀] '+req.agencyName+' / '+req.period+'\n';
    csv+='월,예약건,인원,견적합계,실결제,수수료\n';
    const months={};
    myBks.forEach(b=>{
      const mo=b.date.substring(0,7);
      if(!months[mo])months[mo]={count:0,people:0,est:0,paid:0,fee:0};
      months[mo].count++;months[mo].people+=b.students+b.teachers;
      months[mo].est+=getEstimate(b);
      if(b.paidAmount!=null){months[mo].paid+=b.paidAmount;months[mo].fee+=Math.round(b.paidAmount*getAgencyFee(req.agency,b)/100);}
    });
    Object.keys(months).sort().forEach(mo=>{
      const g=months[mo];
      csv+=`${mo},${g.count},${g.people},${g.est},${g.paid},${g.fee}\n`;
    });
    csv+='\n상세내역\n날짜,단체명,유형,인원,인솔,견적,실결제,수수료율,수수료\n';
    myBks.sort((a,b)=>a.date.localeCompare(b.date)).forEach(b=>{
      const est=getEstimate(b);const paid=b.paidAmount||0;const rate=getAgencyFee(req.agency,b);
      csv+=`${b.date},${b.name},${b.category||''},${b.students},${b.teachers},${est},${paid},${rate}%,${Math.round(paid*rate/100)}\n`;
    });
    dlCsvFile(csv,`${req.agencyName}_정산_${req.period}.xls`);
  } else if(req.type==='연간비교'){
    const thisYear=new Date().getFullYear();const lastYear=thisYear-1;
    let csv='\uFEFF[연간비교] '+req.agencyName+'\n';
    csv+=`월,${lastYear} 수수료,${thisYear} 수수료,증감,${lastYear} 건수,${thisYear} 건수\n`;
    const allBks=bks.filter(b=>b.agency===req.agency&&b.status!=='취소');
    for(let m=1;m<=12;m++){
      const mm=String(m).padStart(2,'0');
      const lyBks=allBks.filter(b=>b.date.startsWith(lastYear+'-'+mm));
      const tyBks=allBks.filter(b=>b.date.startsWith(thisYear+'-'+mm));
      const lyFee=lyBks.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+Math.round(b.paidAmount*getAgencyFee(req.agency,b)/100),0);
      const tyFee=tyBks.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+Math.round(b.paidAmount*getAgencyFee(req.agency,b)/100),0);
      csv+=`${m}월,${lyFee},${tyFee},${tyFee-lyFee},${lyBks.length},${tyBks.length}\n`;
    }
    dlCsvFile(csv,`${req.agencyName}_연간비교_${thisYear}.xls`);
  }
  // Log download
  req.downloadDate=td();req.downloadTime=new Date().toLocaleTimeString('ko-KR');
  svAgLogs();
  toast('📥 엑셀 다운로드 완료','s');
  renderAgExportLog();
}

function dlCsvFile(csv,filename){
  {const _a=document.createElement('a');_a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'application/vnd.ms-excel;charset=utf-8'}));_a.download=filename;_a.style.display='none';document.body.appendChild(_a);_a.click();setTimeout(()=>{document.body.removeChild(_a);},300);}
}

// Admin: approve/reject export requests
function renderAgExportRequests(){
  const el=document.getElementById('agExportRequests');if(!el)return;
  const pending=agExportLogs.filter(l=>l.status==='승인대기').sort((a,b)=>b.id-a.id);
  const recent=agExportLogs.filter(l=>l.status!=='승인대기').sort((a,b)=>b.id-a.id).slice(0,10);

  let html='';
  if(pending.length){
    html+=`<div style="font-size:12px;font-weight:700;color:#e65100;margin-bottom:8px;">⏳ 승인대기 (${pending.length}건)</div>`;
    pending.forEach(l=>{
      html+=`<div style="padding:10px;margin-bottom:6px;border:2px solid #f57c00;border-radius:8px;background:#fff8e1;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><span style="font-weight:700;color:#e65100;">${l.agencyName}</span> <span style="font-size:11px;color:#666;">— ${l.type} (${l.period})</span></div>
          <div style="display:flex;gap:4px;">
            <button class="btn bg bs" onclick="approveExport(${l.id})" style="font-size:10px;">✅ 승인</button>
            <button class="btn br bs" onclick="rejectExport(${l.id})" style="font-size:10px;">❌ 거절</button>
          </div>
        </div>
        <div style="font-size:10px;color:#888;margin-top:4px;">요청일: ${l.requestDate} ${l.requestTime||''}</div>
      </div>`;
    });
  } else {
    html+='<div style="font-size:11px;color:#aaa;padding:8px;">승인대기 요청 없음</div>';
  }

  if(recent.length){
    html+=`<div style="font-size:12px;font-weight:700;color:#666;margin:12px 0 6px;">최근 처리 내역</div>`;
    html+=`<table class="tbl" style="font-size:10px;"><thead><tr><th>대행사</th><th>유형</th><th>기간</th><th>요청일</th><th>상태</th><th>다운로드</th></tr></thead><tbody>`;
    recent.forEach(l=>{
      const badge=l.status==='승인완료'?'<span class="bdg bdg-g" style="font-size:9px;">✅ 승인</span>':'<span class="bdg bdg-r" style="font-size:9px;">❌ 거절</span>';
      html+=`<tr><td>${l.agencyName}</td><td>${l.type}</td><td style="font-size:9px;">${l.period}</td><td style="font-size:9px;">${l.requestDate}</td><td>${badge}</td>
        <td style="font-size:9px;">${l.downloadDate||'—'}</td></tr>`;
    });
    html+=`</tbody></table>`;
  }
  el.innerHTML=html;
}

function approveExport(id){
  const l=agExportLogs.find(x=>x.id===id);if(!l)return;
  l.status='승인완료';l.approvedDate=td();l.approvedBy='관리자';
  svAgLogs();toast(`✅ ${l.agencyName} ${l.type} 다운로드 승인`,'s');
  renderAgencyStats();
}
function rejectExport(id){
  const l=agExportLogs.find(x=>x.id===id);if(!l)return;
  l.status='거절';l.rejectedDate=td();
  svAgLogs();toast(`❌ ${l.agencyName} ${l.type} 다운로드 거절`,'s');
  renderAgencyStats();
}

// Admin: full log view
function renderAgExportAllLog(){
  const el=document.getElementById('agExportAllLog');if(!el)return;
  const logs=agExportLogs.slice().sort((a,b)=>b.id-a.id);
  if(!logs.length){el.innerHTML='<div style="color:#aaa;font-size:11px;padding:12px;text-align:center;">로그 없음</div>';return;}
  el.innerHTML=`<table class="tbl" style="font-size:10px;"><thead><tr><th>일시</th><th>대행사</th><th>유형</th><th>기간</th><th>상태</th><th>승인일</th><th>다운로드일</th></tr></thead><tbody>
  ${logs.map(l=>{
    const sc=l.status==='승인완료'?'bdg-g':l.status==='거절'?'bdg-r':'bdg-y';
    return `<tr><td>${l.requestDate} ${l.requestTime||''}</td><td>${l.agencyName}</td><td>${l.type}</td>
      <td style="font-size:9px;">${l.period}</td><td><span class="bdg ${sc}" style="font-size:8px;">${l.status}</span></td>
      <td style="font-size:9px;">${l.approvedDate||l.rejectedDate||'—'}</td>
      <td style="font-size:9px;">${l.downloadDate?l.downloadDate+' '+l.downloadTime:'—'}</td></tr>`;
  }).join('')}</tbody></table>`;
}

// Admin: Agency statistics
function renderAgencyStats(){
  const selAg=document.getElementById('agFilter').value;
  const selMo=document.getElementById('agMonth').value;
  // Populate filter
  const agOpts=`<option value="all">전체 대행사</option>`+agencies.map(a=>`<option value="${a.code}" ${selAg===a.code?'selected':''}>${a.name}</option>`).join('');
  document.getElementById('agFilter').innerHTML=agOpts;

  const agBks=bks.filter(b=>b.agency&&b.status!=='취소');
  const filtered=agBks.filter(b=>(selAg==='all'||b.agency===selAg)&&(!selMo||b.date.startsWith(selMo)));

  // Per-agency stats
  const agMap={};
  filtered.forEach(b=>{
    const code=b.agency;
    if(!agMap[code])agMap[code]={name:b.agencyName||code,count:0,people:0,est:0,paid:0,fee:0};
    agMap[code].count++;agMap[code].people+=b.students+b.teachers;
    agMap[code].est+=getEstimate(b);
    if(b.paidAmount!=null)agMap[code].paid+=b.paidAmount;
  });
  // Apply fee rates per booking
  Object.keys(agMap).forEach(code=>{
    agMap[code].fee=filtered.filter(b=>b.agency===code&&b.paidAmount!=null).reduce((s,b)=>s+Math.round(b.paidAmount*getAgencyFee(code,b)/100),0);
    const ag=agencies.find(a=>a.code===code);
    agMap[code].baseFeeRate=ag?ag.fee:0;
  });

  const agKeys=Object.keys(agMap).sort((a,b)=>agMap[b].count-agMap[a].count);
  const totalCount=filtered.length||1;
  const totalEst=agKeys.reduce((s,k)=>s+agMap[k].est,0);
  const totalPaid=agKeys.reduce((s,k)=>s+agMap[k].paid,0);
  const totalFee=agKeys.reduce((s,k)=>s+agMap[k].fee,0);

  // Summary
  document.getElementById('agStatsSummary').innerHTML=`
    <div style="padding:14px;background:#fff3e0;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">대행사 예약</div><div style="font-size:22px;font-weight:900;color:#e65100;">${filtered.length}건</div></div>
    <div style="padding:14px;background:#e8f5e9;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">견적합계</div><div style="font-size:16px;font-weight:900;color:var(--p);">₩${fmtWon(totalEst)}</div></div>
    <div style="padding:14px;background:#e3f2fd;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">실결제합계</div><div style="font-size:16px;font-weight:900;color:#1565C0;">₩${fmtWon(totalPaid)}</div></div>
    <div style="padding:14px;background:#f3e5f5;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">수수료합계</div><div style="font-size:22px;font-weight:900;color:#7b1fa2;">₩${fmtWon(totalFee)}</div></div>`;

  // Horizontal bars
  if(!agKeys.length){document.getElementById('agStatsChart').innerHTML='<div style="text-align:center;color:#aaa;padding:30px;">대행사 예약 데이터 없음</div>';document.getElementById('agStatsTable').innerHTML='';document.getElementById('agFeeChart').innerHTML='';document.getElementById('agFeeTable').innerHTML='';return;}
  const agColors=['#e65100','#1565C0','#2e7d32','#7b1fa2','#c62828','#00838f','#4e342e','#37474f'];
  const mxC=Math.max(...agKeys.map(k=>agMap[k].count),1);
  let bc='';
  agKeys.forEach((k,i)=>{const g=agMap[k];const clr=agColors[i%agColors.length];const w=Math.max(3,Math.round(g.count/mxC*100));
    bc+=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
      <div style="width:80px;font-size:12px;font-weight:600;text-align:right;color:#555;">${g.name}</div>
      <div style="flex:1;background:#f0f0f0;border-radius:8px;height:24px;overflow:hidden;">
        <div style="width:${w}%;height:100%;background:${clr};border-radius:8px;display:flex;align-items:center;padding-left:8px;">
          ${w>12?`<span style="font-size:10px;font-weight:700;color:#fff;">${g.count}건</span>`:''}
        </div>
      </div>
      <div style="width:60px;font-size:10px;color:#888;">${g.people}명</div></div>`;
  });
  document.getElementById('agStatsChart').innerHTML=bc;

  // Table
  document.getElementById('agStatsTable').innerHTML=`<table class="tbl" style="font-size:11px;"><thead><tr>
    <th>대행사</th><th>예약건</th><th>인원</th><th>견적액</th><th>실결제</th><th>수수료율</th><th>수수료</th></tr></thead><tbody>
  ${agKeys.map(k=>{const g=agMap[k];
    return `<tr><td style="font-weight:700;">${g.name}</td><td>${g.count}</td><td>${g.people}명</td>
      <td style="color:var(--p);">₩${fmtWon(g.est)}</td><td style="color:#1565C0;">₩${fmtWon(g.paid)}</td>
      <td>${g.baseFeeRate}%</td><td style="color:#7b1fa2;font-weight:700;">₩${fmtWon(g.fee)}</td></tr>`;
  }).join('')}
  <tr style="background:#f5f5f5;font-weight:800;"><td>합계</td><td>${filtered.length}</td><td>${filtered.reduce((s,b)=>s+b.students+b.teachers,0)}명</td>
    <td style="color:var(--p);">₩${fmtWon(totalEst)}</td><td style="color:#1565C0;">₩${fmtWon(totalPaid)}</td><td></td><td style="color:#7b1fa2;">₩${fmtWon(totalFee)}</td></tr>
  </tbody></table>`;

  // Monthly fee breakdown
  const months={};
  agBks.forEach(b=>{
    const mo=b.date.substring(0,7);
    if(!months[mo])months[mo]={};
    const code=b.agency;
    if(!months[mo][code])months[mo][code]={name:b.agencyName||code,count:0,people:0,est:0,paid:0,fee:0};
    months[mo][code].count++;months[mo][code].people+=b.students+b.teachers;
    months[mo][code].est+=getEstimate(b);
    if(b.paidAmount!=null){months[mo][code].paid+=b.paidAmount;months[mo][code].fee+=Math.round(b.paidAmount*getAgencyFee(code,b)/100);}
  });
  const moKeys=Object.keys(months).sort().slice(-12);
  const allAgCodes=[...new Set(agBks.map(b=>b.agency))];

  // Stacked monthly chart
  const mxMoVal=Math.max(...moKeys.map(mo=>{let s=0;allAgCodes.forEach(c=>{if(months[mo][c])s+=months[mo][c].paid;});return s;}),1);
  let fc2=`<div style="display:flex;align-items:flex-end;gap:4px;height:160px;overflow-x:auto;">`;
  moKeys.forEach(mo=>{
    let stack='';
    allAgCodes.forEach((c,i)=>{
      if(months[mo][c]){
        const h=Math.max(2,Math.round(months[mo][c].paid/mxMoVal*140));
        stack+=`<div style="height:${h}px;background:${agColors[i%agColors.length]};width:100%;" title="${months[mo][c].name}: ₩${fmtWon(months[mo][c].paid)}"></div>`;
      }
    });
    fc2+=`<div style="display:flex;flex-direction:column-reverse;align-items:center;flex-shrink:0;width:50px;">
      <div style="font-size:9px;color:#888;margin-top:3px;">${fmtMo(mo)}</div>
      <div style="width:36px;display:flex;flex-direction:column-reverse;border-radius:4px 4px 0 0;overflow:hidden;">${stack}</div></div>`;
  });
  fc2+=`</div><div style="display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap;font-size:10px;">`;
  allAgCodes.forEach((c,i)=>{const ag=agencies.find(a=>a.code===c);fc2+=`<span><span style="display:inline-block;width:10px;height:10px;background:${agColors[i%agColors.length]};border-radius:2px;margin-right:3px;"></span>${ag?ag.name:c}</span>`;});
  fc2+=`</div>`;
  document.getElementById('agFeeChart').innerHTML=fc2;

  // Monthly fee table
  let ft=`<table class="tbl" style="font-size:11px;"><thead><tr><th>월</th><th>대행사</th><th>예약건</th><th>인원</th><th>실결제</th><th>수수료율</th><th>수수료</th></tr></thead><tbody>`;
  moKeys.forEach(mo=>{
    const mAgCodes=Object.keys(months[mo]);
    let first=true;
    mAgCodes.forEach(c=>{
      const g=months[mo][c];const ag=agencies.find(a=>a.code===c);const rate=ag?ag.fee:0;
      ft+=`<tr>${first?`<td rowspan="${mAgCodes.length}" style="font-weight:700;vertical-align:top;">${mo}</td>`:''}<td>${g.name}</td><td>${g.count}</td><td>${g.people}명</td>
        <td style="color:#1565C0;">₩${fmtWon(g.paid)}</td><td>${rate}%</td><td style="color:#7b1fa2;font-weight:700;">₩${fmtWon(g.fee)}</td></tr>`;
      first=false;
    });
  });
  ft+=`</tbody></table>`;
  document.getElementById('agFeeTable').innerHTML=ft;

  // Settlement requests from all agencies
  let sr='';
  const allRequests=[];
  agencies.forEach(ag=>{
    const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+ag.code)||'{}');
    const bankInfo=ag.bankInfo||JSON.parse(localStorage.getItem(FP+'agbank_'+ag.code)||'{}');
    Object.keys(settles).forEach(mo=>{
      const s=settles[mo];
      allRequests.push({agency:ag.name,code:ag.code,mo,status:s.status||'저장됨',memo:s.memo,image:s.image,date:s.requestDate||s.date,fee:ag.fee||0,bank:bankInfo});
    });
  });
  allRequests.sort((a,b)=>(b.date||'').localeCompare(a.date||''));

  if(allRequests.length){
    sr=allRequests.map(r=>{
      const isPending=r.status==='정산요청';
      const myBks=bks.filter(b=>b.agency===r.code&&b.status!=='취소'&&b.date.startsWith(r.mo));
      const paid=myBks.filter(b=>b.paidAmount!=null).reduce((s,b)=>s+b.paidAmount,0);
      const feeAmt=Math.round(paid*r.fee/100);
      return `<div style="padding:12px;margin-bottom:8px;border-radius:10px;border:2px solid ${isPending?'#f57c00':'#ddd'};background:${isPending?'#fff8e1':'#fafafa'};">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div><span style="font-weight:800;color:#e65100;">${r.agency}</span> <span style="font-size:12px;color:#666;">— ${r.mo}</span></div>
          <div style="display:flex;gap:6px;align-items:center;">
            <span class="bdg ${isPending?'bdg-y':'bdg-g'}" style="font-size:9px;">${r.status}</span>
            ${isPending?`<button class="btn bg bs" onclick="approveSettle('${r.code}','${r.mo}')" style="font-size:10px;">✅ 정산완료</button>`:''}
          </div>
        </div>
        <div style="display:flex;gap:16px;font-size:11px;color:#666;flex-wrap:wrap;">
          <span>예약 ${myBks.length}건</span><span>실결제 ₩${fmtWon(paid)}</span>
          <span style="color:#7b1fa2;font-weight:700;">수수료(${r.fee}%) ₩${fmtWon(feeAmt)}</span>
          ${r.bank&&r.bank.bank?`<span>🏦 ${r.bank.bank} ${r.bank.acct} (${r.bank.holder})</span>`:''}
        </div>
        ${r.memo?`<div style="font-size:11px;color:#888;margin-top:4px;">📝 ${r.memo}</div>`:''}
        ${r.image?`<img src="${r.image}" style="max-width:200px;max-height:100px;border-radius:6px;margin-top:6px;border:1px solid #ddd;cursor:pointer;" onclick="window.open(this.src)">`:''}
      </div>`;
    }).join('');
  } else {
    sr='<div style="text-align:center;color:#aaa;padding:20px;">정산요청 내역 없음</div>';
  }
  document.getElementById('agSettleRequests').innerHTML=sr;
  renderAgExportRequests();
  renderAgExportAllLog();
}

function approveSettle(code,mo){
  const settles=JSON.parse(localStorage.getItem(FP+'agsettle_'+code)||'{}');
  if(settles[mo]){settles[mo].status='정산완료';settles[mo].approvedDate=td();}
  localStorage.setItem(FP+'agsettle_'+code,JSON.stringify(settles));
  const ag=agencies.find(a=>a.code===code);
  toast(`✅ ${ag?ag.name:code} ${mo} 정산완료 처리`,'s');
  renderAgencyStats();
}

// Excel export for agency stats
function exportAgencyExcel(){
  const selAg=document.getElementById('agFilter').value;
  const selMo=document.getElementById('agMonth').value;
  const agBks=bks.filter(b=>b.agency&&b.status!=='취소'&&(selAg==='all'||b.agency===selAg)&&(!selMo||b.date.startsWith(selMo)));

  let csv='\uFEFF날짜,대행사,단체명,단체유형,아동,인솔,견적액,실결제,수수료율,수수료\n';
  agBks.sort((a,b)=>a.date.localeCompare(b.date)).forEach(b=>{
    const est=getEstimate(b);const paid=b.paidAmount||0;
    const rate=getAgencyFee(b.agency,b);const fee=Math.round(paid*rate/100);
    csv+=`${b.date},${b.agencyName||''},${b.name},${b.category||''},${b.students},${b.teachers},${est},${paid},${rate}%,${fee}\n`;
  });

  // Monthly summary sheet
  csv+='\n\n월별 수수료 정산\n월,대행사,예약건,인원,견적합계,실결제합계,수수료율,수수료\n';
  const months={};
  agBks.forEach(b=>{
    const mo=b.date.substring(0,7);const code=b.agency;
    if(!months[mo])months[mo]={};
    if(!months[mo][code])months[mo][code]={name:b.agencyName||code,count:0,people:0,est:0,paid:0,fee:0};
    months[mo][code].count++;months[mo][code].people+=b.students+b.teachers;
    months[mo][code].est+=getEstimate(b);
    if(b.paidAmount!=null){months[mo][code].paid+=b.paidAmount;months[mo][code].fee+=Math.round(b.paidAmount*getAgencyFee(code,b)/100);}
  });
  Object.keys(months).sort().forEach(mo=>{
    Object.keys(months[mo]).forEach(code=>{
      const g=months[mo][code];
      csv+=`${mo},${g.name},${g.count},${g.people},${g.est},${g.paid},,${g.fee}\n`;
    });
  });

  {const _a=document.createElement('a');_a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'application/vnd.ms-excel;charset=utf-8'}));_a.download=`대행사_정산_${selMo||'전체'}.xls`;_a.style.display='none';document.body.appendChild(_a);_a.click();setTimeout(()=>{document.body.removeChild(_a);},300);}
  toast('📥 대행사 엑셀 다운로드','s');
}

// ===== FLOW & CATEGORY ANALYSIS =====
let ltPeriod='month';
function setLtPeriod(p){ltPeriod=p;renderLeadTime();}

let _ltRange='1m';
function setLtRange(r){
  _ltRange=r;
  const now=new Date();const fmt=d=>d.toISOString().split('T')[0];
  if(r==='custom'){renderLeadTime();return;}
  let from='',to='';
  if(r!=='all')to=fmt(now);
  if(r==='1w'){const d=new Date(now);d.setDate(d.getDate()-7);from=fmt(d);}
  else if(r==='1m'){const d=new Date(now);d.setMonth(d.getMonth()-1);from=fmt(d);}
  else if(r==='3m'){const d=new Date(now);d.setMonth(d.getMonth()-3);from=fmt(d);}
  else if(r==='6m'){const d=new Date(now);d.setMonth(d.getMonth()-6);from=fmt(d);}
  else if(r==='1y'){const d=new Date(now);d.setFullYear(d.getFullYear()-1);from=fmt(d);}
  document.getElementById('ltFrom').value=from;
  document.getElementById('ltTo').value=to;
  renderLeadTime();
}

const CAT_COLORS={'어린이집':'#66bb6a','유치원':'#42a5f5','초등학교':'#ffa726','중학교':'#ab47bc','복지기관':'#ef5350','기타':'#78909c'};
const CAT_COLORS_L={'어린이집':'#a5d6a7','유치원':'#90caf9','초등학교':'#ffcc80','중학교':'#ce93d8','복지기관':'#ef9a9a','기타':'#b0bec5'};
function fmtMo(s){if(!s)return'';const m=s.substring(5);return parseInt(m)+'월';}

function renderLeadTime(){
  const dp=/^\d{4}-\d{2}-\d{2}$/;
  let active=bks.filter(b=>b.status!=='취소'&&b.date&&dp.test(b.date)&&b.created&&dp.test(b.created));

  // Apply date range filter
  const ltFromVal=document.getElementById('ltFrom')?.value||'';
  const ltToVal=document.getElementById('ltTo')?.value||'';
  if(ltFromVal)active=active.filter(b=>b.date>=ltFromVal);
  if(ltToVal)active=active.filter(b=>b.date<=ltToVal);

  // Highlight buttons
  ['month','year'].forEach(p=>{const el=document.getElementById('lt_'+p);if(el){el.style.background=p===ltPeriod?'var(--p)':'#eee';el.style.color=p===ltPeriod?'#fff':'#333';}});
  ['1w','1m','3m','6m','1y','all'].forEach(k=>{const el=document.getElementById('lr_'+k);if(el){el.style.background=_ltRange===k?'#555':'#eee';el.style.color=_ltRange===k?'#fff':'#333';}});

  // Period label
  const plEl=document.getElementById('ltPeriodLabel');
  if(plEl){
    if(ltFromVal||ltToVal){plEl.innerHTML=`📆 ${ltFromVal||'시작'} ~ ${ltToVal||td()} | ${active.length}건`;}
    else plEl.innerHTML='';
  }

  // Flow data
  const flowMap={};const flowBks={};
  const cPeriods=new Set(),vPeriods=new Set();
  active.forEach(b=>{
    const cK=ltPeriod==='year'?b.created.substring(0,4):b.created.substring(0,7);
    const vK=ltPeriod==='year'?b.date.substring(0,4):b.date.substring(0,7);
    cPeriods.add(cK);vPeriods.add(vK);
    const fk=cK+'|'+vK;
    if(!flowMap[fk])flowMap[fk]={count:0,people:0};
    flowMap[fk].count++;flowMap[fk].people+=b.students+b.teachers;
    if(!flowBks[fk])flowBks[fk]=[];
    flowBks[fk].push(b);
  });
  window._flowBks=flowBks;
  window._ltActive=active;
  const allP=[...new Set([...cPeriods,...vPeriods])].sort().slice(-10);
  const avgLead=active.length?Math.round(active.reduce((s,b)=>{const c=b.created||b.date;const d=Math.max(0,Math.round((new Date(b.date)-new Date(c))/86400000));return s+(isNaN(d)?0:d);},0)/active.length):0;

  // Summary
  document.getElementById('ltSummary').innerHTML=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
    <div style="padding:12px;background:#e8f5e9;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">총 예약</div><div style="font-size:20px;font-weight:900;color:var(--p);">${active.length}건</div></div>
    <div style="padding:12px;background:#e3f2fd;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">평균 리드타임</div><div style="font-size:20px;font-weight:900;color:#1565C0;">${avgLead}일</div></div>
    <div style="padding:12px;background:#fff3e0;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">신청기간</div><div style="font-size:13px;font-weight:700;color:var(--org);">${[...cPeriods].sort()[0]||'-'} ~ ${[...cPeriods].sort().pop()||'-'}</div></div>
    <div style="padding:12px;background:#f3e5f5;border-radius:10px;text-align:center;"><div style="font-size:10px;color:#666;">방문기간</div><div style="font-size:13px;font-weight:700;color:#7b1fa2;">${[...vPeriods].sort()[0]||'-'} ~ ${[...vPeriods].sort().pop()||'-'}</div></div>
  </div>`;

  if(!allP.length){document.getElementById('ltFlow').innerHTML='<div style="text-align:center;color:#aaa;padding:30px;">데이터 없음</div>';document.getElementById('ltTable').innerHTML='';return;}

  // Heatmap
  const maxF=Math.max(...Object.values(flowMap).map(v=>v.count),1);
  const pLbl=ltPeriod==='year'?'년':'월';
  let hm=`<div style="font-size:12px;font-weight:700;margin-bottom:8px;">신청${pLbl} → 방문${pLbl} 히트맵</div>`;
  hm+=`<table style="border-collapse:collapse;font-size:11px;width:100%;"><thead><tr><th style="padding:5px;border:1px solid #ddd;background:#f5f5f5;font-size:10px;">신청＼방문</th>`;
  allP.forEach(v=>hm+=`<th style="padding:5px;border:1px solid #ddd;background:#f5f5f5;font-size:10px;">${ltPeriod==='year'?v:fmtMo(v)}</th>`);
  hm+=`<th style="padding:5px;border:1px solid #ddd;background:#e8f5e9;font-size:10px;">합계</th></tr></thead><tbody>`;
  allP.forEach(c=>{
    let rt=0,rp=0;
    hm+=`<tr><td style="padding:5px;border:1px solid #ddd;background:#f5f5f5;font-weight:600;font-size:10px;">${ltPeriod==='year'?c:fmtMo(c)}</td>`;
    allP.forEach(v=>{
      const d=flowMap[c+'|'+v];const cnt=d?d.count:0;rt+=cnt;if(d)rp+=d.people;
      const int=cnt/maxF;const bg=cnt===0?'#fafafa':`rgba(46,125,50,${0.1+int*0.7})`;
      const hover=cnt>0?`onmouseenter="showLtTip(event,'${c}','${v}')" onmouseleave="hideLtTip()" onclick="clickLtTip('${c}','${v}')" style="padding:5px;border:1px solid #ddd;text-align:center;background:${bg};color:${int>0.5?'#fff':'#333'};cursor:pointer;"`:`style="padding:5px;border:1px solid #ddd;text-align:center;background:${bg};"`;
      hm+=`<td ${hover}>${cnt?`<div style="font-size:12px;font-weight:800;">${cnt}건</div><div style="font-size:9px;opacity:.7;">${d.people}명</div>`:''}</td>`;
    });
    hm+=`<td onmouseenter="showLtTip(event,'${c}','__all__')" onmouseleave="hideLtTip()" onclick="clickLtTip('${c}','__all__')" style="padding:5px;border:1px solid #ddd;text-align:center;background:#e8f5e9;cursor:pointer;"><div style="font-size:12px;font-weight:800;">${rt}건</div><div style="font-size:9px;color:#666;">${rp}명</div></td></tr>`;
  });
  hm+=`<tr><td style="padding:5px;border:1px solid #ddd;background:#e8f5e9;font-weight:700;">합계</td>`;
  let gt=0,gp=0;allP.forEach(v=>{let ct=0,cp=0;allP.forEach(c=>{const d=flowMap[c+'|'+v];if(d){ct+=d.count;cp+=d.people;}});gt+=ct;gp+=cp;
    hm+=`<td onmouseenter="showLtTip(event,'__all__','${v}')" onmouseleave="hideLtTip()" onclick="clickLtTip('__all__','${v}')" style="padding:5px;border:1px solid #ddd;text-align:center;background:#e8f5e9;cursor:pointer;"><div style="font-size:12px;font-weight:800;">${ct}건</div><div style="font-size:9px;color:#666;">${cp}명</div></td>`;});
  hm+=`<td style="padding:5px;border:1px solid #ddd;text-align:center;background:#c8e6c9;"><div style="font-size:14px;font-weight:900;">${gt}건</div><div style="font-size:10px;color:#333;">${gp}명</div></td></tr></tbody></table>`;
  hm+=`<div style="font-size:9px;color:#999;margin-top:4px;">셀: 건수 · 마우스오버: 인원 · 색이 진할수록 건수 많음</div>`;
  document.getElementById('ltFlow').innerHTML=hm;

  // Period detail table
  const pd={};
  active.forEach(b=>{
    const vK=ltPeriod==='year'?b.date.substring(0,4):b.date.substring(0,7);
    const cK=ltPeriod==='year'?b.created.substring(0,4):b.created.substring(0,7);
    if(!pd[vK])pd[vK]={count:0,people:0,leads:[],same:0};
    pd[vK].count++;pd[vK].people+=b.students+b.teachers;
    pd[vK].leads.push(Math.max(0,Math.round((new Date(b.date)-new Date(b.created))/86400000))||0);
    if(cK===vK)pd[vK].same++;
  });
  const pks=Object.keys(pd).sort().slice(-12);
  document.getElementById('ltTable').innerHTML=`<table class="tbl" style="font-size:11px;"><thead><tr>
    <th>방문${pLbl}</th><th>예약건</th><th>총인원</th><th>평균리드</th><th>최소</th><th>최대</th><th>당${pLbl}신청</th><th>리드분포</th>
  </tr></thead><tbody>
  ${pks.map(k=>{const g=pd[k];const l=g.leads;const avg=Math.round(l.reduce((a,b)=>a+b,0)/l.length);const mn=Math.min(...l);const mx=Math.max(...l);
    const w7=l.filter(d=>d<=7).length;const w14=l.filter(d=>d>7&&d<=14).length;const w30=l.filter(d=>d>14&&d<=30).length;const w30p=l.filter(d=>d>30).length;const tot=l.length;
    return `<tr onmouseenter="showLtTip(event,'__all__','${k}')" onmouseleave="hideLtTip()" onclick="clickLtTip('__all__','${k}')" style="cursor:pointer;"><td style="font-weight:600;">${k}</td><td>${g.count}</td><td>${g.people}명</td>
      <td style="font-weight:700;color:var(--p);">${avg}일</td><td>${mn}일</td><td>${mx}일</td>
      <td>${g.same}건 (${Math.round(g.same/tot*100)}%)</td>
      <td><div style="display:flex;height:14px;border-radius:7px;overflow:hidden;width:100px;">
        <div style="width:${w7/tot*100}%;background:#c62828;"></div><div style="width:${w14/tot*100}%;background:#f57c00;"></div>
        <div style="width:${w30/tot*100}%;background:#2e7d32;"></div><div style="width:${w30p/tot*100}%;background:#1565C0;"></div>
      </div><div style="font-size:8px;color:#aaa;display:flex;gap:3px;margin-top:1px;"><span style="color:#c62828;">~7</span><span style="color:#f57c00;">~14</span><span style="color:#2e7d32;">~30</span><span style="color:#1565C0;">30+</span></div></td></tr>`;
  }).join('')}</tbody></table>`;

  renderCategoryStats();
  generateLtInsight();
}

function getLtBks(cKey,vKey){
  const active=window._ltActive||[];
  const flowBks=window._flowBks||{};
  if(cKey!=='__all__'&&vKey!=='__all__')return flowBks[cKey+'|'+vKey]||[];
  if(cKey==='__all__'&&vKey==='__all__')return active;
  return active.filter(b=>{
    const cK=ltPeriod==='year'?b.created.substring(0,4):b.created.substring(0,7);
    const vK=ltPeriod==='year'?b.date.substring(0,4):b.date.substring(0,7);
    if(cKey==='__all__')return vK===vKey;
    return cK===cKey;
  });
}

function buildLtTipHTML(list){
  if(!list.length)return '';
  const sc=b=>b.status==='확정'?'#4caf50':b.status==='대기'?'#ff9800':'#f44336';
  let h=`<div style="max-height:280px;overflow-y:auto;">`;
  list.forEach(b=>{
    const lead=Math.round((new Date(b.date)-new Date(b.created))/86400000);
    h+=`<div onclick="hideLtTipForce();showDtl(${b.id})" style="padding:6px 8px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;gap:8px;align-items:flex-start;" onmouseenter="this.style.background='#f5f5f5'" onmouseleave="this.style.background=''">
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:11px;">${b.name} <span style="color:${sc(b)};font-size:9px;">${b.status}</span></div>
        <div style="font-size:10px;color:#666;">방문 ${b.date} · ${b.arrival}~${b.departure}</div>
        <div style="font-size:10px;color:#888;">신청 ${b.created} · 리드 <strong style="color:var(--p);">${lead}일</strong></div>
        <div style="font-size:10px;">${b.students+b.teachers}명 · ₩${fmtWon(getEstimate(b))}</div>
      </div>
      <div style="font-size:9px;color:#42a5f5;white-space:nowrap;padding-top:2px;">상세→</div>
    </div>`;
  });
  h+=`</div>`;return h;
}

function showLtTip(ev,cKey,vKey){
  const list=getLtBks(cKey,vKey);if(!list.length)return;
  clearTimeout(window._ltHideTimer);
  let tip=document.getElementById('ltTipBox');
  if(!tip){tip=document.createElement('div');tip.id='ltTipBox';
    tip.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid #81c784;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,.2);max-width:380px;min-width:260px;overflow:hidden;';
    tip.onmouseenter=()=>clearTimeout(window._ltHideTimer);
    tip.onmouseleave=()=>{window._ltHideTimer=setTimeout(()=>{tip.style.display='none';},150);};
    document.body.appendChild(tip);}
  const pLbl=ltPeriod==='year'?'년':'월';
  const cLbl=cKey==='__all__'?'전체':(ltPeriod==='year'?cKey:fmtMo(cKey));
  const vLbl=vKey==='__all__'?'전체':(ltPeriod==='year'?vKey:fmtMo(vKey));
  tip.innerHTML=`<div style="background:#2e7d32;color:#fff;padding:6px 12px;font-size:11px;font-weight:700;">신청${pLbl} ${cLbl} → 방문${pLbl} ${vLbl} — ${list.length}건</div>`+buildLtTipHTML(list);
  tip.style.display='block';tip.style.pointerEvents='auto';
  const el=ev.target.closest('td')||ev.target.closest('tr')||ev.target;
  const rect=el.getBoundingClientRect();
  let left=rect.right+8;if(left+380>window.innerWidth)left=rect.left-388;if(left<4)left=4;
  let top=rect.top;if(top+tip.offsetHeight>window.innerHeight-10)top=window.innerHeight-tip.offsetHeight-10;if(top<4)top=4;
  tip.style.left=left+'px';tip.style.top=top+'px';
}
function hideLtTip(){window._ltHideTimer=setTimeout(()=>{const t=document.getElementById('ltTipBox');if(t)t.style.display='none';},150);}
function hideLtTipForce(){clearTimeout(window._ltHideTimer);const t=document.getElementById('ltTipBox');if(t)t.style.display='none';}

function exportLtExcel(){
  let active=bks.filter(b=>b.status!=='취소'&&b.created);
  const ltFrom=document.getElementById('ltFrom')?.value||'';
  const ltTo=document.getElementById('ltTo')?.value||'';
  if(ltFrom)active=active.filter(b=>b.date>=ltFrom);
  if(ltTo)active=active.filter(b=>b.date<=ltTo);

  const pLbl=ltPeriod==='year'?'년':'월';
  const allC=new Set(),allV=new Set();
  const flow={};
  active.forEach(b=>{
    const cK=ltPeriod==='year'?b.created.substring(0,4):b.created.substring(0,7);
    const vK=ltPeriod==='year'?b.date.substring(0,4):b.date.substring(0,7);
    allC.add(cK);allV.add(vK);
    const fk=cK+'→'+vK;
    if(!flow[fk])flow[fk]={count:0,people:0};
    flow[fk].count++;flow[fk].people+=(b.students||0)+(b.teachers||0);
  });
  const cKeys=[...allC].sort();const vKeys=[...allV].sort();

  // Lead times
  const leads=active.map(b=>{const d=Math.round((new Date(b.date)-new Date(b.created))/86400000);return isNaN(d)?0:d;});
  const avgLead=leads.length?Math.round(leads.reduce((a,b)=>a+b,0)/leads.length):0;
  const minLead=leads.length?Math.min(...leads):0;
  const maxLead=leads.length?Math.max(...leads):0;

  let csv='\uFEFF';
  csv+=`잠사박물관 신청${pLbl}→방문${pLbl} 흐름 분석\n`;
  csv+=`기간,${ltFrom||'시작'}~${ltTo||'현재'}\n`;
  csv+=`작성일,${td()}\n\n`;

  csv+=`총 예약,${active.length}건\n`;
  csv+=`평균 리드타임,${avgLead}일\n`;
  csv+=`최소 리드타임,${minLead}일\n`;
  csv+=`최대 리드타임,${maxLead}일\n\n`;

  // Heatmap
  csv+=`[신청${pLbl}→방문${pLbl} 히트맵 (건수/인원)]\n`;
  csv+=`신청\\방문,${vKeys.join(',')},합계\n`;
  cKeys.forEach(c=>{
    let rowCnt=0,rowPpl=0;
    let row=c;
    vKeys.forEach(v=>{
      const f=flow[c+'→'+v];
      if(f){row+=`,${f.count}건/${f.people}명`;rowCnt+=f.count;rowPpl+=f.people;}
      else row+=`,`;
    });
    row+=`,${rowCnt}건/${rowPpl}명`;
    csv+=row+'\n';
  });
  // Column totals
  let totRow='합계';let grandCnt=0,grandPpl=0;
  vKeys.forEach(v=>{
    let cc=0,pp=0;
    cKeys.forEach(c=>{const f=flow[c+'→'+v];if(f){cc+=f.count;pp+=f.people;}});
    totRow+=`,${cc}건/${pp}명`;grandCnt+=cc;grandPpl+=pp;
  });
  totRow+=`,${grandCnt}건/${grandPpl}명`;
  csv+=totRow+'\n\n';

  // Visit month table
  const vGroups={};
  active.forEach(b=>{
    const vK=ltPeriod==='year'?b.date.substring(0,4):b.date.substring(0,7);
    if(!vGroups[vK])vGroups[vK]={count:0,people:0,leads:[],sameMonth:0};
    const lead=Math.round((new Date(b.date)-new Date(b.created))/86400000);
    vGroups[vK].count++;vGroups[vK].people+=(b.students||0)+(b.teachers||0);
    vGroups[vK].leads.push(lead);
    const cK=ltPeriod==='year'?b.created.substring(0,4):b.created.substring(0,7);
    if(cK===vK)vGroups[vK].sameMonth++;
  });
  const vgKeys=Object.keys(vGroups).sort();

  csv+=`[방문${pLbl}별 상세]\n`;
  csv+=`방문${pLbl},예약건,총인원,평균리드,최소,최대,당${pLbl}신청\n`;
  vgKeys.forEach(k=>{
    const g=vGroups[k];
    const avg=g.leads.length?Math.round(g.leads.reduce((a,b)=>a+b,0)/g.leads.length):0;
    const mn=g.leads.length?Math.min(...g.leads):0;
    const mx=g.leads.length?Math.max(...g.leads):0;
    csv+=`${k},${g.count},${g.people}명,${avg}일,${mn}일,${mx}일,${g.sameMonth}건(${g.count>0?Math.round(g.sameMonth/g.count*100):0}%)\n`;
  });

  csv+=`\n[예약 상세]\n`;
  csv+=`방문일,신청일,리드타임,단체명,카테고리,아동,인솔,견적액,상태\n`;
  active.sort((a,b)=>a.date.localeCompare(b.date)).forEach(b=>{
    const lead=Math.round((new Date(b.date)-new Date(b.created))/86400000);
    csv+=`${b.date},${b.created},${lead}일,"${b.name}",${b.category||''},${b.students||0},${b.teachers||0},${getEstimate(b)},${b.status}\n`;
  });

  {const _a=document.createElement('a');_a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'application/vnd.ms-excel;charset=utf-8'}));_a.download=`신청방문흐름_${pLbl}별_${td()}.xls`;_a.style.display='none';document.body.appendChild(_a);_a.click();setTimeout(()=>{document.body.removeChild(_a);},300);}
  toast('📥 신청→방문 흐름 엑셀 다운로드','s');
}
function clickLtTip(cKey,vKey){
  const list=getLtBks(cKey,vKey);if(!list.length)return;
  if(list.length===1){hideLtTipForce();showDtl(list[0].id);return;}
  const tip=document.getElementById('ltTipBox');if(tip)tip.style.pointerEvents='auto';
}

function exportCatExcel(){
  const {active,from,to}=getCatFiltered();
  const cats={};
  active.forEach(b=>{const c=b.category||'기타';if(!cats[c])cats[c]=[];cats[c].push(b);});
  const cn=Object.keys(cats).sort((a,b)=>cats[b].length-cats[a].length);
  const periodLabel=(from||to)?(from||'시작')+'~'+(to||td()):'전체기간';
  const CL='<'+'/';// avoid parser issue

  // Build rows as arrays then join
  function TR(cells,isHead,bgColor){
    const tag=isHead?'th':'td';
    const st=bgColor?(' style="background:'+bgColor+'"'):'';
    return '<tr'+st+'>'+cells.map(c=>{
      const val=typeof c==='object'?c.v:c;
      const s=typeof c==='object'&&c.s?' style="'+c.s+'"':'';
      const cls=typeof c==='object'&&c.c?' class="'+c.c+'"':'';
      return '<'+tag+s+cls+'>'+val+CL+tag+'>';
    }).join('')+CL+'tr>';
  }

  let h='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">';
  h+='<head><meta charset="utf-8">';
  h+='<style>td,th{border:1px solid #ccc;padding:4px 8px;font-size:11px;} th{background:#e8f5e9;font-weight:bold;} .m{mso-number-format:"\\#\\,\\#\\#0";} .d{mso-number-format:"yyyy-mm-dd";}'+CL+'style>';
  h+='<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>';
  h+='<x:ExcelWorksheet><x:Name>전체요약'+CL+'x:Name><x:WorksheetOptions><x:DisplayGridlines/>'+CL+'x:WorksheetOptions>'+CL+'x:ExcelWorksheet>';
  cn.forEach(c=>{h+='<x:ExcelWorksheet><x:Name>'+c+CL+'x:Name><x:WorksheetOptions><x:DisplayGridlines/>'+CL+'x:WorksheetOptions>'+CL+'x:ExcelWorksheet>';});
  h+='<x:ExcelWorksheet><x:Name>월별유형별'+CL+'x:Name><x:WorksheetOptions><x:DisplayGridlines/>'+CL+'x:WorksheetOptions>'+CL+'x:ExcelWorksheet>';
  h+=CL+'x:ExcelWorksheets>'+CL+'x:ExcelWorkbook>'+CL+'xml><![endif]-->'+CL+'head><body>';

  // Sheet 1: Summary
  h+='<div id="전체요약"><table>';
  h+=TR([{v:'단체유형별 통계 — '+periodLabel,s:'font-size:14px;background:#2e7d32;color:#fff;',c:''}],true);
  h+=TR(['유형','예약건','비율','총인원','견적합계','실결제','평균인원'],true);
  let tC=0,tP=0,tE=0,tPd=0;
  cn.forEach(c=>{
    const L=cats[c],n=L.length;
    const p=L.reduce((s,b)=>s+b.students+b.teachers,0);
    const e=L.reduce((s,b)=>s+getEstimate(b),0);
    const pd=L.reduce((s,b)=>s+(b.paidAmount||0),0);
    const pct=active.length?Math.round(n/active.length*100):0;
    tC+=n;tP+=p;tE+=e;tPd+=pd;
    h+=TR([{v:c,s:'font-weight:bold'},n,pct+'%',p+'명',{v:e,c:'m'},{v:pd,c:'m'},Math.round(p/n)+'명'],false);
  });
  h+=TR([{v:'합계',s:'font-weight:bold'},tC,'100%',tP+'명',{v:tE,c:'m'},{v:tPd,c:'m'},tC?Math.round(tP/tC)+'명':'0명'],false,'#e8f5e9');
  h+=CL+'table>'+CL+'div>';

  // Per-category sheets
  cn.forEach(c=>{
    const L=cats[c].sort((a,b)=>a.date.localeCompare(b.date));
    h+='<div id="'+c+'"><table>';
    h+=TR([{v:c+' — '+L.length+'건 ('+periodLabel+')',s:'font-size:13px;background:#2e7d32;color:#fff'}],true);
    h+=TR(['예약일','방문일','단체명','연락처','상태','유아','초등','인솔','총인원','체험','단체식','견적액'],true);
    L.forEach(b=>{
      h+=TR([
        {v:b.created||'',c:'d'},{v:b.date,c:'d'},b.name,b.phone||'',b.status,
        b.studentsChild||0,b.studentsElem||0,b.teachers,b.students+b.teachers,
        (b.addons||[]).join(', '),b.meal||'이용안함',{v:getEstimate(b),c:'m'}
      ],false);
    });
    const sp=L.reduce((s,b)=>s+b.students+b.teachers,0);
    const se=L.reduce((s,b)=>s+getEstimate(b),0);
    h+=TR([{v:'합계',s:'font-weight:bold'},'','','','','','','',sp,'','',{v:se,c:'m'}],false,'#e8f5e9');
    h+=CL+'table>'+CL+'div>';
  });

  // Monthly cross-tab sheet
  const allMo=[...new Set(active.map(b=>b.date.substring(0,7)))].sort();
  h+='<div id="월별유형별"><table>';
  h+=TR([{v:'월별 × 유형별 ('+periodLabel+')',s:'font-size:13px;background:#2e7d32;color:#fff'}],true);
  h+=TR(['월',...cn.map(c=>c),'합계'],true);
  allMo.forEach(mo=>{
    const row=[mo];let mt=0;
    cn.forEach(c=>{
      const mb=(cats[c]||[]).filter(b=>b.date.startsWith(mo));
      const n=mb.length,p=mb.reduce((s,b)=>s+b.students+b.teachers,0),e=mb.reduce((s,b)=>s+getEstimate(b),0);
      mt+=n;
      row.push(n?n+'건/'+p+'명/₩'+fmtWon(e):'-');
    });
    const moAll=active.filter(b=>b.date.startsWith(mo));
    const moP=moAll.reduce((s,b)=>s+b.students+b.teachers,0);
    const moE=moAll.reduce((s,b)=>s+getEstimate(b),0);
    row.push({v:moAll.length+'건/'+moP+'명/₩'+fmtWon(moE),s:'font-weight:bold;background:#e8f5e9'});
    h+=TR(row,false);
  });
  h+=CL+'table>'+CL+'div>';
  h+=CL+'body>'+CL+'html>';

  // Download
  const fname='단체유형별통계_'+periodLabel.replace(/[~\/]/g,'_')+'_'+td()+'.xls';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\uFEFF'+h],{type:'application/vnd.ms-excel;charset=utf-8'}));
  a.download=fname;a.style.display='none';
  document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);},300);
}

let _catPeriod='1m';
function setCatPeriod(p){
  _catPeriod=p;
  const now=new Date();
  const fmt=d=>d.toISOString().split('T')[0];
  if(p==='custom'){renderCategoryStats();return;}
  let from='',to='';
  if(p!=='all')to=fmt(now);
  if(p==='1m'){const d=new Date(now);d.setMonth(d.getMonth()-1);from=fmt(d);}
  else if(p==='3m'){const d=new Date(now);d.setMonth(d.getMonth()-3);from=fmt(d);}
  else if(p==='6m'){const d=new Date(now);d.setMonth(d.getMonth()-6);from=fmt(d);}
  else if(p==='1y'){const d=new Date(now);d.setFullYear(d.getFullYear()-1);from=fmt(d);}
  document.getElementById('cpFrom').value=from;
  document.getElementById('cpTo').value=to;
  renderCategoryStats();
}

function getCatFiltered(){
  const from=document.getElementById('cpFrom')?.value||'';
  const to=document.getElementById('cpTo')?.value||'';
  const dp=/^\d{4}-\d{2}-\d{2}$/;
  let active=bks.filter(b=>b.status!=='취소'&&b.date&&dp.test(b.date));
  if(from)active=active.filter(b=>b.date>=from);
  if(to)active=active.filter(b=>b.date<=to);
  return {active,from,to};
}

function renderCategoryStats(){
  // Highlight active period button
  ['1m','3m','6m','1y','all'].forEach(k=>{
    const el=document.getElementById('cp_'+k);
    if(el){el.style.background=_catPeriod===k?'var(--p)':'#eee';el.style.color=_catPeriod===k?'#fff':'#333';}
  });

  const {active,from,to}=getCatFiltered();

  // Period label
  const plEl=document.getElementById('catPeriodLabel');
  if(plEl){
    if(from||to){
      const cnt=active.length;const ppl=active.reduce((s,b)=>s+b.students+b.teachers,0);
      plEl.innerHTML=`📆 ${from||'시작'} ~ ${to||td()} | ${cnt}건 · ${ppl}명`;
    } else { plEl.innerHTML='📆 전체 기간'; }
  }

  const cats={};
  active.forEach(b=>{const c=b.category||'기타';if(!cats[c])cats[c]={count:0,people:0,est:0,paid:0};cats[c].count++;cats[c].people+=b.students+b.teachers;cats[c].est+=getEstimate(b);if(b.paidAmount!=null)cats[c].paid+=b.paidAmount;});
  const cn=Object.keys(cats).sort((a,b)=>cats[b].count-cats[a].count);
  const tot=active.length||1;

  // Pre-populate cross data for hover popups
  window._crossCatTotBks={};
  cn.forEach(c=>{window._crossCatTotBks[c]=active.filter(b=>(b.category||'기타')===c);});

  // Cards - with hover
  document.getElementById('catSummary').innerHTML=cn.map(c=>{const g=cats[c];const pct=Math.round(g.count/tot*100);const clr=CAT_COLORS[c]||'#78909c';
    return `<div onmouseenter="showCrossTip(event,'__total__','${c}')" onmouseleave="hideCrossTip()" onclick="filterCrossClick('__total__','${c}')" style="padding:12px;border-radius:10px;border-left:4px solid ${clr};background:#fafafa;text-align:center;cursor:pointer;"><div style="font-size:11px;color:#666;">${c}</div><div style="font-size:22px;font-weight:900;color:${clr};">${g.count}</div><div style="font-size:10px;color:#999;">${g.people}명 · ${pct}%</div></div>`;
  }).join('');

  // Horizontal bars + stacked monthly - with hover
  const mx=Math.max(...cn.map(c=>cats[c].count),1);
  let bc=`<div style="display:flex;flex-direction:column;gap:8px;">`;
  cn.forEach(c=>{const g=cats[c];const pct=Math.round(g.count/tot*100);const clr=CAT_COLORS[c]||'#78909c';const w=Math.max(3,Math.round(g.count/mx*100));
    bc+=`<div onmouseenter="showCrossTip(event,'__total__','${c}')" onmouseleave="hideCrossTip()" onclick="filterCrossClick('__total__','${c}')" style="display:flex;align-items:center;gap:10px;cursor:pointer;"><div style="width:70px;font-size:12px;font-weight:600;text-align:right;color:#555;">${c}</div>
      <div style="flex:1;background:#f0f0f0;border-radius:8px;height:24px;overflow:hidden;position:relative;">
        <div style="width:${w}%;height:100%;background:${clr};border-radius:8px;display:flex;align-items:center;padding-left:8px;">${w>15?`<span style="font-size:10px;font-weight:700;color:#fff;">${g.count}건 (${pct}%)</span>`:''}</div>
        ${w<=15?`<span style="position:absolute;left:${w+2}%;top:4px;font-size:10px;font-weight:600;color:#666;">${g.count}건</span>`:''}
      </div><div style="width:60px;font-size:10px;color:#888;text-align:right;">${g.people}명</div></div>`;
  });bc+=`</div>`;
  const allMo=[...new Set(active.map(b=>b.date.substring(0,7)))].sort().slice(-12);
  if(allMo.length>=1){
    bc+=`<div style="margin-top:20px;font-size:12px;font-weight:700;margin-bottom:10px;">📊 월별 단체유형 분포</div>`;
    bc+=`<div style="display:flex;align-items:flex-end;gap:6px;height:200px;overflow-x:auto;padding-bottom:4px;">`;
    const mxMo=Math.max(...allMo.map(mo=>active.filter(b=>b.date.startsWith(mo)).length),1);
    allMo.forEach(mo=>{
      const moB=active.filter(b=>b.date.startsWith(mo));
      const moTot=moB.length;
      let st='';
      cn.forEach(c=>{
        const cnt=moB.filter(b=>(b.category||'기타')===c).length;
        if(cnt>0){
          const h=Math.max(8,Math.round(cnt/mxMo*170));
          const pct=Math.round(cnt/moTot*100);
          const clrL=CAT_COLORS_L[c]||'#cfd8dc';
          const clr=CAT_COLORS[c]||'#78909c';
          st+=`<div style="height:${h}px;background:linear-gradient(180deg,${clrL},${clr});width:100%;display:flex;align-items:center;justify-content:center;position:relative;" title="${c}: ${cnt}건 (${pct}%)">
            ${h>=18?`<span style="font-size:8px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.3);">${cnt}<span style="font-size:7px;">(${pct}%)</span></span>`:''}
          </div>`;
        }
      });
      bc+=`<div style="display:flex;flex-direction:column-reverse;align-items:center;flex-shrink:0;width:56px;">
        <div style="font-size:9px;color:#888;margin-top:4px;font-weight:600;">${mo.substring(5)}월</div>
        <div style="font-size:8px;color:#555;font-weight:700;margin-top:1px;">${moTot}건</div>
        <div style="width:42px;display:flex;flex-direction:column-reverse;border-radius:6px 6px 0 0;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.1);">${st}</div>
      </div>`;
    });
    bc+=`</div>`;
    bc+=`<div style="display:flex;gap:12px;justify-content:center;margin-top:10px;flex-wrap:wrap;font-size:10px;">`;
    cn.forEach(c=>bc+=`<span style="display:flex;align-items:center;gap:3px;"><span style="display:inline-block;width:12px;height:12px;background:linear-gradient(180deg,${CAT_COLORS_L[c]||'#cfd8dc'},${CAT_COLORS[c]||'#78909c'});border-radius:3px;"></span>${c}</span>`);
    bc+=`</div>`;
  }

  // Yearly stats
  const allYears=[...new Set(active.map(b=>b.date.substring(0,4)))].sort();
  if(allYears.length>=1){
    bc+=`<div style="margin-top:24px;font-size:12px;font-weight:700;margin-bottom:10px;">📅 연도별 단체유형 통계</div>`;
    bc+=`<div style="overflow-x:auto;"><table class="tbl" style="font-size:10px;"><thead><tr><th style="min-width:50px;">연도</th>`;
    cn.forEach(c=>{const clr=CAT_COLORS[c]||'#78909c';bc+=`<th><span style="display:inline-block;width:8px;height:8px;background:${clr};border-radius:2px;margin-right:3px;vertical-align:middle;"></span>${c}</th>`;});
    bc+=`<th style="font-weight:900;background:#f0f8e8;">합계</th></tr></thead><tbody>`;

    const yrTotals={};cn.forEach(c=>yrTotals[c]={c:0,p:0,e:0});let yrGrand={c:0,p:0,e:0};
    allYears.forEach(yr=>{
      const yrB=active.filter(b=>b.date.startsWith(yr));
      const yrTotal=yrB.length;
      bc+=`<tr><td style="font-weight:700;">${yr}년</td>`;
      cn.forEach(c=>{
        const cB=yrB.filter(b=>(b.category||'기타')===c);
        const cnt=cB.length;const ppl=cB.reduce((s,b)=>s+b.students+b.teachers,0);
        const est=cB.reduce((s,b)=>s+getEstimate(b),0);
        const pct=yrTotal>0?Math.round(cnt/yrTotal*100):0;
        yrTotals[c].c+=cnt;yrTotals[c].p+=ppl;yrTotals[c].e+=est;
        if(cnt===0){bc+=`<td style="text-align:center;color:#ddd;">-</td>`;return;}
        const intensity=Math.max(0.03,cnt/Math.max(...cn.map(cc=>yrB.filter(b=>(b.category||'기타')===cc).length),1)*0.15);
        bc+=`<td style="vertical-align:top;padding:5px 8px;background:rgba(76,175,80,${intensity});">
          <div><strong>${cnt}</strong>건 (${pct}%) · ${ppl}명</div>
          <div style="color:var(--p);font-size:9px;">₩${fmtWon(est)}</div>
        </td>`;
      });
      const yrPpl=yrB.reduce((s,b)=>s+b.students+b.teachers,0);
      const yrEst=yrB.reduce((s,b)=>s+getEstimate(b),0);
      yrGrand.c+=yrTotal;yrGrand.p+=yrPpl;yrGrand.e+=yrEst;
      bc+=`<td style="vertical-align:top;padding:5px 8px;background:#f0f8e8;font-weight:700;">
        <div><strong>${yrTotal}</strong>건 · ${yrPpl}명</div>
        <div style="color:var(--p);font-size:9px;">₩${fmtWon(yrEst)}</div>
      </td></tr>`;
    });

    if(allYears.length>1){
      bc+=`<tr style="background:#f0f8e8;font-weight:900;"><td>전체</td>`;
      cn.forEach(c=>{const t=yrTotals[c];
        if(t.c===0){bc+=`<td style="text-align:center;color:#ddd;">-</td>`;return;}
        bc+=`<td style="vertical-align:top;padding:5px 8px;"><div><strong>${t.c}</strong>건 · ${t.p}명</div><div style="color:var(--p);font-size:9px;">₩${fmtWon(t.e)}</div></td>`;
      });
      bc+=`<td style="vertical-align:top;padding:5px 8px;background:#e8f5e9;border:2px solid var(--p);border-radius:4px;"><div><strong>${yrGrand.c}</strong>건 · ${yrGrand.p}명</div><div style="color:var(--p);font-size:9px;">₩${fmtWon(yrGrand.e)}</div></td></tr>`;
    }
    bc+=`</tbody></table></div>`;
  }
  document.getElementById('catChart').innerHTML=bc;

  // Table
  document.getElementById('catTable').innerHTML=`<table class="tbl" style="font-size:11px;"><thead><tr><th>유형</th><th>예약건</th><th>비율</th><th>총인원</th><th>견적합계</th><th>실결제</th><th>평균인원</th></tr></thead><tbody>
  ${cn.map(c=>{const g=cats[c];const pct=Math.round(g.count/tot*100);const clr=CAT_COLORS[c]||'#78909c';
    return `<tr onmouseenter="showCrossTip(event,'__total__','${c}')" onmouseleave="hideCrossTip()" onclick="filterCrossClick('__total__','${c}')" style="cursor:pointer;"><td><span style="display:inline-block;width:8px;height:8px;background:${clr};border-radius:2px;margin-right:4px;"></span><strong>${c}</strong></td>
      <td>${g.count}</td><td><div style="background:#eee;border-radius:8px;height:12px;width:60px;overflow:hidden;display:inline-block;vertical-align:middle;"><div style="height:100%;width:${pct}%;background:${clr};border-radius:8px;"></div></div> ${pct}%</td>
      <td>${g.people}명</td><td style="color:var(--p);">₩${fmtWon(g.est)}</td><td style="color:#1565C0;">₩${fmtWon(g.paid)}</td><td>${Math.round(g.people/g.count)}명</td></tr>`;
  }).join('')}</tbody></table>`;

  // Monthly × Category cross-tab
  const allMoFull=[...new Set(active.map(b=>b.date.substring(0,7)))].sort();
  if(allMoFull.length>=1){
    let ct=`<div style="font-size:13px;font-weight:700;margin-bottom:10px;">📊 월별 × 유형별 상세</div>`;
    ct+=`<div id="catCrossGrid"></div>`;
    document.getElementById('catCross').innerHTML=ct;
    renderCrossGrid(active,allMoFull,cn);
  }
  generateCatInsight();
}

function renderCrossGrid(active,allMo,cn){
  // Build multi-metric grid + booking lists
  const grid={};const gridBks={};const moTot={};const catTot={};let grand={c:0,p:0,e:0,a:0};
  allMo.forEach(mo=>{grid[mo]={};gridBks[mo]={};moTot[mo]={c:0,p:0,e:0,a:0};});
  cn.forEach(c=>catTot[c]={c:0,p:0,e:0,a:0});

  active.forEach(b=>{
    const mo=b.date.substring(0,7);const c=b.category||'기타';
    if(!grid[mo])grid[mo]={};if(!gridBks[mo])gridBks[mo]={};
    if(!grid[mo][c])grid[mo][c]={c:0,p:0,e:0,a:0};
    if(!gridBks[mo][c])gridBks[mo][c]=[];
    const ppl=b.students+b.teachers;const est=getEstimate(b);const act=getEstimate(b,true);
    grid[mo][c].c++;grid[mo][c].p+=ppl;grid[mo][c].e+=est;grid[mo][c].a+=act;
    gridBks[mo][c].push(b);
    moTot[mo].c++;moTot[mo].p+=ppl;moTot[mo].e+=est;moTot[mo].a+=act;
    if(!catTot[c])catTot[c]={c:0,p:0,e:0,a:0};
    catTot[c].c++;catTot[c].p+=ppl;catTot[c].e+=est;catTot[c].a+=act;
    grand.c++;grand.p+=ppl;grand.e+=est;grand.a+=act;
  });

  // Store for popup access
  window._crossBks=gridBks;
  window._crossMoTotBks={};
  allMo.forEach(mo=>{window._crossMoTotBks[mo]=active.filter(b=>b.date.startsWith(mo));});
  window._crossCatTotBks={};
  cn.forEach(c=>{window._crossCatTotBks[c]=active.filter(b=>(b.category||'기타')===c);});

  const maxCnt=Math.max(...allMo.flatMap(mo=>cn.map(c=>grid[mo]?.[c]?.c||0)),1);

  function fmtCell(d){
    if(!d||d.c===0)return `<span style="color:#ddd;">-</span>`;
    return `<div style="line-height:1.4;">
      <div><strong>${d.c}</strong>건 · <strong>${d.p}</strong>명</div>
      <div style="color:var(--p);">₩${fmtWon(d.e)}</div>
      ${d.a!==d.e?`<div style="color:#c2185b;font-size:9px;">실제 ₩${fmtWon(d.a)}</div>`:''}
    </div>`;
  }

  let h=`<table class="tbl" style="font-size:10px;border-collapse:collapse;"><thead><tr><th style="position:sticky;left:0;background:#f9f9f9;z-index:1;min-width:60px;">월</th>`;
  cn.forEach(c=>{const clr=CAT_COLORS[c]||'#78909c';h+=`<th style="min-width:100px;"><span style="display:inline-block;width:8px;height:8px;background:${clr};border-radius:2px;margin-right:3px;vertical-align:middle;"></span>${c}</th>`;});
  h+=`<th style="min-width:100px;font-weight:900;background:#f0f8e8;">합계</th></tr></thead><tbody>`;

  allMo.forEach(mo=>{
    h+=`<tr><td style="font-weight:700;white-space:nowrap;position:sticky;left:0;background:#fff;z-index:1;vertical-align:top;padding:8px 6px;">${mo.substring(2).replace('-','.')}월</td>`;
    cn.forEach(c=>{
      const d=grid[mo]?.[c];
      const intensity=d?Math.round(d.c/maxCnt*100):0;
      const bg=d&&d.c>0?`rgba(76,175,80,${Math.max(0.03,intensity/100*0.15)})`:'';
      const hover=d&&d.c>0?` onmouseenter="showCrossTip(event,'${mo}','${c}')" onmouseleave="hideCrossTip()" style="vertical-align:top;padding:6px 8px;background:${bg};cursor:pointer;" onclick="filterCrossClick('${mo}','${c}')"`:`style="vertical-align:top;padding:6px 8px;"`;
      h+=`<td ${hover}>${fmtCell(d)}</td>`;
    });
    h+=`<td onmouseenter="showCrossTip(event,'${mo}','__total__')" onmouseleave="hideCrossTip()" onclick="filterCrossClick('${mo}','__total__')" style="vertical-align:top;padding:6px 8px;background:#f0f8e8;font-weight:700;cursor:pointer;">${fmtCell(moTot[mo])}</td></tr>`;
  });

  h+=`<tr style="background:#f0f8e8;"><td style="font-weight:900;position:sticky;left:0;background:#f0f8e8;z-index:1;padding:8px 6px;">합계</td>`;
  cn.forEach(c=>{h+=`<td onmouseenter="showCrossTip(event,'__total__','${c}')" onmouseleave="hideCrossTip()" onclick="filterCrossClick('__total__','${c}')" style="vertical-align:top;padding:6px 8px;font-weight:700;cursor:pointer;">${fmtCell(catTot[c])}</td>`;});
  h+=`<td style="vertical-align:top;padding:6px 8px;font-weight:900;background:#e8f5e9;border:2px solid var(--p);border-radius:6px;">${fmtCell(grand)}</td></tr>`;
  h+=`</tbody></table>`;

  document.getElementById('catCrossGrid').innerHTML=h;
}

function getCrossBks(mo,cat){
  if(mo==='__total__'&&cat==='__total__')return bks.filter(b=>b.status!=='취소');
  if(mo==='__total__')return window._crossCatTotBks?.[cat]||[];
  if(cat==='__total__')return window._crossMoTotBks?.[mo]||[];
  return window._crossBks?.[mo]?.[cat]||[];
}

function buildCrossTipHTML(list){
  if(!list.length)return '';
  const sc=b=>b.status==='확정'?'#4caf50':b.status==='대기'?'#ff9800':'#f44336';
  let h=`<div style="max-height:280px;overflow-y:auto;">`;
  list.forEach(b=>{
    const est=getEstimate(b);const act=getEstimate(b,true);
    const hasAct=b.actualStudents!=null;
    h+=`<div onclick="hideCrossTipForce();showDtl(${b.id})" style="padding:6px 8px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;gap:8px;align-items:flex-start;" onmouseenter="this.style.background='#f5f5f5'" onmouseleave="this.style.background=''">
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:11px;">${b.date} ${b.name} <span style="color:${sc(b)};font-size:9px;">${b.status}</span></div>
        <div style="font-size:10px;color:#666;">${b.arrival}~${b.departure} · ${b.students+b.teachers}명${hasAct?` → <span style="color:#c2185b;">실제${(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers)}명</span>`:''}</div>
        <div style="font-size:10px;">₩${fmtWon(est)}${hasAct&&act!==est?` <span style="color:#c2185b;">실제₩${fmtWon(act)}</span>`:''}</div>
        ${b.addons?.length?`<div style="font-size:9px;color:#7b1fa2;">${b.addons.join(', ')}</div>`:''}
        ${b.meal&&b.meal!=='이용안함'?`<div style="font-size:9px;color:#c2185b;">🍚${b.meal}</div>`:''}
      </div>
      <div style="font-size:9px;color:#42a5f5;white-space:nowrap;padding-top:2px;">상세→</div>
    </div>`;
  });
  h+=`</div>`;
  return h;
}

function showCrossTip(ev,mo,cat){
  const list=getCrossBks(mo,cat);if(!list.length)return;
  clearTimeout(window._crossHideTimer);
  let tip=document.getElementById('crossTipBox');
  if(!tip){tip=document.createElement('div');tip.id='crossTipBox';
    tip.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid #81c784;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,.2);max-width:360px;min-width:260px;overflow:hidden;';
    tip.onmouseenter=()=>clearTimeout(window._crossHideTimer);
    tip.onmouseleave=()=>{window._crossHideTimer=setTimeout(()=>{tip.style.display='none';},150);};
    document.body.appendChild(tip);}
  const moLabel=mo==='__total__'?'전체':mo.substring(2).replace('-','.')+'월';
  const catLabel=cat==='__total__'?'전체':cat;
  tip.innerHTML=`<div style="background:var(--p);color:#fff;padding:6px 12px;font-size:11px;font-weight:700;">${moLabel} · ${catLabel} — ${list.length}건</div>`+buildCrossTipHTML(list);
  tip.style.display='block';
  tip.style.pointerEvents='auto';
  const el=ev.target.closest('td')||ev.target.closest('tr')||ev.target.closest('div')||ev.target;
  const rect=el.getBoundingClientRect();
  let left=rect.right+8;if(left+360>window.innerWidth)left=rect.left-368;if(left<4)left=4;
  let top=rect.top;if(top+tip.offsetHeight>window.innerHeight-10)top=window.innerHeight-tip.offsetHeight-10;if(top<4)top=4;
  tip.style.left=left+'px';tip.style.top=top+'px';
}
function hideCrossTip(){
  window._crossHideTimer=setTimeout(()=>{
    const t=document.getElementById('crossTipBox');
    if(t)t.style.display='none';
  },150);
}
function hideCrossTipForce(){clearTimeout(window._crossHideTimer);const t=document.getElementById('crossTipBox');if(t)t.style.display='none';}
function filterCrossClick(mo,cat){
  const list=getCrossBks(mo,cat);if(!list.length)return;
  if(list.length===1){hideCrossTipForce();showDtl(list[0].id);return;}
  // Show the tip persistently
  const tip=document.getElementById('crossTipBox');
  if(tip)tip.style.pointerEvents='auto';
}

// ===== CUSTOMER: CALENDAR =====
let ccY,ccMo;
function iCCal(){const n=new Date();ccY=n.getFullYear();ccMo=n.getMonth();}
function ccM(d){if(d===0){const n=new Date();ccY=n.getFullYear();ccMo=n.getMonth();}else{ccMo+=d;if(ccMo>11){ccMo=0;ccY++;}if(ccMo<0){ccMo=11;ccY--;}};rCCal();}

function rCCal(){
  const ccYSel=document.getElementById('ccYearSel');
  const ccMSel=document.getElementById('ccMonthSel');
  const ccCurYear=new Date().getFullYear();
  if(!ccYSel.options.length||ccYSel._lastRange!==ccCurYear){
    ccYSel.innerHTML='';for(let y=ccCurYear-5;y<=ccCurYear+3;y++){const o=document.createElement('option');o.value=y;o.textContent=y;ccYSel.appendChild(o);}ccYSel._lastRange=ccCurYear;
  }
  if(!ccMSel.options.length){
    ccMSel.innerHTML='';for(let m=1;m<=12;m++){const o=document.createElement('option');o.value=m-1;o.textContent=m;ccMSel.appendChild(o);}
  }
  ccYSel.value=ccY;ccMSel.value=ccMo;
  const g=document.getElementById('ccG');const ds=['일','월','화','수','목','금','토'];
  let h=ds.map(d=>`<div class="cdh">${d}</div>`).join('');
  const fd=new Date(ccY,ccMo,1).getDay(),ld=new Date(ccY,ccMo+1,0).getDate(),pld=new Date(ccY,ccMo,0).getDate();
  const ts=td();let mc=0,mp=0;

  for(let i=fd-1;i>=0;i--)h+=`<div class="ccell oth"><div class="dn">${pld-i}</div></div>`;
  for(let d=1;d<=ld;d++){
    const ds2=`${ccY}-${String(ccMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const db=bks.filter(b=>b.date===ds2&&b.status!=='취소');
    mc+=db.length;mp+=db.reduce((s,b)=>s+b.students+b.teachers,0);
    const dp=db.reduce((s,b)=>s+b.students+b.teachers,0);
    let inner='';
    if(db.length){
      inner+=`<div class="day-summary"><span class="ds-badge ds-team">${db.length}팀</span><span class="ds-badge ds-ppl">${dp}명</span></div>`;
      db.forEach(b=>{
        const sc=b.status==='확정'?'#27ae60':'#f39c12';
        inner+=`<div class="chip" style="background:${sc}15;color:${sc};border:1px solid ${sc}30;">${b.name}</div>`;
      });
    }
    h+=`<div class="ccell ${ds2===ts?'today':''}" onclick="ccSelDay('${ds2}')"><div class="dn">${d}</div>${inner}</div>`;
  }
  const rem=(7-(fd+ld)%7)%7;for(let d=1;d<=rem;d++)h+=`<div class="ccell oth"><div class="dn">${d}</div></div>`;
  g.innerHTML=h;
  document.getElementById('ccMC').textContent=`이번달: ${mc}팀 / ${mp}명`;

  // Monthly summary
  const mBks=bks.filter(b=>{const bd=new Date(b.date);return bd.getFullYear()===ccY&&bd.getMonth()===ccMo&&b.status!=='취소';});
  const mStu=mBks.reduce((s,b)=>s+b.students,0);
  const mTea=mBks.reduce((s,b)=>s+b.teachers,0);
  document.getElementById('ccMonthSummary').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
      <div style="padding:16px;background:#e8f5e9;border-radius:10px;"><div style="font-size:24px;font-weight:900;color:var(--p);">${mc}</div><div style="font-size:11px;color:#666;">총 팀수</div></div>
      <div style="padding:16px;background:#e3f2fd;border-radius:10px;"><div style="font-size:24px;font-weight:900;color:var(--blu);">${mp}</div><div style="font-size:11px;color:#666;">총 인원</div></div>
      <div style="padding:16px;background:#fff3e0;border-radius:10px;"><div style="font-size:24px;font-weight:900;color:var(--org);">${mStu}</div><div style="font-size:11px;color:#666;">아동</div></div>
    </div>`;
}

function ccSelDay(ds){
  const db=bks.filter(b=>b.date===ds&&b.status!=='취소');
  const card=document.getElementById('ccDayCard');
  if(!db.length){card.style.display='none';return;}
  card.style.display='block';
  const d=new Date(ds);const dayNames=['일','월','화','수','목','금','토'];
  const dp=db.reduce((s,b)=>s+b.students+b.teachers,0);
  document.getElementById('ccDayTitle').textContent=`📅 ${d.getMonth()+1}/${d.getDate()} (${dayNames[d.getDay()]}) — ${db.length}팀 / ${dp}명`;
  document.getElementById('ccDayBody').innerHTML=db.map((b,i)=>{
    const sc=b.status==='확정'?'var(--grn)':'var(--org)';
    const c=CL[i%CL.length];
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px;border-radius:10px;background:${c.b};border-left:4px solid ${c.r};">
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:700;color:${c.t};">${b.name}</div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:6px;font-size:12px;color:#666;">
          <span>⏰ ${b.arrival}~${b.departure}</span>
          <span>👥 아동 ${b.students} + 인솔 ${b.teachers} = <strong>${b.students+b.teachers}명</strong>${b.actualStudents!=null?` <span style="color:#c2185b;font-size:11px;">→ 실제 ${(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers)}명</span>`:''}</span>
          <span>🎫 ${b.courseType}</span>
          ${b.meal&&b.meal.includes('이용함')?'<span>🍚 단체식</span>':''}
        </div>
      </div>
      <span class="bdg" style="background:${sc}20;color:${sc};border:1px solid ${sc};">${b.status}</span>
    </div>`;
  }).join('');
  card.scrollIntoView({behavior:'smooth',block:'nearest'});
}

// ===== ADMIN: CALENDAR =====
function iCal(){const n=new Date();cY=n.getFullYear();cMo=n.getMonth();}
function cM(d){if(d===0){const n=new Date();cY=n.getFullYear();cMo=n.getMonth();}else{cMo+=d;if(cMo>11){cMo=0;cY++;}if(cMo<0){cMo=11;cY--;}};rCal();}
let _aiBoxId=0;
function mkAiBox(summary,details){
  const id='aiBox'+(++_aiBoxId);
  const detailHtml=details.map(d=>`<div style="padding:4px 0;display:flex;align-items:flex-start;gap:6px;"><span style="color:#1565C0;font-size:12px;margin-top:2px;">•</span><span>${d}</span></div>`).join('');
  return `<div style="background:linear-gradient(135deg,#EBF5FB,#E3F2FD);border-left:4px solid #1565C0;border-radius:10px;padding:12px 16px;margin:10px 0;cursor:pointer;box-shadow:0 2px 8px rgba(21,101,192,.08);transition:box-shadow .15s;" onmouseenter="this.style.boxShadow='0 4px 16px rgba(21,101,192,.15)'" onmouseleave="this.style.boxShadow='0 2px 8px rgba(21,101,192,.08)'" onclick="var d=document.getElementById('${id}'),a=document.getElementById('${id}a');if(d.style.display==='none'){d.style.display='block';a.textContent='▼';}else{d.style.display='none';a.textContent='▶';}">
    <div style="display:flex;align-items:center;gap:8px;">
      <span id="${id}a" style="font-size:11px;color:#1565C0;font-weight:800;">▶</span>
      <span style="font-size:16px;">🤖</span>
      <span style="font-size:13px;font-weight:800;color:#1565C0;">AI</span>
      <span style="font-size:13px;color:#222;font-weight:600;">${summary}</span>
    </div>
    <div id="${id}" style="display:none;font-size:13px;color:#333;line-height:1.8;margin-top:8px;padding-top:8px;border-top:2px solid rgba(21,101,192,.12);">${detailHtml}</div>
  </div>`;
}
function rCal(){
  _aiBoxId=0;
  // Populate year/month selectors
  const ySel=document.getElementById('cYearSel');
  const mSel=document.getElementById('cMonthSel');
  const curRealYear=new Date().getFullYear();
  if(!ySel.options.length||ySel._lastRange!==curRealYear){
    ySel.innerHTML='';for(let y=curRealYear-5;y<=curRealYear+3;y++){const o=document.createElement('option');o.value=y;o.textContent=y;ySel.appendChild(o);}ySel._lastRange=curRealYear;
  }
  if(!mSel.options.length){
    mSel.innerHTML='';for(let m=1;m<=12;m++){const o=document.createElement('option');o.value=m-1;o.textContent=m;mSel.appendChild(o);}
  }
  ySel.value=cY;mSel.value=cMo;
  const g=document.getElementById('cG');const ds=['일','월','화','수','목','금','토'];
  let h=ds.map(d=>`<div class="cdh">${d}</div>`).join('');
  const fd=new Date(cY,cMo,1).getDay(),ld=new Date(cY,cMo+1,0).getDate(),pld=new Date(cY,cMo,0).getDate();
  const ts=td();let mc=0,mp=0;
  for(let i=fd-1;i>=0;i--)h+=`<div class="ccell oth"><div class="dn">${pld-i}</div></div>`;
  for(let d=1;d<=ld;d++){
    const ds2=`${cY}-${String(cMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const db=bks.filter(b=>b.date===ds2&&b.status!=='취소');mc+=db.length;mp+=db.reduce((s,b)=>s+b.students+b.teachers,0);
    const dp=db.reduce((s,b)=>s+b.students+b.teachers,0);
    let sumBadge='';if(db.length)sumBadge=`<div class="day-summary"><span class="ds-badge ds-team">${db.length}팀</span><span class="ds-badge ds-ppl">${dp}명</span></div>`;
    let ch='';db.forEach(b=>{const sc=b.status==='확정'?'#27ae60':'#f39c12';ch+=`<div class="chip" style="background:${sc}20;color:${sc};border:1px solid ${sc}40;">${b.name}(${b.students+b.teachers})</div>`;});
    const lim=getDayLimit(ds2);
    const hasLim=lim.maxPpl||lim.maxMeal||lim.maxExp||lim.memo;
    let limDn='';
    if(hasLim){
      const curPpl=dp;
      const curMeal=db.filter(b=>b.meal&&b.meal!=='이용안함').reduce((s,b)=>s+b.students+b.teachers,0);
      const curExp=db.filter(b=>b.addons&&b.addons.length).length;
      let tags=[];
      if(lim.maxPpl){const rem=lim.maxPpl-curPpl;const ov=rem<=0;tags.push(`<span style="font-size:8px;padding:0 3px;border-radius:2px;background:${ov?'#f44336':'#e8f5e9'};color:${ov?'#fff':'#2e7d32'};font-weight:700;line-height:1.5;">${ov?'마감':'잔여'+rem+'명'}</span>`);}
      if(lim.maxMeal){const rem=lim.maxMeal-curMeal;const ov=rem<=0;tags.push(`<span style="font-size:8px;padding:0 3px;border-radius:2px;background:${ov?'#f44336':'#fce4ec'};color:${ov?'#fff':'#c2185b'};font-weight:700;line-height:1.5;">식사${ov?'마감':'잔여'+rem}</span>`);}
      if(lim.maxExp){const rem=lim.maxExp-curExp;const ov=rem<=0;tags.push(`<span style="font-size:8px;padding:0 3px;border-radius:2px;background:${ov?'#f44336':'#f3e5f5'};color:${ov?'#fff':'#7b1fa2'};font-weight:700;line-height:1.5;">체험${ov?'마감':'잔여'+rem}</span>`);}
      limDn='<div style="display:flex;flex-wrap:wrap;gap:1px;margin-top:1px;">'+tags.join('')+'</div>';
    }
    h+=`<div class="ccell ${ds2===ts?'today':''}" onclick="sCd('${ds2}')"><div class="dn">${d}</div>${sumBadge}${limDn}${ch}</div>`;
  }
  const rem=(7-(fd+ld)%7)%7;for(let d=1;d<=rem;d++)h+=`<div class="ccell oth"><div class="dn">${d}</div></div>`;
  g.innerHTML=h;document.getElementById('cMC').textContent=`이번달: ${mc}팀 / ${mp}명`;

  // Monthly stats breakdown
  const mBks=bks.filter(b=>{const bd=new Date(b.date);return bd.getFullYear()===cY&&bd.getMonth()===cMo&&b.status!=='취소';});
  const mConf=mBks.filter(b=>b.status==='확정');
  const mPend=mBks.filter(b=>b.status==='대기');
  const mStu=mBks.reduce((s,b)=>s+b.students,0);
  const mTea=mBks.reduce((s,b)=>s+b.teachers,0);

  // Per-day data for mini bar chart
  const dayData={};
  for(let d=1;d<=ld;d++){
    const ds2=`${cY}-${String(cMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const db=mBks.filter(b=>b.date===ds2);
    if(db.length) dayData[d]={teams:db.length, ppl:db.reduce((s,b)=>s+b.students+b.teachers,0)};
  }
  const maxPpl=Math.max(1,...Object.values(dayData).map(v=>v.ppl));

  let statsHtml=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:8px;">
    <div style="display:flex;align-items:baseline;justify-content:center;gap:3px;padding:6px 4px;background:#e8f5e9;border-radius:8px;"><span style="font-size:13px;color:#1a472a;font-weight:700;">팀</span><span style="font-size:16px;font-weight:900;color:#1a472a;">${mc}</span></div>
    <div style="display:flex;align-items:baseline;justify-content:center;gap:3px;padding:6px 4px;background:#e3f2fd;border-radius:8px;"><span style="font-size:13px;color:#1565c0;font-weight:700;">인원</span><span style="font-size:16px;font-weight:900;color:#1565c0;">${mp}</span></div>
    <div style="display:flex;align-items:baseline;justify-content:center;gap:3px;padding:6px 4px;background:#fff3e0;border-radius:8px;"><span style="font-size:13px;color:#e65100;font-weight:700;">아동</span><span style="font-size:16px;font-weight:900;color:#e65100;">${mStu}</span></div>
    <div style="display:flex;align-items:baseline;justify-content:center;gap:3px;padding:6px 4px;background:#f3e5f5;border-radius:8px;"><span style="font-size:13px;color:#7b1fa2;font-weight:700;">인솔</span><span style="font-size:16px;font-weight:900;color:#7b1fa2;">${mTea}</span></div>
  </div>
  <div style="display:flex;gap:14px;margin-bottom:8px;font-size:13px;color:#333;font-weight:600;">
    <span>✅ 확정 <strong style="color:#1b5e20;font-size:14px;">${mConf.length}팀 / ${mConf.reduce((s,b)=>s+b.students+b.teachers,0)}명</strong></span>
    <span>⏳ 대기 <strong style="color:#e65100;font-size:14px;">${mPend.length}팀 / ${mPend.reduce((s,b)=>s+b.students+b.teachers,0)}명</strong></span>
  </div>`;

  // AI analysis - monthly summary
  const confRate=mc?Math.round((mConf.length/mc)*100):0;
  const avgPpl=mc?Math.round(mp/mc):0;
  const teaRatio=mp?Math.round((mTea/mp)*100):0;
  let aiMonth=[];
  if(mc===0) aiMonth.push('이번 달 예약이 아직 없습니다. 홍보 채널을 점검해보세요.');
  else {
    aiMonth.push(`팀당 평균 ${avgPpl}명 방문, 인솔자 비율 ${teaRatio}%입니다.`);
    if(mPend.length>0) aiMonth.push(`대기 ${mPend.length}팀(${mPend.reduce((s,b)=>s+b.students+b.teachers,0)}명)이 확정 대기 중입니다. 빠른 확인이 필요합니다.`);
    else aiMonth.push('모든 예약이 확정 완료된 상태입니다.');
    if(confRate<50&&mc>0) aiMonth.push(`확정률 ${confRate}%로 낮은 편입니다. 대기 예약 확정 처리를 서둘러주세요.`);
    else if(mc>0) aiMonth.push(`확정률 ${confRate}%로 양호합니다.`);
  }
  statsHtml+=mkAiBox(aiMonth[0],aiMonth);

  // Mini bar chart
  if(Object.keys(dayData).length){
    statsHtml+=`<div style="font-size:15px;font-weight:900;color:#222;margin:12px 0 8px;">📊 일별 예약 인원</div>`;
    statsHtml+=`<div style="display:flex;align-items:flex-end;gap:2px;height:70px;">`;
    for(let d=1;d<=ld;d++){
      const dd=dayData[d];
      const ds2=`${cY}-${String(cMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      if(dd){
        const pct=Math.max(8,Math.round((dd.ppl/maxPpl)*100));
        statsHtml+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;cursor:pointer;" title="${d}일: ${dd.teams}팀 ${dd.ppl}명" onclick="sCd('${ds2}');document.getElementById('dCard').scrollIntoView({behavior:'smooth',block:'start'});">
          <div style="font-size:10px;font-weight:800;color:#1a472a;margin-bottom:1px;">${dd.ppl}</div>
          <div style="width:100%;max-width:20px;height:${pct}%;background:linear-gradient(180deg,var(--p3),var(--p));border-radius:3px 3px 0 0;min-height:4px;"></div>
        </div>`;
      } else {
        statsHtml+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;">
          <div style="width:100%;max-width:20px;height:2px;background:#eee;border-radius:1px;"></div>
        </div>`;
      }
    }
    statsHtml+=`</div>`;
    // Day button row
    statsHtml+=`<div style="display:flex;gap:1px;margin-top:4px;overflow-x:auto;padding-bottom:2px;">`;
    for(let d=1;d<=ld;d++){
      const dd=dayData[d];
      const ds2=`${cY}-${String(cMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const hasData=!!dd;
      statsHtml+=`<div onclick="${hasData?`sCd('${ds2}');document.getElementById('dCard').scrollIntoView({behavior:'smooth',block:'start'});`:''}" style="min-width:22px;flex:1;text-align:center;padding:5px 0;border-radius:5px;font-size:13px;font-weight:${hasData?'900':'500'};color:${hasData?'#fff':'#7a9e7a'};background:${hasData?'var(--p)':'#e8f5e9'};cursor:${hasData?'pointer':'default'};transition:all .12s;" ${hasData?`onmouseenter="this.style.background='#2e7d32';this.style.transform='scale(1.15)'" onmouseleave="this.style.background='var(--p)';this.style.transform='scale(1)'"`:''}>${d}</div>`;
    }
    statsHtml+=`</div>`;

    // AI analysis - daily chart
    const dayKeys=Object.keys(dayData).map(Number);
    const dayVals=Object.values(dayData);
    const peakDay=dayKeys.length?dayKeys.reduce((a,b)=>dayData[a].ppl>dayData[b].ppl?a:b):0;
    const busyDays=dayKeys.filter(d=>dayData[d].ppl>=maxPpl*0.7);
    const weekdayNames=['일','월','화','수','목','금','토'];
    let aiDaily=[];
    if(dayKeys.length){
      aiDaily.push(`최대 인원일: ${peakDay}일(${dayData[peakDay].teams}팀/${dayData[peakDay].ppl}명). 예약이 ${dayKeys.length}일에 분포합니다.`);
      if(busyDays.length>1) aiDaily.push(`${busyDays.map(d=>d+'일').join(', ')}이 집중일입니다. 인력 배치에 유의하세요.`);
      const avgDaily=Math.round(dayVals.reduce((s,v)=>s+v.ppl,0)/dayKeys.length);
      aiDaily.push(`예약일 평균 ${avgDaily}명 방문 예정입니다.`);
    }
    if(aiDaily.length) statsHtml+=mkAiBox(aiDaily[0],aiDaily);
  }
  const monthNames=['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
  const monthData=[];
  for(let m=0;m<12;m++){
    const prefix=`${cY}-${String(m+1).padStart(2,'0')}`;
    const mb=bks.filter(b=>b.date.startsWith(prefix)&&b.status!=='취소');
    monthData.push({teams:mb.length,ppl:mb.reduce((s,b)=>s+b.students+b.teachers,0)});
  }
  const maxMPpl=Math.max(1,...monthData.map(v=>v.ppl));

  statsHtml+=`<div style="margin-top:20px;font-size:14px;font-weight:900;color:#1B5E20;margin-bottom:10px;">📅 ${cY}년 월별 예약 인원</div>`;
  statsHtml+=`<div style="display:flex;align-items:flex-end;gap:5px;height:100px;position:relative;">`;
  monthData.forEach((md,i)=>{
    const pct=md.ppl?Math.max(8,Math.round((md.ppl/maxMPpl)*100)):0;
    const isCur=i===cMo;
    const bg=isCur?'linear-gradient(180deg,#FF9800,#E65100)':'linear-gradient(180deg,#81C784,#2E7D32)';
    const border=isCur?'2px solid #E65100':'none';
    statsHtml+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;cursor:pointer;" title="${monthNames[i]}: ${md.teams}팀 ${md.ppl}명" onclick="cMo=${i};rCal();document.getElementById('cG').scrollIntoView({behavior:'smooth',block:'start'});">`;
    if(md.ppl) statsHtml+=`<div style="font-size:11px;font-weight:800;color:${isCur?'#E65100':'#1B5E20'};margin-bottom:2px;">${md.ppl}</div>
      <div style="width:100%;max-width:32px;height:${pct}%;background:${bg};border-radius:5px 5px 0 0;min-height:5px;border:${border};box-shadow:0 2px 4px rgba(0,0,0,.1);"></div>`;
    else statsHtml+=`<div style="width:100%;max-width:32px;height:3px;background:#eee;border-radius:2px;"></div>`;
    statsHtml+=`</div>`;
  });
  statsHtml+=`</div>`;
  // Month button row
  statsHtml+=`<div style="display:flex;gap:4px;margin-top:6px;">`;
  monthData.forEach((md,i)=>{
    const isCur=i===cMo;
    statsHtml+=`<div onclick="cMo=${i};rCal();document.getElementById('cG').scrollIntoView({behavior:'smooth',block:'start'});" style="flex:1;text-align:center;padding:7px 0;border-radius:8px;cursor:pointer;font-size:12px;font-weight:${isCur?'900':'700'};color:${isCur?'#fff':'#2E7D32'};background:${isCur?'linear-gradient(135deg,#FF9800,#E65100)':'#E8F5E9'};border:2px solid ${isCur?'#E65100':'#C8E6C9'};transition:all .15s;box-shadow:${isCur?'0 2px 6px rgba(230,81,0,.3)':'none'};" onmouseenter="this.style.background='${isCur?'#BF360C':'#C8E6C9'}'" onmouseleave="this.style.background='${isCur?'linear-gradient(135deg,#FF9800,#E65100)':'#E8F5E9'}'">${i+1}월</div>`;
  });
  statsHtml+=`</div>`;
  const yearTotal=monthData.reduce((s,m)=>s+m.ppl,0);
  const yearTeams=monthData.reduce((s,m)=>s+m.teams,0);
  statsHtml+=`<div style="text-align:right;margin-top:10px;font-size:13px;color:#555;font-weight:600;">${cY}년 합계: <strong style="color:#1B5E20;font-size:15px;">${yearTeams}팀</strong> / <strong style="color:#1565C0;font-size:15px;">${yearTotal}명</strong></div>`;

  // AI analysis - monthly chart
  const activeMonths=monthData.filter(m=>m.ppl>0);
  const peakMonthIdx=monthData.reduce((a,b,i,arr)=>arr[a].ppl>=b.ppl?a:i,0);
  const curMonthData=monthData[cMo];
  const prevMonthData=cMo>0?monthData[cMo-1]:null;
  let aiMonthly=[];
  if(activeMonths.length){
    aiMonthly.push(`${cY}년 최다 방문월: ${peakMonthIdx+1}월(${monthData[peakMonthIdx].ppl}명). ${activeMonths.length}개월간 예약이 있습니다.`);
    if(prevMonthData&&prevMonthData.ppl>0){
      const diff=curMonthData.ppl-prevMonthData.ppl;
      const pctChg=Math.round((diff/prevMonthData.ppl)*100);
      aiMonthly.push(`전월 대비 ${diff>0?'+':''}${diff}명(${pctChg>0?'+':''}${pctChg}%) ${diff>=0?'증가':'감소'}했습니다.`);
    }
    const avgMonth=Math.round(yearTotal/Math.max(1,activeMonths.length));
    aiMonthly.push(`활동월 평균 ${avgMonth}명이며, 연간 총 ${yearTeams}팀 방문 예정입니다.`);
  } else {
    aiMonthly.push(`${cY}년 예약 데이터가 아직 없습니다.`);
  }
  statsHtml+=mkAiBox(aiMonthly[0],aiMonthly);
  const curFullYear=new Date().getFullYear();
  const yearStart=curFullYear-4;
  const yearData=[];
  for(let y=yearStart;y<=curFullYear;y++){
    const prefix=`${y}-`;
    const yb=bks.filter(b=>b.date.startsWith(prefix)&&b.status!=='취소');
    const mArr=[];
    for(let m=0;m<12;m++){
      const mp=`${y}-${String(m+1).padStart(2,'0')}`;
      const mb=yb.filter(b=>b.date.startsWith(mp));
      mArr.push({teams:mb.length,ppl:mb.reduce((s,b)=>s+b.students+b.teachers,0)});
    }
    yearData.push({year:y,teams:yb.length,ppl:yb.reduce((s,b)=>s+b.students+b.teachers,0),months:mArr});
  }
  const maxYPpl=Math.max(1,...yearData.map(v=>v.ppl));

  statsHtml+=`<div onclick="var w=document.getElementById('yearStatsWrap');w.style.display=w.style.display==='none'?'block':'none';this.querySelector('.yTogArrow').textContent=w.style.display==='none'?'▶':'▼';" style="margin-top:18px;cursor:pointer;display:flex;align-items:center;gap:8px;padding:10px 16px;background:linear-gradient(135deg,#E3F2FD,#BBDEFB);border-radius:10px;border:2px solid #90CAF9;">
    <span class="yTogArrow" style="font-size:12px;color:#1565C0;">▶</span>
    <span style="font-size:13px;font-weight:800;color:#1565C0;">📆 연도별 통계 (최근 5년)</span>
    <span style="font-size:11px;color:#42A5F5;margin-left:auto;font-weight:600;">클릭하여 펼치기</span>
  </div>`;
  statsHtml+=`<div id="yearStatsWrap" style="display:none;margin-top:10px;">`;

  statsHtml+=`<div style="display:flex;align-items:flex-end;gap:16px;height:160px;padding-bottom:30px;position:relative;border-bottom:2px solid #E3F2FD;">`;
  yearData.forEach(yd=>{
    const pct=yd.ppl?Math.max(12,Math.round((yd.ppl/maxYPpl)*100)):0;
    const isCur=yd.year===cY;
    const bg=isCur?'linear-gradient(180deg,#FF9800,#E65100)':'linear-gradient(180deg,#90CAF9,#42A5F5)';
    statsHtml+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;position:relative;cursor:pointer;" title="${yd.year}년: ${yd.teams}팀 ${yd.ppl}명" onclick="event.stopPropagation();toggleYearMonthDetail(${yd.year})">`;
    if(yd.ppl) statsHtml+=`<div style="font-size:14px;font-weight:800;color:${isCur?'#E65100':'#1565C0'};margin-bottom:3px;text-align:center;line-height:1.3;">${yd.teams}팀<br><strong style="font-size:16px;">${yd.ppl}명</strong></div>
      <div style="width:100%;max-width:70px;height:${pct}%;background:${bg};border-radius:8px 8px 0 0;min-height:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);"></div>`;
    else statsHtml+=`<div style="width:100%;max-width:70px;height:4px;background:#eee;border-radius:3px;"></div>`;
    statsHtml+=`<div style="font-size:16px;color:${isCur?'#fff':'#42A5F5'};font-weight:900;position:absolute;bottom:-26px;${isCur?'background:#E65100;padding:2px 10px;border-radius:6px;':''}">${yd.year}</div></div>`;
  });
  statsHtml+=`</div>`;
  statsHtml+=`<p style="font-size:11px;color:#90CAF9;margin:10px 0 0;text-align:center;font-weight:600;">↑ 연도 막대를 클릭하면 월별 상세 + 전년 대비</p>`;

  // AI analysis - yearly chart
  const activeYears=yearData.filter(y=>y.ppl>0);
  let aiYearly=[];
  if(activeYears.length>=2){
    const last=activeYears[activeYears.length-1];
    const prev=activeYears[activeYears.length-2];
    const yDiff=last.ppl-prev.ppl;
    const yPct=prev.ppl?Math.round((yDiff/prev.ppl)*100):0;
    aiYearly.push(`${last.year}년 vs ${prev.year}년: ${yDiff>0?'+':''}${yDiff}명(${yPct>0?'+':''}${yPct}%) ${yDiff>=0?'성장':'감소'}추세입니다.`);
    const peakYear=activeYears.reduce((a,b)=>a.ppl>=b.ppl?a:b);
    aiYearly.push(`최다 방문 연도: ${peakYear.year}년(${peakYear.teams}팀/${peakYear.ppl}명).`);
    const totalAll=activeYears.reduce((s,y)=>s+y.ppl,0);
    aiYearly.push(`최근 ${activeYears.length}년간 총 ${totalAll}명이 방문했습니다.`);
  } else if(activeYears.length===1){
    aiYearly.push(`${activeYears[0].year}년 ${activeYears[0].teams}팀/${activeYears[0].ppl}명 예약 중입니다.`);
    aiYearly.push('비교할 전년 데이터가 없습니다.');
  }
  if(aiYearly.length) statsHtml+=mkAiBox(aiYearly[0],aiYearly);

  window._yearMonthData=yearData;
  statsHtml+=`<div id="yearMonthDetail" style="margin-top:10px;"></div>`;
  statsHtml+=`</div>`;

  document.getElementById('cMonthStats').innerHTML=statsHtml;
}

function toggleYearMonthDetail(year){
  const el=document.getElementById('yearMonthDetail');
  if(!el)return;
  const data=window._yearMonthData;
  if(!data)return;
  const yd=data.find(d=>d.year===year);
  if(!yd){el.innerHTML='';return;}
  if(el.dataset.openYear==year&&el.innerHTML){el.innerHTML='';el.dataset.openYear='';return;}
  el.dataset.openYear=year;

  const prevYd=data.find(d=>d.year===year-1);
  const allMax=Math.max(1,...yd.months.map(m=>m.ppl),...(prevYd?prevYd.months.map(m=>m.ppl):[]));
  const curMo=new Date().getMonth();
  const curDay=new Date().getDate();
  const isCurYear=year===new Date().getFullYear();
  const totalPpl=yd.months.reduce((s,m)=>s+m.ppl,0);
  const totalTeams=yd.months.reduce((s,m)=>s+m.teams,0);
  const prevTotalPpl=prevYd?prevYd.months.reduce((s,m)=>s+m.ppl,0):0;
  const prevTotalTeams=prevYd?prevYd.months.reduce((s,m)=>s+m.teams,0):0;

  let h=`<div style="background:linear-gradient(180deg,#F8FBFF,#E3F2FD);border:2px solid #64B5F6;border-radius:12px;padding:16px;">`;
  // Header with YoY
  h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:6px;">`;
  h+=`<span style="font-size:17px;font-weight:900;color:#1565C0;">📅 ${year}년 월별 상세</span>`;
  if(prevYd){
    const yoyD=totalPpl-prevTotalPpl;const yoyP=prevTotalPpl?Math.round((yoyD/prevTotalPpl)*100):0;
    const clr=yoyD>=0?'#2e7d32':'#c62828';
    h+=`<span style="font-size:14px;padding:5px 14px;border-radius:8px;background:${yoyD>=0?'#E8F5E9':'#FFEBEE'};color:${clr};font-weight:900;">${year-1}년 대비 ${yoyD>=0?'↑':'↓'}${Math.abs(yoyD)}명 (${yoyD>=0?'+':''}${yoyP}%)</span>`;
  }
  h+=`</div>`;

  // Comparison bar chart
  h+=`<div style="display:flex;align-items:flex-end;gap:4px;height:120px;padding-bottom:28px;position:relative;border-bottom:2px solid #E3F2FD;margin-bottom:8px;">`;
  yd.months.forEach((md,i)=>{
    const pct=md.ppl?Math.max(8,Math.round((md.ppl/allMax)*100)):0;
    const prevPct=prevYd&&prevYd.months[i].ppl?Math.max(8,Math.round((prevYd.months[i].ppl/allMax)*100)):0;
    const isCurMo=isCurYear&&i===curMo;
    h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;position:relative;" title="${i+1}월: ${year}년 ${md.ppl}명${prevYd?' / '+(year-1)+'년 '+prevYd.months[i].ppl+'명':''}">`;
    h+=`<div style="display:flex;gap:2px;align-items:flex-end;width:100%;justify-content:center;">`;
    if(prevYd){const pp=prevYd.months[i].ppl;h+=pp?`<div style="width:38%;max-width:16px;height:${prevPct}%;background:#CFD8DC;border-radius:3px 3px 0 0;min-height:3px;"></div>`:`<div style="width:38%;max-width:16px;height:2px;background:#ECEFF1;"></div>`;}
    const bg=isCurMo?'linear-gradient(180deg,#FF9800,#E65100)':md.ppl?'linear-gradient(180deg,#64B5F6,#1565C0)':'#eee';
    h+=md.ppl?`<div style="width:48%;max-width:18px;height:${pct}%;background:${bg};border-radius:3px 3px 0 0;min-height:3px;box-shadow:0 1px 3px rgba(0,0,0,.1);"></div>`:`<div style="width:48%;max-width:18px;height:2px;background:#eee;"></div>`;
    h+=`</div><div style="font-size:11px;color:${isCurMo?'#E65100':'#78909C'};font-weight:${isCurMo?'900':'700'};position:absolute;bottom:-22px;">${i+1}월</div></div>`;
  });
  h+=`</div>`;
  if(prevYd) h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:10px;font-size:12px;font-weight:700;"><span><span style="display:inline-block;width:12px;height:12px;background:#CFD8DC;border-radius:3px;vertical-align:middle;margin-right:4px;"></span>${year-1}년</span><span><span style="display:inline-block;width:12px;height:12px;background:#42A5F5;border-radius:3px;vertical-align:middle;margin-right:4px;"></span>${year}년</span></div>`;

  // Comparison table
  h+=`<div style="overflow-x:auto;margin-top:14px;"><table style="width:100%;border-collapse:collapse;font-size:13px;">`;
  h+=`<tr style="background:linear-gradient(135deg,#E3F2FD,#BBDEFB);"><th style="padding:8px 6px;border:1px solid #90CAF9;font-weight:800;color:#1565C0;font-size:12px;"></th>`;
  for(let i=0;i<12;i++){const ic=isCurYear&&i===curMo;h+=`<th style="padding:7px 4px;border:1px solid #90CAF9;font-weight:800;color:${ic?'#E65100':'#1565C0'};${ic?'background:#FFF3E0;':''}font-size:13px;">${i+1}</th>`;}
  h+=`<th style="padding:7px 4px;border:1px solid #90CAF9;background:#C8E6C9;font-weight:900;color:#2E7D32;font-size:14px;">합계</th></tr>`;

  // Current year
  h+=`<tr style="background:#E8F5E9;"><td colspan="14" style="padding:6px 10px;border:1px solid #C8E6C9;font-weight:900;font-size:13px;color:#2E7D32;">${year}년</td></tr>`;
  h+=`<tr><td style="padding:6px 8px;border:1px solid #ddd;font-weight:800;color:#333;font-size:12px;">팀</td>`;
  yd.months.forEach((md,i)=>{const ic=isCurYear&&i===curMo;h+=`<td style="padding:6px 4px;border:1px solid #ddd;text-align:center;font-weight:700;font-size:13px;${ic?'background:#FFF3E0;color:#E65100;':'color:#333;'}">${md.teams||'-'}</td>`;});
  h+=`<td style="padding:6px;border:1px solid #ddd;text-align:center;background:#E8F5E9;font-weight:900;color:#2E7D32;font-size:16px;">${totalTeams}</td></tr>`;
  h+=`<tr><td style="padding:6px 8px;border:1px solid #ddd;font-weight:800;color:#333;font-size:12px;">명</td>`;
  yd.months.forEach((md,i)=>{const ic=isCurYear&&i===curMo;h+=`<td style="padding:6px 4px;border:1px solid #ddd;text-align:center;font-weight:700;font-size:13px;${ic?'background:#FFF3E0;color:#E65100;':'color:#1565C0;'}">${md.ppl||'-'}</td>`;});
  h+=`<td style="padding:6px;border:1px solid #ddd;text-align:center;background:#E8F5E9;font-weight:900;color:#1565C0;font-size:17px;">${totalPpl}</td></tr>`;

  if(prevYd){
    h+=`<tr style="background:#ECEFF1;"><td colspan="14" style="padding:6px 10px;border:1px solid #CFD8DC;font-weight:900;font-size:13px;color:#546E7A;">${year-1}년</td></tr>`;
    h+=`<tr><td style="padding:6px 8px;border:1px solid #ddd;font-weight:800;color:#546E7A;font-size:12px;">팀</td>`;
    prevYd.months.forEach(md=>{h+=`<td style="padding:6px 4px;border:1px solid #ddd;text-align:center;color:#78909C;font-weight:700;font-size:13px;">${md.teams||'-'}</td>`;});
    h+=`<td style="padding:6px;border:1px solid #ddd;text-align:center;font-weight:900;color:#546E7A;font-size:15px;">${prevTotalTeams}</td></tr>`;
    h+=`<tr><td style="padding:6px 8px;border:1px solid #ddd;font-weight:800;color:#546E7A;font-size:12px;">명</td>`;
    prevYd.months.forEach(md=>{h+=`<td style="padding:6px 4px;border:1px solid #ddd;text-align:center;color:#78909C;font-weight:700;font-size:13px;">${md.ppl||'-'}</td>`;});
    h+=`<td style="padding:6px;border:1px solid #ddd;text-align:center;font-weight:900;color:#546E7A;font-size:15px;">${prevTotalPpl}</td></tr>`;

    // Diff row
    h+=`<tr style="background:#FFF8E1;border-top:3px solid #FFB74D;"><td style="padding:7px 8px;border:1px solid #FFB74D;font-weight:900;color:#E65100;font-size:13px;">증감</td>`;
    yd.months.forEach((md,i)=>{const pv=prevYd.months[i]?.ppl||0;const d=md.ppl-pv;const pct=pv?Math.round((d/pv)*100):d?100:0;const c=d>0?'#2e7d32':d<0?'#c62828':'#aaa';h+=`<td style="padding:6px 3px;border:1px solid #FFB74D;text-align:center;color:${c};font-weight:900;font-size:12px;line-height:1.4;">${d?((d>0?'+':'')+d+'<br><span style=font-size:10px;>'+(d>0?'+':'')+pct+'%</span>'):'-'}</td>`;});
    const td2=totalPpl-prevTotalPpl;const dp=prevTotalPpl?Math.round((td2/prevTotalPpl)*100):(td2?100:0);const dc=td2>0?'#2e7d32':td2<0?'#c62828':'#aaa';
    h+=`<td style="padding:6px;border:1px solid #FFB74D;text-align:center;font-weight:900;color:${dc};font-size:15px;line-height:1.4;">${td2>0?'+':''}${td2}<br><span style=font-size:12px;>${td2>0?'+':''}${dp}%</span></td></tr>`;
  }
  h+=`</table></div>`;

  // Same-period comparison
  if(prevYd&&isCurYear){
    let cp=0,pp=0,ct=0,pt=0;
    for(let m=0;m<=curMo;m++){cp+=yd.months[m].ppl;ct+=yd.months[m].teams;pp+=prevYd.months[m].ppl;pt+=prevYd.months[m].teams;}
    const sd=cp-pp;const sp=pp?Math.round((sd/pp)*100):0;const sc=sd>=0?'#2e7d32':'#c62828';
    h+=`<div style="margin-top:12px;padding:12px 16px;background:linear-gradient(135deg,#FFFDE7,#FFF9C4);border:2px solid #FFD54F;border-radius:10px;">`;
    h+=`<div style="font-size:14px;font-weight:900;color:#F57F17;margin-bottom:8px;">📊 동기간 비교 (1~${curMo+1}월 ${curDay}일 기준)</div>`;
    h+=`<div style="display:flex;gap:16px;flex-wrap:wrap;font-size:14px;align-items:center;">`;
    h+=`<div style="background:#fff;padding:6px 14px;border-radius:8px;border:1px solid #E3F2FD;"><span style="color:#1565C0;font-weight:800;">${year}년:</span> <strong style="font-size:15px;">${ct}팀/${cp}명</strong></div>`;
    h+=`<div style="background:#fff;padding:6px 14px;border-radius:8px;border:1px solid #ECEFF1;"><span style="color:#78909C;font-weight:800;">${year-1}년:</span> <strong style="font-size:15px;">${pt}팀/${pp}명</strong></div>`;
    h+=`<div style="padding:6px 14px;border-radius:8px;font-weight:900;color:#fff;background:${sd>=0?'#2e7d32':'#c62828'};font-size:16px;">${sd>=0?'↑':'↓'}${Math.abs(sd)}명 (${sd>=0?'+':''}${sp}%)</div>`;
    h+=`</div></div>`;
  }
  h+=`</div>`;
  el.innerHTML=h;
}

// ===== DAY LIMITS =====
function getDayLimit(ds){return dayLimits[ds]||{};}
function openDayLimitModal(ds){
  const lim=getDayLimit(ds);
  const d=new Date(ds);const dayNames=['일','월','화','수','목','금','토'];
  const label=`${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}(${dayNames[d.getDay()]})`;
  let h=`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;" id="dlModal" onclick="if(event.target===this)this.remove()">
    <div style="background:#fff;border-radius:14px;width:380px;max-width:95vw;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.3);">
      <div style="background:var(--p);color:#fff;padding:14px 20px;font-weight:800;font-size:14px;">⚙️ ${label} 일별 제한 설정</div>
      <div style="padding:20px;">
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;font-weight:700;color:#333;display:block;margin-bottom:4px;">👥 제한 인원 <span style="font-size:10px;color:#999;">(0=무제한)</span></label>
          <input type="number" id="dlPpl" value="${lim.maxPpl||0}" min="0" style="width:100%;padding:8px 12px;border:2px solid #ddd;border-radius:8px;font-size:14px;outline:none;box-sizing:border-box;" placeholder="예: 100">
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;font-weight:700;color:#333;display:block;margin-bottom:4px;">🍚 제한 식사 인원 <span style="font-size:10px;color:#999;">(0=무제한)</span></label>
          <input type="number" id="dlMeal" value="${lim.maxMeal||0}" min="0" style="width:100%;padding:8px 12px;border:2px solid #ddd;border-radius:8px;font-size:14px;outline:none;box-sizing:border-box;" placeholder="예: 50">
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;font-weight:700;color:#333;display:block;margin-bottom:4px;">🎨 제한 체험 팀수 <span style="font-size:10px;color:#999;">(0=무제한)</span></label>
          <input type="number" id="dlExp" value="${lim.maxExp||0}" min="0" style="width:100%;padding:8px 12px;border:2px solid #ddd;border-radius:8px;font-size:14px;outline:none;box-sizing:border-box;" placeholder="예: 5">
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;font-weight:700;color:#333;display:block;margin-bottom:4px;">📝 메모</label>
          <input type="text" id="dlMemo" value="${(lim.memo||'').replace(/"/g,'&amp;quot;')}" style="width:100%;padding:8px 12px;border:2px solid #ddd;border-radius:8px;font-size:13px;outline:none;box-sizing:border-box;" placeholder="예: 행사일, 휴관 등">
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="saveDayLimitVal('${ds}')" style="flex:1;padding:10px;background:var(--p);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:800;cursor:pointer;">💾 저장</button>
          <button onclick="clearDayLimit('${ds}')" style="padding:10px 16px;background:#ffebee;color:#c62828;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">초기화</button>
          <button onclick="document.getElementById('dlModal').remove()" style="padding:10px 16px;background:#eee;color:#333;border:none;border-radius:8px;font-size:12px;cursor:pointer;">닫기</button>
        </div>
      </div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend',h);
}
function saveDayLimitVal(ds){
  const maxPpl=parseInt(document.getElementById('dlPpl').value)||0;
  const maxMeal=parseInt(document.getElementById('dlMeal').value)||0;
  const maxExp=parseInt(document.getElementById('dlExp').value)||0;
  const memo=document.getElementById('dlMemo').value.trim();
  if(!maxPpl&&!maxMeal&&!maxExp&&!memo){delete dayLimits[ds];}
  else{dayLimits[ds]={maxPpl,maxMeal,maxExp,memo};}
  saveDayLimits();
  document.getElementById('dlModal').remove();
  toast('✅ 제한 설정 저장','s');
  rCal();if(sD===ds)sCd(ds);
}
function clearDayLimit(ds){
  delete dayLimits[ds];saveDayLimits();
  document.getElementById('dlModal').remove();
  toast('🗑 제한 설정 초기화','s');
  rCal();if(sD===ds)sCd(ds);
}
function getDayLimitBadges(ds,db){
  const lim=getDayLimit(ds);
  if(!lim.maxPpl&&!lim.maxMeal&&!lim.maxExp&&!lim.memo)return '';
  const curPpl=db.reduce((s,b)=>s+b.students+b.teachers,0);
  const curMeal=db.filter(b=>b.meal&&b.meal!=='이용안함').reduce((s,b)=>s+b.students+b.teachers,0);
  const curExp=db.filter(b=>b.addons&&b.addons.length).length;
  let badges='';
  if(lim.maxPpl){const ov=curPpl>=lim.maxPpl;const pct=Math.round(curPpl/lim.maxPpl*100);
    badges+=`<span style="font-size:7px;padding:1px 3px;border-radius:3px;background:${ov?'#f44336':'#e8f5e9'};color:${ov?'#fff':'#2e7d32'};font-weight:700;">👥${curPpl}/${lim.maxPpl}</span>`;}
  if(lim.maxMeal){const ov=curMeal>=lim.maxMeal;
    badges+=`<span style="font-size:7px;padding:1px 3px;border-radius:3px;background:${ov?'#f44336':'#fce4ec'};color:${ov?'#fff':'#c2185b'};font-weight:700;">🍚${curMeal}/${lim.maxMeal}</span>`;}
  if(lim.maxExp){const ov=curExp>=lim.maxExp;
    badges+=`<span style="font-size:7px;padding:1px 3px;border-radius:3px;background:${ov?'#f44336':'#f3e5f5'};color:${ov?'#fff':'#7b1fa2'};font-weight:700;">🎨${curExp}/${lim.maxExp}</span>`;}
  if(lim.memo)badges+=`<span style="font-size:7px;padding:1px 3px;border-radius:3px;background:#fff3e0;color:#e65100;font-weight:600;" title="${lim.memo}">📝${lim.memo.length>4?lim.memo.substring(0,4)+'…':lim.memo}</span>`;
  return `<div style="display:flex;gap:2px;flex-wrap:wrap;margin-top:2px;justify-content:center;">${badges}</div>`;
}

function getDayLimitInline(ds,db){
  const lim=getDayLimit(ds);
  if(!lim.maxPpl&&!lim.maxMeal&&!lim.maxExp&&!lim.memo)return '';
  const curPpl=db.reduce((s,b)=>s+b.students+b.teachers,0);
  const curMeal=db.filter(b=>b.meal&&b.meal!=='이용안함').reduce((s,b)=>s+b.students+b.teachers,0);
  const curExp=db.filter(b=>b.addons&&b.addons.length).length;
  let parts=[];
  if(lim.maxPpl){const ov=curPpl>=lim.maxPpl;parts.push(`<span style="padding:2px 7px;border-radius:5px;background:${ov?'#f44336':'#e8f5e9'};color:${ov?'#fff':'#2e7d32'};font-weight:700;">제한인원 ${curPpl}/${lim.maxPpl}명${ov?' ⚠️초과':''}</span>`);}
  if(lim.maxMeal){const ov=curMeal>=lim.maxMeal;parts.push(`<span style="padding:2px 7px;border-radius:5px;background:${ov?'#f44336':'#fce4ec'};color:${ov?'#fff':'#c2185b'};font-weight:700;">제한식사 ${curMeal}/${lim.maxMeal}명${ov?' ⚠️초과':''}</span>`);}
  if(lim.maxExp){const ov=curExp>=lim.maxExp;parts.push(`<span style="padding:2px 7px;border-radius:5px;background:${ov?'#f44336':'#f3e5f5'};color:${ov?'#fff':'#7b1fa2'};font-weight:700;">제한체험 ${curExp}/${lim.maxExp}팀${ov?' ⚠️초과':''}</span>`);}
  if(lim.memo)parts.push(`<span style="padding:2px 7px;border-radius:5px;background:#fff3e0;color:#e65100;">메모: ${lim.memo}</span>`);
  return parts.join(' ');
}

function sCd(ds){
  sD=ds;const db=bks.filter(b=>b.date===ds);const c=document.getElementById('dCard');
  c.style.display='block';
  const d=new Date(ds);const dayNames=['일','월','화','수','목','금','토'];
  const dp=db.reduce((s,b)=>s+b.students+b.teachers,0);
  const dStu=db.reduce((s,b)=>s+b.students,0);
  const dTea=db.reduce((s,b)=>s+b.teachers,0);
  const dConf=db.filter(b=>b.status==='확정');
  const dPend=db.filter(b=>b.status==='대기');
  const dMeal=db.filter(b=>b.meal&&b.meal!=='이용안함');
  const dMealPpl=dMeal.reduce((s,b)=>s+b.students+b.teachers,0);
  const dAddon=db.filter(b=>b.addons&&b.addons.length);
  const dEst=db.reduce((s,b)=>s+getEstimate(b),0);
  const limInline=getDayLimitInline(ds,db);
  const limRow=limInline?`<div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;font-size:11px;"><span style="font-weight:700;color:#555;">📊 제한현황</span>${limInline}</div>`:'';
  document.getElementById('dTitle').innerHTML=`<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">📅 ${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}(${dayNames[d.getDay()]}) — ${db.length}팀 / ${dp}명 <button onclick="event.stopPropagation();openDayLimitModal('${ds}')" style="padding:3px 10px;background:#fff3e0;color:#e65100;border:1px solid #ffcc80;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;">⚙️ 제한설정</button></div>${limRow}`;

  // Day summary badges
  let sumHtml=`<div style="display:flex;gap:6px;flex-wrap:wrap;font-size:11px;">`;
  sumHtml+=`<span style="background:#e8f5e9;color:#2e7d32;padding:3px 8px;border-radius:6px;font-weight:700;">👥 ${dp}명 <span style="font-size:9px;font-weight:400;">(아동${dStu}+인솔${dTea})</span></span>`;
  if(dConf.length)sumHtml+=`<span style="background:#c8e6c9;color:#1b5e20;padding:3px 8px;border-radius:6px;">✅ 확정 ${dConf.length}팀</span>`;
  if(dPend.length)sumHtml+=`<span style="background:#fff3e0;color:#e65100;padding:3px 8px;border-radius:6px;">⏳ 대기 ${dPend.length}팀</span>`;
  if(dMeal.length)sumHtml+=`<span style="background:#fce4ec;color:#c2185b;padding:3px 8px;border-radius:6px;font-weight:700;">🍚 단체식 ${dMeal.length}팀(${dMealPpl}명)</span>`;
  if(dAddon.length)sumHtml+=`<span style="background:#f3e5f5;color:#7b1fa2;padding:3px 8px;border-radius:6px;">🎨 체험 ${dAddon.length}팀</span>`;
  sumHtml+=`<span style="background:#e3f2fd;color:#1565c0;padding:3px 8px;border-radius:6px;">💰 ₩${fmtWon(dEst)}</span>`;
  sumHtml+=`</div>`;
  // AI analysis - day detail
  let aiDay=[];
  if(db.length){
    if(dPend.length) aiDay.push(`⚠️ 대기 ${dPend.length}팀 확정 필요. 빠른 연락 권장합니다.`);
    if(dMeal.length) aiDay.push(`🍚 단체식 ${dMealPpl}명분 준비 필요 (${dMeal.length}팀 신청).`);
    const timeSlots={};db.forEach(b=>{const t=b.arrival||'미정';if(!timeSlots[t])timeSlots[t]=0;timeSlots[t]++;});
    const overlap=Object.entries(timeSlots).filter(([k,v])=>v>=2);
    if(overlap.length) aiDay.push(`⏰ ${overlap.map(([t,c])=>t+'에 '+c+'팀').join(', ')} 동시 도착 — 혼잡 주의.`);
    else if(db.length>=2) aiDay.push(`도착시간이 분산되어 운영 여유가 있습니다.`);
  }
  if(aiDay.length) sumHtml+=mkAiBox(aiDay[0],aiDay);
  document.getElementById('dDaySummary').innerHTML=sumHtml;

  if(!db.length){
    document.querySelector('#dTb2 tbody').innerHTML=`<tr><td colspan="8" style="text-align:center;color:#bbb;padding:20px;font-size:12px;">예약 없음</td></tr>`;
    c.scrollIntoView({behavior:'smooth',block:'start'});
    return;
  }

  document.querySelector('#dTb2 tbody').innerHTML=db.map(b=>{
    const sc=b.status==='확정'?'bdg-g':b.status==='대기'?'bdg-y':'bdg-r';
    const hasMeal=b.meal&&b.meal!=='이용안함';
    const ct=b.courseType||'기본코스';
    const mealHtml=hasMeal?`<div style="margin-top:2px;"><span style="display:inline-block;font-size:9px;padding:1px 5px;border-radius:3px;background:#fce4ec;color:#c2185b;font-weight:700;">🍚 ${b.meal}</span></div>`:'';
    const adStr=b.addons&&b.addons.length?b.addons.map(a=>`<span style="display:inline-block;font-size:9px;padding:1px 5px;border-radius:3px;background:#f3e5f5;color:#7b1fa2;margin:1px;">${a}</span>`).join(''):'<span style="color:#ddd;font-size:10px;">없음</span>';
    const memo=memos[b.id]||b.memo||b.etc||'';
    const memoHtml=memo?`<span style="font-size:9px;color:#e65100;background:#fff3e0;padding:1px 5px;border-radius:3px;" title="${memo.replace(/"/g,'&quot;')}">📝 ${memo.length>15?memo.substring(0,15)+'…':memo}</span>`:'<span style="color:#ddd;font-size:10px;">-</span>';
    const catBadge=b.category&&b.category!=='미분류'?`<div style="font-size:9px;color:#888;">${b.category}</div>`:'';
    return `<tr>
      <td style="font-weight:700;">${b.name}${catBadge}</td>
      <td style="white-space:nowrap;">${b.arrival}~${b.departure}</td>
      <td>${b.students+b.teachers}명<div style="font-size:9px;color:#888;">아동${b.students}+인솔${b.teachers}</div>${b.actualStudents!=null?`<div style="font-size:9px;color:#c2185b;">실제${(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers)}</div>`:''}</td>
      <td><span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${(ct).includes('단체식')?'#fff3e0':'#e8f5e9'};font-weight:600;">${ct}</span>${mealHtml}</td>
      <td style="max-width:130px;">${adStr}</td>
      <td style="max-width:140px;">${memoHtml}</td>
      <td><span class="bdg ${sc}">${b.status}</span></td>
      <td style="white-space:nowrap;">${b.status==='대기'?`<button class="btn bg bs" onclick="setSt(${b.id},'확정')">확정</button> `:''} ${b.status!=='취소'?`<button class="btn br bs" onclick="setSt(${b.id},'취소')">취소</button> `:''}<button class="btn bgy bs" onclick="showDtl(${b.id})">상세</button> <button class="btn bs" style="background:${b.etc?'#FFF8E1':'#f5f5f5'};color:${b.etc?'#F57F17':'#ccc'};font-size:10px;border:1px solid ${b.etc?'#FFB300':'#eee'};" onclick="showEtcPopup(${b.id})">📝요청</button> <button class="btn bs" onmouseenter="showActTip(event,${b.id})" onmouseleave="hideActTip()" style="background:${b.actualStudents!=null?'#c2185b':'#fce4ec'};color:${b.actualStudents!=null?'#fff':'#c2185b'};font-size:10px;" onclick="showDtl(${b.id});setTimeout(()=>{const el=document.getElementById('dtl_aSt1');if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},100)">실제</button></td></tr>`;
  }).join('');
  // Scroll to detail card
  c.scrollIntoView({behavior:'smooth',block:'start'});
}
function goSch(){if(!sD)return;document.getElementById('sD').value=sD;gp('as');bSch();}

// ===== ADMIN: ALL BOOKINGS =====
// Memo storage
let memos=JSON.parse(localStorage.getItem('jp_memos')||'{}');
function saveMemos(){localStorage.setItem('jp_memos',JSON.stringify(memos));}
function setMemo(id,val){memos[id]=val;saveMemos();}
function setBkAgency(id,agCode){
  const b=bks.find(x=>x.id===id);
  if(!b)return;
  if(agCode){
    const ag=agencies.find(a=>a.code===agCode);
    b.agency=agCode;
    b.agencyName=ag?ag.name:agCode;
    b.channel='대행사';
  } else {
    delete b.agency;
    delete b.agencyName;
    b.channel='';
  }
  sv();rAll();
  toast(agCode?`🏢 ${b.name} → ${b.agencyName||agCode} 대행사 배정`:`📋 ${b.name} → 직영 변경`,'s');
}
function setBkCat(id,val){
  const b=bks.find(x=>x.id===id);
  if(!b)return;
  b.category=val;
  sv();rAll();
  toast(`🏷️ ${b.name} → ${val}`,'s');
}

// ── 인라인 편집 (단체명, 연락처 등 텍스트 필드) ──
function inlineEdit(td,id,field){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const val=b[field]||'';
  const label=field==='name'?'단체명':field==='phone'?'연락처':field;
  const r=td.getBoundingClientRect();
  const pop=document.createElement('div');
  pop.id='ie_pop';
  pop.innerHTML=`
    <div style="font-size:11px;font-weight:800;color:#1565C0;margin-bottom:6px;">✏️ ${label} 수정</div>
    <input id="ie_txt" type="${field==='phone'?'tel':'text'}" value="${val.replace(/"/g,'&quot;')}" style="width:200px;font-size:14px;padding:8px 10px;border:2px solid #1565C0;border-radius:8px;outline:none;font-weight:700;background:#E3F2FD;color:#111;">
    <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
      <button onclick="document.getElementById('ie_pop').remove()" style="padding:5px 12px;font-size:11px;border:1px solid #ccc;border-radius:6px;background:#f5f5f5;cursor:pointer;font-weight:700;">취소</button>
      <button onclick="saveInlinePopup(${id},'${field}')" style="padding:5px 12px;font-size:11px;border:none;border-radius:6px;background:#1565C0;color:#fff;cursor:pointer;font-weight:800;">저장</button>
    </div>`;
  pop.style.cssText=`position:fixed;left:${Math.min(r.left,window.innerWidth-260)}px;top:${r.bottom+4}px;background:#fff;border:2px solid #1565C0;border-radius:12px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9999;`;
  document.getElementById('ie_pop')?.remove();
  document.body.appendChild(pop);
  const inp=document.getElementById('ie_txt');inp.focus();inp.select();
  inp.onkeydown=e=>{if(e.key==='Enter')saveInlinePopup(id,field);if(e.key==='Escape')pop.remove();};
}
function saveInlinePopup(id,field){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const nv=document.getElementById('ie_txt').value.trim();
  if(nv&&nv!==b[field]){
    pushUndo('수정',`${b.name} ${field} 변경`,JSON.stringify(bks));
    b[field]=nv;sv();toast('💾 수정됨','s');
  }
  document.getElementById('ie_pop')?.remove();
  rAll();
}

// ── 인라인 편집 (인원) ──
function inlineEditPpl(td,id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const r=td.getBoundingClientRect();
  const pop=document.createElement('div');
  pop.id='ie_pop';
  pop.innerHTML=`
    <div style="font-size:11px;font-weight:800;color:#1565C0;margin-bottom:8px;">👥 인원 수정</div>
    <div style="display:flex;gap:10px;align-items:center;">
      <div style="text-align:center;">
        <div style="font-size:10px;color:#1B5E20;font-weight:700;margin-bottom:3px;">아동</div>
        <input id="ie_stu_${id}" type="number" value="${b.students}" style="width:60px;font-size:16px;padding:6px;border:2px solid #1B5E20;border-radius:8px;text-align:center;outline:none;background:#E8F5E9;font-weight:800;color:#1B5E20;" min="0">
      </div>
      <span style="font-size:16px;color:#666;font-weight:900;padding-top:16px;">+</span>
      <div style="text-align:center;">
        <div style="font-size:10px;color:#e65100;font-weight:700;margin-bottom:3px;">인솔</div>
        <input id="ie_tea_${id}" type="number" value="${b.teachers}" style="width:60px;font-size:16px;padding:6px;border:2px solid #e65100;border-radius:8px;text-align:center;outline:none;background:#FFF3E0;font-weight:800;color:#e65100;" min="0">
      </div>
      <span style="font-size:16px;color:#666;font-weight:900;padding-top:16px;">=</span>
      <div style="text-align:center;padding-top:16px;">
        <span id="ie_total_${id}" style="font-size:18px;font-weight:900;color:#1565C0;">${b.students+b.teachers}</span><span style="font-size:11px;color:#888;">명</span>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:10px;justify-content:flex-end;">
      <button onclick="document.getElementById('ie_pop').remove()" style="padding:5px 12px;font-size:11px;border:1px solid #ccc;border-radius:6px;background:#f5f5f5;cursor:pointer;font-weight:700;">취소</button>
      <button onclick="saveInlinePpl(${id})" style="padding:5px 12px;font-size:11px;border:none;border-radius:6px;background:#1565C0;color:#fff;cursor:pointer;font-weight:800;">저장</button>
    </div>`;
  pop.style.cssText=`position:fixed;left:${Math.min(r.left-40,window.innerWidth-320)}px;top:${r.bottom+4}px;background:#fff;border:2px solid #1565C0;border-radius:12px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9999;`;
  document.getElementById('ie_pop')?.remove();
  document.body.appendChild(pop);
  // 합계 실시간 업데이트
  const updateTotal=()=>{
    const s=parseInt(document.getElementById('ie_stu_'+id).value)||0;
    const t=parseInt(document.getElementById('ie_tea_'+id).value)||0;
    document.getElementById('ie_total_'+id).textContent=s+t;
  };
  document.getElementById('ie_stu_'+id).oninput=updateTotal;
  document.getElementById('ie_tea_'+id).oninput=updateTotal;
  document.getElementById('ie_stu_'+id).focus();
  document.getElementById('ie_stu_'+id).select();
}
function saveInlinePpl(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const s=parseInt(document.getElementById('ie_stu_'+id).value)||0;
  const t=parseInt(document.getElementById('ie_tea_'+id).value)||0;
  pushUndo('수정',`${b.name} 인원 변경`,JSON.stringify(bks));
  b.students=s;b.teachers=t;sv();toast('💾 인원 수정됨','s');
  document.getElementById('ie_pop')?.remove();
  rAll();
}

// ── 인라인 편집 (시간) ──
function inlineEditTime(td,id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const r=td.getBoundingClientRect();
  const pop=document.createElement('div');
  pop.id='ie_pop';
  pop.innerHTML=`
    <div style="font-size:11px;font-weight:800;color:#1565C0;margin-bottom:8px;">🕐 시간 수정</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="text-align:center;">
        <div style="font-size:10px;color:#2e7d32;font-weight:700;margin-bottom:3px;">입장</div>
        <input id="ie_arr_${id}" type="time" value="${b.arrival}" style="font-size:15px;padding:6px 8px;border:2px solid #2e7d32;border-radius:8px;outline:none;background:#E8F5E9;font-weight:700;color:#2e7d32;">
      </div>
      <span style="font-size:18px;color:#666;padding-top:16px;">~</span>
      <div style="text-align:center;">
        <div style="font-size:10px;color:#c62828;font-weight:700;margin-bottom:3px;">퇴장</div>
        <input id="ie_dep_${id}" type="time" value="${b.departure}" style="font-size:15px;padding:6px 8px;border:2px solid #c62828;border-radius:8px;outline:none;background:#FFEBEE;font-weight:700;color:#c62828;">
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:10px;justify-content:flex-end;">
      <button onclick="document.getElementById('ie_pop').remove()" style="padding:5px 12px;font-size:11px;border:1px solid #ccc;border-radius:6px;background:#f5f5f5;cursor:pointer;font-weight:700;">취소</button>
      <button onclick="saveInlineTime(${id})" style="padding:5px 12px;font-size:11px;border:none;border-radius:6px;background:#1565C0;color:#fff;cursor:pointer;font-weight:800;">저장</button>
    </div>`;
  pop.style.cssText=`position:fixed;left:${Math.min(r.left-20,window.innerWidth-300)}px;top:${r.bottom+4}px;background:#fff;border:2px solid #1565C0;border-radius:12px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9999;`;
  document.getElementById('ie_pop')?.remove();
  document.body.appendChild(pop);
  document.getElementById('ie_arr_'+id).focus();
}
function saveInlineTime(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const a=document.getElementById('ie_arr_'+id).value;
  const d=document.getElementById('ie_dep_'+id).value;
  if(a&&d){
    pushUndo('수정',`${b.name} 시간 변경`,JSON.stringify(bks));
    b.arrival=a;b.departure=d;sv();toast('💾 시간 수정됨','s');
  }
  document.getElementById('ie_pop')?.remove();
  rAll();
}

// ── 상태 순환 클릭 (확정↔대기↔취소) ──
function cycleStatus(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const cycle=['확정','대기','취소'];
  const ci=cycle.indexOf(b.status);
  const next=cycle[(ci+1)%3];
  if(next==='취소'){
    setSt(id,'취소');
  } else {
    pushUndo('상태변경',`${b.name} ${b.status}→${next}`,JSON.stringify(bks));
    b.status=next;sv();toast(`${b.name} → ${next}`,'s');rAll();
  }
}

// ── 코스 변경 ──
function setBkCourse(id,val){
  const b=bks.find(x=>x.id===id);if(!b)return;
  pushUndo('코스변경',`${b.name} → ${val}`,JSON.stringify(bks));
  b.courseType=val;
  if(val.includes('단체식'))b.meal='이용함';
  sv();toast(`🍽️ ${b.name} → ${val}`,'s');rAll();
}

// ── 코스 팝업 ──
function popCourse(td,id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  document.getElementById('ie_pop')?.remove();
  const r=td.getBoundingClientRect();
  const pop=document.createElement('div');
  pop.id='ie_pop';
  const cur=b.courseType||'기본코스';
  const opts=[
    {v:'기본코스',label:'🎓 기본코스',desc:'기본 체험 프로그램',clr:'#2e7d32',bg:'#E8F5E9'},
    {v:'기본코스+단체식',label:'🍽️ 기본코스+단체식',desc:'체험 + 단체 식사 포함',clr:'#E65100',bg:'#FFF3E0'}
  ];
  pop.innerHTML=`
    <div style="font-size:11px;font-weight:800;color:#333;margin-bottom:8px;">📋 코스 선택</div>
    ${opts.map(o=>`<div onclick="setBkCourse(${id},'${o.v}');document.getElementById('ie_pop')?.remove()" 
      style="padding:10px 14px;margin-bottom:4px;border:2px solid ${cur===o.v?o.clr:'#e0e0e0'};border-radius:10px;background:${cur===o.v?o.bg:'#fff'};cursor:pointer;transition:all .15s;"
      onmouseenter="this.style.background='${o.bg}';this.style.borderColor='${o.clr}'" 
      onmouseleave="this.style.background='${cur===o.v?o.bg:'#fff'}';this.style.borderColor='${cur===o.v?o.clr:'#e0e0e0'}'">
      <div style="font-size:13px;font-weight:800;color:${o.clr};">${o.label} ${cur===o.v?'✓':''}</div>
      <div style="font-size:10px;color:#888;margin-top:2px;">${o.desc}</div>
    </div>`).join('')}
    <div style="text-align:right;margin-top:4px;">
      <button onclick="document.getElementById('ie_pop')?.remove()" style="padding:4px 10px;font-size:10px;border:1px solid #ccc;border-radius:6px;background:#f5f5f5;cursor:pointer;">닫기</button>
    </div>`;
  pop.style.cssText=`position:fixed;left:${Math.min(r.left-20,window.innerWidth-260)}px;top:${r.bottom+4}px;background:#fff;border:2px solid #2e7d32;border-radius:12px;padding:12px 14px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9999;min-width:200px;`;
  document.body.appendChild(pop);
  if(pop.getBoundingClientRect().bottom>window.innerHeight)pop.style.top=(r.top-pop.offsetHeight-4)+'px';
}

// ── 상태 변경 (드롭다운) ──
function setBkStatus(id,val){
  const b=bks.find(x=>x.id===id);if(!b)return;
  if(val===b.status)return;
  if(val==='취소'){
    setSt(id,'취소');
  } else {
    pushUndo('상태변경',`${b.name} ${b.status}→${val}`,JSON.stringify(bks));
    b.status=val;sv();
    if(val==='확정'){toast(`✅ ${b.name} 확정`,'s');}
    else {toast(`${b.name} → ${val}`,'s');}
    rAll();
  }
}

// ── 상태 팝업 ──
function popStatus(td,id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  document.getElementById('ie_pop')?.remove();
  const r=td.getBoundingClientRect();
  const pop=document.createElement('div');
  pop.id='ie_pop';
  const cur=b.status;
  const opts=[
    {v:'확정',icon:'✅',label:'확정',desc:'예약 확정 처리',clr:'#2e7d32',bg:'#E8F5E9'},
    {v:'대기',icon:'⏳',label:'대기',desc:'확인 대기 중',clr:'#e65100',bg:'#FFF3E0'},
    {v:'취소',icon:'❌',label:'취소',desc:'예약 취소 (사유 입력)',clr:'#c62828',bg:'#FFEBEE'}
  ];
  pop.innerHTML=`
    <div style="font-size:11px;font-weight:800;color:#333;margin-bottom:8px;">📌 상태 변경</div>
    ${opts.map(o=>`<div onclick="setBkStatus(${id},'${o.v}');document.getElementById('ie_pop')?.remove()" 
      style="padding:10px 14px;margin-bottom:4px;border:2px solid ${cur===o.v?o.clr:'#e0e0e0'};border-radius:10px;background:${cur===o.v?o.bg:'#fff'};cursor:pointer;transition:all .15s;"
      onmouseenter="this.style.background='${o.bg}';this.style.borderColor='${o.clr}'" 
      onmouseleave="this.style.background='${cur===o.v?o.bg:'#fff'}';this.style.borderColor='${cur===o.v?o.clr:'#e0e0e0'}'">
      <div style="font-size:14px;font-weight:800;color:${o.clr};">${o.icon} ${o.label} ${cur===o.v?'◀':''}</div>
      <div style="font-size:10px;color:#888;margin-top:2px;">${o.desc}</div>
    </div>`).join('')}
    <div style="text-align:right;margin-top:4px;">
      <button onclick="document.getElementById('ie_pop')?.remove()" style="padding:4px 10px;font-size:10px;border:1px solid #ccc;border-radius:6px;background:#f5f5f5;cursor:pointer;">닫기</button>
    </div>`;
  pop.style.cssText=`position:fixed;left:${Math.min(r.left-20,window.innerWidth-240)}px;top:${r.bottom+4}px;background:#fff;border:2px solid #1565C0;border-radius:12px;padding:12px 14px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9999;min-width:180px;`;
  document.body.appendChild(pop);
  if(pop.getBoundingClientRect().bottom>window.innerHeight)pop.style.top=(r.top-pop.offsetHeight-4)+'px';
}

// 팝업 외부 클릭 시 닫기
document.addEventListener('mousedown',function(e){
  const pop=document.getElementById('ie_pop');
  if(pop&&!pop.contains(e.target)){pop.remove();}
});

// ── 툴팁에서 예약 행으로 스크롤 이동 ──
function scrollToBk(bkId){
  hideCardTip();
  const row=document.querySelector(`tr[data-bkid="${bkId}"]`);
  if(!row)return;
  row.scrollIntoView({behavior:'smooth',block:'center'});
  // 하이라이트 애니메이션
  const origBg=row.style.background;
  row.style.background='#FFEB3B';
  row.style.transition='background .3s';
  setTimeout(()=>{row.style.background='#FFF9C4';},300);
  setTimeout(()=>{row.style.background='#FFEB3B';},600);
  setTimeout(()=>{row.style.background='#FFF9C4';},900);
  setTimeout(()=>{row.style.background=origBg;row.style.transition='';},2000);
}

// ── 새 예약 추가 ──
function addNewBk(){
  const today=td();
  const newId=bks.length?Math.max(...bks.map(b=>b.id))+1:1;
  const nb={
    id:newId,date:today,name:'새 단체',category:'미분류',
    students:0,studentsChild:0,studentsElem:0,teachers:0,
    arrival:'10:00',departure:'14:00',
    courseType:'기본코스',meal:'이용안함',addons:[],
    phone:'',email:'',status:'대기',channel:'직접'
  };
  pushUndo('추가','새 예약 추가',JSON.stringify(bks));
  bks.push(nb);sv();
  toast('➕ 새 예약이 추가되었습니다','s');
  rAll();
  setTimeout(()=>showDtl(newId),300);
}

// 메모 툴팁 (hover)
let memoTipEl=null;
function showMemoTip(el,id){
  const memo=memos[id]||'';
  if(!memo)return;
  hideMemoTip();
  memoTipEl=document.createElement('div');
  memoTipEl.innerHTML=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;padding-bottom:5px;border-bottom:2px solid rgba(255,255,255,.2);"><span style="font-size:14px;">📝</span><span style="font-size:11px;font-weight:800;color:#FFD54F;">메모</span></div><div style="font-size:12px;line-height:1.6;white-space:pre-wrap;">${memo.replace(/</g,'&lt;')}</div>`;
  memoTipEl.style.cssText='position:fixed;z-index:9999;background:linear-gradient(135deg,#37474F,#263238);color:#fff;padding:12px 16px;border-radius:12px;font-size:12px;max-width:300px;min-width:120px;word-break:break-all;box-shadow:0 8px 32px rgba(0,0,0,.35);pointer-events:none;';
  document.body.appendChild(memoTipEl);
  const r=el.getBoundingClientRect();
  memoTipEl.style.left=Math.min(r.left-60,window.innerWidth-320)+'px';
  memoTipEl.style.top=(r.bottom+8)+'px';
  if(memoTipEl.getBoundingClientRect().bottom>window.innerHeight)memoTipEl.style.top=(r.top-memoTipEl.offsetHeight-8)+'px';
}
function hideMemoTip(){if(memoTipEl){memoTipEl.remove();memoTipEl=null;}}

let cardTipEl=null;
function showCardTip(el,tipIdx){
  hideCardTip();
  const html=window._cardTips&&window._cardTips[tipIdx];
  if(!html)return;
  const r=el.getBoundingClientRect();
  cardTipEl=document.createElement('div');
  cardTipEl.setAttribute('data-tipidx',tipIdx);
  cardTipEl.innerHTML=html;
  cardTipEl.style.cssText=`position:fixed;left:${r.left}px;top:${r.bottom+8}px;background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:12px 16px;font-size:11px;color:#333;line-height:1.4;box-shadow:0 8px 32px rgba(0,0,0,.2);z-index:9999;max-width:340px;min-width:200px;max-height:70vh;overflow-y:auto;`;
  document.body.appendChild(cardTipEl);
  const tr=cardTipEl.getBoundingClientRect();
  if(tr.right>window.innerWidth)cardTipEl.style.left=(window.innerWidth-tr.width-10)+'px';
  if(tr.bottom>window.innerHeight)cardTipEl.style.top=(r.top-tr.height-8)+'px';
  // 마우스가 팝업 위에 있을 때 닫지 않기
  cardTipEl.onmouseenter=function(){cardTipEl._hover=true;};
  cardTipEl.onmouseleave=function(){cardTipEl._hover=false;hideCardTip();};
}
function hideCardTip(){
  if(cardTipEl&&cardTipEl._hover)return;
  if(cardTipEl){cardTipEl.remove();cardTipEl=null;}
}
function expandCardTip(tipIdx){
  if(!cardTipEl||!window._cardTipsFull)return;
  const full=window._cardTipsFull[tipIdx];
  if(!full)return;
  cardTipEl.innerHTML=full+`<div onclick="collapseCardTip(${tipIdx})" style="text-align:center;padding:6px 0 2px;margin-top:4px;border-top:1px dashed #ddd;font-size:11px;color:#999;font-weight:700;cursor:pointer;">▲ 접기</div>`;
}
function collapseCardTip(tipIdx){
  if(!cardTipEl||!window._cardTips)return;
  cardTipEl.innerHTML=window._cardTips[tipIdx];
}

// ── 열 리사이즈 ──
(function(){
  // CSS 주입
  const sty=document.createElement('style');
  sty.textContent=`
    .rz-handle{position:absolute;right:-2px;top:0;bottom:0;width:5px;cursor:col-resize;z-index:3;background:transparent;transition:background .15s;}
    .rz-handle:hover,.rz-handle.active{background:rgba(255,255,255,.45);}
    .rz-th{user-select:none;}
  `;
  document.head.appendChild(sty);

  let startX,startW,col,colIdx,tbl;

  document.addEventListener('mousedown',function(e){
    if(!e.target.classList.contains('rz-handle'))return;
    e.preventDefault();
    const th=e.target.parentElement;
    tbl=th.closest('table');
    if(!tbl)return;
    colIdx=[...th.parentElement.children].indexOf(th);
    col=tbl.querySelector('colgroup').children[colIdx];
    startX=e.pageX;
    startW=th.offsetWidth;
    e.target.classList.add('active');
    document.body.style.cursor='col-resize';
    document.body.style.userSelect='none';

    function onMove(ev){
      const diff=ev.pageX-startX;
      const nw=Math.max(20,startW+diff);
      col.style.width=nw+'px';
    }
    function onUp(){
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      document.body.style.cursor='';
      document.body.style.userSelect='';
      document.querySelectorAll('.rz-handle.active').forEach(h=>h.classList.remove('active'));
      // 저장
      saveBkColWidths();
    }
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });

  // 더블클릭: 해당 열 내용에 맞게 자동 폭 조정
  document.addEventListener('dblclick',function(e){
    if(!e.target.classList.contains('rz-handle'))return;
    e.preventDefault();
    const th=e.target.parentElement;
    tbl=th.closest('table');
    if(!tbl)return;
    colIdx=[...th.parentElement.children].indexOf(th);
    col=tbl.querySelector('colgroup').children[colIdx];

    // 임시로 auto 설정 후 측정
    const oldLayout=tbl.style.tableLayout;
    const oldW=col.style.width;
    tbl.style.tableLayout='auto';
    col.style.width='1px';
    
    // 해당 열의 모든 셀에서 최대 너비 측정
    let maxW=th.scrollWidth;
    const rows=tbl.querySelectorAll('tbody tr');
    rows.forEach(r=>{
      const cell=r.children[colIdx];
      if(cell&&!cell.hasAttribute('colspan')){
        // rowspan 셀은 실제 colIdx와 다를 수 있으므로 주의
        maxW=Math.max(maxW,cell.scrollWidth);
      }
    });

    tbl.style.tableLayout='fixed';
    col.style.width=Math.min(maxW+6,300)+'px';
    saveBkColWidths();
  });

  // 열 폭 저장/복원
  function saveBkColWidths(){
    const t=document.getElementById('bkTable');
    if(!t)return;
    const cols=t.querySelector('colgroup').children;
    const ws=[...cols].map(c=>c.style.width);
    try{localStorage.setItem('bkColWidths',JSON.stringify(ws));}catch(e){}
  }
  window.restoreBkColWidths=function(){
    const t=document.getElementById('bkTable');
    if(!t)return;
    try{
      const ws=JSON.parse(localStorage.getItem('bkColWidths'));
      if(!ws||!ws.length)return;
      const cols=t.querySelector('colgroup').children;
      ws.forEach((w,i)=>{if(cols[i])cols[i].style.width=w;});
    }catch(e){}
  };
})();

// 메모 팝업 (클릭으로 입력)
function openMemoPopup(id,btn){
  hideMemoTip();
  const existing=document.getElementById('memoPopup');
  if(existing)existing.remove();
  const b=bks.find(x=>x.id===id);
  const memo=memos[id]||'';
  const pop=document.createElement('div');
  pop.id='memoPopup';
  pop.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid #FF8F00;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.25);padding:12px;width:280px;';
  const r=btn.getBoundingClientRect();
  pop.style.left=Math.min(r.left-100,window.innerWidth-300)+'px';
  pop.style.top=Math.min(r.bottom+6,window.innerHeight-200)+'px';
  pop.innerHTML=`
    <div style="font-size:12px;font-weight:800;color:#E65100;margin-bottom:8px;">📝 ${b?b.name:''} 메모</div>
    <textarea id="memoPopTA" style="width:100%;height:80px;border:1px solid #ddd;border-radius:8px;padding:8px;font-size:12px;outline:none;resize:vertical;box-sizing:border-box;font-family:inherit;">${memo}</textarea>
    <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
      <button onclick="document.getElementById('memoPopup').remove()" style="padding:5px 12px;border:1px solid #ddd;border-radius:6px;background:#fff;color:#666;font-size:11px;cursor:pointer;font-weight:600;">취소</button>
      <button onclick="saveMemoPopup(${id})" style="padding:5px 12px;border:none;border-radius:6px;background:#E65100;color:#fff;font-size:11px;cursor:pointer;font-weight:700;">💾 저장</button>
    </div>`;
  document.body.appendChild(pop);
  const ta=document.getElementById('memoPopTA');
  ta.focus();
  ta.setSelectionRange(ta.value.length,ta.value.length);
  // 바깥 클릭시 닫기
  setTimeout(()=>{
    const closer=e=>{if(!pop.contains(e.target)&&e.target!==btn){pop.remove();document.removeEventListener('mousedown',closer);}};
    document.addEventListener('mousedown',closer);
  },100);
}
function saveMemoPopup(id){
  const ta=document.getElementById('memoPopTA');
  if(ta){setMemo(id,ta.value);document.getElementById('memoPopup')?.remove();rAll();toast('📝 메모 저장','s');}
}
function showMemoExpand(inp,id){
  if(document.getElementById('memoExpPop'))return;
  const rect=inp.getBoundingClientRect();
  const pop=document.createElement('div');
  pop.id='memoExpPop';
  pop.style.cssText='position:fixed;z-index:9999;background:#fff;border:2px solid #2e7d32;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:8px;width:280px;';
  pop.style.left=Math.min(rect.left,window.innerWidth-300)+'px';
  pop.style.top=Math.max(rect.bottom+4,0)+'px';
  if(rect.bottom+120>window.innerHeight)pop.style.top=(rect.top-110)+'px';
  const ta=document.createElement('textarea');
  ta.value=memos[id]||'';
  ta.placeholder='메모를 입력하세요...';
  ta.style.cssText='width:100%;height:80px;border:1px solid #ddd;border-radius:5px;padding:8px;font-size:13px;outline:none;resize:vertical;box-sizing:border-box;font-family:inherit;';
  ta.oninput=function(){inp.value=ta.value;setMemo(id,ta.value);};
  ta.onkeydown=function(e){if(e.key==='Escape'){inp.blur();}};
  pop.appendChild(ta);
  document.body.appendChild(pop);
  setTimeout(()=>ta.focus(),50);
}
function hideMemoExpand(inp){
  setTimeout(()=>{
    const pop=document.getElementById('memoExpPop');
    if(pop&&!pop.contains(document.activeElement)){pop.remove();}
    else if(pop){
      const ta=pop.querySelector('textarea');
      if(ta){ta.onblur=()=>{setTimeout(()=>{const p2=document.getElementById('memoExpPop');if(p2)p2.remove();},150);};}
    }
  },150);
}

let abDateMode='today';
function setAbDateRange(mode){
  abDateMode=mode;
  const today=td();
  const fromEl=document.getElementById('fDateFrom');
  const toEl=document.getElementById('fDateTo');
  if(mode==='today'){
    fromEl.value=today;toEl.value=today;
  } else if(mode==='week'){
    const d=new Date(today);const dow=d.getDay();
    const mon=new Date(d);mon.setDate(d.getDate()-(dow===0?6:dow-1));
    const sun=new Date(mon);sun.setDate(mon.getDate()+6);
    fromEl.value=mon.toISOString().slice(0,10);toEl.value=sun.toISOString().slice(0,10);
  } else if(mode==='month'){
    fromEl.value=today.slice(0,7)+'-01';
    const d2=new Date(parseInt(today.slice(0,4)),parseInt(today.slice(5,7)),0);
    toEl.value=d2.toISOString().slice(0,10);
  } else if(mode==='all'){
    fromEl.value='';toEl.value='';
  }
  // Update button styles
  document.querySelectorAll('.ab-dq').forEach(btn=>{
    btn.style.background='#fff';btn.style.color='#666';btn.style.borderColor='#ddd';
  });
  const activeBtn=document.getElementById('abdq_'+(mode==='custom'?'':''+mode));
  if(activeBtn){activeBtn.style.background='var(--p)';activeBtn.style.color='#fff';activeBtn.style.borderColor='var(--p)';}
  if(mode!=='custom')rAll();
}

function rAll(){
  // 대행사 드롭다운 동적 생성
  const chSel=document.getElementById('fCh');
  if(chSel){
    const curVal=chSel.value;
    const agCodes=[...new Set(bks.filter(b=>b.agency).map(b=>b.agency))];
    let opts='<option value="all">전체 채널</option><option value="direct">📋 직접예약</option><option value="agency_all">🏢 대행사(전체)</option>';
    agCodes.forEach(code=>{
      const nm=bks.find(b=>b.agency===code)?.agencyName||code;
      opts+=`<option value="ag_${code}">　🏢 ${nm}</option>`;
    });
    chSel.innerHTML=opts;
    chSel.value=curVal;
  }
  // 기관별 드롭다운 동적 생성
  const catSel=document.getElementById('fCat');
  if(catSel){
    const curCatVal=catSel.value;
    const cats=[...new Set(bks.map(b=>b.category||'미분류'))].sort();
    let catOpts='<option value="all">전체 기관</option>';
    cats.forEach(c=>catOpts+=`<option value="${c}">${c}</option>`);
    catSel.innerHTML=catOpts;
    catSel.value=curCatVal;
  }
  const st=document.getElementById('fS')?.value||'all';
  const dateFrom=document.getElementById('fDateFrom')?.value||'';
  const dateTo=document.getElementById('fDateTo')?.value||'';
  const ct=document.getElementById('fC')?.value||'all';
  const ml=document.getElementById('fMl')?.value||'all';
  const ch=document.getElementById('fCh')?.value||'all';
  const cat=document.getElementById('fCat')?.value||'all';
  const q=(document.getElementById('fQ')?.value||'').trim().toLowerCase();

  let f=bks.slice();
  if(st!=='all')f=f.filter(b=>b.status===st);
  if(dateFrom)f=f.filter(b=>b.date>=dateFrom);
  if(dateTo)f=f.filter(b=>b.date<=dateTo);
  if(ct!=='all')f=f.filter(b=>b.courseType===ct);
  if(ml!=='all')f=f.filter(b=>b.meal&&b.meal.includes(ml));
  if(cat!=='all')f=f.filter(b=>(b.category||'미분류')===cat);
  if(ch==='agency_all')f=f.filter(b=>b.agency);
  if(ch==='direct')f=f.filter(b=>!b.agency);
  if(ch.startsWith('ag_'))f=f.filter(b=>b.agency===ch.slice(3));
  if(q)f=f.filter(b=>b.name.toLowerCase().includes(q)||b.phone.includes(q)||(memos[b.id]||'').toLowerCase().includes(q));
  f.sort((a,b)=>a.date.localeCompare(b.date));

  // Summary
  const totalTeams=f.length;
  const totalStu=f.reduce((s,b)=>s+b.students,0);
  const totalTea=f.reduce((s,b)=>s+b.teachers,0);
  const totalPpl=totalStu+totalTea;
  const conf=f.filter(b=>b.status==='확정').length;
  const pend=f.filter(b=>b.status==='대기').length;
  const canc=f.filter(b=>b.status==='취소').length;
  const mealYes=f.filter(b=>b.meal&&b.meal.includes('이용함')).length;
  const hasAddon=f.filter(b=>b.addons&&b.addons.length).length;

  // Course type breakdown
  const catMap={};
  f.forEach(b=>{const c=b.category||'미분류';catMap[c]=(catMap[c]||0)+1;});
  const agencyCount=f.filter(b=>b.agency).length;
  const directCount=f.filter(b=>!b.agency).length;
  const pct=(n)=>totalTeams?Math.round(n/totalTeams*100):0;
  const catColors=['#1565C0','#2E7D32','#E65100','#AD1457','#4527A0','#00838F','#C62828','#546E7A'];
  const catHtml=Object.entries(catMap).map(([k,v],i)=>`<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:${catColors[i%catColors.length]};color:#fff;font-weight:700;white-space:nowrap;">${k} ${v} <span style="opacity:.8;font-size:8px;">${pct(v)}%</span></span>`).join(' ');

  const abC=`display:flex;align-items:baseline;justify-content:center;gap:5px;padding:8px 6px;`;
  
  // 세부 데이터 생성 (테이블 형식)
  const tipHd=(icon,title,clr)=>`<div style="display:flex;align-items:center;gap:6px;padding-bottom:6px;margin-bottom:6px;border-bottom:2px solid ${clr}20;"><span style="font-size:14px;">${icon}</span><span style="font-size:13px;font-weight:900;color:${clr};">${title}</span></div>`;
  const tipRow=(date,name,extra,i,bkId)=>`<div onclick="${bkId?`scrollToBk(${bkId})`:''}" style="display:flex;align-items:center;gap:6px;padding:3px 0;${bkId?'cursor:pointer;':''}${i%2?'background:#f9f9f9;margin:0 -10px;padding:3px 10px;border-radius:4px;':''}" ${bkId?'onmouseenter="this.style.background=\'#E3F2FD\'" onmouseleave="this.style.background=\''+(i%2?'#f9f9f9':'transparent')+'\';"':''}><span style="font-size:10px;color:#888;font-weight:700;min-width:38px;font-family:monospace;">${date}</span><span style="font-size:11px;color:${bkId?'#1565C0':'#222'};font-weight:600;flex:1;${bkId?'text-decoration:underline dotted;':''}">${name}</span>${extra?`<span style="font-size:10px;color:#666;font-weight:700;">${extra}</span>`:''}</div>`;
  const tipMore=(n,tipIdx)=>n>0?`<div id="tipMore_${tipIdx}" onclick="expandCardTip(${tipIdx})" style="text-align:center;padding:6px 0 2px;margin-top:4px;border-top:1px dashed #ddd;font-size:11px;color:#1565C0;font-weight:700;cursor:pointer;">▼ 외 ${n}건 더보기</div>`:'';
  const tipEmpty=(msg)=>`<div style="text-align:center;padding:8px;color:#bbb;font-size:12px;">${msg}</div>`;

  const dateGroups={};f.forEach(b=>{const d=b.date;dateGroups[d]=(dateGroups[d]||0)+1;});
  const dgEntries=Object.entries(dateGroups).sort(([a],[b])=>a.localeCompare(b));
  const teamTip=tipHd('📅','날짜별 현황','#2e7d32')+dgEntries.slice(0,10).map(([d,c],i)=>tipRow(d.slice(5),c+'팀',`${c*(Math.round(totalPpl/totalTeams)||0)}명 추정`,i)).join('')+tipMore(Math.max(0,dgEntries.length-10),0);
  const teamTipFull=tipHd('📅','날짜별 현황','#2e7d32')+dgEntries.map(([d,c],i)=>tipRow(d.slice(5),c+'팀',`${c*(Math.round(totalPpl/totalTeams)||0)}명 추정`,i)).join('');

  const topPpl=[...f].sort((a,b)=>(b.students+b.teachers)-(a.students+a.teachers)).slice(0,6);
  const pplTip=tipHd('👥','인원 TOP','#1565C0')+topPpl.map((b,i)=>tipRow(b.date.slice(5),b.name,`<b style="color:#1565C0;">${b.students+b.teachers}명</b>`,i,b.id)).join('');

  const confList=f.filter(b=>b.status==='확정');
  const confTip=confList.length?tipHd('✅','확정 단체','#2e7d32')+confList.slice(0,8).map((b,i)=>tipRow(b.date.slice(5),b.name,`${b.students+b.teachers}명`,i,b.id)).join('')+tipMore(Math.max(0,confList.length-8),2):tipEmpty('확정 예약 없음');
  const confTipFull=confList.length?tipHd('✅','확정 단체','#2e7d32')+confList.map((b,i)=>tipRow(b.date.slice(5),b.name,`${b.students+b.teachers}명`,i,b.id)).join(''):confTip;

  const pendList=f.filter(b=>b.status==='대기');
  const pendTip=pendList.length?tipHd('⏳','대기 단체','#e65100')+pendList.slice(0,8).map((b,i)=>tipRow(b.date.slice(5),b.name,`${b.students+b.teachers}명`,i,b.id)).join('')+tipMore(Math.max(0,pendList.length-8),3):tipEmpty('대기 예약 없음');
  const pendTipFull=pendList.length?tipHd('⏳','대기 단체','#e65100')+pendList.map((b,i)=>tipRow(b.date.slice(5),b.name,`${b.students+b.teachers}명`,i,b.id)).join(''):pendTip;

  const cancList=f.filter(b=>b.status==='취소');
  const cancTip=cancList.length?tipHd('❌','취소 단체','#c62828')+cancList.slice(0,8).map((b,i)=>tipRow(b.date.slice(5),b.name,`${b.students+b.teachers}명`,i,b.id)).join('')+tipMore(Math.max(0,cancList.length-8),4):tipEmpty('취소 예약 없음');
  const cancTipFull=cancList.length?tipHd('❌','취소 단체','#c62828')+cancList.map((b,i)=>tipRow(b.date.slice(5),b.name,`${b.students+b.teachers}명`,i,b.id)).join(''):cancTip;

  const mealList=f.filter(b=>b.meal&&b.meal.includes('이용함'));
  const mealTip=mealList.length?tipHd('🍚','식사 이용','#C2185B')+mealList.slice(0,8).map((b,i)=>tipRow(b.date.slice(5),b.name,`<b style="color:#C2185B;">${b.students+b.teachers}명</b>`,i,b.id)).join('')+tipMore(Math.max(0,mealList.length-8),5):tipEmpty('식사 이용 없음');
  const mealTipFull=mealList.length?tipHd('🍚','식사 이용','#C2185B')+mealList.map((b,i)=>tipRow(b.date.slice(5),b.name,`<b style="color:#C2185B;">${b.students+b.teachers}명</b>`,i,b.id)).join(''):mealTip;

  const addonList=f.filter(b=>b.addons&&b.addons.length);
  const addonTip=addonList.length?tipHd('🎨','체험 단체','#7B1FA2')+addonList.slice(0,8).map((b,i)=>tipRow(b.date.slice(5),b.name,`<span style="background:#7B1FA2;color:#fff;padding:1px 5px;border-radius:4px;font-size:9px;">${b.addons.join(' ')}</span>`,i,b.id)).join('')+tipMore(Math.max(0,addonList.length-8),6):tipEmpty('체험 예약 없음');
  const addonTipFull=addonList.length?tipHd('🎨','체험 단체','#7B1FA2')+addonList.map((b,i)=>tipRow(b.date.slice(5),b.name,`<span style="background:#7B1FA2;color:#fff;padding:1px 5px;border-radius:4px;font-size:9px;">${b.addons.join(' ')}</span>`,i,b.id)).join(''):addonTip;

  window._cardTips=[teamTip,pplTip,confTip,pendTip,cancTip,mealTip,addonTip];
  window._cardTipsFull=[teamTipFull,pplTip,confTipFull,pendTipFull,cancTipFull,mealTipFull,addonTipFull];
  const mkCard=(val,label,clr,tipIdx,pctVal,flex='1')=>`<div style="flex:${flex};min-width:0;background:#fff;border-radius:10px;border:1px solid #eee;box-shadow:0 1px 3px rgba(0,0,0,.06);position:relative;cursor:default;transition:box-shadow .15s,transform .15s;" onmouseenter="this.style.boxShadow='0 3px 12px rgba(0,0,0,.15)';this.style.transform='translateY(-1px)';showCardTip(this,${tipIdx})" onmouseleave="this.style.boxShadow='0 1px 3px rgba(0,0,0,.06)';this.style.transform='';setTimeout(hideCardTip,150)"><div style="${abC}">
    <span style="font-size:22px;font-weight:900;color:${clr};">${val}</span><span style="font-size:12px;font-weight:700;color:#999;">${label}</span>${pctVal!==null?`<span style="font-size:13px;font-weight:800;color:${clr};">${pctVal}%</span>`:''}</div></div>`;

  document.getElementById('abSummary').innerHTML=`
    <div style="display:flex;gap:8px;width:100%;">
      ${mkCard(totalTeams,'팀','var(--p)',0,null)}
      ${mkCard(totalPpl+`<span style="font-size:10px;color:#aaa;font-weight:600;"> (${totalStu}+${totalTea})</span>`,'명','var(--blu)',1,null,'1.3')}
      ${mkCard(conf,'확정','#2e7d32',2,pct(conf))}
      ${mkCard(pend,'대기','#e65100',3,pct(pend))}
      ${mkCard(canc,'취소','#c62828',4,pct(canc))}
      ${mkCard(mealYes,'식사','#C2185B',5,pct(mealYes))}
      ${mkCard(hasAddon,'체험','#7B1FA2',6,pct(hasAddon))}
    </div>
    <div style="display:flex;gap:8px;width:100%;margin-top:6px;">
      <div style="flex:1;background:#fff;border-radius:10px;border:1px solid #eee;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:6px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span style="font-size:11px;font-weight:800;color:#555;">채널</span>
        <span style="font-size:10px;padding:3px 8px;border-radius:6px;background:#2E7D32;color:#fff;font-weight:700;">직접 ${directCount} <span style="opacity:.8;font-size:8px;">${pct(directCount)}%</span></span>
        <span style="font-size:10px;padding:3px 8px;border-radius:6px;background:#E65100;color:#fff;font-weight:700;">🏢대행사 ${agencyCount} <span style="opacity:.8;font-size:8px;">${pct(agencyCount)}%</span></span>
      </div>
      <div style="flex:2;background:#fff;border-radius:10px;border:1px solid #eee;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:6px 12px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <span style="font-size:11px;font-weight:800;color:#555;">기관별</span>${catHtml}
      </div>
    </div>`;

  // Group by date
  const grouped={};
  f.forEach(b=>{if(!grouped[b.date])grouped[b.date]=[];grouped[b.date].push(b);});
  const dates=Object.keys(grouped).sort();

  let html='<div class="card" style="margin:0;"><div class="cbd" style="padding:0;overflow:auto;max-height:72vh;">';
  html+=`<table id="bkTable" style="width:100%;border-collapse:collapse;font-size:12px;table-layout:fixed;">
    <colgroup><col style="width:30px"><col style="width:52px"><col style="width:auto"><col style="width:52px"><col style="width:52px"><col style="width:66px"><col style="width:84px"><col style="width:48px"><col style="width:100px"><col style="width:42px"><col style="width:36px"><col style="width:48px"></colgroup>
    <thead><tr style="background:#2e7d32;color:#fff;position:sticky;top:0;z-index:2;">
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">년<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">날짜<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 3px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">단체명<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">기관<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">채널<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">인원<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">시간<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">코스<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">연락처<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">상태<div class="rz-handle"></div></th>
      <th class="rz-th" style="padding:6px 2px;font-weight:800;font-size:11px;border-right:1px solid rgba(255,255,255,.25);position:relative;">메모<div class="rz-handle"></div></th>
      <th style="padding:6px 2px;font-weight:800;font-size:11px;">관리</th>
    </tr></thead><tbody>`;

  const dayNames=['일','월','화','수','목','금','토'];
  const dayColors=['#e53935','#555','#555','#555','#555','#555','#1e88e5'];
  const rowBgs=['#fff','#F5F5F5'];
  let rowIdx=0;

  // Pre-calculate year rowspans
  const yearRows={};
  dates.forEach(date=>{
    const yr=date.slice(0,4);
    const cnt=grouped[date].length+1; // rows + subtotal
    yearRows[yr]=(yearRows[yr]||0)+cnt;
  });
  const yearRendered={};

  dates.forEach(date=>{
    const group=grouped[date];
    const d=new Date(date);
    const dayName=dayNames[d.getDay()];
    const dayColor=dayColors[d.getDay()];
    const gPpl=group.reduce((s,b)=>s+b.students+b.teachers,0);
    const gStu=group.reduce((s,b)=>s+b.students,0);
    const gTea=group.reduce((s,b)=>s+b.teachers,0);
    const gMeal=group.filter(b=>b.meal&&b.meal.includes('이용함')).length;
    const isPast=date<td();
    const isToday=date===td();
    const dateYear=date.slice(0,4);
    const dateMonth=date.slice(5,7);
    const dateDay=date.slice(8,10);
    const rspan=group.length+1;
    const dateBg=isToday?'#C8E6C9':isPast?'#eee':'#FFF9C4';
    const dateBorder=isToday?'#2e7d32':'#ccc';

    group.forEach((b,bi)=>{
      const scBg=b.status==='확정'?'#2e7d32':b.status==='대기'?'#e65100':'#c62828';
      const adStr=b.addons&&b.addons.length?b.addons.map(a=>`<span style="font-size:9px;background:#7B1FA2;color:#fff;padding:1px 6px;border-radius:8px;display:inline-block;margin:1px;">${a}</span>`).join(''):'<span style="color:#ccc;">-</span>';
      const memo=memos[b.id]||'';
      const bgColor=isToday?'#E8F5E9':rowBgs[rowIdx%2];
      const opSt=isPast?'opacity:.5;':'';

      html+=`<tr data-bkid="${b.id}" ${bi===0&&isToday?'data-today="1"':''} style="background:${bgColor};border-bottom:1px solid #ddd;${opSt}" onmouseenter="this.style.background='#DCEDC8'" onmouseleave="this.style.background='${bgColor}'">`;

      // Year cell - only first row of each year
      if(!yearRendered[dateYear]){
        yearRendered[dateYear]=true;
        const yrColors=['#1565C0','#00838F','#2E7D32','#AD1457','#E65100','#4527A0'];
        const yrClr=yrColors[parseInt(dateYear)%yrColors.length];
        html+=`<td rowspan="${yearRows[dateYear]}" style="padding:4px 2px;background:${yrClr};text-align:center;vertical-align:middle;border-right:3px solid ${yrClr};writing-mode:vertical-lr;text-orientation:mixed;letter-spacing:4px;">
          <span style="font-size:16px;font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.3);">${dateYear}</span>
        </td>`;
      }

      // Date cell
      if(bi===0){
        html+=`<td rowspan="${rspan}" style="padding:2px 1px;border-right:2px solid ${dateBorder};background:${dateBg};text-align:center;vertical-align:middle;border-top:1px solid ${dateBorder};border-bottom:1px solid ${dateBorder};">
          <div style="font-size:13px;font-weight:900;color:${isToday?'#1B5E20':'#222'};line-height:1;">${dateMonth}/${dateDay}</div>
          <div style="font-size:10px;font-weight:800;color:${dayColor};">${dayName}</div>
          ${isToday?'<div style="background:#2e7d32;color:#fff;font-size:7px;font-weight:800;padding:1px 4px;border-radius:5px;margin-top:1px;display:inline-block;">TODAY</div>':''}
          <div style="margin-top:2px;background:${isToday?'#2e7d32':'#546E7A'};color:#fff;font-size:8px;font-weight:800;padding:1px 4px;border-radius:5px;display:inline-block;">${group.length}팀</div>
        </td>`;
      }

      html+=`<td style="padding:4px;border-right:1px solid #ddd;font-weight:700;font-size:13px;color:#111;word-break:break-all;cursor:pointer;" ondblclick="inlineEdit(this,${b.id},'name')" title="더블클릭하여 수정">
          ${b.name}
        </td>
        <td style="padding:2px;border-right:1px solid #ddd;text-align:center;">
          <select onchange="setBkCat(${b.id},this.value)" style="width:100%;font-size:9px;padding:2px 0;border:1px solid #ddd;border-radius:3px;background:#fff;color:#555;font-weight:600;outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;text-align:center;">
            <option value="미분류" ${(b.category||'미분류')==='미분류'?'selected':''}>미분류</option>
            <option value="어린이집" ${b.category==='어린이집'?'selected':''}>어린이집</option>
            <option value="유치원" ${b.category==='유치원'?'selected':''}>유치원</option>
            <option value="초등학교" ${b.category==='초등학교'?'selected':''}>초등</option>
            <option value="중학교" ${b.category==='중학교'?'selected':''}>중학교</option>
            <option value="고등학교" ${b.category==='고등학교'?'selected':''}>고등</option>
            <option value="대학교" ${b.category==='대학교'?'selected':''}>대학교</option>
            <option value="기관/단체" ${b.category==='기관/단체'?'selected':''}>기관</option>
            <option value="기업" ${b.category==='기업'?'selected':''}>기업</option>
            <option value="동호회" ${b.category==='동호회'?'selected':''}>동호회</option>
            <option value="기타" ${b.category==='기타'?'selected':''}>기타</option>
          </select>
        </td>
        <td style="padding:2px;border-right:1px solid #ddd;text-align:center;">
          <select onchange="setBkAgency(${b.id},this.value)" style="width:100%;font-size:9px;padding:2px 0;border:1px solid ${b.agency?'#E65100':'#ddd'};border-radius:3px;background:${b.agency?'#FFF3E0':'#fff'};color:${b.agency?'#E65100':'#888'};font-weight:700;outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;text-align:center;">
            <option value="">직영</option>
            ${agencies.filter(a=>a.active!==false).map(a=>`<option value="${a.code}" ${b.agency===a.code?'selected':''}>${a.name}</option>`).join('')}
          </select>
        </td>
        <td style="padding:3px 2px;border-right:1px solid #ddd;text-align:center;white-space:nowrap;font-size:12px;cursor:pointer;" ondblclick="inlineEditPpl(this,${b.id})" title="더블클릭하여 수정">
          <strong style="color:#1B5E20;font-size:16px;">${b.students}</strong><span style="color:#888;font-weight:700;font-size:12px;">+${b.teachers}</span>
          <div style="font-size:13px;color:#111;font-weight:900;">${b.students+b.teachers}명</div>
        </td>
        <td style="padding:3px 2px;border-right:1px solid #ddd;text-align:center;white-space:nowrap;font-size:11px;color:#222;font-weight:600;cursor:pointer;" ondblclick="inlineEditTime(this,${b.id})" title="더블클릭하여 수정">${b.arrival}~${b.departure}</td>
        <td style="padding:2px;border-right:1px solid #ddd;text-align:center;cursor:pointer;" onclick="popCourse(this,${b.id})">
          <span style="font-size:10px;padding:3px 5px;border-radius:5px;background:${(b.courseType||'').includes('단체식')?'#E65100':'#2e7d32'};color:#fff;font-weight:700;">${(b.courseType||'기본').replace('기본코스','기본')}</span>
          ${b.meal&&b.meal.includes('이용함')?'<div style="font-size:8px;color:#C2185B;font-weight:800;">🍚식사</div>':''}
          ${b.addons&&b.addons.length?'<div style="font-size:8px;color:#7B1FA2;font-weight:700;">🎨'+b.addons.length+'</div>':''}
        </td>
        <td style="padding:3px 2px;border-right:1px solid #ddd;font-size:11px;white-space:nowrap;color:#222;font-weight:600;cursor:pointer;" ondblclick="inlineEdit(this,${b.id},'phone')" title="더블클릭하여 수정">${b.phone}</td>
        <td style="padding:2px;border-right:1px solid #ddd;text-align:center;cursor:pointer;" onclick="popStatus(this,${b.id})">
          <span style="display:inline-block;padding:3px 6px;border-radius:5px;font-size:10px;font-weight:800;background:${scBg};color:#fff;">${b.status}</span>
        </td>
        <td style="padding:2px;border-right:1px solid #ddd;text-align:center;background:${memo?'#FFF3E0':'transparent'};" class="memo-cell" onmouseenter="showMemoTip(this,${b.id})" onmouseleave="hideMemoTip()">
          ${memo?`<div onclick="openMemoPopup(${b.id},this)" style="cursor:pointer;padding:3px 4px;border-radius:6px;background:#E65100;color:#fff;font-size:11px;font-weight:800;line-height:1;">📝</div>`:`<div onclick="openMemoPopup(${b.id},this)" style="cursor:pointer;padding:3px 4px;border-radius:6px;border:1px dashed #bbb;color:#aaa;font-size:11px;line-height:1;">✏️</div>`}
        </td>
        <td style="padding:2px;text-align:center;white-space:nowrap;">
          <button onclick="showDtl(${b.id})" style="display:block;width:100%;padding:3px 2px;margin-bottom:2px;font-size:10px;border:1px solid #1565C0;border-radius:4px;background:#E3F2FD;color:#1565C0;font-weight:800;cursor:pointer;">수정</button>
          <button onclick="delBk(${b.id})" style="display:block;width:100%;padding:3px 2px;font-size:10px;border:1px solid #c62828;border-radius:4px;background:#FFEBEE;color:#c62828;font-weight:800;cursor:pointer;">삭제</button>
        </td>
      </tr>`;
      rowIdx++;
    });

    // Subtotal row
    const stClr=isToday?'#1B5E20':'#555';
    const stBg=isToday?'#A5D6A7':'#E8E8E8';
    const confCnt=group.filter(b=>b.status==='확정').length;
    const pendCnt=group.filter(b=>b.status==='대기').length;
    const cancCnt=group.filter(b=>b.status==='취소').length;
    html+=`<tr style="background:${stBg};border-bottom:3px solid ${dateBorder};${isPast?'opacity:.5;':''}">
      <td colspan="12" style="padding:6px 12px;">
        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
          <span style="font-size:12px;font-weight:900;color:${stClr};letter-spacing:1px;">소계</span>
          <span style="background:#1565C0;color:#fff;padding:4px 12px;border-radius:6px;font-size:15px;font-weight:900;letter-spacing:0.5px;">${gPpl}명</span>
          <span style="font-size:13px;color:#333;font-weight:700;">아동 <b style="color:#1B5E20;font-size:14px;">${gStu}</b> + 인솔 <b style="color:#e65100;font-size:14px;">${gTea}</b></span>
          <span style="color:#bbb;font-size:14px;">│</span>
          ${confCnt?`<span style="font-size:12px;font-weight:800;color:#2e7d32;">✅${confCnt}</span>`:''}
          ${pendCnt?`<span style="font-size:12px;font-weight:800;color:#e65100;">⏳${pendCnt}</span>`:''}
          ${cancCnt?`<span style="font-size:12px;font-weight:800;color:#c62828;">❌${cancCnt}</span>`:''}
          ${gMeal?`<span style="color:#bbb;font-size:14px;">│</span><span style="background:#C2185B;color:#fff;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:800;">🍚 식사 ${gMeal}팀</span>`:''}
        </div>
      </td>
    </tr>`;
  });

  html+='</tbody></table></div></div>';

  if(!dates.length) html='<div style="text-align:center;padding:40px;color:#aaa;">검색 결과가 없습니다.</div>';
  document.getElementById('abList').innerHTML=html;
  if(window.restoreBkColWidths)restoreBkColWidths();
}

function expAll(){
  let h=`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"><style>td,th{border:1px solid #999;padding:6px 10px;font-family:맑은 고딕;font-size:11pt;mso-number-format:\\@;}</style></head><body><table>`;
  h+=`<tr><th>날짜</th><th>단체</th><th>아동</th><th>인솔</th><th>총인원</th><th>입장</th><th>퇴장</th><th>코스</th><th>식사</th><th>부가체험</th><th>연락처</th><th>이메일</th><th>상태</th><th>메모</th></tr>`;
  bks.forEach(b=>{h+=`<tr><td>${b.date}</td><td>${b.name}</td><td>${b.students}</td><td>${b.teachers}</td><td>${b.students+b.teachers}</td><td>${b.arrival}</td><td>${b.departure}</td><td>${b.courseType}</td><td>${b.meal}</td><td>${b.addons?.join(',')||'없음'}</td><td>${b.phone}</td><td>${b.email||''}</td><td>${b.status}</td><td>${memos[b.id]||''}</td></tr>`;});
  h+='</table></body></html>';dl(h,`전체예약_${td()}.xls`);toast('📥 다운로드','s');
}

// ===== STATUS / DETAIL =====
function setSt(id,st){
  const b=bks.find(x=>x.id===id);if(!b)return;
  if(st==='취소'){
    promptReason(`❌ "${b.name}" 취소 처리`,function(reason){
      pushUndo('상태변경',`${b.name} ${b.status}→${st}`,JSON.stringify(bks),reason);
      b.status=st;sv();toast(`${b.name} ${st}`,'i');rfr();
    });
  } else {
    pushUndo('상태변경',`${b.name} ${b.status}→${st}`,JSON.stringify(bks));
    b.status=st;sv();
    if(st==='확정'){sendK('customer',custMsg(b,'확정'),b.phone);toast(`✅ ${b.name} 확정`,'s');toast('💬 고객 카톡 전송','k');}
    else toast(`${b.name} ${st}`,'i');
    rfr();
  }
}
function delBk(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  promptReason(`🗑️ "${b.name}" 예약 삭제`,function(reason){
    pushUndo('삭제',`${b.name} ${b.date} 예약 삭제`,JSON.stringify(bks),reason);
    bks=bks.filter(x=>x.id!==id);sv();
    toast('🗑️ 삭제 (↩ 하단 되돌리기 가능)','i');rfr();
  });
}

function saveDtlEdit(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  pushUndo('수정',`${b.name} 예약정보 수정`,JSON.stringify(bks));
  b.date=document.getElementById('dtl_date').value||b.date;
  b.name=document.getElementById('dtl_name').value.trim()||b.name;
  b.arrival=document.getElementById('dtl_arrival').value;
  b.departure=document.getElementById('dtl_departure').value;
  const st1=parseInt(document.getElementById('dtl_st1').value)||0;
  const st2=parseInt(document.getElementById('dtl_st2').value)||0;
  b.studentsChild=st1;b.studentsElem=st2;b.students=st1+st2;
  b.teachers=parseInt(document.getElementById('dtl_tc').value)||0;
  b.courseType=document.getElementById('dtl_course').value;
  b.meal=document.getElementById('dtl_meal').value;
  b.phone=document.getElementById('dtl_phone').value.trim();
  b.email=document.getElementById('dtl_email').value.trim();
  b.channel=document.getElementById('dtl_channel').value.trim();
  b.etc=document.getElementById('dtl_etc').value.trim();
  const checkedAddons=[];document.querySelectorAll('.dtl_addon:checked').forEach(c=>checkedAddons.push(c.value));
  b.addons=checkedAddons;
  sv();
  addLog('수정',`${b.name} 예약정보 수정`);
  toast('💾 예약정보가 수정되었습니다','s');
  cMdl();rfr();
}

function showDtl(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const sc=b.status==='확정'?'bdg-g':b.status==='대기'?'bdg-y':'bdg-r';
  document.getElementById('mtl').textContent=b.name;
  const q=b.customQuote?{items:b.customQuote,grandTotal:b.customQuote.reduce((s,i)=>s+i.total,0)}:calcQuote(b);
  const estAmt=q.grandTotal;
  const paidAmt=b.paidAmount!=null?b.paidAmount:'';
  document.getElementById('mdlBd').innerHTML=`${mode==='admin'?`
  <div style="margin-bottom:10px;padding:10px;background:#e8f5e9;border-radius:8px;border:1px solid #c8e6c9;">
    <div style="font-size:11px;font-weight:700;color:var(--p);margin-bottom:8px;">✏️ 예약 정보 수정</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">
      <div><label style="font-size:10px;color:#888;">📅 날짜</label><input type="date" id="dtl_date" value="${b.date}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
      <div><label style="font-size:10px;color:#888;">🏫 단체명</label><input type="text" id="dtl_name" value="${b.name}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
      <div><label style="font-size:10px;color:#888;">⏰ 입장</label><select id="dtl_arrival" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;">${['09:00','09:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00'].map(t=>`<option ${b.arrival===t?'selected':''}>${t}</option>`).join('')}</select></div>
      <div><label style="font-size:10px;color:#888;">⏰ 퇴장</label><select id="dtl_departure" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;">${['10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00'].map(t=>`<option ${b.departure===t?'selected':''}>${t}</option>`).join('')}</select></div>
      <div><label style="font-size:10px;color:#888;">👶 유아</label><input type="number" id="dtl_st1" value="${b.studentsChild||0}" min="0" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;text-align:center;"></div>
      <div><label style="font-size:10px;color:#888;">🧒 초등</label><input type="number" id="dtl_st2" value="${b.studentsElem||0}" min="0" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;text-align:center;"></div>
      <div><label style="font-size:10px;color:#888;">👤 인솔</label><input type="number" id="dtl_tc" value="${b.teachers}" min="0" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;text-align:center;"></div>
      <div><label style="font-size:10px;color:#888;">🎫 코스</label><select id="dtl_course" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;">${['기본코스','기본코스+단체식'].map(c=>`<option ${b.courseType===c?'selected':''}>${c}</option>`).join('')}</select></div>
      <div><label style="font-size:10px;color:#888;">🍚 식사</label><select id="dtl_meal" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"><option value="이용안함" ${!b.meal||b.meal==='이용안함'?'selected':''}>이용안함</option>${formCfg.meals.map(m=>`<option value="${m.name}" ${b.meal===m.name?'selected':''}>${m.name}</option>`).join('')}</select></div>
      <div><label style="font-size:10px;color:#888;">📞 연락처</label><input type="text" id="dtl_phone" value="${b.phone||''}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
      <div><label style="font-size:10px;color:#888;">📧 이메일</label><input type="text" id="dtl_email" value="${b.email||''}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
      <div><label style="font-size:10px;color:#888;">📢 유입경로</label><input type="text" id="dtl_channel" value="${b.channel||''}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
    </div>
    <div style="margin-top:8px;"><label style="font-size:10px;color:#888;">🎨 부가체험</label>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;">${formCfg.addons.map(a=>`<label style="font-size:11px;padding:2px 6px;border:1px solid #ddd;border-radius:4px;cursor:pointer;background:${b.addons?.some(x=>x.includes(a.name))?'#e8f5e9':'#fff'};"><input type="checkbox" class="dtl_addon" value="${a.name}" ${b.addons?.some(x=>x.includes(a.name))?'checked':''} style="margin-right:2px;">${a.name}</label>`).join('')}</div>
    </div>
    <div style="margin-top:8px;"><label style="font-size:10px;color:#F57F17;font-weight:700;">📝 요청사항</label><textarea id="dtl_etc" style="width:100%;padding:6px;border:2px solid #FFB300;border-radius:6px;font-size:12px;min-height:50px;background:#FFFDE7;margin-top:2px;">${b.etc||''}</textarea></div>
    <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end;">
      <button class="btn bg bs" onclick="saveDtlEdit(${b.id})">💾 수정 저장</button>
    </div>
  </div>
  `:`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">
    <div><label style="font-size:10px;color:#888;">📅 날짜</label><input type="date" id="dtl_date" value="${b.date}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
    <div><label style="font-size:10px;color:#888;">🏫 단체명</label><input type="text" id="dtl_name" value="${b.name}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"> ${b.category?`<span class="bdg" style="background:#e8f5e9;color:var(--p);font-size:10px;">${b.category}</span>`:''}</div>
    <div><label style="font-size:10px;color:#888;">⏰ 입장</label><select id="dtl_arrival" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;">${['09:00','09:30','10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00'].map(t=>`<option ${b.arrival===t?'selected':''}>${t}</option>`).join('')}</select></div>
    <div><label style="font-size:10px;color:#888;">⏰ 퇴장</label><select id="dtl_departure" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;">${['10:00','10:30','11:00','11:30','12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00'].map(t=>`<option ${b.departure===t?'selected':''}>${t}</option>`).join('')}</select></div>
    <div><label style="font-size:10px;color:#888;">👶 유아</label><input type="number" id="dtl_st1" value="${b.studentsChild||0}" min="0" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;text-align:center;"></div>
    <div><label style="font-size:10px;color:#888;">🧒 초등</label><input type="number" id="dtl_st2" value="${b.studentsElem||0}" min="0" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;text-align:center;"></div>
    <div><label style="font-size:10px;color:#888;">👤 인솔</label><input type="number" id="dtl_tc" value="${b.teachers}" min="0" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;text-align:center;"></div>
    <div><label style="font-size:10px;color:#888;">🎫 코스</label><select id="dtl_course" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;">${['기본코스','기본코스+단체식'].map(c=>`<option ${b.courseType===c?'selected':''}>${c}</option>`).join('')}</select></div>
    <div><label style="font-size:10px;color:#888;">🍚 식사</label><select id="dtl_meal" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"><option value="이용안함" ${!b.meal||b.meal==='이용안함'?'selected':''}>이용안함</option>${formCfg.meals.map(m=>`<option value="${m.name}" ${b.meal===m.name?'selected':''}>${m.name}</option>`).join('')}</select></div>
    <div><label style="font-size:10px;color:#888;">📞 연락처</label><input type="text" id="dtl_phone" value="${b.phone||''}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
    <div><label style="font-size:10px;color:#888;">📧 이메일</label><input type="text" id="dtl_email" value="${b.email||''}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
    <div><label style="font-size:10px;color:#888;">📢 유입경로</label><input type="text" id="dtl_channel" value="${b.channel||''}" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:12px;"></div>
    <div style="grid-column:1/-1;"><label style="font-size:10px;color:#888;">🎨 부가체험</label>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;">${formCfg.addons.map(a=>`<label style="font-size:11px;padding:2px 6px;border:1px solid #ddd;border-radius:4px;cursor:pointer;background:${b.addons?.some(x=>x.includes(a.name))?'#e8f5e9':'#fff'};"><input type="checkbox" class="dtl_addon" value="${a.name}" ${b.addons?.some(x=>x.includes(a.name))?'checked':''} style="margin-right:2px;">${a.name}</label>`).join('')}</div>
    </div>
  </div>
  <div style="margin-top:8px;"><label style="font-size:10px;color:#F57F17;font-weight:700;">📝 요청사항</label><textarea id="dtl_etc" style="width:100%;padding:6px;border:2px solid #FFB300;border-radius:6px;font-size:12px;min-height:50px;background:#FFFDE7;margin-top:2px;">${b.etc||''}</textarea></div>
  <div style="margin-top:8px;text-align:right;"><button class="btn bg bs" onclick="saveDtlEdit(${b.id})">💾 수정 저장</button></div>
  <div style="margin-top:6px;"><span class="bdg ${sc}">${b.status}</span></div>
  `}
  ${mode==='admin'?`
  <div style="margin-top:10px;padding:14px;background:#fce4ec;border-radius:10px;border:1px solid #f8bbd0;">
    <div style="font-size:13px;font-weight:700;color:#c2185b;margin-bottom:8px;">📋 실제 내역 (방문일 확인 후 입력)</div>
    <div style="font-size:10px;color:#888;margin-bottom:8px;">비워두면 해당 항목은 '없음'으로 처리됩니다.</div>
    <div style="font-size:11px;font-weight:600;color:#c2185b;margin-bottom:4px;">👥 실제 인원</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:4px;">
      <div><label style="font-size:10px;color:#888;">유아</label><input type="number" id="dtl_aSt1" value="${b.actualStudentsChild!=null?b.actualStudentsChild:''}" placeholder="${b.studentsChild||0}" style="width:100%;padding:6px 8px;font-size:13px;border:2px solid #f48fb1;border-radius:6px;text-align:center;"></div>
      <div><label style="font-size:10px;color:#888;">초등</label><input type="number" id="dtl_aSt2" value="${b.actualStudentsElem!=null?b.actualStudentsElem:''}" placeholder="${b.studentsElem||0}" style="width:100%;padding:6px 8px;font-size:13px;border:2px solid #f48fb1;border-radius:6px;text-align:center;"></div>
      <div><label style="font-size:10px;color:#888;">인솔자</label><input type="number" id="dtl_aTc" value="${b.actualTeachers!=null?b.actualTeachers:''}" placeholder="${b.teachers}" style="width:100%;padding:6px 8px;font-size:13px;border:2px solid #f48fb1;border-radius:6px;text-align:center;"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
      <div><label style="font-size:10px;color:#888;">유아 단가(원)</label><input type="number" id="dtl_aEntryP1" value="${b.actualEntryPrices?.child!=null?b.actualEntryPrices.child:''}" placeholder="${formCfg.entryP1}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #ce93d8;border-radius:5px;text-align:right;"></div>
      <div><label style="font-size:10px;color:#888;">초등 단가(원)</label><input type="number" id="dtl_aEntryP2" value="${b.actualEntryPrices?.elem!=null?b.actualEntryPrices.elem:''}" placeholder="${formCfg.entryP2}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #ce93d8;border-radius:5px;text-align:right;"></div>
      <div><label style="font-size:10px;color:#888;">인솔 단가(원)</label><input type="number" id="dtl_aEntryP3" value="${b.actualEntryPrices?.teacher!=null?b.actualEntryPrices.teacher:''}" placeholder="${formCfg.entryTea}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #ce93d8;border-radius:5px;text-align:right;"></div>
    </div>
    <div style="font-size:11px;font-weight:600;color:#c2185b;margin-bottom:4px;">🎨 실제 체험 <span style="font-size:9px;font-weight:400;color:#888;">(예약: ${b.addons?.length?b.addons.join(', '):'없음'})</span></div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
      ${formCfg.addons.map((a,idx)=>{
        const chkName=a.name;
        const defPrice=a.price;
        const wasBooked=b.addons?.some(x=>x.includes(chkName));
        const saved=b.actualAddonQty?b.actualAddonQty.find(x=>x.name===chkName):null;
        const qty=saved?saved.qty:'';
        const price=saved&&saved.price!=null?saved.price:'';
        return `<div style="display:flex;align-items:center;gap:6px;padding:5px 10px;border-radius:6px;border:1px solid ${wasBooked?'#f48fb1':'#ddd'};background:${wasBooked?'#fce4ec':'#fafafa'};flex-wrap:wrap;">
          <span style="font-size:11px;min-width:80px;">${chkName}${wasBooked?' <span style=\'font-size:8px;color:#c2185b;\'>예약</span>':''}</span>
          <input type="number" class="dtl_aAddonQty" data-name="${chkName}" value="${qty}" placeholder="0" min="0" style="width:55px;padding:4px 6px;font-size:12px;border:1px solid #f48fb1;border-radius:5px;text-align:center;">
          <span style="font-size:10px;color:#888;">명 ×</span>
          <input type="number" class="dtl_aAddonPrice" data-name="${chkName}" value="${price}" placeholder="${defPrice}" min="0" style="width:70px;padding:4px 6px;font-size:12px;border:1px solid #ce93d8;border-radius:5px;text-align:right;">
          <span style="font-size:10px;color:#888;">원</span>
        </div>`;
      }).join('')}
    </div>
    <div style="font-size:11px;font-weight:600;color:#c2185b;margin-bottom:4px;">🍚 실제 단체식 <span style="font-size:9px;font-weight:400;color:#888;">(예약: ${b.meal||'이용안함'})</span></div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="dtl_aMeal" onchange="toggleMealQty()" style="padding:6px 10px;font-size:12px;border:2px solid #f48fb1;border-radius:6px;">
          <option value="" ${!b.actualMeal&&b.actualStudents==null?'selected':(!b.actualMeal?'selected':'')}>이용안함</option>
          ${formCfg.meals.map(m=>`<option value="${m.name}" ${b.actualMeal===m.name?'selected':''}>${m.name}</option>`).join('')}
        </select>
      </div>
      <div id="dtl_aMealQtyWrap" style="display:${b.actualMeal?'grid':'none'};grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:4px;">
        <div><label style="font-size:10px;color:#888;">유아 식수</label><input type="number" id="dtl_aMealQ1" value="${b.actualMealQty?.child!=null?b.actualMealQty.child:''}" placeholder="${b.studentsChild||0}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #f48fb1;border-radius:5px;text-align:center;"></div>
        <div><label style="font-size:10px;color:#888;">초등 식수</label><input type="number" id="dtl_aMealQ2" value="${b.actualMealQty?.elem!=null?b.actualMealQty.elem:''}" placeholder="${b.studentsElem||0}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #f48fb1;border-radius:5px;text-align:center;"></div>
        <div><label style="font-size:10px;color:#888;">인솔 식수</label><input type="number" id="dtl_aMealQ3" value="${b.actualMealQty?.teacher!=null?b.actualMealQty.teacher:''}" placeholder="${b.teachers}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #f48fb1;border-radius:5px;text-align:center;"></div>
      </div>
      <div id="dtl_aMealPriceWrap" style="display:${b.actualMeal?'grid':'none'};grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;">
        <div><label style="font-size:10px;color:#888;">유아 단가(원)</label><input type="number" id="dtl_aMealP1" value="${b.actualMealQty?.priceChild!=null?b.actualMealQty.priceChild:''}" placeholder="${(()=>{const m=formCfg.meals.find(x=>x.name===(b.actualMeal||b.meal));return m?m.p1:8000;})()}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #ce93d8;border-radius:5px;text-align:right;"></div>
        <div><label style="font-size:10px;color:#888;">초등/인솔 단가(원)</label><input type="number" id="dtl_aMealP2" value="${b.actualMealQty?.priceElem!=null?b.actualMealQty.priceElem:''}" placeholder="${(()=>{const m=formCfg.meals.find(x=>x.name===(b.actualMeal||b.meal));return m?m.p2:10000;})()}" min="0" style="width:100%;padding:5px 6px;font-size:12px;border:1px solid #ce93d8;border-radius:5px;text-align:right;"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <button class="btn bs" style="background:#c2185b;color:#fff;" onclick="saveActual(${b.id})">💾 실제내역 저장</button>
      ${b.actualStudents!=null?`<button class="btn bs" style="background:#fdd;color:#c00;" onclick="clearActual(${b.id})">초기화</button>`:''}
      <span style="font-size:10px;color:#888;margin-left:auto;">예약: 유${b.studentsChild||0}+초${b.studentsElem||0}+인솔${b.teachers} = ${b.students+b.teachers}명${b.actualStudents!=null?` → 실제: ${b.actualStudents}+${b.actualTeachers!=null?b.actualTeachers:b.teachers} = ${(b.actualStudents||0)+(b.actualTeachers!=null?b.actualTeachers:b.teachers)}명`:''}</span>
    </div>
  </div>`:''}
  <div style="margin-top:14px;padding:14px;background:#f0f8e8;border-radius:10px;border:1px solid var(--bd);">
    <div style="font-size:13px;font-weight:700;color:var(--p);margin-bottom:8px;">💰 견적 금액: ₩${fmtWon(estAmt)}${b.actualStudents!=null?` <span style="font-size:11px;color:#c2185b;">(실제 기준: ₩${fmtWon(getEstimate(b,true))})</span>`:''}</div>
    <div style="font-size:11px;color:#666;">${q.items.map(i=>`${i.name}: ${i.qty}명 × ₩${fmtWon(i.unit)} = ₩${fmtWon(i.total)}`).join('<br>')}</div>
  </div>
  ${mode==='admin'?`
  <div style="margin-top:10px;padding:14px;background:#e3f2fd;border-radius:10px;border:1px solid #bbdefb;">
    <div style="font-size:13px;font-weight:700;color:#1565C0;margin-bottom:8px;">💳 실제 결제액</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <input type="number" id="dtl_paid" value="${paidAmt}" placeholder="미입력" style="flex:1;padding:8px 12px;font-size:14px;border:2px solid #90caf9;border-radius:8px;font-weight:700;">
      <button class="btn bb bs" onclick="savePaid(${b.id})">저장</button>
    </div>
    <div style="font-size:10px;color:#888;margin-top:6px;">
      ${paidAmt!==''?`차액: ₩${fmtWon(paidAmt-estAmt)} (${paidAmt>=estAmt?'▲':'▼'}${Math.abs(Math.round((paidAmt-estAmt)/estAmt*100))}%)`:'아직 미입력'}
    </div>
  </div>
  ${b.agency?`<div style="margin-top:10px;padding:14px;background:#fff3e0;border-radius:10px;border:1px solid #ffe082;">
    <div style="font-size:13px;font-weight:700;color:#e65100;margin-bottom:8px;">🏢 대행사 수수료 (${b.agencyName||b.agency})</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <span style="font-size:11px;color:#888;">기본: ${(()=>{const ag=agencies.find(a=>a.code===b.agency);return ag?ag.fee:0})()}%</span>
      <span style="font-size:11px;color:#888;">기간별: ${(()=>{const ag=agencies.find(a=>a.code===b.agency);if(!ag||!ag.periodFees)return'-';const mo=b.date.substring(0,7);const pf=ag.periodFees.find(p=>(!p.from||mo>=p.from)&&(!p.to||mo<=p.to));return pf?pf.rate+'%':'-';})()}</span>
      <span style="font-size:11px;font-weight:700;color:#e65100;">→ 적용: ${getAgencyFee(b.agency,b)}%</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <span style="font-size:11px;">건별 수수료 직접 지정:</span>
      <input type="number" id="dtl_feeRate" value="${b.feeRate!=null?b.feeRate:''}" placeholder="미지정(자동)" style="width:70px;padding:5px 8px;font-size:12px;border:2px solid #ffe082;border-radius:6px;text-align:right;">
      <span style="font-size:11px;">%</span>
      <button class="btn bs" style="background:#e65100;color:#fff;font-size:10px;" onclick="saveBkFee(${b.id})">저장</button>
      ${b.feeRate!=null?`<button class="btn bs" style="background:#fdd;color:#c00;font-size:10px;" onclick="clearBkFee(${b.id})">초기화</button>`:''}
    </div>
    <div style="font-size:10px;color:#888;margin-top:6px;">
      수수료: ₩${fmtWon(Math.round((b.paidAmount||0)*getAgencyFee(b.agency,b)/100))}
      ${b.feeRate!=null?` <span style="color:#e65100;">(건별 ${b.feeRate}% 적용)</span>`:''}
    </div>
  </div>`:''}`:''}`;
  const isAdm=mode==='admin';
  document.getElementById('mft').innerHTML=`
    <button class="btn bg bs" onclick="dlQuote(${b.id},'견적서')">📄 견적서</button>
    <button class="btn bb bs" onclick="dlQuote(${b.id},'거래내역서')">📋 거래내역서</button>
    ${b.actualStudents!=null?`<button class="btn bs" style="background:#fce4ec;color:#c2185b;" onclick="dlQuote(${b.id},'거래내역서(실제인원)')">📋 거래(실제)</button>`:''}
    ${isAdm&&b.status==='대기'?`<button class="btn bg bs" onclick="setSt(${b.id},'확정');cMdl();">확정</button>`:''}
    ${isAdm&&b.status!=='취소'?`<button class="btn br bs" onclick="setSt(${b.id},'취소');cMdl();">취소</button>`:''}
    ${isAdm?`<button class="btn bs" style="background:#fdd;color:#c00;" onclick="delBk(${b.id});cMdl();">삭제</button>`:''}
    <button class="btn bgy bs" onclick="cMdl()">닫기</button>`;
  document.getElementById('mdl').classList.add('show');
}

function savePaid(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  pushUndo('수정',`${b.name} 결제액 수정`,JSON.stringify(bks));
  const v=document.getElementById('dtl_paid').value;
  b.paidAmount=v!==''?parseInt(v):null;
  sv();toast('💳 실제 결제액 저장완료','s');
  showDtl(id);
}
function toggleMealQty(){
  const sel=document.getElementById('dtl_aMeal');
  const wrap=document.getElementById('dtl_aMealQtyWrap');
  const pwrap=document.getElementById('dtl_aMealPriceWrap');
  const show=sel&&sel.value?'grid':'none';
  if(wrap)wrap.style.display=show;
  if(pwrap)pwrap.style.display=show;
}

function saveActual(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  pushUndo('수정',`${b.name} 실제인원 수정`,JSON.stringify(bks));
  const v1=document.getElementById('dtl_aSt1').value;
  const v2=document.getElementById('dtl_aSt2').value;
  const vt=document.getElementById('dtl_aTc').value;
  const st1=v1!==''?parseInt(v1):null;
  const st2=v2!==''?parseInt(v2):null;
  const tc=vt!==''?parseInt(vt):null;
  if(st1===null&&st2===null&&tc===null){toast('실제 인원을 입력해주세요','e');return;}
  b.actualStudentsChild=st1!=null?st1:(b.studentsChild||0);
  b.actualStudentsElem=st2!=null?st2:(b.studentsElem||0);
  b.actualStudents=b.actualStudentsChild+b.actualStudentsElem;
  b.actualTeachers=tc!=null?tc:b.teachers;

  // Actual entry prices
  const ep1=document.getElementById('dtl_aEntryP1')?.value;
  const ep2=document.getElementById('dtl_aEntryP2')?.value;
  const ep3=document.getElementById('dtl_aEntryP3')?.value;
  if((ep1!==''&&ep1!=null)||(ep2!==''&&ep2!=null)||(ep3!==''&&ep3!=null)){
    b.actualEntryPrices={
      child:ep1!==''&&ep1!=null?parseInt(ep1):null,
      elem:ep2!==''&&ep2!=null?parseInt(ep2):null,
      teacher:ep3!==''&&ep3!=null?parseInt(ep3):null
    };
  } else { b.actualEntryPrices=null; }

  // Actual addon quantities and prices
  const addonQtyEls=document.querySelectorAll('.dtl_aAddonQty');
  const addonPriceEls=document.querySelectorAll('.dtl_aAddonPrice');
  b.actualAddonQty=[];
  b.actualAddons=[];
  addonQtyEls.forEach(el=>{
    const name=el.dataset.name;
    const qty=el.value!==''?parseInt(el.value):0;
    const priceEl=[...addonPriceEls].find(p=>p.dataset.name===name);
    const price=priceEl&&priceEl.value!==''?parseInt(priceEl.value):null;
    if(qty>0){
      b.actualAddonQty.push({name,qty,price});
      b.actualAddons.push(name);
    }
  });

  // Actual meal and quantities
  const mealEl=document.getElementById('dtl_aMeal');
  b.actualMeal=mealEl?mealEl.value:'';
  if(b.actualMeal){
    const mq1=document.getElementById('dtl_aMealQ1')?.value;
    const mq2=document.getElementById('dtl_aMealQ2')?.value;
    const mq3=document.getElementById('dtl_aMealQ3')?.value;
    const mp1=document.getElementById('dtl_aMealP1')?.value;
    const mp2=document.getElementById('dtl_aMealP2')?.value;
    b.actualMealQty={
      child:mq1!==''?parseInt(mq1):b.actualStudentsChild,
      elem:mq2!==''?parseInt(mq2):b.actualStudentsElem,
      teacher:mq3!==''?parseInt(mq3):(b.actualTeachers!=null?b.actualTeachers:b.teachers),
      priceChild:mp1!==''&&mp1!=null?parseInt(mp1):null,
      priceElem:mp2!==''&&mp2!=null?parseInt(mp2):null
    };
  } else {
    b.actualMealQty=null;
  }

  sv();toast('📋 실제내역 저장완료','s');showDtl(id);
}
function clearActual(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  delete b.actualStudents;delete b.actualStudentsChild;delete b.actualStudentsElem;delete b.actualTeachers;
  delete b.actualEntryPrices;delete b.actualAddons;delete b.actualAddonQty;delete b.actualMeal;delete b.actualMealQty;delete b.customQuoteActual;
  sv();toast('실제내역 초기화','s');showDtl(id);
}
function saveBkFee(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  const v=document.getElementById('dtl_feeRate').value;
  b.feeRate=v!==''?parseFloat(v):null;
  sv();toast('📌 건별 수수료 저장','s');showDtl(id);
}
function clearBkFee(id){
  const b=bks.find(x=>x.id===id);if(!b)return;
  b.feeRate=null;sv();toast('건별 수수료 초기화','s');showDtl(id);
}
function cMdl(){const m=document.getElementById('mdl');m.classList.remove('show');m.style.display='none';const inner=m.querySelector('.mdl');if(inner)inner.style.maxWidth='';}
function rfr(){const a=document.querySelector('.page.act');if(!a)return;const id=a.id.replace('p-','');if(id==='ad')rDash();if(id==='ac')rCal();if(id==='ab')rAll();if(sD)sCd(sD);}

// ===== SCHEDULE =====
let savedScheds=JSON.parse(localStorage.getItem('jp_scheds')||'{}');
function saveSavedScheds(){localStorage.setItem('jp_scheds',JSON.stringify(savedScheds));}

function bSch(){
  const ds=document.getElementById('sD').value;if(!ds){toast('날짜 선택','e');return;}
  // Check if saved version exists
  if(savedScheds[ds]){
    cSch=JSON.parse(JSON.stringify(savedScheds[ds]));
    sEd=null;rSch();
    toast('💾 저장된 일정표를 불러왔습니다','i');
    setTimeout(()=>{document.getElementById('sW').scrollIntoView({behavior:'smooth',block:'start'});},100);
    return;
  }
  const db=bks.filter(b=>b.date===ds&&b.status!=='취소');if(!db.length){toast('예약 없음','e');return;}
  const sch={},su={};TS.forEach((_,i)=>{su[i]=new Set();});
  const sorted=[...db].sort((a,b)=>ti(a.arrival)-ti(b.arrival));
  sorted.forEach((bk,bi)=>{
    const ai=ti(bk.arrival),di=ti(bk.departure);const sl=[];const used=new Set();
    let mi=-1;for(const mc of[3,4,5])if(mc>=ai&&mc<di){mi=mc;break;}
    for(let i=ai;i<di;i++){
      let a=null;if(mi===i)a=bk.courseType==='기본코스+단체식'?'점심식사(단체식)':'점심식사';
      else{for(const c of cs){if(c==='자유관람')continue;if(!used.has(c)&&!su[i].has(c)){a=c;used.add(c);break;}}if(!a)a='자유관람';}
      sl.push({t:i,a});if(a&&a!=='-'&&!a.includes('점심')&&a!=='자유관람')su[i].add(a);
    }sch[bi]=sl;
  });
  applySchRules(sch,sorted);
  cSch={date:ds,bks:sorted,sch,savedAt:null};sEd=null;rSch();
  setTimeout(()=>{document.getElementById('sW').scrollIntoView({behavior:'smooth',block:'start'});},100);
}

function regenSch(){
  if(!cSch)return;
  const ds=cSch.date;
  // Force regenerate (ignore saved)
  const db=bks.filter(b=>b.date===ds&&b.status!=='취소');if(!db.length){toast('예약 없음','e');return;}
  const sch={},su={};TS.forEach((_,i)=>{su[i]=new Set();});
  const sorted=[...db].sort((a,b)=>ti(a.arrival)-ti(b.arrival));
  sorted.forEach((bk,bi)=>{
    const ai=ti(bk.arrival),di=ti(bk.departure);const sl=[];const used=new Set();
    let mi=-1;for(const mc of[3,4,5])if(mc>=ai&&mc<di){mi=mc;break;}
    for(let i=ai;i<di;i++){
      let a=null;if(mi===i)a=bk.courseType==='기본코스+단체식'?'점심식사(단체식)':'점심식사';
      else{for(const c of cs){if(c==='자유관람')continue;if(!used.has(c)&&!su[i].has(c)){a=c;used.add(c);break;}}if(!a)a='자유관람';}
      sl.push({t:i,a});if(a&&a!=='-'&&!a.includes('점심')&&a!=='자유관람')su[i].add(a);
    }sch[bi]=sl;
  });
  applySchRules(sch,sorted);
  cSch={date:ds,bks:sorted,sch,savedAt:null};sEd=null;rSch();
  setTimeout(()=>{document.getElementById('sW').scrollIntoView({behavior:'smooth',block:'start'});},100);
  toast('⚡ 일정표가 새로 생성되었습니다','s');
}

function saveSch(){
  if(!cSch)return;
  cSch.savedAt=new Date().toLocaleString('ko-KR');
  savedScheds[cSch.date]=JSON.parse(JSON.stringify(cSch));
  saveSavedScheds();
  addLog('일정표저장',`${cSch.date} 일정표 저장 (${cSch.bks?.length||0}팀)`);
  toast('💾 일정표가 저장되었습니다!','s');
  rSch();renderSavedList();
}

function loadSch(ds){
  if(!savedScheds[ds])return;
  document.getElementById('sD').value=ds;
  cSch=JSON.parse(JSON.stringify(savedScheds[ds]));
  sEd=null;rSch();
  toast(`📋 ${ds} 일정표 불러옴`,'i');
  setTimeout(()=>{document.getElementById('sW').scrollIntoView({behavior:'smooth',block:'start'});},100);
}

function delSch(ds){
  const backup=JSON.parse(JSON.stringify(savedScheds[ds]));
  delete savedScheds[ds];saveSavedScheds();
  if(cSch&&cSch.date===ds){cSch=null;rSch();}
  renderSavedList();
  addLog('일정표삭제',`${ds} 일정표 삭제`);
  toast(`🗑️ ${ds} 일정표 삭제됨 <button onclick="undoDelSch('${ds}',this)" style="margin-left:8px;background:#fff;color:#333;border:1px solid #ccc;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:11px;">↩ 되돌리기</button>`,'i');
  window._lastDelSch={ds,backup};
}
function undoDelSch(ds,btn){
  if(window._lastDelSch&&window._lastDelSch.ds===ds){
    savedScheds[ds]=window._lastDelSch.backup;
    saveSavedScheds();renderSavedList();
    toast('↩ 일정표가 복원되었습니다','s');
    if(btn)btn.closest('.toast').remove();
  }
}

function setSavedSchRange(days){
  const to=new Date();const from=new Date();from.setDate(from.getDate()-days);
  document.getElementById('savedSchFrom').value=from.toISOString().split('T')[0];
  document.getElementById('savedSchTo').value=to.toISOString().split('T')[0];
  renderSavedList();
}

function renderSavedList(){
  const el=document.getElementById('savedSchList');
  const fromVal=document.getElementById('savedSchFrom')?.value||'';
  const toVal=document.getElementById('savedSchTo')?.value||'';
  let keys=Object.keys(savedScheds).sort().reverse();
  if(fromVal)keys=keys.filter(k=>k>=fromVal);
  if(toVal)keys=keys.filter(k=>k<=toVal);
  const totalKeys=Object.keys(savedScheds).length;
  if(!totalKeys){el.innerHTML='<div style="text-align:center;color:#aaa;padding:16px;font-size:15px;">저장된 일정표가 없습니다. 일정 생성 후 💾저장 버튼을 눌러주세요.</div>';return;}
  if(!keys.length){el.innerHTML='<div style="text-align:center;color:#aaa;padding:16px;font-size:15px;">해당 기간에 저장된 일정표가 없습니다. (전체 '+totalKeys+'건)</div>';return;}
  let h='<div style="font-size:14px;color:#666;margin-bottom:10px;font-weight:600;">조회결과: <strong>'+keys.length+'</strong>건'+(fromVal||toVal?' (전체 '+totalKeys+'건)':'')+'</div>';
  h+=keys.map(ds=>{
    const s=savedScheds[ds];
    const bksList=s.bks||[];
    const teamCount=bksList.length;
    const pplCount=bksList.reduce((sum,b)=>sum+(b.students||0)+(b.teachers||0),0);
    const d=new Date(ds);const dayNames=['일','월','화','수','목','금','토'];
    const dayColor=['#f44336','#333','#333','#333','#333','#333','#2196F3'][d.getDay()];

    // Detail: each team info
    let teamCards='';
    let actBadges='';
    if(bksList.length){
      bksList.forEach((b,bi)=>{
        const ci=bi%8;
        const colors=['#1565C0','#AD1457','#00695C','#E65100','#6A1B9A','#2E7D32','#D84315','#283593'];
        const bgs=['#E3F2FD','#FCE4EC','#E0F2F1','#FFF3E0','#F3E5F5','#E8F5E9','#FBE9E7','#E8EAF6'];
        const ppl=(b.students||0)+(b.teachers||0);
        const timeStr=(b.arrival||'')+'~'+(b.departure||'');
        const courseLabel=(b.courseType||'기본코스').includes('단체식')?'기본+단체식':'기본';
        const mealFlag=b.meal&&b.meal!=='이용안함';
        teamCards+=`<div style="background:${bgs[ci]};border-left:4px solid ${colors[ci]};border-radius:8px;padding:6px 10px;font-size:13px;margin-bottom:2px;">
          <span style="font-weight:800;color:${colors[ci]};font-size:14px;">${b.name||'?'}</span>
          <span style="color:#333;font-weight:600;font-size:12px;margin-left:6px;">👥<b>${ppl}명</b> ⏰${timeStr} <span style="background:${courseLabel.includes('단체식')?'#E65100':'#2e7d32'};color:#fff;padding:1px 5px;border-radius:4px;font-size:10px;">${courseLabel}</span>${mealFlag?' <span style="color:#C2185B;font-weight:800;">🍽식사</span>':''}</span>
        </div>`;
      });
      if(s.sch){
        // 활동을 코스기본/단체식/체험으로 분류
        const baseActs=typeof cs!=='undefined'?cs:['박물관 관람','양떼정원','눈썰매장','키즈카페','누에쉼터','사계절 썰매','자유관람'];
        const mealActs=['점심식사','점심식사(단체식)'];
        const actCount={};
        Object.values(s.sch).forEach(slots=>{slots.forEach(sl=>{if(sl.a&&sl.a!=='-')actCount[sl.a]=(actCount[sl.a]||0)+1;});});
        
        const baseItems=[], mealItems=[], expItems=[];
        Object.entries(actCount).sort((a,b)=>b[1]-a[1]).forEach(([a,c])=>{
          if(mealActs.some(m=>a.includes(m)||a.includes('식사')))mealItems.push({name:a,cnt:c});
          else if(baseActs.includes(a))baseItems.push({name:a,cnt:c});
          else expItems.push({name:a,cnt:c});
        });

        // 코스 기본 (한줄로)
        if(baseItems.length){
          actBadges+=`<div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:3px;">
            <span style="font-size:11px;padding:3px 8px;background:#2e7d32;color:#fff;border-radius:6px;font-weight:800;">🎓 코스기본</span>
            <span style="font-size:12px;color:#555;font-weight:600;">${baseItems.map(i=>i.name+'×'+i.cnt).join(' · ')}</span>
          </div>`;
        }
        // 단체식
        if(mealItems.length){
          actBadges+=`<div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:3px;">
            <span style="font-size:11px;padding:3px 8px;background:#C2185B;color:#fff;border-radius:6px;font-weight:800;">🍽 단체식</span>
            ${mealItems.map(i=>`<span style="font-size:12px;padding:3px 8px;background:#FCE4EC;border-radius:6px;color:#AD1457;font-weight:700;border:1px solid #F48FB1;">${i.name} ×${i.cnt}</span>`).join('')}
          </div>`;
        }
        // 체험 (기본 외 추가)
        if(expItems.length){
          actBadges+=`<div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;">
            <span style="font-size:11px;padding:3px 8px;background:#6A1B9A;color:#fff;border-radius:6px;font-weight:800;">🎨 체험</span>
            ${expItems.map(i=>`<span style="font-size:12px;padding:3px 8px;background:#F3E5F5;border-radius:6px;color:#6A1B9A;font-weight:700;border:1px solid #CE93D8;">${i.name} ×${i.cnt}</span>`).join('')}
          </div>`;
        }
      }
    }

    const uid='ssi_'+ds.replace(/-/g,'');
    return `<div style="padding:10px 0;border-bottom:1px solid #f0ede6;">
      <div style="display:flex;align-items:stretch;gap:10px;">
        <div style="flex-shrink:0;">
          <div style="background:var(--p);color:#fff;border-radius:10px;padding:8px 12px;font-size:14px;font-weight:800;min-width:100px;text-align:center;height:100%;display:flex;flex-direction:column;justify-content:center;">${ds}<br><span style="font-size:12px;opacity:.8;">(${dayNames[d.getDay()]})</span><div style="font-size:13px;margin-top:3px;opacity:.9;">${teamCount}팀 / ${pplCount}명</div></div>
        </div>
        <div style="flex:1;min-width:0;position:relative;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
            <span style="font-size:13px;color:#555;font-weight:600;">저장: ${s.savedAt||'-'}</span>
            <div style="display:flex;gap:5px;flex-shrink:0;">
              <button class="btn bb bs" onclick="loadSch('${ds}')" style="font-size:12px;padding:5px 12px;">불러오기</button>
              <button class="btn bs" style="background:#fdd;color:#c00;font-size:12px;padding:5px 12px;" onclick="delSch('${ds}')">삭제</button>
            </div>
          </div>
          <div id="${uid}">
            ${teamCards?'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px;">'+teamCards+'</div>':''}
            ${actBadges?'<div style="margin-top:2px;">'+actBadges+'</div>':''}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
  el.innerHTML=h;
}

function toggleSavedDetail(uid){
  const box=document.getElementById(uid);
  const btn=document.getElementById(uid+'_btn');
  if(!box||!btn)return;
  const isOpen=box.style.maxHeight!=='42px';
  if(isOpen){
    box.style.maxHeight='42px';
    btn.innerHTML='<button onclick="toggleSavedDetail(\''+uid+'\')" style="background:none;border:none;color:#1976d2;font-size:10px;cursor:pointer;padding:0;">▼ 더보기</button>';
  } else {
    box.style.maxHeight=box.scrollHeight+'px';
    btn.innerHTML='<button onclick="toggleSavedDetail(\''+uid+'\')" style="background:none;border:none;color:#1976d2;font-size:10px;cursor:pointer;padding:0;">▲ 접기</button>';
  }
}

// ===== CHAT SYSTEM =====
let chatData=JSON.parse(localStorage.getItem(FP+'chats')||'{}');
let chatFaq=JSON.parse(localStorage.getItem(FP+'chatfaq')||'null');
// ===== FAQ SCHEMA v2 =====
const FAQ_SCHEMA_VER=2;
const FAQ_POLICY={
  maxMediaPerItem:5,
  maxImgBytes:1.5*1024*1024,
  maxImgB64Chars:2*1024*1024,
  allowedImgMime:['image/jpeg','image/png','image/gif','image/webp'],
  allowedImgExt:['.jpg','.jpeg','.png','.gif','.webp'],
  maxVideoUrlLen:500,
  ytPatterns:[/youtube\.com\/watch\?v=([^&\s?\/]+)/,/youtu\.be\/([^&\s?\/]+)/,/youtube\.com\/shorts\/([^&\s?\/]+)/,/youtube\.com\/embed\/([^&\s?\/]+)/],
  maxTitleLen:50,maxContentLen:2000
};
// ===== 안내 문구 (관리자 8개 + 고객 5개) =====
const FAQ_MSG={
  // 관리자용 8개
  A_SIZE_OVER:(name,mb)=>`📁 "${name}" ${mb}MB → 1.5MB 이하만 가능합니다`,
  A_FORMAT_BAD:(name,type)=>`🚫 "${name}" ${type||'알 수 없는'} 형식 → jpg/png/gif/webp만 가능`,
  A_MEDIA_FULL:(max)=>`📎 미디어 ${max}개 한도 도달 — 기존 항목을 삭제 후 추가하세요`,
  A_MEDIA_PARTIAL:(used,skipped)=>`⚠️ ${used}개 추가, ${skipped}개 제외 (한도 초과)`,
  A_YT_INVALID:'🔗 YouTube 링크만 가능합니다 (youtube.com 또는 youtu.be)',
  A_YT_EMPTY:'🔗 YouTube URL을 입력해주세요',
  A_STORAGE_FULL:'💾 저장 공간 부족 — 사진을 줄이거나 삭제해주세요',
  A_DELETE_CONFIRM:(type,name)=>`🗑️ "${name}" ${type} 삭제됨`,
  // 고객용 5개
  C_IMG_FAIL:'📷 이미지를 불러올 수 없습니다. 다시 시도해주세요.',
  C_VID_EXTERNAL:'▶ 터치하면 YouTube 앱에서 재생됩니다',
  C_VID_FAIL:'🎬 영상을 불러올 수 없습니다.',
  C_LOADING:'⏳ 미디어를 불러오는 중...',
  C_NO_MEDIA:'첨부된 미디어가 없습니다'
};
function migrateFaq(arr){
  if(!arr||!Array.isArray(arr))return arr;
  return arr.map(f=>{
    if(!f.media)f.media=[];
    if(!f.icon)f.icon='📌';
    if(!f.title)f.title='';
    if(typeof f.content!=='string')f.content=String(f.content||'');
    f.media=f.media.filter(m=>m&&(m.type==='image'||m.type==='video')).map(m=>{
      if(!m.id)m.id='m'+Date.now()+Math.random().toString(36).slice(2,6);
      if(m.type==='image'){
        if(!m.mime)m.mime=detectMimeFromB64(m.data);
        if(!m.size)m.size=m.data?Math.round(m.data.length*0.75):0;
        if(!m.name)m.name='image_'+m.id;
      }
      if(m.type==='video'){
        if(!m.thumb)m.thumb=extractYtThumb(m.url||m.originalUrl||'');
        if(!m.originalUrl&&m.url)m.originalUrl=m.url;
      }
      return m;
    });
    return f;
  });
}
function detectMimeFromB64(d){if(!d)return'image/jpeg';const m=d.match(/^data:(image\/[a-z+]+);/);return m?m[1]:'image/jpeg';}
function extractYtThumb(url){if(!url)return '';for(const p of FAQ_POLICY.ytPatterns){const m=url.match(p);if(m)return 'https://img.youtube.com/vi/'+m[1]+'/mqdefault.jpg';}return '';}
function extractYtId(url){if(!url)return '';for(const p of FAQ_POLICY.ytPatterns){const m=url.match(p);if(m)return m[1];}return '';}
function validateFaqItem(item){
  const e=[];if(!item)return['항목이 비어있습니다'];
  if(!item.title?.trim())e.push('제목이 비어있습니다');
  if(item.title&&item.title.length>FAQ_POLICY.maxTitleLen)e.push('제목 '+FAQ_POLICY.maxTitleLen+'자 초과');
  if(item.content&&item.content.length>FAQ_POLICY.maxContentLen)e.push('내용 '+FAQ_POLICY.maxContentLen+'자 초과');
  if(item.media&&item.media.length>FAQ_POLICY.maxMediaPerItem)e.push('미디어 '+FAQ_POLICY.maxMediaPerItem+'개 초과');
  if(item.media)item.media.forEach((m,i)=>{validateMedia(m).forEach(err=>e.push('미디어'+(i+1)+': '+err));});
  return e;
}
function validateMedia(m){
  const e=[];if(!m||!m.type)return['타입 없음'];
  if(m.type==='image'){
    if(!m.data)e.push('이미지 데이터 없음');
    if(m.mime&&!FAQ_POLICY.allowedImgMime.includes(m.mime))e.push(m.mime+' 미지원');
    if(m.size&&m.size>FAQ_POLICY.maxImgBytes)e.push((m.size/1024/1024).toFixed(1)+'MB — 1.5MB 초과');
  } else if(m.type==='video'){
    if(!m.url&&!m.originalUrl)e.push('영상 URL 없음');
    const url=m.originalUrl||m.url||'';
    if(url&&!extractYtId(url))e.push('YouTube URL이 아닙니다');
  } else { e.push('알 수 없는 타입: '+m.type); }
  return e;
}
function validateFileBeforeUpload(file){
  const e=[];if(!file)return['파일 없음'];
  if(file.size>FAQ_POLICY.maxImgBytes)e.push(FAQ_MSG.A_SIZE_OVER(file.name,(file.size/1024/1024).toFixed(1)));
  if(!FAQ_POLICY.allowedImgMime.includes(file.type))e.push(FAQ_MSG.A_FORMAT_BAD(file.name,file.type));
  return e;
}
function validateYoutubeUrl(url){
  if(!url?.trim())return FAQ_MSG.A_YT_EMPTY;
  if(!extractYtId(url.trim()))return FAQ_MSG.A_YT_INVALID;
  return null;
}
function getFaqStorageSize(){try{const d=localStorage.getItem(FP+'chatfaq')||'';return{bytes:d.length*2,kb:Math.round(d.length*2/1024),mb:(d.length*2/1024/1024).toFixed(2)};}catch(e){return{bytes:0,kb:0,mb:'0'};}}
// ===== INIT =====
if(!chatFaq){
  chatFaq=[
    {icon:'🕐',title:'운영시간',content:'평일: 10:00 ~ 17:00\n주말/공휴일: 10:00 ~ 18:00\n\n※ 입장마감: 폐장 1시간 전\n※ 매주 월요일 휴관',media:[]},
    {icon:'💰',title:'이용요금',content:'유아(24개월~7세): 15,000원\n초등학생: 12,000원\n인솔교사: 무료\n\n※ 단체(20인 이상) 할인 별도 문의',media:[]},
    {icon:'🍽️',title:'단체식사',content:'오디돈가스: 유아 8,000원 / 초등 10,000원\n\n※ 단체식 예약은 방문 3일 전까지\n※ 알레르기/식이제한 사전 안내 필수',media:[]},
    {icon:'🎨',title:'체험프로그램',content:'박물관 관람 / 양떼정원 / 키즈카페\n눈썰매장 / 누에쉼터 / 사계절 썰매\n\n※ 계절별 프로그램 상이\n※ 우천 시 실내 프로그램 대체',media:[]},
    {icon:'🚌',title:'오시는 길',content:'주소: 충청북도 청주시 흥덕구\n\n🚗 자가용: 네비게이션 "잠사박물관"\n🚌 대중교통: 청주터미널에서 xxx번 버스',media:[]},
    {icon:'📋',title:'예약방법',content:'1. 홈페이지에서 예약신청서 작성\n2. 관리자 확인 후 확정 안내\n3. 방문 당일 현장 접수\n\n※ 예약 취소: 방문 3일 전까지',media:[]}
  ];
  localStorage.setItem(FP+'chatfaq',JSON.stringify(chatFaq));
} else {
  chatFaq=migrateFaq(chatFaq);
  localStorage.setItem(FP+'chatfaq',JSON.stringify(chatFaq));
}
function saveChatFaq(){try{localStorage.setItem(FP+'chatfaq',JSON.stringify(chatFaq));}catch(e){toast(FAQ_MSG.A_STORAGE_FULL,'e');}}
function getChatFaq(){return chatFaq||[];}
let chatTab='all';
let chatSel=null;
function saveChatData(){localStorage.setItem(FP+'chats',JSON.stringify(chatData));}

function initChatFromBookings(){
  // Auto-create chat rooms from bookings
  bks.forEach(b=>{
    const key='bk_'+b.id;
    if(!chatData[key]){
      chatData[key]={
        id:key, name:b.name, phone:b.phone||'', date:b.date,
        status:'active', starred:false, blocked:false,
        unread:0, lastMsg:'예약이 등록되었습니다.',
        lastTime:b.created||td(),
        msgs:[{from:'system',text:`${b.name} 예약이 등록되었습니다. (${b.date}, ${b.students+b.teachers}명)`,time:b.created||td(),ts:Date.now()-Math.random()*86400000}]
      };
    }
  });
  saveChatData();
}

function switchChatTab(tab,el){
  chatTab=tab;
  document.querySelectorAll('.chatTab').forEach(t=>{t.style.borderBottom='2px solid transparent';t.style.color='#888';t.classList.remove('chatTabAct');});
  if(el){el.style.borderBottom='2px solid var(--p)';el.style.color='var(--p)';el.classList.add('chatTabAct');}
  if(tab==='faq'){renderFaqMgmt();return;}
  renderChatList();
}

function renderFaqMgmt(){
  const panel=document.getElementById('chatListPanel');
  const msgPanel=document.getElementById('chatMsgPanel');
  msgPanel.style.display='none';
  panel.style.width='100%';panel.style.maxWidth='100%';

  const MAX_MEDIA=FAQ_POLICY.maxMediaPerItem;
  const storInfo=getFaqStorageSize();

  let h=`<div style="padding:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="font-size:16px;font-weight:800;color:var(--p);margin:0;">📋 자주 묻는 질문 관리</h3>
      <button onclick="addFaqItem()" style="padding:6px 16px;background:var(--p);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">➕ 항목 추가</button>
    </div>
    <div style="padding:8px 12px;background:#fff8e1;border-radius:8px;border:1px solid #ffe082;margin-bottom:12px;font-size:10px;color:#f57f17;line-height:1.6;">
      📎 미디어 제한: 사진 1.5MB 이하 (jpg/png/gif/webp) · 영상 YouTube URL만 · 항목당 최대 ${MAX_MEDIA}개 &nbsp;|&nbsp; 💾 저장용량: ${storInfo.kb}KB
    </div>`;

  chatFaq.forEach((f,i)=>{
    const mediaCnt=(f.media||[]).length;
    const imgCnt=(f.media||[]).filter(m=>m.type==='image').length;
    const vidCnt=(f.media||[]).filter(m=>m.type==='video').length;

    h+=`<div style="border:1px solid #e0e0e0;border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#f9f9f9;border-bottom:1px solid #eee;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:10px;color:#aaa;cursor:grab;">☰</span>
          <input type="text" value="${f.icon||'📌'}" style="width:30px;text-align:center;border:1px solid #ddd;border-radius:4px;padding:2px;font-size:14px;" onchange="chatFaq[${i}].icon=this.value;saveChatFaq();">
          <input type="text" value="${f.title}" placeholder="제목" style="font-size:13px;font-weight:700;border:1px solid #ddd;border-radius:6px;padding:4px 8px;width:200px;" onchange="chatFaq[${i}].title=this.value;saveChatFaq();">
          ${mediaCnt>0?`<span style="font-size:9px;padding:2px 6px;background:#e3f2fd;color:#1565c0;border-radius:4px;">📎${imgCnt>0?'📷'+imgCnt:''}${vidCnt>0?' 🎬'+vidCnt:''}</span>`:''}
        </div>
        <div style="display:flex;gap:4px;">
          ${i>0?`<button onclick="moveFaq(${i},-1)" style="border:none;background:#f0f0f0;border-radius:4px;cursor:pointer;padding:2px 8px;font-size:11px;">▲</button>`:''}
          ${i<chatFaq.length-1?`<button onclick="moveFaq(${i},1)" style="border:none;background:#f0f0f0;border-radius:4px;cursor:pointer;padding:2px 8px;font-size:11px;">▼</button>`:''}
          <button onclick="removeFaq(${i})" style="border:none;background:#ffebee;color:#c00;border-radius:4px;cursor:pointer;padding:2px 8px;font-size:11px;">삭제</button>
        </div>
      </div>
      <div style="padding:10px 14px;">
        <textarea onchange="chatFaq[${i}].content=this.value;saveChatFaq();" style="width:100%;min-height:80px;border:1px solid #ddd;border-radius:8px;padding:8px;font-size:12px;line-height:1.6;resize:vertical;">${f.content}</textarea>
        
        <div style="margin-top:10px;padding:10px;background:#fafafa;border-radius:8px;border:1px solid #eee;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-size:11px;font-weight:700;color:#555;">📎 첨부 미디어 (${mediaCnt}/${MAX_MEDIA})</span>
            <div style="display:flex;gap:4px;">
              <button onclick="addFaqMedia(${i})" ${mediaCnt>=MAX_MEDIA?'disabled style="padding:4px 10px;background:#eee;color:#aaa;border:1px solid #ddd;border-radius:6px;font-size:10px;cursor:not-allowed;"':'style="padding:4px 10px;background:#e3f2fd;color:#1565c0;border:1px solid #90caf9;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;"'}>📷 사진</button>
              <button onclick="addFaqMediaUrl(${i})" ${mediaCnt>=MAX_MEDIA?'disabled style="padding:4px 10px;background:#eee;color:#aaa;border:1px solid #ddd;border-radius:6px;font-size:10px;cursor:not-allowed;"':'style="padding:4px 10px;background:#fce4ec;color:#c2185b;border:1px solid #f48fb1;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;"'}>🎬 영상URL</button>
            </div>
          </div>
          ${mediaCnt?`<div style="display:flex;flex-wrap:wrap;gap:8px;" id="faqMedia${i}">
            ${(f.media||[]).map((m,mi)=>{
              const moveBtns=`<div style="position:absolute;top:3px;left:3px;display:flex;gap:1px;">
                ${mi>0?`<button onclick="event.stopPropagation();moveFaqMedia(${i},${mi},-1)" style="width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;border:none;font-size:9px;cursor:pointer;" title="앞으로">◀</button>`:''}
                ${mi<(f.media.length-1)?`<button onclick="event.stopPropagation();moveFaqMedia(${i},${mi},1)" style="width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;border:none;font-size:9px;cursor:pointer;" title="뒤로">▶</button>`:''}
              </div>`;
              const actionBtns=`<div style="position:absolute;top:3px;right:3px;display:flex;gap:2px;">
                <button onclick="event.stopPropagation();replaceFaqMedia(${i},${mi})" style="width:20px;height:20px;border-radius:50%;background:rgba(25,118,210,.85);color:#fff;border:none;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="교체">🔄</button>
                <button onclick="event.stopPropagation();removeFaqMedia(${i},${mi})" style="width:20px;height:20px;border-radius:50%;background:rgba(200,0,0,.85);color:#fff;border:none;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="삭제">✕</button>
              </div>`;
              if(m.type==='image'){
                const sizeKB=m.size?Math.round(m.size/1024):0;
                return `<div style="position:relative;width:100px;height:100px;border:1.5px solid #e0e0e0;border-radius:10px;overflow:hidden;background:#f5f5f5;">
                  <img src="${m.data}" style="width:100%;height:100%;object-fit:cover;">
                  <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.55);padding:2px 4px;font-size:8px;color:#fff;text-align:center;">${m.name||''} · ${sizeKB}KB</div>
                  ${moveBtns}${actionBtns}
                </div>`;
              } else {
                const thumb=m.thumb||extractYtThumb(m.url||m.originalUrl||'');
                return `<div style="position:relative;width:160px;border:1.5px solid #e0e0e0;border-radius:10px;overflow:hidden;background:#000;">
                  ${thumb?`<img src="${thumb}" style="width:100%;height:90px;object-fit:cover;">`:`<div style="height:90px;display:flex;align-items:center;justify-content:center;color:#888;font-size:24px;">🎬</div>`}
                  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;background:rgba(255,0,0,.8);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                    <div style="width:0;height:0;border-left:12px solid #fff;border-top:7px solid transparent;border-bottom:7px solid transparent;margin-left:2px;"></div>
                  </div>
                  <div style="padding:3px 6px;background:#111;font-size:8px;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${m.originalUrl||m.url||''}</div>
                  ${moveBtns}${actionBtns}
                </div>`;
              }
            }).join('')}
          </div>`:`<div style="text-align:center;padding:12px;color:#ccc;font-size:11px;">${FAQ_MSG.C_NO_MEDIA}</div>`}
        </div>
      </div>
    </div>`;
  });

  if(!chatFaq.length){
    h+=`<div style="text-align:center;padding:40px;color:#aaa;">
      <div style="font-size:36px;margin-bottom:8px;">📋</div>
      <p style="font-size:13px;">등록된 항목이 없습니다. 항목을 추가해주세요.</p>
    </div>`;
  }

  // Preview section
  h+=`<div style="margin-top:16px;padding:14px;background:#f0f8e8;border-radius:10px;border:1px solid #c8e6c9;">
    <div style="font-size:12px;font-weight:700;color:var(--p);margin-bottom:6px;">📱 고객 화면 미리보기</div>
    <div style="margin-top:8px;background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;max-width:360px;">
      ${chatFaq.map(f=>{
        const mc=(f.media||[]).length;
        return `<div style="padding:8px 12px;border:1px solid #f0f0f0;border-radius:8px;margin-bottom:4px;font-size:12px;font-weight:600;color:#333;">
          ${f.icon||'📌'} ${f.title}${mc?' <span style="font-size:9px;color:#1976d2;font-weight:400;">📎'+mc+'</span>':''}
        </div>`;
      }).join('')}
    </div>
  </div>`;

  h+='</div>';
  panel.innerHTML=h;
}

function addFaqItem(){
  chatFaq.push({icon:'📌',title:'새 항목',content:'내용을 입력하세요.',media:[]});
  saveChatFaq();renderFaqMgmt();toast('➕ 항목 추가됨','s');
  addLog('FAQ수정','FAQ 항목 추가: "새 항목"');
}

function addFaqMedia(i){
  const P=FAQ_POLICY;
  if((chatFaq[i].media||[]).length>=P.maxMediaPerItem){toast(FAQ_MSG.A_MEDIA_FULL(P.maxMediaPerItem),'e');return;}
  const inp=document.createElement('input');
  inp.type='file';inp.accept=P.allowedImgMime.join(',');inp.multiple=true;
  inp.onchange=function(){
    const files=[...this.files];
    let added=0,skipped=0;
    if(!chatFaq[i].media)chatFaq[i].media=[];
    const remain=P.maxMediaPerItem-chatFaq[i].media.length;
    files.slice(0,remain).forEach(file=>{
      const errs=validateFileBeforeUpload(file);
      if(errs.length){errs.forEach(e=>toast('⚠️ '+e,'e'));skipped++;return;}
      const reader=new FileReader();
      reader.onload=function(e){
        chatFaq[i].media.push({
          type:'image',data:e.target.result,mime:file.type,
          id:'m'+Date.now()+Math.random().toString(36).slice(2,6),
          size:file.size,name:file.name
        });
        added++;
        if(added+skipped>=Math.min(files.length,remain)){
          saveChatFaq();renderFaqMgmt();
          if(added){
            toast(`📷 사진 ${added}장 추가됨`,'s');
            addLog('FAQ수정',`"${chatFaq[i].title}" 사진 ${added}장 추가`);
          }
        }
      };
      reader.readAsDataURL(file);
    });
    if(files.length>remain)toast(FAQ_MSG.A_MEDIA_PARTIAL(remain,files.length-remain),'e');
  };
  inp.click();
}

function addFaqMediaUrl(i){
  if((chatFaq[i].media||[]).length>=FAQ_POLICY.maxMediaPerItem){toast(FAQ_MSG.A_MEDIA_FULL(FAQ_POLICY.maxMediaPerItem),'e');return;}
  const el=document.getElementById('faqMedia'+i);
  if(!el)return;
  if(document.getElementById('faqVideoInput'+i))return;
  const div=document.createElement('div');
  div.id='faqVideoInput'+i;
  div.style.cssText='width:100%;margin-top:8px;';
  div.innerHTML=`<div style="padding:10px;background:#fff;border:1.5px solid #f48fb1;border-radius:8px;">
    <div style="font-size:10px;color:#c2185b;font-weight:700;margin-bottom:4px;">🎬 YouTube 영상 URL 입력</div>
    <div style="display:flex;gap:4px;">
      <input type="text" id="faqVideoUrl${i}" placeholder="https://youtube.com/..." style="flex:1;padding:6px 8px;border:1px solid #ddd;border-radius:6px;font-size:11px;">
      <button onclick="saveFaqVideoUrl(${i})" style="padding:6px 12px;background:#c2185b;color:#fff;border:none;border-radius:6px;font-size:10px;cursor:pointer;white-space:nowrap;font-weight:700;">추가</button>
      <button onclick="document.getElementById('faqVideoInput${i}').remove()" style="padding:6px 8px;background:#eee;border:none;border-radius:6px;font-size:10px;cursor:pointer;">취소</button>
    </div>
    <div style="font-size:9px;color:#999;margin-top:4px;">youtube.com/watch?v=... 또는 youtu.be/... 또는 youtube.com/shorts/...</div>
  </div>`;
  el.parentNode.appendChild(div);
}

function saveFaqVideoUrl(i){
  const inp=document.getElementById('faqVideoUrl'+i);
  const url=(inp?.value||'').trim();
  const err=validateYoutubeUrl(url);
  if(err){toast('⚠️ '+err,'e');return;}
  const ytId=extractYtId(url);
  if(!chatFaq[i].media)chatFaq[i].media=[];
  chatFaq[i].media.push({
    type:'video',url:'https://www.youtube.com/embed/'+ytId,
    originalUrl:url,thumb:'https://img.youtube.com/vi/'+ytId+'/mqdefault.jpg',
    id:'m'+Date.now()+Math.random().toString(36).slice(2,6)
  });
  saveChatFaq();renderFaqMgmt();
  toast('🎬 영상 추가됨','s');
  addLog('FAQ수정',`"${chatFaq[i].title}" YouTube 영상 추가`);
}

function removeFaqMedia(i,mi){
  if(!chatFaq[i]?.media)return;
  const m=chatFaq[i].media[mi];
  const typeLabel=m.type==='image'?'사진':'영상';
  const nameLabel=m.type==='image'?(m.name||''):'YouTube';
  chatFaq[i].media.splice(mi,1);
  saveChatFaq();renderFaqMgmt();
  toast(FAQ_MSG.A_DELETE_CONFIRM(typeLabel,nameLabel),'s');
  addLog('FAQ수정',`"${chatFaq[i].title}" ${typeLabel}(${nameLabel}) 삭제`);
}

function replaceFaqMedia(i,mi){
  const m=chatFaq[i]?.media?.[mi];
  if(!m)return;
  if(m.type==='image'){
    const inp=document.createElement('input');
    inp.type='file';inp.accept=FAQ_POLICY.allowedImgMime.join(',');
    inp.onchange=function(){
      const file=this.files[0];if(!file)return;
      const errs=validateFileBeforeUpload(file);
      if(errs.length){errs.forEach(e=>toast('⚠️ '+e,'e'));return;}
      const reader=new FileReader();
      reader.onload=function(e){
        chatFaq[i].media[mi]={
          ...chatFaq[i].media[mi],
          data:e.target.result,mime:file.type,
          size:file.size,name:file.name
        };
        saveChatFaq();renderFaqMgmt();
        toast('🔄 사진 교체됨','s');
        addLog('FAQ수정',`"${chatFaq[i].title}" 사진 교체 → ${file.name}`);
      };
      reader.readAsDataURL(file);
    };
    inp.click();
  } else {
    // For video, show URL input inline
    const old=chatFaq[i].media[mi].originalUrl||'';
    const newUrl=prompt('새 YouTube URL:',old);
    if(!newUrl)return;
    const err=validateYoutubeUrl(newUrl);
    if(err){toast('⚠️ '+err,'e');return;}
    const ytId=extractYtId(newUrl);
    chatFaq[i].media[mi].url='https://www.youtube.com/embed/'+ytId;
    chatFaq[i].media[mi].originalUrl=newUrl;
    chatFaq[i].media[mi].thumb='https://img.youtube.com/vi/'+ytId+'/mqdefault.jpg';
    saveChatFaq();renderFaqMgmt();
    toast('🔄 영상 교체됨','s');
    addLog('FAQ수정',`"${chatFaq[i].title}" 영상 URL 교체`);
  }
}

function moveFaqMedia(i,mi,dir){
  const arr=chatFaq[i]?.media;if(!arr)return;
  const j=mi+dir;
  if(j<0||j>=arr.length)return;
  [arr[mi],arr[j]]=[arr[j],arr[mi]];
  saveChatFaq();renderFaqMgmt();
}

function removeFaq(i){
  const title=chatFaq[i]?.title||'';
  chatFaq.splice(i,1);saveChatFaq();renderFaqMgmt();
  toast('🗑️ 삭제됨','s');
  addLog('FAQ수정',`FAQ 항목 삭제: "${title}"`);
}
function moveFaq(i,dir){
  const j=i+dir;if(j<0||j>=chatFaq.length)return;
  [chatFaq[i],chatFaq[j]]=[chatFaq[j],chatFaq[i]];
  saveChatFaq();renderFaqMgmt();
}

function dashQuickReply(idx){
  const inp=document.getElementById('dashReply_'+idx);
  if(!inp)return;
  const rid=inp.dataset.rid;
  const txt=inp.value.trim();
  if(!txt){toast('메시지를 입력하세요','e');return;}
  const r=chatData[rid];
  if(!r)return;
  r.msgs.push({from:'admin',sender:curAdmin?.name||'관리자',text:txt,ts:Date.now()});
  r.unread=0;
  saveChatData();
  inp.value='';
  toast('✅ 답변 전송 완료: '+r.name,'s');
  // Re-render dashboard to update the list
  rDash();
}
function getChatAiSummary(r){
  const msgs=(r.msgs||[]).filter(m=>m.from!=='system');
  if(!msgs.length) return '';
  const bk=bks.find(b=>'bk_'+b.id===r.id);
  const custMsgs=msgs.filter(m=>m.from==='customer');
  const admMsgs=msgs.filter(m=>m.from==='admin');
  let points=[];
  // Check for keywords in messages
  const allText=msgs.map(m=>m.text).join(' ');
  if(/취소|취소요|취소하고/.test(allText)) points.push('취소 문의');
  if(/변경|날짜.*변경|시간.*변경|인원.*변경/.test(allText)) points.push('변경 요청');
  if(/알레르기|알러지|식이/.test(allText)) points.push('알레르기 주의');
  if(/주차|버스/.test(allText)) points.push('주차/버스 문의');
  if(/견적|비용|가격|결제|입금/.test(allText)) points.push('비용 문의');
  if(/감사|고마|좋아요/.test(allText)) points.push('긍정적 반응');
  if(/불만|화나|안되|왜/.test(allText)&&custMsgs.length>0) points.push('불만 가능성');
  // Response status
  const lastMsg=msgs[msgs.length-1];
  if(lastMsg.from==='customer') points.push('⚡답변 필요');
  else if(lastMsg.from==='admin') points.push('답변 완료');
  // Booking info
  if(bk){
    if(bk.status==='대기') points.push('예약 미확정');
    const daysDiff=Math.ceil((new Date(bk.date)-new Date())/(1000*60*60*24));
    if(daysDiff>=0&&daysDiff<=3) points.push('방문 '+daysDiff+'일 전');
  }
  // Conversation volume
  if(msgs.length>=10) points.push('대화 '+msgs.length+'건');
  return points.slice(0,3).join(' · ');
}
function renderChatList(){
  // Restore panel widths when switching from FAQ
  const panel=document.getElementById('chatListPanel');
  const msgPanel=document.getElementById('chatMsgPanel');
  panel.style.width='360px';panel.style.maxWidth='360px';
  msgPanel.style.display='flex';

  initChatFromBookings();
  const filter=document.getElementById('chatFilter')?.value||'all';
  const search=(document.getElementById('chatSearch')?.value||'').toLowerCase();
  let rooms=Object.values(chatData);

  // Tab filter
  if(chatTab==='star')rooms=rooms.filter(r=>r.starred);
  if(chatTab==='block')rooms=rooms.filter(r=>r.blocked);
  if(chatTab==='all')rooms=rooms.filter(r=>!r.blocked);

  // Status filter
  if(filter==='active')rooms=rooms.filter(r=>r.status==='active');
  if(filter==='waiting')rooms=rooms.filter(r=>r.unread>0);
  if(filter==='done')rooms=rooms.filter(r=>r.status==='done');

  // Search
  if(search)rooms=rooms.filter(r=>r.name.toLowerCase().includes(search)||(r.phone||'').includes(search));

  // Sort by last message time
  rooms.sort((a,b)=>{
    const at=a.msgs?.length?a.msgs[a.msgs.length-1].ts:0;
    const bt=b.msgs?.length?b.msgs[b.msgs.length-1].ts:0;
    return bt-at;
  });

  if(!rooms.length){panel.innerHTML='<div style="text-align:center;padding:40px;color:#aaa;font-size:12px;">채팅이 없습니다.</div>';return;}

  const colors=['#1976d2','#c2185b','#00796b','#e65100','#6a1b9a','#2e7d32','#d84315','#283593','#00838f','#4e342e'];

  panel.innerHTML=rooms.map((r,i)=>{
    const c=colors[i%colors.length];
    const initial=r.name.charAt(0);
    const lastMsg=r.msgs?.length?r.msgs[r.msgs.length-1]:null;
    const timeStr=lastMsg?formatChatTime(lastMsg.ts):'';
    const msgPreview=lastMsg?(lastMsg.text.length>30?lastMsg.text.slice(0,30)+'...':lastMsg.text):'';
    const isActive=chatSel===r.id;
    const bk=bks.find(b=>'bk_'+b.id===r.id);
    const statusBadge=bk?`<span style="font-size:8px;padding:1px 4px;border-radius:3px;background:${bk.status==='확정'?'#e8f5e9':bk.status==='대기'?'#fff8e1':'#ffebee'};color:${bk.status==='확정'?'#2e7d32':bk.status==='대기'?'#f57f17':'#c62828'};">${bk.status}</span>`:'';

    const aiSummary=getChatAiSummary(r);
    return `<div onclick="openChat('${r.id}')" style="display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;border-bottom:1px solid #f0f0f0;background:${isActive?'#e8f5e9':'#fff'};transition:background .15s;" onmouseover="this.style.background='${isActive?'#e8f5e9':'#f5f5f5'}'" onmouseout="this.style.background='${isActive?'#e8f5e9':'#fff'}'">
      <div style="position:relative;flex-shrink:0;">
        ${r.starred?'<span style="position:absolute;top:-4px;left:-4px;font-size:12px;">⭐</span>':''}
        <div style="width:44px;height:44px;border-radius:50%;background:${c};color:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;">${initial}</div>
      </div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:12px;font-weight:700;color:#333;">${r.name} ${r.unread>0?`<span style="background:#f44336;color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;margin-left:2px;">${r.unread}</span>`:''}${statusBadge?' '+statusBadge:''}</span>
          <span style="font-size:9px;color:#aaa;">${timeStr}</span>
        </div>
        <div style="font-size:11px;color:#888;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${msgPreview}</div>
        ${aiSummary?`<div style="font-size:9px;color:#1565c0;margin-top:3px;padding:2px 6px;background:#e3f2fd;border-radius:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">🤖 ${aiSummary}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function formatChatTime(ts){
  if(!ts)return'';
  const d=new Date(ts),now=new Date();
  const diff=now-d;
  if(diff<60000)return'방금';
  if(diff<3600000)return Math.floor(diff/60000)+'분 전';
  if(d.toDateString()===now.toDateString()){
    return d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  }
  const yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);
  if(d.toDateString()===yesterday.toDateString())return'어제';
  return `${d.getMonth()+1}월 ${d.getDate()}일`;
}

function openChat(rid){
  chatSel=rid;
  const r=chatData[rid];if(!r)return;
  r.unread=0;saveChatData();
  renderChatList();

  const bk=bks.find(b=>'bk_'+b.id===rid);

  // Header
  document.getElementById('chatMsgEmpty').style.display='none';
  const hdr=document.getElementById('chatMsgHeader');
  hdr.style.display='block';
  const bkId=bk?bk.id:'';
  const statusBdg=bk?`<span style="font-size:9px;padding:1px 6px;border-radius:3px;background:${bk.status==='확정'?'#e8f5e9':bk.status==='대기'?'#fff8e1':'#ffebee'};color:${bk.status==='확정'?'#2e7d32':bk.status==='대기'?'#f57f17':'#c62828'};font-weight:700;margin-left:4px;">${bk.status}</span>`:'';
  hdr.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;">
    <div id="chatHdrInfo" style="display:flex;align-items:center;gap:8px;cursor:${bk?'pointer':'default'};padding:4px 8px;border-radius:8px;transition:background .15s;position:relative;" ${bk?`onclick="gotoBkFromChat(${bkId})" onmouseenter="this.style.background='#e8f5e9';showChatBkTip(event,${bkId})" onmouseleave="this.style.background='transparent';hideChatBkTip()"`:''}>
      <div style="width:36px;height:36px;border-radius:50%;background:#78909c;color:#fff;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;">${r.name.charAt(0)}</div>
      <div>
        <div><span style="font-size:15px;font-weight:800;color:#333;">${r.name}</span> <span style="font-size:11px;color:#666;margin-left:4px;">${r.phone||''}</span>${statusBdg}</div>
        ${bk?`<div style="font-size:11px;color:#888;">📅 ${bk.date} &nbsp;👥 ${bk.students+bk.teachers}명 &nbsp;🎫 ${bk.courseType||''} <span style="font-size:9px;color:#1976d2;margin-left:4px;">🔗 상세보기 →</span></div>`:''}
      </div>
    </div>
    <div style="display:flex;gap:6px;">
      <button onclick="toggleChatStar('${rid}')" style="border:none;background:none;cursor:pointer;font-size:18px;padding:2px;">${r.starred?'⭐':'☆'}</button>
      <button onclick="toggleChatBlock('${rid}')" style="border:none;background:${r.blocked?'#ffebee':'#f5f5f5'};border-radius:6px;cursor:pointer;font-size:11px;padding:4px 10px;font-weight:600;">${r.blocked?'🚫차단해제':'🚫 차단'}</button>
      <button onclick="markChatDone('${rid}')" style="border:none;background:#e8f5e9;border-radius:6px;cursor:pointer;font-size:11px;padding:4px 10px;color:#2e7d32;font-weight:700;">✅ 완료</button>
    </div>
  </div>
  ${bk&&bk.etc?`<div style="margin-top:6px;padding:6px 10px;background:#FFFDE7;border-radius:6px;font-size:11px;color:#F57F17;border-left:3px solid #FFB300;">📝 ${bk.etc}</div>`:''}
  ${(()=>{const aiS=getChatAiSummary(r);return aiS?`<div style="margin-top:6px;padding:6px 10px;background:#e3f2fd;border-radius:6px;font-size:11px;color:#1565c0;border-left:3px solid #2196F3;">🤖 ${aiS}</div>`:''})()}`;
  // Messages
  const body=document.getElementById('chatMsgBody');
  body.style.display='block';
  let mh='';
  (r.msgs||[]).forEach((m,mi)=>{
    if(!m.id)m.id='m_'+m.ts+'_'+mi;
    const isAdmin=m.from==='admin';
    const isSys=m.from==='system';
    const isCust=m.from==='customer';
    if(m.deleted){
      mh+=`<div style="text-align:center;margin:8px 0;"><span style="color:#bbb;font-size:11px;font-style:italic;">🗑️ 삭제된 메시지</span></div>`;
      return;
    }
    const time=m.ts?new Date(m.ts).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
    const editedMark=m.editedAt?`<div class="chat-edited-mark">✏️ 수정됨 ${new Date(m.editedAt).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>`:'';
    const senderName=m.sender||(isAdmin?(curAdmin?.name||'관리자'):isCust?r.name:'');
    const admInfo=isAdmin?getAdminInfo(senderName):null;
    const admPhoto=admInfo?.photo||'';
    const admTitle=admInfo?.title||'';
    const admPhone=admInfo?.phone||'';
    const admInitial=senderName.charAt(0);
    const admColors=['#1976d2','#c2185b','#00796b','#e65100','#6a1b9a','#2e7d32'];
    const admIdx=admInfo?adminAccounts.indexOf(admInfo):0;
    const admBg=admColors[(admIdx>=0?admIdx:0)%admColors.length];
    const isMyMsg=isAdmin&&(m.sender===curAdmin?.name||(!m.sender&&isAdmin));
    const actBtns=isMyMsg?`<div class="chat-msg-actions" style="right:48px;"><button class="cma-edit" onclick="editAdminChatMsg('${rid}',${mi})">✏️수정</button><button class="cma-del" onclick="deleteAdminChatMsg('${rid}',${mi})">🗑️삭제</button></div>`:'';
    if(isSys){
      mh+=`<div style="text-align:center;margin:12px 0;"><span style="background:rgba(0,0,0,.15);color:#fff;font-size:11px;padding:4px 14px;border-radius:12px;">${m.text}</span></div>`;
    } else if(isAdmin){
      const photoHtml=admPhoto?`<img src="${admPhoto}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2);">`:`<div style="width:38px;height:38px;border-radius:50%;background:${admBg};color:#fff;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;box-shadow:0 1px 4px rgba(0,0,0,.2);">${admInitial}</div>`;
      mh+=`<div class="chat-msg-wrap" style="display:flex;justify-content:flex-end;margin:8px 0;gap:8px;align-items:flex-start;">
        ${actBtns}
        <div style="text-align:right;max-width:75%;">
          <div style="margin-bottom:4px;"><span style="background:var(--p);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">${senderName}</span>${admTitle?` <span style="background:#fff3e0;color:#e65100;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;">${admTitle}</span>`:''}${admPhone?` <span style="color:#666;font-size:10px;">📞${admPhone}</span>`:''}</div>
          <div style="display:flex;justify-content:flex-end;gap:6px;align-items:flex-end;">
            <span style="font-size:9px;color:#999;white-space:nowrap;">${time}</span>
            <div id="chatBubble_${mi}" style="background:var(--p);color:#fff;padding:10px 14px;border-radius:14px 14px 0 14px;font-size:13px;line-height:1.5;box-shadow:0 1px 3px rgba(0,0,0,.15);">${m.text}</div>
          </div>
          ${editedMark}
        </div>
        <div style="flex-shrink:0;">${photoHtml}</div>
      </div>`;
    } else {
      mh+=`<div style="display:flex;justify-content:flex-start;margin:8px 0;gap:8px;align-items:flex-start;">
        <div style="width:38px;height:38px;border-radius:50%;background:#78909c;color:#fff;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;flex-shrink:0;box-shadow:0 1px 4px rgba(0,0,0,.2);">${r.name.charAt(0)}</div>
        <div style="max-width:75%;">
          <div style="margin-bottom:4px;"><span style="background:#455a64;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">${senderName}</span> <span style="color:#555;font-size:10px;">${r.phone||''}</span></div>
          <div style="display:flex;gap:6px;align-items:flex-end;">
            <div style="background:#fff;padding:10px 14px;border-radius:14px 14px 14px 0;font-size:13px;line-height:1.5;box-shadow:0 1px 3px rgba(0,0,0,.12);">${m.text}</div>
            <span style="font-size:9px;color:#999;white-space:nowrap;">${time}</span>
          </div>
          ${editedMark}
        </div>
      </div>`;
    }
  });
  body.innerHTML=mh;
  body.scrollTop=body.scrollHeight;

  // Input
  const inp=document.getElementById('chatMsgInput');
  inp.style.display='flex';
  inp.style.gap='8px';
  inp.style.alignItems='center';
  inp.innerHTML=`<input type="text" id="chatInputText" placeholder="메시지 입력..." style="flex:1;padding:8px 12px;border:2px solid #ddd;border-radius:20px;font-size:12px;outline:none;" onkeydown="if(event.key==='Enter')sendChatMsg('${rid}')">
    <button onclick="sendChatMsg('${rid}')" style="padding:8px 16px;background:var(--p);color:#fff;border:none;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;">전송</button>`;
}

function sendChatMsg(rid){
  const inp=document.getElementById('chatInputText');
  const text=inp?.value.trim();if(!text)return;
  const r=chatData[rid];if(!r)return;
  if(!r.msgs)r.msgs=[];
  r.msgs.push({id:'m_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),from:'admin',sender:curAdmin?.name||'관리자',text,ts:Date.now()});
  r.lastMsg=text;r.lastTime=td();r.status='active';
  saveChatData();
  inp.value='';
  openChat(rid);
  addLog('채팅',`${r.name}에게 메시지 전송`);
}

function showChatBkTip(ev,bid){
  const b=bks.find(x=>x.id===bid);if(!b)return;
  let tip=document.getElementById('chatBkTip');
  if(!tip){tip=document.createElement('div');tip.id='chatBkTip';
    tip.style.cssText='position:fixed;z-index:10000;background:#fff;border:2px solid var(--p);border-radius:12px;padding:0;box-shadow:0 8px 30px rgba(0,0,0,.2);min-width:280px;max-width:340px;overflow:hidden;pointer-events:none;';
    document.body.appendChild(tip);}
  const sc=b.status==='확정'?'#2e7d32':b.status==='대기'?'#f57f17':'#c62828';
  const scBg=b.status==='확정'?'#e8f5e9':b.status==='대기'?'#fff8e1':'#ffebee';
  const q=typeof calcQuote==='function'?calcQuote(b):{grandTotal:0};
  tip.innerHTML=`
    <div style="background:var(--p);color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:14px;font-weight:800;">${b.name}</span>
      <span style="background:${scBg};color:${sc};padding:2px 10px;border-radius:4px;font-size:11px;font-weight:700;">${b.status}</span>
    </div>
    <div style="padding:12px 14px;font-size:12px;line-height:2;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;">
        <div>📅 <strong>${b.date}</strong></div>
        <div>⏰ ${b.arrival}~${b.departure}</div>
        <div>👥 아동 <strong>${b.students}명</strong></div>
        <div>👤 인솔 <strong>${b.teachers}명</strong></div>
        <div>🎫 ${b.courseType||'-'}</div>
        <div>🍚 ${b.meal||'-'}</div>
        <div>📞 ${b.phone||'-'}</div>
        <div>📢 ${b.channel||'-'}</div>
      </div>
      ${b.addons?.length?`<div style="margin-top:6px;">🎨 ${b.addons.join(', ')}</div>`:''}
      <div style="margin-top:6px;padding:5px 8px;background:#FFFDE7;border-radius:6px;border-left:3px solid #FFB300;color:#F57F17;">📝 요청사항: ${b.etc||'<span style="color:#ccc;">없음</span>'}</div>
      <div style="margin-top:8px;padding-top:6px;border-top:1px dashed #ddd;font-weight:700;color:var(--p);">💰 견적: ₩${typeof fmtWon==='function'?fmtWon(q.grandTotal):q.grandTotal}</div>
    </div>
    <div style="padding:6px 14px 10px;text-align:center;font-size:10px;color:#1976d2;">🔗 클릭하면 예약 상세로 이동합니다</div>`;
  tip.style.display='block';
  const rect=ev.currentTarget.getBoundingClientRect();
  let left=rect.left;
  let top=rect.bottom+6;
  if(top+tip.offsetHeight>window.innerHeight-10)top=rect.top-tip.offsetHeight-6;
  if(left+tip.offsetWidth>window.innerWidth-10)left=window.innerWidth-tip.offsetWidth-10;
  tip.style.left=left+'px';tip.style.top=top+'px';
}
function hideChatBkTip(){const t=document.getElementById('chatBkTip');if(t)t.style.display='none';}

function gotoBkFromChat(bid){
  hideChatBkTip();
  const b=bks.find(x=>x.id===bid);if(!b)return;
  // Navigate to calendar page with the booking date selected
  gp('ac');
  setTimeout(()=>{
    // Set calendar to booking month/date
    if(typeof sCd==='function')sCd(b.date);
    // Also open detail modal
    setTimeout(()=>showDtl(bid),300);
  },200);
}

function toggleChatStar(rid){const r=chatData[rid];if(!r)return;r.starred=!r.starred;saveChatData();openChat(rid);renderChatList();}
function toggleChatBlock(rid){const r=chatData[rid];if(!r)return;r.blocked=!r.blocked;saveChatData();openChat(rid);renderChatList();}
function markChatDone(rid){const r=chatData[rid];if(!r)return;r.status='done';r.msgs.push({from:'system',text:'상담이 완료되었습니다.',ts:Date.now()});saveChatData();openChat(rid);renderChatList();toast('✅ 상담 완료 처리','s');}

// ===== Chat Message Edit/Delete (Admin) =====
function editAdminChatMsg(rid,mi){
  const r=chatData[rid];if(!r||!r.msgs[mi])return;
  const m=r.msgs[mi];
  const bubble=document.getElementById('chatBubble_'+mi);
  if(!bubble)return;
  const origText=m.text;
  bubble.outerHTML=`<div class="chat-edit-area" id="chatEditArea_${mi}">
    <textarea id="chatEditTa_${mi}" rows="2">${origText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
    <div class="chat-edit-btns">
      <button class="ced-cancel" onclick="openChat('${rid}')">취소</button>
      <button class="ced-save" onclick="saveAdminChatMsg('${rid}',${mi})">저장</button>
    </div>
  </div>`;
  const ta=document.getElementById('chatEditTa_'+mi);
  if(ta){ta.focus();ta.setSelectionRange(ta.value.length,ta.value.length);}
}
function saveAdminChatMsg(rid,mi){
  const ta=document.getElementById('chatEditTa_'+mi);
  const newText=ta?.value.trim();if(!newText)return toast('메시지 내용을 입력하세요.','e');
  const r=chatData[rid];if(!r||!r.msgs[mi])return;
  const m=r.msgs[mi];
  if(!m.origText)m.origText=m.text;
  m.text=newText;
  m.editedAt=Date.now();
  saveChatData();
  openChat(rid);
  toast('✏️ 메시지가 수정되었습니다.','s');
  addLog('채팅',`${r.name} 대화 메시지 수정`);
}
function deleteAdminChatMsg(rid,mi){
  const r=chatData[rid];if(!r||!r.msgs[mi])return;
  if(!confirm('이 메시지를 삭제하시겠습니까?\n(삭제된 메시지로 표시됩니다)'))return;
  r.msgs[mi].deleted=true;
  r.msgs[mi].deletedAt=Date.now();
  saveChatData();
  openChat(rid);
  toast('🗑️ 메시지가 삭제되었습니다.','s');
  addLog('채팅',`${r.name} 대화 메시지 삭제`);
}

// ===== Chat Message Edit/Delete (Customer) =====
function editCustChatMsg(rid,mi){
  const r=chatData[rid];if(!r||!r.msgs[mi])return;
  const m=r.msgs[mi];
  const bubble=document.getElementById('custBubble_'+mi);
  if(!bubble)return;
  const origText=m.text;
  bubble.outerHTML=`<div class="chat-edit-area" id="custEditArea_${mi}">
    <textarea id="custEditTa_${mi}" rows="2">${origText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
    <div class="chat-edit-btns">
      <button class="ced-cancel" onclick="openCustomerChat('${rid}')">취소</button>
      <button class="ced-save" onclick="saveCustChatMsg('${rid}',${mi})">저장</button>
    </div>
  </div>`;
  const ta=document.getElementById('custEditTa_'+mi);
  if(ta){ta.focus();ta.setSelectionRange(ta.value.length,ta.value.length);}
}
function saveCustChatMsg(rid,mi){
  const ta=document.getElementById('custEditTa_'+mi);
  const newText=ta?.value.trim();if(!newText)return toast('메시지 내용을 입력하세요.','e');
  const r=chatData[rid];if(!r||!r.msgs[mi])return;
  const m=r.msgs[mi];
  if(!m.origText)m.origText=m.text;
  m.text=newText;
  m.editedAt=Date.now();
  saveChatData();
  openCustomerChat(rid);
  toast('✏️ 메시지가 수정되었습니다.','s');
}
function deleteCustChatMsg(rid,mi){
  const r=chatData[rid];if(!r||!r.msgs[mi])return;
  if(!confirm('이 메시지를 삭제하시겠습니까?\n(삭제된 메시지로 표시됩니다)'))return;
  r.msgs[mi].deleted=true;
  r.msgs[mi].deletedAt=Date.now();
  saveChatData();
  openCustomerChat(rid);
  toast('🗑️ 메시지가 삭제되었습니다.','s');
}

// ===== CUSTOMER CHAT =====
function renderCustomerChat(){
  initChatFromBookings();
  // Find chat rooms for this customer (by phone)
  const myBks=bks.filter(b=>b.phone===uph);
  const myRooms=myBks.map(b=>chatData['bk_'+b.id]).filter(Boolean);

  const listEl=document.getElementById('custChatList');
  const roomEl=document.getElementById('custChatRoom');

  if(!myRooms.length){
    listEl.innerHTML=`<div style="text-align:center;padding:50px;color:#aaa;">
      <div style="font-size:40px;margin-bottom:10px;">💬</div>
      <p style="font-size:13px;">예약을 먼저 신청하시면 채팅방이 자동 생성됩니다.</p>
    </div>`;
    roomEl.style.display='none';
    return;
  }

  if(myRooms.length===1){
    listEl.style.display='none';
    roomEl.style.display='block';
    openCustomerChat(myRooms[0].id);
    return;
  }

  // Multiple rooms - show list
  listEl.style.display='block';
  roomEl.style.display='none';
  listEl.innerHTML=`<div style="padding:12px 16px;background:#f9f9f9;border-bottom:1px solid #eee;font-size:12px;color:#888;">내 채팅방 (${myRooms.length}개)</div>`+
  myRooms.map(r=>{
    const bk=bks.find(b=>'bk_'+b.id===r.id);
    const lastMsg=r.msgs?.length?r.msgs[r.msgs.length-1]:null;
    const timeStr=lastMsg?formatChatTime(lastMsg.ts):'';
    const preview=lastMsg?(lastMsg.text.length>35?lastMsg.text.slice(0,35)+'...':lastMsg.text):'';
    return `<div onclick="openCustomerChat('${r.id}')" style="display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;border-bottom:1px solid #f0f0f0;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
      <div style="width:40px;height:40px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;">🏛</div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;">
          <span style="font-size:12px;font-weight:700;">${bk?bk.date+' 예약':'채팅방'} ${r.unread>0?`<span style="background:#f44336;color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;">${r.unread}</span>`:''}</span>
          <span style="font-size:9px;color:#aaa;">${timeStr}</span>
        </div>
        <div style="font-size:11px;color:#888;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${preview}</div>
      </div>
    </div>`;
  }).join('');
}

function openCustomerChat(rid){
  const r=chatData[rid];if(!r)return;
  r.unread=0;saveChatData();
  const bk=bks.find(b=>'bk_'+b.id===rid);

  document.getElementById('custChatList').style.display='none';
  const roomEl=document.getElementById('custChatRoom');
  roomEl.style.display='block';

  // Header
  const hdr=document.getElementById('custChatHeader');
  hdr.innerHTML=`<div>
    <span style="font-size:14px;font-weight:700;">🏛 잠사박물관 플레이팜</span>
    ${bk?`<span style="font-size:10px;opacity:.8;margin-left:6px;">${bk.date} 예약</span>`:''}
  </div>
  ${bk&&bks.filter(b=>b.phone===uph).length>1?`<button onclick="renderCustomerChat()" style="border:none;background:rgba(255,255,255,.2);color:#fff;border-radius:6px;padding:4px 10px;font-size:10px;cursor:pointer;">← 목록</button>`:''}`;

  // Messages with sender names
  const body=document.getElementById('custChatBody');
  let mh='';
  const adminName=curAdmin?.name||'관리자';
  (r.msgs||[]).forEach((m,mi)=>{
    if(!m.id)m.id='m_'+m.ts+'_'+mi;
    const isAdmin=m.from==='admin';
    const isSys=m.from==='system';
    const isCust=m.from==='customer';
    if(m.deleted){
      mh+=`<div style="text-align:center;margin:8px 0;"><span style="color:#bbb;font-size:11px;font-style:italic;">🗑️ 삭제된 메시지</span></div>`;
      return;
    }
    const time=m.ts?new Date(m.ts).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
    const editedMark=m.editedAt?`<div class="chat-edited-mark">✏️ 수정됨 ${new Date(m.editedAt).toLocaleString('ko-KR',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>`:'';
    const senderName=m.sender||(isAdmin?'관리자':isCust?r.name:'');
    const admInfo=isAdmin?getAdminInfo(senderName):null;
    const admPhoto=admInfo?.photo||'';
    const admTitle=admInfo?.title||'';
    const admPhone=admInfo?.phone||'';
    const custActBtns=isCust?`<div class="chat-msg-actions" style="right:4px;"><button class="cma-edit" onclick="editCustChatMsg('${rid}',${mi})">✏️수정</button><button class="cma-del" onclick="deleteCustChatMsg('${rid}',${mi})">🗑️삭제</button></div>`:'';
    if(isSys){
      mh+=`<div style="text-align:center;margin:12px 0;"><span style="background:rgba(0,0,0,.15);color:#fff;font-size:11px;padding:4px 14px;border-radius:12px;">${m.text}</span></div>`;
    } else if(isCust){
      mh+=`<div class="chat-msg-wrap" style="display:flex;justify-content:flex-end;margin:8px 0;gap:6px;align-items:flex-end;">
        ${custActBtns}
        <span style="font-size:9px;color:#999;white-space:nowrap;">${time}</span>
        <div style="max-width:75%;">
          <div style="text-align:right;margin-bottom:4px;"><span style="background:#F9A825;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">${senderName}</span></div>
          <div id="custBubble_${mi}" style="background:#FFF9C4;padding:10px 14px;border-radius:14px 14px 0 14px;font-size:13px;line-height:1.5;box-shadow:0 1px 3px rgba(0,0,0,.1);">${m.text}</div>
          ${editedMark}
        </div>
      </div>`;
    } else if(isAdmin){
      const admInitial2=senderName.charAt(0);
      const photoHtml=admPhoto?`<img src="${admPhoto}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2);">`:`<div style="width:38px;height:38px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;flex-shrink:0;box-shadow:0 1px 4px rgba(0,0,0,.2);">${admInitial2}</div>`;
      mh+=`<div style="display:flex;justify-content:flex-start;margin:8px 0;gap:8px;align-items:flex-start;">
        <div style="flex-shrink:0;">${photoHtml}</div>
        <div style="max-width:75%;">
          <div style="margin-bottom:4px;"><span style="background:var(--p);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">${senderName}</span>${admTitle?` <span style="background:#fff3e0;color:#e65100;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;">${admTitle}</span>`:''}${admPhone?` <span style="color:#555;font-size:10px;font-weight:600;">📞${admPhone}</span>`:''}</div>
          <div style="display:flex;gap:6px;align-items:flex-end;">
            <div style="background:#fff;padding:10px 14px;border-radius:14px 14px 14px 0;font-size:13px;line-height:1.5;box-shadow:0 1px 3px rgba(0,0,0,.12);">${m.text}</div>
            <span style="font-size:9px;color:#999;white-space:nowrap;">${time}</span>
          </div>
          ${editedMark}
        </div>
      </div>`;
    }
  });
  body.innerHTML=mh;
  body.scrollTop=body.scrollHeight;

  // FAQ quick menu
  const faqList=getChatFaq();
  let faqHtml='';
  if(faqList.length){
    faqHtml=`<div id="custFaqPanel" style="padding:6px 16px 0;background:#fff;border-top:1px solid #f0f0f0;">
      <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:6px;" id="custFaqBtns">
        <button onclick="toggleFaqExpand()" style="flex-shrink:0;padding:6px 12px;border:1.5px solid var(--p);border-radius:20px;background:#f0f8e8;color:var(--p);font-size:11px;font-weight:700;cursor:pointer;">＋ 자주 묻는 질문</button>
      </div>
      <div id="custFaqExpanded" style="display:none;padding:4px 0 8px;"></div>
    </div>`;
  }

  // Input
  const inp=document.getElementById('custChatInput');
  inp.innerHTML=faqHtml+`<div style="display:flex;gap:8px;align-items:center;width:100%;padding:${faqList.length?'6px 0 0':'0'};">
    <input type="text" id="custChatText" placeholder="메시지를 입력하세요..." style="flex:1;padding:8px 14px;border:2px solid #ddd;border-radius:20px;font-size:12px;outline:none;" onkeydown="if(event.key==='Enter')sendCustomerMsg('${rid}')">
    <button onclick="sendCustomerMsg('${rid}')" style="padding:8px 18px;background:var(--p);color:#fff;border:none;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;">전송</button>
  </div>`;
  inp.style.flexDirection='column';
  inp.style.padding='0 16px 10px';
}

function toggleFaqExpand(){
  const el=document.getElementById('custFaqExpanded');if(!el)return;
  const isOpen=el.style.display!=='none';
  el.style.display=isOpen?'none':'block';
  if(!isOpen){
    const faqList=getChatFaq();
    el.innerHTML=faqList.map((f,i)=>{
      let mediaHtml='';
      const imgs=(f.media||[]).filter(m=>m.type==='image');
      const vids=(f.media||[]).filter(m=>m.type==='video');
      if(f.media?.length){
        mediaHtml='<div role="list" aria-label="첨부 미디어" style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">';

        // Images - grid for multiple, full width for single
        if(imgs.length===1){
          const m=imgs[0];const mi=(f.media).indexOf(m);
          mediaHtml+=`<div role="listitem" style="border-radius:12px;overflow:hidden;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.1);" onclick="showFaqImageModal(${i},${mi})" aria-label="${f.title} 사진">
            <img src="${m.data}" alt="${f.title} - ${m.name||'이미지'}" loading="lazy" style="width:100%;max-height:240px;object-fit:cover;display:block;" onerror="this.parentElement.innerHTML='<div style=padding:24px;text-align:center;background:#f5f5f5;color:#999;font-size:12px>📷 이미지를 불러올 수 없습니다</div>'">
          </div>`;
        } else if(imgs.length>1){
          mediaHtml+=`<div role="listitem" style="display:grid;grid-template-columns:repeat(${imgs.length<=2?2:3},1fr);gap:4px;border-radius:12px;overflow:hidden;">`;
          imgs.forEach(m=>{
            const mi=(f.media).indexOf(m);
            mediaHtml+=`<div style="cursor:pointer;aspect-ratio:1;overflow:hidden;position:relative;" onclick="showFaqImageModal(${i},${mi})" aria-label="${m.name||'사진'}">
              <img src="${m.data}" alt="${f.title} - ${m.name||'이미지'}" loading="lazy" style="width:100%;height:100%;object-fit:cover;display:block;transition:transform .2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            </div>`;
          });
          mediaHtml+='</div>';
        }

        // Videos
        vids.forEach(m=>{
          const ytId=extractYtId(m.url||m.originalUrl||'');
          const thumb=m.thumb||(ytId?'https://img.youtube.com/vi/'+ytId+'/hqdefault.jpg':'');
          const videoUrl=m.originalUrl||m.url||'';
          mediaHtml+=`<div role="listitem" aria-label="YouTube 영상" style="position:relative;border-radius:12px;overflow:hidden;cursor:pointer;background:#000;box-shadow:0 1px 4px rgba(0,0,0,.15);" onclick="window.open('${videoUrl}','_blank')">
            ${thumb?`<img src="${thumb}" alt="${f.title} - YouTube 영상 썸네일" loading="lazy" style="width:100%;display:block;max-height:200px;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`:''}
            <div style="${thumb?'display:none;':'display:flex;'}height:120px;align-items:center;justify-content:center;background:#1a1a1a;flex-direction:column;gap:6px;">
              <span style="font-size:40px;">🎬</span>
              <span style="font-size:10px;color:#aaa;">${FAQ_MSG.C_VID_FAIL}</span>
            </div>
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);" aria-hidden="true">
              <div style="width:56px;height:56px;background:rgba(255,0,0,.9);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 12px rgba(0,0,0,.4);transition:transform .2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                <div style="width:0;height:0;border-left:20px solid #fff;border-top:12px solid transparent;border-bottom:12px solid transparent;margin-left:4px;"></div>
              </div>
            </div>
            <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.75));padding:10px 12px;">
              <div style="font-size:11px;color:#fff;font-weight:600;">${FAQ_MSG.C_VID_EXTERNAL}</div>
            </div>
          </div>`;
        });

        mediaHtml+='</div>';
      }
      const mc=(f.media||[]).length;
      const imgCnt=imgs.length;
      const vidCnt=vids.length;
      const badge=mc?` <span style="font-size:9px;color:#1976d2;font-weight:400;">${imgCnt?'📷'+imgCnt:''}${imgCnt&&vidCnt?' ':''}${vidCnt?'🎬'+vidCnt:''}</span>`:'';
      return `
      <div style="border:1px solid #e0e0e0;border-radius:12px;margin-bottom:8px;overflow:hidden;">
        <div onclick="toggleFaqItem(${i})" role="button" tabindex="0" aria-expanded="false" aria-controls="faqBody${i}" style="display:flex;justify-content:space-between;align-items:center;padding:11px 14px;background:#fafafa;cursor:pointer;font-size:12px;font-weight:700;color:#333;user-select:none;" onkeydown="if(event.key==='Enter')this.click()">
          <span>${f.icon||'📌'} ${f.title}${badge}</span>
          <span id="faqArrow${i}" style="font-size:10px;color:#888;transition:transform .3s;" aria-hidden="true">▼</span>
        </div>
        <div id="faqBody${i}" role="region" style="display:none;padding:12px 14px;font-size:12px;color:#555;line-height:1.7;background:#fff;">
          <div style="white-space:pre-wrap;">${f.content}</div>
          ${mediaHtml}
        </div>
      </div>`;
    }).join('');
  }
}

function showFaqImageModal(fi,mi){
  const f=getChatFaq()[fi];if(!f?.media?.[mi])return;
  const imgs=f.media.filter(m=>m.type==='image');
  const imgIdx=imgs.indexOf(f.media[mi]);
  const old=document.getElementById('faqImgModal');if(old)old.remove();

  let curIdx=imgIdx>=0?imgIdx:0;
  const modal=document.createElement('div');
  modal.id='faqImgModal';
  modal.setAttribute('role','dialog');
  modal.setAttribute('aria-label','이미지 확대 보기');
  modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;';

  function render(){
    const m=imgs[curIdx];if(!m)return;
    modal.innerHTML=`
      <div style="position:relative;max-width:95vw;max-height:85vh;display:flex;align-items:center;justify-content:center;">
        <img src="${m.data}" alt="${m.name||f.title+' 이미지'}" style="max-width:95vw;max-height:80vh;object-fit:contain;border-radius:8px;box-shadow:0 4px 24px rgba(0,0,0,.5);user-select:none;">
      </div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:16px;">
        ${imgs.length>1?`<button onclick="event.stopPropagation();faqImgNav(-1)" style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;font-size:16px;cursor:pointer;${curIdx===0?'opacity:.3;cursor:default;':''}">◀</button>`:''}
        <span style="color:rgba(255,255,255,.7);font-size:11px;">${m.name||'이미지'} ${imgs.length>1?'('+(curIdx+1)+'/'+imgs.length+')':''}</span>
        ${imgs.length>1?`<button onclick="event.stopPropagation();faqImgNav(1)" style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;font-size:16px;cursor:pointer;${curIdx===imgs.length-1?'opacity:.3;cursor:default;':''}">▶</button>`:''}
      </div>
      <button onclick="document.getElementById('faqImgModal').remove()" aria-label="닫기" style="position:absolute;top:12px;right:12px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.9);border:none;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.3);">✕</button>`;
  }

  window.faqImgNav=function(dir){
    const next=curIdx+dir;
    if(next<0||next>=imgs.length)return;
    curIdx=next;render();
  };

  modal.onclick=function(e){if(e.target===modal)modal.remove();};
  document.addEventListener('keydown',function handler(e){
    if(!document.getElementById('faqImgModal')){document.removeEventListener('keydown',handler);return;}
    if(e.key==='Escape')modal.remove();
    if(e.key==='ArrowLeft')window.faqImgNav(-1);
    if(e.key==='ArrowRight')window.faqImgNav(1);
  });

  render();
  document.body.appendChild(modal);
}

function toggleFaqItem(i){
  const body=document.getElementById('faqBody'+i);
  const arrow=document.getElementById('faqArrow'+i);
  const header=arrow?.parentElement;
  if(!body)return;
  const isOpen=body.style.display!=='none';
  body.style.display=isOpen?'none':'block';
  if(arrow){arrow.textContent=isOpen?'▼':'▲';arrow.style.transform=isOpen?'rotate(0)':'rotate(180deg)';}
  if(header)header.setAttribute('aria-expanded',!isOpen);
}

function sendCustomerMsg(rid){
  const inp=document.getElementById('custChatText');
  const text=inp?.value.trim();if(!text)return;
  const r=chatData[rid];if(!r)return;
  if(!r.msgs)r.msgs=[];
  r.msgs.push({id:'m_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),from:'customer',sender:r.name,text,ts:Date.now()});
  r.lastMsg=text;r.lastTime=td();r.unread=(r.unread||0)+1;r.status='active';
  saveChatData();
  inp.value='';
  openCustomerChat(rid);
  // Trigger notification for admin
  triggerChatNotification(r.name, text);
}

// ===== Chat Notification System =====
function triggerChatNotification(senderName, msgText){
  // Browser Notification API
  if('Notification' in window && Notification.permission==='granted'){
    try{
      const noti=new Notification('💬 '+senderName+'님의 새 메시지',{
        body: msgText.length>60?msgText.slice(0,60)+'...':msgText,
        icon: '🏕️',
        tag: 'chat-'+Date.now(),
        requireInteraction: false
      });
      noti.onclick=function(){window.focus();noti.close();};
      setTimeout(()=>noti.close(),6000);
    }catch(e){}
  }
  // In-app toast notification (always works)
  showChatToast(senderName, msgText);
}

function showChatToast(name, text){
  // Remove existing chat toast
  const old=document.getElementById('chatNotiToast');if(old)old.remove();

  const preview=text.length>40?text.slice(0,40)+'...':text;
  const toast=document.createElement('div');
  toast.id='chatNotiToast';
  toast.style.cssText='position:fixed;bottom:80px;right:20px;z-index:99999;background:#fff;border-radius:14px;box-shadow:0 6px 30px rgba(0,0,0,.2);padding:0;min-width:300px;max-width:360px;overflow:hidden;animation:chatNotiSlide .35s ease;cursor:pointer;border:2px solid var(--p);';
  toast.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;padding:12px 14px;">
      <div style="width:42px;height:42px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0;">${name.charAt(0)}</div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:800;color:#333;">${name}</span>
          <span style="font-size:9px;color:#aaa;">방금 전</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${preview}</div>
      </div>
      <button onclick="event.stopPropagation();this.parentElement.parentElement.remove();" style="background:none;border:none;font-size:16px;color:#ccc;cursor:pointer;padding:0 2px;flex-shrink:0;">✕</button>
    </div>
    <div style="height:3px;background:var(--p);animation:chatNotiBar 5s linear forwards;"></div>`;
  toast.onclick=function(){
    toast.remove();
    if(mode==='admin'){gp('at');setTimeout(()=>{renderChatList();},100);}
  };
  document.body.appendChild(toast);

  // Add animation styles if not exist
  if(!document.getElementById('chatNotiStyle')){
    const style=document.createElement('style');
    style.id='chatNotiStyle';
    style.textContent=`
      @keyframes chatNotiSlide{from{transform:translateX(120%);opacity:0;}to{transform:translateX(0);opacity:1;}}
      @keyframes chatNotiBar{from{width:100%;}to{width:0;}}
    `;
    document.head.appendChild(style);
  }

  // Auto remove after 5s
  setTimeout(()=>{if(toast.parentNode)toast.style.animation='chatNotiSlide .3s ease reverse forwards';setTimeout(()=>{if(toast.parentNode)toast.remove();},300);},5000);

  // Play notification sound
  playChatSound();
}

function playChatSound(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(880,ctx.currentTime);
    osc.frequency.setValueAtTime(1100,ctx.currentTime+0.1);
    gain.gain.setValueAtTime(0.15,ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime+0.3);
  }catch(e){}
}

function sCon(){if(!cSch)return new Set();const cs2=new Set(),sm={};Object.entries(cSch.sch).forEach(([gi,sl])=>{sl.forEach(({t,a})=>{if(a&&a!=='-'&&!a.includes('점심')&&a!=='자유관람'){const k=`${t}-${a}`;if(sm[k]!==undefined){cs2.add(`${gi}-${t}`);cs2.add(`${sm[k]}-${t}`);}else sm[k]=gi;}});});return cs2;}
function sEE(gi,ti2,si){sEd={g:gi,t:ti2,s:si,mode:'select'};rSch();const s=document.getElementById(`se-${gi}-${ti2}`);if(s)s.focus();}
function sEDirect(gi,ti2,si,curVal){sEd={g:gi,t:ti2,s:si,mode:'input'};rSch();const inp=document.getElementById(`sei-${gi}-${ti2}`);if(inp){inp.focus();inp.select();}}
function sCm(gi,si,v){cSch.sch[gi][si].a=v;sEd=null;rSch();}
function sCmDirect(gi,si,v){if(v.trim())cSch.sch[gi][si].a=v.trim();sEd=null;rSch();}
function sCn(){sEd=null;rSch();}

// Schedule Rules
let schRules=JSON.parse(localStorage.getItem(FP+'schrules')||'[]');
function saveSchRules(){localStorage.setItem(FP+'schrules',JSON.stringify(schRules));}

function toggleSchRules(){
  const el=document.getElementById('schRulesCard');
  el.style.display=el.style.display==='none'?'block':'none';
  if(el.style.display==='block')renderSchRules();
}

function renderSchRules(){
  // Populate time dropdown
  const tSel=document.getElementById('srTime');
  if(tSel.options.length<=1){TS.forEach((s,i)=>{const o=document.createElement('option');o.value=i;o.text=s.l;tSel.appendChild(o);});}
  // Populate activity dropdown
  const aSel=document.getElementById('srAct');
  aSel.innerHTML='';allA().filter(a=>a!=='✏️ 직접입력').forEach(a=>{const o=document.createElement('option');o.value=a;o.text=a;aSel.appendChild(o);});
  // Add custom input option
  const customOpt=document.createElement('option');customOpt.value='__custom__';customOpt.text='✏️ 직접입력';aSel.appendChild(customOpt);
  aSel.onchange=function(){
    let ci=document.getElementById('srActCustom');
    if(this.value==='__custom__'){
      if(!ci){ci=document.createElement('input');ci.id='srActCustom';ci.type='text';ci.placeholder='활동명 입력';ci.style.cssText='padding:5px 8px;border:2px solid var(--p);border-radius:6px;font-size:11px;margin-left:4px;width:100px;';this.parentNode.insertBefore(ci,this.nextSibling);}
      ci.style.display='inline-block';ci.focus();
    } else {if(ci)ci.style.display='none';}
  };
  // Populate group dropdown from selected date bookings only
  const gSel=document.getElementById('srGroup');
  gSel.innerHTML='<option value="all">전체 단체</option>';
  const ds=document.getElementById('sD').value;
  const dateBks=ds?bks.filter(b=>b.date===ds&&b.status!=='취소'):[];
  const seen=new Set();
  dateBks.forEach(b=>{if(!seen.has(b.name)){const o=document.createElement('option');o.value=b.name;o.text=b.name;gSel.appendChild(o);seen.add(b.name);}});

  const el=document.getElementById('schRulesList');
  if(!schRules.length){el.innerHTML='<div style="color:#aaa;font-size:12px;text-align:center;padding:8px;">설정된 조건이 없습니다.</div>';return;}
  const typeLabels={fix:'🔒 고정',ban:'🚫 금지',first:'⭐ 우선'};
  const typeColors={fix:'#e8f5e9',ban:'#ffebee',first:'#e3f2fd'};
  const durLabels={'1':'30분','2':'1시간','3':'1시간30분'};
  el.innerHTML=schRules.map((r,i)=>{
    const timeLabel=r.time==='all'?'전체시간':TS[r.time]?.l||r.time;
    const groupLabel=(!r.group||r.group==='all')?'전체단체':r.group;
    const dur=r.dur||1;
    const endIdx=r.time!=='all'?r.time+dur:null;
    const timeRange=r.time==='all'?'전체시간':`${TS[r.time]?.s||''}~${TS[endIdx-1]?.e||TS[r.time]?.e||''} (${durLabels[dur]||dur+'칸'})`;
    return `<div style="display:flex;align-items:center;gap:6px;padding:8px 10px;background:${typeColors[r.type]};border-radius:6px;margin-bottom:4px;flex-wrap:wrap;">
      <span style="font-size:11px;font-weight:700;">${typeLabels[r.type]}</span>
      <span style="font-size:10px;background:#fff;padding:2px 6px;border-radius:4px;border:1px solid #ddd;">👥 ${groupLabel}</span>
      <span style="font-size:10px;background:#fff;padding:2px 6px;border-radius:4px;border:1px solid #ddd;">🕐 ${timeRange}</span>
      <span style="font-size:11px;font-weight:600;background:#fff;padding:2px 6px;border-radius:4px;">${r.act}</span>
      ${r.memo?`<span style="font-size:10px;color:#888;">(${r.memo})</span>`:''}
      <button onclick="removeSchRule(${i})" style="margin-left:auto;background:#f44336;color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer;">삭제</button>
    </div>`;
  }).join('');
}

function addSchRule(){
  const type=document.getElementById('srType').value;
  const group=document.getElementById('srGroup').value;
  const time=document.getElementById('srTime').value;
  const dur=parseInt(document.getElementById('srDur').value)||1;
  let act=document.getElementById('srAct').value;
  if(act==='__custom__'){const ci=document.getElementById('srActCustom');act=ci?ci.value.trim():'';if(!act){toast('활동명을 입력하세요','e');return;}}
  const memo=document.getElementById('srMemo').value.trim();
  schRules.push({type,group,time:time==='all'?'all':parseInt(time),dur,act,memo});
  saveSchRules();renderSchRules();toast('✅ 조건 추가','s');
}

function removeSchRule(idx){
  schRules.splice(idx,1);saveSchRules();renderSchRules();toast('🗑 조건 삭제','i');
}

function applySchRules(sch,sorted){
  if(!schRules.length)return;
  schRules.forEach(rule=>{
    sorted.forEach((bk,bi)=>{
      // Group filter
      if(rule.group&&rule.group!=='all'&&bk.name!==rule.group)return;
      const slots=sch[bi];if(!slots)return;
      const dur=rule.dur||1;

      if(rule.time!=='all'){
        // Apply to specific time range (time ~ time+dur)
        for(let t=rule.time;t<rule.time+dur;t++){
          const si=slots.findIndex(s=>s.t===t);
          if(si===-1)continue;
          if(rule.type==='fix')slots[si].a=rule.act;
          else if(rule.type==='ban'&&slots[si].a===rule.act){
            const used=new Set(slots.filter(s=>s.t===t).map(s=>s.a));
            let repl=null;for(const c of cs){if(!used.has(c)&&c!==rule.act){repl=c;break;}}
            slots[si].a=repl||'자유관람';
          }
          else if(rule.type==='first'&&!slots[si].a.includes('점심')){slots[si].a=rule.act;}
        }
      } else {
        // Apply to all timeslots
        slots.forEach((sl,si)=>{
          if(rule.type==='fix')sl.a=rule.act;
          else if(rule.type==='ban'&&sl.a===rule.act){
            const used=new Set(slots.filter(s=>s.t===sl.t).map(s=>s.a));
            let repl=null;for(const c of cs){if(!used.has(c)&&c!==rule.act){repl=c;break;}}
            sl.a=repl||'자유관람';
          }
          else if(rule.type==='first'&&!sl.a.includes('점심')){sl.a=rule.act;}
        });
      }
    });
  });
}

function rSch(){
  if(!cSch){document.getElementById('sW').style.display='none';document.getElementById('savSchBtn').style.display='none';
    const ep=document.getElementById('schExcelPreviewBtn');if(ep)ep.style.display='none';
    const ed=document.getElementById('schExcelDlBtn');if(ed)ed.style.display='none';
    const sb=document.getElementById('schSavedBadge');if(sb)sb.style.display='none';
    return;}
  document.getElementById('sW').style.display='block';
  document.getElementById('savSchBtn').style.display='';
  const d=new Date(cSch.date);
  const isSaved=!!savedScheds[cSch.date];
  document.getElementById('sT').textContent=`📋 ${d.getMonth()+1}/${d.getDate()} 일정표`;
  const savedBadge=document.getElementById('schSavedBadge');
  if(savedBadge){
    savedBadge.style.display='';
    if(isSaved){
      savedBadge.innerHTML='💾 재저장';
      savedBadge.style.background='rgba(76,175,80,.3)';
      savedBadge.style.borderColor='#81C784';
    } else {
      savedBadge.innerHTML='💾 저장';
      savedBadge.style.background='rgba(255,255,255,.2)';
      savedBadge.style.borderColor='#fff';
    }
  }
  const exPrevBtn=document.getElementById('schExcelPreviewBtn');
  const exDlBtn=document.getElementById('schExcelDlBtn');
  if(exPrevBtn)exPrevBtn.style.display='';
  if(exDlBtn)exDlBtn.style.display='';

  const con=sCon();const cb=document.getElementById('sCB');
  if(con.size>0){cb.style.display='';cb.textContent=`⚠️ 충돌 ${Math.floor(con.size/2)}건`;}else cb.style.display='none';
  const bs2=cSch.bks,sc=cSch.sch;

  // Pre-calculate per-timeslot location headcounts
  const locHead={};// {ti: {actName: totalPpl}}
  TS.forEach((_,ti2)=>{
    locHead[ti2]={};
    bs2.forEach((b,gi)=>{
      const e=sc[gi]?.find(s=>s.t===ti2);
      if(e&&e.a&&e.a!=='-'){
        const ppl=b.students+b.teachers;
        if(!locHead[ti2][e.a])locHead[ti2][e.a]=0;
        locHead[ti2][e.a]+=ppl;
      }
    });
  });

  let h='<thead><tr><th class="tth" style="font-size:15px;">시간</th>';
  bs2.forEach((b,i)=>{
    const c=CL[i%CL.length];
    const etc=b.etc?b.etc.replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
    const etcRow=b.etc?`<div style="margin-top:4px;padding:5px 8px;background:rgba(255,255,255,.7);border-radius:6px;border:1px dashed ${c.r};font-size:12px;color:#333;text-align:left;line-height:1.4;max-height:44px;overflow-y:auto;">📝 ${b.etc}</div>`:'';
    
    // 견적 정보 계산
    let quoteInfo='';
    try{
      const q=calcQuote(b);
      const items=q.items;
      const entryItems=items.filter(x=>x.cat==='체험료');
      const mealItems=items.filter(x=>x.cat==='급식');
      let qRows='';
      entryItems.forEach(it=>{
        qRows+=`<div style="display:flex;justify-content:space-between;gap:4px;font-size:11px;color:#333;padding:1px 0;"><span>${it.name}</span><span style="font-weight:700;">${it.qty}×₩${fmtWon(it.unit)}</span></div>`;
      });
      mealItems.forEach(it=>{
        qRows+=`<div style="display:flex;justify-content:space-between;gap:4px;font-size:11px;color:#C2185B;padding:1px 0;"><span>🍽${it.name}</span><span style="font-weight:700;">${it.qty}×₩${fmtWon(it.unit)}</span></div>`;
      });
      quoteInfo=`<div style="margin-top:6px;padding:6px 8px;background:rgba(255,255,255,.85);border-radius:8px;border:1px solid rgba(0,0,0,.1);text-align:left;">
        ${qRows}
        <div style="border-top:1px solid rgba(0,0,0,.15);margin-top:4px;padding-top:4px;display:flex;justify-content:space-between;font-size:13px;font-weight:900;color:#1565C0;">
          <span>합계</span><span>₩${fmtWon(q.grandTotal)}</span>
        </div>
      </div>`;
    }catch(e){quoteInfo='';}
    
    // 견적서/거래내역서 버튼
    const hasActual=b.actualStudents!=null;
    const docBtns=`<div style="margin-top:6px;display:flex;gap:4px;justify-content:center;flex-wrap:wrap;">
      <button onclick="event.stopPropagation();previewQuote(${b.id},'견적서')" style="padding:3px 8px;font-size:10px;border:1px solid #2e7d32;border-radius:5px;background:#E8F5E9;color:#2e7d32;font-weight:700;cursor:pointer;">📄견적 미리보기</button>
      <button onclick="event.stopPropagation();dlQuote(${b.id},'견적서')" style="padding:3px 8px;font-size:10px;border:1px solid #1565C0;border-radius:5px;background:#E3F2FD;color:#1565C0;font-weight:700;cursor:pointer;">📥견적 다운</button>
      ${hasActual?`<button onclick="event.stopPropagation();previewQuote(${b.id},'거래내역서(실제인원)')" style="padding:3px 8px;font-size:10px;border:1px solid #C2185B;border-radius:5px;background:#FCE4EC;color:#C2185B;font-weight:700;cursor:pointer;">📋거래 미리보기</button>
      <button onclick="event.stopPropagation();dlQuote(${b.id},'거래내역서(실제인원)')" style="padding:3px 8px;font-size:10px;border:1px solid #C2185B;border-radius:5px;background:#FCE4EC;color:#C2185B;font-weight:700;cursor:pointer;">📥거래 다운</button>`:''}
    </div>`;
    
    h+=`<th style="background:${c.b};color:${c.t};border-bottom:4px solid ${c.r};min-width:180px;vertical-align:top;padding:12px 10px;font-size:15px;" ${etc?'title="📝 특이사항: '+etc+'"':''}>${b.name}<br><span class="sub" style="font-size:12px;font-weight:600;">${b.arrival}~${b.departure} | ${b.students+b.teachers}명</span>${quoteInfo}${docBtns}${etcRow}</th>`;
  });
  h+='</tr></thead><tbody>';
  TS.forEach((slot,ti2)=>{
    const rb=ti2%2===0?'#fff':'#f7f7f7';h+=`<tr style="background:${rb}"><td class="ttd" style="background:${rb};font-size:14px;padding:10px 12px;">${slot.l}</td>`;
    bs2.forEach((b,gi)=>{
      const e=sc[gi]?.find(s=>s.t===ti2);if(!e){h+='<td style="color:#ddd;font-size:14px;">-</td>';return;}
      const ic=con.has(`${gi}-${ti2}`),im=e.a.includes('점심'),ig=e.a==='자유관람';const c=CL[gi%CL.length];
      let bg='transparent';if(ic)bg='#ffcdd2';else if(im)bg='#FFF9C4';else if(ig)bg='#f0f0f0';else bg=c.b;
      const si=sc[gi].findIndex(s=>s.t===ti2);
      if(sEd&&sEd.g===gi&&sEd.t===ti2){
        if(sEd.mode==='input'){
          h+=`<td style="background:${bg};padding:6px;"><input id="sei-${gi}-${ti2}" type="text" value="${e.a}" style="width:100%;padding:6px;border:2px solid var(--p);border-radius:6px;font-size:14px;text-align:center;" onkeydown="if(event.key==='Enter')sCmDirect(${gi},${si},this.value);if(event.key==='Escape')sCn();" onblur="sCmDirect(${gi},${si},this.value)"></td>`;
        } else {
          const opts=allA().map(o=>`<option value="${o}" ${o===e.a?'selected':''}>${o}</option>`).join('');
          h+=`<td style="background:${bg};padding:6px;"><select id="se-${gi}-${ti2}" style="font-size:14px;padding:4px;" onchange="if(this.value==='✏️ 직접입력'){this.style.display='none';const inp=document.createElement('input');inp.type='text';inp.style.cssText='width:100%;padding:6px;border:2px solid var(--p);border-radius:6px;font-size:14px;text-align:center;';inp.placeholder='활동명 입력';inp.onkeydown=function(ev){if(ev.key==='Enter')sCmDirect(${gi},${si},this.value);if(ev.key==='Escape')sCn();};inp.onblur=function(){if(this.value.trim())sCmDirect(${gi},${si},this.value);else sCn();};this.parentNode.appendChild(inp);inp.focus();}else{sCm(${gi},${si},this.value);}" onblur="if(this.value!=='✏️ 직접입력')sCn()">${opts}</select></td>`;
        }
      }
      else {
        let ruleIcon='';
        schRules.forEach(r=>{if((r.time==='all'||r.time===ti2)&&(r.type==='fix'&&e.a===r.act))ruleIcon='🔒';if((r.time==='all'||r.time===ti2)&&r.type==='ban'&&e.a===r.act)ruleIcon='🚫';});
        h+=`<td class="${ic?'cfl':''}" style="background:${bg};${im?'font-weight:800;':''}${ic?'color:#c62828;':''}cursor:pointer;font-size:14px;font-weight:600;color:#222;" onclick="sEE(${gi},${ti2},${si})" ondblclick="event.stopPropagation();sEDirect(${gi},${ti2},${si},'${e.a.replace(/'/g,"\\'")}')">${ruleIcon}${e.a}${ic?' ⚠️':''}</td>`;
      }
    });
    h+='</tr>';
  });
  h+='<tr style="border-top:3px solid var(--p);"><td class="ttd" style="background:#FFF8E1;font-weight:800;color:#F57F17;font-size:14px;padding:10px;">📝 요청사항</td>';
  bs2.forEach((b,gi)=>{
    const c=CL[gi%CL.length];
    const etc=b.etc||'';
    if(etc){
      h+=`<td style="background:#FFFDE7;padding:10px 12px;font-size:13px;color:#333;line-height:1.5;vertical-align:top;border-left:3px solid ${c.r};max-width:200px;">
        <div style="max-height:70px;overflow-y:auto;font-weight:500;">${etc}</div>
      </td>`;
    } else {
      h+=`<td style="background:#fafafa;color:#ccc;font-size:13px;text-align:center;vertical-align:middle;">-</td>`;
    }
  });
  h+='</tr>';
  h+='</tbody>';document.getElementById('sTbl').innerHTML=h;

  // Build location headcount detail table
  // Collect all unique locations
  const allLocs=new Set();
  TS.forEach((_,ti2)=>{Object.keys(locHead[ti2]).forEach(k=>{if(k!=='-')allLocs.add(k);});});
  const locs=[...allLocs];
  const locCard=document.getElementById('sLocCard');
  if(locs.length){
    locCard.style.display='block';
    // Color map for locations
    const locColors={'박물관 관람':'#E8F5E9','양떼정원':'#F1F8E9','눈썰매장':'#E3F2FD','키즈카페':'#FFF3E0','누에쉼터':'#F3E5F5','사계절 썰매':'#E0F7FA','자유관람':'#F5F5F5','점심식사':'#FFF9C4','점심식사(단체식)':'#FFF9C4'};
    let lt='<thead><tr><th class="tth" style="background:#37474F;color:#fff;font-size:15px;padding:12px;">시간</th>';
    locs.forEach(loc=>{lt+=`<th style="background:${locColors[loc]||'#ECEFF1'};font-size:15px;min-width:110px;padding:12px 10px;font-weight:800;color:#333;">${loc}</th>`;});
    lt+='<th style="background:#37474F;color:#fff;font-size:15px;padding:12px;">합계</th>';
    lt+='</tr></thead><tbody>';

    // Track max per location for highlighting
    const locMaxPpl={};
    locs.forEach(loc=>{let mx=0;TS.forEach((_,ti2)=>{mx=Math.max(mx,locHead[ti2][loc]||0);});locMaxPpl[loc]=mx;});

    TS.forEach((slot,ti2)=>{
      const hasAny=locs.some(loc=>locHead[ti2][loc]);
      if(!hasAny){lt+=`<tr style="background:#fafafa;"><td class="ttd" style="font-size:14px;padding:10px 12px;">${slot.l}</td>${locs.map(()=>'<td style="color:#ddd;text-align:center;font-size:14px;">-</td>').join('')}<td style="color:#ddd;text-align:center;font-size:14px;">-</td></tr>`;return;}
      const rb=ti2%2===0?'#fff':'#f7f7f7';
      let rowTotal=0;
      lt+=`<tr style="background:${rb}"><td class="ttd" style="font-weight:700;font-size:14px;color:#333;padding:10px 12px;">${slot.l}</td>`;
      locs.forEach(loc=>{
        const ppl=locHead[ti2][loc]||0;
        rowTotal+=ppl;
        if(ppl){
          const isMax=ppl===locMaxPpl[loc]&&ppl>0;
          const bg=locColors[loc]||'#ECEFF1';
          // Build tooltip with group details
          const groups=[];
          bs2.forEach((b,gi)=>{const e=sc[gi]?.find(s=>s.t===ti2);if(e&&e.a===loc)groups.push({name:b.name,stu:b.students,tea:b.teachers,ppl:b.students+b.teachers,ct:b.courseType||'',meal:b.meal||''});});
          const tipLines=groups.map(g=>`• ${g.name}: ${g.ppl}명(아동${g.stu}+인솔${g.tea})`).join('||');
          const tipText=`[${slot.l}] ${loc}||총 ${ppl}명 (${groups.length}팀)||─────────||${tipLines}`;
          lt+=`<td style="text-align:center;background:${bg};font-weight:700;padding:8px;${isMax?'border:3px solid #ff9800;':''}cursor:pointer;position:relative;" data-loctip="${tipText.replace(/"/g,'&quot;')}" onmouseenter="showLocTip(event,this)" onmouseleave="hideLocTip()">`;
          lt+=`<span style="font-size:18px;font-weight:900;color:#111;">${ppl}</span><span style="font-size:12px;color:#666;font-weight:700;">명</span>`;
          if(groups.length>1)lt+=`<div style="font-size:11px;color:#555;margin-top:3px;font-weight:600;">${groups.map(g=>`${g.name}(${g.ppl})`).join(' ')}</div>`;
          lt+='</td>';
        } else {
          lt+='<td style="text-align:center;color:#ddd;font-size:14px;">-</td>';
        }
      });
      lt+=`<td style="text-align:center;background:#ECEFF1;font-weight:900;font-size:18px;padding:8px;"><span style="color:#111;">${rowTotal}</span><span style="font-size:12px;color:#555;font-weight:700;">명</span></td>`;
      lt+='</tr>';
    });

    // Total row
    lt+=`<tr style="background:#37474F;color:#fff;font-weight:800;"><td style="text-align:center;font-size:15px;padding:12px;">총계</td>`;
    let grandTotal=0;
    locs.forEach(loc=>{
      let locTotal=0;TS.forEach((_,ti2)=>{locTotal+=locHead[ti2][loc]||0;});
      grandTotal+=locTotal;
      lt+=`<td style="text-align:center;font-size:17px;padding:10px;">${locTotal}<span style="font-size:12px;opacity:.8;">명</span></td>`;
    });
    lt+=`<td style="text-align:center;font-size:18px;padding:10px;">${grandTotal}<span style="font-size:12px;opacity:.8;">명</span></td></tr>`;

    lt+='</tbody>';
    document.getElementById('sLocTbl').innerHTML=lt;
  } else {
    locCard.style.display='none';
  }

  renderSavedList();
}

function previewSchExcel(){
  if(!cSch){toast('먼저 생성','e');return;}
  const d=new Date(cSch.date),ds=`${d.getMonth()+1}/${d.getDate()}`;
  const bs2=cSch.bks,sc=cSch.sch;
  
  let h=`<div style="overflow-x:auto;max-height:70vh;overflow-y:auto;">
  <table style="border-collapse:collapse;width:100%;font-size:12px;">
  <tr><td colspan="${bs2.length+1}" style="background:#2E7D32;color:white;font-size:16px;font-weight:bold;padding:10px;text-align:center;">${ds} 일정표</td></tr>
  <tr><td style="background:#f5f5f5;font-weight:bold;padding:8px;border:1px solid #ddd;text-align:center;">시간</td>`;
  bs2.forEach((b,i)=>{
    const c=CL[i%CL.length];
    h+=`<td style="background:${c.b};color:${c.t};font-weight:bold;padding:8px;border:1px solid #ddd;text-align:center;min-width:120px;">${b.name} (${b.students}+${b.teachers})<br>${b.courseType}</td>`;
  });
  h+='</tr>';
  TS.forEach((slot,ti2)=>{
    h+=`<tr><td style="background:#F5F5F5;font-weight:bold;padding:6px 10px;border:1px solid #ddd;text-align:center;">${slot.l}</td>`;
    bs2.forEach((b,gi)=>{
      const e=sc[gi]?.find(s=>s.t===ti2);
      let v='',st='background:#fff;';
      if(e){v=e.a;if(v.includes('점심'))st='background:#FFEB3B;font-weight:bold;';else if(v==='자유관람')st='background:#E0E0E0;';else st=`background:${CL[gi%CL.length].b};`;}
      h+=`<td style="${st}padding:6px;border:1px solid #ddd;text-align:center;">${v}</td>`;
    });
    h+='</tr>';
  });

  // 장소별 인원
  const allLX=new Set();const lhX={};
  TS.forEach((_,ti2)=>{lhX[ti2]={};bs2.forEach((b,gi)=>{const e=sc[gi]?.find(s=>s.t===ti2);if(e&&e.a&&e.a!=='-'){if(!lhX[ti2][e.a])lhX[ti2][e.a]=0;lhX[ti2][e.a]+=b.students+b.teachers;allLX.add(e.a);}});});
  const locsX=[...allLX];
  if(locsX.length){
    h+=`<tr><td colspan="${bs2.length+1}" style="height:16px;border:none;"></td></tr>`;
    h+=`<tr><td colspan="${locsX.length+2}" style="background:#37474F;color:white;font-size:14px;font-weight:bold;padding:8px;text-align:center;">📍 장소별 인원 현황</td></tr>`;
    h+=`<tr><td style="background:#37474F;color:white;font-weight:bold;padding:6px;border:1px solid #ddd;text-align:center;">시간</td>`;
    locsX.forEach(loc=>{h+=`<td style="background:#ECEFF1;font-weight:bold;padding:6px;border:1px solid #ddd;text-align:center;">${loc}</td>`;});
    h+=`<td style="background:#37474F;color:white;font-weight:bold;padding:6px;border:1px solid #ddd;text-align:center;">합계</td></tr>`;
    TS.forEach((slot,ti2)=>{
      h+=`<tr><td style="background:#F5F5F5;font-weight:bold;padding:6px;border:1px solid #ddd;text-align:center;">${slot.l}</td>`;
      let rt=0;
      locsX.forEach(loc=>{const p=lhX[ti2][loc]||0;rt+=p;h+=`<td style="text-align:center;padding:6px;border:1px solid #ddd;${p?'font-weight:bold;':''}">${p||'-'}</td>`;});
      h+=`<td style="text-align:center;font-weight:bold;padding:6px;border:1px solid #ddd;background:#ECEFF1;">${rt||'-'}</td></tr>`;
    });
  }
  h+='</table></div>';

  const mdl=document.getElementById('mdl');
  const mdlInner=mdl.querySelector('.mdl');
  if(mdlInner)mdlInner.style.maxWidth='90vw';
  document.getElementById('mtl').textContent=`📥 ${ds} 일정표 엑셀 미리보기`;
  document.getElementById('mdlBd').innerHTML=h;
  document.getElementById('mft').innerHTML=`<div style="display:flex;gap:8px;justify-content:flex-end;padding:10px;">
    <button class="btn bg" onclick="expSch();cMdl();" style="font-size:13px;padding:8px 16px;">📥 엑셀 다운로드</button>
    <button class="btn bgy" onclick="cMdl()" style="font-size:13px;padding:8px 16px;">닫기</button>
  </div>`;
  mdl.style.display='flex';
}

function expSch(){
  if(!cSch){toast('먼저 생성','e');return;}const d=new Date(cSch.date),ds=`${d.getMonth()+1}/${d.getDate()}`;const bs2=cSch.bks,sc=cSch.sch;
  let h=`<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"><style>td,th{border:1px solid #999;padding:6px 12px;text-align:center;font-family:맑은 고딕;font-size:11pt;mso-number-format:\\@;}</style></head><body><table>`;
  h+=`<tr><td colspan="${bs2.length+1}" style="background:#2E7D32;color:white;font-size:14pt;font-weight:bold;">${ds} 일정표</td></tr>`;
  h+='<tr><td style="background:#f5f5f5;font-weight:bold;">시간</td>';
  bs2.forEach((b,i)=>{const c=CL[i%CL.length];h+=`<td style="background:${c.b};color:${c.t};font-weight:bold;">${b.name} (${b.students}+${b.teachers})<br>${b.courseType}</td>`;});
  h+='</tr>';
  TS.forEach((slot,ti2)=>{h+='<tr><td style="background:#F5F5F5;font-weight:bold;">'+slot.l+'</td>';
    bs2.forEach((b,gi)=>{const e=sc[gi]?.find(s=>s.t===ti2);let v='',st='';if(e){v=e.a;if(v.includes('점심'))st='background:#FFEB3B;font-weight:bold;';else if(v==='자유관람')st='background:#E0E0E0;';else st=`background:${CL[gi%CL.length].b};`;}h+=`<td style="${st}">${v}</td>`;});
    h+='</tr>';});
  // Location headcount section
  const allLX=new Set();const lhX={};
  TS.forEach((_,ti2)=>{lhX[ti2]={};bs2.forEach((b,gi)=>{const e=sc[gi]?.find(s=>s.t===ti2);if(e&&e.a&&e.a!=='-'){if(!lhX[ti2][e.a])lhX[ti2][e.a]=0;lhX[ti2][e.a]+=b.students+b.teachers;allLX.add(e.a);}});});
  const locsX=[...allLX];
  h+=`<tr><td colspan="${bs2.length+1}" style="height:20px;"></td></tr>`;
  h+=`<tr><td colspan="${locsX.length+2}" style="background:#37474F;color:white;font-size:12pt;font-weight:bold;">📍 장소별 인원 현황</td></tr>`;
  h+=`<tr><td style="background:#37474F;color:white;font-weight:bold;">시간</td>`;
  locsX.forEach(loc=>{h+=`<td style="background:#ECEFF1;font-weight:bold;">${loc}</td>`;});
  h+=`<td style="background:#37474F;color:white;font-weight:bold;">합계</td></tr>`;
  TS.forEach((slot,ti2)=>{h+=`<tr><td style="background:#F5F5F5;font-weight:bold;">${slot.l}</td>`;let rt=0;locsX.forEach(loc=>{const p=lhX[ti2][loc]||0;rt+=p;h+=`<td style="text-align:center;${p?'font-weight:bold;':''}">${p||'-'}</td>`;});h+=`<td style="text-align:center;font-weight:bold;background:#ECEFF1;">${rt||'-'}</td></tr>`;});
  h+='</table></body></html>';dl(h,`일정표_${cSch.date}.xls`);toast('📥 엑셀','s');
}

// ===== KAKAO =====
function admMsg(b){return `[잠사박물관 단체예약]\n📅${b.date} ⏰${b.arrival}~${b.departure}\n🏫${b.name} 👥${b.students+b.teachers}명\n🎫${b.courseType} 🍚${b.meal}\n📞${b.phone}\n⏱️${new Date().toLocaleString('ko-KR')}`;}
function custMsg(b,type){const t={접수:'예약 접수 완료',확정:'예약이 확정되었습니다'};return `[잠사박물관]\n${t[type]||type}\n📅${b.date} ⏰${b.arrival}~${b.departure}\n🏫${b.name} 👥${b.students+b.teachers}명\n문의:010-6256-2969`;}
function remMsg(b,type){return `[잠사박물관 방문안내]\n${b.name}님, ${type==='전일'?'내일':'다음주'} 방문 예정 안내\n📅${b.date} ⏰${b.arrival}~${b.departure}\n👥${b.students+b.teachers}명\n즐거운 방문 되세요!🏕️`;}
function dailyMsg(ds,list){let m=`[잠사박물관 ${ds} 예약현황]\n총${list.length}건/${list.reduce((s,b)=>s+b.students+b.teachers,0)}명\n`;list.forEach((b,i)=>{m+=`${i+1}.${b.name}|${b.arrival}~${b.departure}|${b.students+b.teachers}명|${b.status}\n`;});return m;}

function sendK(target,msg,phone){
  console.log(`📤[${target}${phone?':'+phone:''}]`,msg);
  if('Notification' in window&&Notification.permission==='granted'){try{new Notification('🏕️잠사박물관',{body:msg.substring(0,80)+'...'});}catch(e){}}
}

function sendDK(){
  if(!cSch){toast('먼저 일정 생성','e');return;}
  const msg=dailyMsg(cSch.date,cSch.bks);
  sendK('admin',msg);toast('💬 일별 예약 카톡 전송','k');
}

function testK(){
  sendK('admin',admMsg({date:'2025-01-20',name:'테스트',arrival:'10:00',departure:'14:00',students:20,teachers:4,courseType:'기본코스',meal:'이용안함',phone:'010-0000-0000'}));
  toast('🔔 테스트 알림 전송','k');
}

// ===== REMINDERS =====
function scheduleReminder(bk){
  const visit=new Date(bk.date);const now=new Date();
  // 전일 리마인더
  const dayBefore=new Date(visit);dayBefore.setDate(dayBefore.getDate()-1);dayBefore.setHours(10,0,0,0);
  const msDay=dayBefore.getTime()-now.getTime();
  if(msDay>0&&msDay<7*24*60*60*1000){setTimeout(()=>{sendK('customer',remMsg(bk,'전일'),bk.phone);toast(`📢 ${bk.name} 전일 리마인더 발송`,'k');},msDay);}
  // 1주전 리마인더
  const weekBefore=new Date(visit);weekBefore.setDate(weekBefore.getDate()-7);weekBefore.setHours(10,0,0,0);
  const msWeek=weekBefore.getTime()-now.getTime();
  if(msWeek>0){setTimeout(()=>{sendK('customer',remMsg(bk,'전주'),bk.phone);toast(`📢 ${bk.name} 1주전 리마인더 발송`,'k');},Math.min(msWeek,2147483647));}
  // 관리자 당일 요약 (simplified: check every page load)
}

function checkDailyAdmin(){
  const t=td();const tB=bks.filter(b=>b.date===t&&b.status!=='취소');
  if(tB.length){const lastSent=localStorage.getItem('jp_daily_'+t);
    if(!lastSent){sendK('admin',dailyMsg(t,tB));localStorage.setItem('jp_daily_'+t,'1');console.log('📤 당일 예약 요약 발송');}
  }
}

// ===== SETTINGS =====
function chPw(){
  const c=document.getElementById('cpw').value,n=document.getElementById('npw').value;
  if(!curAdmin){toast('로그인 필요','e');return;}
  const acc=adminAccounts.find(a=>a.id===curAdmin.id);
  if(!acc){toast('계정 오류','e');return;}
  if(c!==acc.pw){toast('현재 비번 오류','e');return;}
  if(!n){toast('새 비번 입력','e');return;}
  acc.pw=n;svAdmins();
  addLog('수정',`${curAdmin.name} 비밀번호 변경`);
  toast('✅ 변경 완료','s');
  document.getElementById('cpw').value='';document.getElementById('npw').value='';
}

function changeAdminPhoto(idx){
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=function(){
    const file=this.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(e){
      adminAccounts[idx].photo=e.target.result;
      svAdmins();renderAdminMgmt();toast('📷 프로필 사진 변경됨','s');
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

function getAdminInfo(name){
  return adminAccounts.find(a=>a.name===name)||null;
}
function hasPerm(key){
  if(!curAdmin)return false;
  if(curAdmin.role==='master')return true;
  const acc=adminAccounts.find(a=>a.id===curAdmin.id);
  if(!acc)return false;
  if(!acc.perms)return true; // no perms set = all allowed (legacy)
  return !!acc.perms[key];
}

function addAdmin(){
  if(!curAdmin||curAdmin.role!=='master'){toast('마스터만 가능합니다','e');return;}
  const name=document.getElementById('newAdmName').value.trim();
  const id=document.getElementById('newAdmId').value.trim();
  const pw=document.getElementById('newAdmPw').value;
  const title=document.getElementById('newAdmTitle')?.value.trim()||'';
  const phone=document.getElementById('newAdmPhone')?.value.trim()||'';
  if(!name||!id||!pw){toast('모든 항목을 입력하세요','e');return;}
  if(adminAccounts.find(a=>a.id===id)){toast('이미 존재하는 아이디입니다','e');return;}
  adminAccounts.push({id,name,pw,role:'admin',title,phone,created:td()});
  svAdmins();
  addLog('입력',`관리자 추가: ${name}(${id})`);
  toast(`✅ ${name} 관리자 추가 완료`,'s');
  document.getElementById('newAdmName').value='';document.getElementById('newAdmId').value='';document.getElementById('newAdmPw').value='';
  if(document.getElementById('newAdmTitle'))document.getElementById('newAdmTitle').value='';
  if(document.getElementById('newAdmPhone'))document.getElementById('newAdmPhone').value='';
  renderAdminMgmt();
}

function removeAdmin(i){
  if(!curAdmin||curAdmin.role!=='master'){toast('마스터만 가능합니다','e');return;}
  const a=adminAccounts[i];
  if(!a||a.role==='master'){toast('마스터는 삭제할 수 없습니다','e');return;}
  addLog('삭제',`관리자 삭제: ${a.name}(${a.id})`);
  adminAccounts.splice(i,1);svAdmins();
  toast(`🗑️ ${a.name} 관리자 삭제`,'i');
  renderAdminMgmt();
}

function promoteAdmin(i){
  if(!curAdmin||curAdmin.role!=='master'){toast('마스터만 가능합니다','e');return;}
  const a=adminAccounts[i];if(!a)return;
  // Demote current master
  const curMaster=adminAccounts.find(x=>x.role==='master');
  if(curMaster)curMaster.role='admin';
  a.role='master';
  svAdmins();
  curAdmin.role='admin';
  addLog('수정',`마스터 권한 이전: ${a.name}에게 마스터 임명`);
  toast(`👑 ${a.name}님이 새 마스터로 임명되었습니다`,'s');
  renderAdminMgmt();
}
function rCs(){
  if(!window.courseInfo)window.courseInfo=JSON.parse(localStorage.getItem(FP+'courseInfo')||'{}');
  let html=cs.map((c,i)=>{
    const info=window.courseInfo[c]||{};
    const safeKey=c.replace(/[^a-zA-Z0-9가-힣]/g,'_');
    return `<div style="border:1px solid #eee;border-radius:10px;margin-bottom:8px;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fafaf8;">
        <span style="font-size:13px;font-weight:600;">${c}</span>
        <button class="btn bs" style="background:#fdd;color:#c00;" onclick="rmCs(${i})">삭제</button>
      </div>
      <div style="padding:8px 12px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <div style="flex:1;min-width:140px;"><label style="font-size:9px;color:#999;">🎬 시연영상 URL</label><input type="text" id="ci_v_${safeKey}" value="${info.video||''}" placeholder="YouTube 링크" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:11px;"></div>
        <div style="flex:1;min-width:140px;"><label style="font-size:9px;color:#999;">📝 블로그 링크</label><input type="text" id="ci_b_${safeKey}" value="${info.blog||''}" placeholder="블로그/소개 URL" style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:5px;font-size:11px;"></div>
        ${info.video?`<a href="${info.video}" target="_blank" style="font-size:9px;color:#1976d2;text-decoration:none;">▶ 미리보기</a>`:''}
        ${info.blog?`<a href="${info.blog}" target="_blank" style="font-size:9px;color:#e65100;text-decoration:none;">📖 블로그</a>`:''}
      </div>
    </div>`;
  }).join('');
  html+=`<div style="text-align:right;margin-top:8px;margin-bottom:12px;"><button onclick="saveAllCourseInfo()" class="btn bg" style="padding:8px 24px;font-size:12px;font-weight:700;">💾 링크 저장</button></div>`;
  document.getElementById('csList').innerHTML=html;
  // Also render form config
  renderFormCfgUI();
}

function renderFormCfgUI(){
  const fc=formCfg;
  const el=id=>document.getElementById(id);
  if(el('fc_pkgDesc'))el('fc_pkgDesc').value=fc.pkgDesc;
  if(el('fc_entryP1'))el('fc_entryP1').value=fc.entryP1;
  if(el('fc_entryP2'))el('fc_entryP2').value=fc.entryP2;
  if(el('fc_entryTea'))el('fc_entryTea').value=fc.entryTea;
  if(el('fc_freeRatioChild'))el('fc_freeRatioChild').value=fc.freeRatioChild;
  if(el('fc_freeRatioElem'))el('fc_freeRatioElem').value=fc.freeRatioElem;
  renderFormMealList();
  renderFormAddonList();
  renderFormChannelList();
}

function renderFormMealList(){
  const el=document.getElementById('fc_mealList');if(!el)return;
  if(!window.courseInfo)window.courseInfo=JSON.parse(localStorage.getItem(FP+'courseInfo')||'{}');
  el.innerHTML=formCfg.meals.map((m,i)=>{
    const key='meal_'+m.name;
    const safeKey=key.replace(/[^a-zA-Z0-9가-힣]/g,'_');
    const info=window.courseInfo[key]||{};
    return `
    <div style="border:1px solid #eee;border-radius:8px;margin-bottom:6px;overflow:hidden;">
      <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;flex-wrap:wrap;">
        <input value="${m.name}" onchange="formCfg.meals[${i}].name=this.value" style="flex:1;min-width:100px;padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;font-weight:600;">
        <span style="font-size:10px;color:#999;">유아</span>
        <input type="number" value="${m.p1}" onchange="formCfg.meals[${i}].p1=+this.value" style="width:70px;padding:5px 6px;font-size:12px;border:1px solid #ddd;border-radius:5px;text-align:right;">
        <span style="font-size:10px;color:#999;">초등</span>
        <input type="number" value="${m.p2}" onchange="formCfg.meals[${i}].p2=+this.value" style="width:70px;padding:5px 6px;font-size:12px;border:1px solid #ddd;border-radius:5px;text-align:right;">
        <button onclick="formCfg.meals.splice(${i},1);renderFormMealList();" style="background:#fdd;color:#c00;border:none;border-radius:5px;padding:4px 8px;font-size:11px;cursor:pointer;">✕</button>
      </div>
      <div style="padding:4px 10px 8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <div style="flex:1;min-width:120px;"><label style="font-size:9px;color:#999;">🎬 영상</label><input type="text" id="ci_v_${safeKey}" value="${info.video||''}" placeholder="YouTube 링크" style="width:100%;padding:3px 5px;border:1px solid #eee;border-radius:4px;font-size:10px;"></div>
        <div style="flex:1;min-width:120px;"><label style="font-size:9px;color:#999;">📝 블로그</label><input type="text" id="ci_b_${safeKey}" value="${info.blog||''}" placeholder="블로그 URL" style="width:100%;padding:3px 5px;border:1px solid #eee;border-radius:4px;font-size:10px;"></div>
        ${info.video?`<a href="${info.video}" target="_blank" style="font-size:9px;color:#1976d2;">▶</a>`:''}
        ${info.blog?`<a href="${info.blog}" target="_blank" style="font-size:9px;color:#e65100;">📖</a>`:''}
      </div>
    </div>`;
  }).join('');
}

function addFormMeal(){
  const name=document.getElementById('fc_newMealName').value.trim();
  const p1=parseInt(document.getElementById('fc_newMealP1').value)||0;
  const p2=parseInt(document.getElementById('fc_newMealP2').value)||0;
  if(!name){toast('메뉴명을 입력하세요','e');return;}
  formCfg.meals.push({name,p1,p2});
  document.getElementById('fc_newMealName').value='';document.getElementById('fc_newMealP1').value='';document.getElementById('fc_newMealP2').value='';
  renderFormMealList();
}

function renderFormAddonList(){
  const el=document.getElementById('fc_addonList');if(!el)return;
  if(!window.courseInfo)window.courseInfo=JSON.parse(localStorage.getItem(FP+'courseInfo')||'{}');
  el.innerHTML=formCfg.addons.map((a,i)=>{
    const key='addon_'+a.name;
    const safeKey=key.replace(/[^a-zA-Z0-9가-힣]/g,'_');
    const info=window.courseInfo[key]||{};
    return `
    <div style="border:1px solid #eee;border-radius:8px;margin-bottom:6px;overflow:hidden;">
      <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;">
        <input value="${a.name}" onchange="formCfg.addons[${i}].name=this.value" style="flex:1;padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;font-weight:600;">
        <span style="font-size:10px;color:#999;">₩</span>
        <input type="number" value="${a.price}" onchange="formCfg.addons[${i}].price=+this.value" style="width:80px;padding:5px 6px;font-size:12px;border:1px solid #ddd;border-radius:5px;text-align:right;">
        <button onclick="formCfg.addons.splice(${i},1);renderFormAddonList();" style="background:#fdd;color:#c00;border:none;border-radius:5px;padding:4px 8px;font-size:11px;cursor:pointer;">✕</button>
      </div>
      <div style="padding:4px 10px 8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <div style="flex:1;min-width:120px;"><label style="font-size:9px;color:#999;">🎬 영상</label><input type="text" id="ci_v_${safeKey}" value="${info.video||''}" placeholder="YouTube 링크" style="width:100%;padding:3px 5px;border:1px solid #eee;border-radius:4px;font-size:10px;"></div>
        <div style="flex:1;min-width:120px;"><label style="font-size:9px;color:#999;">📝 블로그</label><input type="text" id="ci_b_${safeKey}" value="${info.blog||''}" placeholder="블로그 URL" style="width:100%;padding:3px 5px;border:1px solid #eee;border-radius:4px;font-size:10px;"></div>
        ${info.video?`<a href="${info.video}" target="_blank" style="font-size:9px;color:#1976d2;">▶</a>`:''}
        ${info.blog?`<a href="${info.blog}" target="_blank" style="font-size:9px;color:#e65100;">📖</a>`:''}
      </div>
    </div>`;
  }).join('');
}

function saveCourseInfo(key,field,val){
  if(!window.courseInfo)window.courseInfo={};
  if(!window.courseInfo[key])window.courseInfo[key]={};
  window.courseInfo[key][field]=val.trim();
  localStorage.setItem(FP+'courseInfo',JSON.stringify(window.courseInfo));
}

function saveAllCourseInfo(){
  if(!window.courseInfo)window.courseInfo={};
  cs.forEach(c=>{
    const safeKey=c.replace(/[^a-zA-Z0-9가-힣]/g,'_');
    const vEl=document.getElementById('ci_v_'+safeKey);
    const bEl=document.getElementById('ci_b_'+safeKey);
    if(!window.courseInfo[c])window.courseInfo[c]={};
    if(vEl)window.courseInfo[c].video=vEl.value.trim();
    if(bEl)window.courseInfo[c].blog=bEl.value.trim();
  });
  localStorage.setItem(FP+'courseInfo',JSON.stringify(window.courseInfo));
}

function saveAllMealInfo(){
  if(!window.courseInfo)window.courseInfo={};
  formCfg.meals.forEach(m=>{
    const key='meal_'+m.name;
    const safeKey=key.replace(/[^a-zA-Z0-9가-힣]/g,'_');
    const vEl=document.getElementById('ci_v_'+safeKey);
    const bEl=document.getElementById('ci_b_'+safeKey);
    if(!window.courseInfo[key])window.courseInfo[key]={};
    if(vEl)window.courseInfo[key].video=vEl.value.trim();
    if(bEl)window.courseInfo[key].blog=bEl.value.trim();
  });
  localStorage.setItem(FP+'courseInfo',JSON.stringify(window.courseInfo));
}

function saveAllAddonInfo(){
  if(!window.courseInfo)window.courseInfo={};
  formCfg.addons.forEach(a=>{
    const key='addon_'+a.name;
    const safeKey=key.replace(/[^a-zA-Z0-9가-힣]/g,'_');
    const vEl=document.getElementById('ci_v_'+safeKey);
    const bEl=document.getElementById('ci_b_'+safeKey);
    if(!window.courseInfo[key])window.courseInfo[key]={};
    if(vEl)window.courseInfo[key].video=vEl.value.trim();
    if(bEl)window.courseInfo[key].blog=bEl.value.trim();
  });
  localStorage.setItem(FP+'courseInfo',JSON.stringify(window.courseInfo));
}

function addFormAddon(){
  const name=document.getElementById('fc_addonName').value.trim();
  const price=parseInt(document.getElementById('fc_addonPrice').value)||0;
  if(!name){toast('체험명을 입력하세요','e');return;}
  formCfg.addons.push({name,price});
  document.getElementById('fc_addonName').value='';document.getElementById('fc_addonPrice').value='';
  renderFormAddonList();
}

function renderFormChannelList(){
  const el=document.getElementById('fc_channelList');if(!el)return;
  el.innerHTML=formCfg.channels.map((c,i)=>`
    <div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid #eee;">
      <input value="${c}" onchange="formCfg.channels[${i}]=this.value" style="flex:1;padding:5px 8px;font-size:12px;border:1px solid #ddd;border-radius:5px;font-weight:600;">
      <button onclick="formCfg.channels.splice(${i},1);renderFormChannelList();" style="background:#fdd;color:#c00;border:none;border-radius:5px;padding:4px 8px;font-size:11px;cursor:pointer;">✕</button>
    </div>`).join('');
}

function addFormChannel(){
  const name=document.getElementById('fc_newChannel').value.trim();
  if(!name){toast('경로명을 입력하세요','e');return;}
  formCfg.channels.push(name);
  document.getElementById('fc_newChannel').value='';
  renderFormChannelList();
}

function saveFormConfig(){
  const el=id=>document.getElementById(id);
  formCfg.pkgDesc=el('fc_pkgDesc').value.trim()||formCfg.pkgDesc;
  formCfg.entryP1=parseInt(el('fc_entryP1').value)||formCfg.entryP1;
  formCfg.entryP2=parseInt(el('fc_entryP2').value)||formCfg.entryP2;
  formCfg.entryTea=parseInt(el('fc_entryTea').value)||formCfg.entryTea;
  formCfg.freeRatioChild=parseInt(el('fc_freeRatioChild').value)||formCfg.freeRatioChild;
  formCfg.freeRatioElem=parseInt(el('fc_freeRatioElem').value)||formCfg.freeRatioElem;
  saveFormCfgLS();
  // Also save all course/meal/addon media links
  saveAllCourseInfo();
  saveAllMealInfo();
  saveAllAddonInfo();
  toast('✅ 예약폼 설정이 저장되었습니다','s');
}
function addCs(){const n=document.getElementById('nCs').value.trim();if(!n)return;cs.push(n);svC();document.getElementById('nCs').value='';rCs();toast(`"${n}" 추가`,'s');}
function rmCs(i){cs.splice(i,1);svC();rCs();}

// ===== SYSTEM INFO & DIAGNOSTICS =====
function renderSysInfo(){
  const el=document.getElementById('sysInfoPanel');if(!el)return;
  const d=JAMSA.getDiagnostics(FP);
  let h=`
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:14px;">
      <div style="padding:10px;background:#e8f5e9;border-radius:10px;text-align:center;">
        <div style="font-size:10px;color:#666;">앱 버전</div>
        <div style="font-size:16px;font-weight:800;color:var(--p);">v${d.appVersion}</div>
      </div>
      <div style="padding:10px;background:#e3f2fd;border-radius:10px;text-align:center;">
        <div style="font-size:10px;color:#666;">빌드</div>
        <div style="font-size:16px;font-weight:800;color:#1565c0;">${d.build}</div>
      </div>
      <div style="padding:10px;background:#fff3e0;border-radius:10px;text-align:center;">
        <div style="font-size:10px;color:#666;">저장용량</div>
        <div style="font-size:16px;font-weight:800;color:#e65100;">${d.totalStorageKB}KB</div>
      </div>
      <div style="padding:10px;background:#f3e5f5;border-radius:10px;text-align:center;">
        <div style="font-size:10px;color:#666;">시설 코드</div>
        <div style="font-size:16px;font-weight:800;color:#7b1fa2;">${d.facilityPrefix}</div>
      </div>
    </div>
    <div style="font-size:12px;font-weight:700;color:#555;margin-bottom:8px;">📦 등록 모듈 (${d.modules.length}개)</div>
    <div style="display:flex;flex-direction:column;gap:6px;">`;
  d.modules.forEach(m=>{
    const status=m.needsMigration?'🔄 업데이트 필요':'✅ 최신';
    const statusColor=m.needsMigration?'#e65100':'#2e7d32';
    const keyList=m.storageKeys.map(k=>`<code style="font-size:9px;background:#f5f5f5;padding:1px 4px;border-radius:3px;">${FP}${k}</code>`).join(' ');
    h+=`<div style="padding:10px 12px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <span style="font-size:12px;font-weight:700;">${m.name}</span>
          <span style="font-size:9px;color:#888;margin-left:6px;">v${m.version}</span>
        </div>
        <span style="font-size:10px;color:${statusColor};font-weight:600;">${status}</span>
      </div>
      <div style="font-size:10px;color:#999;margin-top:3px;">스키마: v${m.currentVer}/${m.schemaVer} ${m.depends.length?'| 의존: '+m.depends.join(','):''}</div>
      <div style="margin-top:3px;">${keyList}</div>
    </div>`;
  });
  h+='</div>';
  h+=`<div style="margin-top:10px;font-size:10px;color:#aaa;">마지막 업데이트: ${d.lastUpdate}</div>`;
  el.innerHTML=h;
}

function showChangelog(){
  const el=document.getElementById('changelogPanel');if(!el)return;
  const hp=document.getElementById('healthCheckPanel');if(hp)hp.style.display='none';
  const isOpen=el.style.display!=='none';
  if(isOpen){el.style.display='none';return;}
  const logs=JAMSA._changelog;
  let h='';
  logs.forEach(log=>{
    h+=`<div style="padding:10px 12px;border-left:3px solid var(--p);margin-bottom:10px;background:#f9f9f9;border-radius:0 8px 8px 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <span style="font-size:13px;font-weight:800;color:var(--p);">v${log.version}</span>
        <span style="font-size:10px;color:#888;">${log.date}</span>
      </div>
      <ul style="margin:0;padding-left:18px;">
        ${log.changes.map(c=>`<li style="font-size:11px;color:#555;line-height:1.8;">${c}</li>`).join('')}
      </ul>
    </div>`;
  });
  el.innerHTML=h;
  el.style.display='block';
}

// ===== PATCH MANAGER =====
function renderPatchManager(){
  const el=document.getElementById('patchManagerPanel');if(!el)return;
  // 다른 패널 닫기
  const hp=document.getElementById('healthCheckPanel');if(hp)hp.style.display='none';
  const cp=document.getElementById('changelogPanel');if(cp)cp.style.display='none';

  if(el.style.display==='block'){el.style.display='none';return;}
  el.style.display='block';

  const patches=JAMSA.getAvailablePatches(FP);
  const applied=patches.filter(p=>p.applied).length;
  const pending=patches.filter(p=>!p.applied&&!p.failed).length;
  const failed=patches.filter(p=>p.failed).length;

  const typeIcon={fix:'🔧',feature:'✨',hotfix:'🚨',migration:'📦'};
  const typeLabel={fix:'버그수정',feature:'기능추가',hotfix:'긴급패치',migration:'마이그레이션'};

  let h=`
    <div style="padding:14px;background:linear-gradient(135deg,#f3e5f5,#e8eaf6);border-radius:12px;margin-bottom:12px;">
      <div style="font-size:15px;font-weight:800;color:#4a148c;margin-bottom:8px;">🩹 패치 관리</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="padding:8px 14px;background:#fff;border-radius:8px;font-size:12px;">
          <span style="color:#888;">전체</span> <b>${patches.length}</b>개
        </div>
        <div style="padding:8px 14px;background:#e8f5e9;border-radius:8px;font-size:12px;">
          <span style="color:#2e7d32;">✅ 적용</span> <b>${applied}</b>
        </div>
        <div style="padding:8px 14px;background:#fff3e0;border-radius:8px;font-size:12px;">
          <span style="color:#e65100;">⏳ 대기</span> <b>${pending}</b>
        </div>
        ${failed?`<div style="padding:8px 14px;background:#ffebee;border-radius:8px;font-size:12px;">
          <span style="color:#c62828;">❌ 실패</span> <b>${failed}</b>
        </div>`:''}
      </div>
      ${pending?`<button onclick="applyAllPatches()" style="margin-top:10px;padding:8px 20px;background:#6a1b9a;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">⚡ 대기 중인 패치 모두 적용 (${pending}개)</button>`:''}
    </div>`;

  if(!patches.length){
    h+=`<div style="text-align:center;padding:24px;color:#aaa;font-size:13px;">등록된 패치가 없습니다</div>`;
  }

  patches.forEach(p=>{
    const icon=typeIcon[p.type]||'🩹';
    const label=typeLabel[p.type]||p.type;
    let statusBadge,statusBg,actionBtn;

    if(p.applied){
      statusBadge='<span style="font-size:10px;padding:2px 8px;background:#c8e6c9;color:#2e7d32;border-radius:10px;font-weight:700;">✅ 적용됨</span>';
      statusBg='#f1f8e9';
      actionBtn=p.rollback||p.record?.backup
        ?`<button onclick="rollbackPatch('${p.id}')" style="padding:4px 10px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;">↩ 되돌리기</button>`
        :'<span style="font-size:9px;color:#aaa;">되돌리기 불가</span>';
    } else if(p.failed){
      statusBadge='<span style="font-size:10px;padding:2px 8px;background:#ffcdd2;color:#c62828;border-radius:10px;font-weight:700;">❌ 실패</span>';
      statusBg='#fff8e1';
      actionBtn=`<button onclick="applyOnePatch('${p.id}')" style="padding:4px 10px;background:#fff3e0;color:#e65100;border:1px solid #ffcc80;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;">🔄 재시도</button>`;
    } else if(p.rolledback){
      statusBadge='<span style="font-size:10px;padding:2px 8px;background:#e0e0e0;color:#555;border-radius:10px;font-weight:700;">↩ 롤백됨</span>';
      statusBg='#fafafa';
      actionBtn=`<button onclick="applyOnePatch('${p.id}')" style="padding:4px 10px;background:#e8eaf6;color:#283593;border:1px solid #9fa8da;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;">▶ 다시 적용</button>`;
    } else {
      statusBadge='<span style="font-size:10px;padding:2px 8px;background:#fff3e0;color:#e65100;border-radius:10px;font-weight:700;">⏳ 대기</span>';
      statusBg='#fff';
      actionBtn=`<button onclick="applyOnePatch('${p.id}')" style="padding:4px 10px;background:#e8f5e9;color:#2e7d32;border:1px solid #a5d6a7;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;">▶ 적용</button>`;
    }

    h+=`<div style="padding:12px;border:1px solid #e0e0e0;border-radius:10px;margin-bottom:8px;background:${statusBg};">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <span style="font-size:13px;font-weight:700;">${icon} ${p.title}</span>
            ${statusBadge}
            ${p.breaking?'<span style="font-size:9px;padding:1px 5px;background:#ffebee;color:#c62828;border-radius:4px;">⚠ 데이터변경</span>':''}
          </div>
          <div style="font-size:10px;color:#888;margin-top:4px;">
            <code style="background:#f5f5f5;padding:1px 4px;border-radius:3px;">${p.id}</code>
            · ${label}
            · 모듈: ${p.module}
            · ${p.date}
          </div>
          ${p.description?`<div style="font-size:11px;color:#666;margin-top:4px;line-height:1.5;">${p.description}</div>`:''}
          ${p.record?.error?`<div style="font-size:10px;color:#c62828;margin-top:4px;">오류: ${p.record.error}</div>`:''}
          ${p.record?.ts?`<div style="font-size:9px;color:#aaa;margin-top:2px;">${p.applied?'적용':p.failed?'실패':'롤백'}: ${new Date(p.record.ts).toLocaleString('ko')}</div>`:''}
        </div>
        <div style="flex-shrink:0;">${actionBtn}</div>
      </div>
    </div>`;
  });

  h+=`<div style="margin-top:8px;text-align:right;">
    <button onclick="document.getElementById('patchManagerPanel').style.display='none'" style="padding:6px 14px;background:#eee;color:#555;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;">닫기</button>
  </div>`;

  el.innerHTML=h;
}

function applyOnePatch(id){
  const result=JAMSA.applyPatch(FP,id);
  if(result.ok){
    toast('✅ 패치 적용 완료: '+id,'s');
    addLog('시스템','패치 적용: '+id);
  } else {
    toast('❌ 패치 실패: '+result.error,'e');
    addLog('시스템','패치 실패: '+id+' — '+result.error);
  }
  renderPatchManager();
  renderSysInfo();
}

function applyAllPatches(){
  const patches=JAMSA.getAvailablePatches(FP);
  const pending=patches.filter(p=>!p.applied&&!p.failed);
  let ok=0,fail=0;
  pending.forEach(p=>{
    const r=JAMSA.applyPatch(FP,p.id);
    if(r.ok)ok++;else fail++;
  });
  if(ok)toast(`✅ ${ok}개 패치 적용 완료`+(fail?` (${fail}개 실패)`:''),'s');
  if(fail&&!ok)toast(`❌ ${fail}개 패치 모두 실패`,'e');
  addLog('시스템',`패치 일괄 적용: 성공 ${ok}, 실패 ${fail}`);
  renderPatchManager();
  renderSysInfo();
}

function rollbackPatch(id){
  const result=JAMSA.rollbackPatch(FP,id);
  if(result.ok){
    toast('↩ 패치 롤백 완료: '+id,'s');
    addLog('시스템','패치 롤백: '+id);
  } else {
    toast('❌ 롤백 실패: '+result.error,'e');
  }
  renderPatchManager();
  renderSysInfo();
}

// ===== HEALTH CHECK =====
function runHealthCheck(){
  const el=document.getElementById('healthCheckPanel');if(!el)return;
  const cp=document.getElementById('changelogPanel');if(cp)cp.style.display='none';
  el.style.display='block';
  el.innerHTML='<div style="padding:20px;text-align:center;color:#888;font-size:13px;">⏳ 점검 중...</div>';

  setTimeout(()=>{
    const results=[];
    const t0=performance.now();

    // ── 1) 코어: localStorage 읽기/쓰기 ──
    results.push(hcTest('코어','localStorage 읽기/쓰기',()=>{
      const tk='__hc_'+Date.now();
      localStorage.setItem(tk,'ok');
      const v=localStorage.getItem(tk);
      localStorage.removeItem(tk);
      if(v!=='ok') throw 'write/read 실패';
    }));

    // ── 2) 코어: 예약 데이터 무결성 ──
    results.push(hcTest('코어','예약 데이터 ('+FP+'bk)',()=>{
      const raw=localStorage.getItem(FP+'bk');
      if(!raw) return '데이터 없음 (정상 — 신규)';
      const arr=JSON.parse(raw);
      if(!Array.isArray(arr)) throw '배열이 아닙니다';
      const bad=arr.filter(b=>!b.date||!b.name);
      if(bad.length) throw bad.length+'건 필수필드 누락';
      return arr.length+'건 정상';
    }));

    // ── 3) 코어: formCfg 로드 ──
    results.push(hcTest('코어','예약폼 설정 ('+FP+'formcfg)',()=>{
      const raw=localStorage.getItem(FP+'formcfg');
      if(!raw) return '기본값 사용 중';
      const cfg=JSON.parse(raw);
      if(!cfg.meals||!Array.isArray(cfg.meals)) throw 'meals 배열 없음';
      return '식사 '+cfg.meals.length+'종, 부가 '+(cfg.addons?.length||0)+'종';
    }));

    // ── 4) 코어: 일일제한 ──
    results.push(hcTest('코어','일일 제한 ('+FP+'daylimits)',()=>{
      const raw=localStorage.getItem(FP+'daylimits');
      if(!raw||raw==='{}') return '설정 없음 (정상)';
      const dl=JSON.parse(raw);
      return Object.keys(dl).length+'일 설정됨';
    }));

    // ── 5) 관리자: 계정 ──
    results.push(hcTest('관리자','관리자 계정 ('+FP+'admins)',()=>{
      const raw=localStorage.getItem(FP+'admins');
      if(!raw) throw '계정 데이터 없음';
      const arr=JSON.parse(raw);
      if(!Array.isArray(arr)||!arr.length) throw '계정 0명';
      const master=arr.filter(a=>a.role==='master');
      if(!master.length) throw '마스터 계정 없음';
      return '총 '+arr.length+'명 (마스터 '+master.length+'명)';
    }));

    // ── 6) 관리자: 활동로그 ──
    results.push(hcTest('관리자','활동 로그 ('+FP+'actlog)',()=>{
      const raw=localStorage.getItem(FP+'actlog');
      if(!raw) return '로그 없음';
      const arr=JSON.parse(raw);
      return arr.length+'건 기록됨';
    }));

    // ── 7) 대행사 ──
    results.push(hcTest('대행사','대행사 목록 ('+FP+'agencies)',()=>{
      const raw=localStorage.getItem(FP+'agencies');
      if(!raw||raw==='[]') return '등록된 대행사 없음';
      const arr=JSON.parse(raw);
      return arr.length+'개 등록됨';
    }));

    // ── 8) 채팅: 데이터 구조 ──
    results.push(hcTest('채팅','채팅 데이터 ('+FP+'chats)',()=>{
      const raw=localStorage.getItem(FP+'chats');
      if(!raw||raw==='{}') return '채팅 없음';
      const data=JSON.parse(raw);
      const rooms=Object.keys(data).length;
      let msgs=0;
      Object.values(data).forEach(r=>{if(r.msgs)msgs+=r.msgs.length;});
      return rooms+'개 채팅방, '+msgs+'건 메시지';
    }));

    // ── 9) FAQ: 데이터 + 스키마 ──
    results.push(hcTest('FAQ','FAQ 데이터 ('+FP+'chatfaq)',()=>{
      const raw=localStorage.getItem(FP+'chatfaq');
      if(!raw) throw 'FAQ 데이터 없음';
      const arr=JSON.parse(raw);
      if(!Array.isArray(arr)) throw '배열이 아닙니다';
      const noMedia=arr.filter(f=>!Array.isArray(f.media));
      if(noMedia.length) throw noMedia.length+'건 media 필드 누락 (마이그레이션 필요)';
      const totalMedia=arr.reduce((s,f)=>s+(f.media?.length||0),0);
      return arr.length+'개 항목, 미디어 '+totalMedia+'개';
    }));

    // ── 10) FAQ: 미디어 무결성 ──
    results.push(hcTest('FAQ','FAQ 미디어 검증',()=>{
      const faq=JSON.parse(localStorage.getItem(FP+'chatfaq')||'[]');
      let imgOk=0,vidOk=0,errors=[];
      faq.forEach((f,fi)=>{
        (f.media||[]).forEach((m,mi)=>{
          if(m.type==='image'){
            if(!m.data) errors.push(`[${fi}][${mi}] 이미지 data 없음`);
            else if(!m.id) errors.push(`[${fi}][${mi}] id 없음`);
            else imgOk++;
          } else if(m.type==='video'){
            if(!m.url&&!m.originalUrl) errors.push(`[${fi}][${mi}] 영상 URL 없음`);
            else if(!m.thumb) errors.push(`[${fi}][${mi}] 썸네일 없음`);
            else vidOk++;
          }
        });
      });
      if(errors.length) throw errors.length+'건 오류: '+errors[0];
      return '사진 '+imgOk+'장, 영상 '+vidOk+'개 정상';
    }));

    // ── 11) FAQ: 용량 정책 준수 ──
    results.push(hcTest('FAQ','용량 정책 (1.5MB/항목당 5개)',()=>{
      const faq=JSON.parse(localStorage.getItem(FP+'chatfaq')||'[]');
      let warnings=[];
      faq.forEach((f,i)=>{
        if((f.media||[]).length>FAQ_POLICY.maxMediaPerItem)
          warnings.push(`"${f.title}" 미디어 ${f.media.length}개 > ${FAQ_POLICY.maxMediaPerItem}`);
        (f.media||[]).forEach(m=>{
          if(m.type==='image'&&m.size>FAQ_POLICY.maxImgBytes)
            warnings.push(`"${f.title}" ${m.name} ${(m.size/1024/1024).toFixed(1)}MB 초과`);
        });
      });
      if(warnings.length) throw warnings.join(', ');
      return '모든 항목 정책 준수';
    }));

    // ── 12) 일정: 저장 데이터 ──
    results.push(hcTest('일정','일정 데이터 ('+FP+'sch)',()=>{
      const raw=localStorage.getItem(FP+'sch');
      if(!raw||raw==='{}') return '저장된 일정 없음';
      const data=JSON.parse(raw);
      return Object.keys(data).length+'개 날짜 저장됨';
    }));

    // ── 13) 일정: 자동배정 규칙 ──
    results.push(hcTest('일정','자동배정 규칙 ('+FP+'schrules)',()=>{
      const raw=localStorage.getItem(FP+'schrules');
      if(!raw||raw==='[]') return '규칙 없음';
      const arr=JSON.parse(raw);
      return arr.length+'개 규칙';
    }));

    // ── 14) 코스 미디어 ──
    results.push(hcTest('코스 미디어','코스 링크 ('+FP+'courseInfo)',()=>{
      const raw=localStorage.getItem(FP+'courseInfo');
      if(!raw||raw==='{}') return '설정 없음';
      const data=JSON.parse(raw);
      let cnt=0;
      ['courses','meals','addons'].forEach(k=>{
        if(data[k])Object.values(data[k]).forEach(v=>{if(v.videoUrl||v.blogUrl)cnt++;});
      });
      return cnt+'개 항목에 링크 설정됨';
    }));

    // ── 15) 전체: 저장 용량 ──
    results.push(hcTest('전체','localStorage 총 용량',()=>{
      let total=0;
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k.startsWith(FP)){
          total+=localStorage.getItem(k).length*2;
        }
      }
      const kb=Math.round(total/1024);
      const mb=(total/1024/1024).toFixed(2);
      if(total>4.5*1024*1024) throw `${mb}MB — 5MB 한계 근접!`;
      if(total>3*1024*1024) return `⚠️ ${kb}KB (${mb}MB) — 여유 부족`;
      return `${kb}KB (${mb}MB) — 여유 충분`;
    }));

    // ── 16) 함수 존재 확인 ──
    results.push(hcTest('전체','핵심 함수 존재 확인',()=>{
      const fns=['migrateFaq','validateFaqItem','validateMedia','validateFileBeforeUpload',
        'validateYoutubeUrl','extractYtId','extractYtThumb','saveChatFaq','addFaqMedia',
        'removeFaqMedia','replaceFaqMedia','moveFaqMedia','showFaqImageModal','renderFaqMgmt',
        'renderSysInfo','addLog','toast'];
      const missing=fns.filter(f=>typeof window[f]!=='function');
      if(missing.length) throw missing.length+'개 누락: '+missing.join(', ');
      return fns.length+'개 함수 모두 정상';
    }));

    const elapsed=Math.round(performance.now()-t0);
    const pass=results.filter(r=>r.status==='pass').length;
    const warn=results.filter(r=>r.status==='warn').length;
    const fail=results.filter(r=>r.status==='fail').length;

    let h=`<div style="padding:14px;background:${fail?'#ffebee':warn?'#fff8e1':'#e8f5e9'};border-radius:12px;margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:15px;font-weight:800;color:${fail?'#c62828':warn?'#e65100':'#2e7d32'};">
          ${fail?'❌ 점검 완료 — 문제 발견':'⚠️ 점검 결과'===warn?'⚠️':'✅ 모든 모듈 정상'}
        </div>
        <div style="font-size:11px;color:#888;">${elapsed}ms</div>
      </div>
      <div style="display:flex;gap:12px;margin-top:8px;">
        <span style="font-size:12px;font-weight:700;color:#2e7d32;">✅ ${pass}개 통과</span>
        ${warn?`<span style="font-size:12px;font-weight:700;color:#e65100;">⚠️ ${warn}개 경고</span>`:''}
        ${fail?`<span style="font-size:12px;font-weight:700;color:#c62828;">❌ ${fail}개 실패</span>`:''}
      </div>
    </div>`;

    // 실패 먼저, 경고, 통과 순
    const sorted=[...results].sort((a,b)=>{
      const ord={fail:0,warn:1,pass:2};
      return (ord[a.status]||2)-(ord[b.status]||2);
    });

    sorted.forEach(r=>{
      const icon=r.status==='pass'?'✅':r.status==='warn'?'⚠️':'❌';
      const bg=r.status==='pass'?'#f1f8e9':r.status==='warn'?'#fff8e1':'#ffebee';
      const bd=r.status==='pass'?'#c5e1a5':r.status==='warn'?'#ffe082':'#ef9a9a';
      h+=`<div style="padding:8px 12px;margin-bottom:4px;border-left:3px solid ${bd};background:${bg};border-radius:0 8px 8px 0;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div>
            <span style="font-size:11px;font-weight:700;color:#555;">${icon} ${r.module}</span>
            <span style="font-size:10px;color:#888;margin-left:4px;">${r.name}</span>
          </div>
          <span style="font-size:10px;color:#aaa;">${r.ms}ms</span>
        </div>
        <div style="font-size:11px;color:${r.status==='fail'?'#c62828':'#555'};margin-top:2px;">${r.detail}</div>
      </div>`;
    });

    h+=`<div style="margin-top:10px;text-align:center;">
      <button onclick="runHealthCheck()" style="padding:6px 14px;background:var(--p);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">🔄 다시 점검</button>
      <button onclick="document.getElementById('healthCheckPanel').style.display='none'" style="padding:6px 14px;background:#eee;color:#555;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;margin-left:6px;">닫기</button>
    </div>`;

    el.innerHTML=h;
  },100);
}

function hcTest(module,name,fn){
  const t0=performance.now();
  try{
    const detail=fn();
    return{module,name,status:detail&&String(detail).includes('⚠️')?'warn':'pass',detail:detail||'정상',ms:Math.round(performance.now()-t0)};
  }catch(e){
    return{module,name,status:'fail',detail:String(e),ms:Math.round(performance.now()-t0)};
  }
}

// ===== UTIL =====
function toast(m,t='s'){const c=document.getElementById('tw');const el=document.createElement('div');el.className=`toast ${t}`;el.innerHTML=m;c.appendChild(el);setTimeout(()=>{el.style.animation='none';el.style.opacity='0';el.style.transform='translateX(100%)';el.style.transition='all .3s';setTimeout(()=>el.remove(),300);},3500);}
function dl(c,f){try{const blob=new Blob(['\uFEFF'+c],{type:'application/vnd.ms-excel;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=f;a.style.display='none';document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);document.body.removeChild(a);},300);}catch(e){toast('다운로드 실패','e');}}

// Init on load
if(mode==='admin'){
  checkDailyAdmin();
  // Unanswered chat notification
  setTimeout(function(){
    initChatFromBookings();
    const rooms=Object.values(chatData);
    const unanswered=rooms.filter(r=>{
      if(!r.msgs||!r.msgs.length)return false;
      const realMsgs=r.msgs.filter(m=>m.from!=='system');
      if(!realMsgs.length)return false;
      const last=realMsgs[realMsgs.length-1];
      return last.from==='customer';
    });
    if(unanswered.length){
      const listHtml=unanswered.slice(0,5).map(r=>{
        const lastMsg=r.msgs.filter(m=>m.from==='customer').pop();
        const preview=lastMsg?(lastMsg.text.length>20?lastMsg.text.slice(0,20)+'...':lastMsg.text):'';
        const timeAgo=lastMsg?formatChatTime(lastMsg.ts):'';
        return `<div onclick="document.getElementById('chatAlertModal').style.display='none';gpNav('at');setTimeout(()=>openChat('${r.id}'),200);" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;transition:background .12s;" onmouseenter="this.style.background='#e8f5e9'" onmouseleave="this.style.background='transparent'">
          <div style="width:32px;height:32px;border-radius:50%;background:#f44336;color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;">${r.name.charAt(0)}</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:12px;font-weight:700;color:#333;">${r.name} <span style="font-size:9px;color:#aaa;font-weight:400;">${timeAgo}</span></div>
            <div style="font-size:11px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${preview}</div>
          </div>
          <span style="font-size:9px;color:#1565c0;white-space:nowrap;">답변하기 →</span>
        </div>`;
      }).join('');
      const moreText=unanswered.length>5?`<div style="text-align:center;font-size:10px;color:#aaa;padding:4px;">외 ${unanswered.length-5}건 더...</div>`:'';
      const modal=document.createElement('div');
      modal.id='chatAlertModal';
      modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:9999;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML=`<div style="background:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.25);width:380px;max-width:90vw;overflow:hidden;animation:fadeIn .3s;">
        <div style="background:linear-gradient(135deg,#f44336,#d32f2f);padding:16px 20px;color:#fff;display:flex;align-items:center;gap:10px;">
          <span style="font-size:28px;">💬</span>
          <div>
            <div style="font-size:15px;font-weight:900;">미답변 채팅 ${unanswered.length}건</div>
            <div style="font-size:11px;opacity:.85;">고객이 답변을 기다리고 있습니다</div>
          </div>
        </div>
        <div style="padding:10px 12px;max-height:250px;overflow-y:auto;">${listHtml}${moreText}</div>
        <div style="padding:10px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end;">
          <button onclick="document.getElementById('chatAlertModal').style.display='none'" style="padding:8px 16px;border:1px solid #ddd;background:#fff;border-radius:8px;font-size:12px;cursor:pointer;color:#666;">나중에</button>
          <button onclick="document.getElementById('chatAlertModal').style.display='none';gpNav('at');" style="padding:8px 16px;border:none;background:#f44336;color:#fff;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">채팅 전체보기</button>
        </div>
      </div>`;
      document.body.appendChild(modal);
      modal.addEventListener('click',function(e){if(e.target===modal)modal.style.display='none';});
    }
  },800);
}

// Keyboard shortcuts: Ctrl+Z = undo, Ctrl+Y = redo
document.addEventListener('keydown',function(e){
  if(mode!=='admin')return;
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undo();}
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redo();}
});


// ============================================================================
// SUPABASE BACKEND API — 자동 삽입됨
// ============================================================================
// ============================================================================
//  잠사박물관 예약시스템 — Supabase 풀백엔드 API
//  파일명: supabase_backend_api.js
// ============================================================================
//  적용 방법:
//    1. HTML head에 Supabase CDN 추가
//    2. HTML 본문 스크립트 끝 직전에 이 파일 삽입
//    3. 아래 SUPABASE_URL / SUPABASE_ANON_KEY 교체
//
//  동작 원리 — Write-Through Cache:
//    읽기: localStorage(캐시) 우선 사용
//    쓰기: localStorage + Supabase 동시 저장 (debounced)
//    초기화: Supabase → localStorage 캐시 동기화
//    실시간: Supabase Realtime → 다른 관리자 변경사항 자동 반영
// ============================================================================

;(function(){
'use strict';

// ★ 본인 Supabase 프로젝트 정보로 교체하세요 ★
const SB_URL = window.__SB_URL || 'https://YOUR_PROJECT_ID.supabase.co';
const SB_KEY = window.__SB_KEY || 'YOUR_ANON_KEY';
const FAC    = 'jp';

// 미설정 감지
if (SB_URL.includes('YOUR_PROJECT_ID')) {
  console.log('[SB] localStorage 전용 모드');
  return;
}
if (typeof supabase === 'undefined' || !supabase.createClient) {
  console.error('[SB] ❌ supabase-js 미로드. <head>에 CDN을 추가하세요:');
  console.error('  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"><\/script>');
  return;
}

const sb = supabase.createClient(SB_URL, SB_KEY);
window._supabase = sb; // 디버깅용

// localStorage 원본 보존 (프록시에서 사용)
const _lsSet = localStorage.setItem.bind(localStorage);
const _lsGet = localStorage.getItem.bind(localStorage);
const _lsRem = localStorage.removeItem.bind(localStorage);

// ============================================================================
// A. 유틸
// ============================================================================
const _T = {};
function debounce(key, fn, ms) { clearTimeout(_T[key]); _T[key] = setTimeout(fn, ms || 400); }
function err(ctx, e) { console.error('[SB:'+ctx+']', e?.message || e); }
function fp() { return typeof FP !== 'undefined' ? FP : 'jp_'; }

// ============================================================================
// B. Booking 변환
// ============================================================================
function bkFromRow(r) {
  return {
    id: r.id, date: r.date, name: r.name, phone: r.phone,
    arrival: r.arrival, departure: r.departure,
    students: r.students||0, teachers: r.teachers||0,
    studentsChild: r.students_child||0, studentsElem: r.students_elem||0,
    ageGroup: r.age_group||'유아', courseType: r.course_type||'기본코스',
    meal: r.meal||'이용안함', addons: r.addons||[],
    status: r.status||'접수', etc: r.etc,
    agency: r.agency, agencyName: r.agency_name,
    channel: r.channel, category: r.category,
    paidAmount: r.paid_amount,
    actualStudents: r.actual_students, actualTeachers: r.actual_teachers,
    actualStudentsChild: r.actual_students_child, actualStudentsElem: r.actual_students_elem,
    actualAddons: r.actual_addons, actualMeal: r.actual_meal,
    actualAddonQty: r.actual_addon_qty, actualEntryPrices: r.actual_entry_prices,
    actualMealQty: r.actual_meal_qty,
    created: r.created
  };
}
function bkToRow(b) {
  return {
    facility_code: FAC, date: b.date, name: b.name, phone: b.phone||null,
    arrival: b.arrival, departure: b.departure,
    students: b.students||0, teachers: b.teachers||0,
    students_child: b.studentsChild||0, students_elem: b.studentsElem||0,
    age_group: b.ageGroup||'유아', course_type: b.courseType||'기본코스',
    meal: b.meal||'이용안함', addons: b.addons||[],
    status: b.status||'접수', etc: b.etc||null,
    agency: b.agency||null, agency_name: b.agencyName||null,
    channel: b.channel||null, category: b.category||'미분류',
    paid_amount: b.paidAmount??null,
    actual_students: b.actualStudents??null, actual_teachers: b.actualTeachers??null,
    actual_students_child: b.actualStudentsChild??null, actual_students_elem: b.actualStudentsElem??null,
    actual_addons: b.actualAddons||null, actual_meal: b.actualMeal||null,
    actual_addon_qty: b.actualAddonQty||null, actual_entry_prices: b.actualEntryPrices||null,
    actual_meal_qty: b.actualMealQty||null,
    created: b.created || new Date().toISOString().split('T')[0]
  };
}

// ============================================================================
// C. CRUD API 객체
// ============================================================================
const API = window.SB = {

  // ── 예약 ──
  async loadBookings() {
    const{data,error}=await sb.from('bookings').select('*').eq('facility_code',FAC).order('date');
    if(error){err('loadBk',error);return null;} return(data||[]).map(bkFromRow);
  },
  async saveAllBookings(arr) {
    if(!arr||!arr.length)return;
    const rows=arr.map(b=>{const r=bkToRow(b);r.id=b.id;return r;});
    for(let i=0;i<rows.length;i+=500){
      const{error}=await sb.from('bookings').upsert(rows.slice(i,i+500),{onConflict:'id'});
      if(error)err('saveBk',error);
    }
  },
  async deleteBooking(id) {
    await sb.from('bookings').delete().eq('id',id);
  },

  // ── 관리자 ──
  async loadAdmins() {
    const{data}=await sb.from('admin_accounts').select('*').eq('facility_code',FAC).order('created_at');
    return data||[];
  },
  async saveAllAdmins(arr) {
    const rows=arr.map(a=>({id:a.id,facility_code:FAC,name:a.name,pw:a.pw,
      role:a.role||'staff',title:a.title||null,phone:a.phone||null,
      photo:a.photo||null,perms:a.perms||{},created_at:a.created||null}));
    const{error}=await sb.from('admin_accounts').upsert(rows,{onConflict:'id'});
    if(error)err('saveAdm',error);
  },

  // ── 활동 장소 ──
  async loadActivities() {
    const{data}=await sb.from('activities').select('name').eq('facility_code',FAC).order('sort_order');
    return(data||[]).map(r=>r.name);
  },
  async saveActivities(arr) {
    await sb.from('activities').delete().eq('facility_code',FAC);
    if(arr&&arr.length){
      const{error}=await sb.from('activities').insert(arr.map((n,i)=>({facility_code:FAC,name:n,sort_order:i})));
      if(error)err('saveAct',error);
    }
  },

  // ── 여행사 ──
  async loadAgencies() {
    const{data}=await sb.from('agencies').select('*').eq('facility_code',FAC);
    return data||[];
  },
  async saveAllAgencies(arr) {
    await sb.from('agencies').delete().eq('facility_code',FAC);
    if(arr&&arr.length){
      const rows=arr.map(a=>({facility_code:FAC,code:a.code,name:a.name,contact:a.contact||null,
        phone:a.phone||null,email:a.email||null,memo:a.memo||null,commission:a.commission||0}));
      const{error}=await sb.from('agencies').insert(rows);
      if(error)err('saveAg',error);
    }
  },

  // ── 여행사 사업자/은행 정보 ──
  async loadAgBizInfo(code) {
    const{data}=await sb.from('agency_biz_info').select('biz_data,bank_data')
      .eq('facility_code',FAC).eq('agency_code',code).maybeSingle();
    return data||{biz_data:{},bank_data:{}};
  },
  async saveAgBizData(code,bizData) {
    const cur=await this.loadAgBizInfo(code);
    await sb.from('agency_biz_info').upsert({facility_code:FAC,agency_code:code,
      biz_data:bizData,bank_data:cur.bank_data||{}},{onConflict:'facility_code,agency_code'});
  },
  async saveAgBankData(code,bankData) {
    const cur=await this.loadAgBizInfo(code);
    await sb.from('agency_biz_info').upsert({facility_code:FAC,agency_code:code,
      biz_data:cur.biz_data||{},bank_data:bankData},{onConflict:'facility_code,agency_code'});
  },

  // ── 여행사 정산 ──
  async loadAgSettle(code) {
    const{data}=await sb.from('agency_settlements').select('month,data')
      .eq('facility_code',FAC).eq('agency_code',code);
    const r={};(data||[]).forEach(d=>{r[d.month]=d.data;});return r;
  },
  async saveAgSettle(code,settlesObj) {
    for(const[month,d]of Object.entries(settlesObj||{})){
      await sb.from('agency_settlements').upsert({facility_code:FAC,agency_code:code,
        month,data:d},{onConflict:'facility_code,agency_code,month'});
    }
  },

  // ── 여행사 엑셀 로그 ──
  async loadAgExportLogs() {
    const{data}=await sb.from('agency_export_logs').select('*')
      .eq('facility_code',FAC).order('created_at',{ascending:false}).limit(200);
    return data||[];
  },
  async saveAllAgExportLogs(arr) {
    await sb.from('agency_export_logs').delete().eq('facility_code',FAC);
    if(arr&&arr.length) await sb.from('agency_export_logs').insert(arr.map(l=>({facility_code:FAC,data:l})));
  },

  // ── 채팅방 ──
  async loadChatRooms() {
    const{data}=await sb.from('chat_rooms').select('*').eq('facility_code',FAC)
      .order('updated_at',{ascending:false});
    return data||[];
  },
  async saveChatRoom(r) {
    await sb.from('chat_rooms').upsert({id:r.id,facility_code:FAC,name:r.name,
      phone:r.phone||null,status:r.status||'active',starred:r.starred||false,
      blocked:r.blocked||false,last_msg:r.lastMsg||null},{onConflict:'id'});
  },
  async loadChatMessages(roomId) {
    const{data}=await sb.from('chat_messages').select('*').eq('room_id',roomId).order('created_at');
    return(data||[]).map(m=>({from:m.sender,text:m.text,ts:new Date(m.created_at).getTime(),
      edited:m.edited,deleted:m.deleted,_dbId:m.id}));
  },
  async addChatMessage(roomId,msg) {
    await sb.from('chat_messages').insert({room_id:roomId,sender:msg.from,text:msg.text});
    await sb.from('chat_rooms').update({last_msg:(msg.text||'').substring(0,100),
      last_msg_at:new Date().toISOString(),status:'active'}).eq('id',roomId);
  },

  // ── 채팅 FAQ ──
  async loadChatFaq() {
    const{data}=await sb.from('chat_faq').select('*').eq('facility_code',FAC).order('sort_order');
    return(data||[]).map(f=>({q:f.question,a:f.answer}));
  },
  async saveChatFaq(arr) {
    await sb.from('chat_faq').delete().eq('facility_code',FAC);
    if(arr&&arr.length) await sb.from('chat_faq').insert(
      arr.map((f,i)=>({facility_code:FAC,question:f.q||f.question||'',answer:f.a||f.answer||'',sort_order:i})));
  },

  // ── 활동 로그 ──
  async loadLogs(lim) {
    const{data}=await sb.from('activity_logs').select('*').eq('facility_code',FAC)
      .order('created_at',{ascending:false}).limit(lim||500);
    return(data||[]).map(l=>({action:l.action,desc:l.description,
      time:l.created_at?new Date(l.created_at).toLocaleString('ko-KR'):'',
      user:l.admin_name||'',snap:l.snapshot,reason:l.reason||null}));
  },
  async addLog(action,desc,snap,who,reason) {
    await sb.from('activity_logs').insert({facility_code:FAC,admin_name:who||'',
      action:action||'',description:desc||'',snapshot:snap||null,reason:reason||null});
  },
  async saveAllLogs(arr) {
    const rows=(arr||[]).map(l=>({facility_code:FAC,admin_name:l.user||l.who||'',
      action:l.action||'',description:l.desc||'',snapshot:l.snap||null,reason:l.reason||null}));
    for(let i=0;i<rows.length;i+=100) await sb.from('activity_logs').insert(rows.slice(i,i+100));
  },

  // ── 폼 설정 ──
  async loadFormConfig() {
    const{data}=await sb.from('form_config').select('config').eq('facility_code',FAC).maybeSingle();
    return data?.config||null;
  },
  async saveFormConfig(cfg) {
    await sb.from('form_config').upsert({facility_code:FAC,config:cfg},{onConflict:'facility_code'});
  },

  // ── 저장된 일정표 ──
  async loadSavedSchedules() {
    const{data}=await sb.from('saved_schedules').select('date,schedule_data')
      .eq('facility_code',FAC).order('date',{ascending:false});
    const r={};(data||[]).forEach(d=>{r[d.date]=d.schedule_data;});return r;
  },
  async saveSchedule(date,d) {
    await sb.from('saved_schedules').upsert({facility_code:FAC,date,schedule_data:d},
      {onConflict:'facility_code,date'});
  },
  async deleteSchedule(date) {
    await sb.from('saved_schedules').delete().eq('facility_code',FAC).eq('date',date);
  },

  // ── 일정표 규칙 ──
  async loadScheduleRules() {
    const{data}=await sb.from('schedule_rules').select('*').eq('facility_code',FAC).order('id');
    return(data||[]).map(r=>({id:r.id,type:r.rule_type,group:r.group_target,
      time:r.time_slot==='all'?'all':parseInt(r.time_slot),dur:r.duration||1,
      act:r.activity,memo:r.memo}));
  },
  async saveAllScheduleRules(arr) {
    await sb.from('schedule_rules').delete().eq('facility_code',FAC);
    if(arr&&arr.length) await sb.from('schedule_rules').insert(
      arr.map(r=>({facility_code:FAC,rule_type:r.type,group_target:r.group||'all',
        time_slot:String(r.time??'all'),duration:r.dur||1,activity:r.act,memo:r.memo||null})));
  },

  // ── 일별 제한 ──
  async loadDayLimits() {
    const{data}=await sb.from('day_limits').select('*').eq('facility_code',FAC);
    const r={};(data||[]).forEach(d=>{r[d.date]={maxTeams:d.max_teams,maxPeople:d.max_people,
      closed:d.closed,memo:d.memo};});return r;
  },
  async saveAllDayLimits(obj) {
    await sb.from('day_limits').delete().eq('facility_code',FAC);
    const rows=Object.entries(obj||{}).map(([d,l])=>({facility_code:FAC,date:d,
      max_teams:l.maxTeams||null,max_people:l.maxPeople||null,closed:l.closed||false,memo:l.memo||null}));
    if(rows.length) await sb.from('day_limits').insert(rows);
  },

  // ── 자동발송 ──
  async loadAutoSendConfig() {
    const{data}=await sb.from('auto_send_config').select('config').eq('facility_code',FAC).maybeSingle();
    return data?.config||null;
  },
  async saveAutoSendConfig(cfg) {
    await sb.from('auto_send_config').upsert({facility_code:FAC,config:cfg},{onConflict:'facility_code'});
  },

  // ── 코스 미디어 ──
  async loadCourseInfo() {
    const{data}=await sb.from('course_info').select('key,video_url,blog_url').eq('facility_code',FAC);
    const r={};(data||[]).forEach(d=>{r[d.key]={video:d.video_url,blog:d.blog_url};});return r;
  },
  async saveAllCourseInfo(obj) {
    await sb.from('course_info').delete().eq('facility_code',FAC);
    const rows=Object.entries(obj||{}).map(([k,v])=>({facility_code:FAC,key:k,
      video_url:v.video||null,blog_url:v.blog||null}));
    if(rows.length) await sb.from('course_info').insert(rows);
  },

  // ── 메모 ──
  async loadMemos() {
    const{data}=await sb.from('memos').select('ref_key,text').eq('facility_code',FAC);
    const r={};(data||[]).forEach(d=>{r[d.ref_key]=d.text;});return r;
  },
  async saveAllMemos(obj) {
    await sb.from('memos').delete().eq('facility_code',FAC);
    const rows=Object.entries(obj||{}).filter(([,v])=>v)
      .map(([k,v])=>({facility_code:FAC,ref_key:k,text:v}));
    if(rows.length) await sb.from('memos').insert(rows);
  },

  // ── 시설 ──
  async loadFacilities() {
    const{data}=await sb.from('facilities').select('code,name').order('created_at');
    return data||[];
  }
};

// ============================================================================
// D. 기존 함수 오버라이드 — 21개 save 함수 자동 Supabase 동기화
// ============================================================================

function override(name, syncFn) {
  if (typeof window[name] !== 'function') return;
  const orig = window[name];
  window[name] = function() {
    orig.apply(this, arguments); // localStorage 캐시 유지
    try { syncFn.apply(this, arguments); } catch(e) { err('override:'+name, e); }
  };
}

// 1) sv() — 예약 저장
override('sv', function() {
  debounce('sv', ()=>API.saveAllBookings(bks).catch(e=>err('sv',e)), 500);
});

// 2) svC() — 활동 목록
override('svC', function() {
  debounce('svC', ()=>API.saveActivities(cs).catch(e=>err('svC',e)));
});

// 3) svAdmins() — 관리자
override('svAdmins', function() {
  debounce('svAdmins', ()=>API.saveAllAdmins(adminAccounts).catch(e=>err('svAdmins',e)));
});

// 4) saveFormCfgLS() — 폼 설정
override('saveFormCfgLS', function() {
  debounce('formCfg', ()=>API.saveFormConfig(formCfg).catch(e=>err('formCfg',e)));
});

// 5) saveSavedScheds() — 일정표
override('saveSavedScheds', function() {
  debounce('scheds', ()=>{
    Object.entries(savedScheds).forEach(([d,v])=>API.saveSchedule(d,v).catch(e=>err('sch',e)));
  });
});

// 6) saveSchRules() — 일정표 규칙
override('saveSchRules', function() {
  debounce('schRules', ()=>API.saveAllScheduleRules(schRules).catch(e=>err('schR',e)));
});

// 7) svAg() — 여행사
override('svAg', function() {
  debounce('agencies', ()=>API.saveAllAgencies(agencies).catch(e=>err('ag',e)));
});

// 8) svAgLogs() — 여행사 엑셀 로그
override('svAgLogs', function() {
  debounce('agLogs', ()=>API.saveAllAgExportLogs(agExportLogs).catch(e=>err('agLog',e)));
});

// 9) saveDayLimits() — 일별 제한
override('saveDayLimits', function() {
  debounce('dayLimits', ()=>API.saveAllDayLimits(dayLimits).catch(e=>err('dL',e)));
});

// 10) saveChatData() — 채팅 전체
override('saveChatData', function() {
  debounce('chatData', ()=>{
    Object.entries(chatData).forEach(([k,room])=>
      API.saveChatRoom({id:k,name:room.name,phone:room.phone,
        status:room.status,starred:room.starred,blocked:room.blocked}).catch(e=>err('chat',e)));
  });
});

// 11) saveChatFaq() — 채팅 FAQ
override('saveChatFaq', function() {
  debounce('chatFaq', ()=>API.saveChatFaq(chatFaq).catch(e=>err('faq',e)));
});

// 12) saveMemos() — 메모
override('saveMemos', function() {
  debounce('memos', ()=>API.saveAllMemos(memos).catch(e=>err('memo',e)));
});

// 13) saveLog() — 활동 로그 (배치)
override('saveLog', function() {
  // addLog에서 개별 처리하므로 배치 동기화 불필요
});

// 14) addLog() — 활동 로그 (개별)
override('addLog', function(action, desc, snapshot, reason) {
  const who = (typeof mode!=='undefined'&&mode==='admin'&&typeof curAdmin!=='undefined'&&curAdmin)
    ? curAdmin.name
    : (typeof mode!=='undefined'&&mode==='agency'&&typeof curAgency!=='undefined'?curAgency.name:'고객');
  API.addLog(action, desc, snapshot, who, reason).catch(e=>err('log',e));
});

// 15) saveAutoSend() — 자동발송
override('saveAutoSend', function() {
  debounce('autoSend', ()=>{
    try{const c=JSON.parse(_lsGet(fp()+'autosend')||'null');
      if(c)API.saveAutoSendConfig(c).catch(e=>err('auto',e));}catch(e){}
  });
});

// 16) saveCourseInfo() — 코스 미디어 (개별)
override('saveCourseInfo', function() {
  debounce('courseInfo', ()=>{
    if(window.courseInfo)API.saveAllCourseInfo(window.courseInfo).catch(e=>err('ci',e));
  });
});

// 17) saveAllCourseInfo() — 코스 미디어 (전체)
override('saveAllCourseInfo', function() {
  debounce('courseInfo', ()=>{
    if(window.courseInfo)API.saveAllCourseInfo(window.courseInfo).catch(e=>err('ci',e));
  });
});

// 18) saveAllMealInfo() — 식사 미디어
override('saveAllMealInfo', function() {
  debounce('courseInfo', ()=>{
    if(window.courseInfo)API.saveAllCourseInfo(window.courseInfo).catch(e=>err('ci',e));
  });
});

// 19) saveAllAddonInfo() — 부가체험 미디어
override('saveAllAddonInfo', function() {
  debounce('courseInfo', ()=>{
    if(window.courseInfo)API.saveAllCourseInfo(window.courseInfo).catch(e=>err('ci',e));
  });
});

// ============================================================================
// E. localStorage.setItem 프록시 — 동적 키 처리
//    (agbiz_, agbank_, agsettle_, courseInfo, autosend, chatfaq 등)
// ============================================================================
localStorage.setItem = function(key, value) {
  _lsSet(key, value); // 원본 캐시 저장
  try {
    const p = fp();

    // 여행사 사업자정보 — jp_agbiz_{code}
    if (key.startsWith(p+'agbiz_')) {
      const code = key.replace(p+'agbiz_','');
      debounce('agbiz_'+code, ()=>API.saveAgBizData(code,JSON.parse(value||'{}')).catch(e=>err('agbiz',e)));
    }
    // 여행사 은행정보 — jp_agbank_{code}
    else if (key.startsWith(p+'agbank_')) {
      const code = key.replace(p+'agbank_','');
      debounce('agbank_'+code, ()=>API.saveAgBankData(code,JSON.parse(value||'{}')).catch(e=>err('agbank',e)));
    }
    // 여행사 정산 — jp_agsettle_{code}
    else if (key.startsWith(p+'agsettle_')) {
      const code = key.replace(p+'agsettle_','');
      debounce('agsettle_'+code, ()=>API.saveAgSettle(code,JSON.parse(value||'{}')).catch(e=>err('agsettle',e)));
    }
    // 코스 미디어 — jp_courseInfo
    else if (key === p+'courseInfo') {
      debounce('ci_proxy', ()=>API.saveAllCourseInfo(JSON.parse(value||'{}')).catch(e=>err('ci',e)));
    }
    // 자동발송 — jp_autosend
    else if (key === p+'autosend') {
      debounce('auto_proxy', ()=>API.saveAutoSendConfig(JSON.parse(value||'{}')).catch(e=>err('auto',e)));
    }
    // 채팅 FAQ — jp_chatfaq
    else if (key === p+'chatfaq') {
      debounce('faq_proxy', ()=>API.saveChatFaq(JSON.parse(value||'[]')).catch(e=>err('faq',e)));
    }
  } catch(e) { /* JSON 파싱 실패 등 무시 */ }
};

// ============================================================================
// F. 초기 동기화 — Supabase → localStorage 캐시
// ============================================================================
async function syncFromDB() {
  console.log('[SB] 데이터 동기화 시작...');
  const t0 = performance.now();
  const p = fp();
  let synced = 0;

  try {
    const [bkD,admD,csD,agD,cfgD,schD,ruleD,dlD,logD,chatR,autoD,ciD,faqD,memoD] =
      await Promise.all([
        API.loadBookings(), API.loadAdmins(), API.loadActivities(),
        API.loadAgencies(), API.loadFormConfig(), API.loadSavedSchedules(),
        API.loadScheduleRules(), API.loadDayLimits(), API.loadLogs(300),
        API.loadChatRooms(), API.loadAutoSendConfig(), API.loadCourseInfo(),
        API.loadChatFaq(), API.loadMemos()
      ]);

    // 예약
    if (bkD && bkD.length) {
      bks = bkD; nid = Math.max(0.1, ...bks.map(b=>b.id)) + 1;
      _lsSet(p+'bk', JSON.stringify(bks)); synced++;
    }
    // 관리자
    if (admD && admD.length) {
      adminAccounts = admD;
      _lsSet(p+'admins', JSON.stringify(adminAccounts)); synced++;
    }
    // 활동
    if (csD && csD.length) {
      cs = csD;
      _lsSet(p+'cs', JSON.stringify(cs)); synced++;
    }
    // 여행사
    if (agD) {
      agencies = agD;
      _lsSet(p+'agencies', JSON.stringify(agencies)); synced++;
    }
    // 폼설정
    if (cfgD) {
      formCfg = cfgD;
      if (!formCfg.channels) formCfg.channels=['문자','이메일','우편물','사이트'];
      if (!formCfg.meals) formCfg.meals=[{name:'오디돈가스',p1:8000,p2:10000}];
      if (!formCfg.freeRatioChild) { formCfg.freeRatioChild=10; formCfg.freeRatioElem=10; }
      _lsSet(p+'formcfg', JSON.stringify(formCfg)); synced++;
    }
    // 일정표
    if (schD && Object.keys(schD).length) {
      savedScheds = schD;
      _lsSet('jp_scheds', JSON.stringify(savedScheds)); synced++;
    }
    // 규칙
    if (ruleD && ruleD.length) {
      schRules = ruleD;
      _lsSet(p+'schrules', JSON.stringify(schRules)); synced++;
    }
    // 일별 제한
    if (dlD && Object.keys(dlD).length) {
      dayLimits = dlD;
      _lsSet(p+'daylimits', JSON.stringify(dayLimits)); synced++;
    }
    // 로그
    if (logD && logD.length) {
      actLog = logD;
      _lsSet(p+'actlog', JSON.stringify(actLog)); synced++;
    }
    // 채팅
    if (chatR && chatR.length) {
      const cd = {};
      for (const room of chatR) {
        const msgs = await API.loadChatMessages(room.id);
        cd[room.id] = { id:room.id, name:room.name, phone:room.phone,
          status:room.status, starred:room.starred, blocked:room.blocked, msgs };
      }
      chatData = cd;
      _lsSet(p+'chats', JSON.stringify(chatData)); synced++;
    }
    // 자동발송
    if (autoD) { _lsSet(p+'autosend', JSON.stringify(autoD)); synced++; }
    // 코스미디어
    if (ciD && Object.keys(ciD).length) {
      window.courseInfo = ciD;
      _lsSet(p+'courseInfo', JSON.stringify(ciD)); synced++;
    }
    // FAQ
    if (faqD && faqD.length) {
      chatFaq = faqD;
      _lsSet(p+'chatfaq', JSON.stringify(chatFaq)); synced++;
    }
    // 메모
    if (memoD && Object.keys(memoD).length) {
      memos = memoD;
      _lsSet('jp_memos', JSON.stringify(memos)); synced++;
    }

    const ms = Math.round(performance.now()-t0);
    console.log('[SB] ✅ 동기화 완료 ('+ms+'ms) — '+synced+'항목, 예약 '+bks.length+'건');

    // UI 새로고침
    try { if(typeof rfr==='function') rfr(); } catch(e){}

    return true;
  } catch(e) {
    console.error('[SB] 동기화 실패:', e);
    console.log('[SB] localStorage 캐시로 계속 작동합니다.');
    return false;
  }
}

// ============================================================================
// G. 실시간 구독 (Realtime)
// ============================================================================
function startRealtime() {
  // 예약 변경
  sb.channel('rt-bk')
    .on('postgres_changes',{event:'*',schema:'public',table:'bookings',
      filter:'facility_code=eq.'+FAC}, async()=>{
      try{
        const fresh=await API.loadBookings();
        if(fresh){bks=fresh;nid=Math.max(0.1,...bks.map(b=>b.id))+1;
          _lsSet(fp()+'bk',JSON.stringify(bks));
          try{if(typeof rfr==='function')rfr();}catch(e){}}
      }catch(e){err('RT:bk',e);}
    }).subscribe();

  // 채팅 메시지
  sb.channel('rt-chat')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'chat_messages'},p=>{
      const m=p.new;
      if(chatData[m.room_id]){
        const exists=chatData[m.room_id].msgs.some(x=>x._dbId===m.id);
        if(!exists){
          chatData[m.room_id].msgs.push({from:m.sender,text:m.text,
            ts:new Date(m.created_at).getTime(),_dbId:m.id});
          try{if(typeof renderChatList==='function')renderChatList();}catch(e){}
        }
      }
    }).subscribe();

  // 일정표
  sb.channel('rt-sch')
    .on('postgres_changes',{event:'*',schema:'public',table:'saved_schedules',
      filter:'facility_code=eq.'+FAC}, async()=>{
      try{
        savedScheds=await API.loadSavedSchedules();
        _lsSet('jp_scheds',JSON.stringify(savedScheds));
        if(typeof renderSavedList==='function')renderSavedList();
      }catch(e){}
    }).subscribe();

  console.log('[SB] 🔴 실시간 구독 시작');
}

// ============================================================================
// H. loadFacilityData 오버라이드 — Supabase 우선 로드
// ============================================================================
if (typeof loadFacilityData === 'function') {
  const _origLoad = loadFacilityData;
  loadFacilityData = function() {
    _origLoad(); // localStorage 캐시에서 빠르게 로드 (즉시 UI 표시)
    // 그 다음 Supabase에서 최신 데이터 동기화 (백그라운드)
    setTimeout(()=>{
      syncFromDB().then(ok=>{
        if(ok) startRealtime();
      });
    }, 800);
  };
}

// ============================================================================
// I. 마이그레이션 — localStorage → Supabase 일괄 전송
// ============================================================================
window.migrateToSupabase = async function() {
  const p = fp();
  const res = [];
  console.log('[SB] 🚀 마이그레이션 시작...');

  try {
    // 예약
    const bkR=_lsGet(p+'bk');
    if(bkR){const a=JSON.parse(bkR);if(a.length){await API.saveAllBookings(a);res.push('예약 '+a.length+'건');}}
    // 관리자
    const adR=_lsGet(p+'admins');
    if(adR){const a=JSON.parse(adR);await API.saveAllAdmins(a);res.push('관리자 '+a.length+'명');}
    // 활동
    const csR=_lsGet(p+'cs');
    if(csR){const a=JSON.parse(csR);await API.saveActivities(a);res.push('활동 '+a.length+'개');}
    // 여행사
    const agR=_lsGet(p+'agencies');
    if(agR){const a=JSON.parse(agR);await API.saveAllAgencies(a);res.push('여행사 '+a.length+'개');}
    // 폼설정
    const cfR=_lsGet(p+'formcfg');
    if(cfR){await API.saveFormConfig(JSON.parse(cfR));res.push('폼설정');}
    // 일정표
    const schR=_lsGet('jp_scheds');
    if(schR){const o=JSON.parse(schR);let c=0;for(const[d,v]of Object.entries(o)){await API.saveSchedule(d,v);c++;}res.push('일정표 '+c+'개');}
    // 규칙
    const ruR=_lsGet(p+'schrules');
    if(ruR){const a=JSON.parse(ruR);await API.saveAllScheduleRules(a);res.push('규칙 '+a.length+'개');}
    // 일별제한
    const dlR=_lsGet(p+'daylimits');
    if(dlR){await API.saveAllDayLimits(JSON.parse(dlR));res.push('일별제한');}
    // 로그
    const lgR=_lsGet(p+'actlog');
    if(lgR){const a=JSON.parse(lgR);await API.saveAllLogs(a);res.push('로그 '+a.length+'건');}
    // 채팅
    const chR=_lsGet(p+'chats');
    if(chR){
      const o=JSON.parse(chR);let rc=0,mc=0;
      for(const[k,room]of Object.entries(o)){
        await API.saveChatRoom({id:k,name:room.name,phone:room.phone,
          status:room.status||'active',starred:room.starred||false,blocked:room.blocked||false});rc++;
        if(room.msgs){for(const m of room.msgs){
          await sb.from('chat_messages').insert({room_id:k,sender:m.from,text:m.text});mc++;}}
      }
      res.push('채팅 '+rc+'방/'+mc+'메시지');
    }
    // FAQ
    const fqR=_lsGet(p+'chatfaq');
    if(fqR){await API.saveChatFaq(JSON.parse(fqR));res.push('FAQ');}
    // 자동발송
    const auR=_lsGet(p+'autosend');
    if(auR){await API.saveAutoSendConfig(JSON.parse(auR));res.push('자동발송');}
    // 코스미디어
    const ciR=_lsGet(p+'courseInfo');
    if(ciR){await API.saveAllCourseInfo(JSON.parse(ciR));res.push('코스미디어');}
    // 메모
    const mmR=_lsGet('jp_memos');
    if(mmR){await API.saveAllMemos(JSON.parse(mmR));res.push('메모');}
    // 여행사별 사업자/은행/정산 정보
    const allAg=JSON.parse(_lsGet(p+'agencies')||'[]');
    for(const ag of allAg){
      const bizR=_lsGet(p+'agbiz_'+ag.code);
      const bnkR=_lsGet(p+'agbank_'+ag.code);
      const stlR=_lsGet(p+'agsettle_'+ag.code);
      if(bizR) await API.saveAgBizData(ag.code,JSON.parse(bizR));
      if(bnkR) await API.saveAgBankData(ag.code,JSON.parse(bnkR));
      if(stlR) await API.saveAgSettle(ag.code,JSON.parse(stlR));
    }
    if(allAg.length) res.push('여행사 상세정보');
    // 엑셀로그
    const exR=_lsGet(p+'agexlogs');
    if(exR){await API.saveAllAgExportLogs(JSON.parse(exR));res.push('엑셀로그');}
  } catch(e) {
    console.error('[SB] 마이그레이션 오류:', e);
  }

  console.log('[SB] ✅ 마이그레이션 완료!');
  res.forEach(r=>console.log('  ✅ '+r));
  if(typeof toast==='function')toast('✅ Supabase 마이그레이션 완료 ('+res.length+'항목)','s');
  return res;
};

// ============================================================================
// J. 초기화 완료
// ============================================================================
console.log('[SB] ✅ 풀백엔드 API 준비 완료');
console.log('[SB] 📋 콘솔 명령어:');
console.log('  migrateToSupabase()  — localStorage → Supabase 마이그레이션');
console.log('  SB.loadBookings()    — 예약 조회');
console.log('  SB.saveAllBookings() — 예약 저장');

})();

// ============================================================================
// 통합 업데이트 매니저 — localStorage + Supabase 양방향 지원
// ============================================================================
;(function(){
'use strict';
const sb=window._supabase||null;
const hasSB=!!sb;
const _J=typeof JAMSA!=='undefined'?JAMSA:null;
function _fp(){return typeof FP!=='undefined'?FP:'jp_';}
function _who(){return(typeof curAdmin!=='undefined'&&curAdmin)?curAdmin.name:'system';}
function _esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function _fmtDate(d){try{return new Date(d).toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch(e){return d||'-';}}
const catIcon={feature:'✨',fix:'🔧',hotfix:'🚨',migration:'📦',security:'🔒'};
const catLabel={feature:'기능추가',fix:'버그수정',hotfix:'긴급패치',migration:'마이그레이션',security:'보안'};
const sevColor={critical:'#c62828',high:'#e65100',normal:'#1565c0',low:'#888'};

// ── 로컬 업데이트 저장소 (Supabase 없을 때) ──
function _getLocalPkgs(){try{return JSON.parse(localStorage.getItem(_fp()+'_update_pkgs')||'[]');}catch(e){return[];}}
function _setLocalPkgs(arr){try{localStorage.setItem(_fp()+'_update_pkgs',JSON.stringify(arr));}catch(e){}}
function _getLocalLogs(){try{return JSON.parse(localStorage.getItem(_fp()+'_update_logs')||'[]');}catch(e){return[];}}
function _addLocalLog(ver,action,result){
  const logs=_getLocalLogs();
  logs.unshift({ver:ver,action:action,who:_who(),result:result,ts:new Date().toISOString()});
  if(logs.length>100)logs.length=100;
  try{localStorage.setItem(_fp()+'_update_logs',JSON.stringify(logs));}catch(e){}
}

// ============================================================================
// A. 통합 API (Supabase 있으면 원격, 없으면 로컬)
// ============================================================================
const UPD=window.UpdateManager={
  mode: hasSB?'cloud':'local',

  async getStatus(){
    if(hasSB){
      try{const{data}=await sb.rpc('get_system_status');return data||{};}catch(e){}
    }
    // 로컬 모드
    const pkgs=_getLocalPkgs();
    const patches=_J?_J.getAvailablePatches(_fp()):[];
    const pending=pkgs.filter(p=>!p.applied).length + patches.filter(p=>!p.applied&&!p.failed).length;
    const applied=pkgs.filter(p=>p.applied).length + patches.filter(p=>p.applied).length;
    return{
      current_version:_J?'v'+_J.version:'v2.10.0',
      pending:pending, applied:applied, critical:0,
      table_count:0, mode:'local'
    };
  },

  async getPending(){
    if(hasSB){
      try{const{data}=await sb.from('update_packages').select('*').eq('is_published',true).eq('is_applied',false).order('version');return data||[];}catch(e){}
    }
    return _getLocalPkgs().filter(p=>!p.applied);
  },

  async getAllPackages(){
    if(hasSB){
      try{const{data}=await sb.from('update_packages').select('*').order('version',{ascending:false});return data||[];}catch(e){}
    }
    return _getLocalPkgs();
  },

  async getHistory(){
    if(hasSB){
      try{const{data}=await sb.from('system_versions').select('*').order('applied_at',{ascending:false}).limit(50);return data||[];}catch(e){}
    }
    const sv=_J?_J.getSysVer(_fp()):{};
    const hist=[];
    if(sv._lastUpdate)hist.push({version:'v'+(_J?_J.version:'?'),component:'app',applied_at:sv._lastUpdate,notes:'현재 버전'});
    const logs=_getLocalLogs().filter(l=>l.action==='apply'&&l.result?.success);
    logs.forEach(l=>hist.push({version:l.ver,component:'patch',applied_at:l.ts,applied_by:l.who,notes:'패치 적용'}));
    return hist;
  },

  async getLogs(){
    if(hasSB){
      try{const{data}=await sb.from('update_logs').select('*').order('created_at',{ascending:false}).limit(30);return data||[];}catch(e){}
    }
    return _getLocalLogs().map(l=>({package_ver:l.ver,action:l.action,admin_name:l.who,result:l.result,created_at:l.ts}));
  },

  // 패키지 등록
  async addPackage(pkg){
    if(hasSB){
      const{data,error}=await sb.from('update_packages').insert({
        version:pkg.version,title:pkg.title,description:pkg.description||null,
        component:pkg.component||'schema',category:pkg.category||'feature',
        severity:pkg.severity||'normal',sql_up:pkg.sqlUp||null,sql_down:pkg.sqlDown||null,
        js_patch:pkg.jsPatch||null,breaking:pkg.breaking||false,
        auto_apply:pkg.autoApply||false,is_published:true,created_by:_who()
      }).select().single();
      if(error)return{success:false,error:error.message};return{success:true,data};
    }
    // 로컬 저장
    const pkgs=_getLocalPkgs();
    if(pkgs.find(p=>p.version===pkg.version))return{success:false,error:'이미 등록된 버전'};
    pkgs.push({
      version:pkg.version,title:pkg.title,description:pkg.description||'',
      component:pkg.component||'app',category:pkg.category||'feature',
      severity:pkg.severity||'normal',sql_up:pkg.sqlUp||'',js_patch:pkg.jsPatch||'',
      sql_down:pkg.sqlDown||'',breaking:pkg.breaking||false,
      auto_apply:pkg.autoApply||false,applied:false,created_at:new Date().toISOString(),created_by:_who()
    });
    _setLocalPkgs(pkgs);
    return{success:true};
  },

  // 패키지 삭제
  async deletePackage(ver){
    if(hasSB){
      const{error}=await sb.from('update_packages').delete().eq('version',ver).eq('is_applied',false);
      return error?{success:false,error:error.message}:{success:true};
    }
    const pkgs=_getLocalPkgs().filter(p=>p.version!==ver||p.applied);
    _setLocalPkgs(pkgs);return{success:true};
  },

  // 업데이트 적용
  async applyPackage(ver){
    const all=hasSB?await this.getAllPackages():_getLocalPkgs();
    const pkg=all.find(p=>p.version===ver);
    if(!pkg)return{success:false,error:'패키지 없음'};

    // 1) SQL 실행 (Supabase 있을 때만)
    if(hasSB && pkg.sql_up){
      try{
        const{data,error}=await sb.rpc('apply_update_sql',{p_version:ver,p_admin:_who()});
        if(error)throw error;
        if(!data.success)return data;
      }catch(e){
        _addLocalLog(ver,'fail',{success:false,error:e.message});
        return{success:false,error:'SQL 실행 실패: '+e.message};
      }
    }

    // 2) JS 패치 실행
    if(pkg.js_patch){
      try{
        const fn=new Function('FP','bks','cs','formCfg','agencies','toast','localStorage','sv',
          pkg.js_patch);
        fn(_fp(),
          typeof bks!=='undefined'?bks:[],
          typeof cs!=='undefined'?cs:[],
          typeof formCfg!=='undefined'?formCfg:{},
          typeof agencies!=='undefined'?agencies:[],
          typeof toast==='function'?toast:function(){},
          localStorage,
          typeof sv==='function'?sv:function(){}
        );
      }catch(e){
        _addLocalLog(ver,'js_fail',{success:false,error:e.message});
        return{success:true, warning:'JS 패치 오류: '+e.message};
      }
    }

    // 3) 완료 처리
    if(!hasSB){
      const pkgs=_getLocalPkgs();
      const idx=pkgs.findIndex(p=>p.version===ver);
      if(idx>=0){pkgs[idx].applied=true;pkgs[idx].applied_at=new Date().toISOString();pkgs[idx].applied_by=_who();}
      _setLocalPkgs(pkgs);
    }
    _addLocalLog(ver,'apply',{success:true});
    if(typeof addLog==='function')addLog('시스템','업데이트 적용: '+ver+' '+pkg.title);
    return{success:true,version:ver,title:pkg.title};
  },

  // JAMSA 패치 적용
  applyJamsaPatch(id){
    if(!_J)return{ok:false,error:'JAMSA 없음'};
    return _J.applyPatch(_fp(),id);
  },
  rollbackJamsaPatch(id){
    if(!_J)return{ok:false,error:'JAMSA 없음'};
    return _J.rollbackPatch(_fp(),id);
  },
  applyAllJamsaPatches(){
    if(!_J)return{ok:0,fail:0};
    const patches=_J.getAvailablePatches(_fp()).filter(p=>!p.applied&&!p.failed);
    let ok=0,fail=0;
    patches.forEach(p=>{const r=_J.applyPatch(_fp(),p.id);if(r.ok)ok++;else fail++;});
    return{ok,fail};
  },

  // 백업
  exportLocalData(){
    const data={_meta:{exported:new Date().toISOString(),app:_J?_J.version:'?',mode:this.mode}};
    const keys=['bk','admins','cs','agencies','formcfg','daylimits','actlog','chats','chatfaq','schrules','courseInfo','autosend'];
    const fp=_fp();
    keys.forEach(k=>{try{data[k]=JSON.parse(localStorage.getItem(fp+k)||'null');}catch(e){}});
    data['jp_memos']=JSON.parse(localStorage.getItem('jp_memos')||'{}');
    data['jp_scheds']=JSON.parse(localStorage.getItem('jp_scheds')||'{}');
    return data;
  }
};

// ============================================================================
// B. 렌더링
// ============================================================================
window.renderUpdatePanel=async function(){
  const panel=document.getElementById('updatePanel');if(!panel)return;
  panel.innerHTML='<div style="text-align:center;padding:30px;color:#aaa;">⏳ 로딩중...</div>';

  try{
    const status=await UPD.getStatus();
    const pending=await UPD.getPending();
    const history=await UPD.getHistory();
    const logs=await UPD.getLogs();
    const jamsaPatches=_J?_J.getAvailablePatches(_fp()):[];
    const jPending=jamsaPatches.filter(p=>!p.applied&&!p.failed);
    const jApplied=jamsaPatches.filter(p=>p.applied);
    const changelog=_J?_J._changelog:[];
    const diag=_J?_J.getDiagnostics(_fp()):null;

    const totalPending=pending.length+jPending.length;
    let h='';

    // ── 연결 상태 배너 ──
    h+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:14px;padding:8px 14px;background:${hasSB?'#e8f5e9':'#fff8e1'};border-radius:8px;border:1px solid ${hasSB?'#c8e6c9':'#ffe082'};">
      <span style="font-size:16px;">${hasSB?'☁️':'💾'}</span>
      <span style="font-size:12px;font-weight:700;color:${hasSB?'#2e7d32':'#f57f17'};">${hasSB?'클라우드 모드 (Supabase 연결됨)':'로컬 모드 (localStorage)'}</span>
      ${!hasSB?'<span style="font-size:10px;color:#999;margin-left:auto;">Supabase 연결 시 원격 업데이트 가능</span>':''}
    </div>`;

    // ── 상태 카드 ──
    h+=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:10px;margin-bottom:16px;">
      <div style="padding:14px;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-radius:12px;text-align:center;">
        <div style="font-size:9px;color:#2e7d32;font-weight:700;">현재 버전</div>
        <div style="font-size:18px;font-weight:900;color:#1b5e20;">${_J?'v'+_J.version:status.current_version||'?'}</div>
        <div style="font-size:9px;color:#66bb6a;">${_J?'빌드 '+_J.build:''}</div>
      </div>
      <div style="padding:14px;background:linear-gradient(135deg,${totalPending?'#fff3e0,#ffe0b2':'#e3f2fd,#bbdefb'});border-radius:12px;text-align:center;">
        <div style="font-size:9px;color:${totalPending?'#e65100':'#1565c0'};font-weight:700;">대기중 업데이트</div>
        <div style="font-size:18px;font-weight:900;color:${totalPending?'#bf360c':'#0d47a1'};">${totalPending}건</div>
      </div>
      <div style="padding:14px;background:linear-gradient(135deg,#f3e5f5,#e1bee7);border-radius:12px;text-align:center;">
        <div style="font-size:9px;color:#6a1b9a;font-weight:700;">적용 완료</div>
        <div style="font-size:18px;font-weight:900;color:#4a148c;">${(status.applied||0)+jApplied.length}건</div>
      </div>
      <div style="padding:14px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:12px;text-align:center;">
        <div style="font-size:9px;color:#1565c0;font-weight:700;">모듈</div>
        <div style="font-size:18px;font-weight:900;color:#0d47a1;">${_J?_J.getAllModules().length:0}개</div>
      </div>
      ${diag?`<div style="padding:14px;background:linear-gradient(135deg,#fce4ec,#f8bbd0);border-radius:12px;text-align:center;">
        <div style="font-size:9px;color:#880e4f;font-weight:700;">저장 용량</div>
        <div style="font-size:18px;font-weight:900;color:#880e4f;">${diag.totalStorageKB}KB</div>
      </div>`:''}
    </div>`;

    // ── JAMSA 패치 (로컬 패치 시스템) ──
    if(jamsaPatches.length){
      h+=`<div style="background:#f9fbe7;border:1px solid #dce775;border-radius:12px;padding:14px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-size:13px;font-weight:800;color:#827717;">🩹 로컬 패치 (${jamsaPatches.length}개)</div>
          ${jPending.length?`<button onclick="_updApplyAllJamsa()" style="padding:6px 16px;background:#827717;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">⚡ 대기 패치 모두 적용 (${jPending.length})</button>`:'<span style="font-size:10px;color:#aaa;">모두 적용됨 ✅</span>'}
        </div>`;
      const typeIcon={fix:'🔧',feature:'✨',hotfix:'🚨',migration:'📦'};
      jamsaPatches.forEach(p=>{
        const st=p.applied?'applied':p.failed?'failed':p.rolledback?'rolledback':'pending';
        const stBg={applied:'#e8f5e9',failed:'#ffebee',rolledback:'#fff8e1',pending:'#fff'}[st];
        const stBadge={
          applied:'<span style="font-size:9px;padding:2px 6px;background:#c8e6c9;color:#2e7d32;border-radius:8px;font-weight:700;">✅ 적용</span>',
          failed:'<span style="font-size:9px;padding:2px 6px;background:#ffcdd2;color:#c62828;border-radius:8px;font-weight:700;">❌ 실패</span>',
          rolledback:'<span style="font-size:9px;padding:2px 6px;background:#ffe0b2;color:#e65100;border-radius:8px;font-weight:700;">↩ 롤백</span>',
          pending:'<span style="font-size:9px;padding:2px 6px;background:#fff3e0;color:#e65100;border-radius:8px;font-weight:700;">⏳ 대기</span>'
        }[st];
        let btn='';
        if(st==='pending'||st==='rolledback'||st==='failed')
          btn=`<button onclick="_updApplyJamsa('${p.id}')" style="padding:3px 10px;background:#4caf50;color:#fff;border:none;border-radius:5px;font-size:10px;cursor:pointer;">적용</button>`;
        else if(st==='applied'&&(p.rollback||p.record?.backup))
          btn=`<button onclick="_updRollbackJamsa('${p.id}')" style="padding:3px 10px;background:#ffebee;color:#c62828;border:1px solid #ef9a9a;border-radius:5px;font-size:10px;cursor:pointer;">롤백</button>`;

        h+=`<div style="padding:8px 10px;background:${stBg};border-radius:6px;margin-bottom:4px;border:1px solid #f0f0f0;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;min-width:0;">
              <span style="font-size:11px;font-weight:700;">${typeIcon[p.type]||'🩹'} ${p.title}</span> ${stBadge}
              ${p.breaking?'<span style="font-size:8px;padding:1px 4px;background:#ffebee;color:#c62828;border-radius:3px;">⚠구조변경</span>':''}
              <div style="font-size:9px;color:#aaa;margin-top:2px;"><code>${p.id}</code> · ${p.module} · ${p.date}</div>
            </div>
            <div style="flex-shrink:0;margin-left:6px;">${btn}</div>
          </div>
        </div>`;
      });
      h+='</div>';
    }

    // ── 원격/로컬 패키지 (사용자 등록 업데이트) ──
    if(pending.length){
      h+=`<div style="background:#fff8e1;border:2px solid #ffca28;border-radius:12px;padding:14px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-size:13px;font-weight:800;color:#f57f17;">📦 대기중 업데이트 패키지 (${pending.length}건)</div>
          <button onclick="_updRunAllPkgs()" style="padding:6px 16px;background:#f57f17;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;">🚀 전체 적용</button>
        </div>`;
      pending.forEach(p=>{
        h+=`<div style="background:#fff;border-radius:8px;padding:10px;border:1px solid #ffe082;margin-bottom:4px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
              <div style="font-size:12px;font-weight:700;">${catIcon[p.category]||'📦'} ${p.version} — ${p.title}
                <span style="font-size:9px;padding:1px 5px;background:${sevColor[p.severity]||'#666'}22;color:${sevColor[p.severity]||'#666'};border-radius:4px;">${p.severity||'normal'}</span>
              </div>
              ${p.description?`<div style="font-size:10px;color:#888;margin-top:2px;">${p.description}</div>`:''}
            </div>
            <div style="display:flex;gap:4px;flex-shrink:0;">
              <button onclick="_updApplyPkg('${p.version}')" style="padding:4px 10px;background:#4caf50;color:#fff;border:none;border-radius:5px;font-size:10px;cursor:pointer;">적용</button>
              <button onclick="_updPreviewPkg('${p.version}')" style="padding:4px 8px;background:#e3f2fd;color:#1565c0;border:1px solid #90caf9;border-radius:5px;font-size:10px;cursor:pointer;">코드</button>
              <button onclick="_updDelPkg('${p.version}')" style="padding:4px 8px;background:#fafafa;color:#999;border:1px solid #eee;border-radius:5px;font-size:10px;cursor:pointer;">삭제</button>
            </div>
          </div>
        </div>`;
      });
      h+='</div>';
    }

    // ── 액션 버튼 ──
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;">
      <button onclick="_updNewPkgForm()" style="padding:7px 14px;background:#1565c0;color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;">📤 파일 업로드</button>
      <button onclick="_updShowRestore()" style="padding:7px 14px;background:#ff8f00;color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;">↩ 복원</button>
      <button onclick="_updBackup()" style="padding:7px 14px;background:#e65100;color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;">📦 백업</button>
      ${hasSB?`<button onclick="_updHealthCheck()" style="padding:7px 14px;background:#00897b;color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;">🩺 DB점검</button>
      <button onclick="_updDirectSQL()" style="padding:7px 14px;background:#6a1b9a;color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;">💻 SQL</button>`:''}
      <button onclick="renderUpdatePanel()" style="padding:7px 14px;background:#f5f5f5;color:#666;border:1px solid #ddd;border-radius:7px;font-size:11px;cursor:pointer;">🔄 새로고침</button>
    </div>
    <div id="_updAction"></div>`;

    // ── 변경 이력 (Changelog) ──
    if(changelog.length){
      h+=`<details style="margin-bottom:12px;"><summary style="font-size:13px;font-weight:800;color:#333;cursor:pointer;padding:6px 0;">📋 변경 이력 (${changelog.length}개 버전)</summary>
        <div style="margin-top:8px;max-height:300px;overflow-y:auto;">`;
      changelog.forEach(log=>{
        h+=`<div style="padding:10px 12px;border-left:3px solid var(--p);margin-bottom:8px;background:#f9f9f9;border-radius:0 8px 8px 0;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:12px;font-weight:800;color:var(--p);">v${log.version}</span>
            <span style="font-size:10px;color:#888;">${log.date}</span>
          </div>
          <ul style="margin:0;padding-left:16px;">
            ${log.changes.map(c=>`<li style="font-size:10px;color:#555;line-height:1.7;">${c}</li>`).join('')}
          </ul>
        </div>`;
      });
      h+='</div></details>';
    }

    // ── 모듈 정보 ──
    if(diag&&diag.modules.length){
      h+=`<details style="margin-bottom:12px;"><summary style="font-size:13px;font-weight:800;color:#333;cursor:pointer;padding:6px 0;">📦 등록 모듈 (${diag.modules.length}개)</summary>
        <div style="display:flex;flex-direction:column;gap:4px;margin-top:8px;">`;
      diag.modules.forEach(m=>{
        const ok=!m.needsMigration;
        h+=`<div style="padding:8px 10px;background:#fafafa;border-radius:6px;border:1px solid #f0f0f0;">
          <div style="display:flex;justify-content:space-between;">
            <span style="font-size:11px;font-weight:700;">${m.name} <span style="color:#aaa;font-weight:400;">v${m.version}</span></span>
            <span style="font-size:10px;color:${ok?'#2e7d32':'#e65100'};font-weight:600;">${ok?'✅ 최신':'🔄 업데이트 필요'}</span>
          </div>
          <div style="font-size:9px;color:#999;margin-top:2px;">스키마 v${m.currentVer}/${m.schemaVer} ${m.depends.length?'· 의존: '+m.depends.join(', '):''}</div>
        </div>`;
      });
      h+='</div></details>';
    }

    // ── 실행 로그 ──
    if(logs.length){
      h+=`<details><summary style="font-size:12px;font-weight:700;color:#666;cursor:pointer;padding:6px 0;">📜 실행 로그 (${logs.length}건)</summary>
        <div style="max-height:200px;overflow-y:auto;margin-top:6px;">`;
      logs.forEach(l=>{
        const ok=l.result?.success;
        h+=`<div style="font-size:10px;padding:4px 8px;border-left:3px solid ${ok?'#4caf50':l.action==='rollback'?'#ff9800':'#ef5350'};margin-bottom:2px;background:#fafafa;border-radius:0 4px 4px 0;">
          <b>${l.package_ver||l.ver||'?'}</b> · ${l.action} · ${l.admin_name||l.who||''} · ${_fmtDate(l.created_at||l.ts)}
          ${l.result?.error?` · <span style="color:#c62828;">${_esc(l.result.error)}</span>`:''}
        </div>`;
      });
      h+='</div></details>';
    }

    panel.innerHTML=h;
  }catch(e){
    panel.innerHTML=`<div style="padding:14px;background:#ffebee;border-radius:10px;color:#c62828;">
      <div style="font-size:13px;font-weight:700;">❌ 오류: ${_esc(e.message)}</div>
      <button onclick="renderUpdatePanel()" style="margin-top:8px;padding:5px 12px;background:#c62828;color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;">재시도</button>
    </div>`;
  }
};

// ============================================================================
// C. 액션 핸들러
// ============================================================================

// JAMSA 패치 개별 적용
window._updApplyJamsa=function(id){
  const r=UPD.applyJamsaPatch(id);
  if(r.ok){toast('✅ 패치 적용: '+id,'s');_addLocalLog(id,'apply',{success:true});}
  else{toast('❌ 실패: '+r.error,'e');_addLocalLog(id,'fail',{success:false,error:r.error});}
  renderUpdatePanel();
};
window._updRollbackJamsa=function(id){
  const r=UPD.rollbackJamsaPatch(id);
  if(r.ok){toast('↩ 롤백: '+id,'s');_addLocalLog(id,'rollback',{success:true});}
  else toast('❌ '+r.error,'e');
  renderUpdatePanel();
};
window._updApplyAllJamsa=function(){
  const r=UPD.applyAllJamsaPatches();
  toast(`✅ ${r.ok}개 적용`+(r.fail?`, ❌ ${r.fail}개 실패`:''),'s');
  if(typeof addLog==='function')addLog('시스템',`패치 일괄 적용: 성공 ${r.ok}, 실패 ${r.fail}`);
  renderUpdatePanel();
};

// 패키지 적용
window._updApplyPkg=async function(ver){
  if(!confirm(ver+' 업데이트를 적용합니다?'))return;
  const area=document.getElementById('_updAction');
  area.innerHTML=`<div style="padding:8px;color:#1565c0;font-size:11px;">🔄 ${ver} 적용중...</div>`;
  const r=await UPD.applyPackage(ver);
  area.innerHTML=`<div style="padding:8px;background:${r.success?'#e8f5e9':'#ffebee'};border-radius:6px;font-size:11px;">
    ${r.success?'✅ 성공':'❌ 실패'}: ${r.success?(r.title||ver):r.error}${r.warning?' ⚠️ '+r.warning:''}
  </div>`;
  toast(r.success?'✅ 적용 완료':'❌ '+r.error,r.success?'s':'e');
  setTimeout(renderUpdatePanel,1500);
};
window._updRunAllPkgs=async function(){
  if(!confirm('모든 대기 업데이트를 적용합니다?'))return;
  const area=document.getElementById('_updAction');
  area.innerHTML='<div style="padding:8px;color:#f57f17;font-size:11px;">🔄 적용중...</div>';
  const pending=await UPD.getPending();
  let ok=0,fail=0;
  for(const p of pending){
    const r=await UPD.applyPackage(p.version);
    if(r.success)ok++;else fail++;
  }
  area.innerHTML=`<div style="padding:8px;background:#e8f5e9;border-radius:6px;font-size:11px;">✅ ${ok}건 완료${fail?' · ❌ '+fail+'건 실패':''}</div>`;
  toast(`업데이트 ${ok}건 완료`,'s');
  setTimeout(renderUpdatePanel,1500);
};
window._updPreviewPkg=async function(ver){
  const all=await UPD.getAllPackages();const p=all.find(x=>x.version===ver);if(!p)return;
  const area=document.getElementById('_updAction');
  area.innerHTML=`<div style="background:#263238;border-radius:8px;padding:12px;margin-bottom:8px;">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
      <span style="font-size:11px;font-weight:700;color:#80cbc4;">${p.version} — ${p.title}</span>
      <button onclick="document.getElementById('_updAction').innerHTML=''" style="padding:2px 8px;background:#455a64;color:#cfd8dc;border:none;border-radius:4px;font-size:9px;cursor:pointer;">닫기</button>
    </div>
    ${p.sql_up?`<div style="font-size:9px;color:#4dd0e1;">SQL (UP)</div><pre style="background:#1b2327;color:#a5d6a7;padding:8px;border-radius:4px;font-size:10px;overflow-x:auto;white-space:pre-wrap;max-height:150px;">${_esc(p.sql_up)}</pre>`:''}
    ${p.js_patch?`<div style="font-size:9px;color:#fff59d;margin-top:4px;">JS Patch</div><pre style="background:#1b2327;color:#fff59d;padding:8px;border-radius:4px;font-size:10px;overflow-x:auto;white-space:pre-wrap;max-height:150px;">${_esc(p.js_patch)}</pre>`:''}
  </div>`;
};
window._updDelPkg=async function(ver){
  if(!confirm(ver+' 삭제?'))return;
  await UPD.deletePackage(ver);toast('삭제됨','s');renderUpdatePanel();
};

// 새 패키지 등록 폼
// ── 파일 업로드 기반 업데이트 ──
window._updNewPkgForm=function(){
  const area=document.getElementById('_updAction');
  area.innerHTML=`<div style="background:#e8eaf6;border-radius:10px;padding:14px;margin-bottom:10px;">
    <div style="font-size:13px;font-weight:800;color:#283593;margin-bottom:10px;">📤 파일 업로드로 업데이트</div>
    <div style="font-size:10px;color:#666;margin-bottom:12px;">수정된 HTML 파일을 업로드하면 현재 시스템에 자동 반영됩니다.</div>

    <div id="_updDropZone" onclick="document.getElementById('_updFileInput').click()"
      ondragover="event.preventDefault();this.style.borderColor='#283593';this.style.background='#c5cae9'"
      ondragleave="this.style.borderColor='#9fa8da';this.style.background='#e8eaf6'"
      ondrop="event.preventDefault();this.style.borderColor='#9fa8da';this.style.background='#e8eaf6';_updHandleFile(event.dataTransfer.files[0])"
      style="border:2px dashed #9fa8da;border-radius:10px;padding:28px 16px;text-align:center;cursor:pointer;background:#e8eaf6;transition:all .2s;margin-bottom:12px;">
      <div style="font-size:28px;margin-bottom:4px;">📁</div>
      <div style="font-size:12px;font-weight:700;color:#283593;">수정된 HTML 파일을 여기에 드래그하거나 클릭</div>
      <div style="font-size:10px;color:#999;margin-top:4px;">.html 파일 지원</div>
      <input type="file" id="_updFileInput" accept=".html,.htm" style="display:none;" onchange="_updHandleFile(this.files[0])">
    </div>

    <div id="_updFileStatus" style="display:none;margin-bottom:12px;"></div>
    <div id="_updDiffResult" style="display:none;margin-bottom:12px;"></div>

    <div id="_updApplyArea" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">
        <div><label style="font-size:9px;font-weight:600;color:#555;">버전</label><input id="_uV" placeholder="자동 생성" style="width:100%;padding:6px;border:1px solid #c5cae9;border-radius:5px;font-size:11px;box-sizing:border-box;"></div>
        <div><label style="font-size:9px;font-weight:600;color:#555;">제목</label><input id="_uT" placeholder="업데이트 내용" style="width:100%;padding:6px;border:1px solid #c5cae9;border-radius:5px;font-size:11px;box-sizing:border-box;"></div>
      </div>
      <div style="display:flex;gap:6px;">
        <button onclick="_updApplyFile()" style="padding:8px 22px;background:#283593;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;">🚀 업데이트 적용</button>
        <button onclick="document.getElementById('_updAction').innerHTML=''" style="padding:8px 14px;background:#e0e0e0;color:#666;border:none;border-radius:6px;font-size:11px;cursor:pointer;">취소</button>
      </div>
    </div>
  </div>`;
};

// 업로드된 파일 내용 저장
window._updPendingContent=null;

window._updHandleFile=function(file){
  if(!file)return;
  if(!file.name.match(/\.html?$/i)){toast('HTML 파일만 업로드 가능합니다','e');return;}

  const statusEl=document.getElementById('_updFileStatus');
  const diffEl=document.getElementById('_updDiffResult');
  const applyEl=document.getElementById('_updApplyArea');
  statusEl.style.display='block';
  statusEl.innerHTML=`<div style="padding:10px;background:#fff3e0;border-radius:6px;font-size:11px;color:#e65100;">📂 <b>${file.name}</b> (${(file.size/1024).toFixed(1)}KB) 분석중...</div>`;

  const reader=new FileReader();
  reader.onload=function(e){
    const newContent=e.target.result;
    window._updPendingContent=newContent;

    // 현재 HTML의 <script> 영역과 비교
    const curScripts=_updExtractScripts(document.documentElement.outerHTML);
    const newScripts=_updExtractScripts(newContent);
    const curHTML=_updExtractBody(document.documentElement.outerHTML);
    const newHTML=_updExtractBody(newContent);

    const jsChanged=curScripts!==newScripts;
    const htmlChanged=curHTML!==newHTML;
    const newLines=newContent.split('\n').length;
    const curLines=document.documentElement.outerHTML.split('\n').length;

    statusEl.innerHTML=`<div style="padding:10px;background:#e8f5e9;border-radius:6px;">
      <div style="font-size:11px;font-weight:700;color:#2e7d32;">✅ 파일 로드 완료: ${file.name}</div>
      <div style="font-size:10px;color:#666;margin-top:4px;">
        새 파일: ${newLines.toLocaleString()}줄 · 현재: ${curLines.toLocaleString()}줄 · 차이: ${(newLines-curLines>0?'+':'')}${(newLines-curLines).toLocaleString()}줄
      </div>
    </div>`;

    // 변경사항 분석
    let diffH='';
    if(!jsChanged&&!htmlChanged){
      diffH=`<div style="padding:12px;background:#fff3e0;border-radius:6px;text-align:center;">
        <div style="font-size:12px;font-weight:700;color:#e65100;">⚠️ 변경사항이 감지되지 않습니다</div>
        <div style="font-size:10px;color:#888;margin-top:4px;">동일한 파일이거나 변경 범위가 감지 영역 밖입니다</div>
      </div>`;
    } else {
      const changes=[];
      if(jsChanged)changes.push({icon:'⚡',label:'JavaScript 코드 변경',color:'#1565c0'});
      if(htmlChanged)changes.push({icon:'🎨',label:'HTML 구조/UI 변경',color:'#6a1b9a'});

      diffH=`<div style="padding:12px;background:#f3e5f5;border-radius:6px;">
        <div style="font-size:12px;font-weight:700;color:#4a148c;margin-bottom:8px;">🔍 변경사항 감지됨</div>`;
      changes.forEach(c=>{
        diffH+=`<div style="padding:6px 10px;background:#fff;border-radius:5px;margin-bottom:4px;border-left:3px solid ${c.color};">
          <span style="font-size:11px;font-weight:600;">${c.icon} ${c.label}</span>
        </div>`;
      });
      diffH+='</div>';
    }
    diffEl.style.display='block';
    diffEl.innerHTML=diffH;

    // 버전 자동 생성
    const now=new Date();
    const autoVer='v'+now.getFullYear()+'.'+String(now.getMonth()+1).padStart(2,'0')+'.'+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    document.getElementById('_uV').value=autoVer;
    document.getElementById('_uT').value=file.name.replace(/\.html?$/i,'').replace(/_/g,' ');
    applyEl.style.display='block';
  };
  reader.readAsText(file,'UTF-8');
};

// 스크립트 영역 추출 (비교용)
function _updExtractScripts(html){
  const m=html.match(/<script[^>]*>([\s\S]*?)<\/script>/gi);
  return m?m.join('').replace(/\s+/g,' '):'';
}
function _updExtractBody(html){
  const m=html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
  return m?m[1].replace(/<script[\s\S]*?<\/script>/gi,'').replace(/\s+/g,' '):'';
}

// 파일 적용 → 다운로드 방식 (안전)
window._updApplyFile=function(){
  if(!window._updPendingContent){toast('업로드된 파일이 없습니다','e');return;}
  const ver=(document.getElementById('_uV').value||'').trim();
  const title=(document.getElementById('_uT').value||'').trim()||'파일 업데이트';

  // 1) 현재 파일 백업 다운로드 제안
  if(confirm('업데이트를 적용합니다.\n\n1단계: 현재 버전 백업 다운로드\n2단계: 새 파일 다운로드\n3단계: 새 파일로 교체\n\n먼저 현재 버전을 백업합니다.')){
    // 현재 파일 백업 다운로드
    _updDownloadHTML(document.documentElement.outerHTML, 'backup_'+new Date().toISOString().slice(0,10)+'.html');
  }

  // 2) 로그 기록
  _addLocalLog(ver,'file_update',{success:true,title:title,size:window._updPendingContent.length});
  if(typeof addLog==='function')addLog('시스템','파일 업데이트: '+ver+' '+title);

  // 3) 새 파일 다운로드
  setTimeout(function(){
    _updDownloadHTML(window._updPendingContent, '잠사박물관_예약시스템_supabase.html');
    const area=document.getElementById('_updAction');
    if(area) area.innerHTML=`<div style="padding:14px;background:#e8f5e9;border:2px solid #4caf50;border-radius:10px;margin-top:10px;">
      <div style="font-size:14px;font-weight:800;color:#2e7d32;margin-bottom:6px;">✅ 업데이트 파일 다운로드 완료!</div>
      <div style="font-size:11px;color:#555;line-height:1.8;">
        <b>적용 방법:</b><br>
        1. 다운로드된 <b>잠사박물관_예약시스템_supabase.html</b> 파일 확인<br>
        2. 기존 파일을 다운로드된 파일로 <b>교체(덮어쓰기)</b><br>
        3. 브라우저에서 새 파일 열기 또는 <b>새로고침</b><br>
        <span style="color:#888;">💡 기존 데이터(예약/설정 등)는 localStorage에 저장되어 있어 자동으로 유지됩니다.</span>
      </div>
    </div>`;
    toast('✅ 새 파일 다운로드됨 — 기존 파일을 교체하세요','s');
  },1500);
};

// HTML 파일 다운로드 유틸
function _updDownloadHTML(content, filename){
  const blob=new Blob([content],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(a.href);},100);
}

// ── 이전 버전 복원 (백업 다운로드) ──
window._updShowRestore=function(){
  const area=document.getElementById('_updAction');
  area.innerHTML=`<div style="background:#fff3e0;border-radius:10px;padding:14px;margin-bottom:10px;">
    <div style="font-size:13px;font-weight:800;color:#e65100;margin-bottom:8px;">↩ 현재 버전 백업</div>
    <div style="font-size:10px;color:#888;margin-bottom:10px;">현재 사용중인 HTML 파일을 백업 파일로 다운로드합니다.<br>문제 발생 시 이 파일로 교체하면 됩니다.</div>
    <button onclick="_updDownloadCurrent()" style="padding:8px 20px;background:#e65100;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;">📥 현재 버전 백업 다운로드</button>
    <button onclick="document.getElementById('_updAction').innerHTML=''" style="margin-left:6px;padding:8px 14px;background:#eee;color:#666;border:none;border-radius:6px;font-size:11px;cursor:pointer;">닫기</button>
  </div>`;
};
window._updDownloadCurrent=function(){
  const content='<!DOCTYPE html>\n'+document.documentElement.outerHTML;
  _updDownloadHTML(content, 'backup_잠사박물관_'+new Date().toISOString().slice(0,10)+'.html');
  toast('📥 백업 다운로드 완료','s');
};
// _updRestore 제거 (localStorage 기반 복원 삭제 → 파일 교체 방식으로 통일)

// 백업
window._updBackup=function(){
  const data=UPD.exportLocalData();
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='jamsa_backup_'+new Date().toISOString().split('T')[0]+'.json';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast('📦 백업 다운로드 완료','s');
};

// DB 점검 (Supabase only)
window._updHealthCheck=async function(){
  if(!hasSB)return;
  const area=document.getElementById('_updAction');
  area.innerHTML='<div style="padding:8px;color:#00897b;font-size:11px;">🩺 점검중...</div>';
  const tables=['facilities','admin_accounts','bookings','activities','agencies','agency_biz_info',
    'agency_settlements','chat_rooms','chat_messages','chat_faq','activity_logs','form_config',
    'saved_schedules','schedule_rules','day_limits','auto_send_config','course_info','memos'];
  const results=[];
  for(const t of tables){
    try{const{count,error}=await sb.from(t).select('*',{count:'exact',head:true});
      results.push({t:t,ok:!error,n:count||0});}
    catch(e){results.push({t:t,ok:false,n:0});}
  }
  const ok=results.filter(r=>r.ok).length;
  let h=`<div style="background:#e0f2f1;border-radius:8px;padding:12px;margin-bottom:8px;">
    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
      <span style="font-size:11px;font-weight:700;color:#00695c;">🩺 ${ok}/${results.length} 정상</span>
      <button onclick="document.getElementById('_updAction').innerHTML=''" style="padding:2px 8px;background:#b2dfdb;border:none;border-radius:4px;font-size:9px;cursor:pointer;">닫기</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:3px;">`;
  results.forEach(r=>{h+=`<div style="padding:4px 8px;background:${r.ok?'#fff':'#ffebee'};border-radius:4px;font-size:10px;">${r.ok?'✅':'❌'} ${r.t} <span style="color:#aaa;">${r.ok?r.n+'행':''}</span></div>`;});
  area.innerHTML=h+'</div></div>';
};

// 직접 SQL (Supabase only)
window._updDirectSQL=function(){
  if(!hasSB)return;
  const area=document.getElementById('_updAction');
  area.innerHTML=`<div style="background:#37474f;border-radius:8px;padding:12px;margin-bottom:8px;">
    <div style="font-size:12px;font-weight:700;color:#80cbc4;margin-bottom:6px;">💻 SQL 실행</div>
    <textarea id="_updSQLTxt" rows="4" placeholder="SELECT COUNT(*) FROM bookings;" style="width:100%;padding:8px;background:#263238;color:#a5d6a7;border:1px solid #546e7a;border-radius:5px;font-size:11px;font-family:monospace;box-sizing:border-box;"></textarea>
    <div style="display:flex;gap:6px;margin-top:6px;">
      <button onclick="_updSQLRun()" style="padding:6px 16px;background:#00897b;color:#fff;border:none;border-radius:5px;font-size:11px;cursor:pointer;">▶ 실행</button>
      <button onclick="document.getElementById('_updAction').innerHTML=''" style="padding:6px 12px;background:#546e7a;color:#cfd8dc;border:none;border-radius:5px;font-size:11px;cursor:pointer;">닫기</button>
    </div>
    <div id="_updSQLRes" style="margin-top:6px;"></div>
  </div>`;
};
window._updSQLRun=async function(){
  const sql=(document.getElementById('_updSQLTxt').value||'').trim();if(!sql)return;
  if(!confirm('SQL 실행?'))return;
  const tmpV='sql_'+Date.now();
  await UPD.addPackage({version:tmpV,title:'수동 SQL',sqlUp:sql,component:'manual',category:'fix'});
  const r=await UPD.applyPackage(tmpV);
  document.getElementById('_updSQLRes').innerHTML=`<div style="padding:6px;background:${r.success?'#1b5e20':'#b71c1c'};border-radius:4px;color:#fff;font-size:10px;">${r.success?'✅ 완료':'❌ '+(r.error||'실패')}</div>`;
};

// ============================================================================
// D. 자동 점검 (로그인 시)
// ============================================================================
window.addEventListener('load',function(){
  setTimeout(function(){
    try{
      if(typeof mode==='undefined'||mode!=='admin')return;
      // JAMSA 패치 체크
      if(_J){
        const patches=_J.getAvailablePatches(_fp());
        const pend=patches.filter(p=>!p.applied&&!p.failed);
        if(pend.length&&typeof toast==='function'){
          toast('🔔 대기 패치 '+pend.length+'건 — 설정 > 업데이트','i');
        }
        // 업데이트 탭 배지
        const navBtns=document.querySelectorAll('#axSubTabs button');
        navBtns.forEach(function(b){
          if(b.textContent.indexOf('업데이트')>=0 && pend.length){
            b.innerHTML='🔄 업데이트 <span style="display:inline-block;min-width:16px;height:16px;line-height:16px;text-align:center;background:#f57f17;color:#fff;border-radius:8px;font-size:9px;font-weight:900;margin-left:2px;">'+pend.length+'</span>';
          }
        });
      }
    }catch(e){}
  },3000);
});
})();
</script>
</body>
</html>
